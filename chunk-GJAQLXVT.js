import{d as h}from"./chunk-FWZ75RMU.js";var m=class{static ConvertPanoramaToCubemap(e,o,t,n,r=!1,s=!0){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";let l=0;if(e.length!=o*t*3){if(e.length!=o*t*4)throw"ConvertPanoramaToCubemap: input size is wrong";l=4}else l=3;let w=this.CreateCubemapTexture(n,this.FACE_FRONT,e,o,t,r,s,l),u=this.CreateCubemapTexture(n,this.FACE_BACK,e,o,t,r,s,l),C=this.CreateCubemapTexture(n,this.FACE_LEFT,e,o,t,r,s,l),f=this.CreateCubemapTexture(n,this.FACE_RIGHT,e,o,t,r,s,l),c=this.CreateCubemapTexture(n,this.FACE_UP,e,o,t,r,s,l),i=this.CreateCubemapTexture(n,this.FACE_DOWN,e,o,t,r,s,l);return{front:w,back:u,left:C,right:f,up:c,down:i,size:n,type:1,format:4,gammaSpace:!1}}static CreateCubemapTexture(e,o,t,n,r,s,l,w){let u=new ArrayBuffer(e*e*4*3),C=new Float32Array(u),f=s?Math.max(1,Math.round(n/4/e)):1,c=1/f,i=c*c,d=o[1].subtract(o[0]).scale(c/e),R=o[3].subtract(o[2]).scale(c/e),b=1/e,F=0;for(let g=0;g<e;g++)for(let P=0;P<f;P++){let B=o[0],T=o[2];for(let M=0;M<e;M++)for(let x=0;x<f;x++){let _=T.subtract(B).scale(F).add(B);_.normalize();let A=this.CalcProjectionSpherical(_,t,n,r,w,l);C[g*e*3+M*3+0]+=A.r*i,C[g*e*3+M*3+1]+=A.g*i,C[g*e*3+M*3+2]+=A.b*i,B=B.add(d),T=T.add(R)}F+=b*c}return C}static CalcProjectionSpherical(e,o,t,n,r,s){let l=Math.atan2(e.z,e.x),w=Math.acos(e.y);for(;l<-Math.PI;)l+=2*Math.PI;for(;l>Math.PI;)l-=2*Math.PI;let u=l/Math.PI,C=w/Math.PI;u=u*.5+.5;let f=Math.round(u*t);f<0?f=0:f>=t&&(f=t-1);let c=Math.round(C*n);c<0?c=0:c>=n&&(c=n-1);let i=s?n-c-1:c,d=o[i*t*r+f*r+0],R=o[i*t*r+f*r+1],b=o[i*t*r+f*r+2];return{r:d,g:R,b}}};m.FACE_LEFT=[new h(-1,-1,-1),new h(1,-1,-1),new h(-1,1,-1),new h(1,1,-1)];m.FACE_RIGHT=[new h(1,-1,1),new h(-1,-1,1),new h(1,1,1),new h(-1,1,1)];m.FACE_FRONT=[new h(1,-1,-1),new h(1,-1,1),new h(1,1,-1),new h(1,1,1)];m.FACE_BACK=[new h(-1,-1,1),new h(-1,-1,-1),new h(-1,1,1),new h(-1,1,-1)];m.FACE_DOWN=[new h(1,1,-1),new h(1,1,1),new h(-1,1,-1),new h(-1,1,1)];m.FACE_UP=[new h(-1,-1,-1),new h(-1,-1,1),new h(1,-1,-1),new h(1,-1,1)];function L(a,e){return e>1023?a*Math.pow(2,1023)*Math.pow(2,e-1023):e<-1074?a*Math.pow(2,-1074)*Math.pow(2,e+1074):a*Math.pow(2,e)}function D(a,e,o,t,n,r){n>0?(n=L(1,n-136),a[r+0]=e*n,a[r+1]=o*n,a[r+2]=t*n):(a[r+0]=0,a[r+1]=0,a[r+2]=0)}function E(a,e){let o="",t="";for(let n=e;n<a.length-e&&(t=String.fromCharCode(a[n]),t!=`
`);n++)o+=t;return o}function p(a){let e=0,o=0,t=E(a,0);if(t[0]!="#"||t[1]!="?")throw"Bad HDR Format.";let n=!1,r=!1,s=0;do s+=t.length+1,t=E(a,s),t=="FORMAT=32-bit_rle_rgbe"?r=!0:t.length==0&&(n=!0);while(!n);if(!r)throw"HDR Bad header format, unsupported FORMAT";s+=t.length+1,t=E(a,s);let w=/^-Y (.*) \+X (.*)$/g.exec(t);if(!w||w.length<3)throw"HDR Bad header format, no size";if(o=parseInt(w[2]),e=parseInt(w[1]),o<8||o>32767)throw"HDR Bad header format, unsupported size";return s+=t.length+1,{height:e,width:o,dataPosition:s}}function X(a,e,o=!1){let t=new Uint8Array(a),n=p(t),r=G(t,n);return m.ConvertPanoramaToCubemap(r,n.width,n.height,e,o)}function G(a,e){return O(a,e)}function O(a,e){let o=e.height,t=e.width,n,r,s,l,w,u=e.dataPosition,C=0,f=0,c=0,i=new ArrayBuffer(t*4),d=new Uint8Array(i),R=new ArrayBuffer(e.width*e.height*4*3),b=new Float32Array(R);for(;o>0;){if(n=a[u++],r=a[u++],s=a[u++],l=a[u++],n!=2||r!=2||s&128||e.width<8||e.width>32767)return N(a,e);if((s<<8|l)!=t)throw"HDR Bad header format, wrong scan line width";for(C=0,c=0;c<4;c++)for(f=(c+1)*t;C<f;)if(n=a[u++],r=a[u++],n>128){if(w=n-128,w==0||w>f-C)throw"HDR Bad Format, bad scanline data (run)";for(;w-- >0;)d[C++]=r}else{if(w=n,w==0||w>f-C)throw"HDR Bad Format, bad scanline data (non-run)";if(d[C++]=r,--w>0)for(let F=0;F<w;F++)d[C++]=a[u++]}for(c=0;c<t;c++)n=d[c],r=d[c+t],s=d[c+2*t],l=d[c+3*t],D(b,n,r,s,l,(e.height-o)*t*3+c*3);o--}return b}function N(a,e){let o=e.height,t=e.width,n,r,s,l,w,u=e.dataPosition,C=new ArrayBuffer(e.width*e.height*4*3),f=new Float32Array(C);for(;o>0;){for(w=0;w<e.width;w++)n=a[u++],r=a[u++],s=a[u++],l=a[u++],D(f,n,r,s,l,(e.height-o)*t*3+w*3);o--}return f}export{p as a,X as b,G as c};
