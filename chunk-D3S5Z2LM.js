import{b as Ct}from"./chunk-XGKK3RCV.js";import{b as Pt}from"./chunk-BIUUBQVG.js";import{a as Rt,d as $}from"./chunk-UQ4ZL6C5.js";import{a as St}from"./chunk-5MZUWGRQ.js";import{a as ut}from"./chunk-D5FZWZLB.js";import{a as Tt}from"./chunk-2LR3BD57.js";import{a as vt}from"./chunk-LXQMLMT4.js";import{b as J}from"./chunk-JIBXETCA.js";import{a as ct,b as rt}from"./chunk-LU3OERCI.js";import{d as m,e as j,f as P,g as y,h as d}from"./chunk-D7E25M7D.js";import{d as K}from"./chunk-OPJEXU7D.js";import{h as w}from"./chunk-NETBLRFG.js";import{g as h}from"./chunk-ZIF4NNI2.js";import{a as E,d as Y,i as nt,n as At,q as k}from"./chunk-CCUABLZY.js";import{a as xt,b as It}from"./chunk-M4M4JHJ5.js";import{a as Dt,b as yt}from"./chunk-3WG2WLZ4.js";import{K as Q}from"./chunk-UB6LWR2H.js";import{a as R}from"./chunk-A3WFPZFR.js";import{b as z}from"./chunk-4UCLQGBG.js";import{a as bt}from"./chunk-PTJ4CXVK.js";import{h as st}from"./chunk-GXO6EN2N.js";function ft(n,t,e){try{let i=n.next();i.done?t(i):i.value?i.value.then(()=>{i.value=void 0,t(i)},e):t(i)}catch(i){e(i)}}function Zt(n=25){let t;return(e,i,s)=>{let r=performance.now();t===void 0||r-t>n?(t=r,setTimeout(()=>{ft(e,i,s)},0)):ft(e,i,s)}}function Et(n,t,e,i,s){let r=()=>{let l,o=u=>{u.done?e(u.value):l===void 0?l=!0:r()};do l=void 0,!s||!s.aborted?t(n,o,i):i(new Error("Aborted")),l===void 0&&(l=!1);while(l)};r()}function dt(n,t){let e;return Et(n,ft,i=>e=i,i=>{throw i},t),e}function Ht(n,t,e){return st(this,null,function*(){return yield new Promise((i,s)=>{Et(n,t,i,s,e)})})}function Ft(n,t){return(...e)=>dt(n(...e),t)}var G=class{},O=class n{constructor(){this.uniqueId=0,this.metadata={},this._applyTo=Ft(this._applyToCoroutine.bind(this)),this.uniqueId=n._UniqueIdGenerator,n._UniqueIdGenerator++}set(t,e){switch(t.length||bt.Warn(`Setting vertex data kind '${e}' with an empty array`),e){case h.PositionKind:this.positions=t;break;case h.NormalKind:this.normals=t;break;case h.TangentKind:this.tangents=t;break;case h.UVKind:this.uvs=t;break;case h.UV2Kind:this.uvs2=t;break;case h.UV3Kind:this.uvs3=t;break;case h.UV4Kind:this.uvs4=t;break;case h.UV5Kind:this.uvs5=t;break;case h.UV6Kind:this.uvs6=t;break;case h.ColorKind:this.colors=t;break;case h.MatricesIndicesKind:this.matricesIndices=t;break;case h.MatricesWeightsKind:this.matricesWeights=t;break;case h.MatricesIndicesExtraKind:this.matricesIndicesExtra=t;break;case h.MatricesWeightsExtraKind:this.matricesWeightsExtra=t;break}}applyToMesh(t,e){return this._applyTo(t,e,!1),this}applyToGeometry(t,e){return this._applyTo(t,e,!1),this}updateMesh(t){return this._update(t),this}updateGeometry(t){return this._update(t),this}*_applyToCoroutine(t,e=!1,i){if(this.positions&&(t.setVerticesData(h.PositionKind,this.positions,e),i&&(yield)),this.normals&&(t.setVerticesData(h.NormalKind,this.normals,e),i&&(yield)),this.tangents&&(t.setVerticesData(h.TangentKind,this.tangents,e),i&&(yield)),this.uvs&&(t.setVerticesData(h.UVKind,this.uvs,e),i&&(yield)),this.uvs2&&(t.setVerticesData(h.UV2Kind,this.uvs2,e),i&&(yield)),this.uvs3&&(t.setVerticesData(h.UV3Kind,this.uvs3,e),i&&(yield)),this.uvs4&&(t.setVerticesData(h.UV4Kind,this.uvs4,e),i&&(yield)),this.uvs5&&(t.setVerticesData(h.UV5Kind,this.uvs5,e),i&&(yield)),this.uvs6&&(t.setVerticesData(h.UV6Kind,this.uvs6,e),i&&(yield)),this.colors){let s=this.positions&&this.colors.length===this.positions.length?3:4;t.setVerticesData(h.ColorKind,this.colors,e,s),this.hasVertexAlpha&&t.hasVertexAlpha!==void 0&&(t.hasVertexAlpha=!0),i&&(yield)}if(this.matricesIndices&&(t.setVerticesData(h.MatricesIndicesKind,this.matricesIndices,e),i&&(yield)),this.matricesWeights&&(t.setVerticesData(h.MatricesWeightsKind,this.matricesWeights,e),i&&(yield)),this.matricesIndicesExtra&&(t.setVerticesData(h.MatricesIndicesExtraKind,this.matricesIndicesExtra,e),i&&(yield)),this.matricesWeightsExtra&&(t.setVerticesData(h.MatricesWeightsExtraKind,this.matricesWeightsExtra,e),i&&(yield)),this.indices?(t.setIndices(this.indices,null,e),i&&(yield)):t.setIndices([],null),t.subMeshes&&this.materialInfos&&this.materialInfos.length>1){let s=t;s.subMeshes=[];for(let r of this.materialInfos)new Ct(r.materialIndex,r.verticesStart,r.verticesCount,r.indexStart,r.indexCount,s)}return this}_update(t,e,i){return this.positions&&t.updateVerticesData(h.PositionKind,this.positions,e,i),this.normals&&t.updateVerticesData(h.NormalKind,this.normals,e,i),this.tangents&&t.updateVerticesData(h.TangentKind,this.tangents,e,i),this.uvs&&t.updateVerticesData(h.UVKind,this.uvs,e,i),this.uvs2&&t.updateVerticesData(h.UV2Kind,this.uvs2,e,i),this.uvs3&&t.updateVerticesData(h.UV3Kind,this.uvs3,e,i),this.uvs4&&t.updateVerticesData(h.UV4Kind,this.uvs4,e,i),this.uvs5&&t.updateVerticesData(h.UV5Kind,this.uvs5,e,i),this.uvs6&&t.updateVerticesData(h.UV6Kind,this.uvs6,e,i),this.colors&&t.updateVerticesData(h.ColorKind,this.colors,e,i),this.matricesIndices&&t.updateVerticesData(h.MatricesIndicesKind,this.matricesIndices,e,i),this.matricesWeights&&t.updateVerticesData(h.MatricesWeightsKind,this.matricesWeights,e,i),this.matricesIndicesExtra&&t.updateVerticesData(h.MatricesIndicesExtraKind,this.matricesIndicesExtra,e,i),this.matricesWeightsExtra&&t.updateVerticesData(h.MatricesWeightsExtraKind,this.matricesWeightsExtra,e,i),this.indices&&t.setIndices(this.indices,null),this}static _TransformVector3Coordinates(t,e,i=0,s=t.length){let r=d.Vector3[0],l=d.Vector3[1];for(let o=i;o<i+s;o+=3)m.FromArrayToRef(t,o,r),m.TransformCoordinatesToRef(r,e,l),t[o]=l.x,t[o+1]=l.y,t[o+2]=l.z}static _TransformVector3Normals(t,e,i=0,s=t.length){let r=d.Vector3[0],l=d.Vector3[1];for(let o=i;o<i+s;o+=3)m.FromArrayToRef(t,o,r),m.TransformNormalToRef(r,e,l),t[o]=l.x,t[o+1]=l.y,t[o+2]=l.z}static _TransformVector4Normals(t,e,i=0,s=t.length){let r=d.Vector4[0],l=d.Vector4[1];for(let o=i;o<i+s;o+=4)j.FromArrayToRef(t,o,r),j.TransformNormalToRef(r,e,l),t[o]=l.x,t[o+1]=l.y,t[o+2]=l.z,t[o+3]=l.w}static _FlipFaces(t,e=0,i=t.length){for(let s=e;s<e+i;s+=3){let r=t[s+1];t[s+1]=t[s+2],t[s+2]=r}}transform(t){let e=t.determinant()<0;return this.positions&&n._TransformVector3Coordinates(this.positions,t),this.normals&&n._TransformVector3Normals(this.normals,t),this.tangents&&n._TransformVector4Normals(this.tangents,t),e&&this.indices&&n._FlipFaces(this.indices),this}splitBasedOnMaterialID(){if(!this.materialInfos||this.materialInfos.length<2)return[this];let t=[];for(let e of this.materialInfos){let i=new n;if(this.positions&&(i.positions=this.positions.slice(e.verticesStart*3,(e.verticesCount+e.verticesStart)*3)),this.normals&&(i.normals=this.normals.slice(e.verticesStart*3,(e.verticesCount+e.verticesStart)*3)),this.tangents&&(i.tangents=this.tangents.slice(e.verticesStart*4,(e.verticesCount+e.verticesStart)*4)),this.colors&&(i.colors=this.colors.slice(e.verticesStart*4,(e.verticesCount+e.verticesStart)*4)),this.uvs&&(i.uvs=this.uvs.slice(e.verticesStart*2,(e.verticesCount+e.verticesStart)*2)),this.uvs2&&(i.uvs2=this.uvs2.slice(e.verticesStart*2,(e.verticesCount+e.verticesStart)*2)),this.uvs3&&(i.uvs3=this.uvs3.slice(e.verticesStart*2,(e.verticesCount+e.verticesStart)*2)),this.uvs4&&(i.uvs4=this.uvs4.slice(e.verticesStart*2,(e.verticesCount+e.verticesStart)*2)),this.uvs5&&(i.uvs5=this.uvs5.slice(e.verticesStart*2,(e.verticesCount+e.verticesStart)*2)),this.uvs6&&(i.uvs6=this.uvs6.slice(e.verticesStart*2,(e.verticesCount+e.verticesStart)*2)),this.matricesIndices&&(i.matricesIndices=this.matricesIndices.slice(e.verticesStart*4,(e.verticesCount+e.verticesStart)*4)),this.matricesIndicesExtra&&(i.matricesIndicesExtra=this.matricesIndicesExtra.slice(e.verticesStart*4,(e.verticesCount+e.verticesStart)*4)),this.matricesWeights&&(i.matricesWeights=this.matricesWeights.slice(e.verticesStart*4,(e.verticesCount+e.verticesStart)*4)),this.matricesWeightsExtra&&(i.matricesWeightsExtra=this.matricesWeightsExtra.slice(e.verticesStart*4,(e.verticesCount+e.verticesStart)*4)),this.indices){i.indices=[];for(let r=e.indexStart;r<e.indexStart+e.indexCount;r++)i.indices.push(this.indices[r]-e.verticesStart)}let s=new G;s.indexStart=0,s.indexCount=i.indices?i.indices.length:0,s.materialIndex=e.materialIndex,s.verticesStart=0,s.verticesCount=(i.positions?i.positions.length:0)/3,i.materialInfos=[s],t.push(i)}return t}merge(t,e=!1,i=!1,s=!1,r=!1){let l=Array.isArray(t)?t.map(o=>({vertexData:o})):[{vertexData:t}];return dt(this._mergeCoroutine(void 0,l,e,!1,i,s,r))}*_mergeCoroutine(t,e,i=!1,s,r,l=!1,o=!1){this._validate();let u=e.map(a=>a.vertexData),c=this;if(o)for(let a of u)a&&(a._validate(),!this.normals&&a.normals&&(this.normals=new Float32Array(this.positions.length)),!this.tangents&&a.tangents&&(this.tangents=new Float32Array(this.positions.length/3*4)),!this.uvs&&a.uvs&&(this.uvs=new Float32Array(this.positions.length/3*2)),!this.uvs2&&a.uvs2&&(this.uvs2=new Float32Array(this.positions.length/3*2)),!this.uvs3&&a.uvs3&&(this.uvs3=new Float32Array(this.positions.length/3*2)),!this.uvs4&&a.uvs4&&(this.uvs4=new Float32Array(this.positions.length/3*2)),!this.uvs5&&a.uvs5&&(this.uvs5=new Float32Array(this.positions.length/3*2)),!this.uvs6&&a.uvs6&&(this.uvs6=new Float32Array(this.positions.length/3*2)),!this.colors&&a.colors&&(this.colors=new Float32Array(this.positions.length/3*4),this.colors.fill(1)),!this.matricesIndices&&a.matricesIndices&&(this.matricesIndices=new Float32Array(this.positions.length/3*4)),!this.matricesWeights&&a.matricesWeights&&(this.matricesWeights=new Float32Array(this.positions.length/3*4)),!this.matricesIndicesExtra&&a.matricesIndicesExtra&&(this.matricesIndicesExtra=new Float32Array(this.positions.length/3*4)),!this.matricesWeightsExtra&&a.matricesWeightsExtra&&(this.matricesWeightsExtra=new Float32Array(this.positions.length/3*4)));for(let a of u)if(a){if(o)this.normals&&!a.normals&&(a.normals=new Float32Array(a.positions.length)),this.tangents&&!a.tangents&&(a.tangents=new Float32Array(a.positions.length/3*4)),this.uvs&&!a.uvs&&(a.uvs=new Float32Array(a.positions.length/3*2)),this.uvs2&&!a.uvs2&&(a.uvs2=new Float32Array(a.positions.length/3*2)),this.uvs3&&!a.uvs3&&(a.uvs3=new Float32Array(a.positions.length/3*2)),this.uvs4&&!a.uvs4&&(a.uvs4=new Float32Array(a.positions.length/3*2)),this.uvs5&&!a.uvs5&&(a.uvs5=new Float32Array(a.positions.length/3*2)),this.uvs6&&!a.uvs6&&(a.uvs6=new Float32Array(a.positions.length/3*2)),this.colors&&!a.colors&&(a.colors=new Float32Array(a.positions.length/3*4),a.colors.fill(1)),this.matricesIndices&&!a.matricesIndices&&(a.matricesIndices=new Float32Array(a.positions.length/3*4)),this.matricesWeights&&!a.matricesWeights&&(a.matricesWeights=new Float32Array(a.positions.length/3*4)),this.matricesIndicesExtra&&!a.matricesIndicesExtra&&(a.matricesIndicesExtra=new Float32Array(a.positions.length/3*4)),this.matricesWeightsExtra&&!a.matricesWeightsExtra&&(a.matricesWeightsExtra=new Float32Array(a.positions.length/3*4));else if(a._validate(),!this.normals!=!a.normals||!this.tangents!=!a.tangents||!this.uvs!=!a.uvs||!this.uvs2!=!a.uvs2||!this.uvs3!=!a.uvs3||!this.uvs4!=!a.uvs4||!this.uvs5!=!a.uvs5||!this.uvs6!=!a.uvs6||!this.colors!=!a.colors||!this.matricesIndices!=!a.matricesIndices||!this.matricesWeights!=!a.matricesWeights||!this.matricesIndicesExtra!=!a.matricesIndicesExtra||!this.matricesWeightsExtra!=!a.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes")}if(l){let a=0,p=0,_=0,D=[],b=null,A=[];for(let S of this.splitBasedOnMaterialID())A.push({vertexData:S,transform:t});for(let S of e)if(S.vertexData)for(let T of S.vertexData.splitBasedOnMaterialID())A.push({vertexData:T,transform:S.transform});A.sort((S,T)=>{let x=S.vertexData.materialInfos?S.vertexData.materialInfos[0].materialIndex:0,F=T.vertexData.materialInfos?T.vertexData.materialInfos[0].materialIndex:0;return x>F?1:x===F?0:-1});for(let S of A){let T=S.vertexData;if(T.materialInfos?a=T.materialInfos[0].materialIndex:a=0,b&&b.materialIndex===a)b.indexCount+=T.indices.length,b.verticesCount+=T.positions.length/3;else{let x=new G;x.materialIndex=a,x.indexStart=p,x.indexCount=T.indices.length,x.verticesStart=_,x.verticesCount=T.positions.length/3,D.push(x),b=x}p+=T.indices.length,_+=T.positions.length/3}let C=A.splice(0,1)[0];c=C.vertexData,t=C.transform,u=A.map(S=>S.vertexData),e=A,this.materialInfos=D}let f=u.reduce((a,p)=>a+(p.indices?.length??0),c.indices?.length??0),M=r||u.some(a=>a.indices===c.indices)?c.indices?.slice():c.indices;if(f>0){let a=M?.length??0;if(M||(M=new Array(f)),M.length!==f){if(Array.isArray(M))M.length=f;else{let _=i||M instanceof Uint32Array?new Uint32Array(f):new Uint16Array(f);_.set(M),M=_}t&&t.determinant()<0&&n._FlipFaces(M,0,a)}let p=c.positions?c.positions.length/3:0;for(let{vertexData:_,transform:D}of e)if(_.indices){for(let b=0;b<_.indices.length;b++)M[a+b]=_.indices[b]+p;D&&D.determinant()<0&&n._FlipFaces(M,a,_.indices.length),p+=_.positions.length/3,a+=_.indices.length,s&&(yield)}}return this.indices=M,this.positions=n._MergeElement(h.PositionKind,c.positions,t,e.map(a=>[a.vertexData.positions,a.transform])),s&&(yield),c.normals&&(this.normals=n._MergeElement(h.NormalKind,c.normals,t,e.map(a=>[a.vertexData.normals,a.transform])),s&&(yield)),c.tangents&&(this.tangents=n._MergeElement(h.TangentKind,c.tangents,t,e.map(a=>[a.vertexData.tangents,a.transform])),s&&(yield)),c.uvs&&(this.uvs=n._MergeElement(h.UVKind,c.uvs,t,e.map(a=>[a.vertexData.uvs,a.transform])),s&&(yield)),c.uvs2&&(this.uvs2=n._MergeElement(h.UV2Kind,c.uvs2,t,e.map(a=>[a.vertexData.uvs2,a.transform])),s&&(yield)),c.uvs3&&(this.uvs3=n._MergeElement(h.UV3Kind,c.uvs3,t,e.map(a=>[a.vertexData.uvs3,a.transform])),s&&(yield)),c.uvs4&&(this.uvs4=n._MergeElement(h.UV4Kind,c.uvs4,t,e.map(a=>[a.vertexData.uvs4,a.transform])),s&&(yield)),c.uvs5&&(this.uvs5=n._MergeElement(h.UV5Kind,c.uvs5,t,e.map(a=>[a.vertexData.uvs5,a.transform])),s&&(yield)),c.uvs6&&(this.uvs6=n._MergeElement(h.UV6Kind,c.uvs6,t,e.map(a=>[a.vertexData.uvs6,a.transform])),s&&(yield)),c.colors&&(this.colors=n._MergeElement(h.ColorKind,c.colors,t,e.map(a=>[a.vertexData.colors,a.transform])),(c.hasVertexAlpha!==void 0||e.some(a=>a.vertexData.hasVertexAlpha!==void 0))&&(this.hasVertexAlpha=c.hasVertexAlpha||e.some(a=>a.vertexData.hasVertexAlpha)),s&&(yield)),c.matricesIndices&&(this.matricesIndices=n._MergeElement(h.MatricesIndicesKind,c.matricesIndices,t,e.map(a=>[a.vertexData.matricesIndices,a.transform])),s&&(yield)),c.matricesWeights&&(this.matricesWeights=n._MergeElement(h.MatricesWeightsKind,c.matricesWeights,t,e.map(a=>[a.vertexData.matricesWeights,a.transform])),s&&(yield)),c.matricesIndicesExtra&&(this.matricesIndicesExtra=n._MergeElement(h.MatricesIndicesExtraKind,c.matricesIndicesExtra,t,e.map(a=>[a.vertexData.matricesIndicesExtra,a.transform])),s&&(yield)),c.matricesWeightsExtra&&(this.matricesWeightsExtra=n._MergeElement(h.MatricesWeightsExtraKind,c.matricesWeightsExtra,t,e.map(a=>[a.vertexData.matricesWeightsExtra,a.transform]))),this}static _MergeElement(t,e,i,s){let r=s.filter(u=>u[0]!==null&&u[0]!==void 0);if(!e&&r.length==0)return e;if(!e)return this._MergeElement(t,r[0][0],r[0][1],r.slice(1));let l=r.reduce((u,c)=>u+c[0].length,e.length),o=t===h.PositionKind?n._TransformVector3Coordinates:t===h.NormalKind?n._TransformVector3Normals:t===h.TangentKind?n._TransformVector4Normals:()=>{};if(e instanceof Float32Array){let u=new Float32Array(l);u.set(e),i&&o(u,i,0,e.length);let c=e.length;for(let[f,g]of r)u.set(f,c),g&&o(u,g,c,f.length),c+=f.length;return u}else{let u=new Array(l);for(let f=0;f<e.length;f++)u[f]=e[f];i&&o(u,i,0,e.length);let c=e.length;for(let[f,g]of r){for(let M=0;M<f.length;M++)u[c+M]=f[M];g&&o(u,g,c,f.length),c+=f.length}return u}}_validate(){if(!this.positions)throw new It("Positions are required",xt.MeshInvalidPositionsError);let t=(s,r)=>{let l=h.DeduceStride(s);if(r.length%l!==0)throw new Error("The "+s+"s array count must be a multiple of "+l);return r.length/l},e=t(h.PositionKind,this.positions),i=(s,r)=>{let l=t(s,r);if(l!==e)throw new Error("The "+s+"s element count ("+l+") does not match the positions count ("+e+")")};this.normals&&i(h.NormalKind,this.normals),this.tangents&&i(h.TangentKind,this.tangents),this.uvs&&i(h.UVKind,this.uvs),this.uvs2&&i(h.UV2Kind,this.uvs2),this.uvs3&&i(h.UV3Kind,this.uvs3),this.uvs4&&i(h.UV4Kind,this.uvs4),this.uvs5&&i(h.UV5Kind,this.uvs5),this.uvs6&&i(h.UV6Kind,this.uvs6),this.colors&&i(h.ColorKind,this.colors),this.matricesIndices&&i(h.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&i(h.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&i(h.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&i(h.MatricesWeightsExtraKind,this.matricesWeightsExtra)}clone(){let t=this.serialize();return n.Parse(t)}serialize(){let t={};if(this.positions&&(t.positions=Array.from(this.positions)),this.normals&&(t.normals=Array.from(this.normals)),this.tangents&&(t.tangents=Array.from(this.tangents)),this.uvs&&(t.uvs=Array.from(this.uvs)),this.uvs2&&(t.uvs2=Array.from(this.uvs2)),this.uvs3&&(t.uvs3=Array.from(this.uvs3)),this.uvs4&&(t.uvs4=Array.from(this.uvs4)),this.uvs5&&(t.uvs5=Array.from(this.uvs5)),this.uvs6&&(t.uvs6=Array.from(this.uvs6)),this.colors&&(t.colors=Array.from(this.colors),t.hasVertexAlpha=this.hasVertexAlpha),this.matricesIndices&&(t.matricesIndices=Array.from(this.matricesIndices),t.matricesIndicesExpanded=!0),this.matricesWeights&&(t.matricesWeights=Array.from(this.matricesWeights)),this.matricesIndicesExtra&&(t.matricesIndicesExtra=Array.from(this.matricesIndicesExtra),t.matricesIndicesExtraExpanded=!0),this.matricesWeightsExtra&&(t.matricesWeightsExtra=Array.from(this.matricesWeightsExtra)),t.indices=this.indices?Array.from(this.indices):[],this.materialInfos){t.materialInfos=[];for(let e of this.materialInfos){let i={indexStart:e.indexStart,indexCount:e.indexCount,materialIndex:e.materialIndex,verticesStart:e.verticesStart,verticesCount:e.verticesCount};t.materialInfos.push(i)}}return t}static ExtractFromMesh(t,e,i){return n._ExtractFrom(t,e,i)}static ExtractFromGeometry(t,e,i){return n._ExtractFrom(t,e,i)}static _ExtractFrom(t,e,i){let s=new n;if(t.isVerticesDataPresent(h.PositionKind)&&(s.positions=t.getVerticesData(h.PositionKind,e,i)),t.isVerticesDataPresent(h.NormalKind)&&(s.normals=t.getVerticesData(h.NormalKind,e,i)),t.isVerticesDataPresent(h.TangentKind)&&(s.tangents=t.getVerticesData(h.TangentKind,e,i)),t.isVerticesDataPresent(h.UVKind)&&(s.uvs=t.getVerticesData(h.UVKind,e,i)),t.isVerticesDataPresent(h.UV2Kind)&&(s.uvs2=t.getVerticesData(h.UV2Kind,e,i)),t.isVerticesDataPresent(h.UV3Kind)&&(s.uvs3=t.getVerticesData(h.UV3Kind,e,i)),t.isVerticesDataPresent(h.UV4Kind)&&(s.uvs4=t.getVerticesData(h.UV4Kind,e,i)),t.isVerticesDataPresent(h.UV5Kind)&&(s.uvs5=t.getVerticesData(h.UV5Kind,e,i)),t.isVerticesDataPresent(h.UV6Kind)&&(s.uvs6=t.getVerticesData(h.UV6Kind,e,i)),t.isVerticesDataPresent(h.ColorKind)){let r=t.geometry||t,l=r.getVertexBuffer(h.ColorKind),o=r.getVerticesData(h.ColorKind,e,i);if(l.getSize()===3){let u=new Float32Array(o.length*4/3);for(let c=0,f=0;c<o.length;c+=3,f+=4)u[f]=o[c],u[f+1]=o[c+1],u[f+2]=o[c+2],u[f+3]=1;s.colors=u}else if(l.getSize()===4)s.colors=o;else throw new Error(`Unexpected number of color components: ${l.getSize()}`)}return t.isVerticesDataPresent(h.MatricesIndicesKind)&&(s.matricesIndices=t.getVerticesData(h.MatricesIndicesKind,e,i)),t.isVerticesDataPresent(h.MatricesWeightsKind)&&(s.matricesWeights=t.getVerticesData(h.MatricesWeightsKind,e,i)),t.isVerticesDataPresent(h.MatricesIndicesExtraKind)&&(s.matricesIndicesExtra=t.getVerticesData(h.MatricesIndicesExtraKind,e,i)),t.isVerticesDataPresent(h.MatricesWeightsExtraKind)&&(s.matricesWeightsExtra=t.getVerticesData(h.MatricesWeightsExtraKind,e,i)),s.indices=t.getIndices(e,i),s}static CreateRibbon(t){throw R("ribbonBuilder")}static CreateBox(t){throw R("boxBuilder")}static CreateTiledBox(t){throw R("tiledBoxBuilder")}static CreateTiledPlane(t){throw R("tiledPlaneBuilder")}static CreateSphere(t){throw R("sphereBuilder")}static CreateCylinder(t){throw R("cylinderBuilder")}static CreateTorus(t){throw R("torusBuilder")}static CreateLineSystem(t){throw R("linesBuilder")}static CreateDashedLines(t){throw R("linesBuilder")}static CreateGround(t){throw R("groundBuilder")}static CreateTiledGround(t){throw R("groundBuilder")}static CreateGroundFromHeightMap(t){throw R("groundBuilder")}static CreatePlane(t){throw R("planeBuilder")}static CreateDisc(t){throw R("discBuilder")}static CreatePolygon(t,e,i,s,r,l,o){throw R("polygonBuilder")}static CreateIcoSphere(t){throw R("icoSphereBuilder")}static CreatePolyhedron(t){throw R("polyhedronBuilder")}static CreateCapsule(t={orientation:m.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw R("capsuleBuilder")}static CreateTorusKnot(t){throw R("torusKnotBuilder")}static ComputeNormals(t,e,i,s){let r=0,l=0,o=0,u=0,c=0,f=0,g=0,M=0,a=0,p=0,_=0,D=0,b=0,A=0,C=0,S=0,T=0,x=0,F=0,V=0,Mt=!1,pt=!1,lt=!1,ht=!1,tt=1,B=0,et=null;s&&(Mt=!!s.facetNormals,pt=!!s.facetPositions,lt=!!s.facetPartitioning,tt=s.useRightHandedSystem===!0?-1:1,B=s.ratio||0,ht=!!s.depthSort,et=s.distanceTo,ht&&et===void 0&&(et=m.Zero()));let X=0,Z=0,H=0,q=0;for(lt&&s&&s.bbSize&&(X=s.subDiv.X*B/s.bbSize.x,Z=s.subDiv.Y*B/s.bbSize.y,H=s.subDiv.Z*B/s.bbSize.z,q=s.subDiv.max*s.subDiv.max,s.facetPartitioning.length=0),r=0;r<t.length;r++)i[r]=0;let Bt=e.length/3|0;for(r=0;r<Bt;r++){if(D=e[r*3]*3,b=D+1,A=D+2,C=e[r*3+1]*3,S=C+1,T=C+2,x=e[r*3+2]*3,F=x+1,V=x+2,l=t[D]-t[C],o=t[b]-t[S],u=t[A]-t[T],c=t[x]-t[C],f=t[F]-t[S],g=t[V]-t[T],M=tt*(o*g-u*f),a=tt*(u*c-l*g),p=tt*(l*f-o*c),_=Math.sqrt(M*M+a*a+p*p),_=_===0?1:_,M/=_,a/=_,p/=_,Mt&&s&&(s.facetNormals[r].x=M,s.facetNormals[r].y=a,s.facetNormals[r].z=p),pt&&s&&(s.facetPositions[r].x=(t[D]+t[C]+t[x])/3,s.facetPositions[r].y=(t[b]+t[S]+t[F])/3,s.facetPositions[r].z=(t[A]+t[T]+t[V])/3),lt&&s){let it=Math.floor((s.facetPositions[r].x-s.bInfo.minimum.x*B)*X),wt=Math.floor((s.facetPositions[r].y-s.bInfo.minimum.y*B)*Z),Ot=Math.floor((s.facetPositions[r].z-s.bInfo.minimum.z*B)*H),Qt=Math.floor((t[D]-s.bInfo.minimum.x*B)*X),Vt=Math.floor((t[b]-s.bInfo.minimum.y*B)*Z),Lt=Math.floor((t[A]-s.bInfo.minimum.z*B)*H),Nt=Math.floor((t[C]-s.bInfo.minimum.x*B)*X),Wt=Math.floor((t[S]-s.bInfo.minimum.y*B)*Z),Ut=Math.floor((t[T]-s.bInfo.minimum.z*B)*H),zt=Math.floor((t[x]-s.bInfo.minimum.x*B)*X),Kt=Math.floor((t[F]-s.bInfo.minimum.y*B)*Z),kt=Math.floor((t[V]-s.bInfo.minimum.z*B)*H),L=Qt+s.subDiv.max*Vt+q*Lt,N=Nt+s.subDiv.max*Wt+q*Ut,W=zt+s.subDiv.max*Kt+q*kt,U=it+s.subDiv.max*wt+q*Ot;s.facetPartitioning[U]=s.facetPartitioning[U]?s.facetPartitioning[U]:[],s.facetPartitioning[L]=s.facetPartitioning[L]?s.facetPartitioning[L]:[],s.facetPartitioning[N]=s.facetPartitioning[N]?s.facetPartitioning[N]:[],s.facetPartitioning[W]=s.facetPartitioning[W]?s.facetPartitioning[W]:[],s.facetPartitioning[L].push(r),N!=L&&s.facetPartitioning[N].push(r),W==N||W==L||s.facetPartitioning[W].push(r),U==L||U==N||U==W||s.facetPartitioning[U].push(r)}if(ht&&s&&s.facetPositions){let it=s.depthSortedFacets[r];it.ind=r*3,it.sqDistance=m.DistanceSquared(s.facetPositions[r],et)}i[D]+=M,i[b]+=a,i[A]+=p,i[C]+=M,i[S]+=a,i[T]+=p,i[x]+=M,i[F]+=a,i[V]+=p}for(r=0;r<i.length/3;r++)M=i[r*3],a=i[r*3+1],p=i[r*3+2],_=Math.sqrt(M*M+a*a+p*p),_=_===0?1:_,M/=_,a/=_,p/=_,i[r*3]=M,i[r*3+1]=a,i[r*3+2]=p}static _ComputeSides(t,e,i,s,r,l,o){let u=i.length,c=s.length,f,g;switch(t=t||n.DEFAULTSIDE,t){case n.FRONTSIDE:break;case n.BACKSIDE:for(f=0;f<u;f+=3){let M=i[f];i[f]=i[f+2],i[f+2]=M}for(g=0;g<c;g++)s[g]=-s[g];break;case n.DOUBLESIDE:{let M=e.length,a=M/3;for(let D=0;D<M;D++)e[M+D]=e[D];for(f=0;f<u;f+=3)i[f+u]=i[f+2]+a,i[f+1+u]=i[f+1]+a,i[f+2+u]=i[f]+a;for(g=0;g<c;g++)s[c+g]=-s[g];let p=r.length,_=0;for(_=0;_<p;_++)r[_+p]=r[_];for(l=l||new j(0,0,1,1),o=o||new j(0,0,1,1),_=0,f=0;f<p/2;f++)r[_]=l.x+(l.z-l.x)*r[_],r[_+1]=l.y+(l.w-l.y)*r[_+1],r[_+p]=o.x+(o.z-o.x)*r[_+p],r[_+p+1]=o.y+(o.w-o.y)*r[_+p+1],_+=2;break}}}static Parse(t){let e=new n,i=t.positions;i&&e.set(i,h.PositionKind);let s=t.normals;s&&e.set(s,h.NormalKind);let r=t.tangents;r&&e.set(r,h.TangentKind);let l=t.uvs;l&&e.set(l,h.UVKind);let o=t.uvs2;o&&e.set(o,h.UV2Kind);let u=t.uvs3;u&&e.set(u,h.UV3Kind);let c=t.uvs4;c&&e.set(c,h.UV4Kind);let f=t.uvs5;f&&e.set(f,h.UV5Kind);let g=t.uvs6;g&&e.set(g,h.UV6Kind);let M=t.colors;M&&(e.set(rt.CheckColors4(M,i.length/3),h.ColorKind),t.hasVertexAlpha!==void 0&&(e.hasVertexAlpha=t.hasVertexAlpha));let a=t.matricesIndices;a&&e.set(a,h.MatricesIndicesKind);let p=t.matricesWeights;p&&e.set(p,h.MatricesWeightsKind);let _=t.indices;_&&(e.indices=_);let D=t.materialInfos;if(D){e.materialInfos=[];for(let b of D){let A=new G;A.indexCount=b.indexCount,A.indexStart=b.indexStart,A.verticesCount=b.verticesCount,A.verticesStart=b.verticesStart,A.materialIndex=b.materialIndex,e.materialInfos.push(A)}}return e}static ImportVertexData(t,e){let i=n.Parse(t);e.setAllVerticesData(i,t.updatable)}};O.FRONTSIDE=0;O.BACKSIDE=1;O.DOUBLESIDE=2;O.DEFAULTSIDE=0;O._UniqueIdGenerator=0;E([k.filter((...[n])=>!Array.isArray(n))],O,"_TransformVector3Coordinates",null);E([k.filter((...[n])=>!Array.isArray(n))],O,"_TransformVector3Normals",null);E([k.filter((...[n])=>!Array.isArray(n))],O,"_TransformVector4Normals",null);E([k.filter((...[n])=>!Array.isArray(n))],O,"_FlipFaces",null);var I=class n extends ut{get billboardMode(){return this._billboardMode}set billboardMode(t){this._billboardMode!==t&&(this._billboardMode=t,this._cache.useBillboardPosition=(this._billboardMode&n.BILLBOARDMODE_USE_POSITION)!==0)}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(t){this._infiniteDistance!==t&&(this._infiniteDistance=t)}constructor(t,e=null,i=!0){super(t,e,!1),this._forward=new m(0,0,1),this._up=new m(0,1,0),this._right=new m(1,0,0),this._position=m.Zero(),this._rotation=m.Zero(),this._rotationQuaternion=null,this._scaling=m.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=n.BILLBOARDMODE_NONE,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=y.Zero(),this._usePivotMatrix=!1,this._absolutePosition=m.Zero(),this._absoluteScaling=m.Zero(),this._absoluteRotationQuaternion=P.Identity(),this._pivotMatrix=y.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new z,this._nonUniformScaling=!1,i&&this.getScene().addTransformNode(this)}getClassName(){return"TransformNode"}get position(){return this._position}set position(t){this._position=t,this._markAsDirtyInternal()}isUsingPivotMatrix(){return this._usePivotMatrix}isUsingPostMultiplyPivotMatrix(){return this._postMultiplyPivotMatrix}get rotation(){return this._rotation}set rotation(t){this._rotation=t,this._rotationQuaternion=null,this._markAsDirtyInternal()}get scaling(){return this._scaling}set scaling(t){this._scaling=t,this._markAsDirtyInternal()}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(t){this._rotationQuaternion=t,t&&this._rotation.setAll(0),this._markAsDirtyInternal()}_markAsDirtyInternal(){this._isDirty||(this._isDirty=!0,this.customMarkAsDirty&&this.customMarkAsDirty())}get forward(){return m.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return m.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return m.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(t){return this._poseMatrix?(this._poseMatrix.copyFrom(t),this):(this._poseMatrix=t.clone(),this)}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=y.Identity()),this._poseMatrix}_isSynchronized(){let t=this._cache;return!(this._billboardMode!==t.billboardMode||this._billboardMode!==n.BILLBOARDMODE_NONE||t.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}_initCache(){super._initCache();let t=this._cache;t.localMatrixUpdated=!1,t.billboardMode=-1,t.infiniteDistance=!1,t.useBillboardPosition=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(t){return this.setPivotMatrix(t,!1)}setPivotMatrix(t,e=!0){return this._pivotMatrix.copyFrom(t),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=e,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=y.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(t=null,e,i){let s=this.clone("Clone of "+(this.name||this.id),t||this.parent,!0);s&&i&&i(this,s);for(let r of this.getChildTransformNodes(!0))r.instantiateHierarchy(s,e,i);return s}freezeWorldMatrix(t=null,e=!1){return t?e?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||P.Identity(),t.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=t,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(t){if(!t)return this;let e,i,s;if(t.x===void 0){if(arguments.length<3)return this;e=arguments[0],i=arguments[1],s=arguments[2]}else e=t.x,i=t.y,s=t.z;if(this.parent){let r=d.Matrix[0];this.parent.getWorldMatrix().invertToRef(r),m.TransformCoordinatesFromFloatsToRef(e,i,s,r,this.position)}else this.position.x=e,this.position.y=i,this.position.z=s;return this._absolutePosition.copyFrom(t),this}setPositionWithLocalVector(t){return this.computeWorldMatrix(),this.position=m.TransformNormal(t,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();let t=d.Matrix[0];return this._localMatrix.invertToRef(t),m.TransformNormal(this.position,t)}locallyTranslate(t){return this.computeWorldMatrix(!0),this.position=m.TransformCoordinates(t,this._localMatrix),this}lookAt(t,e=0,i=0,s=0,r=0){let l=n._LookAtVectorCache,o=r===0?this.position:this.getAbsolutePosition();if(t.subtractToRef(o,l),this.setDirection(l,e,i,s),r===1&&this.parent)if(this.rotationQuaternion){let u=d.Matrix[0];this.rotationQuaternion.toRotationMatrix(u);let c=d.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(c),c.invert(),u.multiplyToRef(c,u),this.rotationQuaternion.fromRotationMatrix(u)}else{let u=d.Quaternion[0];P.FromEulerVectorToRef(this.rotation,u);let c=d.Matrix[0];u.toRotationMatrix(c);let f=d.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(f),f.invert(),c.multiplyToRef(f,c),u.fromRotationMatrix(c),u.toEulerAnglesToRef(this.rotation)}return this}getDirection(t){let e=m.Zero();return this.getDirectionToRef(t,e),e}getDirectionToRef(t,e){return m.TransformNormalToRef(t,this.getWorldMatrix(),e),this}setDirection(t,e=0,i=0,s=0){let r=-Math.atan2(t.z,t.x)+Math.PI/2,l=Math.sqrt(t.x*t.x+t.z*t.z),o=-Math.atan2(t.y,l);return this.rotationQuaternion?P.RotationYawPitchRollToRef(r+e,o+i,s,this.rotationQuaternion):(this.rotation.x=o+i,this.rotation.y=r+e,this.rotation.z=s),this}setPivotPoint(t,e=0){this.getScene().getRenderId()==0&&this.computeWorldMatrix(!0);let i=this.getWorldMatrix();if(e==1){let s=d.Matrix[0];i.invertToRef(s),t=m.TransformCoordinates(t,s)}return this.setPivotMatrix(y.Translation(-t.x,-t.y,-t.z),!0)}getPivotPoint(){let t=m.Zero();return this.getPivotPointToRef(t),t}getPivotPointToRef(t){return t.x=-this._pivotMatrix.m[12],t.y=-this._pivotMatrix.m[13],t.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){let t=m.Zero();return this.getAbsolutePivotPointToRef(t),t}getAbsolutePivotPointToRef(t){return this.getPivotPointToRef(t),m.TransformCoordinatesToRef(t,this.getWorldMatrix(),t),this}markAsDirty(t){if(this._isDirty)return this;if(this._children)for(let e of this._children)e.markAsDirty(t);return super.markAsDirty(t)}setParent(t,e=!1,i=!1){if(!t&&!this.parent)return this;let s=d.Quaternion[0],r=d.Vector3[0],l=d.Vector3[1],o=d.Matrix[1];y.IdentityToRef(o);let u=d.Matrix[0];this.computeWorldMatrix(!0);let c=this.rotationQuaternion;return c||(c=n._TmpRotation,P.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,c)),y.ComposeToRef(this.scaling,c,this.position,u),this.parent&&u.multiplyToRef(this.parent.computeWorldMatrix(!0),u),t&&(t.computeWorldMatrix(!0).invertToRef(o),u.multiplyToRef(o,u)),u.decompose(l,s,r,e?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(s):s.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(l),this.position.copyFrom(r),this.parent=t,i&&this.setPivotMatrix(y.Identity()),this}addChild(t,e=!1){return t.setParent(this,e),this}removeChild(t,e=!1){return t.parent!==this?this:(t.setParent(null,e),this)}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(t){return this._nonUniformScaling===t?!1:(this._nonUniformScaling=t,!0)}attachToBone(t,e){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=e,this.parent=t,t.getSkeleton().prepare(!0),t.getFinalMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(t=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,t?this.parent=this._currentParentWhenAttachingToBone:this.parent=null,this):(t&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(t,e,i){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0));let s;if(!i||i===0)s=P.RotationAxisToRef(t,e,n._RotationAxisCache),this.rotationQuaternion.multiplyToRef(s,this.rotationQuaternion);else{if(this.parent){let r=this.parent.getWorldMatrix(),l=d.Matrix[0];r.invertToRef(l),t=m.TransformNormal(t,l),r.determinant()<0&&(e*=-1)}s=P.RotationAxisToRef(t,e,n._RotationAxisCache),s.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}return this}rotateAround(t,e,i){e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=P.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));let s=d.Vector3[0],r=d.Vector3[1],l=d.Vector3[2],o=d.Quaternion[0],u=d.Matrix[0],c=d.Matrix[1],f=d.Matrix[2],g=d.Matrix[3];return t.subtractToRef(this.position,s),y.TranslationToRef(s.x,s.y,s.z,u),y.TranslationToRef(-s.x,-s.y,-s.z,c),y.RotationAxisToRef(e,i,f),c.multiplyToRef(f,g),g.multiplyToRef(u,g),g.decompose(r,o,l),this.position.addInPlace(l),o.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(t,e,i){let s=t.scale(e);if(!i||i===0){let r=this.getPositionExpressedInLocalSpace().add(s);this.setPositionWithLocalVector(r)}else this.setAbsolutePosition(this.getAbsolutePosition().add(s));return this}addRotation(t,e,i){let s;this.rotationQuaternion?s=this.rotationQuaternion:(s=d.Quaternion[1],P.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,s));let r=d.Quaternion[0];return P.RotationYawPitchRollToRef(e,t,i,r),s.multiplyInPlace(r),this.rotationQuaternion||s.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}isWorldMatrixCameraDependent(){return this._infiniteDistance&&!this.parent||this._billboardMode!==n.BILLBOARDMODE_NONE}computeWorldMatrix(t=!1,e=null){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;let i=this.getScene().getRenderId();if(!this._isDirty&&!t&&(this._currentRenderId===i||this.isSynchronized()))return this._currentRenderId=i,this._worldMatrix;e=e||this.getScene().activeCamera,this._updateCache();let s=this._cache;s.pivotMatrixUpdated=!1,s.billboardMode=this.billboardMode,s.infiniteDistance=this.infiniteDistance,s.parent=this._parentNode,this._currentRenderId=i,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;let r=this._getEffectiveParent(),l=n._TmpScaling,o=this._position;if(this._infiniteDistance&&!this.parent&&e){let c=e.getWorldMatrix(),f=new m(c.m[12],c.m[13],c.m[14]);o=n._TmpTranslation,o.copyFromFloats(this._position.x+f.x,this._position.y+f.y,this._position.z+f.z)}l.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant);let u;if(this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,u=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(P.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(u=n._TmpRotation,P.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,u)),this._usePivotMatrix){let c=d.Matrix[1];y.ScalingToRef(l.x,l.y,l.z,c);let f=d.Matrix[0];u.toRotationMatrix(f),this._pivotMatrix.multiplyToRef(c,d.Matrix[4]),d.Matrix[4].multiplyToRef(f,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(o.x,o.y,o.z)}else y.ComposeToRef(l,u,o,this._localMatrix);if(r&&r.getWorldMatrix){if(t&&r.computeWorldMatrix(t),this.billboardMode){if(this._transformToBoneReferal){let M=this.parent;M.getSkeleton().prepare(),M.getFinalMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),d.Matrix[7])}else d.Matrix[7].copyFrom(r.getWorldMatrix());let c=d.Vector3[5],f=d.Vector3[6],g=d.Quaternion[0];d.Matrix[7].decompose(f,g,c),y.ScalingToRef(f.x,f.y,f.z,d.Matrix[7]),d.Matrix[7].setTranslation(c),n.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(g,c),this._localMatrix.setTranslation(c)),this._localMatrix.multiplyToRef(d.Matrix[7],this._worldMatrix)}else if(this._transformToBoneReferal){let c=this.parent;c.getSkeleton().prepare(),this._localMatrix.multiplyToRef(c.getFinalMatrix(),d.Matrix[6]),d.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)}else this._localMatrix.multiplyToRef(r.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(e&&this.billboardMode)if(s.useBillboardPosition){let c=d.Vector3[0];this._worldMatrix.getTranslationToRef(c);let f=e.globalPosition;this._worldMatrix.invertToRef(d.Matrix[1]);let g=d.Vector3[1];m.TransformCoordinatesToRef(f,d.Matrix[1],g),g.normalize();let M=-Math.atan2(g.z,g.x)+Math.PI/2,a=Math.sqrt(g.x*g.x+g.z*g.z),p=-Math.atan2(g.y,a);if(P.RotationYawPitchRollToRef(M,p,0,d.Quaternion[0]),(this.billboardMode&n.BILLBOARDMODE_ALL)!==n.BILLBOARDMODE_ALL){let _=d.Vector3[1];d.Quaternion[0].toEulerAnglesToRef(_),(this.billboardMode&n.BILLBOARDMODE_X)!==n.BILLBOARDMODE_X&&(_.x=0),(this.billboardMode&n.BILLBOARDMODE_Y)!==n.BILLBOARDMODE_Y&&(_.y=0),(this.billboardMode&n.BILLBOARDMODE_Z)!==n.BILLBOARDMODE_Z&&(_.z=0),y.RotationYawPitchRollToRef(_.y,_.x,_.z,d.Matrix[0])}else y.FromQuaternionToRef(d.Quaternion[0],d.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(d.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(d.Vector3[0])}else{let c=d.Vector3[0];this._worldMatrix.getTranslationToRef(c),d.Matrix[1].copyFrom(e.getViewMatrix());let f=this.getScene().useRightHandedSystem;if(f&&d.Matrix[1].multiplyToRef(n._TmpRHRestore,d.Matrix[1]),d.Matrix[1].setTranslationFromFloats(0,0,0),d.Matrix[1].invertToRef(d.Matrix[0]),(this.billboardMode&n.BILLBOARDMODE_ALL)!==n.BILLBOARDMODE_ALL){d.Matrix[0].decompose(void 0,d.Quaternion[0],void 0);let g=d.Vector3[1];d.Quaternion[0].toEulerAnglesToRef(g),(this.billboardMode&n.BILLBOARDMODE_X)!==n.BILLBOARDMODE_X&&(g.x=0),(this.billboardMode&n.BILLBOARDMODE_Y)!==n.BILLBOARDMODE_Y&&(g.y=0),(this.billboardMode&n.BILLBOARDMODE_Z)!==n.BILLBOARDMODE_Z&&(g.z=0),f&&(g.y+=Math.PI),y.RotationYawPitchRollToRef(g.y,g.x,g.z,d.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(d.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(d.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):r&&r._nonUniformScaling?this._updateNonUniformScalingState(r._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=y.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(t=!0){if(this.computeWorldMatrix(),t){let e=this.getChildren();for(let i=0;i<e.length;++i){let s=e[i];if(s){s.computeWorldMatrix();let r=d.Matrix[0];s._localMatrix.multiplyToRef(this._localMatrix,r);let l=d.Quaternion[0];r.decompose(s.scaling,l,s.position),s.rotationQuaternion?s.rotationQuaternion.copyFrom(l):l.toEulerAnglesToRef(s.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=P.Identity()),this._worldMatrix=y.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(t){return this.onAfterWorldMatrixUpdateObservable.add(t),this}unregisterAfterWorldMatrixUpdate(t){return this.onAfterWorldMatrixUpdateObservable.removeCallback(t),this}getPositionInCameraSpace(t=null){return t||(t=this.getScene().activeCamera),m.TransformCoordinates(this.getAbsolutePosition(),t.getViewMatrix())}getDistanceToCamera(t=null){return t||(t=this.getScene().activeCamera),this.getAbsolutePosition().subtract(t.globalPosition).length()}clone(t,e,i){let s=J.Clone(()=>new n(t,this.getScene()),this);if(s.name=t,s.id=t,e&&(s.parent=e),!i){let r=this.getDescendants(!0);for(let l=0;l<r.length;l++){let o=r[l];o.clone&&o.clone(t+"."+o.name,s)}}return s}serialize(t){let e=J.Serialize(this,t);return e.type=this.getClassName(),e.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(e),e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(),J.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e}static Parse(t,e,i){let s=J.Parse(()=>new n(t.name,e),t,e,i);if(t.localMatrix?s.setPreTransformMatrix(y.FromArray(t.localMatrix)):t.pivotMatrix&&s.setPivotMatrix(y.FromArray(t.pivotMatrix)),s.setEnabled(t.isEnabled),s._waitingParsedUniqueId=t.uniqueId,t.parentId!==void 0&&(s._waitingParentId=t.parentId),t.parentInstanceIndex!==void 0&&(s._waitingParentInstanceIndex=t.parentInstanceIndex),t.animations){for(let r=0;r<t.animations.length;r++){let l=t.animations[r],o=yt("BABYLON.Animation");o&&s.animations.push(o.Parse(l))}ut.ParseAnimationRanges(s,t,e)}return t.autoAnimate&&e.beginAnimation(s,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),s}getChildTransformNodes(t,e){let i=[];return this._getDescendants(i,t,s=>(!e||e(s))&&s instanceof n),i}dispose(t,e=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){let i=this._parentContainer.transformNodes.indexOf(this);i>-1&&this._parentContainer.transformNodes.splice(i,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),t){let i=this.getChildTransformNodes(!0);for(let s of i)s.parent=null,s.computeWorldMatrix(!0)}super.dispose(t,e)}normalizeToUnitCube(t=!0,e=!1,i){let s=null,r=null;e&&(this.rotationQuaternion?(r=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(s=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));let l=this.getHierarchyBoundingVectors(t,i),o=l.max.subtract(l.min),u=Math.max(o.x,o.y,o.z);if(u===0)return this;let c=1/u;return this.scaling.scaleInPlace(c),e&&(this.rotationQuaternion&&r?this.rotationQuaternion.copyFrom(r):this.rotation&&s&&this.rotation.copyFrom(s)),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}};I.BILLBOARDMODE_NONE=0;I.BILLBOARDMODE_X=1;I.BILLBOARDMODE_Y=2;I.BILLBOARDMODE_Z=4;I.BILLBOARDMODE_ALL=7;I.BILLBOARDMODE_USE_POSITION=128;I.BillboardUseParentOrientation=!1;I._TmpRotation=P.Zero();I._TmpScaling=m.Zero();I._TmpTranslation=m.Zero();I._TmpRHRestore=y.Scaling(1,1,-1);I._LookAtVectorCache=new m(0,0,0);I._RotationAxisCache=new P;E([nt("position")],I.prototype,"_position",void 0);E([nt("rotation")],I.prototype,"_rotation",void 0);E([At("rotationQuaternion")],I.prototype,"_rotationQuaternion",void 0);E([nt("scaling")],I.prototype,"_scaling",void 0);E([Y("billboardMode")],I.prototype,"_billboardMode",void 0);E([Y()],I.prototype,"scalingDeterminant",void 0);E([Y("infiniteDistance")],I.prototype,"_infiniteDistance",void 0);E([Y()],I.prototype,"ignoreNonUniformScaling",void 0);E([Y()],I.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0);var at=class{constructor(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new m(0,0,0),this._diffPositionForCollisions=new m(0,0,0),this._collisionResponse=!0}};function Yt(n,t,e){let i=null;switch(t){case h.PositionKind:i=s=>s.getPositions();break;case h.NormalKind:i=s=>s.getNormals();break;case h.TangentKind:i=s=>s.getTangents();break;case h.UVKind:i=s=>s.getUVs();break;case h.UV2Kind:i=s=>s.getUV2s();break;case h.ColorKind:i=s=>s.getColors();break;default:return}for(let s=0;s<n.length;s++){let r=n[s];for(let l=0;l<e.numTargets;l++){let o=e.getTarget(l),u=o.influence;if(u!==0){let c=i(o);c&&(r+=(c[s]-n[s])*u)}}n[s]=r}}function Xt(n,t,e,i,s,r,l){let o=d.Vector3[0],u=d.Matrix[0],c=d.Matrix[1],f=t===h.NormalKind?m.TransformNormalFromFloatsToRef:m.TransformCoordinatesFromFloatsToRef;for(let g=0,M=0;g<n.length;g+=3,M+=4){u.reset();let a,p;for(a=0;a<4;a++)p=s[M+a],p>0&&(y.FromFloat32ArrayToRefScaled(e,Math.floor(i[M+a]*16),p,c),u.addToSelf(c));if(r&&l)for(a=0;a<4;a++)p=l[M+a],p>0&&(y.FromFloat32ArrayToRefScaled(e,Math.floor(r[M+a]*16),p,c),u.addToSelf(c));f(n[g],n[g+1],n[g+2],u,o),o.toArray(n,g)}}var gt=class{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=m.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}},mt=class{constructor(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new gt,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=new Map,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new at,this._enableDistantPicking=!1,this._rawBoundingInfo=null,this._sideOrientationHint=!1,this._wasActiveLastFrame=!1}},v=class n extends I{static get BILLBOARDMODE_NONE(){return I.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return I.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return I.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return I.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return I.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return I.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(t){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=t}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(t){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=t}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(t){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=t}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(t){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=t}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(t){this._internalAbstractMeshDataInfo._collisionRetryCount=t}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(t){this._internalAbstractMeshDataInfo._morphTargetManager!==t&&(this._internalAbstractMeshDataInfo._morphTargetManager=t,this._syncGeometryWithMorphTargetManager())}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(t){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==t&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=t,this._markSubMeshesAsAttributesDirty())}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(t){return super._updateNonUniformScalingState(t)?(this._markSubMeshesAsMiscDirty(),!0):!1}get rawBoundingInfo(){return this._internalAbstractMeshDataInfo._rawBoundingInfo}set rawBoundingInfo(t){this._internalAbstractMeshDataInfo._rawBoundingInfo=t}set onCollide(t){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(t)}set onCollisionPositionChange(t){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(t)}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(t){if(this._internalAbstractMeshDataInfo._visibility===t)return;let e=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=t,(e===1&&t!==1||e!==1&&t===1)&&this._markSubMeshesAsDirty(i=>{i.markAsMiscDirty(),i.markAsPrePassDirty()})}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(t){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=t}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(t){this._internalAbstractMeshDataInfo._renderingGroupId=t}get material(){return this._internalAbstractMeshDataInfo._material}set material(t){this._setMaterial(t)}_setMaterial(t){this._internalAbstractMeshDataInfo._material!==t&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=t,t&&t.meshMap&&(t.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(void 0,t==null),this._unBindEffect()))}getMaterialForRenderPass(t){return this._internalAbstractMeshDataInfo._materialForRenderPass?.[t]}setMaterialForRenderPass(t,e){this.resetDrawCache(t),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]);let i=this._internalAbstractMeshDataInfo._materialForRenderPass[t];i?.meshMap?.[this.uniqueId]&&(i.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._materialForRenderPass[t]=e,e&&e.meshMap&&(e.meshMap[this.uniqueId]=this)}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(t){this._internalAbstractMeshDataInfo._receiveShadows!==t&&(this._internalAbstractMeshDataInfo._receiveShadows=t,this._markSubMeshesAsLightDirty())}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(t){this._internalAbstractMeshDataInfo._hasVertexAlpha!==t&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=t,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(t){this._internalAbstractMeshDataInfo._useVertexColors!==t&&(this._internalAbstractMeshDataInfo._useVertexColors=t,this._markSubMeshesAsAttributesDirty())}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(t){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==t&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=t,this._markSubMeshesAsAttributesDirty())}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(t){this._internalAbstractMeshDataInfo._numBoneInfluencers!==t&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=t,this._markSubMeshesAsAttributesDirty())}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(t){this._internalAbstractMeshDataInfo._applyFog!==t&&(this._internalAbstractMeshDataInfo._applyFog=t,this._markSubMeshesAsMiscDirty())}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(t){this._internalAbstractMeshDataInfo._enableDistantPicking=t}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(t){t!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=t,this._resyncLightSources())}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(t){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(t)?-1:t}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(t){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=t}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(t){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(t)?-1:t}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(t){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=t}get lightSources(){return this._lightSources}set skeleton(t){let e=this._internalAbstractMeshDataInfo._skeleton;e&&e.needInitialSkinMatrix&&e._unregisterMeshWithPoseMatrix(this),t&&t.needInitialSkinMatrix&&t._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=t,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}constructor(t,e=null){switch(super(t,e,!1),this._internalAbstractMeshDataInfo=new mt,this._waitingMaterialId=null,this._waitingMorphTargetManagerId=null,this.cullingStrategy=n.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new z,this.onCollisionPositionChangeObservable=new z,this.onMaterialChangedObservable=new z,this.definedFacingForward=!0,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=ct.Red(),this.outlineWidth=.02,this.overlayColor=ct.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new m(.5,1,.5),this.ellipsoidOffset=new m(0,0,0),this.edgesWidth=1,this.edgesColor=new rt(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=!0,this._renderId=0,this._intersectionsInProgress=new Array,this._unIndexed=!1,this._lightSources=new Array,this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new z,this._onCollisionPositionChange=(i,s,r=null)=>{s.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>Q.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),r&&this.onCollideObservable.notifyObservers(r),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},e=this.getScene(),e.addMesh(this),this._resyncLightSources(),this._uniformBuffer=new St(this.getScene().getEngine(),void 0,void 0,t,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),e.performancePriority){case 2:this.doNotSyncBoundingInfo=!0;case 1:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1;break}}_buildUniformLayout(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()}transferToEffect(t){let e=this._uniformBuffer;e.updateMatrix("world",t),e.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),e.update()}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return"AbstractMesh"}toString(t){let e="Name: "+this.name+", isInstance: "+(this.getClassName()==="InstancedMesh"?"YES":"NO");e+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);let i=this._internalAbstractMeshDataInfo._skeleton;return i&&(e+=", skeleton: "+i.name),t&&(e+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],e+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),e}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==I.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(t,e=!0){if(this.actionManager&&(e||this.actionManager.isRecursive))if(t){if(this.actionManager.hasSpecificTrigger(t))return this.actionManager}else return this.actionManager;return this.parent?this.parent._getActionManagerForTrigger(t,!1):null}_rebuild(t=!1){if(this.onRebuildObservable.notifyObservers(this),this._occlusionQuery!==null&&(this._occlusionQuery=null),!!this.subMeshes){for(let e of this.subMeshes)e._rebuild();this.resetDrawCache()}}_resyncLightSources(){this._lightSources.length=0;for(let t of this.getScene().lights)t.isEnabled()&&t.canAffectMesh(this)&&this._lightSources.push(t);this._markSubMeshesAsLightDirty()}_resyncLightSource(t){let e=t.isEnabled()&&t.canAffectMesh(this),i=this._lightSources.indexOf(t),s=!1;if(i===-1){if(!e)return;this._lightSources.push(t)}else{if(e)return;s=!0,this._lightSources.splice(i,1)}this._markSubMeshesAsLightDirty(s)}_unBindEffect(){for(let t of this.subMeshes)t.setEffect(null)}_removeLightSource(t,e){let i=this._lightSources.indexOf(t);i!==-1&&(this._lightSources.splice(i,1),this._markSubMeshesAsLightDirty(e))}_markSubMeshesAsDirty(t){if(this.subMeshes)for(let e of this.subMeshes)for(let i=0;i<e._drawWrappers.length;++i){let s=e._drawWrappers[i];!s||!s.defines||!s.defines.markAllAsDirty||t(s.defines)}}_markSubMeshesAsLightDirty(t=!1){this._markSubMeshesAsDirty(e=>e.markAsLightDirty(t))}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty(t=>t.markAsAttributesDirty())}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty(t=>t.markAsMiscDirty())}markAsDirty(t){return this._currentRenderId=Number.MAX_VALUE,super.markAsDirty(t),this._isDirty=!0,this}resetDrawCache(t,e=!1){if(this.subMeshes)for(let i of this.subMeshes)i.resetDrawCache(t,e)}get isBlocked(){return!1}getLOD(t){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(t){return null}setVerticesData(t,e,i,s){return this}updateVerticesData(t,e,i,s){return this}setIndices(t,e){return this}isVerticesDataPresent(t){return!1}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}getRawBoundingInfo(){return this.rawBoundingInfo??this.getBoundingInfo()}setBoundingInfo(t){return this._boundingInfo=t,this}get hasBoundingInfo(){return this._boundingInfo!==null}buildBoundingInfo(t,e,i){return this._boundingInfo=new $(t,e,i),this._boundingInfo}normalizeToUnitCube(t=!0,e=!1,i){return super.normalizeToUnitCube(t,e,i)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(h.MatricesIndicesKind)&&this.isVerticesDataPresent(h.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(t){}_activate(t,e){return this._renderId=t,!0}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===I.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(t,e,i){return this.position.addInPlace(this.calcMovePOV(t,e,i)),this}calcMovePOV(t,e,i){let s=new y;(this.rotationQuaternion?this.rotationQuaternion:P.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(s);let l=m.Zero(),o=this.definedFacingForward?-1:1;return m.TransformCoordinatesFromFloatsToRef(t*o,e,i*o,s,l),l}rotatePOV(t,e,i){return this.rotation.addInPlace(this.calcRotatePOV(t,e,i)),this}calcRotatePOV(t,e,i){let s=this.definedFacingForward?1:-1;return new m(t*s,e,i*s)}_refreshBoundingInfo(t,e){if(t){let i=Pt(t,0,this.getTotalVertices(),e);this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new $(i.minimum,i.maximum)}if(this.subMeshes)for(let i=0;i<this.subMeshes.length;i++)this.subMeshes[i].refreshBoundingInfo(t);this._updateBoundingInfo()}_refreshBoundingInfoDirect(t){if(this._boundingInfo?this._boundingInfo.reConstruct(t.minimum,t.maximum):this._boundingInfo=new $(t.minimum,t.maximum),this.subMeshes)for(let e=0;e<this.subMeshes.length;e++)this.subMeshes[e].refreshBoundingInfo(null);this._updateBoundingInfo()}static _ApplySkeleton(t,e,i,s,r,l,o){Xt(t,e,i,s,r,l,o)}_getData(t,e,i=h.PositionKind){let s=t.cache,r=l=>{if(s){let o=s._vertexData||(s._vertexData={});return o[l]||this.copyVerticesData(l,o),o[l]}return this.getVerticesData(l)};if(e||(e=r(i)),!e)return null;if(s?(s._outputData?s._outputData.set(e):s._outputData=new Float32Array(e),e=s._outputData):(t.applyMorph&&this.morphTargetManager||t.applySkeleton&&this.skeleton)&&(e=e.slice()),t.applyMorph&&this.morphTargetManager&&Yt(e,i,this.morphTargetManager),t.applySkeleton&&this.skeleton){let l=r(h.MatricesIndicesKind),o=r(h.MatricesWeightsKind);if(o&&l){let u=this.numBoneInfluencers>4,c=u?r(h.MatricesIndicesExtraKind):null,f=u?r(h.MatricesWeightsExtraKind):null,g=this.skeleton.getTransformMatrices(this);n._ApplySkeleton(e,i,g,l,o,c,f)}}if(t.updatePositionsArray!==!1&&i===h.PositionKind){let l=this._internalAbstractMeshDataInfo._positions||[],o=l.length;if(l.length=e.length/3,o<l.length)for(let u=o;u<l.length;u++)l[u]=new m;for(let u=0,c=0;u<l.length;u++,c+=3)l[u].copyFromFloats(e[c],e[c+1],e[c+2]);this._internalAbstractMeshDataInfo._positions=l}return e}getNormalsData(t=!1,e=!1){return this._getData({applySkeleton:t,applyMorph:e,updatePositionsArray:!1},null,h.NormalKind)}getPositionData(t=!1,e=!1,i=null){return this._getData({applySkeleton:t,applyMorph:e,updatePositionsArray:!1},i,h.PositionKind)}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new $(m.Zero(),m.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(t){if(!this.subMeshes)return this;let e=this.subMeshes.length;for(let i=0;i<e;i++){let s=this.subMeshes[i];(e>1||!s.IsGlobal)&&s.updateBoundingInfo(t)}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}isInFrustum(t){return this.getBoundingInfo().isInFrustum(t,this.cullingStrategy)}isCompletelyInFrustum(t){return this.getBoundingInfo().isCompletelyInFrustum(t)}intersectsMesh(t,e=!1,i){let s=this.getBoundingInfo(),r=t.getBoundingInfo();if(s.intersects(r,e))return!0;if(i){for(let l of this.getChildMeshes())if(l.intersectsMesh(t,e,!0))return!0}return!1}intersectsPoint(t){return this.getBoundingInfo().intersectsPoint(t)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(t){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=t}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(t,e=!0){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);let s=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=s.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,s.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,t,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId,e),this}_collideForSubMesh(t,e,i){if(this._generatePointsArray(),!this._positions)return this;if(!t._lastColliderWorldVertices||!t._lastColliderTransformMatrix.equals(e)){t._lastColliderTransformMatrix=e.clone(),t._lastColliderWorldVertices=[],t._trianglePlanes=[];let s=t.verticesStart,r=t.verticesStart+t.verticesCount;for(let l=s;l<r;l++)t._lastColliderWorldVertices.push(m.TransformCoordinates(this._positions[l],e))}return i._collide(t._trianglePlanes,t._lastColliderWorldVertices,this.getIndices(),t.indexStart,t.indexStart+t.indexCount,t.verticesStart,!!t.getMaterial(),this,this._shouldConvertRHS(),t.getMaterial()?.fillMode===7),this}_processCollisionsForSubMeshes(t,e){let i=this._scene.getCollidingSubMeshCandidates(this,t),s=i.length;for(let r=0;r<s;r++){let l=i.data[r];s>1&&!l._checkCollision(t)||this._collideForSubMesh(l,e,t)}return this}_shouldConvertRHS(){return!1}_checkCollision(t){if(!this.getBoundingInfo()._checkCollision(t))return this;let e=d.Matrix[0],i=d.Matrix[1];return y.ScalingToRef(1/t._radius.x,1/t._radius.y,1/t._radius.z,e),this.worldMatrixFromCache.multiplyToRef(e,i),this._processCollisionsForSubMeshes(t,i),this}_generatePointsArray(){return!1}intersects(t,e,i,s=!1,r,l=!1){let o=new Rt,u=this.getClassName(),c=u==="InstancedLinesMesh"||u==="LinesMesh"||u==="GreasedLineMesh"?this.intersectionThreshold:0,f=this.getBoundingInfo();if(!this.subMeshes||!l&&(!t.intersectsSphere(f.boundingSphere,c)||!t.intersectsBox(f.boundingBox,c)))return o;if(s)return o.hit=!l,o.pickedMesh=l?null:this,o.distance=l?0:m.Distance(t.origin,f.boundingSphere.center),o.subMeshId=0,o;if(!this._generatePointsArray())return o;let g=null,M=this._scene.getIntersectingSubMeshCandidates(this,t),a=M.length,p=!1;for(let _=0;_<a;_++){let b=M.data[_].getMaterial();if(b&&(b.fillMode==7||b.fillMode==0||b.fillMode==1||b.fillMode==2||b.fillMode==4)){p=!0;break}}if(!p)return o.hit=!0,o.pickedMesh=this,o.distance=m.Distance(t.origin,f.boundingSphere.center),o.subMeshId=-1,o;for(let _=0;_<a;_++){let D=M.data[_];if(a>1&&!l&&!D.canIntersects(t))continue;let b=D.intersects(t,this._positions,this.getIndices(),e,i);if(b&&(e||!g||b.distance<g.distance)&&(g=b,g.subMeshId=D._id,g._internalSubMeshId=_,e))break}if(g){let _=r??this.getWorldMatrix(),D=d.Vector3[0],b=d.Vector3[1];m.TransformCoordinatesToRef(t.origin,_,D),t.direction.scaleToRef(g.distance,b);let C=m.TransformNormal(b,_).addInPlace(D);return o.hit=!0,o.distance=m.Distance(D,C),o.pickedPoint=C,o.pickedMesh=this,o.bu=g.bu||0,o.bv=g.bv||0,o.subMeshFaceId=g.faceId,o.faceId=g.faceId+M.data[g._internalSubMeshId].indexStart/(this.getClassName().indexOf("LinesMesh")!==-1?2:3),o.subMeshId=g.subMeshId,o}return o}clone(t,e,i){return null}releaseSubMeshes(t=!1){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose(t);else this.subMeshes=[];return this}dispose(t,e=!1){let i,s=this.getScene();for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),s.freeActiveMeshes(),s.freeRenderingGroups(),s.renderingManager.maintainStateBetweenFrames&&s.renderingManager.restoreDispachedFlags(),this.actionManager!==void 0&&this.actionManager!==null&&(this.actionManager.disposeWhenUnowned&&!this._scene.meshes.some(o=>o!==this&&o.actionManager===this.actionManager)&&this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),i=0;i<this._intersectionsInProgress.length;i++){let o=this._intersectionsInProgress[i],u=o._intersectionsInProgress.indexOf(this);o._intersectionsInProgress.splice(u,1)}this._intersectionsInProgress.length=0;let r=s.lights;for(let o of r){let u=o.includedOnlyMeshes.indexOf(this);u!==-1&&o.includedOnlyMeshes.splice(u,1),u=o.excludedMeshes.indexOf(this),u!==-1&&o.excludedMeshes.splice(u,1);let c=o.getShadowGenerators();if(c){let f=c.values();for(let g=f.next();g.done!==!0;g=f.next()){let a=g.value.getShadowMap();a&&a.renderList&&(u=a.renderList.indexOf(this),u!==-1&&a.renderList.splice(u,1))}}}(this.getClassName()!=="InstancedMesh"||this.getClassName()!=="InstancedLinesMesh")&&this.releaseSubMeshes(!0);let l=s.getEngine();if(this._occlusionQuery!==null&&(this.isOcclusionQueryInProgress=!1,l.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),l.wipeCaches(),s.removeMesh(this),this._parentContainer){let o=this._parentContainer.meshes.indexOf(this);o>-1&&this._parentContainer.meshes.splice(o,1),this._parentContainer=null}if(e&&this.material&&(this.material.getClassName()==="MultiMaterial"?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!t)for(i=0;i<s.particleSystems.length;i++)s.particleSystems[i].emitter===this&&(s.particleSystems[i].dispose(),i--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(t,e)}_initFacetData(){let t=this._internalAbstractMeshDataInfo._facetData;t.facetNormals||(t.facetNormals=[]),t.facetPositions||(t.facetPositions=[]),t.facetPartitioning||(t.facetPartitioning=new Array),t.facetNb=this.getIndices().length/3|0,t.partitioningSubdivisions=t.partitioningSubdivisions?t.partitioningSubdivisions:10,t.partitioningBBoxRatio=t.partitioningBBoxRatio?t.partitioningBBoxRatio:1.01;for(let e=0;e<t.facetNb;e++)t.facetNormals[e]=m.Zero(),t.facetPositions[e]=m.Zero();return t.facetDataEnabled=!0,this}updateFacetData(){let t=this._internalAbstractMeshDataInfo._facetData;t.facetDataEnabled||this._initFacetData();let e=this.getVerticesData(h.PositionKind),i=this.getIndices(),s=this.getVerticesData(h.NormalKind),r=this.getBoundingInfo();if(t.facetDepthSort&&!t.facetDepthSortEnabled){if(t.facetDepthSortEnabled=!0,i instanceof Uint16Array)t.depthSortedIndices=new Uint16Array(i);else if(i instanceof Uint32Array)t.depthSortedIndices=new Uint32Array(i);else{let o=!1;for(let u=0;u<i.length;u++)if(i[u]>65535){o=!0;break}o?t.depthSortedIndices=new Uint32Array(i):t.depthSortedIndices=new Uint16Array(i)}if(t.facetDepthSortFunction=function(o,u){return u.sqDistance-o.sqDistance},!t.facetDepthSortFrom){let o=this.getScene().activeCamera;t.facetDepthSortFrom=o?o.position:m.Zero()}t.depthSortedFacets=[];for(let o=0;o<t.facetNb;o++){let u={ind:o*3,sqDistance:0};t.depthSortedFacets.push(u)}t.invertedMatrix=y.Identity(),t.facetDepthSortOrigin=m.Zero()}t.bbSize.x=r.maximum.x-r.minimum.x>K?r.maximum.x-r.minimum.x:K,t.bbSize.y=r.maximum.y-r.minimum.y>K?r.maximum.y-r.minimum.y:K,t.bbSize.z=r.maximum.z-r.minimum.z>K?r.maximum.z-r.minimum.z:K;let l=t.bbSize.x>t.bbSize.y?t.bbSize.x:t.bbSize.y;if(l=l>t.bbSize.z?l:t.bbSize.z,t.subDiv.max=t.partitioningSubdivisions,t.subDiv.X=Math.floor(t.subDiv.max*t.bbSize.x/l),t.subDiv.Y=Math.floor(t.subDiv.max*t.bbSize.y/l),t.subDiv.Z=Math.floor(t.subDiv.max*t.bbSize.z/l),t.subDiv.X=t.subDiv.X<1?1:t.subDiv.X,t.subDiv.Y=t.subDiv.Y<1?1:t.subDiv.Y,t.subDiv.Z=t.subDiv.Z<1?1:t.subDiv.Z,t.facetParameters.facetNormals=this.getFacetLocalNormals(),t.facetParameters.facetPositions=this.getFacetLocalPositions(),t.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),t.facetParameters.bInfo=r,t.facetParameters.bbSize=t.bbSize,t.facetParameters.subDiv=t.subDiv,t.facetParameters.ratio=this.partitioningBBoxRatio,t.facetParameters.depthSort=t.facetDepthSort,t.facetDepthSort&&t.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(t.invertedMatrix),m.TransformCoordinatesToRef(t.facetDepthSortFrom,t.invertedMatrix,t.facetDepthSortOrigin),t.facetParameters.distanceTo=t.facetDepthSortOrigin),t.facetParameters.depthSortedFacets=t.depthSortedFacets,s&&O.ComputeNormals(e,i,s,t.facetParameters),t.facetDepthSort&&t.facetDepthSortEnabled){t.depthSortedFacets.sort(t.facetDepthSortFunction);let o=t.depthSortedIndices.length/3|0;for(let u=0;u<o;u++){let c=t.depthSortedFacets[u].ind;t.depthSortedIndices[u*3]=i[c],t.depthSortedIndices[u*3+1]=i[c+1],t.depthSortedIndices[u*3+2]=i[c+2]}this.updateIndices(t.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){let t=this._internalAbstractMeshDataInfo._facetData;return t.facetNormals||this.updateFacetData(),t.facetNormals}getFacetLocalPositions(){let t=this._internalAbstractMeshDataInfo._facetData;return t.facetPositions||this.updateFacetData(),t.facetPositions}getFacetLocalPartitioning(){let t=this._internalAbstractMeshDataInfo._facetData;return t.facetPartitioning||this.updateFacetData(),t.facetPartitioning}getFacetPosition(t){let e=m.Zero();return this.getFacetPositionToRef(t,e),e}getFacetPositionToRef(t,e){let i=this.getFacetLocalPositions()[t],s=this.getWorldMatrix();return m.TransformCoordinatesToRef(i,s,e),this}getFacetNormal(t){let e=m.Zero();return this.getFacetNormalToRef(t,e),e}getFacetNormalToRef(t,e){let i=this.getFacetLocalNormals()[t];return m.TransformNormalToRef(i,this.getWorldMatrix(),e),this}getFacetsAtLocalCoordinates(t,e,i){let s=this.getBoundingInfo(),r=this._internalAbstractMeshDataInfo._facetData,l=Math.floor((t-s.minimum.x*r.partitioningBBoxRatio)*r.subDiv.X*r.partitioningBBoxRatio/r.bbSize.x),o=Math.floor((e-s.minimum.y*r.partitioningBBoxRatio)*r.subDiv.Y*r.partitioningBBoxRatio/r.bbSize.y),u=Math.floor((i-s.minimum.z*r.partitioningBBoxRatio)*r.subDiv.Z*r.partitioningBBoxRatio/r.bbSize.z);return l<0||l>r.subDiv.max||o<0||o>r.subDiv.max||u<0||u>r.subDiv.max?null:r.facetPartitioning[l+r.subDiv.max*o+r.subDiv.max*r.subDiv.max*u]}getClosestFacetAtCoordinates(t,e,i,s,r=!1,l=!0){let o=this.getWorldMatrix(),u=d.Matrix[5];o.invertToRef(u);let c=d.Vector3[8];m.TransformCoordinatesFromFloatsToRef(t,e,i,u,c);let f=this.getClosestFacetAtLocalCoordinates(c.x,c.y,c.z,s,r,l);return s&&m.TransformCoordinatesFromFloatsToRef(s.x,s.y,s.z,o,s),f}getClosestFacetAtLocalCoordinates(t,e,i,s,r=!1,l=!0){let o=null,u=0,c=0,f=0,g=0,M=0,a=0,p=0,_=0,D=this.getFacetLocalPositions(),b=this.getFacetLocalNormals(),A=this.getFacetsAtLocalCoordinates(t,e,i);if(!A)return null;let C=Number.MAX_VALUE,S=C,T,x,F;for(let V=0;V<A.length;V++)T=A[V],x=b[T],F=D[T],g=(t-F.x)*x.x+(e-F.y)*x.y+(i-F.z)*x.z,(!r||r&&l&&g>=0||r&&!l&&g<=0)&&(g=x.x*F.x+x.y*F.y+x.z*F.z,M=-(x.x*t+x.y*e+x.z*i-g)/(x.x*x.x+x.y*x.y+x.z*x.z),a=t+x.x*M,p=e+x.y*M,_=i+x.z*M,u=a-t,c=p-e,f=_-i,S=u*u+c*c+f*f,S<C&&(C=S,o=T,s&&(s.x=a,s.y=p,s.z=_)));return o}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){let t=this._internalAbstractMeshDataInfo._facetData;return t.facetDataEnabled&&(t.facetDataEnabled=!1,t.facetPositions=[],t.facetNormals=[],t.facetPartitioning=new Array,t.facetParameters={},t.depthSortedIndices=new Uint32Array(0)),this}updateIndices(t,e,i=!1){return this}createNormals(t){let e=this.getVerticesData(h.PositionKind),i=this.getIndices(),s;return this.isVerticesDataPresent(h.NormalKind)?s=this.getVerticesData(h.NormalKind):s=[],O.ComputeNormals(e,i,s,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(h.NormalKind,s,t),this}optimizeIndicesAsync(){return st(this,null,function*(){let t=this.getIndices();if(!t)return this;let{OptimizeIndices:e}=yield import("./chunk-4SPUOVIA.js");return e(t),this.setIndices(t,this.getTotalVertices()),this})}alignWithNormal(t,e){e||(e=vt.Y);let i=d.Vector3[0],s=d.Vector3[1];return m.CrossToRef(e,t,s),m.CrossToRef(t,s,i),this.rotationQuaternion?P.RotationQuaternionFromAxisToRef(i,t,s,this.rotationQuaternion):m.RotationFromAxisToRef(i,t,s,this.rotation),this}_checkOcclusionQuery(){return!1}disableEdgesRendering(){throw R("EdgesRenderer")}enableEdgesRendering(t,e,i){throw R("EdgesRenderer")}getConnectedParticleSystems(){return this._scene.particleSystems.filter(t=>t.emitter===this)}};v.OCCLUSION_TYPE_NONE=0;v.OCCLUSION_TYPE_OPTIMISTIC=1;v.OCCLUSION_TYPE_STRICT=2;v.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0;v.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1;v.CULLINGSTRATEGY_STANDARD=0;v.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1;v.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2;v.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3;E([k.filter((...[n,t,e,i,s])=>!Array.isArray(n)&&!Array.isArray(t)&&!Array.isArray(e)&&!Array.isArray(i)&&!Array.isArray(s))],v,"_ApplySkeleton",null);Dt("BABYLON.AbstractMesh",v);var ot=class{constructor(){this._timeElapsedQueryEnded=!1}};Q.prototype.getGPUFrameTimeCounter=function(){return this._gpuFrameTime||(this._gpuFrameTime=new Tt),this._gpuFrameTime};Q.prototype.captureGPUFrameTime=function(n){};var _t=class{constructor(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=!1,this.isOccluded=!1,this.occlusionRetryCount=-1,this.occlusionType=v.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=v.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,this.forceRenderingWhenOccluded=!1}};Q.prototype.createQuery=function(){return null};Q.prototype.deleteQuery=function(n){return this};Q.prototype.isQueryResultAvailable=function(n){return!1};Q.prototype.getQueryResult=function(n){return 0};Q.prototype.beginOcclusionQuery=function(n,t){return!1};Q.prototype.endOcclusionQuery=function(n){return this};Object.defineProperty(v.prototype,"isOcclusionQueryInProgress",{get:function(){return this._occlusionDataStorage.isOcclusionQueryInProgress},set:function(n){this._occlusionDataStorage.isOcclusionQueryInProgress=n},enumerable:!1,configurable:!0});Object.defineProperty(v.prototype,"_occlusionDataStorage",{get:function(){return this.__occlusionDataStorage||(this.__occlusionDataStorage=new _t),this.__occlusionDataStorage},enumerable:!1,configurable:!0});Object.defineProperty(v.prototype,"isOccluded",{get:function(){return this._occlusionDataStorage.isOccluded},set:function(n){this._occlusionDataStorage.isOccluded=n},enumerable:!0,configurable:!0});Object.defineProperty(v.prototype,"occlusionQueryAlgorithmType",{get:function(){return this._occlusionDataStorage.occlusionQueryAlgorithmType},set:function(n){this._occlusionDataStorage.occlusionQueryAlgorithmType=n},enumerable:!0,configurable:!0});Object.defineProperty(v.prototype,"occlusionType",{get:function(){return this._occlusionDataStorage.occlusionType},set:function(n){this._occlusionDataStorage.occlusionType=n},enumerable:!0,configurable:!0});Object.defineProperty(v.prototype,"occlusionRetryCount",{get:function(){return this._occlusionDataStorage.occlusionRetryCount},set:function(n){this._occlusionDataStorage.occlusionRetryCount=n},enumerable:!0,configurable:!0});Object.defineProperty(v.prototype,"forceRenderingWhenOccluded",{get:function(){return this._occlusionDataStorage.forceRenderingWhenOccluded},set:function(n){this._occlusionDataStorage.forceRenderingWhenOccluded=n},enumerable:!0,configurable:!0});v.prototype._checkOcclusionQuery=function(){let n=this._occlusionDataStorage;if(n.occlusionType===v.OCCLUSION_TYPE_NONE)return n.isOccluded=!1,!1;let t=this.getEngine();if(!t.getCaps().supportOcclusionQuery||!t.isQueryResultAvailable)return n.isOccluded=!1,!1;if(this.isOcclusionQueryInProgress&&this._occlusionQuery!==null&&this._occlusionQuery!==void 0)if(t.isQueryResultAvailable(this._occlusionQuery)){let s=t.getQueryResult(this._occlusionQuery);n.isOcclusionQueryInProgress=!1,n.occlusionInternalRetryCounter=0,n.isOccluded=!(s>0)}else if(n.occlusionInternalRetryCounter++,n.occlusionRetryCount!==-1&&n.occlusionInternalRetryCounter>n.occlusionRetryCount)n.isOcclusionQueryInProgress=!1,n.occlusionInternalRetryCounter=0,n.isOccluded=n.occlusionType===v.OCCLUSION_TYPE_OPTIMISTIC?!1:n.isOccluded;else return n.occlusionType===v.OCCLUSION_TYPE_OPTIMISTIC?!1:n.isOccluded;let e=this.getScene();if(e.getBoundingBoxRenderer){let i=e.getBoundingBoxRenderer();this._occlusionQuery===null&&(this._occlusionQuery=t.createQuery()),this._occlusionQuery&&t.beginOcclusionQuery(n.occlusionQueryAlgorithmType,this._occlusionQuery)&&(i.renderOcclusionBoundingBox(this),t.endOcclusionQuery(n.occlusionQueryAlgorithmType),this._occlusionDataStorage.isOcclusionQueryInProgress=!0)}return n.isOccluded};w.prototype.createQuery=function(){let n=this._gl.createQuery();if(!n)throw new Error("Unable to create Occlusion Query");return n};w.prototype.deleteQuery=function(n){return this._gl.deleteQuery(n),this};w.prototype.isQueryResultAvailable=function(n){return this._gl.getQueryParameter(n,this._gl.QUERY_RESULT_AVAILABLE)};w.prototype.getQueryResult=function(n){return this._gl.getQueryParameter(n,this._gl.QUERY_RESULT)};w.prototype.beginOcclusionQuery=function(n,t){let e=this._getGlAlgorithmType(n);return this._gl.beginQuery(e,t),!0};w.prototype.endOcclusionQuery=function(n){let t=this._getGlAlgorithmType(n);return this._gl.endQuery(t),this};w.prototype._createTimeQuery=function(){let n=this.getCaps().timerQuery;return n.createQueryEXT?n.createQueryEXT():this.createQuery()};w.prototype._deleteTimeQuery=function(n){let t=this.getCaps().timerQuery;if(t.deleteQueryEXT){t.deleteQueryEXT(n);return}this.deleteQuery(n)};w.prototype._getTimeQueryResult=function(n){let t=this.getCaps().timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(n,t.QUERY_RESULT_EXT):this.getQueryResult(n)};w.prototype._getTimeQueryAvailability=function(n){let t=this.getCaps().timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(n,t.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(n)};w.prototype.startTimeQuery=function(){let n=this.getCaps(),t=n.timerQuery;if(!t)return null;let e=new ot;if(this._gl.getParameter(t.GPU_DISJOINT_EXT),n.canUseTimestampForTimerQuery)e._startTimeQuery=this._createTimeQuery(),e._startTimeQuery&&t.queryCounterEXT(e._startTimeQuery,t.TIMESTAMP_EXT);else{if(this._currentNonTimestampToken)return this._currentNonTimestampToken;e._timeElapsedQuery=this._createTimeQuery(),e._timeElapsedQuery&&(t.beginQueryEXT?t.beginQueryEXT(t.TIME_ELAPSED_EXT,e._timeElapsedQuery):this._gl.beginQuery(t.TIME_ELAPSED_EXT,e._timeElapsedQuery)),this._currentNonTimestampToken=e}return e};w.prototype.endTimeQuery=function(n){let t=this.getCaps(),e=t.timerQuery;if(!e||!n)return-1;if(t.canUseTimestampForTimerQuery){if(!n._startTimeQuery)return-1;n._endTimeQuery||(n._endTimeQuery=this._createTimeQuery(),n._endTimeQuery&&e.queryCounterEXT(n._endTimeQuery,e.TIMESTAMP_EXT))}else if(!n._timeElapsedQueryEnded){if(!n._timeElapsedQuery)return-1;e.endQueryEXT?e.endQueryEXT(e.TIME_ELAPSED_EXT):(this._gl.endQuery(e.TIME_ELAPSED_EXT),this._currentNonTimestampToken=null),n._timeElapsedQueryEnded=!0}let i=this._gl.getParameter(e.GPU_DISJOINT_EXT),s=!1;if(n._endTimeQuery?s=this._getTimeQueryAvailability(n._endTimeQuery):n._timeElapsedQuery&&(s=this._getTimeQueryAvailability(n._timeElapsedQuery)),s&&!i){let r=0;if(t.canUseTimestampForTimerQuery){if(!n._startTimeQuery||!n._endTimeQuery)return-1;let l=this._getTimeQueryResult(n._startTimeQuery);r=this._getTimeQueryResult(n._endTimeQuery)-l,this._deleteTimeQuery(n._startTimeQuery),this._deleteTimeQuery(n._endTimeQuery),n._startTimeQuery=null,n._endTimeQuery=null}else{if(!n._timeElapsedQuery)return-1;r=this._getTimeQueryResult(n._timeElapsedQuery),this._deleteTimeQuery(n._timeElapsedQuery),n._timeElapsedQuery=null,n._timeElapsedQueryEnded=!1}return r}return-1};w.prototype.captureGPUFrameTime=function(n){if(n!==this._captureGPUFrameTime)if(this._captureGPUFrameTime=n,n){let t=this.getGPUFrameTimeCounter();this._onBeginFrameObserver=this.onBeginFrameObservable.add(()=>{this._gpuFrameTimeToken||(this._gpuFrameTimeToken=this.startTimeQuery())}),this._onEndFrameObserver=this.onEndFrameObservable.add(()=>{if(!this._gpuFrameTimeToken)return;let e=this.endTimeQuery(this._gpuFrameTimeToken);e>-1&&(this._gpuFrameTimeToken=null,t.fetchNewFrame(),t.addCount(e,!0))})}else this.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null};w.prototype._getGlAlgorithmType=function(n){return n===v.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED};export{ft as a,Zt as b,dt as c,Ht as d,G as e,O as f,I as g,v as h,ot as i};
