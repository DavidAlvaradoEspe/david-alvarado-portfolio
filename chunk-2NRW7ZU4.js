import{c as V,j as H}from"./chunk-WMKW4FWA.js";import{c as S}from"./chunk-SZHZ4WUM.js";import{d as u}from"./chunk-D7E25M7D.js";import{b as k}from"./chunk-NYFOCGFC.js";import{i as G}from"./chunk-VBN2JSHE.js";import{D as C}from"./chunk-NU3IHOYI.js";import{a as O}from"./chunk-PTJ4CXVK.js";import{a as B,b as P,h as A}from"./chunk-GXO6EN2N.js";var F="image/png",W=2,j=[134,22,135,150,246,214,150,54];function $(e){let r=new DataView(e.buffer,e.byteOffset,e.byteLength),t=0;for(let i=0;i<j.length;i++)if(r.getUint8(t++)!==j[i])return O.Error("Not a babylon environment map"),null;let n="",o=0;for(;o=r.getUint8(t++);)n+=String.fromCharCode(o);let a=JSON.parse(n);return a=D(a),a.binaryDataPosition=t,a.specular&&(a.specular.lodGenerationScale=a.specular.lodGenerationScale||.8),a}function D(e){if(e.version>W)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "${W}".`);return e.version===2||(e=P(B({},e),{version:2,imageType:F})),e}function K(e,r){r=D(r);let t=r.specular,n=Math.log2(r.width);if(n=Math.round(n)+1,t.mipmaps.length!==6*n)throw new Error(`Unsupported specular mipmaps number "${t.mipmaps.length}"`);let o=new Array(n);for(let a=0;a<n;a++){o[a]=new Array(6);for(let i=0;i<6;i++){let c=t.mipmaps[a*6+i];o[a][i]=new Uint8Array(e.buffer,e.byteOffset+r.binaryDataPosition+c.position,c.length)}}return o}function X(e,r){r=D(r);let t=new Array(6),n=r.irradiance?.irradianceTexture;if(n){if(n.faces.length!==6)throw new Error(`Incorrect irradiance texture faces number "${n.faces.length}"`);for(let o=0;o<6;o++){let a=n.faces[o];t[o]=new Uint8Array(e.buffer,e.byteOffset+r.binaryDataPosition+a.position,a.length)}}return t}function N(e,r,t){t=D(t);let n=t.specular;if(!n)return Promise.resolve([]);e._lodGenerationScale=n.lodGenerationScale;let o=[],a=K(r,t);o.push(U(e,a,t.imageType));let i=t.irradiance?.irradianceTexture;if(i){let c=X(r,t),s=null;t.irradiance?.irradianceTexture?.dominantDirection&&(s=u.FromArray(t.irradiance.irradianceTexture.dominantDirection)),o.push(Z(e,c,i.size,t.imageType,s))}return Promise.all(o)}function Y(e,r,t,n,o,a,i,c,s,l,d){return A(this,null,function*(){return yield new Promise((w,x)=>{if(t){let y=r.createTexture(null,!0,!0,null,1,null,g=>{x(g)},e);n?.onEffectCreatedObservable.addOnce(g=>{g.executeWhenCompiled(()=>{n.externalTextureSamplerBinding=!0,n.onApply=z=>{z._bindTexture("textureSampler",y),z.setFloat2("scale",1,r._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},r.scenes.length&&(r.scenes[0].postProcessManager.directRender([n],l,!0,a,i),r.restoreDefaultFramebuffer(),y.dispose(),URL.revokeObjectURL(o),w())})})}else{if(r._uploadImageToTexture(d,e,a,i),c){let y=s[i];y&&r._uploadImageToTexture(y._texture,e,a,0)}w()}})})}function U(n,o){return A(this,arguments,function*(e,r,t=F){let a=e.getEngine();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,a.updateTextureSamplingMode(3,e),yield J(e,r,!0,t),e.isReady=!0})}function Z(a,i,c){return A(this,arguments,function*(e,r,t,n=F,o=null){let s=e.getEngine(),l=new C(s,5),d=new S(s,l);e._irradianceTexture=d,d._dominantDirection=o,l.isCube=!0,l.format=5,l.type=0,l.generateMipMaps=!0,l._cachedAnisotropicFilteringLevel=null,l.generateMipMaps=!0,l.width=t,l.height=t,s.updateTextureSamplingMode(3,l),yield J(l,[r],!1,n),s.generateMipMapsForCubemap(l),l.isReady=!0})}function J(o,a,i){return A(this,arguments,function*(e,r,t,n=F){if(!k.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");let c=G(e.width)+1,s=e.getEngine(),l=!1,d=!1,w=null,x=null,y=null,g=s.getCaps();g.textureLOD?s._features.supportRenderAndCopyToLodForFloatTextures?g.textureHalfFloatRender&&g.textureHalfFloatLinearFiltering?(l=!0,e.type=2):g.textureFloatRender&&g.textureFloatLinearFiltering&&(l=!0,e.type=1):l=!1:(l=!1,d=t);let z=0;if(l)s.isWebGPU?(z=1,yield import("./chunk-S73J4FTD.js")):yield import("./chunk-6MBXVINW.js"),w=new H("rgbdDecode","rgbdDecode",null,null,1,null,3,s,!1,void 0,e.type,void 0,null,!1,void 0,z),e._isRGBD=!1,e.invertY=!1,x=s.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,d){y={};let m=e._lodGenerationScale,T=e._lodGenerationOffset;for(let p=0;p<3;p++){let v=1-p/2,h=T,I=(c-1)*m+T,M=h+(I-h)*v,L=Math.round(Math.min(Math.max(M,0),I)),R=new C(s,2);R.isCube=!0,R.invertY=!0,R.generateMipMaps=!1,s.updateTextureSamplingMode(2,R);let _=new S(null);switch(_._isCube=!0,_._texture=R,y[L]=_,p){case 0:e._lodTextureLow=_;break;case 1:e._lodTextureMid=_;break;case 2:e._lodTextureHigh=_;break}}}let E=[];for(let f=0;f<r.length;f++)for(let m=0;m<6;m++){let T=r[f][m],p=new Blob([T],{type:n}),b=URL.createObjectURL(p),v;if(s._features.forceBitmapOverHTMLImageElement)v=s.createImageBitmap(p,{premultiplyAlpha:"none"}).then(h=>A(null,null,function*(){return yield Y(h,s,l,w,b,m,f,d,y,x,e)}));else{let h=new Image;h.src=b,v=new Promise((I,M)=>{h.onload=()=>{Y(h,s,l,w,b,m,f,d,y,x,e).then(()=>I()).catch(L=>{M(L)})},h.onerror=L=>{M(L)}})}E.push(v)}if(yield Promise.all(E),r.length<c){let f,m=Math.pow(2,c-1-r.length),T=m*m*4;switch(e.type){case 0:{f=new Uint8Array(T);break}case 2:{f=new Uint16Array(T);break}case 1:{f=new Float32Array(T);break}}for(let p=r.length;p<c;p++)for(let b=0;b<6;b++)s._uploadArrayBufferViewToTexture(x?.texture||e,f,b,p)}if(x){let f=e._irradianceTexture;e._irradianceTexture=null,s._releaseTexture(e),x._swapAndDie(e),e._irradianceTexture=f}w&&w.dispose(),d&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))})}function Q(e,r){r=D(r);let t=r.irradiance;if(!t)return;let n=new V;u.FromArrayToRef(t.x,0,n.x),u.FromArrayToRef(t.y,0,n.y),u.FromArrayToRef(t.z,0,n.z),u.FromArrayToRef(t.xx,0,n.xx),u.FromArrayToRef(t.yy,0,n.yy),u.FromArrayToRef(t.zz,0,n.zz),u.FromArrayToRef(t.yz,0,n.yz),u.FromArrayToRef(t.zx,0,n.zx),u.FromArrayToRef(t.xy,0,n.xy),e._sphericalPolynomial=n}function me(e,r,t,n,o){let a=e.getEngine().createRawCubeTexture(null,e.width,e.format,e.type,e.generateMipMaps,e.invertY,e.samplingMode,e._compression),i=U(a,r).then(()=>e);return e.onRebuildCallback=c=>({proxy:i,isReady:!0,isAsync:!0}),e._source=13,e._bufferViewArrayArray=r,e._lodGenerationScale=n,e._lodGenerationOffset=o,e._sphericalPolynomial=t,U(e,r).then(()=>(e.isReady=!0,e))}var q=class{constructor(){this.supportCascades=!1}loadCubeData(r,t,n,o,a){if(Array.isArray(r))return;let i=$(r);if(i){t.width=i.width,t.height=i.width;try{Q(t,i),N(t,r,i).then(()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),o&&o()},c=>{a?.("Can not upload environment levels",c)})}catch(c){a?.("Can not upload environment file",c)}}else a&&a("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}};export{$ as a,K as b,Q as c,me as d,q as e};
