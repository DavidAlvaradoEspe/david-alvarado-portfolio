import{a as A}from"./chunk-OOSHHHZN.js";import{a as T}from"./chunk-DTW6C2NU.js";import{a as h}from"./chunk-G5DRJZ63.js";import{a as S}from"./chunk-IMSFUDDL.js";import{b as p}from"./chunk-CW5F3XFN.js";import{a as y,c as _}from"./chunk-NPZEPKVW.js";import{d as a,g as f,h as m}from"./chunk-FWZ75RMU.js";import{a as n,c as x,d as c,f as E,i as g}from"./chunk-CCUABLZY.js";import{b as L}from"./chunk-3WG2WLZ4.js";var r=class o extends T{get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale()}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}getViewMatrix(e){return null}getProjectionMatrix(e,t){return null}constructor(e,t){super(e,t,!1),this.diffuse=new y(1,1,1),this.specular=new y(1,1,1),this.falloffType=o.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=o.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._currentViewDepth=0,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new A(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=[],this.excludedMeshes=[],this._resyncMeshes()}transferTexturesToEffect(e,t){return this}_bindLight(e,t,s,i,d=!0){let l=e.toString(),u=!1;if(this._uniformBuffer.bindToEffect(s,"Light"+l),this._renderId!==t.getRenderId()||this._lastUseSpecular!==i||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=i;let I=this.getScaledIntensity();this.transferToEffect(s,l),this.diffuse.scaleToRef(I,_.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",_.Color3[0],this.range,l),i&&(this.specular.scaleToRef(I,_.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",_.Color3[1],this.radius,l)),u=!0}if(this.transferTexturesToEffect(s,l),t.shadowsEnabled&&this.shadowEnabled&&d){let I=this.getShadowGenerator(t.activeCamera)??this.getShadowGenerator();I&&(I.bindShadowLight(l,s),u=!0)}u?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(e){let t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric","Clustered"][this.getTypeID()],this.animations)for(let s=0;s<this.animations.length;s++)t+=", animation[0]: "+this.animations[s].toString(e);return t}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(e){super.setEnabled(e),this._resyncMeshes()}getShadowGenerator(e=null){return this._shadowGenerators===null?null:this._shadowGenerators.get(e)??null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return a.Zero()}canAffectMesh(e){return e?!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(e)===-1||this.excludedMeshes&&this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1||this.includeOnlyWithLayerMask!==0&&(this.includeOnlyWithLayerMask&e.layerMask)===0||this.excludeWithLayerMask!==0&&this.excludeWithLayerMask&e.layerMask):!0}dispose(e,t=!1){if(this._shadowGenerators){let s=this._shadowGenerators.values();for(let i=s.next();i.done!==!0;i=s.next())i.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){let s=this._parentContainer.lights.indexOf(this);s>-1&&this._parentContainer.lights.splice(s,1),this._parentContainer=null}for(let s of this.getScene().meshes)s._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,t)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,t=null){let s=o.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!s)return null;let i=p.Clone(s,this);return e&&(i.name=e),t&&(i.parent=t),i.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(i),i}serialize(){let e=p.Serialize(this);if(e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0){e.excludedMeshesIds=[];for(let t of this.excludedMeshes)e.excludedMeshesIds.push(t.id)}if(this.includedOnlyMeshes.length>0){e.includedOnlyMeshesIds=[];for(let t of this.includedOnlyMeshes)e.includedOnlyMeshesIds.push(t.id)}return p.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,t,s){let i=T.Construct("Light_Type_"+e,t,s);return i||null}static Parse(e,t){let s=o.GetConstructorFromName(e.type,e.name,t);if(!s)return null;let i=p.Parse(s,e,t);if(e.excludedMeshesIds&&(i._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(i._includedOnlyMeshesIds=e.includedOnlyMeshesIds),e.parentId!==void 0&&(i._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(i._waitingParentInstanceIndex=e.parentInstanceIndex),e.falloffType!==void 0&&(i.falloffType=e.falloffType),e.lightmapMode!==void 0&&(i.lightmapMode=e.lightmapMode),e.animations){for(let d=0;d<e.animations.length;d++){let l=e.animations[d],u=L("BABYLON.Animation");u&&i.animations.push(u.Parse(l))}T.ParseAnimationRanges(i,e,t)}return e.autoAnimate&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&i.setEnabled(e.isEnabled),i}_hookArrayForExcluded(e){let t=e.push;e.push=(...i)=>{let d=t.apply(e,i);for(let l of i)l._resyncLightSource(this);return d};let s=e.splice;e.splice=(i,d)=>{let l=s.apply(e,[i,d]);for(let u of l)u._resyncLightSource(this);return l};for(let i of e)i._resyncLightSource(this)}_hookArrayForIncludedOnly(e){let t=e.push;e.push=(...i)=>{let d=t.apply(e,i);return this._resyncMeshes(),d};let s=e.splice;e.splice=(i,d)=>{let l=s.apply(e,[i,d]);return this._resyncMeshes(),l},this._resyncMeshes()}_resyncMeshes(){for(let e of this.getScene().meshes)e._resyncLightSource(this)}_markMeshesAsLightDirty(){for(let e of this.getScene().meshes)e.lightSources.indexOf(this)!==-1&&e._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let e=0,t=this.getTypeID(),s=this.intensityMode;switch(s===o.INTENSITYMODE_AUTOMATIC&&(t===o.LIGHTTYPEID_DIRECTIONALLIGHT?s=o.INTENSITYMODE_ILLUMINANCE:s=o.INTENSITYMODE_LUMINOUSINTENSITY),t){case o.LIGHTTYPEID_POINTLIGHT:case o.LIGHTTYPEID_SPOTLIGHT:switch(s){case o.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case o.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case o.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius;break}break;case o.LIGHTTYPEID_DIRECTIONALLIGHT:switch(s){case o.INTENSITYMODE_ILLUMINANCE:e=1;break;case o.INTENSITYMODE_LUMINANCE:{let i=this.radius;i=Math.max(i,.001),e=2*Math.PI*(1-Math.cos(i));break}}break;case o.LIGHTTYPEID_HEMISPHERICLIGHT:e=1;break}return e}_reorderLightsInScene(){let e=this.getScene();this._renderPriority!=0&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}_isReady(){return!0}};r.FALLOFF_DEFAULT=h.FALLOFF_DEFAULT;r.FALLOFF_PHYSICAL=h.FALLOFF_PHYSICAL;r.FALLOFF_GLTF=h.FALLOFF_GLTF;r.FALLOFF_STANDARD=h.FALLOFF_STANDARD;r.LIGHTMAP_DEFAULT=h.LIGHTMAP_DEFAULT;r.LIGHTMAP_SPECULAR=h.LIGHTMAP_SPECULAR;r.LIGHTMAP_SHADOWSONLY=h.LIGHTMAP_SHADOWSONLY;r.INTENSITYMODE_AUTOMATIC=h.INTENSITYMODE_AUTOMATIC;r.INTENSITYMODE_LUMINOUSPOWER=h.INTENSITYMODE_LUMINOUSPOWER;r.INTENSITYMODE_LUMINOUSINTENSITY=h.INTENSITYMODE_LUMINOUSINTENSITY;r.INTENSITYMODE_ILLUMINANCE=h.INTENSITYMODE_ILLUMINANCE;r.INTENSITYMODE_LUMINANCE=h.INTENSITYMODE_LUMINANCE;r.LIGHTTYPEID_POINTLIGHT=h.LIGHTTYPEID_POINTLIGHT;r.LIGHTTYPEID_DIRECTIONALLIGHT=h.LIGHTTYPEID_DIRECTIONALLIGHT;r.LIGHTTYPEID_SPOTLIGHT=h.LIGHTTYPEID_SPOTLIGHT;r.LIGHTTYPEID_HEMISPHERICLIGHT=h.LIGHTTYPEID_HEMISPHERICLIGHT;r.LIGHTTYPEID_RECT_AREALIGHT=h.LIGHTTYPEID_RECT_AREALIGHT;n([E()],r.prototype,"diffuse",void 0);n([E()],r.prototype,"specular",void 0);n([c()],r.prototype,"falloffType",void 0);n([c()],r.prototype,"intensity",void 0);n([c()],r.prototype,"range",null);n([c()],r.prototype,"intensityMode",null);n([c()],r.prototype,"radius",null);n([c()],r.prototype,"_renderPriority",void 0);n([x("_reorderLightsInScene")],r.prototype,"renderPriority",void 0);n([c("shadowEnabled")],r.prototype,"_shadowEnabled",void 0);n([c("excludeWithLayerMask")],r.prototype,"_excludeWithLayerMask",void 0);n([c("includeOnlyWithLayerMask")],r.prototype,"_includeOnlyWithLayerMask",void 0);n([c("lightmapMode")],r.prototype,"_lightmapMode",void 0);var M=class extends r{constructor(){super(...arguments),this._needProjectionMatrixCompute=!0,this._viewMatrix=f.Identity(),this._projectionMatrix=f.Identity()}_setPosition(e){this._position=e}get position(){return this._position}set position(e){this._setPosition(e)}_setDirection(e){this._direction=e}get direction(){return this._direction}set direction(e){this._setDirection(e)}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return this.parent&&this.parent.getWorldMatrix?(this.transformedPosition||(this.transformedPosition=a.Zero()),a.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=a.Zero()),a.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0):!1}getDepthScale(){return 50}getShadowDirection(e){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(e){return this.direction=a.Normalize(e.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();let e=a.Cross(this.direction,S.Y),t=a.Cross(e,this.direction);return a.RotationFromAxis(e,t,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=!0}_initCache(){super._initCache(),this._cache.position=a.Zero()}_isSynchronized(){return!!this._cache.position.equals(this.position)}computeWorldMatrix(e){return!e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=f.Identity()),f.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)}getDepthMinZ(e){return this.shadowMinZ!==void 0?this.shadowMinZ:e?.minZ||0}getDepthMaxZ(e){return this.shadowMaxZ!==void 0?this.shadowMaxZ:e?.maxZ||1e4}setShadowProjectionMatrix(e,t,s){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,s,e):this._setDefaultShadowProjectionMatrix(e,t,s),this}_syncParentEnabledState(){super._syncParentEnabledState(),(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition=null,this.transformedDirection=null)}getViewMatrix(e){let t=m.Vector3[0],s=this.position;this.computeTransformedInformation()&&(s=this.transformedPosition),a.NormalizeToRef(this.getShadowDirection(e),t),Math.abs(a.Dot(t,a.Up()))===1&&(t.z=1e-13);let i=m.Vector3[1];return s.addToRef(t,i),f.LookAtLHToRef(s,i,a.Up(),this._viewMatrix),this._viewMatrix}getProjectionMatrix(e,t){return this.setShadowProjectionMatrix(this._projectionMatrix,e??this._viewMatrix,t??[]),this._projectionMatrix}};n([g()],M.prototype,"position",null);n([g()],M.prototype,"direction",null);n([c()],M.prototype,"shadowMinZ",null);n([c()],M.prototype,"shadowMaxZ",null);export{r as a,M as b};
