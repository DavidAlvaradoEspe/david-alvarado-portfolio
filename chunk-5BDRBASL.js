import{d as f}from"./chunk-FWZ75RMU.js";import"./chunk-OPJEXU7D.js";import"./chunk-3WG2WLZ4.js";import"./chunk-ZUHEGR2G.js";import"./chunk-PMYBMJFK.js";import"./chunk-CJK33JLH.js";import"./chunk-YVY7FGQB.js";var m=class{static ConvertPanoramaToCubemap(e,o,t,n,a=!1,l=!0){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";let w=0;if(e.length!=o*t*3){if(e.length!=o*t*4)throw"ConvertPanoramaToCubemap: input size is wrong";w=4}else w=3;let c=this.CreateCubemapTexture(n,this.FACE_FRONT,e,o,t,a,l,w),s=this.CreateCubemapTexture(n,this.FACE_BACK,e,o,t,a,l,w),u=this.CreateCubemapTexture(n,this.FACE_LEFT,e,o,t,a,l,w),i=this.CreateCubemapTexture(n,this.FACE_RIGHT,e,o,t,a,l,w),h=this.CreateCubemapTexture(n,this.FACE_UP,e,o,t,a,l,w),C=this.CreateCubemapTexture(n,this.FACE_DOWN,e,o,t,a,l,w);return{front:c,back:s,left:u,right:i,up:h,down:C,size:n,type:1,format:4,gammaSpace:!1}}static CreateCubemapTexture(e,o,t,n,a,l,w,c){let s=new ArrayBuffer(e*e*4*3),u=new Float32Array(s),i=l?Math.max(1,Math.round(n/4/e)):1,h=1/i,C=h*h,d=o[1].subtract(o[0]).scale(h/e),R=o[3].subtract(o[2]).scale(h/e),b=1/e,g=0;for(let F=0;F<e;F++)for(let T=0;T<i;T++){let M=o[0],A=o[2];for(let B=0;B<e;B++)for(let P=0;P<i;P++){let _=A.subtract(M).scale(g).add(M);_.normalize();let E=this.CalcProjectionSpherical(_,t,n,a,c,w);u[F*e*3+B*3+0]+=E.r*C,u[F*e*3+B*3+1]+=E.g*C,u[F*e*3+B*3+2]+=E.b*C,M=M.add(d),A=A.add(R)}g+=b*h}return u}static CalcProjectionSpherical(e,o,t,n,a,l){let w=Math.atan2(e.z,e.x),c=Math.acos(e.y);for(;w<-Math.PI;)w+=2*Math.PI;for(;w>Math.PI;)w-=2*Math.PI;let s=w/Math.PI,u=c/Math.PI;s=s*.5+.5;let i=Math.round(s*t);i<0?i=0:i>=t&&(i=t-1);let h=Math.round(u*n);h<0?h=0:h>=n&&(h=n-1);let C=l?n-h-1:h,d=o[C*t*a+i*a+0],R=o[C*t*a+i*a+1],b=o[C*t*a+i*a+2];return{r:d,g:R,b}}};m.FACE_LEFT=[new f(-1,-1,-1),new f(1,-1,-1),new f(-1,1,-1),new f(1,1,-1)];m.FACE_RIGHT=[new f(1,-1,1),new f(-1,-1,1),new f(1,1,1),new f(-1,1,1)];m.FACE_FRONT=[new f(1,-1,-1),new f(1,-1,1),new f(1,1,-1),new f(1,1,1)];m.FACE_BACK=[new f(-1,-1,1),new f(-1,-1,-1),new f(-1,1,1),new f(-1,1,-1)];m.FACE_DOWN=[new f(1,1,-1),new f(1,1,1),new f(-1,1,-1),new f(-1,1,1)];m.FACE_UP=[new f(-1,-1,-1),new f(-1,-1,1),new f(1,-1,-1),new f(1,-1,1)];function O(r,e){return e>1023?r*Math.pow(2,1023)*Math.pow(2,e-1023):e<-1074?r*Math.pow(2,-1074)*Math.pow(2,e+1074):r*Math.pow(2,e)}function x(r,e,o,t,n,a){n>0?(n=O(1,n-136),r[a+0]=e*n,r[a+1]=o*n,r[a+2]=t*n):(r[a+0]=0,r[a+1]=0,r[a+2]=0)}function p(r,e){let o="",t="";for(let n=e;n<r.length-e&&(t=String.fromCharCode(r[n]),t!=`
`);n++)o+=t;return o}function D(r){let e=0,o=0,t=p(r,0);if(t[0]!="#"||t[1]!="?")throw"Bad HDR Format.";let n=!1,a=!1,l=0;do l+=t.length+1,t=p(r,l),t=="FORMAT=32-bit_rle_rgbe"?a=!0:t.length==0&&(n=!0);while(!n);if(!a)throw"HDR Bad header format, unsupported FORMAT";l+=t.length+1,t=p(r,l);let c=/^-Y (.*) \+X (.*)$/g.exec(t);if(!c||c.length<3)throw"HDR Bad header format, no size";if(o=parseInt(c[2]),e=parseInt(c[1]),o<8||o>32767)throw"HDR Bad header format, unsupported size";return l+=t.length+1,{height:e,width:o,dataPosition:l}}function G(r,e){return U(r,e)}function U(r,e){let o=e.height,t=e.width,n,a,l,w,c,s=e.dataPosition,u=0,i=0,h=0,C=new ArrayBuffer(t*4),d=new Uint8Array(C),R=new ArrayBuffer(e.width*e.height*4*3),b=new Float32Array(R);for(;o>0;){if(n=r[s++],a=r[s++],l=r[s++],w=r[s++],n!=2||a!=2||l&128||e.width<8||e.width>32767)return N(r,e);if((l<<8|w)!=t)throw"HDR Bad header format, wrong scan line width";for(u=0,h=0;h<4;h++)for(i=(h+1)*t;u<i;)if(n=r[s++],a=r[s++],n>128){if(c=n-128,c==0||c>i-u)throw"HDR Bad Format, bad scanline data (run)";for(;c-- >0;)d[u++]=a}else{if(c=n,c==0||c>i-u)throw"HDR Bad Format, bad scanline data (non-run)";if(d[u++]=a,--c>0)for(let g=0;g<c;g++)d[u++]=r[s++]}for(h=0;h<t;h++)n=d[h],a=d[h+t],l=d[h+2*t],w=d[h+3*t],x(b,n,a,l,w,(e.height-o)*t*3+h*3);o--}return b}function N(r,e){let o=e.height,t=e.width,n,a,l,w,c,s=e.dataPosition,u=new ArrayBuffer(e.width*e.height*4*3),i=new Float32Array(u);for(;o>0;){for(c=0;c<e.width;c++)n=r[s++],a=r[s++],l=r[s++],w=r[s++],x(i,n,a,l,w,(e.height-o)*t*3+c*3);o--}return i}var L=class{constructor(){this.supportCascades=!1}loadCubeData(){throw".hdr not supported in Cube."}loadData(e,o,t){let n=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),a=D(n),l=G(n,a),w=a.width*a.height,c=new Float32Array(w*4);for(let s=0;s<w;s+=1)c[s*4]=l[s*3],c[s*4+1]=l[s*3+1],c[s*4+2]=l[s*3+2],c[s*4+3]=1;t(a.width,a.height,o.generateMipMaps,!1,()=>{let s=o.getEngine();o.type=1,o.format=5,o._gammaSpace=!1,s._uploadDataToTextureDirectly(o,c)})}};export{L as _HDRTextureLoader};
