import{b as g}from"./chunk-R6NZNNKC.js";import{a as c}from"./chunk-A6K5JERA.js";import"./chunk-Z6SLAXJD.js";import"./chunk-ECE5LYUU.js";import{a as r,f as p,o as h}from"./chunk-3I5CJTBG.js";import"./chunk-NPZEPKVW.js";import"./chunk-FWZ75RMU.js";import"./chunk-OPJEXU7D.js";import"./chunk-XXSLHR3E.js";import{a as u}from"./chunk-3WG2WLZ4.js";import"./chunk-ZUHEGR2G.js";import"./chunk-PMYBMJFK.js";import"./chunk-CJK33JLH.js";import{a as d}from"./chunk-PTJ4CXVK.js";import"./chunk-YVY7FGQB.js";var b=(()=>{class s extends c{constructor(e){super(e),this.cancel=this._registerSignalInput("cancel"),this.duration=this.registerDataInput("duration",p),this.lastDelayIndex=this.registerDataOutput("lastDelayIndex",h,new r(-1))}_preparePendingTasks(e){let a=this.duration.getValue(e);if(a<0||isNaN(a)||!isFinite(a))return this._reportError(e,"Invalid duration in SetDelay block");if(e._getGlobalContextVariable("activeDelays",0)>=s.MaxParallelDelayCount)return this._reportError(e,"Max parallel delays reached");let i=e._getGlobalContextVariable("lastDelayIndex",-1),l=e._getExecutionVariable(this,"pendingDelays",[]),m=e.configuration.scene,n=new g({timeout:a*1e3,contextObservable:m.onBeforeRenderObservable,onEnded:()=>this._onEnded(n,e)});n.start();let o=i+1;this.lastDelayIndex.setValue(new r(o),e),e._setGlobalContextVariable("lastDelayIndex",o),l[o]=n,e._setExecutionVariable(this,"pendingDelays",l),this._updateGlobalTimers(e)}_cancelPendingTasks(e){let a=e._getExecutionVariable(this,"pendingDelays",[]);for(let t of a)t?.dispose();e._deleteExecutionVariable(this,"pendingDelays"),this.lastDelayIndex.setValue(new r(-1),e),this._updateGlobalTimers(e)}_execute(e,a){if(a===this.cancel){this._cancelPendingTasks(e);return}else this._preparePendingTasks(e),this.out._activateSignal(e)}getClassName(){return"FlowGraphSetDelayBlock"}_onEnded(e,a){let t=a._getExecutionVariable(this,"pendingDelays",[]),i=t.indexOf(e);i!==-1?t.splice(i,1):d.Warn("FlowGraphTimerBlock: Timer ended but was not found in the running timers list"),a._removePendingBlock(this),this.done._activateSignal(a),this._updateGlobalTimers(a)}_updateGlobalTimers(e){let a=e._getExecutionVariable(this,"pendingDelays",[]),t=e._getGlobalContextVariable("pendingDelays",[]);for(let i=0;i<a.length;i++){if(!a[i])continue;let l=a[i];t[i]&&t[i]!==l?d.Warn("FlowGraphTimerBlock: Timer ended but was not found in the running timers list"):t[i]=l}e._setGlobalContextVariable("pendingDelays",t)}}return s.MaxParallelDelayCount=100,s})();u("FlowGraphSetDelayBlock",b);export{b as FlowGraphSetDelayBlock};
