import{b as u}from"./chunk-LKP2ECJY.js";import{b as C,c as I}from"./chunk-SX3EKMWY.js";import{a as b,q as x}from"./chunk-CCUABLZY.js";import{d as h}from"./chunk-M4M4JHJ5.js";import{f as A}from"./chunk-VBN2JSHE.js";import{a as l}from"./chunk-FIS22N7N.js";import{a as y}from"./chunk-PTJ4CXVK.js";import{h as c}from"./chunk-GXO6EN2N.js";var m=null;function B(){return c(this,null,function*(){let n=l.LastCreatedEngine?.createCanvas(100,100)??new OffscreenCanvas(100,100);n instanceof OffscreenCanvas&&y.Warn("DumpData: OffscreenCanvas will be used for dumping data. This may result in lossy alpha values.");let{ThinEngine:s}=yield import("./chunk-BNTYYBKK.js");if(!s.IsSupported)throw new Error("DumpData: No WebGL context available. Cannot dump data.");let r={preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1},e=new s(n,!1,r);l.Instances.pop(),l.OnEnginesDisposedObservable.add(i=>{e&&i!==e&&!e.isDisposed&&l.Instances.length===0&&S()}),e.getCaps().parallelShaderCompile=void 0;let o=new C(e),{passPixelShader:t}=yield import("./chunk-MLCM4HTX.js"),p=new I({engine:e,name:t.name,fragmentShader:t.shader,samplerNames:["textureSampler"]});return{canvas:n,dumpEngine:{engine:e,renderer:o,wrapper:p}}})}function O(){return c(this,null,function*(){return m||(m=B()),yield m})}var g=class{static EncodeImageAsync(s,r,e,o,t,p){return c(this,null,function*(){let i=yield O(),a=i.dumpEngine;a.engine.setSize(r,e,!0);let f=a.engine.createRawTexture(s,r,e,5,!1,!t,1);return a.renderer.setViewport(),a.renderer.applyEffectWrapper(a.wrapper),a.wrapper.effect._bindTexture("textureSampler",f),a.renderer.draw(),f.dispose(),yield new Promise((w,d)=>{u.ToBlob(i.canvas,E=>{E?w(E):d(new Error("EncodeImageAsync: Failed to convert canvas to blob."))},o,p)})})}};b([x],g,"EncodeImageAsync",null);var U=g.EncodeImageAsync;function T(n,s,r,e,o="image/png",t,p){return c(this,null,function*(){let i=yield r.readPixels(0,0,n,s),a=new Uint8Array(i.buffer);v(n,s,a,e,o,t,!0,void 0,p)})}function D(n,s,r,e="image/png",o,t=!1,p=!1,i){return c(this,null,function*(){if(r instanceof Float32Array){let w=new Uint8Array(r.length),d=r.length;for(;d--;){let E=r[d];w[d]=Math.round(A(E)*255)}r=w}let a=yield g.EncodeImageAsync(r,n,s,e,t,i);o!==void 0&&u.DownloadBlob(a,o),a.type!==e&&y.Warn(`DumpData: The requested mimeType '${e}' is not supported. The result has mimeType '${a.type}' instead.`);let f=yield a.arrayBuffer();return p?f:`data:${e};base64,${h(f)}`})}function v(n,s,r,e,o="image/png",t,p=!1,i=!1,a){t===void 0&&!e&&(t=""),D(n,s,r,o,t,p,i,a).then(f=>{e&&e(f)})}function S(){m&&(m?.then(n=>{n.canvas instanceof HTMLCanvasElement&&n.canvas.remove(),n.dumpEngine&&(n.dumpEngine.engine.dispose(),n.dumpEngine.renderer.dispose(),n.dumpEngine.wrapper.dispose())}),m=null)}var V={DumpData:v,DumpDataAsync:D,DumpFramebuffer:T,Dispose:S},P=()=>{u.DumpData=v,u.DumpDataAsync=D,u.DumpFramebuffer=T};P();export{U as a,T as b,D as c,v as d,S as e,V as f};
