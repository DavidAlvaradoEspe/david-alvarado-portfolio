import"./chunk-6ZYTWFB7.js";import{a as FT,b as kT,c as BT,d as X,e as ln,f as _i}from"./chunk-SIRYQ23E.js";import"./chunk-UCOVMCIN.js";import{a as ni,b as YT,c as KT,e as Ag,g as XT,h as mc,i as kh}from"./chunk-XUCPIFVC.js";import{a as pc}from"./chunk-R6NZNNKC.js";import{a as Eg}from"./chunk-O4KX6OS6.js";import"./chunk-PAIB4B2M.js";import{a as qT}from"./chunk-IBLZLZZZ.js";import"./chunk-HYMNALGP.js";import"./chunk-A6K5JERA.js";import"./chunk-Z6SLAXJD.js";import{a as Ig}from"./chunk-ECE5LYUU.js";import{r as WT,u as Fh,v as jT}from"./chunk-3I5CJTBG.js";import"./chunk-L5ZS7BLX.js";import{a as zT,b as Na}from"./chunk-KUSDBOVJ.js";import"./chunk-OTG5DIDJ.js";import{a as Sg,b as HT}from"./chunk-3CQOVPBJ.js";import{c as Li,d as $T}from"./chunk-NYOR2HEC.js";import{a as gr}from"./chunk-ONJQLIA2.js";import{a as Ts,b as Lh,c as dc,d as ee,e as ti,i as fc}from"./chunk-ZCCO6EMC.js";import{a as Zr}from"./chunk-R3OZJ4HQ.js";import{a as Tg,h as H}from"./chunk-ONKGPWX4.js";import"./chunk-OXLTDKUZ.js";import"./chunk-XAO7YOQZ.js";import{a as Oe,b as Oh,c as Cs,d as Ra,e as UT,f as _r,g as Pa,h as Nh,i as Oa}from"./chunk-6KSC6QMC.js";import{a as VT,b as GT,c as ei}from"./chunk-Y6OLMIZM.js";import{a as PT}from"./chunk-7DENLIKN.js";import"./chunk-LJGIHTVW.js";import"./chunk-4O5HTYBQ.js";import"./chunk-VJIYOY3Y.js";import{a as RT}from"./chunk-BY3NEV2G.js";import"./chunk-UZ4AZL3O.js";import"./chunk-2O64SUYQ.js";import{A as mr,B as AT,C as Ia,D as xh,E as Ch,F as Ea,G as Th,H as Aa,I as Sh,J as Ih,K as wa,L as Ma,M as Eh,N as wT,O as Ah,P as MT,Q as wh,R as Mh,S as Dh,T as bg,U as Ne,V as Cg,W as Da,X as Pe,a as vT,b as bT,c as gi,d as Ge,e as CT,f as mh,g as gh,h as TT,i as _h,j as hc,k as bs,l as fr,m as Zn,n as xs,o as Qn,p as rt,q as Jn,r as Ni,s as yh,t as ST,u as vh,v as Sa,w as IT,x as bh,y as ET,z as pr}from"./chunk-YWVEFMAA.js";import{a as In,b as xg,c as Xr}from"./chunk-7PKF2HBK.js";import{a as Ae,c as ph}from"./chunk-ESU2LKTX.js";import{a as an,b as DT}from"./chunk-WOSX534W.js";import{a as xT}from"./chunk-UTB7MUBH.js";import{a as kt}from"./chunk-DTW6C2NU.js";import"./chunk-4L3AMN6L.js";import"./chunk-BBMLNH3A.js";import"./chunk-7FSFDK4E.js";import"./chunk-JTBODENQ.js";import"./chunk-BQPQ6TSI.js";import"./chunk-DXIW36IF.js";import"./chunk-FJN7KTAM.js";import"./chunk-ADGVNOWV.js";import"./chunk-RPO3NA2D.js";import"./chunk-MUVVFX4O.js";import"./chunk-CO7QZEHY.js";import"./chunk-TZYBJFW2.js";import"./chunk-MZYVXJQS.js";import"./chunk-TYRUT66Y.js";import"./chunk-RX5ZKODH.js";import"./chunk-56K6VOMW.js";import"./chunk-3XT2LBGG.js";import"./chunk-B7ACYLBJ.js";import{a as oT,b as lT,c as cT,e as Ca,h as gT,i as Tn,j as Ta,k as Sn}from"./chunk-GCSIM5MW.js";import"./chunk-2LR3BD57.js";import{b as dh,c as uc,d as aT}from"./chunk-QCR5HLUD.js";import"./chunk-G5DRJZ63.js";import{a as Vn}from"./chunk-IMSFUDDL.js";import{a as ya,b as xa,c as we,d as te}from"./chunk-5T7GZZEX.js";import"./chunk-NHIHMT2T.js";import{a as Tt,b as Xe}from"./chunk-CW5F3XFN.js";import{a as G,b as le,c as it}from"./chunk-NPZEPKVW.js";import{c as _e,d as m,e as ht,f as J,g as V,h as U}from"./chunk-FWZ75RMU.js";import{c as wt,d as Pt,e as hh}from"./chunk-OPJEXU7D.js";import{b as _T,d as yT,f as vg}from"./chunk-YFTPYCF4.js";import"./chunk-H5VVG2IN.js";import{a as xt,b as z,c as LT}from"./chunk-YZWYFFYQ.js";import{a as vs}from"./chunk-5H5AAOGY.js";import{a as fT,b as pT,c as mT,d as Cn,e as S,f as mi}from"./chunk-J7UYENZA.js";import{a as w,c as Re,d as L,e as Gn,f as pi,g as va,h as uT,i as yn,j as fh,l as hT,o as yg,p as dT}from"./chunk-CCUABLZY.js";import{a as ma,b as ga,c as rT,f as OT,m as NT,n as Rh,o as Ph}from"./chunk-LYHSKFCL.js";import{a as to}from"./chunk-5SDLENZK.js";import{a as ba}from"./chunk-XXSLHR3E.js";import{a as ue,b as Ct}from"./chunk-3WG2WLZ4.js";import{b as Ee,c as Kt,e as Oi,i as _g}from"./chunk-ZUHEGR2G.js";import"./chunk-XI4OBPMN.js";import"./chunk-SO644OCK.js";import{C as Kr,E as ne,e as sT,h as mg,i as gg,v as Ft,x as _a}from"./chunk-CXW3WAWT.js";import{a as Bn}from"./chunk-A3WFPZFR.js";import{a as iT,e as Zi}from"./chunk-CWQQB2EJ.js";import{a as Ie}from"./chunk-PMYBMJFK.js";import{a as B}from"./chunk-CJK33JLH.js";import{a as N}from"./chunk-PTJ4CXVK.js";import{a as gt}from"./chunk-L3UYHT7M.js";import{a as K,b as ct,f as nT,g as T}from"./chunk-YVY7FGQB.js";var En=null,Bh=!1,Mg=1,TD=null,Fi=Symbol("SIGNAL");function Be(i){let e=En;return En=i,e}function Vh(){return En}var Gh={version:0,lastCleanEpoch:0,dirty:!1,producers:void 0,producersTail:void 0,consumers:void 0,consumersTail:void 0,recomputing:!1,consumerAllowSignalWrites:!1,consumerIsAlwaysLive:!1,kind:"unknown",producerMustRecompute:()=>!1,producerRecomputeValue:()=>{},consumerMarkedDirty:()=>{},consumerOnSignalRead:()=>{}};function Uh(i){if(Bh)throw new Error("");if(En===null)return;En.consumerOnSignalRead(i);let e=En.producersTail;if(e!==void 0&&e.producer===i)return;let t,n=En.recomputing;if(n&&(t=e!==void 0?e.nextProducer:En.producers,t!==void 0&&t.producer===i)){En.producersTail=t,t.lastReadVersion=i.version;return}let r=i.consumersTail;if(r!==void 0&&r.consumer===En&&(!n||ID(r,En)))return;let s=La(En),o={producer:i,consumer:En,nextProducer:t,prevConsumer:r,lastReadVersion:i.version,nextConsumer:void 0};En.producersTail=o,e!==void 0?e.nextProducer=o:En.producers=o,s&&tS(i,o)}function ZT(){Mg++}function QT(i){if(!(La(i)&&!i.dirty)&&!(!i.dirty&&i.lastCleanEpoch===Mg)){if(!i.producerMustRecompute(i)&&!Hh(i)){wg(i);return}i.producerRecomputeValue(i),wg(i)}}function Dg(i){if(i.consumers===void 0)return;let e=Bh;Bh=!0;try{for(let t=i.consumers;t!==void 0;t=t.nextConsumer){let n=t.consumer;n.dirty||SD(n)}}finally{Bh=e}}function Rg(){return En?.consumerAllowSignalWrites!==!1}function SD(i){i.dirty=!0,Dg(i),i.consumerMarkedDirty?.(i)}function wg(i){i.dirty=!1,i.lastCleanEpoch=Mg}function zh(i){return i&&JT(i),Be(i)}function JT(i){i.producersTail=void 0,i.recomputing=!0}function Pg(i,e){Be(e),i&&eS(i)}function eS(i){i.recomputing=!1;let e=i.producersTail,t=e!==void 0?e.nextProducer:i.producers;if(t!==void 0){if(La(i))do t=Og(t);while(t!==void 0);e!==void 0?e.nextProducer=void 0:i.producers=void 0}}function Hh(i){for(let e=i.producers;e!==void 0;e=e.nextProducer){let t=e.producer,n=e.lastReadVersion;if(n!==t.version||(QT(t),n!==t.version))return!0}return!1}function gc(i){if(La(i)){let e=i.producers;for(;e!==void 0;)e=Og(e)}i.producers=void 0,i.producersTail=void 0,i.consumers=void 0,i.consumersTail=void 0}function tS(i,e){let t=i.consumersTail,n=La(i);if(t!==void 0?(e.nextConsumer=t.nextConsumer,t.nextConsumer=e):(e.nextConsumer=void 0,i.consumers=e),e.prevConsumer=t,i.consumersTail=e,!n)for(let r=i.producers;r!==void 0;r=r.nextProducer)tS(r.producer,r)}function Og(i){let e=i.producer,t=i.nextProducer,n=i.nextConsumer,r=i.prevConsumer;if(i.nextConsumer=void 0,i.prevConsumer=void 0,n!==void 0?n.prevConsumer=r:e.consumersTail=r,r!==void 0)r.nextConsumer=n;else if(e.consumers=n,!La(e)){let s=e.producers;for(;s!==void 0;)s=Og(s)}return t}function La(i){return i.consumerIsAlwaysLive||i.consumers!==void 0}function nS(i){TD?.(i)}function ID(i,e){let t=e.producersTail;if(t!==void 0){let n=e.producers;do{if(n===i)return!0;if(n===t)break;n=n.nextProducer}while(n!==void 0)}return!1}function iS(i,e){return Object.is(i,e)}function ED(){throw new Error}var rS=ED;function sS(i){rS(i)}function Ng(i){rS=i}var AD=null;function Lg(i,e){let t=Object.create($h);t.value=i,e!==void 0&&(t.equal=e);let n=()=>oS(t);return n[Fi]=t,nS(t),[n,o=>_c(t,o),o=>aS(t,o)]}function oS(i){return Uh(i),i.value}function _c(i,e){Rg()||sS(i),i.equal(i.value,e)||(i.value=e,wD(i))}function aS(i,e){Rg()||sS(i),_c(i,e(i.value))}var $h=ct(K({},Gh),{equal:iS,value:void 0,kind:"signal"});function wD(i){i.version++,ZT(),Dg(i),AD?.(i)}function Fg(i){let e=Be(null);try{return i()}finally{Be(e)}}function ze(i){return typeof i=="function"}function Fa(i){let t=i(n=>{Error.call(n),n.stack=new Error().stack});return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var Wh=Fa(i=>function(t){i(this),this.message=t?`${t.length} errors occurred during unsubscription:
${t.map((n,r)=>`${r+1}) ${n.toString()}`).join(`
  `)}`:"",this.name="UnsubscriptionError",this.errors=t});function no(i,e){if(i){let t=i.indexOf(e);0<=t&&i.splice(t,1)}}var Bt=class i{constructor(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let e;if(!this.closed){this.closed=!0;let{_parentage:t}=this;if(t)if(this._parentage=null,Array.isArray(t))for(let s of t)s.remove(this);else t.remove(this);let{initialTeardown:n}=this;if(ze(n))try{n()}catch(s){e=s instanceof Wh?s.errors:[s]}let{_finalizers:r}=this;if(r){this._finalizers=null;for(let s of r)try{lS(s)}catch(o){e=e??[],o instanceof Wh?e=[...e,...o.errors]:e.push(o)}}if(e)throw new Wh(e)}}add(e){var t;if(e&&e!==this)if(this.closed)lS(e);else{if(e instanceof i){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=(t=this._finalizers)!==null&&t!==void 0?t:[]).push(e)}}_hasParent(e){let{_parentage:t}=this;return t===e||Array.isArray(t)&&t.includes(e)}_addParent(e){let{_parentage:t}=this;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e}_removeParent(e){let{_parentage:t}=this;t===e?this._parentage=null:Array.isArray(t)&&no(t,e)}remove(e){let{_finalizers:t}=this;t&&no(t,e),e instanceof i&&e._removeParent(this)}};Bt.EMPTY=(()=>{let i=new Bt;return i.closed=!0,i})();var kg=Bt.EMPTY;function jh(i){return i instanceof Bt||i&&"closed"in i&&ze(i.remove)&&ze(i.add)&&ze(i.unsubscribe)}function lS(i){ze(i)?i():i.unsubscribe()}var Qi={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1};var ka={setTimeout(i,e,...t){let{delegate:n}=ka;return n?.setTimeout?n.setTimeout(i,e,...t):setTimeout(i,e,...t)},clearTimeout(i){let{delegate:e}=ka;return(e?.clearTimeout||clearTimeout)(i)},delegate:void 0};function qh(i){ka.setTimeout(()=>{let{onUnhandledError:e}=Qi;if(e)e(i);else throw i})}function io(){}var cS=Bg("C",void 0,void 0);function uS(i){return Bg("E",void 0,i)}function hS(i){return Bg("N",i,void 0)}function Bg(i,e,t){return{kind:i,value:e,error:t}}var ro=null;function Ba(i){if(Qi.useDeprecatedSynchronousErrorHandling){let e=!ro;if(e&&(ro={errorThrown:!1,error:null}),i(),e){let{errorThrown:t,error:n}=ro;if(ro=null,t)throw n}}else i()}function dS(i){Qi.useDeprecatedSynchronousErrorHandling&&ro&&(ro.errorThrown=!0,ro.error=i)}var so=class extends Bt{constructor(e){super(),this.isStopped=!1,e?(this.destination=e,jh(e)&&e.add(this)):this.destination=RD}static create(e,t,n){return new Va(e,t,n)}next(e){this.isStopped?Gg(hS(e),this):this._next(e)}error(e){this.isStopped?Gg(uS(e),this):(this.isStopped=!0,this._error(e))}complete(){this.isStopped?Gg(cS,this):(this.isStopped=!0,this._complete())}unsubscribe(){this.closed||(this.isStopped=!0,super.unsubscribe(),this.destination=null)}_next(e){this.destination.next(e)}_error(e){try{this.destination.error(e)}finally{this.unsubscribe()}}_complete(){try{this.destination.complete()}finally{this.unsubscribe()}}},MD=Function.prototype.bind;function Vg(i,e){return MD.call(i,e)}var Ug=class{constructor(e){this.partialObserver=e}next(e){let{partialObserver:t}=this;if(t.next)try{t.next(e)}catch(n){Yh(n)}}error(e){let{partialObserver:t}=this;if(t.error)try{t.error(e)}catch(n){Yh(n)}else Yh(e)}complete(){let{partialObserver:e}=this;if(e.complete)try{e.complete()}catch(t){Yh(t)}}},Va=class extends so{constructor(e,t,n){super();let r;if(ze(e)||!e)r={next:e??void 0,error:t??void 0,complete:n??void 0};else{let s;this&&Qi.useDeprecatedNextContext?(s=Object.create(e),s.unsubscribe=()=>this.unsubscribe(),r={next:e.next&&Vg(e.next,s),error:e.error&&Vg(e.error,s),complete:e.complete&&Vg(e.complete,s)}):r=e}this.destination=new Ug(r)}};function Yh(i){Qi.useDeprecatedSynchronousErrorHandling?dS(i):qh(i)}function DD(i){throw i}function Gg(i,e){let{onStoppedNotification:t}=Qi;t&&ka.setTimeout(()=>t(i,e))}var RD={closed:!0,next:io,error:DD,complete:io};var Ga=typeof Symbol=="function"&&Symbol.observable||"@@observable";function Ji(i){return i}function zg(...i){return Hg(i)}function Hg(i){return i.length===0?Ji:i.length===1?i[0]:function(t){return i.reduce((n,r)=>r(n),t)}}var st=(()=>{class i{constructor(t){t&&(this._subscribe=t)}lift(t){let n=new i;return n.source=this,n.operator=t,n}subscribe(t,n,r){let s=OD(t)?t:new Va(t,n,r);return Ba(()=>{let{operator:o,source:a}=this;s.add(o?o.call(s,a):a?this._subscribe(s):this._trySubscribe(s))}),s}_trySubscribe(t){try{return this._subscribe(t)}catch(n){t.error(n)}}forEach(t,n){return n=fS(n),new n((r,s)=>{let o=new Va({next:a=>{try{t(a)}catch(l){s(l),o.unsubscribe()}},error:s,complete:r});this.subscribe(o)})}_subscribe(t){var n;return(n=this.source)===null||n===void 0?void 0:n.subscribe(t)}[Ga](){return this}pipe(...t){return Hg(t)(this)}toPromise(t){return t=fS(t),new t((n,r)=>{let s;this.subscribe(o=>s=o,o=>r(o),()=>n(s))})}}return i.create=e=>new i(e),i})();function fS(i){var e;return(e=i??Qi.Promise)!==null&&e!==void 0?e:Promise}function PD(i){return i&&ze(i.next)&&ze(i.error)&&ze(i.complete)}function OD(i){return i&&i instanceof so||PD(i)&&jh(i)}function ND(i){return ze(i?.lift)}function at(i){return e=>{if(ND(e))return e.lift(function(t){try{return i(t,this)}catch(n){this.error(n)}});throw new TypeError("Unable to lift unknown Observable type")}}function dt(i,e,t,n,r){return new $g(i,e,t,n,r)}var $g=class extends so{constructor(e,t,n,r,s,o){super(e),this.onFinalize=s,this.shouldUnsubscribe=o,this._next=t?function(a){try{t(a)}catch(l){e.error(l)}}:super._next,this._error=r?function(a){try{r(a)}catch(l){e.error(l)}finally{this.unsubscribe()}}:super._error,this._complete=n?function(){try{n()}catch(a){e.error(a)}finally{this.unsubscribe()}}:super._complete}unsubscribe(){var e;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){let{closed:t}=this;super.unsubscribe(),!t&&((e=this.onFinalize)===null||e===void 0||e.call(this))}}};var pS=Fa(i=>function(){i(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"});var Xt=(()=>{class i extends st{constructor(){super(),this.closed=!1,this.currentObservers=null,this.observers=[],this.isStopped=!1,this.hasError=!1,this.thrownError=null}lift(t){let n=new Kh(this,this);return n.operator=t,n}_throwIfClosed(){if(this.closed)throw new pS}next(t){Ba(()=>{if(this._throwIfClosed(),!this.isStopped){this.currentObservers||(this.currentObservers=Array.from(this.observers));for(let n of this.currentObservers)n.next(t)}})}error(t){Ba(()=>{if(this._throwIfClosed(),!this.isStopped){this.hasError=this.isStopped=!0,this.thrownError=t;let{observers:n}=this;for(;n.length;)n.shift().error(t)}})}complete(){Ba(()=>{if(this._throwIfClosed(),!this.isStopped){this.isStopped=!0;let{observers:t}=this;for(;t.length;)t.shift().complete()}})}unsubscribe(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null}get observed(){var t;return((t=this.observers)===null||t===void 0?void 0:t.length)>0}_trySubscribe(t){return this._throwIfClosed(),super._trySubscribe(t)}_subscribe(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)}_innerSubscribe(t){let{hasError:n,isStopped:r,observers:s}=this;return n||r?kg:(this.currentObservers=null,s.push(t),new Bt(()=>{this.currentObservers=null,no(s,t)}))}_checkFinalizedStatuses(t){let{hasError:n,thrownError:r,isStopped:s}=this;n?t.error(r):s&&t.complete()}asObservable(){let t=new st;return t.source=this,t}}return i.create=(e,t)=>new Kh(e,t),i})(),Kh=class extends Xt{constructor(e,t){super(),this.destination=e,this.source=t}next(e){var t,n;(n=(t=this.destination)===null||t===void 0?void 0:t.next)===null||n===void 0||n.call(t,e)}error(e){var t,n;(n=(t=this.destination)===null||t===void 0?void 0:t.error)===null||n===void 0||n.call(t,e)}complete(){var e,t;(t=(e=this.destination)===null||e===void 0?void 0:e.complete)===null||t===void 0||t.call(e)}_subscribe(e){var t,n;return(n=(t=this.source)===null||t===void 0?void 0:t.subscribe(e))!==null&&n!==void 0?n:kg}};var Dt=class extends Xt{constructor(e){super(),this._value=e}get value(){return this.getValue()}_subscribe(e){let t=super._subscribe(e);return!t.closed&&e.next(this._value),t}getValue(){let{hasError:e,thrownError:t,_value:n}=this;if(e)throw t;return this._throwIfClosed(),n}next(e){super.next(this._value=e)}};var Wg={now(){return(Wg.delegate||Date).now()},delegate:void 0};var Xh=class extends Bt{constructor(e,t){super()}schedule(e,t=0){return this}};var yc={setInterval(i,e,...t){let{delegate:n}=yc;return n?.setInterval?n.setInterval(i,e,...t):setInterval(i,e,...t)},clearInterval(i){let{delegate:e}=yc;return(e?.clearInterval||clearInterval)(i)},delegate:void 0};var Zh=class extends Xh{constructor(e,t){super(e,t),this.scheduler=e,this.work=t,this.pending=!1}schedule(e,t=0){var n;if(this.closed)return this;this.state=e;let r=this.id,s=this.scheduler;return r!=null&&(this.id=this.recycleAsyncId(s,r,t)),this.pending=!0,this.delay=t,this.id=(n=this.id)!==null&&n!==void 0?n:this.requestAsyncId(s,this.id,t),this}requestAsyncId(e,t,n=0){return yc.setInterval(e.flush.bind(e,this),n)}recycleAsyncId(e,t,n=0){if(n!=null&&this.delay===n&&this.pending===!1)return t;t!=null&&yc.clearInterval(t)}execute(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;let n=this._execute(e,t);if(n)return n;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))}_execute(e,t){let n=!1,r;try{this.work(e)}catch(s){n=!0,r=s||new Error("Scheduled action threw falsy error")}if(n)return this.unsubscribe(),r}unsubscribe(){if(!this.closed){let{id:e,scheduler:t}=this,{actions:n}=t;this.work=this.state=this.scheduler=null,this.pending=!1,no(n,this),e!=null&&(this.id=this.recycleAsyncId(t,e,null)),this.delay=null,super.unsubscribe()}}};var Ua=class i{constructor(e,t=i.now){this.schedulerActionCtor=e,this.now=t}schedule(e,t=0,n){return new this.schedulerActionCtor(this,e).schedule(n,t)}};Ua.now=Wg.now;var Qh=class extends Ua{constructor(e,t=Ua.now){super(e,t),this.actions=[],this._active=!1}flush(e){let{actions:t}=this;if(this._active){t.push(e);return}let n;this._active=!0;do if(n=e.execute(e.state,e.delay))break;while(e=t.shift());if(this._active=!1,n){for(;e=t.shift();)e.unsubscribe();throw n}}};var jg=new Qh(Zh),mS=jg;var ii=new st(i=>i.complete());function Jh(i){return i&&ze(i.schedule)}function gS(i){return i[i.length-1]}function _S(i){return ze(gS(i))?i.pop():void 0}function Ss(i){return Jh(gS(i))?i.pop():void 0}function vS(i,e,t,n){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function a(u){try{c(n.next(u))}catch(h){o(h)}}function l(u){try{c(n.throw(u))}catch(h){o(h)}}function c(u){u.done?s(u.value):r(u.value).then(a,l)}c((n=n.apply(i,e||[])).next())})}function yS(i){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&i[e],n=0;if(t)return t.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&n>=i.length&&(i=void 0),{value:i&&i[n++],done:!i}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function oo(i){return this instanceof oo?(this.v=i,this):new oo(i)}function bS(i,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=t.apply(i,e||[]),r,s=[];return r=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),a("next"),a("throw"),a("return",o),r[Symbol.asyncIterator]=function(){return this},r;function o(f){return function(p){return Promise.resolve(p).then(f,h)}}function a(f,p){n[f]&&(r[f]=function(g){return new Promise(function(_,y){s.push([f,g,_,y])>1||l(f,g)})},p&&(r[f]=p(r[f])))}function l(f,p){try{c(n[f](p))}catch(g){d(s[0][3],g)}}function c(f){f.value instanceof oo?Promise.resolve(f.value.v).then(u,h):d(s[0][2],f)}function u(f){l("next",f)}function h(f){l("throw",f)}function d(f,p){f(p),s.shift(),s.length&&l(s[0][0],s[0][1])}}function xS(i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=i[Symbol.asyncIterator],t;return e?e.call(i):(i=typeof yS=="function"?yS(i):i[Symbol.iterator](),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(s){t[s]=i[s]&&function(o){return new Promise(function(a,l){o=i[s](o),r(a,l,o.done,o.value)})}}function r(s,o,a,l){Promise.resolve(l).then(function(c){s({value:c,done:a})},o)}}var ed=i=>i&&typeof i.length=="number"&&typeof i!="function";function td(i){return ze(i?.then)}function nd(i){return ze(i[Ga])}function id(i){return Symbol.asyncIterator&&ze(i?.[Symbol.asyncIterator])}function rd(i){return new TypeError(`You provided ${i!==null&&typeof i=="object"?"an invalid object":`'${i}'`} where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.`)}function LD(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var sd=LD();function od(i){return ze(i?.[sd])}function ad(i){return bS(this,arguments,function*(){let t=i.getReader();try{for(;;){let{value:n,done:r}=yield oo(t.read());if(r)return yield oo(void 0);yield yield oo(n)}}finally{t.releaseLock()}})}function ld(i){return ze(i?.getReader)}function $t(i){if(i instanceof st)return i;if(i!=null){if(nd(i))return FD(i);if(ed(i))return kD(i);if(td(i))return BD(i);if(id(i))return CS(i);if(od(i))return VD(i);if(ld(i))return GD(i)}throw rd(i)}function FD(i){return new st(e=>{let t=i[Ga]();if(ze(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function kD(i){return new st(e=>{for(let t=0;t<i.length&&!e.closed;t++)e.next(i[t]);e.complete()})}function BD(i){return new st(e=>{i.then(t=>{e.closed||(e.next(t),e.complete())},t=>e.error(t)).then(null,qh)})}function VD(i){return new st(e=>{for(let t of i)if(e.next(t),e.closed)return;e.complete()})}function CS(i){return new st(e=>{UD(i,e).catch(t=>e.error(t))})}function GD(i){return CS(ad(i))}function UD(i,e){var t,n,r,s;return vS(this,void 0,void 0,function*(){try{for(t=xS(i);n=yield t.next(),!n.done;){let o=n.value;if(e.next(o),e.closed)return}}catch(o){r={error:o}}finally{try{n&&!n.done&&(s=t.return)&&(yield s.call(t))}finally{if(r)throw r.error}}e.complete()})}function ri(i,e,t,n=0,r=!1){let s=e.schedule(function(){t(),r?i.add(this.schedule(null,n)):this.unsubscribe()},n);if(i.add(s),!r)return s}function cd(i,e=0){return at((t,n)=>{t.subscribe(dt(n,r=>ri(n,i,()=>n.next(r),e),()=>ri(n,i,()=>n.complete(),e),r=>ri(n,i,()=>n.error(r),e)))})}function ud(i,e=0){return at((t,n)=>{n.add(i.schedule(()=>t.subscribe(n),e))})}function TS(i,e){return $t(i).pipe(ud(e),cd(e))}function SS(i,e){return $t(i).pipe(ud(e),cd(e))}function IS(i,e){return new st(t=>{let n=0;return e.schedule(function(){n===i.length?t.complete():(t.next(i[n++]),t.closed||this.schedule())})})}function ES(i,e){return new st(t=>{let n;return ri(t,e,()=>{n=i[sd](),ri(t,e,()=>{let r,s;try{({value:r,done:s}=n.next())}catch(o){t.error(o);return}s?t.complete():t.next(r)},0,!0)}),()=>ze(n?.return)&&n.return()})}function hd(i,e){if(!i)throw new Error("Iterable cannot be null");return new st(t=>{ri(t,e,()=>{let n=i[Symbol.asyncIterator]();ri(t,e,()=>{n.next().then(r=>{r.done?t.complete():t.next(r.value)})},0,!0)})})}function AS(i,e){return hd(ad(i),e)}function wS(i,e){if(i!=null){if(nd(i))return TS(i,e);if(ed(i))return IS(i,e);if(td(i))return SS(i,e);if(id(i))return hd(i,e);if(od(i))return ES(i,e);if(ld(i))return AS(i,e)}throw rd(i)}function cn(i,e){return e?wS(i,e):$t(i)}function Je(...i){let e=Ss(i);return cn(i,e)}function qg(i,e){let t=ze(i)?i:()=>i,n=r=>r.error(t());return new st(e?r=>e.schedule(n,0,r):n)}function dd(i){return!!i&&(i instanceof st||ze(i.lift)&&ze(i.subscribe))}var ao=Fa(i=>function(){i(this),this.name="EmptyError",this.message="no elements in sequence"});function MS(i){return i instanceof Date&&!isNaN(i)}function It(i,e){return at((t,n)=>{let r=0;t.subscribe(dt(n,s=>{n.next(i.call(e,s,r++))}))})}var{isArray:zD}=Array;function HD(i,e){return zD(e)?i(...e):i(e)}function DS(i){return It(e=>HD(i,e))}var{isArray:$D}=Array,{getPrototypeOf:WD,prototype:jD,keys:qD}=Object;function RS(i){if(i.length===1){let e=i[0];if($D(e))return{args:e,keys:null};if(YD(e)){let t=qD(e);return{args:t.map(n=>e[n]),keys:t}}}return{args:i,keys:null}}function YD(i){return i&&typeof i=="object"&&WD(i)===jD}function PS(i,e){return i.reduce((t,n,r)=>(t[n]=e[r],t),{})}function Yg(...i){let e=Ss(i),t=_S(i),{args:n,keys:r}=RS(i);if(n.length===0)return cn([],e);let s=new st(KD(n,e,r?o=>PS(r,o):Ji));return t?s.pipe(DS(t)):s}function KD(i,e,t=Ji){return n=>{OS(e,()=>{let{length:r}=i,s=new Array(r),o=r,a=r;for(let l=0;l<r;l++)OS(e,()=>{let c=cn(i[l],e),u=!1;c.subscribe(dt(n,h=>{s[l]=h,u||(u=!0,a--),a||n.next(t(s.slice()))},()=>{--o||n.complete()}))},n)},n)}}function OS(i,e,t){i?ri(t,i,e):e()}function NS(i,e,t,n,r,s,o,a){let l=[],c=0,u=0,h=!1,d=()=>{h&&!l.length&&!c&&e.complete()},f=g=>c<n?p(g):l.push(g),p=g=>{s&&e.next(g),c++;let _=!1;$t(t(g,u++)).subscribe(dt(e,y=>{r?.(y),s?f(y):e.next(y)},()=>{_=!0},void 0,()=>{if(_)try{for(c--;l.length&&c<n;){let y=l.shift();o?ri(e,o,()=>p(y)):p(y)}d()}catch(y){e.error(y)}}))};return i.subscribe(dt(e,f,()=>{h=!0,d()})),()=>{a?.()}}function vn(i,e,t=1/0){return ze(e)?vn((n,r)=>It((s,o)=>e(n,s,r,o))($t(i(n,r))),t):(typeof e=="number"&&(t=e),at((n,r)=>NS(n,r,i,t)))}function LS(i=1/0){return vn(Ji,i)}function FS(){return LS(1)}function Is(...i){return FS()(cn(i,Ss(i)))}function vc(i){return new st(e=>{$t(i()).subscribe(e)})}function kS(i=0,e,t=mS){let n=-1;return e!=null&&(Jh(e)?t=e:n=e),new st(r=>{let s=MS(i)?+i-t.now():i;s<0&&(s=0);let o=0;return t.schedule(function(){r.closed||(r.next(o++),0<=n?this.schedule(void 0,n):r.complete())},s)})}function yr(i,e){return at((t,n)=>{let r=0;t.subscribe(dt(n,s=>i.call(e,s,r++)&&n.next(s)))})}function bc(i){return at((e,t)=>{let n=null,r=!1,s;n=e.subscribe(dt(t,void 0,void 0,o=>{s=$t(i(o,bc(i)(e))),n?(n.unsubscribe(),n=null,s.subscribe(t)):r=!0})),r&&(n.unsubscribe(),n=null,s.subscribe(t))})}function lo(i,e){return ze(e)?vn(i,e,1):vn(i,1)}function Kg(i){return at((e,t)=>{let n=!1;e.subscribe(dt(t,r=>{n=!0,t.next(r)},()=>{n||t.next(i),t.complete()}))})}function ki(i){return i<=0?()=>ii:at((e,t)=>{let n=0;e.subscribe(dt(t,r=>{++n<=i&&(t.next(r),i<=n&&t.complete())}))})}function BS(){return at((i,e)=>{i.subscribe(dt(e,io))})}function VS(i){return It(()=>i)}function Xg(i,e){return e?t=>Is(e.pipe(ki(1),BS()),t.pipe(Xg(i))):vn((t,n)=>$t(i(t,n)).pipe(ki(1),VS(t)))}function fd(i,e=jg){let t=kS(i,e);return Xg(()=>t)}function GS(i=XD){return at((e,t)=>{let n=!1;e.subscribe(dt(t,r=>{n=!0,t.next(r)},()=>n?t.complete():t.error(i())))})}function XD(){return new ao}function Zg(i){return at((e,t)=>{try{e.subscribe(t)}finally{t.add(i)}})}function Qr(i,e){let t=arguments.length>=2;return n=>n.pipe(i?yr((r,s)=>i(r,s,n)):Ji,ki(1),t?Kg(e):GS(()=>new ao))}function pd(i){return i<=0?()=>ii:at((e,t)=>{let n=[];e.subscribe(dt(t,r=>{n.push(r),i<n.length&&n.shift()},()=>{for(let r of n)t.next(r);t.complete()},void 0,()=>{n=null}))})}function Qg(...i){let e=Ss(i);return at((t,n)=>{(e?Is(i,t,e):Is(i,t)).subscribe(n)})}function vr(i,e){return at((t,n)=>{let r=null,s=0,o=!1,a=()=>o&&!r&&n.complete();t.subscribe(dt(n,l=>{r?.unsubscribe();let c=0,u=s++;$t(i(l,u)).subscribe(r=dt(n,h=>n.next(e?e(l,h,u,c++):h),()=>{r=null,a()}))},()=>{o=!0,a()}))})}function xc(i){return at((e,t)=>{$t(i).subscribe(dt(t,()=>t.complete(),io)),!t.closed&&e.subscribe(t)})}function un(i,e,t){let n=ze(i)||e||t?{next:i,error:e,complete:t}:i;return n?at((r,s)=>{var o;(o=n.subscribe)===null||o===void 0||o.call(n);let a=!0;r.subscribe(dt(s,l=>{var c;(c=n.next)===null||c===void 0||c.call(n,l),s.next(l)},()=>{var l;a=!1,(l=n.complete)===null||l===void 0||l.call(n),s.complete()},l=>{var c;a=!1,(c=n.error)===null||c===void 0||c.call(n,l),s.error(l)},()=>{var l,c;a&&((l=n.unsubscribe)===null||l===void 0||l.call(n)),(c=n.finalize)===null||c===void 0||c.call(n)}))}):Ji}var Jg;function md(){return Jg}function br(i){let e=Jg;return Jg=i,e}var US=Symbol("NotFound");function za(i){return i===US||i?.name==="\u0275NotFound"}var xd="https://angular.dev/best-practices/security#preventing-cross-site-scripting-xss",Le=class extends Error{code;constructor(e,t){super($a(e,t)),this.code=e}};function eR(i){return`NG0${Math.abs(i)}`}function $a(i,e){return`${eR(i)}${e?": "+e:""}`}function ft(i){for(let e in i)if(i[e]===ft)return e;throw Error("")}function es(i){if(typeof i=="string")return i;if(Array.isArray(i))return`[${i.map(es).join(", ")}]`;if(i==null)return""+i;let e=i.overriddenName||i.name;if(e)return`${e}`;let t=i.toString();if(t==null)return""+t;let n=t.indexOf(`
`);return n>=0?t.slice(0,n):t}function p_(i,e){return i?e?`${i} ${e}`:i:e||""}var tR=ft({__forward_ref__:ft});function Cd(i){return i.__forward_ref__=Cd,i.toString=function(){return es(this())},i}function si(i){return m_(i)?i():i}function m_(i){return typeof i=="function"&&i.hasOwnProperty(tR)&&i.__forward_ref__===Cd}function Me(i){return{token:i.token,providedIn:i.providedIn||null,factory:i.factory,value:void 0}}function Wa(i){return{providers:i.providers||[],imports:i.imports||[]}}function Ac(i){return nR(i,Td)}function g_(i){return Ac(i)!==null}function nR(i,e){return i.hasOwnProperty(e)&&i[e]||null}function iR(i){let e=i?.[Td]??null;return e||null}function t_(i){return i&&i.hasOwnProperty(_d)?i[_d]:null}var Td=ft({\u0275prov:ft}),_d=ft({\u0275inj:ft}),Ve=class{_desc;ngMetadataName="InjectionToken";\u0275prov;constructor(e,t){this._desc=e,this.\u0275prov=void 0,typeof t=="number"?this.__NG_ELEMENT_ID__=t:t!==void 0&&(this.\u0275prov=Me({token:this,providedIn:t.providedIn||"root",factory:t.factory}))}get multi(){return this}toString(){return`InjectionToken ${this._desc}`}};function __(i){return i&&!!i.\u0275providers}var y_=ft({\u0275cmp:ft}),v_=ft({\u0275dir:ft}),b_=ft({\u0275pipe:ft}),x_=ft({\u0275mod:ft}),Tc=ft({\u0275fac:ft}),po=ft({__NG_ELEMENT_ID__:ft}),zS=ft({__NG_ENV_ID__:ft});function Sd(i){return typeof i=="string"?i:i==null?"":String(i)}function jS(i){return typeof i=="function"?i.name||i.toString():typeof i=="object"&&i!=null&&typeof i.type=="function"?i.type.name||i.type.toString():Sd(i)}var qS=ft({ngErrorCode:ft}),rR=ft({ngErrorMessage:ft}),sR=ft({ngTokenPath:ft});function C_(i,e){return YS("",-200,e)}function Id(i,e){throw new Le(-201,!1)}function YS(i,e,t){let n=new Le(e,i);return n[qS]=e,n[rR]=i,t&&(n[sR]=t),n}function oR(i){return i[qS]}var n_;function KS(){return n_}function Un(i){let e=n_;return n_=i,e}function T_(i,e,t){let n=Ac(i);if(n&&n.providedIn=="root")return n.value===void 0?n.value=n.factory():n.value;if(t&8)return null;if(e!==void 0)return e;Id(i,"Injector")}var aR={},co=aR,lR="__NG_DI_FLAG__",i_=class{injector;constructor(e){this.injector=e}retrieve(e,t){let n=uo(t)||0;try{return this.injector.get(e,n&8?null:co,n)}catch(r){if(za(r))return r;throw r}}};function cR(i,e=0){let t=md();if(t===void 0)throw new Le(-203,!1);if(t===null)return T_(i,void 0,e);{let n=uR(e),r=t.retrieve(i,n);if(za(r)){if(n.optional)return null;throw r}return r}}function je(i,e=0){return(KS()||cR)(si(i),e)}function ae(i,e){return je(i,uo(e))}function uo(i){return typeof i>"u"||typeof i=="number"?i:0|(i.optional&&8)|(i.host&&1)|(i.self&&2)|(i.skipSelf&&4)}function uR(i){return{optional:!!(i&8),host:!!(i&1),self:!!(i&2),skipSelf:!!(i&4)}}function r_(i){let e=[];for(let t=0;t<i.length;t++){let n=si(i[t]);if(Array.isArray(n)){if(n.length===0)throw new Le(900,!1);let r,s=0;for(let o=0;o<n.length;o++){let a=n[o],l=hR(a);typeof l=="number"?l===-1?r=a.token:s|=l:r=a}e.push(je(r,s))}else e.push(je(n))}return e}function hR(i){return i[lR]}function Es(i,e){let t=i.hasOwnProperty(Tc);return t?i[Tc]:null}function XS(i,e,t){if(i.length!==e.length)return!1;for(let n=0;n<i.length;n++){let r=i[n],s=e[n];if(t&&(r=t(r),s=t(s)),s!==r)return!1}return!0}function ZS(i){return i.flat(Number.POSITIVE_INFINITY)}function Ed(i,e){i.forEach(t=>Array.isArray(t)?Ed(t,e):e(t))}function S_(i,e,t){e>=i.length?i.push(t):i.splice(e,0,t)}function wc(i,e){return e>=i.length-1?i.pop():i.splice(e,1)[0]}function QS(i,e,t,n){let r=i.length;if(r==e)i.push(t,n);else if(r===1)i.push(n,i[0]),i[0]=t;else{for(r--,i.push(i[r-1],i[r]);r>e;){let s=r-2;i[r]=i[s],r--}i[e]=t,i[e+1]=n}}function JS(i,e,t){let n=ja(i,e);return n>=0?i[n|1]=t:(n=~n,QS(i,n,e,t)),n}function Ad(i,e){let t=ja(i,e);if(t>=0)return i[t|1]}function ja(i,e){return dR(i,e,1)}function dR(i,e,t){let n=0,r=i.length>>t;for(;r!==n;){let s=n+(r-n>>1),o=i[s<<t];if(e===o)return s<<t;o>e?r=s:n=s+1}return~(r<<t)}var mo={},Bi=[],ws=new Ve(""),I_=new Ve("",-1),E_=new Ve(""),Sc=class{get(e,t=co){if(t===co){let r=YS("",-201);throw r.name="\u0275NotFound",r}return t}};function A_(i){return i[x_]||null}function Ms(i){return i[y_]||null}function w_(i){return i[v_]||null}function e0(i){return i[b_]||null}function qa(i){return{\u0275providers:i}}function t0(...i){return{\u0275providers:M_(!0,i),\u0275fromNgModule:!0}}function M_(i,...e){let t=[],n=new Set,r,s=o=>{t.push(o)};return Ed(e,o=>{let a=o;yd(a,s,[],n)&&(r||=[],r.push(a))}),r!==void 0&&n0(r,s),t}function n0(i,e){for(let t=0;t<i.length;t++){let{ngModule:n,providers:r}=i[t];D_(r,s=>{e(s,n)})}}function yd(i,e,t,n){if(i=si(i),!i)return!1;let r=null,s=t_(i),o=!s&&Ms(i);if(!s&&!o){let l=i.ngModule;if(s=t_(l),s)r=l;else return!1}else{if(o&&!o.standalone)return!1;r=i}let a=n.has(r);if(o){if(a)return!1;if(n.add(r),o.dependencies){let l=typeof o.dependencies=="function"?o.dependencies():o.dependencies;for(let c of l)yd(c,e,t,n)}}else if(s){if(s.imports!=null&&!a){n.add(r);let c;try{Ed(s.imports,u=>{yd(u,e,t,n)&&(c||=[],c.push(u))})}finally{}c!==void 0&&n0(c,e)}if(!a){let c=Es(r)||(()=>new r);e({provide:r,useFactory:c,deps:Bi},r),e({provide:E_,useValue:r,multi:!0},r),e({provide:ws,useValue:()=>je(r),multi:!0},r)}let l=s.providers;if(l!=null&&!a){let c=i;D_(l,u=>{e(u,c)})}}else return!1;return r!==i&&i.providers!==void 0}function D_(i,e){for(let t of i)__(t)&&(t=t.\u0275providers),Array.isArray(t)?D_(t,e):e(t)}var fR=ft({provide:String,useValue:ft});function i0(i){return i!==null&&typeof i=="object"&&fR in i}function pR(i){return!!(i&&i.useExisting)}function mR(i){return!!(i&&i.useFactory)}function vd(i){return typeof i=="function"}var Mc=new Ve(""),gd={},HS={},e_;function Dc(){return e_===void 0&&(e_=new Sc),e_}var An=class{},ho=class extends An{parent;source;scopes;records=new Map;_ngOnDestroyHooks=new Set;_onDestroyHooks=[];get destroyed(){return this._destroyed}_destroyed=!1;injectorDefTypes;constructor(e,t,n,r){super(),this.parent=t,this.source=n,this.scopes=r,o_(e,o=>this.processProvider(o)),this.records.set(I_,Ha(void 0,this)),r.has("environment")&&this.records.set(An,Ha(void 0,this));let s=this.records.get(Mc);s!=null&&typeof s.value=="string"&&this.scopes.add(s.value),this.injectorDefTypes=new Set(this.get(E_,Bi,{self:!0}))}retrieve(e,t){let n=uo(t)||0;try{return this.get(e,co,n)}catch(r){if(za(r))return r;throw r}}destroy(){Cc(this),this._destroyed=!0;let e=Be(null);try{for(let n of this._ngOnDestroyHooks)n.ngOnDestroy();let t=this._onDestroyHooks;this._onDestroyHooks=[];for(let n of t)n()}finally{this.records.clear(),this._ngOnDestroyHooks.clear(),this.injectorDefTypes.clear(),Be(e)}}onDestroy(e){return Cc(this),this._onDestroyHooks.push(e),()=>this.removeOnDestroy(e)}runInContext(e){Cc(this);let t=br(this),n=Un(void 0),r;try{return e()}finally{br(t),Un(n)}}get(e,t=co,n){if(Cc(this),e.hasOwnProperty(zS))return e[zS](this);let r=uo(n),s,o=br(this),a=Un(void 0);try{if(!(r&4)){let c=this.records.get(e);if(c===void 0){let u=bR(e)&&Ac(e);u&&this.injectableDefInScope(u)?c=Ha(s_(e),gd):c=null,this.records.set(e,c)}if(c!=null)return this.hydrate(e,c,r)}let l=r&2?Dc():this.parent;return t=r&8&&t===co?null:t,l.get(e,t)}catch(l){let c=oR(l);throw c===-200||c===-201?new Le(c,null):l}finally{Un(a),br(o)}}resolveInjectorInitializers(){let e=Be(null),t=br(this),n=Un(void 0),r;try{let s=this.get(ws,Bi,{self:!0});for(let o of s)o()}finally{br(t),Un(n),Be(e)}}toString(){let e=[],t=this.records;for(let n of t.keys())e.push(es(n));return`R3Injector[${e.join(", ")}]`}processProvider(e){e=si(e);let t=vd(e)?e:si(e&&e.provide),n=_R(e);if(!vd(e)&&e.multi===!0){let r=this.records.get(t);r||(r=Ha(void 0,gd,!0),r.factory=()=>r_(r.multi),this.records.set(t,r)),t=e,r.multi.push(e)}this.records.set(t,n)}hydrate(e,t,n){let r=Be(null);try{if(t.value===HS)throw C_(es(e));return t.value===gd&&(t.value=HS,t.value=t.factory(void 0,n)),typeof t.value=="object"&&t.value&&vR(t.value)&&this._ngOnDestroyHooks.add(t.value),t.value}finally{Be(r)}}injectableDefInScope(e){if(!e.providedIn)return!1;let t=si(e.providedIn);return typeof t=="string"?t==="any"||this.scopes.has(t):this.injectorDefTypes.has(t)}removeOnDestroy(e){let t=this._onDestroyHooks.indexOf(e);t!==-1&&this._onDestroyHooks.splice(t,1)}};function s_(i){let e=Ac(i),t=e!==null?e.factory:Es(i);if(t!==null)return t;if(i instanceof Ve)throw new Le(204,!1);if(i instanceof Function)return gR(i);throw new Le(204,!1)}function gR(i){if(i.length>0)throw new Le(204,!1);let t=iR(i);return t!==null?()=>t.factory(i):()=>new i}function _R(i){if(i0(i))return Ha(void 0,i.useValue);{let e=r0(i);return Ha(e,gd)}}function r0(i,e,t){let n;if(vd(i)){let r=si(i);return Es(r)||s_(r)}else if(i0(i))n=()=>si(i.useValue);else if(mR(i))n=()=>i.useFactory(...r_(i.deps||[]));else if(pR(i))n=(r,s)=>je(si(i.useExisting),s!==void 0&&s&8?8:void 0);else{let r=si(i&&(i.useClass||i.provide));if(yR(i))n=()=>new r(...r_(i.deps));else return Es(r)||s_(r)}return n}function Cc(i){if(i.destroyed)throw new Le(205,!1)}function Ha(i,e,t=!1){return{factory:i,value:e,multi:t?[]:void 0}}function yR(i){return!!i.deps}function vR(i){return i!==null&&typeof i=="object"&&typeof i.ngOnDestroy=="function"}function bR(i){return typeof i=="function"||typeof i=="object"&&i.ngMetadataName==="InjectionToken"}function o_(i,e){for(let t of i)Array.isArray(t)?o_(t,e):t&&__(t)?o_(t.\u0275providers,e):e(t)}function Hn(i,e){let t;i instanceof ho?(Cc(i),t=i):t=new i_(i);let n,r=br(t),s=Un(void 0);try{return e()}finally{br(r),Un(s)}}function s0(){return KS()!==void 0||md()!=null}var er=0,Fe=1,qe=2,Zt=3,Vi=4,Gi=5,Ya=6,Ka=7,Vt=8,ns=9,Cr=10,Qt=11,Xa=12,R_=13,go=14,yi=15,Ds=16,_o=17,Tr=18,Rc=19,P_=20,Jr=21,wd=22,Pc=23,vi=24,Md=25,yo=26,Jt=27,o0=1,O_=6,Rs=7,Oc=8,vo=9,Nt=10;function is(i){return Array.isArray(i)&&typeof i[o0]=="object"}function tr(i){return Array.isArray(i)&&i[o0]===!0}function N_(i){return(i.flags&4)!==0}function bo(i){return i.componentOffset>-1}function Dd(i){return(i.flags&1)===1}function xo(i){return!!i.template}function Za(i){return(i[qe]&512)!==0}function Co(i){return(i[qe]&256)===256}var L_="svg",a0="math";function Ui(i){for(;Array.isArray(i);)i=i[er];return i}function F_(i,e){return Ui(e[i])}function Sr(i,e){return Ui(e[i.index])}function Nc(i,e){return i.data[e]}function l0(i,e){return i[e]}function k_(i,e,t,n){t>=i.data.length&&(i.data[t]=null,i.blueprint[t]=null),e[t]=n}function Ir(i,e){let t=e[i];return is(t)?t:t[er]}function c0(i){return(i[qe]&4)===4}function Rd(i){return(i[qe]&128)===128}function u0(i){return tr(i[Zt])}function Er(i,e){return e==null?null:i[e]}function B_(i){i[_o]=0}function V_(i){i[qe]&1024||(i[qe]|=1024,Rd(i)&&Fc(i))}function h0(i,e){for(;i>0;)e=e[go],i--;return e}function Lc(i){return!!(i[qe]&9216||i[vi]?.dirty)}function Pd(i){i[Cr].changeDetectionScheduler?.notify(8),i[qe]&64&&(i[qe]|=1024),Lc(i)&&Fc(i)}function Fc(i){i[Cr].changeDetectionScheduler?.notify(0);let e=As(i);for(;e!==null&&!(e[qe]&8192||(e[qe]|=8192,!Rd(e)));)e=As(e)}function G_(i,e){if(Co(i))throw new Le(911,!1);i[Jr]===null&&(i[Jr]=[]),i[Jr].push(e)}function d0(i,e){if(i[Jr]===null)return;let t=i[Jr].indexOf(e);t!==-1&&i[Jr].splice(t,1)}function As(i){let e=i[Zt];return tr(e)?e[Zt]:e}function U_(i){return i[Ka]??=[]}function z_(i){return i.cleanup??=[]}function f0(i,e,t,n){let r=U_(e);r.push(t),i.firstCreatePass&&z_(i).push(n,r.length-1)}var Ke={lFrame:w0(null),bindingsEnabled:!0,skipHydrationRootTNode:null};var a_=!1;function p0(){return Ke.lFrame.elementDepthCount}function m0(){Ke.lFrame.elementDepthCount++}function H_(){Ke.lFrame.elementDepthCount--}function g0(){return Ke.bindingsEnabled}function _0(){return Ke.skipHydrationRootTNode!==null}function $_(i){return Ke.skipHydrationRootTNode===i}function W_(){Ke.skipHydrationRootTNode=null}function lt(){return Ke.lFrame.lView}function bi(){return Ke.lFrame.tView}function Qa(i){return Ke.lFrame.contextLView=i,i[Vt]}function Ja(i){return Ke.lFrame.contextLView=null,i}function nr(){let i=j_();for(;i!==null&&i.type===64;)i=i.parent;return i}function j_(){return Ke.lFrame.currentTNode}function y0(){let i=Ke.lFrame,e=i.currentTNode;return i.isParent?e:e.parent}function el(i,e){let t=Ke.lFrame;t.currentTNode=i,t.isParent=e}function q_(){return Ke.lFrame.isParent}function v0(){Ke.lFrame.isParent=!1}function Y_(){return a_}function K_(i){let e=a_;return a_=i,e}function b0(){let i=Ke.lFrame,e=i.bindingRootIndex;return e===-1&&(e=i.bindingRootIndex=i.tView.bindingStartIndex),e}function x0(i){return Ke.lFrame.bindingIndex=i}function kc(){return Ke.lFrame.bindingIndex++}function C0(i){let e=Ke.lFrame,t=e.bindingIndex;return e.bindingIndex=e.bindingIndex+i,t}function T0(){return Ke.lFrame.inI18n}function S0(i,e){let t=Ke.lFrame;t.bindingIndex=t.bindingRootIndex=i,Od(e)}function I0(){return Ke.lFrame.currentDirectiveIndex}function Od(i){Ke.lFrame.currentDirectiveIndex=i}function E0(i){let e=Ke.lFrame.currentDirectiveIndex;return e===-1?null:i[e]}function X_(){return Ke.lFrame.currentQueryIndex}function Nd(i){Ke.lFrame.currentQueryIndex=i}function xR(i){let e=i[Fe];return e.type===2?e.declTNode:e.type===1?i[Gi]:null}function Z_(i,e,t){if(t&4){let r=e,s=i;for(;r=r.parent,r===null&&!(t&1);)if(r=xR(s),r===null||(s=s[go],r.type&10))break;if(r===null)return!1;e=r,i=s}let n=Ke.lFrame=A0();return n.currentTNode=e,n.lView=i,!0}function Ld(i){let e=A0(),t=i[Fe];Ke.lFrame=e,e.currentTNode=t.firstChild,e.lView=i,e.tView=t,e.contextLView=i,e.bindingIndex=t.bindingStartIndex,e.inI18n=!1}function A0(){let i=Ke.lFrame,e=i===null?null:i.child;return e===null?w0(i):e}function w0(i){let e={currentTNode:null,isParent:!0,lView:null,tView:null,selectedIndex:-1,contextLView:null,elementDepthCount:0,currentNamespace:null,currentDirectiveIndex:-1,bindingRootIndex:-1,bindingIndex:-1,currentQueryIndex:0,parent:i,child:null,inI18n:!1};return i!==null&&(i.child=e),e}function M0(){let i=Ke.lFrame;return Ke.lFrame=i.parent,i.currentTNode=null,i.lView=null,i}var Q_=M0;function Fd(){let i=M0();i.isParent=!0,i.tView=null,i.selectedIndex=-1,i.contextLView=null,i.elementDepthCount=0,i.currentDirectiveIndex=-1,i.currentNamespace=null,i.bindingRootIndex=-1,i.bindingIndex=-1,i.currentQueryIndex=0}function D0(i){return(Ke.lFrame.contextLView=h0(i,Ke.lFrame.contextLView))[Vt]}function Ps(){return Ke.lFrame.selectedIndex}function Os(i){Ke.lFrame.selectedIndex=i}function R0(){let i=Ke.lFrame;return Nc(i.tView,i.selectedIndex)}function To(){Ke.lFrame.currentNamespace=L_}function kd(){CR()}function CR(){Ke.lFrame.currentNamespace=null}function P0(){return Ke.lFrame.currentNamespace}var O0=!0;function Bd(){return O0}function Vd(i){O0=i}function l_(i,e=null,t=null,n){let r=J_(i,e,t,n);return r.resolveInjectorInitializers(),r}function J_(i,e=null,t=null,n,r=new Set){let s=[t||Bi,t0(i)];return n=n||(typeof i=="object"?void 0:es(i)),new ho(s,e||Dc(),n||null,r)}var xr=class i{static THROW_IF_NOT_FOUND=co;static NULL=new Sc;static create(e,t){if(Array.isArray(e))return l_({name:""},t,e,"");{let n=e.name??"";return l_({name:n},e.parent,e.providers,n)}}static \u0275prov=Me({token:i,providedIn:"any",factory:()=>je(I_)});static __NG_ELEMENT_ID__=-1},$n=new Ve(""),tl=(()=>{class i{static __NG_ELEMENT_ID__=TR;static __NG_ENV_ID__=t=>t}return i})(),c_=class extends tl{_lView;constructor(e){super(),this._lView=e}get destroyed(){return Co(this._lView)}onDestroy(e){let t=this._lView;return G_(t,e),()=>d0(t,e)}};function TR(){return new c_(lt())}var ey=!1,rs=(()=>{class i{taskId=0;pendingTasks=new Set;destroyed=!1;pendingTask=new Dt(!1);get hasPendingTasks(){return this.destroyed?!1:this.pendingTask.value}get hasPendingTasksObservable(){return this.destroyed?new st(t=>{t.next(!1),t.complete()}):this.pendingTask}add(){!this.hasPendingTasks&&!this.destroyed&&this.pendingTask.next(!0);let t=this.taskId++;return this.pendingTasks.add(t),t}has(t){return this.pendingTasks.has(t)}remove(t){this.pendingTasks.delete(t),this.pendingTasks.size===0&&this.hasPendingTasks&&this.pendingTask.next(!1)}ngOnDestroy(){this.pendingTasks.clear(),this.hasPendingTasks&&this.pendingTask.next(!1),this.destroyed=!0,this.pendingTask.unsubscribe()}static \u0275prov=Me({token:i,providedIn:"root",factory:()=>new i})}return i})(),u_=class extends Xt{__isAsync;destroyRef=void 0;pendingTasks=void 0;constructor(e=!1){super(),this.__isAsync=e,s0()&&(this.destroyRef=ae(tl,{optional:!0})??void 0,this.pendingTasks=ae(rs,{optional:!0})??void 0)}emit(e){let t=Be(null);try{super.next(e)}finally{Be(t)}}subscribe(e,t,n){let r=e,s=t||(()=>null),o=n;if(e&&typeof e=="object"){let l=e;r=l.next?.bind(l),s=l.error?.bind(l),o=l.complete?.bind(l)}this.__isAsync&&(s=this.wrapInTimeout(s),r&&(r=this.wrapInTimeout(r)),o&&(o=this.wrapInTimeout(o)));let a=super.subscribe({next:r,error:s,complete:o});return e instanceof Bt&&e.add(a),a}wrapInTimeout(e){return t=>{let n=this.pendingTasks?.add();setTimeout(()=>{try{e(t)}finally{n!==void 0&&this.pendingTasks?.remove(n)}})}}},zn=u_;function bd(...i){}function ty(i){let e,t;function n(){i=bd;try{t!==void 0&&typeof cancelAnimationFrame=="function"&&cancelAnimationFrame(t),e!==void 0&&clearTimeout(e)}catch{}}return e=setTimeout(()=>{i(),n()}),typeof requestAnimationFrame=="function"&&(t=requestAnimationFrame(()=>{i(),n()})),()=>n()}function ny(i){return queueMicrotask(()=>i()),()=>{i=bd}}var iy="isAngularZone",Ic=iy+"_ID",SR=0,Et=class i{hasPendingMacrotasks=!1;hasPendingMicrotasks=!1;isStable=!0;onUnstable=new zn(!1);onMicrotaskEmpty=new zn(!1);onStable=new zn(!1);onError=new zn(!1);constructor(e){let{enableLongStackTrace:t=!1,shouldCoalesceEventChangeDetection:n=!1,shouldCoalesceRunChangeDetection:r=!1,scheduleInRootZone:s=ey}=e;if(typeof Zone>"u")throw new Le(908,!1);Zone.assertZonePatched();let o=this;o._nesting=0,o._outer=o._inner=Zone.current,Zone.TaskTrackingZoneSpec&&(o._inner=o._inner.fork(new Zone.TaskTrackingZoneSpec)),t&&Zone.longStackTraceZoneSpec&&(o._inner=o._inner.fork(Zone.longStackTraceZoneSpec)),o.shouldCoalesceEventChangeDetection=!r&&n,o.shouldCoalesceRunChangeDetection=r,o.callbackScheduled=!1,o.scheduleInRootZone=s,AR(o)}static isInAngularZone(){return typeof Zone<"u"&&Zone.current.get(iy)===!0}static assertInAngularZone(){if(!i.isInAngularZone())throw new Le(909,!1)}static assertNotInAngularZone(){if(i.isInAngularZone())throw new Le(909,!1)}run(e,t,n){return this._inner.run(e,t,n)}runTask(e,t,n,r){let s=this._inner,o=s.scheduleEventTask("NgZoneEvent: "+r,e,IR,bd,bd);try{return s.runTask(o,t,n)}finally{s.cancelTask(o)}}runGuarded(e,t,n){return this._inner.runGuarded(e,t,n)}runOutsideAngular(e){return this._outer.run(e)}},IR={};function ry(i){if(i._nesting==0&&!i.hasPendingMicrotasks&&!i.isStable)try{i._nesting++,i.onMicrotaskEmpty.emit(null)}finally{if(i._nesting--,!i.hasPendingMicrotasks)try{i.runOutsideAngular(()=>i.onStable.emit(null))}finally{i.isStable=!0}}}function ER(i){if(i.isCheckStableRunning||i.callbackScheduled)return;i.callbackScheduled=!0;function e(){ty(()=>{i.callbackScheduled=!1,h_(i),i.isCheckStableRunning=!0,ry(i),i.isCheckStableRunning=!1})}i.scheduleInRootZone?Zone.root.run(()=>{e()}):i._outer.run(()=>{e()}),h_(i)}function AR(i){let e=()=>{ER(i)},t=SR++;i._inner=i._inner.fork({name:"angular",properties:{[iy]:!0,[Ic]:t,[Ic+t]:!0},onInvokeTask:(n,r,s,o,a,l)=>{if(wR(l))return n.invokeTask(s,o,a,l);try{return $S(i),n.invokeTask(s,o,a,l)}finally{(i.shouldCoalesceEventChangeDetection&&o.type==="eventTask"||i.shouldCoalesceRunChangeDetection)&&e(),WS(i)}},onInvoke:(n,r,s,o,a,l,c)=>{try{return $S(i),n.invoke(s,o,a,l,c)}finally{i.shouldCoalesceRunChangeDetection&&!i.callbackScheduled&&!MR(l)&&e(),WS(i)}},onHasTask:(n,r,s,o)=>{n.hasTask(s,o),r===s&&(o.change=="microTask"?(i._hasPendingMicrotasks=o.microTask,h_(i),ry(i)):o.change=="macroTask"&&(i.hasPendingMacrotasks=o.macroTask))},onHandleError:(n,r,s,o)=>(n.handleError(s,o),i.runOutsideAngular(()=>i.onError.emit(o)),!1)})}function h_(i){i._hasPendingMicrotasks||(i.shouldCoalesceEventChangeDetection||i.shouldCoalesceRunChangeDetection)&&i.callbackScheduled===!0?i.hasPendingMicrotasks=!0:i.hasPendingMicrotasks=!1}function $S(i){i._nesting++,i.isStable&&(i.isStable=!1,i.onUnstable.emit(null))}function WS(i){i._nesting--,ry(i)}var Ec=class{hasPendingMicrotasks=!1;hasPendingMacrotasks=!1;isStable=!0;onUnstable=new zn;onMicrotaskEmpty=new zn;onStable=new zn;onError=new zn;run(e,t,n){return e.apply(t,n)}runGuarded(e,t,n){return e.apply(t,n)}runOutsideAngular(e){return e()}runTask(e,t,n,r){return e.apply(t,n)}};function wR(i){return N0(i,"__ignore_ng_zone__")}function MR(i){return N0(i,"__scheduler_tick__")}function N0(i,e){return!Array.isArray(i)||i.length!==1?!1:i[0]?.data?.[e]===!0}var ts=class{_console=console;handleError(e){this._console.error("ERROR",e)}},zi=new Ve("",{factory:()=>{let i=ae(Et),e=ae(An),t;return n=>{i.runOutsideAngular(()=>{e.destroyed&&!t?setTimeout(()=>{throw n}):(t??=e.get(ts),t.handleError(n))})}}}),L0={provide:ws,useValue:()=>{let i=ae(ts,{optional:!0})},multi:!0};function oi(i,e){let[t,n,r]=Lg(i,e?.equal),s=t,o=s[Fi];return s.set=n,s.update=r,s.asReadonly=F0.bind(s),s}function F0(){let i=this[Fi];if(i.readonlyFn===void 0){let e=()=>this();e[Fi]=i,i.readonlyFn=e}return i.readonlyFn}var fo=class{},nl=new Ve("",{factory:()=>!0});var Gd=new Ve("");var sy=(()=>{class i{static \u0275prov=Me({token:i,providedIn:"root",factory:()=>new d_})}return i})(),d_=class{dirtyEffectCount=0;queues=new Map;add(e){this.enqueue(e),this.schedule(e)}schedule(e){e.dirty&&this.dirtyEffectCount++}remove(e){let t=e.zone,n=this.queues.get(t);n.has(e)&&(n.delete(e),e.dirty&&this.dirtyEffectCount--)}enqueue(e){let t=e.zone;this.queues.has(t)||this.queues.set(t,new Set);let n=this.queues.get(t);n.has(e)||n.add(e)}flush(){for(;this.dirtyEffectCount>0;){let e=!1;for(let[t,n]of this.queues)t===null?e||=this.flushQueue(n):e||=t.run(()=>this.flushQueue(n));e||(this.dirtyEffectCount=0)}}flushQueue(e){let t=!1;for(let n of e)n.dirty&&(this.dirtyEffectCount--,t=!0,n.run());return t}},f_=class{[Fi];constructor(e){this[Fi]=e}destroy(){this[Fi].destroy()}};function Hi(i){return Fg(i)}function jc(i){return{toString:i}.toString()}function kR(i){return typeof i=="function"}function cI(i,e,t,n){e!==null?e.applyValueToInputSignal(e,n):i[t]=n}var jd=class{previousValue;currentValue;firstChange;constructor(e,t,n){this.previousValue=e,this.currentValue=t,this.firstChange=n}isFirstChange(){return this.firstChange}},hf=(()=>{let i=()=>uI;return i.ngInherit=!0,i})();function uI(i){return i.type.prototype.ngOnChanges&&(i.setInput=VR),BR}function BR(){let i=dI(this),e=i?.current;if(e){let t=i.previous;if(t===mo)i.previous=e;else for(let n in e)t[n]=e[n];i.current=null,this.ngOnChanges(e)}}function VR(i,e,t,n,r){let s=this.declaredInputs[n],o=dI(i)||GR(i,{previous:mo,current:null}),a=o.current||(o.current={}),l=o.previous,c=l[s];a[s]=new jd(c&&c.currentValue,t,l===mo),cI(i,e,r,t)}var hI="__ngSimpleChanges__";function dI(i){return i[hI]||null}function GR(i,e){return i[hI]=e}var k0=[];var St=function(i,e=null,t){for(let n=0;n<k0.length;n++){let r=k0[n];r(i,e,t)}};function UR(i,e,t){let{ngOnChanges:n,ngOnInit:r,ngDoCheck:s}=e.type.prototype;if(n){let o=uI(e);(t.preOrderHooks??=[]).push(i,o),(t.preOrderCheckHooks??=[]).push(i,o)}r&&(t.preOrderHooks??=[]).push(0-i,r),s&&((t.preOrderHooks??=[]).push(i,s),(t.preOrderCheckHooks??=[]).push(i,s))}function zR(i,e){for(let t=e.directiveStart,n=e.directiveEnd;t<n;t++){let s=i.data[t].type.prototype,{ngAfterContentInit:o,ngAfterContentChecked:a,ngAfterViewInit:l,ngAfterViewChecked:c,ngOnDestroy:u}=s;o&&(i.contentHooks??=[]).push(-t,o),a&&((i.contentHooks??=[]).push(t,a),(i.contentCheckHooks??=[]).push(t,a)),l&&(i.viewHooks??=[]).push(-t,l),c&&((i.viewHooks??=[]).push(t,c),(i.viewCheckHooks??=[]).push(t,c)),u!=null&&(i.destroyHooks??=[]).push(t,u)}}function zd(i,e,t){fI(i,e,3,t)}function Hd(i,e,t,n){(i[qe]&3)===t&&fI(i,e,t,n)}function oy(i,e){let t=i[qe];(t&3)===e&&(t&=16383,t+=1,i[qe]=t)}function fI(i,e,t,n){let r=n!==void 0?i[_o]&65535:0,s=n??-1,o=e.length-1,a=0;for(let l=r;l<o;l++)if(typeof e[l+1]=="number"){if(a=e[l],n!=null&&a>=n)break}else e[l]<0&&(i[_o]+=65536),(a<s||s==-1)&&(HR(i,t,e,l),i[_o]=(i[_o]&4294901760)+l+2),l++}function B0(i,e){St(4,i,e);let t=Be(null);try{e.call(i)}finally{Be(t),St(5,i,e)}}function HR(i,e,t,n){let r=t[n]<0,s=t[n+1],o=r?-t[n]:t[n],a=i[o];r?i[qe]>>14<i[_o]>>16&&(i[qe]&3)===e&&(i[qe]+=16384,B0(a,s)):B0(a,s)}var rl=-1,Gc=class{factory;name;injectImpl;resolving=!1;canSeeViewProviders;multi;componentProviders;index;providerFactory;constructor(e,t,n,r){this.factory=e,this.name=r,this.canSeeViewProviders=t,this.injectImpl=n}};function $R(i){return(i.flags&8)!==0}function WR(i){return(i.flags&16)!==0}function jR(i,e,t){let n=0;for(;n<t.length;){let r=t[n];if(typeof r=="number"){if(r!==0)break;n++;let s=t[n++],o=t[n++],a=t[n++];i.setAttribute(e,o,a,s)}else{let s=r,o=t[++n];YR(s)?i.setProperty(e,s,o):i.setAttribute(e,s,o),n++}}return n}function qR(i){return i===3||i===4||i===6}function YR(i){return i.charCodeAt(0)===64}function df(i,e){if(!(e===null||e.length===0))if(i===null||i.length===0)i=e.slice();else{let t=-1;for(let n=0;n<e.length;n++){let r=e[n];typeof r=="number"?t=r:t===0||(t===-1||t===2?V0(i,t,r,null,e[++n]):V0(i,t,r,null,null))}}return i}function V0(i,e,t,n,r){let s=0,o=i.length;if(e===-1)o=-1;else for(;s<i.length;){let a=i[s++];if(typeof a=="number"){if(a===e){o=-1;break}else if(a>e){o=s-1;break}}}for(;s<i.length;){let a=i[s];if(typeof a=="number")break;if(a===t){r!==null&&(i[s+1]=r);return}s++,r!==null&&s++}o!==-1&&(i.splice(o,0,e),s=o+1),i.splice(s++,0,t),r!==null&&i.splice(s++,0,r)}function pI(i){return i!==rl}function qd(i){return i&32767}function KR(i){return i>>16}function Yd(i,e){let t=KR(i),n=e;for(;t>0;)n=n[go],t--;return n}var fy=!0;function Kd(i){let e=fy;return fy=i,e}var XR=256,mI=XR-1,gI=5,ZR=0,Ar={};function QR(i,e,t){let n;typeof t=="string"?n=t.charCodeAt(0)||0:t.hasOwnProperty(po)&&(n=t[po]),n==null&&(n=t[po]=ZR++);let r=n&mI,s=1<<r;e.data[i+(r>>gI)]|=s}function _I(i,e){let t=yI(i,e);if(t!==-1)return t;let n=e[Fe];n.firstCreatePass&&(i.injectorIndex=e.length,ay(n.data,i),ay(e,null),ay(n.blueprint,null));let r=Vy(i,e),s=i.injectorIndex;if(pI(r)){let o=qd(r),a=Yd(r,e),l=a[Fe].data;for(let c=0;c<8;c++)e[s+c]=a[o+c]|l[o+c]}return e[s+8]=r,s}function ay(i,e){i.push(0,0,0,0,0,0,0,0,e)}function yI(i,e){return i.injectorIndex===-1||i.parent&&i.parent.injectorIndex===i.injectorIndex||e[i.injectorIndex+8]===null?-1:i.injectorIndex}function Vy(i,e){if(i.parent&&i.parent.injectorIndex!==-1)return i.parent.injectorIndex;let t=0,n=null,r=e;for(;r!==null;){if(n=TI(r),n===null)return rl;if(t++,r=r[go],n.injectorIndex!==-1)return n.injectorIndex|t<<16}return rl}function JR(i,e,t){QR(i,e,t)}function vI(i,e,t){if(t&8||i!==void 0)return i;Id(e,"NodeInjector")}function bI(i,e,t,n){if(t&8&&n===void 0&&(n=null),(t&3)===0){let r=i[ns],s=Un(void 0);try{return r?r.get(e,n,t&8):T_(e,n,t&8)}finally{Un(s)}}return vI(n,e,t)}function xI(i,e,t,n=0,r){if(i!==null){if(e[qe]&2048&&!(n&2)){let o=iP(i,e,t,n,Ar);if(o!==Ar)return o}let s=CI(i,e,t,n,Ar);if(s!==Ar)return s}return bI(e,t,n,r)}function CI(i,e,t,n,r){let s=tP(t);if(typeof s=="function"){if(!Z_(e,i,n))return n&1?vI(r,t,n):bI(e,t,n,r);try{let o;if(o=s(n),o==null&&!(n&8))Id(t);else return o}finally{Q_()}}else if(typeof s=="number"){let o=null,a=yI(i,e),l=rl,c=n&1?e[yi][Gi]:null;for((a===-1||n&4)&&(l=a===-1?Vy(i,e):e[a+8],l===rl||!U0(n,!1)?a=-1:(o=e[Fe],a=qd(l),e=Yd(l,e)));a!==-1;){let u=e[Fe];if(G0(s,a,u.data)){let h=eP(a,e,t,o,n,c);if(h!==Ar)return h}l=e[a+8],l!==rl&&U0(n,e[Fe].data[a+8]===c)&&G0(s,a,e)?(o=u,a=qd(l),e=Yd(l,e)):a=-1}}return r}function eP(i,e,t,n,r,s){let o=e[Fe],a=o.data[i+8],l=n==null?bo(a)&&fy:n!=o&&(a.type&3)!==0,c=r&1&&s===a,u=$d(a,o,t,l,c);return u!==null?Xd(e,o,u,a,r):Ar}function $d(i,e,t,n,r){let s=i.providerIndexes,o=e.data,a=s&1048575,l=i.directiveStart,c=i.directiveEnd,u=s>>20,h=n?a:a+u,d=r?a+u:c;for(let f=h;f<d;f++){let p=o[f];if(f<l&&t===p||f>=l&&p.type===t)return f}if(r){let f=o[l];if(f&&xo(f)&&f.type===t)return l}return null}function Xd(i,e,t,n,r){let s=i[t],o=e.data;if(s instanceof Gc){let a=s;if(a.resolving){let f=jS(o[t]);throw C_(f)}let l=Kd(a.canSeeViewProviders);a.resolving=!0;let c=o[t].type||o[t],u,h=a.injectImpl?Un(a.injectImpl):null,d=Z_(i,n,0);try{s=i[t]=a.factory(void 0,r,o,i,n),e.firstCreatePass&&t>=n.directiveStart&&UR(t,o[t],e)}finally{h!==null&&Un(h),Kd(l),a.resolving=!1,Q_()}}return s}function tP(i){if(typeof i=="string")return i.charCodeAt(0)||0;let e=i.hasOwnProperty(po)?i[po]:void 0;return typeof e=="number"?e>=0?e&mI:nP:e}function G0(i,e,t){let n=1<<i;return!!(t[e+(i>>gI)]&n)}function U0(i,e){return!(i&2)&&!(i&1&&e)}var So=class{_tNode;_lView;constructor(e,t){this._tNode=e,this._lView=t}get(e,t,n){return xI(this._tNode,this._lView,e,uo(n),t)}};function nP(){return new So(nr(),lt())}function ff(i){return jc(()=>{let e=i.prototype.constructor,t=e[Tc]||py(e),n=Object.prototype,r=Object.getPrototypeOf(i.prototype).constructor;for(;r&&r!==n;){let s=r[Tc]||py(r);if(s&&s!==t)return s;r=Object.getPrototypeOf(r)}return s=>new s})}function py(i){return m_(i)?()=>{let e=py(si(i));return e&&e()}:Es(i)}function iP(i,e,t,n,r){let s=i,o=e;for(;s!==null&&o!==null&&o[qe]&2048&&!Za(o);){let a=CI(s,o,t,n|2,Ar);if(a!==Ar)return a;let l=s.parent;if(!l){let c=o[P_];if(c){let u=c.get(t,Ar,n);if(u!==Ar)return u}l=TI(o),o=o[go]}s=l}return r}function TI(i){let e=i[Fe],t=e.type;return t===2?e.declTNode:t===1?i[Gi]:null}function rP(){return cl(nr(),lt())}function cl(i,e){return new ul(Sr(i,e))}var ul=(()=>{class i{nativeElement;constructor(t){this.nativeElement=t}static __NG_ELEMENT_ID__=rP}return i})();function sP(i){return i instanceof ul?i.nativeElement:i}function oP(){return this._results[Symbol.iterator]()}var Zd=class{_emitDistinctChangesOnly;dirty=!0;_onDirty=void 0;_results=[];_changesDetected=!1;_changes=void 0;length=0;first=void 0;last=void 0;get changes(){return this._changes??=new Xt}constructor(e=!1){this._emitDistinctChangesOnly=e}get(e){return this._results[e]}map(e){return this._results.map(e)}filter(e){return this._results.filter(e)}find(e){return this._results.find(e)}reduce(e,t){return this._results.reduce(e,t)}forEach(e){this._results.forEach(e)}some(e){return this._results.some(e)}toArray(){return this._results.slice()}toString(){return this._results.toString()}reset(e,t){this.dirty=!1;let n=ZS(e);(this._changesDetected=!XS(this._results,n,t))&&(this._results=n,this.length=n.length,this.last=n[this.length-1],this.first=n[0])}notifyOnChanges(){this._changes!==void 0&&(this._changesDetected||!this._emitDistinctChangesOnly)&&this._changes.next(this)}onDirty(e){this._onDirty=e}setDirty(){this.dirty=!0,this._onDirty?.()}destroy(){this._changes!==void 0&&(this._changes.complete(),this._changes.unsubscribe())}[Symbol.iterator]=oP};function SI(i){return(i.flags&128)===128}var Gy=(function(i){return i[i.OnPush=0]="OnPush",i[i.Default=1]="Default",i})(Gy||{}),II=new Map,aP=0;function lP(){return aP++}function cP(i){II.set(i[Rc],i)}function my(i){II.delete(i[Rc])}var z0="__ngContext__";function sl(i,e){is(e)?(i[z0]=e[Rc],cP(e)):i[z0]=e}function EI(i){return wI(i[Xa])}function AI(i){return wI(i[Vi])}function wI(i){for(;i!==null&&!tr(i);)i=i[Vi];return i}var gy;function Uy(i){gy=i}function MI(){if(gy!==void 0)return gy;if(typeof document<"u")return document;throw new Le(210,!1)}var pf=new Ve("",{factory:()=>uP}),uP="ng";var mf=new Ve(""),qc=new Ve("",{providedIn:"platform",factory:()=>"unknown"});var gf=new Ve("",{factory:()=>MI().body?.querySelector("[ngCspNonce]")?.getAttribute("ngCspNonce")||null});var DI="r";var RI="di";var PI=!1,OI=new Ve("",{factory:()=>PI});var hP=(i,e,t,n)=>{};function dP(i,e,t,n){hP(i,e,t,n)}function zy(i){return(i.flags&32)===32}var fP=()=>null;function NI(i,e,t=!1){return fP(i,e,t)}function LI(i,e){let t=i.contentQueries;if(t!==null){let n=Be(null);try{for(let r=0;r<t.length;r+=2){let s=t[r],o=t[r+1];if(o!==-1){let a=i.data[o];Nd(s),a.contentQueries(2,e[o],o)}}}finally{Be(n)}}}function _y(i,e,t){Nd(0);let n=Be(null);try{e(i,t)}finally{Be(n)}}function FI(i,e,t){if(N_(e)){let n=Be(null);try{let r=e.directiveStart,s=e.directiveEnd;for(let o=r;o<s;o++){let a=i.data[o];if(a.contentQueries){let l=t[o];a.contentQueries(1,l,o)}}}finally{Be(n)}}}var rr=(function(i){return i[i.Emulated=0]="Emulated",i[i.None=2]="None",i[i.ShadowDom=3]="ShadowDom",i[i.ExperimentalIsolatedShadowDom=4]="ExperimentalIsolatedShadowDom",i})(rr||{});var Qd=class{changingThisBreaksApplicationSecurity;constructor(e){this.changingThisBreaksApplicationSecurity=e}toString(){return`SafeValue must use [property]=binding: ${this.changingThisBreaksApplicationSecurity} (see ${xd})`}};function Hy(i){return i instanceof Qd?i.changingThisBreaksApplicationSecurity:i}function kI(i,e){let t=BI(i);if(t!=null&&t!==e){if(t==="ResourceURL"&&e==="URL")return!0;throw new Error(`Required a safe ${e}, got a ${t} (see ${xd})`)}return t===e}function BI(i){return i instanceof Qd&&i.getTypeName()||null}var pP=/^(?!javascript:)(?:[a-z0-9+.-]+:|[^&:\/?#]*(?:[\/?#]|$))/i;function VI(i){return i=String(i),i.match(pP)?i:"unsafe:"+i}var $y=(function(i){return i[i.NONE=0]="NONE",i[i.HTML=1]="HTML",i[i.STYLE=2]="STYLE",i[i.SCRIPT=3]="SCRIPT",i[i.URL=4]="URL",i[i.RESOURCE_URL=5]="RESOURCE_URL",i})($y||{});function ss(i){let e=mP();return e?e.sanitize($y.URL,i)||"":kI(i,"URL")?Hy(i):VI(Sd(i))}function mP(){let i=lt();return i&&i[Cr].sanitizer}function GI(i){return i instanceof Function?i():i}function gP(i,e,t){let n=i.length;for(;;){let r=i.indexOf(e,t);if(r===-1)return r;if(r===0||i.charCodeAt(r-1)<=32){let s=e.length;if(r+s===n||i.charCodeAt(r+s)<=32)return r}t=r+1}}var UI="ng-template";function _P(i,e,t,n){let r=0;if(n){for(;r<e.length&&typeof e[r]=="string";r+=2)if(e[r]==="class"&&gP(e[r+1].toLowerCase(),t,0)!==-1)return!0}else if(Wy(i))return!1;if(r=e.indexOf(1,r),r>-1){let s;for(;++r<e.length&&typeof(s=e[r])=="string";)if(s.toLowerCase()===t)return!0}return!1}function Wy(i){return i.type===4&&i.value!==UI}function yP(i,e,t){let n=i.type===4&&!t?UI:i.value;return e===n}function vP(i,e,t){let n=4,r=i.attrs,s=r!==null?CP(r):0,o=!1;for(let a=0;a<e.length;a++){let l=e[a];if(typeof l=="number"){if(!o&&!ir(n)&&!ir(l))return!1;if(o&&ir(l))continue;o=!1,n=l|n&1;continue}if(!o)if(n&4){if(n=2|n&1,l!==""&&!yP(i,l,t)||l===""&&e.length===1){if(ir(n))return!1;o=!0}}else if(n&8){if(r===null||!_P(i,r,l,t)){if(ir(n))return!1;o=!0}}else{let c=e[++a],u=bP(l,r,Wy(i),t);if(u===-1){if(ir(n))return!1;o=!0;continue}if(c!==""){let h;if(u>s?h="":h=r[u+1].toLowerCase(),n&2&&c!==h){if(ir(n))return!1;o=!0}}}}return ir(n)||o}function ir(i){return(i&1)===0}function bP(i,e,t,n){if(e===null)return-1;let r=0;if(n||!t){let s=!1;for(;r<e.length;){let o=e[r];if(o===i)return r;if(o===3||o===6)s=!0;else if(o===1||o===2){let a=e[++r];for(;typeof a=="string";)a=e[++r];continue}else{if(o===4)break;if(o===0){r+=4;continue}}r+=s?1:2}return-1}else return TP(e,i)}function xP(i,e,t=!1){for(let n=0;n<e.length;n++)if(vP(i,e[n],t))return!0;return!1}function CP(i){for(let e=0;e<i.length;e++){let t=i[e];if(qR(t))return e}return i.length}function TP(i,e){let t=i.indexOf(4);if(t>-1)for(t++;t<i.length;){let n=i[t];if(typeof n=="number")return-1;if(n===e)return t;t++}return-1}function H0(i,e){return i?":not("+e.trim()+")":e}function SP(i){let e=i[0],t=1,n=2,r="",s=!1;for(;t<i.length;){let o=i[t];if(typeof o=="string")if(n&2){let a=i[++t];r+="["+o+(a.length>0?'="'+a+'"':"")+"]"}else n&8?r+="."+o:n&4&&(r+=" "+o);else r!==""&&!ir(o)&&(e+=H0(s,r),r=""),n=o,s=s||!ir(n);t++}return r!==""&&(e+=H0(s,r)),e}function IP(i){return i.map(SP).join(",")}function EP(i){let e=[],t=[],n=1,r=2;for(;n<i.length;){let s=i[n];if(typeof s=="string")r===2?s!==""&&e.push(s,i[++n]):r===8&&t.push(s);else{if(!ir(r))break;r=s}n++}return t.length&&e.push(1,...t),e}var Mr={};function AP(i,e){return i.createText(e)}function wP(i,e,t){i.setValue(e,t)}function zI(i,e,t){return i.createElement(e,t)}function Jd(i,e,t,n,r){i.insertBefore(e,t,n,r)}function HI(i,e,t){i.appendChild(e,t)}function $0(i,e,t,n,r){n!==null?Jd(i,e,t,n,r):HI(i,e,t)}function $I(i,e,t,n){i.removeChild(null,e,t,n)}function MP(i,e,t){i.setAttribute(e,"style",t)}function DP(i,e,t){t===""?i.removeAttribute(e,"class"):i.setAttribute(e,"class",t)}function WI(i,e,t){let{mergedAttrs:n,classes:r,styles:s}=t;n!==null&&jR(i,e,n),r!==null&&DP(i,e,r),s!==null&&MP(i,e,s)}function jy(i,e,t,n,r,s,o,a,l,c,u){let h=Jt+n,d=h+r,f=RP(h,d),p=typeof c=="function"?c():c;return f[Fe]={type:i,blueprint:f,template:t,queries:null,viewQuery:a,declTNode:e,data:f.slice().fill(null,h),bindingStartIndex:h,expandoStartIndex:d,hostBindingOpCodes:null,firstCreatePass:!0,firstUpdatePass:!0,staticViewQueries:!1,staticContentQueries:!1,preOrderHooks:null,preOrderCheckHooks:null,contentHooks:null,contentCheckHooks:null,viewHooks:null,viewCheckHooks:null,destroyHooks:null,cleanup:null,contentQueries:null,components:null,directiveRegistry:typeof s=="function"?s():s,pipeRegistry:typeof o=="function"?o():o,firstChild:null,schemas:l,consts:p,incompleteFirstPass:!1,ssrId:u}}function RP(i,e){let t=[];for(let n=0;n<e;n++)t.push(n<i?null:Mr);return t}function PP(i){let e=i.tView;return e===null||e.incompleteFirstPass?i.tView=jy(1,null,i.template,i.decls,i.vars,i.directiveDefs,i.pipeDefs,i.viewQuery,i.schemas,i.consts,i.id):e}function qy(i,e,t,n,r,s,o,a,l,c,u){let h=e.blueprint.slice();return h[er]=r,h[qe]=n|4|128|8|64|1024,(c!==null||i&&i[qe]&2048)&&(h[qe]|=2048),B_(h),h[Zt]=h[go]=i,h[Vt]=t,h[Cr]=o||i&&i[Cr],h[Qt]=a||i&&i[Qt],h[ns]=l||i&&i[ns]||null,h[Gi]=s,h[Rc]=lP(),h[Ya]=u,h[P_]=c,h[yi]=e.type==2?i[yi]:h,h}function OP(i,e,t){let n=Sr(e,i),r=PP(t),s=i[Cr].rendererFactory,o=Yy(i,qy(i,r,null,jI(t),n,e,null,s.createRenderer(n,t),null,null,null));return i[e.index]=o}function jI(i){let e=16;return i.signals?e=4096:i.onPush&&(e=64),e}function qI(i,e,t,n){if(t===0)return-1;let r=e.length;for(let s=0;s<t;s++)e.push(n),i.blueprint.push(n),i.data.push(null);return r}function Yy(i,e){return i[Xa]?i[R_][Vi]=e:i[Xa]=e,i[R_]=e,e}function De(i=1){YI(bi(),lt(),Ps()+i,!1)}function YI(i,e,t,n){if(!n)if((e[qe]&3)===3){let s=i.preOrderCheckHooks;s!==null&&zd(e,s,t)}else{let s=i.preOrderHooks;s!==null&&Hd(e,s,0,t)}Os(t)}var _f=(function(i){return i[i.None=0]="None",i[i.SignalBased=1]="SignalBased",i[i.HasDecoratorInputTransform=2]="HasDecoratorInputTransform",i})(_f||{});function yy(i,e,t,n){let r=Be(null);try{let[s,o,a]=i.inputs[t],l=null;(o&_f.SignalBased)!==0&&(l=e[s][Fi]),l!==null&&l.transformFn!==void 0?n=l.transformFn(n):a!==null&&(n=a.call(e,n)),i.setInput!==null?i.setInput(e,l,n,t,s):cI(e,l,s,n)}finally{Be(r)}}var wr=(function(i){return i[i.Important=1]="Important",i[i.DashCase=2]="DashCase",i})(wr||{}),NP;function Ky(i,e){return NP(i,e)}var Io=new Set,Xy=(function(i){return i[i.CHANGE_DETECTION=0]="CHANGE_DETECTION",i[i.AFTER_NEXT_RENDER=1]="AFTER_NEXT_RENDER",i})(Xy||{}),Yc=new Ve(""),W0=new Set;function Ls(i){W0.has(i)||(W0.add(i),performance?.mark?.("mark_feature_usage",{detail:{feature:i}}))}var KI=(()=>{class i{impl=null;execute(){this.impl?.execute()}static \u0275prov=Me({token:i,providedIn:"root",factory:()=>new i})}return i})();var XI=new Ve("",{factory:()=>({queue:new Set,isScheduled:!1,scheduler:null})});function ZI(i,e,t){let n=i.get(XI);if(Array.isArray(e))for(let r of e)n.queue.add(r),t?.detachedLeaveAnimationFns?.push(r);else n.queue.add(e),t?.detachedLeaveAnimationFns?.push(e);n.scheduler&&n.scheduler(i)}function LP(i,e){let t=i.get(XI);if(e.detachedLeaveAnimationFns){for(let n of e.detachedLeaveAnimationFns)t.queue.delete(n);e.detachedLeaveAnimationFns=void 0}}function FP(i,e){for(let[t,n]of e)ZI(i,n.animateFns)}function j0(i,e,t,n){let r=i?.[yo]?.enter;e!==null&&r&&r.has(t.index)&&FP(n,r)}function il(i,e,t,n,r,s,o,a){if(r!=null){let l,c=!1;tr(r)?l=r:is(r)&&(c=!0,r=r[er]);let u=Ui(r);i===0&&n!==null?(j0(a,n,s,t),o==null?HI(e,n,u):Jd(e,n,u,o||null,!0)):i===1&&n!==null?(j0(a,n,s,t),Jd(e,n,u,o||null,!0)):i===2?q0(a,s,t,h=>{$I(e,u,c,h)}):i===3&&q0(a,s,t,()=>{e.destroyNode(u)}),l!=null&&KP(e,i,t,l,s,n,o)}}function kP(i,e){QI(i,e),e[er]=null,e[Gi]=null}function BP(i,e,t,n,r,s){n[er]=r,n[Gi]=e,vf(i,n,t,1,r,s)}function QI(i,e){e[Cr].changeDetectionScheduler?.notify(9),vf(i,e,e[Qt],2,null,null)}function VP(i){let e=i[Xa];if(!e)return ly(i[Fe],i);for(;e;){let t=null;if(is(e))t=e[Xa];else{let n=e[Nt];n&&(t=n)}if(!t){for(;e&&!e[Vi]&&e!==i;)is(e)&&ly(e[Fe],e),e=e[Zt];e===null&&(e=i),is(e)&&ly(e[Fe],e),t=e&&e[Vi]}e=t}}function Zy(i,e){let t=i[vo],n=t.indexOf(e);t.splice(n,1)}function yf(i,e){if(Co(e))return;let t=e[Qt];t.destroyNode&&vf(i,e,t,3,null,null),VP(e)}function ly(i,e){if(Co(e))return;let t=Be(null);try{e[qe]&=-129,e[qe]|=256,e[vi]&&gc(e[vi]),zP(i,e),UP(i,e),e[Fe].type===1&&e[Qt].destroy();let n=e[Ds];if(n!==null&&tr(e[Zt])){n!==e[Zt]&&Zy(n,e);let r=e[Tr];r!==null&&r.detachView(i)}my(e)}finally{Be(t)}}function q0(i,e,t,n){let r=i?.[yo];if(r==null||r.leave==null||!r.leave.has(e.index))return n(!1);i&&Io.add(i),ZI(t,()=>{if(r.leave&&r.leave.has(e.index)){let o=r.leave.get(e.index),a=[];if(o){for(let l=0;l<o.animateFns.length;l++){let c=o.animateFns[l],{promise:u}=c();a.push(u)}r.detachedLeaveAnimationFns=void 0}r.running=Promise.allSettled(a),GP(i,n)}else i&&Io.delete(i),n(!1)},r)}function GP(i,e){let t=i[yo]?.running;if(t){t.then(()=>{i[yo].running=void 0,Io.delete(i),e(!0)});return}e(!1)}function UP(i,e){let t=i.cleanup,n=e[Ka];if(t!==null)for(let o=0;o<t.length-1;o+=2)if(typeof t[o]=="string"){let a=t[o+3];a>=0?n[a]():n[-a].unsubscribe(),o+=2}else{let a=n[t[o+1]];t[o].call(a)}n!==null&&(e[Ka]=null);let r=e[Jr];if(r!==null){e[Jr]=null;for(let o=0;o<r.length;o++){let a=r[o];a()}}let s=e[Pc];if(s!==null){e[Pc]=null;for(let o of s)o.destroy()}}function zP(i,e){let t;if(i!=null&&(t=i.destroyHooks)!=null)for(let n=0;n<t.length;n+=2){let r=e[t[n]];if(!(r instanceof Gc)){let s=t[n+1];if(Array.isArray(s))for(let o=0;o<s.length;o+=2){let a=r[s[o]],l=s[o+1];St(4,a,l);try{l.call(a)}finally{St(5,a,l)}}else{St(4,r,s);try{s.call(r)}finally{St(5,r,s)}}}}}function HP(i,e,t){return $P(i,e.parent,t)}function $P(i,e,t){let n=e;for(;n!==null&&n.type&168;)e=n,n=e.parent;if(n===null)return t[er];if(bo(n)){let{encapsulation:r}=i.data[n.directiveStart+n.componentOffset];if(r===rr.None||r===rr.Emulated)return null}return Sr(n,t)}function WP(i,e,t){return qP(i,e,t)}function jP(i,e,t){return i.type&40?Sr(i,t):null}var qP=jP,Y0;function Qy(i,e,t,n){let r=HP(i,n,e),s=e[Qt],o=n.parent||e[Gi],a=WP(o,n,e);if(r!=null)if(Array.isArray(t))for(let l=0;l<t.length;l++)$0(s,r,t[l],a,!1);else $0(s,r,t,a,!1);Y0!==void 0&&Y0(s,n,e,t,r)}function Bc(i,e){if(e!==null){let t=e.type;if(t&3)return Sr(e,i);if(t&4)return vy(-1,i[e.index]);if(t&8){let n=e.child;if(n!==null)return Bc(i,n);{let r=i[e.index];return tr(r)?vy(-1,r):Ui(r)}}else{if(t&128)return Bc(i,e.next);if(t&32)return Ky(e,i)()||Ui(i[e.index]);{let n=JI(i,e);if(n!==null){if(Array.isArray(n))return n[0];let r=As(i[yi]);return Bc(r,n)}else return Bc(i,e.next)}}}return null}function JI(i,e){if(e!==null){let n=i[yi][Gi],r=e.projection;return n.projection[r]}return null}function vy(i,e){let t=Nt+i+1;if(t<e.length){let n=e[t],r=n[Fe].firstChild;if(r!==null)return Bc(n,r)}return e[Rs]}function Jy(i,e,t,n,r,s,o){for(;t!=null;){let a=n[ns];if(t.type===128){t=t.next;continue}let l=n[t.index],c=t.type;if(o&&e===0&&(l&&sl(Ui(l),n),t.flags|=2),!zy(t))if(c&8)Jy(i,e,t.child,n,r,s,!1),il(e,i,a,r,l,t,s,n);else if(c&32){let u=Ky(t,n),h;for(;h=u();)il(e,i,a,r,h,t,s,n);il(e,i,a,r,l,t,s,n)}else c&16?YP(i,e,n,t,r,s):il(e,i,a,r,l,t,s,n);t=o?t.projectionNext:t.next}}function vf(i,e,t,n,r,s){Jy(t,n,i.firstChild,e,r,s,!1)}function YP(i,e,t,n,r,s){let o=t[yi],l=o[Gi].projection[n.projection];if(Array.isArray(l))for(let c=0;c<l.length;c++){let u=l[c];il(e,i,t[ns],r,u,n,s,t)}else{let c=l,u=o[Zt];SI(n)&&(c.flags|=128),Jy(i,e,c,u,r,s,!0)}}function KP(i,e,t,n,r,s,o){let a=n[Rs],l=Ui(n);a!==l&&il(e,i,t,s,a,r,o);for(let c=Nt;c<n.length;c++){let u=n[c];vf(u[Fe],u,i,e,s,a)}}function XP(i,e,t,n,r){if(e)r?i.addClass(t,n):i.removeClass(t,n);else{let s=n.indexOf("-")===-1?void 0:wr.DashCase;r==null?i.removeStyle(t,n,s):(typeof r=="string"&&r.endsWith("!important")&&(r=r.slice(0,-10),s|=wr.Important),i.setStyle(t,n,r,s))}}function eE(i,e,t,n,r){let s=Ps(),o=n&2;try{Os(-1),o&&e.length>Jt&&YI(i,e,Jt,!1),St(o?2:0,r,t),t(n,r)}finally{Os(s),St(o?3:1,r,t)}}function tE(i,e,t){tO(i,e,t),(t.flags&64)===64&&nO(i,e,t)}function ev(i,e,t=Sr){let n=e.localNames;if(n!==null){let r=e.index+1;for(let s=0;s<n.length;s+=2){let o=n[s+1],a=o===-1?t(e,i):i[o];i[r++]=a}}}function ZP(i,e,t,n){let s=n.get(OI,PI)||t===rr.ShadowDom||t===rr.ExperimentalIsolatedShadowDom,o=i.selectRootElement(e,s);return QP(o),o}function QP(i){JP(i)}var JP=()=>null;function eO(i,e,t,n,r,s){if(i.type&3){let o=Sr(i,e);n=s!=null?s(n,i.value||"",t):n,r.setProperty(o,t,n)}else i.type&12}function tO(i,e,t){let n=t.directiveStart,r=t.directiveEnd;bo(t)&&OP(e,t,i.data[n+t.componentOffset]),i.firstCreatePass||_I(t,e);let s=t.initialInputs;for(let o=n;o<r;o++){let a=i.data[o],l=Xd(e,i,o,t);if(sl(l,e),s!==null&&sO(e,o-n,l,a,t,s),xo(a)){let c=Ir(t.index,e);c[Vt]=Xd(e,i,o,t)}}}function nO(i,e,t){let n=t.directiveStart,r=t.directiveEnd,s=t.index,o=I0();try{Os(s);for(let a=n;a<r;a++){let l=i.data[a],c=e[a];Od(a),(l.hostBindings!==null||l.hostVars!==0||l.hostAttrs!==null)&&iO(l,c)}}finally{Os(-1),Od(o)}}function iO(i,e){i.hostBindings!==null&&i.hostBindings(1,e)}function rO(i,e){let t=i.directiveRegistry,n=null;if(t)for(let r=0;r<t.length;r++){let s=t[r];xP(e,s.selectors,!1)&&(n??=[],xo(s)?n.unshift(s):n.push(s))}return n}function sO(i,e,t,n,r,s){let o=s[e];if(o!==null)for(let a=0;a<o.length;a+=2){let l=o[a],c=o[a+1];yy(n,t,l,c)}}function nE(i,e,t,n,r){let s=Jt+t,o=e[Fe],a=r(o,e,i,n,t);e[s]=a,el(i,!0);let l=i.type===2;return l?(WI(e[Qt],a,i),(p0()===0||Dd(i))&&sl(a,e),m0()):sl(a,e),Bd()&&(!l||!zy(i))&&Qy(o,e,a,i),i}function iE(i){let e=i;return q_()?v0():(e=e.parent,el(e,!1)),e}function oO(i,e){let t=i[ns];if(!t)return;let n;try{n=t.get(zi,null)}catch{n=null}n?.(e)}function rE(i,e,t,n,r){let s=i.inputs?.[n],o=i.hostDirectiveInputs?.[n],a=!1;if(o)for(let l=0;l<o.length;l+=2){let c=o[l],u=o[l+1],h=e.data[c];yy(h,t[c],u,r),a=!0}if(s)for(let l of s){let c=t[l],u=e.data[l];yy(u,c,n,r),a=!0}return a}function aO(i,e){let t=Ir(e,i),n=t[Fe];lO(n,t);let r=t[er];r!==null&&t[Ya]===null&&(t[Ya]=NI(r,t[ns])),St(18),tv(n,t,t[Vt]),St(19,t[Vt])}function lO(i,e){for(let t=e.length;t<i.blueprint.length;t++)e.push(i.blueprint[t])}function tv(i,e,t){Ld(e);try{let n=i.viewQuery;n!==null&&_y(1,n,t);let r=i.template;r!==null&&eE(i,e,r,1,t),i.firstCreatePass&&(i.firstCreatePass=!1),e[Tr]?.finishViewCreation(i),i.staticContentQueries&&LI(i,e),i.staticViewQueries&&_y(2,i.viewQuery,t);let s=i.components;s!==null&&cO(e,s)}catch(n){throw i.firstCreatePass&&(i.incompleteFirstPass=!0,i.firstCreatePass=!1),n}finally{e[qe]&=-5,Fd()}}function cO(i,e){for(let t=0;t<e.length;t++)aO(i,e[t])}function bf(i,e,t,n){let r=Be(null);try{let s=e.tView,a=i[qe]&4096?4096:16,l=qy(i,s,t,a,null,e,null,null,n?.injector??null,n?.embeddedViewInjector??null,n?.dehydratedView??null),c=i[e.index];l[Ds]=c;let u=i[Tr];return u!==null&&(l[Tr]=u.createEmbeddedView(s)),tv(s,l,t),l}finally{Be(r)}}function Uc(i,e){return!e||e.firstChild===null||SI(i)}function zc(i,e,t,n,r=!1){for(;t!==null;){if(t.type===128){t=r?t.projectionNext:t.next;continue}let s=e[t.index];s!==null&&n.push(Ui(s)),tr(s)&&sE(s,n);let o=t.type;if(o&8)zc(i,e,t.child,n);else if(o&32){let a=Ky(t,e),l;for(;l=a();)n.push(l)}else if(o&16){let a=JI(e,t);if(Array.isArray(a))n.push(...a);else{let l=As(e[yi]);zc(l[Fe],l,a,n,!0)}}t=r?t.projectionNext:t.next}return n}function sE(i,e){for(let t=Nt;t<i.length;t++){let n=i[t],r=n[Fe].firstChild;r!==null&&zc(n[Fe],n,r,e)}i[Rs]!==i[er]&&e.push(i[Rs])}function oE(i){if(i[Md]!==null){for(let e of i[Md])e.impl.addSequence(e);i[Md].length=0}}var aE=[];function uO(i){return i[vi]??hO(i)}function hO(i){let e=aE.pop()??Object.create(fO);return e.lView=i,e}function dO(i){i.lView[vi]!==i&&(i.lView=null,aE.push(i))}var fO=ct(K({},Gh),{consumerIsAlwaysLive:!0,kind:"template",consumerMarkedDirty:i=>{Fc(i.lView)},consumerOnSignalRead(){this.lView[vi]=this}});function pO(i){let e=i[vi]??Object.create(mO);return e.lView=i,e}var mO=ct(K({},Gh),{consumerIsAlwaysLive:!0,kind:"template",consumerMarkedDirty:i=>{let e=As(i.lView);for(;e&&!lE(e[Fe]);)e=As(e);e&&V_(e)},consumerOnSignalRead(){this.lView[vi]=this}});function lE(i){return i.type!==2}function cE(i){if(i[Pc]===null)return;let e=!0;for(;e;){let t=!1;for(let n of i[Pc])n.dirty&&(t=!0,n.zone===null||Zone.current===n.zone?n.run():n.zone.run(()=>n.run()));e=t&&!!(i[qe]&8192)}}var gO=100;function uE(i,e=0){let n=i[Cr].rendererFactory,r=!1;r||n.begin?.();try{_O(i,e)}finally{r||n.end?.()}}function _O(i,e){let t=Y_();try{K_(!0),by(i,e);let n=0;for(;Lc(i);){if(n===gO)throw new Le(103,!1);n++,by(i,1)}}finally{K_(t)}}function yO(i,e,t,n){if(Co(e))return;let r=e[qe],s=!1,o=!1;Ld(e);let a=!0,l=null,c=null;s||(lE(i)?(c=uO(e),l=zh(c)):Vh()===null?(a=!1,c=pO(e),l=zh(c)):e[vi]&&(gc(e[vi]),e[vi]=null));try{B_(e),x0(i.bindingStartIndex),t!==null&&eE(i,e,t,2,n);let u=(r&3)===3;if(!s)if(u){let f=i.preOrderCheckHooks;f!==null&&zd(e,f,null)}else{let f=i.preOrderHooks;f!==null&&Hd(e,f,0,null),oy(e,0)}if(o||vO(e),cE(e),hE(e,0),i.contentQueries!==null&&LI(i,e),!s)if(u){let f=i.contentCheckHooks;f!==null&&zd(e,f)}else{let f=i.contentHooks;f!==null&&Hd(e,f,1),oy(e,1)}xO(i,e);let h=i.components;h!==null&&fE(e,h,0);let d=i.viewQuery;if(d!==null&&_y(2,d,n),!s)if(u){let f=i.viewCheckHooks;f!==null&&zd(e,f)}else{let f=i.viewHooks;f!==null&&Hd(e,f,2),oy(e,2)}if(i.firstUpdatePass===!0&&(i.firstUpdatePass=!1),e[wd]){for(let f of e[wd])f();e[wd]=null}s||(oE(e),e[qe]&=-73)}catch(u){throw s||Fc(e),u}finally{c!==null&&(Pg(c,l),a&&dO(c)),Fd()}}function hE(i,e){for(let t=EI(i);t!==null;t=AI(t))for(let n=Nt;n<t.length;n++){let r=t[n];dE(r,e)}}function vO(i){for(let e=EI(i);e!==null;e=AI(e)){if(!(e[qe]&2))continue;let t=e[vo];for(let n=0;n<t.length;n++){let r=t[n];V_(r)}}}function bO(i,e,t){St(18);let n=Ir(e,i);dE(n,t),St(19,n[Vt])}function dE(i,e){Rd(i)&&by(i,e)}function by(i,e){let n=i[Fe],r=i[qe],s=i[vi],o=!!(e===0&&r&16);if(o||=!!(r&64&&e===0),o||=!!(r&1024),o||=!!(s?.dirty&&Hh(s)),o||=!1,s&&(s.dirty=!1),i[qe]&=-9217,o)yO(n,i,n.template,i[Vt]);else if(r&8192){let a=Be(null);try{cE(i),hE(i,1);let l=n.components;l!==null&&fE(i,l,1),oE(i)}finally{Be(a)}}}function fE(i,e,t){for(let n=0;n<e.length;n++)bO(i,e[n],t)}function xO(i,e){let t=i.hostBindingOpCodes;if(t!==null)try{for(let n=0;n<t.length;n++){let r=t[n];if(r<0)Os(~r);else{let s=r,o=t[++n],a=t[++n];S0(o,s);let l=e[s];St(24,l),a(2,l),St(25,l)}}}finally{Os(-1)}}function nv(i,e){let t=Y_()?64:1088;for(i[Cr].changeDetectionScheduler?.notify(e);i;){i[qe]|=t;let n=As(i);if(Za(i)&&!n)return i;i=n}return null}function pE(i,e,t,n){return[i,!0,0,e,null,n,null,t,null,null]}function mE(i,e){let t=Nt+e;if(t<i.length)return i[t]}function xf(i,e,t,n=!0){let r=e[Fe];if(CO(r,e,i,t),n){let o=vy(t,i),a=e[Qt],l=a.parentNode(i[Rs]);l!==null&&BP(r,i[Gi],a,e,l,o)}let s=e[Ya];s!==null&&s.firstChild!==null&&(s.firstChild=null)}function gE(i,e){let t=Hc(i,e);return t!==void 0&&yf(t[Fe],t),t}function Hc(i,e){if(i.length<=Nt)return;let t=Nt+e,n=i[t];if(n){let r=n[Ds];r!==null&&r!==i&&Zy(r,n),e>0&&(i[t-1][Vi]=n[Vi]);let s=wc(i,Nt+e);kP(n[Fe],n);let o=s[Tr];o!==null&&o.detachView(s[Fe]),n[Zt]=null,n[Vi]=null,n[qe]&=-129}return n}function CO(i,e,t,n){let r=Nt+n,s=t.length;n>0&&(t[r-1][Vi]=e),n<s-Nt?(e[Vi]=t[r],S_(t,Nt+n,e)):(t.push(e),e[Vi]=null),e[Zt]=t;let o=e[Ds];o!==null&&t!==o&&_E(o,e);let a=e[Tr];a!==null&&a.insertView(i),Pd(e),e[qe]|=128}function _E(i,e){let t=i[vo],n=e[Zt];if(is(n))i[qe]|=2;else{let r=n[Zt][yi];e[yi]!==r&&(i[qe]|=2)}t===null?i[vo]=[e]:t.push(e)}var Ns=class{_lView;_cdRefInjectingView;_appRef=null;_attachedToViewContainer=!1;exhaustive;get rootNodes(){let e=this._lView,t=e[Fe];return zc(t,e,t.firstChild,[])}constructor(e,t){this._lView=e,this._cdRefInjectingView=t}get context(){return this._lView[Vt]}set context(e){this._lView[Vt]=e}get destroyed(){return Co(this._lView)}destroy(){if(this._appRef)this._appRef.detachView(this);else if(this._attachedToViewContainer){let e=this._lView[Zt];if(tr(e)){let t=e[Oc],n=t?t.indexOf(this):-1;n>-1&&(Hc(e,n),wc(t,n))}this._attachedToViewContainer=!1}yf(this._lView[Fe],this._lView)}onDestroy(e){G_(this._lView,e)}markForCheck(){nv(this._cdRefInjectingView||this._lView,4)}detach(){this._lView[qe]&=-129}reattach(){Pd(this._lView),this._lView[qe]|=128}detectChanges(){this._lView[qe]|=1024,uE(this._lView)}checkNoChanges(){}attachToViewContainerRef(){if(this._appRef)throw new Le(902,!1);this._attachedToViewContainer=!0}detachFromAppRef(){this._appRef=null;let e=Za(this._lView),t=this._lView[Ds];t!==null&&!e&&Zy(t,this._lView),QI(this._lView[Fe],this._lView)}attachToAppRef(e){if(this._attachedToViewContainer)throw new Le(902,!1);this._appRef=e;let t=Za(this._lView),n=this._lView[Ds];n!==null&&!t&&_E(n,this._lView),Pd(this._lView)}};var ol=(()=>{class i{_declarationLView;_declarationTContainer;elementRef;static __NG_ELEMENT_ID__=TO;constructor(t,n,r){this._declarationLView=t,this._declarationTContainer=n,this.elementRef=r}get ssrId(){return this._declarationTContainer.tView?.ssrId||null}createEmbeddedView(t,n){return this.createEmbeddedViewImpl(t,n)}createEmbeddedViewImpl(t,n,r){let s=bf(this._declarationLView,this._declarationTContainer,t,{embeddedViewInjector:n,dehydratedView:r});return new Ns(s)}}return i})();function TO(){return iv(nr(),lt())}function iv(i,e){return i.type&4?new ol(e,i,cl(i,e)):null}function Cf(i,e,t,n,r){let s=i.data[e];if(s===null)s=SO(i,e,t,n,r),T0()&&(s.flags|=32);else if(s.type&64){s.type=t,s.value=n,s.attrs=r;let o=y0();s.injectorIndex=o===null?-1:o.injectorIndex}return el(s,!0),s}function SO(i,e,t,n,r){let s=j_(),o=q_(),a=o?s:s&&s.parent,l=i.data[e]=EO(i,a,t,e,n,r);return IO(i,l,s,o),l}function IO(i,e,t,n){i.firstChild===null&&(i.firstChild=e),t!==null&&(n?t.child==null&&e.parent!==null&&(t.child=e):t.next===null&&(t.next=e,e.prev=t))}function EO(i,e,t,n,r,s){let o=e?e.injectorIndex:-1,a=0;return _0()&&(a|=128),{type:t,index:n,insertBeforeIndex:null,injectorIndex:o,directiveStart:-1,directiveEnd:-1,directiveStylingLast:-1,componentOffset:-1,propertyBindings:null,flags:a,providerIndexes:0,value:r,attrs:s,mergedAttrs:null,localNames:null,initialInputs:null,inputs:null,hostDirectiveInputs:null,outputs:null,hostDirectiveOutputs:null,directiveToIndex:null,tView:null,next:null,prev:null,projectionNext:null,child:null,parent:e,projection:null,styles:null,stylesWithoutHost:null,residualStyles:void 0,classes:null,classesWithoutHost:null,residualClasses:void 0,classBindings:0,styleBindings:0}}function AO(i){let e=i[O_]??[],n=i[Zt][Qt],r=[];for(let s of e)s.data[RI]!==void 0?r.push(s):wO(s,n);i[O_]=r}function wO(i,e){let t=0,n=i.firstChild;if(n){let r=i.data[DI];for(;t<r;){let s=n.nextSibling;$I(e,n,!1),n=s,t++}}}var MO=()=>null,DO=()=>null;function xy(i,e){return MO(i,e)}function yE(i,e,t){return DO(i,e,t)}var vE=class{},Tf=class{},Cy=class{resolveComponentFactory(e){throw new Le(917,!1)}},Kc=class{static NULL=new Cy},Eo=class{};var bE=(()=>{class i{static \u0275prov=Me({token:i,providedIn:"root",factory:()=>null})}return i})();var Wd={},Ty=class{injector;parentInjector;constructor(e,t){this.injector=e,this.parentInjector=t}get(e,t,n){let r=this.injector.get(e,Wd,n);return r!==Wd||t===Wd?r:this.parentInjector.get(e,t,n)}};function ef(i,e,t){let n=t?i.styles:null,r=t?i.classes:null,s=0;if(e!==null)for(let o=0;o<e.length;o++){let a=e[o];if(typeof a=="number")s=a;else if(s==1)r=p_(r,a);else if(s==2){let l=a,c=e[++o];n=p_(n,l+": "+c+";")}}t?i.styles=n:i.stylesWithoutHost=n,t?i.classes=r:i.classesWithoutHost=r}function Wt(i,e=0){let t=lt();if(t===null)return je(i,e);let n=nr();return xI(n,t,si(i),e)}function RO(i,e,t,n,r){let s=n===null?null:{"":-1},o=r(i,t);if(o!==null){let a=o,l=null,c=null;for(let u of o)if(u.resolveHostDirectives!==null){[a,l,c]=u.resolveHostDirectives(o);break}NO(i,e,t,a,s,l,c)}s!==null&&n!==null&&PO(t,n,s)}function PO(i,e,t){let n=i.localNames=[];for(let r=0;r<e.length;r+=2){let s=t[e[r+1]];if(s==null)throw new Le(-301,!1);n.push(e[r],s)}}function OO(i,e,t){e.componentOffset=t,(i.components??=[]).push(e.index)}function NO(i,e,t,n,r,s,o){let a=n.length,l=!1;for(let d=0;d<a;d++){let f=n[d];!l&&xo(f)&&(l=!0,OO(i,t,d)),JR(_I(t,e),i,f.type)}GO(t,i.data.length,a);for(let d=0;d<a;d++){let f=n[d];f.providersResolver&&f.providersResolver(f)}let c=!1,u=!1,h=qI(i,e,a,null);a>0&&(t.directiveToIndex=new Map);for(let d=0;d<a;d++){let f=n[d];if(t.mergedAttrs=df(t.mergedAttrs,f.hostAttrs),FO(i,t,e,h,f),VO(h,f,r),o!==null&&o.has(f)){let[g,_]=o.get(f);t.directiveToIndex.set(f.type,[h,g+t.directiveStart,_+t.directiveStart])}else(s===null||!s.has(f))&&t.directiveToIndex.set(f.type,h);f.contentQueries!==null&&(t.flags|=4),(f.hostBindings!==null||f.hostAttrs!==null||f.hostVars!==0)&&(t.flags|=64);let p=f.type.prototype;!c&&(p.ngOnChanges||p.ngOnInit||p.ngDoCheck)&&((i.preOrderHooks??=[]).push(t.index),c=!0),!u&&(p.ngOnChanges||p.ngDoCheck)&&((i.preOrderCheckHooks??=[]).push(t.index),u=!0),h++}LO(i,t,s)}function LO(i,e,t){for(let n=e.directiveStart;n<e.directiveEnd;n++){let r=i.data[n];if(t===null||!t.has(r))K0(0,e,r,n),K0(1,e,r,n),Z0(e,n,!1);else{let s=t.get(r);X0(0,e,s,n),X0(1,e,s,n),Z0(e,n,!0)}}}function K0(i,e,t,n){let r=i===0?t.inputs:t.outputs;for(let s in r)if(r.hasOwnProperty(s)){let o;i===0?o=e.inputs??={}:o=e.outputs??={},o[s]??=[],o[s].push(n),xE(e,s)}}function X0(i,e,t,n){let r=i===0?t.inputs:t.outputs;for(let s in r)if(r.hasOwnProperty(s)){let o=r[s],a;i===0?a=e.hostDirectiveInputs??={}:a=e.hostDirectiveOutputs??={},a[o]??=[],a[o].push(n,s),xE(e,o)}}function xE(i,e){e==="class"?i.flags|=8:e==="style"&&(i.flags|=16)}function Z0(i,e,t){let{attrs:n,inputs:r,hostDirectiveInputs:s}=i;if(n===null||!t&&r===null||t&&s===null||Wy(i)){i.initialInputs??=[],i.initialInputs.push(null);return}let o=null,a=0;for(;a<n.length;){let l=n[a];if(l===0){a+=4;continue}else if(l===5){a+=2;continue}else if(typeof l=="number")break;if(!t&&r.hasOwnProperty(l)){let c=r[l];for(let u of c)if(u===e){o??=[],o.push(l,n[a+1]);break}}else if(t&&s.hasOwnProperty(l)){let c=s[l];for(let u=0;u<c.length;u+=2)if(c[u]===e){o??=[],o.push(c[u+1],n[a+1]);break}}a+=2}i.initialInputs??=[],i.initialInputs.push(o)}function FO(i,e,t,n,r){i.data[n]=r;let s=r.factory||(r.factory=Es(r.type,!0)),o=new Gc(s,xo(r),Wt,null);i.blueprint[n]=o,t[n]=o,kO(i,e,n,qI(i,t,r.hostVars,Mr),r)}function kO(i,e,t,n,r){let s=r.hostBindings;if(s){let o=i.hostBindingOpCodes;o===null&&(o=i.hostBindingOpCodes=[]);let a=~e.index;BO(o)!=a&&o.push(a),o.push(t,n,s)}}function BO(i){let e=i.length;for(;e>0;){let t=i[--e];if(typeof t=="number"&&t<0)return t}return 0}function VO(i,e,t){if(t){if(e.exportAs)for(let n=0;n<e.exportAs.length;n++)t[e.exportAs[n]]=i;xo(e)&&(t[""]=i)}}function GO(i,e,t){i.flags|=1,i.directiveStart=e,i.directiveEnd=e+t,i.providerIndexes=e}function CE(i,e,t,n,r,s,o,a){let l=e[Fe],c=l.consts,u=Er(c,o),h=Cf(l,i,t,n,u);return s&&RO(l,e,h,Er(c,a),r),h.mergedAttrs=df(h.mergedAttrs,h.attrs),h.attrs!==null&&ef(h,h.attrs,!1),h.mergedAttrs!==null&&ef(h,h.mergedAttrs,!0),l.queries!==null&&l.queries.elementStart(l,h),h}function TE(i,e){zR(i,e),N_(e)&&i.queries.elementEnd(e)}function UO(i,e,t,n,r,s){let o=e.consts,a=Er(o,r),l=Cf(e,i,t,n,a);if(l.mergedAttrs=df(l.mergedAttrs,l.attrs),s!=null){let c=Er(o,s);l.localNames=[];for(let u=0;u<c.length;u+=2)l.localNames.push(c[u],-1)}return l.attrs!==null&&ef(l,l.attrs,!1),l.mergedAttrs!==null&&ef(l,l.mergedAttrs,!0),e.queries!==null&&e.queries.elementStart(e,l),l}function zO(i,e,t){return i[e]=t}function hl(i,e,t){if(t===Mr)return!1;let n=i[e];return Object.is(n,t)?!1:(i[e]=t,!0)}function HO(i,e,t){return function n(r){let s=bo(i)?Ir(i.index,e):e;nv(s,5);let o=e[Vt],a=Q0(e,o,t,r),l=n.__ngNextListenerFn__;for(;l;)a=Q0(e,o,l,r)&&a,l=l.__ngNextListenerFn__;return a}}function Q0(i,e,t,n){let r=Be(null);try{return St(6,e,t),t(n)!==!1}catch(s){return oO(i,s),!1}finally{St(7,e,t),Be(r)}}function $O(i,e,t,n,r,s,o,a){let l=Dd(i),c=!1,u=null;if(!n&&l&&(u=jO(e,t,s,i.index)),u!==null){let h=u.__ngLastListenerFn__||u;h.__ngNextListenerFn__=o,u.__ngLastListenerFn__=o,c=!0}else{let h=Sr(i,t),d=n?n(h):h;dP(t,d,s,a);let f=r.listen(d,s,a);if(!WO(s)){let p=n?g=>n(Ui(g[i.index])):i.index;qO(p,e,t,s,a,f,!1)}}return c}function WO(i){return i.startsWith("animation")||i.startsWith("transition")}function jO(i,e,t,n){let r=i.cleanup;if(r!=null)for(let s=0;s<r.length-1;s+=2){let o=r[s];if(o===t&&r[s+1]===n){let a=e[Ka],l=r[s+2];return a&&a.length>l?a[l]:null}typeof o=="string"&&(s+=2)}return null}function qO(i,e,t,n,r,s,o){let a=e.firstCreatePass?z_(e):null,l=U_(t),c=l.length;l.push(r,s),a&&a.push(n,i,c,(c+1)*(o?-1:1))}var Sy=Symbol("BINDING");var tf=class extends Kc{ngModule;constructor(e){super(),this.ngModule=e}resolveComponentFactory(e){let t=Ms(e);return new al(t,this.ngModule)}};function YO(i){return Object.keys(i).map(e=>{let[t,n,r]=i[e],s={propName:t,templateName:e,isSignal:(n&_f.SignalBased)!==0};return r&&(s.transform=r),s})}function KO(i){return Object.keys(i).map(e=>({propName:i[e],templateName:e}))}function XO(i,e,t){let n=e instanceof An?e:e?.injector;return n&&i.getStandaloneInjector!==null&&(n=i.getStandaloneInjector(n)||n),n?new Ty(t,n):t}function ZO(i){let e=i.get(Eo,null);if(e===null)throw new Le(407,!1);let t=i.get(bE,null),n=i.get(fo,null);return{rendererFactory:e,sanitizer:t,changeDetectionScheduler:n,ngReflect:!1}}function QO(i,e){let t=SE(i);return zI(e,t,t==="svg"?L_:t==="math"?a0:null)}function SE(i){return(i.selectors[0][0]||"div").toLowerCase()}var al=class extends Tf{componentDef;ngModule;selector;componentType;ngContentSelectors;isBoundToModule;cachedInputs=null;cachedOutputs=null;get inputs(){return this.cachedInputs??=YO(this.componentDef.inputs),this.cachedInputs}get outputs(){return this.cachedOutputs??=KO(this.componentDef.outputs),this.cachedOutputs}constructor(e,t){super(),this.componentDef=e,this.ngModule=t,this.componentType=e.type,this.selector=IP(e.selectors),this.ngContentSelectors=e.ngContentSelectors??[],this.isBoundToModule=!!t}create(e,t,n,r,s,o){St(22);let a=Be(null);try{let l=this.componentDef,c=JO(n,l,o,s),u=XO(l,r||this.ngModule,e),h=ZO(u),d=h.rendererFactory.createRenderer(null,l),f=n?ZP(d,n,l.encapsulation,u):QO(l,d),p=o?.some(J0)||s?.some(y=>typeof y!="function"&&y.bindings.some(J0)),g=qy(null,c,null,512|jI(l),null,null,h,d,u,null,NI(f,u,!0));g[Jt]=f,Ld(g);let _=null;try{let y=CE(Jt,g,2,"#host",()=>c.directiveRegistry,!0,0);WI(d,f,y),sl(f,g),tE(c,g,y),FI(c,y,g),TE(c,y),t!==void 0&&t1(y,this.ngContentSelectors,t),_=Ir(y.index,g),g[Vt]=_[Vt],tv(c,g,null)}catch(y){throw _!==null&&my(_),my(g),y}finally{St(23),Fd()}return new nf(this.componentType,g,!!p)}finally{Be(a)}}};function JO(i,e,t,n){let r=i?["ng-version","21.0.0"]:EP(e.selectors[0]),s=null,o=null,a=0;if(t)for(let u of t)a+=u[Sy].requiredVars,u.create&&(u.targetIdx=0,(s??=[]).push(u)),u.update&&(u.targetIdx=0,(o??=[]).push(u));if(n)for(let u=0;u<n.length;u++){let h=n[u];if(typeof h!="function")for(let d of h.bindings){a+=d[Sy].requiredVars;let f=u+1;d.create&&(d.targetIdx=f,(s??=[]).push(d)),d.update&&(d.targetIdx=f,(o??=[]).push(d))}}let l=[e];if(n)for(let u of n){let h=typeof u=="function"?u:u.type,d=w_(h);l.push(d)}return jy(0,null,e1(s,o),1,a,l,null,null,null,[r],null)}function e1(i,e){return!i&&!e?null:t=>{if(t&1&&i)for(let n of i)n.create();if(t&2&&e)for(let n of e)n.update()}}function J0(i){let e=i[Sy].kind;return e==="input"||e==="twoWay"}var nf=class extends vE{_rootLView;_hasInputBindings;instance;hostView;changeDetectorRef;componentType;location;previousInputValues=null;_tNode;constructor(e,t,n){super(),this._rootLView=t,this._hasInputBindings=n,this._tNode=Nc(t[Fe],Jt),this.location=cl(this._tNode,t),this.instance=Ir(this._tNode.index,t)[Vt],this.hostView=this.changeDetectorRef=new Ns(t,void 0),this.componentType=e}setInput(e,t){this._hasInputBindings;let n=this._tNode;if(this.previousInputValues??=new Map,this.previousInputValues.has(e)&&Object.is(this.previousInputValues.get(e),t))return;let r=this._rootLView,s=rE(n,r[Fe],r,e,t);this.previousInputValues.set(e,t);let o=Ir(n.index,r);nv(o,1)}get injector(){return new So(this._tNode,this._rootLView)}destroy(){this.hostView.destroy()}onDestroy(e){this.hostView.onDestroy(e)}};function t1(i,e,t){let n=i.projection=[];for(let r=0;r<e.length;r++){let s=t[r];n.push(s!=null&&s.length?Array.from(s):null)}}var Mo=(()=>{class i{static __NG_ELEMENT_ID__=n1}return i})();function n1(){let i=nr();return EE(i,lt())}var i1=Mo,IE=class extends i1{_lContainer;_hostTNode;_hostLView;constructor(e,t,n){super(),this._lContainer=e,this._hostTNode=t,this._hostLView=n}get element(){return cl(this._hostTNode,this._hostLView)}get injector(){return new So(this._hostTNode,this._hostLView)}get parentInjector(){let e=Vy(this._hostTNode,this._hostLView);if(pI(e)){let t=Yd(e,this._hostLView),n=qd(e),r=t[Fe].data[n+8];return new So(r,t)}else return new So(null,this._hostLView)}clear(){for(;this.length>0;)this.remove(this.length-1)}get(e){let t=eI(this._lContainer);return t!==null&&t[e]||null}get length(){return this._lContainer.length-Nt}createEmbeddedView(e,t,n){let r,s;typeof n=="number"?r=n:n!=null&&(r=n.index,s=n.injector);let o=xy(this._lContainer,e.ssrId),a=e.createEmbeddedViewImpl(t||{},s,o);return this.insertImpl(a,r,Uc(this._hostTNode,o)),a}createComponent(e,t,n,r,s,o,a){let l=e&&!kR(e),c;if(l)c=t;else{let _=t||{};c=_.index,n=_.injector,r=_.projectableNodes,s=_.environmentInjector||_.ngModuleRef,o=_.directives,a=_.bindings}let u=l?e:new al(Ms(e)),h=n||this.parentInjector;if(!s&&u.ngModule==null){let y=(l?h:this.parentInjector).get(An,null);y&&(s=y)}let d=Ms(u.componentType??{}),f=xy(this._lContainer,d?.id??null),p=f?.firstChild??null,g=u.create(h,r,p,s,o,a);return this.insertImpl(g.hostView,c,Uc(this._hostTNode,f)),g}insert(e,t){return this.insertImpl(e,t,!0)}insertImpl(e,t,n){let r=e._lView;if(u0(r)){let a=this.indexOf(e);if(a!==-1)this.detach(a);else{let l=r[Zt],c=new IE(l,l[Gi],l[Zt]);c.detach(c.indexOf(e))}}let s=this._adjustIndex(t),o=this._lContainer;return xf(o,r,s,n),e.attachToViewContainerRef(),S_(cy(o),s,e),e}move(e,t){return this.insert(e,t)}indexOf(e){let t=eI(this._lContainer);return t!==null?t.indexOf(e):-1}remove(e){let t=this._adjustIndex(e,-1),n=Hc(this._lContainer,t);n&&(wc(cy(this._lContainer),t),yf(n[Fe],n))}detach(e){let t=this._adjustIndex(e,-1),n=Hc(this._lContainer,t);return n&&wc(cy(this._lContainer),t)!=null?new Ns(n):null}_adjustIndex(e,t=0){return e??this.length+t}};function eI(i){return i[Oc]}function cy(i){return i[Oc]||(i[Oc]=[])}function EE(i,e){let t,n=e[i.index];return tr(n)?t=n:(t=pE(n,e,null,i),e[i.index]=t,Yy(e,t)),s1(t,e,i,n),new IE(t,i,e)}function r1(i,e){let t=i[Qt],n=t.createComment(""),r=Sr(e,i),s=t.parentNode(r);return Jd(t,s,n,t.nextSibling(r),!1),n}var s1=l1,o1=()=>!1;function a1(i,e,t){return o1(i,e,t)}function l1(i,e,t,n){if(i[Rs])return;let r;t.type&8?r=Ui(n):r=r1(e,t),i[Rs]=r}var Iy=class i{queryList;matches=null;constructor(e){this.queryList=e}clone(){return new i(this.queryList)}setDirty(){this.queryList.setDirty()}},Ey=class i{queries;constructor(e=[]){this.queries=e}createEmbeddedView(e){let t=e.queries;if(t!==null){let n=e.contentQueries!==null?e.contentQueries[0]:t.length,r=[];for(let s=0;s<n;s++){let o=t.getByIndex(s),a=this.queries[o.indexInDeclarationView];r.push(a.clone())}return new i(r)}return null}insertView(e){this.dirtyQueriesWithMatches(e)}detachView(e){this.dirtyQueriesWithMatches(e)}finishViewCreation(e){this.dirtyQueriesWithMatches(e)}dirtyQueriesWithMatches(e){for(let t=0;t<this.queries.length;t++)rv(e,t).matches!==null&&this.queries[t].setDirty()}},Ay=class{flags;read;predicate;constructor(e,t,n=null){this.flags=t,this.read=n,typeof e=="string"?this.predicate=g1(e):this.predicate=e}},wy=class i{queries;constructor(e=[]){this.queries=e}elementStart(e,t){for(let n=0;n<this.queries.length;n++)this.queries[n].elementStart(e,t)}elementEnd(e){for(let t=0;t<this.queries.length;t++)this.queries[t].elementEnd(e)}embeddedTView(e){let t=null;for(let n=0;n<this.length;n++){let r=t!==null?t.length:0,s=this.getByIndex(n).embeddedTView(e,r);s&&(s.indexInDeclarationView=n,t!==null?t.push(s):t=[s])}return t!==null?new i(t):null}template(e,t){for(let n=0;n<this.queries.length;n++)this.queries[n].template(e,t)}getByIndex(e){return this.queries[e]}get length(){return this.queries.length}track(e){this.queries.push(e)}},My=class i{metadata;matches=null;indexInDeclarationView=-1;crossesNgTemplate=!1;_declarationNodeIndex;_appliesToNextNode=!0;constructor(e,t=-1){this.metadata=e,this._declarationNodeIndex=t}elementStart(e,t){this.isApplyingToNode(t)&&this.matchTNode(e,t)}elementEnd(e){this._declarationNodeIndex===e.index&&(this._appliesToNextNode=!1)}template(e,t){this.elementStart(e,t)}embeddedTView(e,t){return this.isApplyingToNode(e)?(this.crossesNgTemplate=!0,this.addMatch(-e.index,t),new i(this.metadata)):null}isApplyingToNode(e){if(this._appliesToNextNode&&(this.metadata.flags&1)!==1){let t=this._declarationNodeIndex,n=e.parent;for(;n!==null&&n.type&8&&n.index!==t;)n=n.parent;return t===(n!==null?n.index:-1)}return this._appliesToNextNode}matchTNode(e,t){let n=this.metadata.predicate;if(Array.isArray(n))for(let r=0;r<n.length;r++){let s=n[r];this.matchTNodeWithReadOption(e,t,c1(t,s)),this.matchTNodeWithReadOption(e,t,$d(t,e,s,!1,!1))}else n===ol?t.type&4&&this.matchTNodeWithReadOption(e,t,-1):this.matchTNodeWithReadOption(e,t,$d(t,e,n,!1,!1))}matchTNodeWithReadOption(e,t,n){if(n!==null){let r=this.metadata.read;if(r!==null)if(r===ul||r===Mo||r===ol&&t.type&4)this.addMatch(t.index,-2);else{let s=$d(t,e,r,!1,!1);s!==null&&this.addMatch(t.index,s)}else this.addMatch(t.index,n)}}addMatch(e,t){this.matches===null?this.matches=[e,t]:this.matches.push(e,t)}};function c1(i,e){let t=i.localNames;if(t!==null){for(let n=0;n<t.length;n+=2)if(t[n]===e)return t[n+1]}return null}function u1(i,e){return i.type&11?cl(i,e):i.type&4?iv(i,e):null}function h1(i,e,t,n){return t===-1?u1(e,i):t===-2?d1(i,e,n):Xd(i,i[Fe],t,e)}function d1(i,e,t){if(t===ul)return cl(e,i);if(t===ol)return iv(e,i);if(t===Mo)return EE(e,i)}function AE(i,e,t,n){let r=e[Tr].queries[n];if(r.matches===null){let s=i.data,o=t.matches,a=[];for(let l=0;o!==null&&l<o.length;l+=2){let c=o[l];if(c<0)a.push(null);else{let u=s[c];a.push(h1(e,u,o[l+1],t.metadata.read))}}r.matches=a}return r.matches}function Dy(i,e,t,n){let r=i.queries.getByIndex(t),s=r.matches;if(s!==null){let o=AE(i,e,r,t);for(let a=0;a<s.length;a+=2){let l=s[a];if(l>0)n.push(o[a/2]);else{let c=s[a+1],u=e[-l];for(let h=Nt;h<u.length;h++){let d=u[h];d[Ds]===d[Zt]&&Dy(d[Fe],d,c,n)}if(u[vo]!==null){let h=u[vo];for(let d=0;d<h.length;d++){let f=h[d];Dy(f[Fe],f,c,n)}}}}}return n}function f1(i,e){return i[Tr].queries[e].queryList}function p1(i,e,t){let n=new Zd((t&4)===4);return f0(i,e,n,n.destroy),(e[Tr]??=new Ey).queries.push(new Iy(n))-1}function m1(i,e,t){let n=bi();return n.firstCreatePass&&(_1(n,new Ay(i,e,t),-1),(e&2)===2&&(n.staticViewQueries=!0)),p1(n,lt(),e)}function g1(i){return i.split(",").map(e=>e.trim())}function _1(i,e,t){i.queries===null&&(i.queries=new wy),i.queries.track(new My(e,t))}function rv(i,e){return i.queries.getByIndex(e)}function y1(i,e){let t=i[Fe],n=rv(t,e);return n.crossesNgTemplate?Dy(t,i,e,[]):AE(t,i,n,e)}var Ao=class{},Sf=class{};var rf=class extends Ao{ngModuleType;_parent;_bootstrapComponents=[];_r3Injector;instance;destroyCbs=[];componentFactoryResolver=new tf(this);constructor(e,t,n,r=!0){super(),this.ngModuleType=e,this._parent=t;let s=A_(e);this._bootstrapComponents=GI(s.bootstrap),this._r3Injector=J_(e,t,[{provide:Ao,useValue:this},{provide:Kc,useValue:this.componentFactoryResolver},...n],es(e),new Set(["environment"])),r&&this.resolveInjectorInitializers()}resolveInjectorInitializers(){this._r3Injector.resolveInjectorInitializers(),this.instance=this._r3Injector.get(this.ngModuleType)}get injector(){return this._r3Injector}destroy(){let e=this._r3Injector;!e.destroyed&&e.destroy(),this.destroyCbs.forEach(t=>t()),this.destroyCbs=null}onDestroy(e){this.destroyCbs.push(e)}},sf=class extends Sf{moduleType;constructor(e){super(),this.moduleType=e}create(e){return new rf(this.moduleType,e,[])}};var $c=class extends Ao{injector;componentFactoryResolver=new tf(this);instance=null;constructor(e){super();let t=new ho([...e.providers,{provide:Ao,useValue:this},{provide:Kc,useValue:this.componentFactoryResolver}],e.parent||Dc(),e.debugName,new Set(["environment"]));this.injector=t,e.runEnvironmentInitializers&&t.resolveInjectorInitializers()}destroy(){this.injector.destroy()}onDestroy(e){this.injector.onDestroy(e)}};function Xc(i,e,t=null){return new $c({providers:i,parent:e,debugName:t,runEnvironmentInitializers:!0}).injector}var v1=(()=>{class i{_injector;cachedInjectors=new Map;constructor(t){this._injector=t}getOrCreateStandaloneInjector(t){if(!t.standalone)return null;if(!this.cachedInjectors.has(t)){let n=M_(!1,t.type),r=n.length>0?Xc([n],this._injector,`Standalone[${t.type.name}]`):null;this.cachedInjectors.set(t,r)}return this.cachedInjectors.get(t)}ngOnDestroy(){try{for(let t of this.cachedInjectors.values())t!==null&&t.destroy()}finally{this.cachedInjectors.clear()}}static \u0275prov=Me({token:i,providedIn:"environment",factory:()=>new i(je(An))})}return i})();function sr(i){return jc(()=>{let e=wE(i),t=ct(K({},e),{decls:i.decls,vars:i.vars,template:i.template,consts:i.consts||null,ngContentSelectors:i.ngContentSelectors,onPush:i.changeDetection===Gy.OnPush,directiveDefs:null,pipeDefs:null,dependencies:e.standalone&&i.dependencies||null,getStandaloneInjector:e.standalone?r=>r.get(v1).getOrCreateStandaloneInjector(t):null,getExternalStyles:null,signals:i.signals??!1,data:i.data||{},encapsulation:i.encapsulation||rr.Emulated,styles:i.styles||Bi,_:null,schemas:i.schemas||null,tView:null,id:""});e.standalone&&Ls("NgStandalone"),ME(t);let n=i.dependencies;return t.directiveDefs=tI(n,b1),t.pipeDefs=tI(n,e0),t.id=T1(t),t})}function b1(i){return Ms(i)||w_(i)}function Zc(i){return jc(()=>({type:i.type,bootstrap:i.bootstrap||Bi,declarations:i.declarations||Bi,imports:i.imports||Bi,exports:i.exports||Bi,transitiveCompileScopes:null,schemas:i.schemas||null,id:i.id||null}))}function x1(i,e){if(i==null)return mo;let t={};for(let n in i)if(i.hasOwnProperty(n)){let r=i[n],s,o,a,l;Array.isArray(r)?(a=r[0],s=r[1],o=r[2]??s,l=r[3]||null):(s=r,o=r,a=_f.None,l=null),t[s]=[n,a,l],e[s]=o}return t}function C1(i){if(i==null)return mo;let e={};for(let t in i)i.hasOwnProperty(t)&&(e[i[t]]=t);return e}function If(i){return jc(()=>{let e=wE(i);return ME(e),e})}function sv(i){return{type:i.type,name:i.name,factory:null,pure:i.pure!==!1,standalone:i.standalone??!0,onDestroy:i.type.prototype.ngOnDestroy||null}}function wE(i){let e={};return{type:i.type,providersResolver:null,factory:null,hostBindings:i.hostBindings||null,hostVars:i.hostVars||0,hostAttrs:i.hostAttrs||null,contentQueries:i.contentQueries||null,declaredInputs:e,inputConfig:i.inputs||mo,exportAs:i.exportAs||null,standalone:i.standalone??!0,signals:i.signals===!0,selectors:i.selectors||Bi,viewQuery:i.viewQuery||null,features:i.features||null,setInput:null,resolveHostDirectives:null,hostDirectives:null,inputs:x1(i.inputs,e),outputs:C1(i.outputs),debugInfo:null}}function ME(i){i.features?.forEach(e=>e(i))}function tI(i,e){return i?()=>{let t=typeof i=="function"?i():i,n=[];for(let r of t){let s=e(r);s!==null&&n.push(s)}return n}:null}function T1(i){let e=0,t=typeof i.consts=="function"?"":i.consts,n=[i.selectors,i.ngContentSelectors,i.hostVars,i.hostAttrs,t,i.vars,i.decls,i.encapsulation,i.standalone,i.signals,i.exportAs,JSON.stringify(i.inputs),JSON.stringify(i.outputs),Object.getOwnPropertyNames(i.type.prototype),!!i.contentQueries,!!i.viewQuery];for(let s of n.join("|"))e=Math.imul(31,e)+s.charCodeAt(0)<<0;return e+=2147483648,"c"+e}function S1(i,e,t,n,r,s,o,a){if(t.firstCreatePass){i.mergedAttrs=df(i.mergedAttrs,i.attrs);let u=i.tView=jy(2,i,r,s,o,t.directiveRegistry,t.pipeRegistry,null,t.schemas,t.consts,null);t.queries!==null&&(t.queries.template(t,i),u.queries=t.queries.embeddedTView(i))}a&&(i.flags|=a),el(i,!1);let l=I1(t,e,i,n);Bd()&&Qy(t,e,l,i),sl(l,e);let c=pE(l,e,l,i);e[n+Jt]=c,Yy(e,c),a1(c,i,e)}function of(i,e,t,n,r,s,o,a,l,c,u){let h=t+Jt,d;if(e.firstCreatePass){if(d=Cf(e,h,4,o||null,a||null),c!=null){let f=Er(e.consts,c);d.localNames=[];for(let p=0;p<f.length;p+=2)d.localNames.push(f[p],-1)}}else d=e.data[h];return S1(d,i,e,t,n,r,s,l),c!=null&&ev(i,d,u),d}var I1=E1;function E1(i,e,t,n){return Vd(!0),e[Qt].createComment("")}var ov=(()=>{class i{log(t){console.log(t)}warn(t){console.warn(t)}static \u0275fac=function(n){return new(n||i)};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"platform"})}return i})();var av=new Ve("");function Do(i){return!!i&&typeof i.then=="function"}function Ef(i){return!!i&&typeof i.subscribe=="function"}var DE=new Ve("");var lv=(()=>{class i{resolve;reject;initialized=!1;done=!1;donePromise=new Promise((t,n)=>{this.resolve=t,this.reject=n});appInits=ae(DE,{optional:!0})??[];injector=ae(xr);constructor(){}runInitializers(){if(this.initialized)return;let t=[];for(let r of this.appInits){let s=Hn(this.injector,r);if(Do(s))t.push(s);else if(Ef(s)){let o=new Promise((a,l)=>{s.subscribe({complete:a,error:l})});t.push(o)}}let n=()=>{this.done=!0,this.resolve()};Promise.all(t).then(()=>{n()}).catch(r=>{this.reject(r)}),t.length===0&&n(),this.initialized=!0}static \u0275fac=function(n){return new(n||i)};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})(),Af=new Ve("");function RE(){Ng(()=>{let i="";throw new Le(600,i)})}function PE(i){return i.isBoundToModule}var A1=10;var Ro=(()=>{class i{_runningTick=!1;_destroyed=!1;_destroyListeners=[];_views=[];internalErrorHandler=ae(zi);afterRenderManager=ae(KI);zonelessEnabled=ae(nl);rootEffectScheduler=ae(sy);dirtyFlags=0;tracingSnapshot=null;allTestViews=new Set;autoDetectTestViews=new Set;includeAllTestViews=!1;afterTick=new Xt;get allViews(){return[...(this.includeAllTestViews?this.allTestViews:this.autoDetectTestViews).keys(),...this._views]}get destroyed(){return this._destroyed}componentTypes=[];components=[];internalPendingTask=ae(rs);get isStable(){return this.internalPendingTask.hasPendingTasksObservable.pipe(It(t=>!t))}constructor(){ae(Yc,{optional:!0})}whenStable(){let t;return new Promise(n=>{t=this.isStable.subscribe({next:r=>{r&&n()}})}).finally(()=>{t.unsubscribe()})}_injector=ae(An);_rendererFactory=null;get injector(){return this._injector}bootstrap(t,n){return this.bootstrapImpl(t,n)}bootstrapImpl(t,n,r=xr.NULL){return this._injector.get(Et).run(()=>{St(10);let o=t instanceof Tf;if(!this._injector.get(lv).done){let p="";throw new Le(405,p)}let l;o?l=t:l=this._injector.get(Kc).resolveComponentFactory(t),this.componentTypes.push(l.componentType);let c=PE(l)?void 0:this._injector.get(Ao),u=n||l.selector,h=l.create(r,[],u,c),d=h.location.nativeElement,f=h.injector.get(av,null);return f?.registerApplication(d),h.onDestroy(()=>{this.detachView(h.hostView),Vc(this.components,h),f?.unregisterApplication(d)}),this._loadComponent(h),St(11,h),h})}tick(){this.zonelessEnabled||(this.dirtyFlags|=1),this._tick()}_tick(){St(12),this.tracingSnapshot!==null?this.tracingSnapshot.run(Xy.CHANGE_DETECTION,this.tickImpl):this.tickImpl()}tickImpl=()=>{if(this._runningTick)throw new Le(101,!1);let t=Be(null);try{this._runningTick=!0,this.synchronize()}finally{this._runningTick=!1,this.tracingSnapshot?.dispose(),this.tracingSnapshot=null,Be(t),this.afterTick.next(),St(13)}};synchronize(){this._rendererFactory===null&&!this._injector.destroyed&&(this._rendererFactory=this._injector.get(Eo,null,{optional:!0}));let t=0;for(;this.dirtyFlags!==0&&t++<A1;)St(14),this.synchronizeOnce(),St(15)}synchronizeOnce(){this.dirtyFlags&16&&(this.dirtyFlags&=-17,this.rootEffectScheduler.flush());let t=!1;if(this.dirtyFlags&7){let n=!!(this.dirtyFlags&1);this.dirtyFlags&=-8,this.dirtyFlags|=8;for(let{_lView:r}of this.allViews){if(!n&&!Lc(r))continue;let s=n&&!this.zonelessEnabled?0:1;uE(r,s),t=!0}if(this.dirtyFlags&=-5,this.syncDirtyFlagsWithViews(),this.dirtyFlags&23)return}t||(this._rendererFactory?.begin?.(),this._rendererFactory?.end?.()),this.dirtyFlags&8&&(this.dirtyFlags&=-9,this.afterRenderManager.execute()),this.syncDirtyFlagsWithViews()}syncDirtyFlagsWithViews(){if(this.allViews.some(({_lView:t})=>Lc(t))){this.dirtyFlags|=2;return}else this.dirtyFlags&=-8}attachView(t){let n=t;this._views.push(n),n.attachToAppRef(this)}detachView(t){let n=t;Vc(this._views,n),n.detachFromAppRef()}_loadComponent(t){this.attachView(t.hostView);try{this.tick()}catch(r){this.internalErrorHandler(r)}this.components.push(t),this._injector.get(Af,[]).forEach(r=>r(t))}ngOnDestroy(){if(!this._destroyed)try{this._destroyListeners.forEach(t=>t()),this._views.slice().forEach(t=>t.destroy())}finally{this._destroyed=!0,this._views=[],this._destroyListeners=[]}}onDestroy(t){return this._destroyListeners.push(t),()=>Vc(this._destroyListeners,t)}destroy(){if(this._destroyed)throw new Le(406,!1);let t=this._injector;t.destroy&&!t.destroyed&&t.destroy()}get viewCount(){return this._views.length}static \u0275fac=function(n){return new(n||i)};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();function Vc(i,e){let t=i.indexOf(e);t>-1&&i.splice(t,1)}var v4=typeof document<"u"&&typeof document?.documentElement?.getAnimations=="function";var Ry=class{destroy(e){}updateValue(e,t){}swap(e,t){let n=Math.min(e,t),r=Math.max(e,t),s=this.detach(r);if(r-n>1){let o=this.detach(n);this.attach(n,s),this.attach(r,o)}else this.attach(n,s)}move(e,t){this.attach(t,this.detach(e))}};function uy(i,e,t,n,r){return i===t&&Object.is(e,n)?1:Object.is(r(i,e),r(t,n))?-1:0}function w1(i,e,t,n){let r,s,o=0,a=i.length-1,l=void 0;if(Array.isArray(e)){Be(n);let c=e.length-1;for(Be(null);o<=a&&o<=c;){let u=i.at(o),h=e[o],d=uy(o,u,o,h,t);if(d!==0){d<0&&i.updateValue(o,h),o++;continue}let f=i.at(a),p=e[c],g=uy(a,f,c,p,t);if(g!==0){g<0&&i.updateValue(a,p),a--,c--;continue}let _=t(o,u),y=t(a,f),C=t(o,h);if(Object.is(C,y)){let E=t(c,p);Object.is(E,_)?(i.swap(o,a),i.updateValue(a,p),c--,a--):i.move(a,o),i.updateValue(o,h),o++;continue}if(r??=new af,s??=iI(i,o,a,t),Py(i,r,o,C))i.updateValue(o,h),o++,a++;else if(s.has(C))r.set(_,i.detach(o)),a--;else{let E=i.create(o,e[o]);i.attach(o,E),o++,a++}}for(;o<=c;)nI(i,r,t,o,e[o]),o++}else if(e!=null){Be(n);let c=e[Symbol.iterator]();Be(null);let u=c.next();for(;!u.done&&o<=a;){let h=i.at(o),d=u.value,f=uy(o,h,o,d,t);if(f!==0)f<0&&i.updateValue(o,d),o++,u=c.next();else{r??=new af,s??=iI(i,o,a,t);let p=t(o,d);if(Py(i,r,o,p))i.updateValue(o,d),o++,a++,u=c.next();else if(!s.has(p))i.attach(o,i.create(o,d)),o++,a++,u=c.next();else{let g=t(o,h);r.set(g,i.detach(o)),a--}}}for(;!u.done;)nI(i,r,t,i.length,u.value),u=c.next()}for(;o<=a;)i.destroy(i.detach(a--));r?.forEach(c=>{i.destroy(c)})}function Py(i,e,t,n){return e!==void 0&&e.has(n)?(i.attach(t,e.get(n)),e.delete(n),!0):!1}function nI(i,e,t,n,r){if(Py(i,e,n,t(n,r)))i.updateValue(n,r);else{let s=i.create(n,r);i.attach(n,s)}}function iI(i,e,t,n){let r=new Set;for(let s=e;s<=t;s++)r.add(n(s,i.at(s)));return r}var af=class{kvMap=new Map;_vMap=void 0;has(e){return this.kvMap.has(e)}delete(e){if(!this.has(e))return!1;let t=this.kvMap.get(e);return this._vMap!==void 0&&this._vMap.has(t)?(this.kvMap.set(e,this._vMap.get(t)),this._vMap.delete(t)):this.kvMap.delete(e),!0}get(e){return this.kvMap.get(e)}set(e,t){if(this.kvMap.has(e)){let n=this.kvMap.get(e);this._vMap===void 0&&(this._vMap=new Map);let r=this._vMap;for(;r.has(n);)n=r.get(n);r.set(n,t)}else this.kvMap.set(e,t)}forEach(e){for(let[t,n]of this.kvMap)if(e(n,t),this._vMap!==void 0){let r=this._vMap;for(;r.has(n);)n=r.get(n),e(n,t)}}};function hn(i,e,t,n,r,s,o,a){Ls("NgControlFlow");let l=lt(),c=bi(),u=Er(c.consts,s);return of(l,c,i,e,t,n,r,u,256,o,a),Qc}function Qc(i,e,t,n,r,s,o,a){Ls("NgControlFlow");let l=lt(),c=bi(),u=Er(c.consts,s);return of(l,c,i,e,t,n,r,u,512,o,a),Qc}function dn(i,e){Ls("NgControlFlow");let t=lt(),n=kc(),r=t[n]!==Mr?t[n]:-1,s=r!==-1?lf(t,Jt+r):void 0,o=0;if(hl(t,n,i)){let a=Be(null);try{if(s!==void 0&&gE(s,o),i!==-1){let l=Jt+i,c=lf(t,l),u=Fy(t[Fe],l),h=yE(c,u,t),d=bf(t,u,e,{dehydratedView:h});xf(c,d,o,Uc(u,h))}}finally{Be(a)}}else if(s!==void 0){let a=mE(s,o);a!==void 0&&(a[Vt]=e)}}var Oy=class{lContainer;$implicit;$index;constructor(e,t,n){this.lContainer=e,this.$implicit=t,this.$index=n}get $count(){return this.lContainer.length-Nt}};function Dr(i,e){return e}var Ny=class{hasEmptyBlock;trackByFn;liveCollection;constructor(e,t,n){this.hasEmptyBlock=e,this.trackByFn=t,this.liveCollection=n}};function xi(i,e,t,n,r,s,o,a,l,c,u,h,d){Ls("NgControlFlow");let f=lt(),p=bi(),g=l!==void 0,_=lt(),y=a?o.bind(_[yi][Vt]):o,C=new Ny(g,y);_[Jt+i]=C,of(f,p,i+1,e,t,n,r,Er(p.consts,s),256),g&&of(f,p,i+2,l,c,u,h,Er(p.consts,d),512)}var Ly=class extends Ry{lContainer;hostLView;templateTNode;operationsCounter=void 0;needsIndexUpdate=!1;constructor(e,t,n){super(),this.lContainer=e,this.hostLView=t,this.templateTNode=n}get length(){return this.lContainer.length-Nt}at(e){return this.getLView(e)[Vt].$implicit}attach(e,t){let n=t[Ya];this.needsIndexUpdate||=e!==this.length,xf(this.lContainer,t,e,Uc(this.templateTNode,n)),M1(this.lContainer,e)}detach(e){return this.needsIndexUpdate||=e!==this.length-1,D1(this.lContainer,e),R1(this.lContainer,e)}create(e,t){let n=xy(this.lContainer,this.templateTNode.tView.ssrId),r=bf(this.hostLView,this.templateTNode,new Oy(this.lContainer,t,e),{dehydratedView:n});return this.operationsCounter?.recordCreate(),r}destroy(e){yf(e[Fe],e),this.operationsCounter?.recordDestroy()}updateValue(e,t){this.getLView(e)[Vt].$implicit=t}reset(){this.needsIndexUpdate=!1,this.operationsCounter?.reset()}updateIndexes(){if(this.needsIndexUpdate)for(let e=0;e<this.length;e++)this.getLView(e)[Vt].$index=e}getLView(e){return P1(this.lContainer,e)}};function Ci(i){let e=Be(null),t=Ps();try{let n=lt(),r=n[Fe],s=n[t],o=t+1,a=lf(n,o);if(s.liveCollection===void 0){let c=Fy(r,o);s.liveCollection=new Ly(a,n,c)}else s.liveCollection.reset();let l=s.liveCollection;if(w1(l,i,s.trackByFn,e),l.updateIndexes(),s.hasEmptyBlock){let c=kc(),u=l.length===0;if(hl(n,c,u)){let h=t+2,d=lf(n,h);if(u){let f=Fy(r,h),p=yE(d,f,n),g=bf(n,f,void 0,{dehydratedView:p});xf(d,g,0,Uc(f,p))}else r.firstUpdatePass&&AO(d),gE(d,0)}}}finally{Be(e)}}function lf(i,e){return i[e]}function M1(i,e){if(i.length<=Nt)return;let t=Nt+e,n=i[t],r=n?n[yo]:void 0;if(n&&r&&r.detachedLeaveAnimationFns&&r.detachedLeaveAnimationFns.length>0){let s=n[ns];LP(s,r),Io.delete(n),r.detachedLeaveAnimationFns=void 0}}function D1(i,e){if(i.length<=Nt)return;let t=Nt+e,n=i[t],r=n?n[yo]:void 0;r&&r.leave&&r.leave.size>0&&(r.detachedLeaveAnimationFns=[])}function R1(i,e){return Hc(i,e)}function P1(i,e){return mE(i,e)}function Fy(i,e){return Nc(i,e)}function rI(i,e,t,n,r){rE(e,i,t,r?"class":"style",n)}function cv(i,e,t,n){let r=lt(),s=r[Fe],o=i+Jt,a=s.firstCreatePass?CE(o,r,2,e,rO,g0(),t,n):s.data[o];if(nE(a,r,i,e,OE),Dd(a)){let l=r[Fe];tE(l,r,a),FI(l,a,r)}return n!=null&&ev(r,a),cv}function uv(){let i=bi(),e=nr(),t=iE(e);return i.firstCreatePass&&TE(i,t),$_(t)&&W_(),H_(),t.classesWithoutHost!=null&&$R(t)&&rI(i,t,lt(),t.classesWithoutHost,!0),t.stylesWithoutHost!=null&&WR(t)&&rI(i,t,lt(),t.stylesWithoutHost,!1),uv}function dl(i,e,t,n){return cv(i,e,t,n),uv(),dl}function Te(i,e,t,n){let r=lt(),s=r[Fe],o=i+Jt,a=s.firstCreatePass?UO(o,s,2,e,t,n):s.data[o];return nE(a,r,i,e,OE),n!=null&&ev(r,a),Te}function xe(){let i=nr(),e=iE(i);return $_(e)&&W_(),H_(),xe}function en(i,e,t,n){return Te(i,e,t,n),xe(),en}var OE=(i,e,t,n,r)=>(Vd(!0),zI(e[Qt],n,P0()));function Jc(){return lt()}function Rr(i,e,t){let n=lt(),r=kc();if(hl(n,r,e)){let s=bi(),o=R0();eO(o,n,i,e,n[Qt],t)}return Rr}var eu="en-US";var O1=eu;function NE(i){typeof i=="string"&&(O1=i.toLowerCase().replace(/_/g,"-"))}function fl(i,e,t){let n=lt(),r=bi(),s=nr();return(s.type&3||t)&&$O(s,r,n,t,n[Qt],i,e,HO(s,n,e)),fl}function wn(i=1){return D0(i)}function tu(i,e,t){m1(i,e,t)}function nu(i){let e=lt(),t=bi(),n=X_();Nd(n+1);let r=rv(t,n);if(i.dirty&&c0(e)===((r.metadata.flags&2)===2)){if(r.matches===null)i.reset([]);else{let s=y1(e,n);i.reset(s,sP),i.notifyOnChanges()}return!0}return!1}function iu(){return f1(lt(),X_())}function Ud(i,e){return i<<17|e<<2}function wo(i){return i>>17&32767}function N1(i){return(i&2)==2}function L1(i,e){return i&131071|e<<17}function ky(i){return i|2}function ll(i){return(i&131068)>>2}function hy(i,e){return i&-131069|e<<2}function F1(i){return(i&1)===1}function By(i){return i|1}function k1(i,e,t,n,r,s){let o=s?e.classBindings:e.styleBindings,a=wo(o),l=ll(o);i[n]=t;let c=!1,u;if(Array.isArray(t)){let h=t;u=h[1],(u===null||ja(h,u)>0)&&(c=!0)}else u=t;if(r)if(l!==0){let d=wo(i[a+1]);i[n+1]=Ud(d,a),d!==0&&(i[d+1]=hy(i[d+1],n)),i[a+1]=L1(i[a+1],n)}else i[n+1]=Ud(a,0),a!==0&&(i[a+1]=hy(i[a+1],n)),a=n;else i[n+1]=Ud(l,0),a===0?a=n:i[l+1]=hy(i[l+1],n),l=n;c&&(i[n+1]=ky(i[n+1])),sI(i,u,n,!0),sI(i,u,n,!1),B1(e,u,i,n,s),o=Ud(a,l),s?e.classBindings=o:e.styleBindings=o}function B1(i,e,t,n,r){let s=r?i.residualClasses:i.residualStyles;s!=null&&typeof e=="string"&&ja(s,e)>=0&&(t[n+1]=By(t[n+1]))}function sI(i,e,t,n){let r=i[t+1],s=e===null,o=n?wo(r):ll(r),a=!1;for(;o!==0&&(a===!1||s);){let l=i[o],c=i[o+1];V1(l,e)&&(a=!0,i[o+1]=n?By(c):ky(c)),o=n?wo(c):ll(c)}a&&(i[t+1]=n?ky(r):By(r))}function V1(i,e){return i===null||e==null||(Array.isArray(i)?i[1]:i)===e?!0:Array.isArray(i)&&typeof e=="string"?ja(i,e)>=0:!1}function wf(i,e,t){return LE(i,e,t,!1),wf}function Pr(i,e){return LE(i,e,null,!0),Pr}function LE(i,e,t,n){let r=lt(),s=bi(),o=C0(2);if(s.firstUpdatePass&&U1(s,i,o,n),e!==Mr&&hl(r,o,e)){let a=s.data[Ps()];j1(s,a,r,r[Qt],i,r[o+1]=q1(e,t),n,o)}}function G1(i,e){return e>=i.expandoStartIndex}function U1(i,e,t,n){let r=i.data;if(r[t+1]===null){let s=r[Ps()],o=G1(i,t);Y1(s,n)&&e===null&&!o&&(e=!1),e=z1(r,s,e,n),k1(r,s,e,t,o,n)}}function z1(i,e,t,n){let r=E0(i),s=n?e.residualClasses:e.residualStyles;if(r===null)(n?e.classBindings:e.styleBindings)===0&&(t=dy(null,i,e,t,n),t=Wc(t,e.attrs,n),s=null);else{let o=e.directiveStylingLast;if(o===-1||i[o]!==r)if(t=dy(r,i,e,t,n),s===null){let l=H1(i,e,n);l!==void 0&&Array.isArray(l)&&(l=dy(null,i,e,l[1],n),l=Wc(l,e.attrs,n),$1(i,e,n,l))}else s=W1(i,e,n)}return s!==void 0&&(n?e.residualClasses=s:e.residualStyles=s),t}function H1(i,e,t){let n=t?e.classBindings:e.styleBindings;if(ll(n)!==0)return i[wo(n)]}function $1(i,e,t,n){let r=t?e.classBindings:e.styleBindings;i[wo(r)]=n}function W1(i,e,t){let n,r=e.directiveEnd;for(let s=1+e.directiveStylingLast;s<r;s++){let o=i[s].hostAttrs;n=Wc(n,o,t)}return Wc(n,e.attrs,t)}function dy(i,e,t,n,r){let s=null,o=t.directiveEnd,a=t.directiveStylingLast;for(a===-1?a=t.directiveStart:a++;a<o&&(s=e[a],n=Wc(n,s.hostAttrs,r),s!==i);)a++;return i!==null&&(t.directiveStylingLast=a),n}function Wc(i,e,t){let n=t?1:2,r=-1;if(e!==null)for(let s=0;s<e.length;s++){let o=e[s];typeof o=="number"?r=o:r===n&&(Array.isArray(i)||(i=i===void 0?[]:["",i]),JS(i,o,t?!0:e[++s]))}return i===void 0?null:i}function j1(i,e,t,n,r,s,o,a){if(!(e.type&3))return;let l=i.data,c=l[a+1],u=F1(c)?oI(l,e,t,r,ll(c),o):void 0;if(!cf(u)){cf(s)||N1(c)&&(s=oI(l,null,t,r,a,o));let h=F_(Ps(),t);XP(n,o,h,r,s)}}function oI(i,e,t,n,r,s){let o=e===null,a;for(;r>0;){let l=i[r],c=Array.isArray(l),u=c?l[1]:l,h=u===null,d=t[r+1];d===Mr&&(d=h?Bi:void 0);let f=h?Ad(d,n):u===n?d:void 0;if(c&&!cf(f)&&(f=Ad(l,n)),cf(f)&&(a=f,o))return a;let p=i[r+1];r=o?wo(p):ll(p)}if(e!==null){let l=s?e.residualClasses:e.residualStyles;l!=null&&(a=Ad(l,n))}return a}function cf(i){return i!==void 0}function q1(i,e){return i==null||i===""||(typeof e=="string"?i=i+e:typeof i=="object"&&(i=es(Hy(i)))),i}function Y1(i,e){return(i.flags&(e?8:16))!==0}function Ye(i,e=""){let t=lt(),n=bi(),r=i+Jt,s=n.firstCreatePass?Cf(n,r,1,e,null):n.data[r],o=K1(n,t,s,e,i);t[r]=o,Bd()&&Qy(n,t,o,s),el(s,!1)}var K1=(i,e,t,n,r)=>(Vd(!0),AP(e[Qt],n));function X1(i,e,t,n=""){return hl(i,kc(),t)?e+Sd(t)+n:Mr}function tn(i){return os("",i),tn}function os(i,e,t){let n=lt(),r=X1(n,i,e,t);return r!==Mr&&Z1(n,Ps(),r),os}function Z1(i,e,t){let n=F_(e,i);wP(i[Qt],n,t)}function Q1(i,e){let t=i[e];return t===Mr?void 0:t}function J1(i,e,t,n,r,s){let o=e+t;return hl(i,o,r)?zO(i,o+1,s?n.call(s,r):n(r)):Q1(i,o+1)}function Fs(i,e){let t=bi(),n,r=i+Jt;t.firstCreatePass?(n=eN(e,t.pipeRegistry),t.data[r]=n,n.onDestroy&&(t.destroyHooks??=[]).push(r,n.onDestroy)):n=t.data[r];let s=n.factory||(n.factory=Es(n.type,!0)),o,a=Un(Wt);try{let l=Kd(!1),c=s();return Kd(l),k_(t,lt(),r,c),c}finally{Un(a)}}function eN(i,e){if(e)for(let t=e.length-1;t>=0;t--){let n=e[t];if(i===n.name)return n}}function ks(i,e,t){let n=i+Jt,r=lt(),s=l0(r,n);return tN(r,n)?J1(r,b0(),e,s.transform,t,s):s.transform(t)}function tN(i,e){return i[Fe].data[e].pure}var uf=class{ngModuleFactory;componentFactories;constructor(e,t){this.ngModuleFactory=e,this.componentFactories=t}},hv=(()=>{class i{compileModuleSync(t){return new sf(t)}compileModuleAsync(t){return Promise.resolve(this.compileModuleSync(t))}compileModuleAndAllComponentsSync(t){let n=this.compileModuleSync(t),r=A_(t),s=GI(r.declarations).reduce((o,a)=>{let l=Ms(a);return l&&o.push(new al(l)),o},[]);return new uf(n,s)}compileModuleAndAllComponentsAsync(t){return Promise.resolve(this.compileModuleAndAllComponentsSync(t))}clearCache(){}clearCacheFor(t){}getModuleId(t){}static \u0275fac=function(n){return new(n||i)};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();var FE=(()=>{class i{applicationErrorHandler=ae(zi);appRef=ae(Ro);taskService=ae(rs);ngZone=ae(Et);zonelessEnabled=ae(nl);tracing=ae(Yc,{optional:!0});zoneIsDefined=typeof Zone<"u"&&!!Zone.root.run;schedulerTickApplyArgs=[{data:{__scheduler_tick__:!0}}];subscriptions=new Bt;angularZoneId=this.zoneIsDefined?this.ngZone._inner?.get(Ic):null;scheduleInRootZone=!this.zonelessEnabled&&this.zoneIsDefined&&(ae(Gd,{optional:!0})??!1);cancelScheduledCallback=null;useMicrotaskScheduler=!1;runningTick=!1;pendingRenderTaskId=null;constructor(){this.subscriptions.add(this.appRef.afterTick.subscribe(()=>{this.runningTick||this.cleanup()})),this.subscriptions.add(this.ngZone.onUnstable.subscribe(()=>{this.runningTick||this.cleanup()}))}notify(t){if(!this.zonelessEnabled&&t===5)return;switch(t){case 0:{this.appRef.dirtyFlags|=2;break}case 3:case 2:case 4:case 5:case 1:{this.appRef.dirtyFlags|=4;break}case 6:{this.appRef.dirtyFlags|=2;break}case 12:{this.appRef.dirtyFlags|=16;break}case 13:{this.appRef.dirtyFlags|=2;break}case 11:break;case 9:case 8:case 7:case 10:default:this.appRef.dirtyFlags|=8}if(this.appRef.tracingSnapshot=this.tracing?.snapshot(this.appRef.tracingSnapshot)??null,!this.shouldScheduleTick())return;let n=this.useMicrotaskScheduler?ny:ty;this.pendingRenderTaskId=this.taskService.add(),this.scheduleInRootZone?this.cancelScheduledCallback=Zone.root.run(()=>n(()=>this.tick())):this.cancelScheduledCallback=this.ngZone.runOutsideAngular(()=>n(()=>this.tick()))}shouldScheduleTick(){return!(this.appRef.destroyed||this.pendingRenderTaskId!==null||this.runningTick||this.appRef._runningTick||!this.zonelessEnabled&&this.zoneIsDefined&&Zone.current.get(Ic+this.angularZoneId))}tick(){if(this.runningTick||this.appRef.destroyed)return;if(this.appRef.dirtyFlags===0){this.cleanup();return}!this.zonelessEnabled&&this.appRef.dirtyFlags&7&&(this.appRef.dirtyFlags|=1);let t=this.taskService.add();try{this.ngZone.run(()=>{this.runningTick=!0,this.appRef._tick()},void 0,this.schedulerTickApplyArgs)}catch(n){this.taskService.remove(t),this.applicationErrorHandler(n)}finally{this.cleanup()}this.useMicrotaskScheduler=!0,ny(()=>{this.useMicrotaskScheduler=!1,this.taskService.remove(t)})}ngOnDestroy(){this.subscriptions.unsubscribe(),this.cleanup()}cleanup(){if(this.runningTick=!1,this.cancelScheduledCallback?.(),this.cancelScheduledCallback=null,this.pendingRenderTaskId!==null){let t=this.pendingRenderTaskId;this.pendingRenderTaskId=null,this.taskService.remove(t)}}static \u0275fac=function(n){return new(n||i)};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();function kE(){return[{provide:fo,useExisting:FE},{provide:Et,useClass:Ec},{provide:nl,useValue:!0}]}function nN(){return typeof $localize<"u"&&$localize.locale||eu}var Mf=new Ve("",{factory:()=>ae(Mf,{optional:!0,skipSelf:!0})||nN()});var VE=Symbol("InputSignalNode#UNSET"),vN=ct(K({},$h),{transformFn:void 0,applyValueToInputSignal(i,e){_c(i,e)}});function GE(i,e){let t=Object.create(vN);t.value=i,t.transformFn=e?.transform;function n(){if(Uh(t),t.value===VE){let r=null;throw new Le(-950,r)}return t.value}return n[Fi]=t,n}function BE(i,e){return GE(i,e)}function bN(i){return GE(VE,i)}var UE=(BE.required=bN,BE);var xN=(()=>{class i{zone=ae(Et);changeDetectionScheduler=ae(fo);applicationRef=ae(Ro);applicationErrorHandler=ae(zi);_onMicrotaskEmptySubscription;initialize(){this._onMicrotaskEmptySubscription||(this._onMicrotaskEmptySubscription=this.zone.onMicrotaskEmpty.subscribe({next:()=>{this.changeDetectionScheduler.runningTick||this.zone.run(()=>{try{this.applicationRef.dirtyFlags|=1,this.applicationRef._tick()}catch(t){this.applicationErrorHandler(t)}})}}))}ngOnDestroy(){this._onMicrotaskEmptySubscription?.unsubscribe()}static \u0275fac=function(n){return new(n||i)};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})(),CN=new Ve("",{factory:()=>!1});function TN({ngZoneFactory:i,scheduleInRootZone:e}){return i??=()=>new Et(ct(K({},HE()),{scheduleInRootZone:e})),[{provide:nl,useValue:!1},{provide:Et,useFactory:i},{provide:ws,multi:!0,useFactory:()=>{let t=ae(xN,{optional:!0});return()=>t.initialize()}},{provide:ws,multi:!0,useFactory:()=>{let t=ae(SN);return()=>{t.initialize()}}},{provide:Gd,useValue:e??ey}]}function zE(i){let e=i?.scheduleInRootZone,t=TN({ngZoneFactory:()=>{let n=HE(i);return n.scheduleInRootZone=e,n.shouldCoalesceEventChangeDetection&&Ls("NgZone_CoalesceEvent"),new Et(n)},scheduleInRootZone:e});return qa([{provide:CN,useValue:!0},t])}function HE(i){return{enableLongStackTrace:!1,shouldCoalesceEventChangeDetection:i?.eventCoalescing??!1,shouldCoalesceRunChangeDetection:i?.runCoalescing??!1}}var SN=(()=>{class i{subscription=new Bt;initialized=!1;zone=ae(Et);pendingTasks=ae(rs);initialize(){if(this.initialized)return;this.initialized=!0;let t=null;!this.zone.isStable&&!this.zone.hasPendingMacrotasks&&!this.zone.hasPendingMicrotasks&&(t=this.pendingTasks.add()),this.zone.runOutsideAngular(()=>{this.subscription.add(this.zone.onStable.subscribe(()=>{Et.assertNotInAngularZone(),queueMicrotask(()=>{t!==null&&!this.zone.hasPendingMacrotasks&&!this.zone.hasPendingMicrotasks&&(this.pendingTasks.remove(t),t=null)})}))}),this.subscription.add(this.zone.onUnstable.subscribe(()=>{Et.assertInAngularZone(),t??=this.pendingTasks.add()}))}ngOnDestroy(){this.subscription.unsubscribe()}static \u0275fac=function(n){return new(n||i)};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();var dv=new Ve(""),IN=new Ve("");function ru(i){return!i.moduleRef}function EN(i){let e=ru(i)?i.r3Injector:i.moduleRef.injector,t=e.get(Et);return t.run(()=>{ru(i)?i.r3Injector.resolveInjectorInitializers():i.moduleRef.resolveInjectorInitializers();let n=e.get(zi),r;if(t.runOutsideAngular(()=>{r=t.onError.subscribe({next:n})}),ru(i)){let s=()=>e.destroy(),o=i.platformInjector.get(dv);o.add(s),e.onDestroy(()=>{r.unsubscribe(),o.delete(s)})}else{let s=()=>i.moduleRef.destroy(),o=i.platformInjector.get(dv);o.add(s),i.moduleRef.onDestroy(()=>{Vc(i.allPlatformModules,i.moduleRef),r.unsubscribe(),o.delete(s)})}return wN(n,t,()=>{let s=e.get(rs),o=s.add(),a=e.get(lv);return a.runInitializers(),a.donePromise.then(()=>{let l=e.get(Mf,eu);if(NE(l||eu),!e.get(IN,!0))return ru(i)?e.get(Ro):(i.allPlatformModules.push(i.moduleRef),i.moduleRef);if(ru(i)){let u=e.get(Ro);return i.rootComponent!==void 0&&u.bootstrap(i.rootComponent),u}else return AN?.(i.moduleRef,i.allPlatformModules),i.moduleRef}).finally(()=>void s.remove(o))})})}var AN;function wN(i,e,t){try{let n=t();return Do(n)?n.catch(r=>{throw e.runOutsideAngular(()=>i(r)),r}):n}catch(n){throw e.runOutsideAngular(()=>i(n)),n}}var Df=null;function MN(i=[],e){return xr.create({name:e,providers:[{provide:Mc,useValue:"platform"},{provide:dv,useValue:new Set([()=>Df=null])},...i]})}function DN(i=[]){if(Df)return Df;let e=MN(i);return Df=e,RE(),RN(e),e}function RN(i){let e=i.get(mf,null);Hn(i,()=>{e?.forEach(t=>t())})}var Pf=(()=>{class i{static __NG_ELEMENT_ID__=PN}return i})();function PN(i){return ON(nr(),lt(),(i&16)===16)}function ON(i,e,t){if(bo(i)&&!t){let n=Ir(i.index,e);return new Ns(n,n)}else if(i.type&175){let n=e[yi];return new Ns(n,e)}return null}function $E(i){let{rootComponent:e,appProviders:t,platformProviders:n,platformRef:r}=i;St(8);try{let s=r?.injector??DN(n),o=[kE(),L0,...t||[]],a=new $c({providers:o,parent:s,debugName:"",runEnvironmentInitializers:!1});return EN({r3Injector:a.injector,platformInjector:s,rootComponent:e})}catch(s){return Promise.reject(s)}finally{St(9)}}var qE=null;function as(){return qE}function fv(i){qE??=i}var su=class{},pv=(()=>{class i{historyGo(t){throw new Error("")}static \u0275fac=function(n){return new(n||i)};static \u0275prov=Me({token:i,factory:()=>ae(YE),providedIn:"platform"})}return i})();var YE=(()=>{class i extends pv{_location;_history;_doc=ae($n);constructor(){super(),this._location=window.location,this._history=window.history}getBaseHrefFromDOM(){return as().getBaseHref(this._doc)}onPopState(t){let n=as().getGlobalEventTarget(this._doc,"window");return n.addEventListener("popstate",t,!1),()=>n.removeEventListener("popstate",t)}onHashChange(t){let n=as().getGlobalEventTarget(this._doc,"window");return n.addEventListener("hashchange",t,!1),()=>n.removeEventListener("hashchange",t)}get href(){return this._location.href}get protocol(){return this._location.protocol}get hostname(){return this._location.hostname}get port(){return this._location.port}get pathname(){return this._location.pathname}get search(){return this._location.search}get hash(){return this._location.hash}set pathname(t){this._location.pathname=t}pushState(t,n,r){this._history.pushState(t,n,r)}replaceState(t,n,r){this._history.replaceState(t,n,r)}forward(){this._history.forward()}back(){this._history.back()}historyGo(t=0){this._history.go(t)}getState(){return this._history.state}static \u0275fac=function(n){return new(n||i)};static \u0275prov=Me({token:i,factory:()=>new i,providedIn:"platform"})}return i})();function KE(i,e){return i?e?i.endsWith("/")?e.startsWith("/")?i+e.slice(1):i+e:e.startsWith("/")?i+e:`${i}/${e}`:i:e}function WE(i){let e=i.search(/#|\?|$/);return i[e-1]==="/"?i.slice(0,e-1)+i.slice(e):i}function Bs(i){return i&&i[0]!=="?"?`?${i}`:i}var Of=(()=>{class i{historyGo(t){throw new Error("")}static \u0275fac=function(n){return new(n||i)};static \u0275prov=Me({token:i,factory:()=>ae(ZE),providedIn:"root"})}return i})(),XE=new Ve(""),ZE=(()=>{class i extends Of{_platformLocation;_baseHref;_removeListenerFns=[];constructor(t,n){super(),this._platformLocation=t,this._baseHref=n??this._platformLocation.getBaseHrefFromDOM()??ae($n).location?.origin??""}ngOnDestroy(){for(;this._removeListenerFns.length;)this._removeListenerFns.pop()()}onPopState(t){this._removeListenerFns.push(this._platformLocation.onPopState(t),this._platformLocation.onHashChange(t))}getBaseHref(){return this._baseHref}prepareExternalUrl(t){return KE(this._baseHref,t)}path(t=!1){let n=this._platformLocation.pathname+Bs(this._platformLocation.search),r=this._platformLocation.hash;return r&&t?`${n}${r}`:n}pushState(t,n,r,s){let o=this.prepareExternalUrl(r+Bs(s));this._platformLocation.pushState(t,n,o)}replaceState(t,n,r,s){let o=this.prepareExternalUrl(r+Bs(s));this._platformLocation.replaceState(t,n,o)}forward(){this._platformLocation.forward()}back(){this._platformLocation.back()}getState(){return this._platformLocation.getState()}historyGo(t=0){this._platformLocation.historyGo?.(t)}static \u0275fac=function(n){return new(n||i)(je(pv),je(XE,8))};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})(),pl=(()=>{class i{_subject=new Xt;_basePath;_locationStrategy;_urlChangeListeners=[];_urlChangeSubscription=null;constructor(t){this._locationStrategy=t;let n=this._locationStrategy.getBaseHref();this._basePath=FN(WE(jE(n))),this._locationStrategy.onPopState(r=>{this._subject.next({url:this.path(!0),pop:!0,state:r.state,type:r.type})})}ngOnDestroy(){this._urlChangeSubscription?.unsubscribe(),this._urlChangeListeners=[]}path(t=!1){return this.normalize(this._locationStrategy.path(t))}getState(){return this._locationStrategy.getState()}isCurrentPathEqualTo(t,n=""){return this.path()==this.normalize(t+Bs(n))}normalize(t){return i.stripTrailingSlash(LN(this._basePath,jE(t)))}prepareExternalUrl(t){return t&&t[0]!=="/"&&(t="/"+t),this._locationStrategy.prepareExternalUrl(t)}go(t,n="",r=null){this._locationStrategy.pushState(r,"",t,n),this._notifyUrlChangeListeners(this.prepareExternalUrl(t+Bs(n)),r)}replaceState(t,n="",r=null){this._locationStrategy.replaceState(r,"",t,n),this._notifyUrlChangeListeners(this.prepareExternalUrl(t+Bs(n)),r)}forward(){this._locationStrategy.forward()}back(){this._locationStrategy.back()}historyGo(t=0){this._locationStrategy.historyGo?.(t)}onUrlChange(t){return this._urlChangeListeners.push(t),this._urlChangeSubscription??=this.subscribe(n=>{this._notifyUrlChangeListeners(n.url,n.state)}),()=>{let n=this._urlChangeListeners.indexOf(t);this._urlChangeListeners.splice(n,1),this._urlChangeListeners.length===0&&(this._urlChangeSubscription?.unsubscribe(),this._urlChangeSubscription=null)}}_notifyUrlChangeListeners(t="",n){this._urlChangeListeners.forEach(r=>r(t,n))}subscribe(t,n,r){return this._subject.subscribe({next:t,error:n??void 0,complete:r??void 0})}static normalizeQueryParams=Bs;static joinWithSlash=KE;static stripTrailingSlash=WE;static \u0275fac=function(n){return new(n||i)(je(Of))};static \u0275prov=Me({token:i,factory:()=>NN(),providedIn:"root"})}return i})();function NN(){return new pl(je(Of))}function LN(i,e){if(!i||!e.startsWith(i))return e;let t=e.substring(i.length);return t===""||["/",";","?","#"].includes(t[0])?t:e}function jE(i){return i.replace(/\/index.html$/,"")}function FN(i){if(new RegExp("^(https?:)?//").test(i)){let[,t]=i.split(/\/\/[^\/]+/);return t}return i}function kN(i,e){return new Le(2100,!1)}var mv=class{createSubscription(e,t,n){return Hi(()=>e.subscribe({next:t,error:n}))}dispose(e){Hi(()=>e.unsubscribe())}},gv=class{createSubscription(e,t,n){return e.then(r=>t?.(r),r=>n?.(r)),{unsubscribe:()=>{t=null,n=null}}}dispose(e){e.unsubscribe()}},BN=new gv,VN=new mv,_v=(()=>{class i{_ref;_latestValue=null;markForCheckOnValueUpdate=!0;_subscription=null;_obj=null;_strategy=null;applicationErrorHandler=ae(zi);constructor(t){this._ref=t}ngOnDestroy(){this._subscription&&this._dispose(),this._ref=null}transform(t){if(!this._obj){if(t)try{this.markForCheckOnValueUpdate=!1,this._subscribe(t)}finally{this.markForCheckOnValueUpdate=!0}return this._latestValue}return t!==this._obj?(this._dispose(),this.transform(t)):this._latestValue}_subscribe(t){this._obj=t,this._strategy=this._selectStrategy(t),this._subscription=this._strategy.createSubscription(t,n=>this._updateLatestValue(t,n),n=>this.applicationErrorHandler(n))}_selectStrategy(t){if(Do(t))return BN;if(Ef(t))return VN;throw kN(i,t)}_dispose(){this._strategy.dispose(this._subscription),this._latestValue=null,this._subscription=null,this._obj=null}_updateLatestValue(t,n){t===this._obj&&(this._latestValue=n,this.markForCheckOnValueUpdate&&this._ref?.markForCheck())}static \u0275fac=function(n){return new(n||i)(Wt(Pf,16))};static \u0275pipe=sv({name:"async",type:i,pure:!1})}return i})();var ml=(()=>{class i{static \u0275fac=function(n){return new(n||i)};static \u0275mod=Zc({type:i});static \u0275inj=Wa({})}return i})();function yv(i,e){e=encodeURIComponent(e);for(let t of i.split(";")){let n=t.indexOf("="),[r,s]=n==-1?[t,""]:[t.slice(0,n),t.slice(n+1)];if(r.trim()===e)return decodeURIComponent(s)}return null}var ou=class{};var QE="browser";var au=class{_doc;constructor(e){this._doc=e}manager},Nf=(()=>{class i extends au{constructor(t){super(t)}supports(t){return!0}addEventListener(t,n,r,s){return t.addEventListener(n,r,s),()=>this.removeEventListener(t,n,r,s)}removeEventListener(t,n,r,s){return t.removeEventListener(n,r,s)}static \u0275fac=function(n){return new(n||i)(je($n))};static \u0275prov=Me({token:i,factory:i.\u0275fac})}return i})(),kf=new Ve(""),Cv=(()=>{class i{_zone;_plugins;_eventNameToPlugin=new Map;constructor(t,n){this._zone=n,t.forEach(o=>{o.manager=this});let r=t.filter(o=>!(o instanceof Nf));this._plugins=r.slice().reverse();let s=t.find(o=>o instanceof Nf);s&&this._plugins.push(s)}addEventListener(t,n,r,s){return this._findPluginFor(n).addEventListener(t,n,r,s)}getZone(){return this._zone}_findPluginFor(t){let n=this._eventNameToPlugin.get(t);if(n)return n;if(n=this._plugins.find(s=>s.supports(t)),!n)throw new Le(5101,!1);return this._eventNameToPlugin.set(t,n),n}static \u0275fac=function(n){return new(n||i)(je(kf),je(Et))};static \u0275prov=Me({token:i,factory:i.\u0275fac})}return i})(),vv="ng-app-id";function JE(i){for(let e of i)e.remove()}function eA(i,e){let t=e.createElement("style");return t.textContent=i,t}function zN(i,e,t,n){let r=i.head?.querySelectorAll(`style[${vv}="${e}"],link[${vv}="${e}"]`);if(r)for(let s of r)s.removeAttribute(vv),s instanceof HTMLLinkElement?n.set(s.href.slice(s.href.lastIndexOf("/")+1),{usage:0,elements:[s]}):s.textContent&&t.set(s.textContent,{usage:0,elements:[s]})}function xv(i,e){let t=e.createElement("link");return t.setAttribute("rel","stylesheet"),t.setAttribute("href",i),t}var Tv=(()=>{class i{doc;appId;nonce;inline=new Map;external=new Map;hosts=new Set;constructor(t,n,r,s={}){this.doc=t,this.appId=n,this.nonce=r,zN(t,n,this.inline,this.external),this.hosts.add(t.head)}addStyles(t,n){for(let r of t)this.addUsage(r,this.inline,eA);n?.forEach(r=>this.addUsage(r,this.external,xv))}removeStyles(t,n){for(let r of t)this.removeUsage(r,this.inline);n?.forEach(r=>this.removeUsage(r,this.external))}addUsage(t,n,r){let s=n.get(t);s?s.usage++:n.set(t,{usage:1,elements:[...this.hosts].map(o=>this.addElement(o,r(t,this.doc)))})}removeUsage(t,n){let r=n.get(t);r&&(r.usage--,r.usage<=0&&(JE(r.elements),n.delete(t)))}ngOnDestroy(){for(let[,{elements:t}]of[...this.inline,...this.external])JE(t);this.hosts.clear()}addHost(t){this.hosts.add(t);for(let[n,{elements:r}]of this.inline)r.push(this.addElement(t,eA(n,this.doc)));for(let[n,{elements:r}]of this.external)r.push(this.addElement(t,xv(n,this.doc)))}removeHost(t){this.hosts.delete(t)}addElement(t,n){return this.nonce&&n.setAttribute("nonce",this.nonce),t.appendChild(n)}static \u0275fac=function(n){return new(n||i)(je($n),je(pf),je(gf,8),je(qc))};static \u0275prov=Me({token:i,factory:i.\u0275fac})}return i})(),bv={svg:"http://www.w3.org/2000/svg",xhtml:"http://www.w3.org/1999/xhtml",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/",math:"http://www.w3.org/1998/Math/MathML"},Sv=/%COMP%/g;var nA="%COMP%",HN=`_nghost-${nA}`,$N=`_ngcontent-${nA}`,WN=!0,jN=new Ve("",{factory:()=>WN});function qN(i){return $N.replace(Sv,i)}function YN(i){return HN.replace(Sv,i)}function iA(i,e){return e.map(t=>t.replace(Sv,i))}var Iv=(()=>{class i{eventManager;sharedStylesHost;appId;removeStylesOnCompDestroy;doc;ngZone;nonce;tracingService;rendererByCompId=new Map;defaultRenderer;platformIsServer;constructor(t,n,r,s,o,a,l=null,c=null){this.eventManager=t,this.sharedStylesHost=n,this.appId=r,this.removeStylesOnCompDestroy=s,this.doc=o,this.ngZone=a,this.nonce=l,this.tracingService=c,this.platformIsServer=!1,this.defaultRenderer=new lu(t,o,a,this.platformIsServer,this.tracingService)}createRenderer(t,n){if(!t||!n)return this.defaultRenderer;let r=this.getOrCreateRenderer(t,n);return r instanceof Ff?r.applyToHost(t):r instanceof cu&&r.applyStyles(),r}getOrCreateRenderer(t,n){let r=this.rendererByCompId,s=r.get(n.id);if(!s){let o=this.doc,a=this.ngZone,l=this.eventManager,c=this.sharedStylesHost,u=this.removeStylesOnCompDestroy,h=this.platformIsServer,d=this.tracingService;switch(n.encapsulation){case rr.Emulated:s=new Ff(l,c,n,this.appId,u,o,a,h,d);break;case rr.ShadowDom:return new Lf(l,t,n,o,a,this.nonce,h,d,c);case rr.ExperimentalIsolatedShadowDom:return new Lf(l,t,n,o,a,this.nonce,h,d);default:s=new cu(l,c,n,u,o,a,h,d);break}r.set(n.id,s)}return s}ngOnDestroy(){this.rendererByCompId.clear()}componentReplaced(t){this.rendererByCompId.delete(t)}static \u0275fac=function(n){return new(n||i)(je(Cv),je(Tv),je(pf),je(jN),je($n),je(Et),je(gf),je(Yc,8))};static \u0275prov=Me({token:i,factory:i.\u0275fac})}return i})(),lu=class{eventManager;doc;ngZone;platformIsServer;tracingService;data=Object.create(null);throwOnSyntheticProps=!0;constructor(e,t,n,r,s){this.eventManager=e,this.doc=t,this.ngZone=n,this.platformIsServer=r,this.tracingService=s}destroy(){}destroyNode=null;createElement(e,t){return t?this.doc.createElementNS(bv[t]||t,e):this.doc.createElement(e)}createComment(e){return this.doc.createComment(e)}createText(e){return this.doc.createTextNode(e)}appendChild(e,t){(tA(e)?e.content:e).appendChild(t)}insertBefore(e,t,n){e&&(tA(e)?e.content:e).insertBefore(t,n)}removeChild(e,t){t.remove()}selectRootElement(e,t){let n=typeof e=="string"?this.doc.querySelector(e):e;if(!n)throw new Le(-5104,!1);return t||(n.textContent=""),n}parentNode(e){return e.parentNode}nextSibling(e){return e.nextSibling}setAttribute(e,t,n,r){if(r){t=r+":"+t;let s=bv[r];s?e.setAttributeNS(s,t,n):e.setAttribute(t,n)}else e.setAttribute(t,n)}removeAttribute(e,t,n){if(n){let r=bv[n];r?e.removeAttributeNS(r,t):e.removeAttribute(`${n}:${t}`)}else e.removeAttribute(t)}addClass(e,t){e.classList.add(t)}removeClass(e,t){e.classList.remove(t)}setStyle(e,t,n,r){r&(wr.DashCase|wr.Important)?e.style.setProperty(t,n,r&wr.Important?"important":""):e.style[t]=n}removeStyle(e,t,n){n&wr.DashCase?e.style.removeProperty(t):e.style[t]=""}setProperty(e,t,n){e!=null&&(e[t]=n)}setValue(e,t){e.nodeValue=t}listen(e,t,n,r){if(typeof e=="string"&&(e=as().getGlobalEventTarget(this.doc,e),!e))throw new Le(5102,!1);let s=this.decoratePreventDefault(n);return this.tracingService?.wrapEventListener&&(s=this.tracingService.wrapEventListener(e,t,s)),this.eventManager.addEventListener(e,t,s,r)}decoratePreventDefault(e){return t=>{if(t==="__ngUnwrap__")return e;e(t)===!1&&t.preventDefault()}}};function tA(i){return i.tagName==="TEMPLATE"&&i.content!==void 0}var Lf=class extends lu{hostEl;sharedStylesHost;shadowRoot;constructor(e,t,n,r,s,o,a,l,c){super(e,r,s,a,l),this.hostEl=t,this.sharedStylesHost=c,this.shadowRoot=t.attachShadow({mode:"open"}),this.sharedStylesHost&&this.sharedStylesHost.addHost(this.shadowRoot);let u=n.styles;u=iA(n.id,u);for(let d of u){let f=document.createElement("style");o&&f.setAttribute("nonce",o),f.textContent=d,this.shadowRoot.appendChild(f)}let h=n.getExternalStyles?.();if(h)for(let d of h){let f=xv(d,r);o&&f.setAttribute("nonce",o),this.shadowRoot.appendChild(f)}}nodeOrShadowRoot(e){return e===this.hostEl?this.shadowRoot:e}appendChild(e,t){return super.appendChild(this.nodeOrShadowRoot(e),t)}insertBefore(e,t,n){return super.insertBefore(this.nodeOrShadowRoot(e),t,n)}removeChild(e,t){return super.removeChild(null,t)}parentNode(e){return this.nodeOrShadowRoot(super.parentNode(this.nodeOrShadowRoot(e)))}destroy(){this.sharedStylesHost&&this.sharedStylesHost.removeHost(this.shadowRoot)}},cu=class extends lu{sharedStylesHost;removeStylesOnCompDestroy;styles;styleUrls;constructor(e,t,n,r,s,o,a,l,c){super(e,s,o,a,l),this.sharedStylesHost=t,this.removeStylesOnCompDestroy=r;let u=n.styles;this.styles=c?iA(c,u):u,this.styleUrls=n.getExternalStyles?.(c)}applyStyles(){this.sharedStylesHost.addStyles(this.styles,this.styleUrls)}destroy(){this.removeStylesOnCompDestroy&&Io.size===0&&this.sharedStylesHost.removeStyles(this.styles,this.styleUrls)}},Ff=class extends cu{contentAttr;hostAttr;constructor(e,t,n,r,s,o,a,l,c){let u=r+"-"+n.id;super(e,t,n,s,o,a,l,c,u),this.contentAttr=qN(u),this.hostAttr=YN(u)}applyToHost(e){this.applyStyles(),this.setAttribute(e,this.hostAttr,"")}createElement(e,t){let n=super.createElement(e,t);return super.setAttribute(n,this.contentAttr,""),n}};var Bf=class i extends su{supportsDOMEvents=!0;static makeCurrent(){fv(new i)}onAndCancel(e,t,n,r){return e.addEventListener(t,n,r),()=>{e.removeEventListener(t,n,r)}}dispatchEvent(e,t){e.dispatchEvent(t)}remove(e){e.remove()}createElement(e,t){return t=t||this.getDefaultDocument(),t.createElement(e)}createHtmlDocument(){return document.implementation.createHTMLDocument("fakeTitle")}getDefaultDocument(){return document}isElementNode(e){return e.nodeType===Node.ELEMENT_NODE}isShadowRoot(e){return e instanceof DocumentFragment}getGlobalEventTarget(e,t){return t==="window"?window:t==="document"?e:t==="body"?e.body:null}getBaseHref(e){let t=KN();return t==null?null:XN(t)}resetBaseElement(){uu=null}getUserAgent(){return window.navigator.userAgent}getCookie(e){return yv(document.cookie,e)}},uu=null;function KN(){return uu=uu||document.head.querySelector("base"),uu?uu.getAttribute("href"):null}function XN(i){return new URL(i,document.baseURI).pathname}var ZN=(()=>{class i{build(){return new XMLHttpRequest}static \u0275fac=function(n){return new(n||i)};static \u0275prov=Me({token:i,factory:i.\u0275fac})}return i})(),rA=["alt","control","meta","shift"],QN={"\b":"Backspace","	":"Tab","\x7F":"Delete","\x1B":"Escape",Del:"Delete",Esc:"Escape",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Down:"ArrowDown",Menu:"ContextMenu",Scroll:"ScrollLock",Win:"OS"},JN={alt:i=>i.altKey,control:i=>i.ctrlKey,meta:i=>i.metaKey,shift:i=>i.shiftKey},sA=(()=>{class i extends au{constructor(t){super(t)}supports(t){return i.parseEventName(t)!=null}addEventListener(t,n,r,s){let o=i.parseEventName(n),a=i.eventCallback(o.fullKey,r,this.manager.getZone());return this.manager.getZone().runOutsideAngular(()=>as().onAndCancel(t,o.domEventName,a,s))}static parseEventName(t){let n=t.toLowerCase().split("."),r=n.shift();if(n.length===0||!(r==="keydown"||r==="keyup"))return null;let s=i._normalizeKey(n.pop()),o="",a=n.indexOf("code");if(a>-1&&(n.splice(a,1),o="code."),rA.forEach(c=>{let u=n.indexOf(c);u>-1&&(n.splice(u,1),o+=c+".")}),o+=s,n.length!=0||s.length===0)return null;let l={};return l.domEventName=r,l.fullKey=o,l}static matchEventFullKeyCode(t,n){let r=QN[t.key]||t.key,s="";return n.indexOf("code.")>-1&&(r=t.code,s="code."),r==null||!r?!1:(r=r.toLowerCase(),r===" "?r="space":r==="."&&(r="dot"),rA.forEach(o=>{if(o!==r){let a=JN[o];a(t)&&(s+=o+".")}}),s+=r,s===n)}static eventCallback(t,n,r){return s=>{i.matchEventFullKeyCode(s,t)&&r.runGuarded(()=>n(s))}}static _normalizeKey(t){return t==="esc"?"escape":t}static \u0275fac=function(n){return new(n||i)(je($n))};static \u0275prov=Me({token:i,factory:i.\u0275fac})}return i})();function Ev(i,e,t){let n=K({rootComponent:i,platformRef:t?.platformRef},eL(e));return $E(n)}function eL(i){return{appProviders:[...sL,...i?.providers??[]],platformProviders:rL}}function tL(){Bf.makeCurrent()}function nL(){return new ts}function iL(){return Uy(document),document}var rL=[{provide:qc,useValue:QE},{provide:mf,useValue:tL,multi:!0},{provide:$n,useFactory:iL}];var sL=[{provide:Mc,useValue:"root"},{provide:ts,useFactory:nL},{provide:kf,useClass:Nf,multi:!0},{provide:kf,useClass:sA,multi:!0},Iv,Tv,Cv,{provide:Eo,useExisting:Iv},{provide:ou,useClass:ZN},[]];var oA=(()=>{class i{_doc;constructor(t){this._doc=t}getTitle(){return this._doc.title}setTitle(t){this._doc.title=t||""}static \u0275fac=function(n){return new(n||i)(je($n))};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();var Ue="primary",Tu=Symbol("RouteTitle"),Rv=class{params;constructor(e){this.params=e||{}}has(e){return Object.prototype.hasOwnProperty.call(this.params,e)}get(e){if(this.has(e)){let t=this.params[e];return Array.isArray(t)?t[0]:t}return null}getAll(e){if(this.has(e)){let t=this.params[e];return Array.isArray(t)?t:[t]}return[]}get keys(){return Object.keys(this.params)}};function Lo(i){return new Rv(i)}function mA(i,e,t){let n=t.path.split("/");if(n.length>i.length||t.pathMatch==="full"&&(e.hasChildren()||n.length<i.length))return null;let r={};for(let s=0;s<n.length;s++){let o=n[s],a=i[s];if(o[0]===":")r[o.substring(1)]=a;else if(o!==a.path)return null}return{consumed:i.slice(0,n.length),posParams:r}}function $f(i){return new Promise((e,t)=>{i.pipe(Qr()).subscribe({next:n=>e(n),error:n=>t(n)})})}function aL(i,e){if(i.length!==e.length)return!1;for(let t=0;t<i.length;++t)if(!Or(i[t],e[t]))return!1;return!0}function Or(i,e){let t=i?Pv(i):void 0,n=e?Pv(e):void 0;if(!t||!n||t.length!=n.length)return!1;let r;for(let s=0;s<t.length;s++)if(r=t[s],!gA(i[r],e[r]))return!1;return!0}function Pv(i){return[...Object.keys(i),...Object.getOwnPropertySymbols(i)]}function gA(i,e){if(Array.isArray(i)&&Array.isArray(e)){if(i.length!==e.length)return!1;let t=[...i].sort(),n=[...e].sort();return t.every((r,s)=>n[s]===r)}else return i===e}function _A(i){return i.length>0?i[i.length-1]:null}function ko(i){return dd(i)?i:Do(i)?cn(Promise.resolve(i)):Je(i)}function yA(i){return dd(i)?$f(i):Promise.resolve(i)}var lL={exact:bA,subset:xA},vA={exact:cL,subset:uL,ignored:()=>!0};function aA(i,e,t){return lL[t.paths](i.root,e.root,t.matrixParams)&&vA[t.queryParams](i.queryParams,e.queryParams)&&!(t.fragment==="exact"&&i.fragment!==e.fragment)}function cL(i,e){return Or(i,e)}function bA(i,e,t){if(!Oo(i.segments,e.segments)||!Uf(i.segments,e.segments,t)||i.numberOfChildren!==e.numberOfChildren)return!1;for(let n in e.children)if(!i.children[n]||!bA(i.children[n],e.children[n],t))return!1;return!0}function uL(i,e){return Object.keys(e).length<=Object.keys(i).length&&Object.keys(e).every(t=>gA(i[t],e[t]))}function xA(i,e,t){return CA(i,e,e.segments,t)}function CA(i,e,t,n){if(i.segments.length>t.length){let r=i.segments.slice(0,t.length);return!(!Oo(r,t)||e.hasChildren()||!Uf(r,t,n))}else if(i.segments.length===t.length){if(!Oo(i.segments,t)||!Uf(i.segments,t,n))return!1;for(let r in e.children)if(!i.children[r]||!xA(i.children[r],e.children[r],n))return!1;return!0}else{let r=t.slice(0,i.segments.length),s=t.slice(i.segments.length);return!Oo(i.segments,r)||!Uf(i.segments,r,n)||!i.children[Ue]?!1:CA(i.children[Ue],e,s,n)}}function Uf(i,e,t){return e.every((n,r)=>vA[t](i[r].parameters,n.parameters))}var ar=class{root;queryParams;fragment;_queryParamMap;constructor(e=new ut([],{}),t={},n=null){this.root=e,this.queryParams=t,this.fragment=n}get queryParamMap(){return this._queryParamMap??=Lo(this.queryParams),this._queryParamMap}toString(){return fL.serialize(this)}},ut=class{segments;children;parent=null;constructor(e,t){this.segments=e,this.children=t,Object.values(t).forEach(n=>n.parent=this)}hasChildren(){return this.numberOfChildren>0}get numberOfChildren(){return Object.keys(this.children).length}toString(){return zf(this)}},Vs=class{path;parameters;_parameterMap;constructor(e,t){this.path=e,this.parameters=t}get parameterMap(){return this._parameterMap??=Lo(this.parameters),this._parameterMap}toString(){return SA(this)}};function hL(i,e){return Oo(i,e)&&i.every((t,n)=>Or(t.parameters,e[n].parameters))}function Oo(i,e){return i.length!==e.length?!1:i.every((t,n)=>t.path===e[n].path)}function dL(i,e){let t=[];return Object.entries(i.children).forEach(([n,r])=>{n===Ue&&(t=t.concat(e(r,n)))}),Object.entries(i.children).forEach(([n,r])=>{n!==Ue&&(t=t.concat(e(r,n)))}),t}var Su=(()=>{class i{static \u0275fac=function(n){return new(n||i)};static \u0275prov=Me({token:i,factory:()=>new Gs,providedIn:"root"})}return i})(),Gs=class{parse(e){let t=new Nv(e);return new ar(t.parseRootSegment(),t.parseQueryParams(),t.parseFragment())}serialize(e){let t=`/${hu(e.root,!0)}`,n=gL(e.queryParams),r=typeof e.fragment=="string"?`#${pL(e.fragment)}`:"";return`${t}${n}${r}`}},fL=new Gs;function zf(i){return i.segments.map(e=>SA(e)).join("/")}function hu(i,e){if(!i.hasChildren())return zf(i);if(e){let t=i.children[Ue]?hu(i.children[Ue],!1):"",n=[];return Object.entries(i.children).forEach(([r,s])=>{r!==Ue&&n.push(`${r}:${hu(s,!1)}`)}),n.length>0?`${t}(${n.join("//")})`:t}else{let t=dL(i,(n,r)=>r===Ue?[hu(i.children[Ue],!1)]:[`${r}:${hu(n,!1)}`]);return Object.keys(i.children).length===1&&i.children[Ue]!=null?`${zf(i)}/${t[0]}`:`${zf(i)}/(${t.join("//")})`}}function TA(i){return encodeURIComponent(i).replace(/%40/g,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",")}function Vf(i){return TA(i).replace(/%3B/gi,";")}function pL(i){return encodeURI(i)}function Ov(i){return TA(i).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/%26/gi,"&")}function Hf(i){return decodeURIComponent(i)}function lA(i){return Hf(i.replace(/\+/g,"%20"))}function SA(i){return`${Ov(i.path)}${mL(i.parameters)}`}function mL(i){return Object.entries(i).map(([e,t])=>`;${Ov(e)}=${Ov(t)}`).join("")}function gL(i){let e=Object.entries(i).map(([t,n])=>Array.isArray(n)?n.map(r=>`${Vf(t)}=${Vf(r)}`).join("&"):`${Vf(t)}=${Vf(n)}`).filter(t=>t);return e.length?`?${e.join("&")}`:""}var _L=/^[^\/()?;#]+/;function Av(i){let e=i.match(_L);return e?e[0]:""}var yL=/^[^\/()?;=#]+/;function vL(i){let e=i.match(yL);return e?e[0]:""}var bL=/^[^=?&#]+/;function xL(i){let e=i.match(bL);return e?e[0]:""}var CL=/^[^&#]+/;function TL(i){let e=i.match(CL);return e?e[0]:""}var Nv=class{url;remaining;constructor(e){this.url=e,this.remaining=e}parseRootSegment(){return this.consumeOptional("/"),this.remaining===""||this.peekStartsWith("?")||this.peekStartsWith("#")?new ut([],{}):new ut([],this.parseChildren())}parseQueryParams(){let e={};if(this.consumeOptional("?"))do this.parseQueryParam(e);while(this.consumeOptional("&"));return e}parseFragment(){return this.consumeOptional("#")?decodeURIComponent(this.remaining):null}parseChildren(){if(this.remaining==="")return{};this.consumeOptional("/");let e=[];for(this.peekStartsWith("(")||e.push(this.parseSegment());this.peekStartsWith("/")&&!this.peekStartsWith("//")&&!this.peekStartsWith("/(");)this.capture("/"),e.push(this.parseSegment());let t={};this.peekStartsWith("/(")&&(this.capture("/"),t=this.parseParens(!0));let n={};return this.peekStartsWith("(")&&(n=this.parseParens(!1)),(e.length>0||Object.keys(t).length>0)&&(n[Ue]=new ut(e,t)),n}parseSegment(){let e=Av(this.remaining);if(e===""&&this.peekStartsWith(";"))throw new Le(4009,!1);return this.capture(e),new Vs(Hf(e),this.parseMatrixParams())}parseMatrixParams(){let e={};for(;this.consumeOptional(";");)this.parseParam(e);return e}parseParam(e){let t=vL(this.remaining);if(!t)return;this.capture(t);let n="";if(this.consumeOptional("=")){let r=Av(this.remaining);r&&(n=r,this.capture(n))}e[Hf(t)]=Hf(n)}parseQueryParam(e){let t=xL(this.remaining);if(!t)return;this.capture(t);let n="";if(this.consumeOptional("=")){let o=TL(this.remaining);o&&(n=o,this.capture(n))}let r=lA(t),s=lA(n);if(e.hasOwnProperty(r)){let o=e[r];Array.isArray(o)||(o=[o],e[r]=o),o.push(s)}else e[r]=s}parseParens(e){let t={};for(this.capture("(");!this.consumeOptional(")")&&this.remaining.length>0;){let n=Av(this.remaining),r=this.remaining[n.length];if(r!=="/"&&r!==")"&&r!==";")throw new Le(4010,!1);let s;n.indexOf(":")>-1?(s=n.slice(0,n.indexOf(":")),this.capture(s),this.capture(":")):e&&(s=Ue);let o=this.parseChildren();t[s??Ue]=Object.keys(o).length===1&&o[Ue]?o[Ue]:new ut([],o),this.consumeOptional("//")}return t}peekStartsWith(e){return this.remaining.startsWith(e)}consumeOptional(e){return this.peekStartsWith(e)?(this.remaining=this.remaining.substring(e.length),!0):!1}capture(e){if(!this.consumeOptional(e))throw new Le(4011,!1)}};function IA(i){return i.segments.length>0?new ut([],{[Ue]:i}):i}function EA(i){let e={};for(let[n,r]of Object.entries(i.children)){let s=EA(r);if(n===Ue&&s.segments.length===0&&s.hasChildren())for(let[o,a]of Object.entries(s.children))e[o]=a;else(s.segments.length>0||s.hasChildren())&&(e[n]=s)}let t=new ut(i.segments,e);return SL(t)}function SL(i){if(i.numberOfChildren===1&&i.children[Ue]){let e=i.children[Ue];return new ut(i.segments.concat(e.segments),e.children)}return i}function vl(i){return i instanceof ar}function AA(i,e,t=null,n=null,r=new Gs){let s=wA(i);return MA(s,e,t,n,r)}function wA(i){let e;function t(s){let o={};for(let l of s.children){let c=t(l);o[l.outlet]=c}let a=new ut(s.url,o);return s===i&&(e=a),a}let n=t(i.root),r=IA(n);return e??r}function MA(i,e,t,n,r){let s=i;for(;s.parent;)s=s.parent;if(e.length===0)return wv(s,s,s,t,n,r);let o=IL(e);if(o.toRoot())return wv(s,s,new ut([],{}),t,n,r);let a=EL(o,s,i),l=a.processChildren?fu(a.segmentGroup,a.index,o.commands):RA(a.segmentGroup,a.index,o.commands);return wv(s,a.segmentGroup,l,t,n,r)}function Wf(i){return typeof i=="object"&&i!=null&&!i.outlets&&!i.segmentPath}function gu(i){return typeof i=="object"&&i!=null&&i.outlets}function cA(i,e,t){i||="\u0275";let n=new ar;return n.queryParams={[i]:e},t.parse(t.serialize(n)).queryParams[i]}function wv(i,e,t,n,r,s){let o={};for(let[c,u]of Object.entries(n??{}))o[c]=Array.isArray(u)?u.map(h=>cA(c,h,s)):cA(c,u,s);let a;i===e?a=t:a=DA(i,e,t);let l=IA(EA(a));return new ar(l,o,r)}function DA(i,e,t){let n={};return Object.entries(i.children).forEach(([r,s])=>{s===e?n[r]=t:n[r]=DA(s,e,t)}),new ut(i.segments,n)}var jf=class{isAbsolute;numberOfDoubleDots;commands;constructor(e,t,n){if(this.isAbsolute=e,this.numberOfDoubleDots=t,this.commands=n,e&&n.length>0&&Wf(n[0]))throw new Le(4003,!1);let r=n.find(gu);if(r&&r!==_A(n))throw new Le(4004,!1)}toRoot(){return this.isAbsolute&&this.commands.length===1&&this.commands[0]=="/"}};function IL(i){if(typeof i[0]=="string"&&i.length===1&&i[0]==="/")return new jf(!0,0,i);let e=0,t=!1,n=i.reduce((r,s,o)=>{if(typeof s=="object"&&s!=null){if(s.outlets){let a={};return Object.entries(s.outlets).forEach(([l,c])=>{a[l]=typeof c=="string"?c.split("/"):c}),[...r,{outlets:a}]}if(s.segmentPath)return[...r,s.segmentPath]}return typeof s!="string"?[...r,s]:o===0?(s.split("/").forEach((a,l)=>{l==0&&a==="."||(l==0&&a===""?t=!0:a===".."?e++:a!=""&&r.push(a))}),r):[...r,s]},[]);return new jf(t,e,n)}var _l=class{segmentGroup;processChildren;index;constructor(e,t,n){this.segmentGroup=e,this.processChildren=t,this.index=n}};function EL(i,e,t){if(i.isAbsolute)return new _l(e,!0,0);if(!t)return new _l(e,!1,NaN);if(t.parent===null)return new _l(t,!0,0);let n=Wf(i.commands[0])?0:1,r=t.segments.length-1+n;return AL(t,r,i.numberOfDoubleDots)}function AL(i,e,t){let n=i,r=e,s=t;for(;s>r;){if(s-=r,n=n.parent,!n)throw new Le(4005,!1);r=n.segments.length}return new _l(n,!1,r-s)}function wL(i){return gu(i[0])?i[0].outlets:{[Ue]:i}}function RA(i,e,t){if(i??=new ut([],{}),i.segments.length===0&&i.hasChildren())return fu(i,e,t);let n=ML(i,e,t),r=t.slice(n.commandIndex);if(n.match&&n.pathIndex<i.segments.length){let s=new ut(i.segments.slice(0,n.pathIndex),{});return s.children[Ue]=new ut(i.segments.slice(n.pathIndex),i.children),fu(s,0,r)}else return n.match&&r.length===0?new ut(i.segments,{}):n.match&&!i.hasChildren()?Lv(i,e,t):n.match?fu(i,0,r):Lv(i,e,t)}function fu(i,e,t){if(t.length===0)return new ut(i.segments,{});{let n=wL(t),r={};if(Object.keys(n).some(s=>s!==Ue)&&i.children[Ue]&&i.numberOfChildren===1&&i.children[Ue].segments.length===0){let s=fu(i.children[Ue],e,t);return new ut(i.segments,s.children)}return Object.entries(n).forEach(([s,o])=>{typeof o=="string"&&(o=[o]),o!==null&&(r[s]=RA(i.children[s],e,o))}),Object.entries(i.children).forEach(([s,o])=>{n[s]===void 0&&(r[s]=o)}),new ut(i.segments,r)}}function ML(i,e,t){let n=0,r=e,s={match:!1,pathIndex:0,commandIndex:0};for(;r<i.segments.length;){if(n>=t.length)return s;let o=i.segments[r],a=t[n];if(gu(a))break;let l=`${a}`,c=n<t.length-1?t[n+1]:null;if(r>0&&l===void 0)break;if(l&&c&&typeof c=="object"&&c.outlets===void 0){if(!hA(l,c,o))return s;n+=2}else{if(!hA(l,{},o))return s;n++}r++}return{match:!0,pathIndex:r,commandIndex:n}}function Lv(i,e,t){let n=i.segments.slice(0,e),r=0;for(;r<t.length;){let s=t[r];if(gu(s)){let l=DL(s.outlets);return new ut(n,l)}if(r===0&&Wf(t[0])){let l=i.segments[e];n.push(new Vs(l.path,uA(t[0]))),r++;continue}let o=gu(s)?s.outlets[Ue]:`${s}`,a=r<t.length-1?t[r+1]:null;o&&a&&Wf(a)?(n.push(new Vs(o,uA(a))),r+=2):(n.push(new Vs(o,{})),r++)}return new ut(n,{})}function DL(i){let e={};return Object.entries(i).forEach(([t,n])=>{typeof n=="string"&&(n=[n]),n!==null&&(e[t]=Lv(new ut([],{}),0,n))}),e}function uA(i){let e={};return Object.entries(i).forEach(([t,n])=>e[t]=`${n}`),e}function hA(i,e,t){return i==t.path&&Or(e,t.parameters)}var pu="imperative",fn=(function(i){return i[i.NavigationStart=0]="NavigationStart",i[i.NavigationEnd=1]="NavigationEnd",i[i.NavigationCancel=2]="NavigationCancel",i[i.NavigationError=3]="NavigationError",i[i.RoutesRecognized=4]="RoutesRecognized",i[i.ResolveStart=5]="ResolveStart",i[i.ResolveEnd=6]="ResolveEnd",i[i.GuardsCheckStart=7]="GuardsCheckStart",i[i.GuardsCheckEnd=8]="GuardsCheckEnd",i[i.RouteConfigLoadStart=9]="RouteConfigLoadStart",i[i.RouteConfigLoadEnd=10]="RouteConfigLoadEnd",i[i.ChildActivationStart=11]="ChildActivationStart",i[i.ChildActivationEnd=12]="ChildActivationEnd",i[i.ActivationStart=13]="ActivationStart",i[i.ActivationEnd=14]="ActivationEnd",i[i.Scroll=15]="Scroll",i[i.NavigationSkipped=16]="NavigationSkipped",i})(fn||{}),Si=class{id;url;constructor(e,t){this.id=e,this.url=t}},Fo=class extends Si{type=fn.NavigationStart;navigationTrigger;restoredState;constructor(e,t,n="imperative",r=null){super(e,t),this.navigationTrigger=n,this.restoredState=r}toString(){return`NavigationStart(id: ${this.id}, url: '${this.url}')`}},ls=class extends Si{urlAfterRedirects;type=fn.NavigationEnd;constructor(e,t,n){super(e,t),this.urlAfterRedirects=n}toString(){return`NavigationEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}')`}},Wn=(function(i){return i[i.Redirect=0]="Redirect",i[i.SupersededByNewNavigation=1]="SupersededByNewNavigation",i[i.NoDataFromResolver=2]="NoDataFromResolver",i[i.GuardRejected=3]="GuardRejected",i[i.Aborted=4]="Aborted",i})(Wn||{}),_u=(function(i){return i[i.IgnoredSameUrlNavigation=0]="IgnoredSameUrlNavigation",i[i.IgnoredByUrlHandlingStrategy=1]="IgnoredByUrlHandlingStrategy",i})(_u||{}),Nr=class extends Si{reason;code;type=fn.NavigationCancel;constructor(e,t,n,r){super(e,t),this.reason=n,this.code=r}toString(){return`NavigationCancel(id: ${this.id}, url: '${this.url}')`}},cs=class extends Si{reason;code;type=fn.NavigationSkipped;constructor(e,t,n,r){super(e,t),this.reason=n,this.code=r}},bl=class extends Si{error;target;type=fn.NavigationError;constructor(e,t,n,r){super(e,t),this.error=n,this.target=r}toString(){return`NavigationError(id: ${this.id}, url: '${this.url}', error: ${this.error})`}},yu=class extends Si{urlAfterRedirects;state;type=fn.RoutesRecognized;constructor(e,t,n,r){super(e,t),this.urlAfterRedirects=n,this.state=r}toString(){return`RoutesRecognized(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},qf=class extends Si{urlAfterRedirects;state;type=fn.GuardsCheckStart;constructor(e,t,n,r){super(e,t),this.urlAfterRedirects=n,this.state=r}toString(){return`GuardsCheckStart(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},Yf=class extends Si{urlAfterRedirects;state;shouldActivate;type=fn.GuardsCheckEnd;constructor(e,t,n,r,s){super(e,t),this.urlAfterRedirects=n,this.state=r,this.shouldActivate=s}toString(){return`GuardsCheckEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state}, shouldActivate: ${this.shouldActivate})`}},Kf=class extends Si{urlAfterRedirects;state;type=fn.ResolveStart;constructor(e,t,n,r){super(e,t),this.urlAfterRedirects=n,this.state=r}toString(){return`ResolveStart(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},Xf=class extends Si{urlAfterRedirects;state;type=fn.ResolveEnd;constructor(e,t,n,r){super(e,t),this.urlAfterRedirects=n,this.state=r}toString(){return`ResolveEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},Zf=class{route;type=fn.RouteConfigLoadStart;constructor(e){this.route=e}toString(){return`RouteConfigLoadStart(path: ${this.route.path})`}},Qf=class{route;type=fn.RouteConfigLoadEnd;constructor(e){this.route=e}toString(){return`RouteConfigLoadEnd(path: ${this.route.path})`}},Jf=class{snapshot;type=fn.ChildActivationStart;constructor(e){this.snapshot=e}toString(){return`ChildActivationStart(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},ep=class{snapshot;type=fn.ChildActivationEnd;constructor(e){this.snapshot=e}toString(){return`ChildActivationEnd(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},tp=class{snapshot;type=fn.ActivationStart;constructor(e){this.snapshot=e}toString(){return`ActivationStart(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},np=class{snapshot;type=fn.ActivationEnd;constructor(e){this.snapshot=e}toString(){return`ActivationEnd(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}};var vu=class{},xl=class{url;navigationBehaviorOptions;constructor(e,t){this.url=e,this.navigationBehaviorOptions=t}};function RL(i){return!(i instanceof vu)&&!(i instanceof xl)}function PL(i,e){return i.providers&&!i._injector&&(i._injector=Xc(i.providers,e,`Route: ${i.path}`)),i._injector??e}function or(i){return i.outlet||Ue}function OL(i,e){let t=i.filter(n=>or(n)===e);return t.push(...i.filter(n=>or(n)!==e)),t}function Sl(i){if(!i)return null;if(i.routeConfig?._injector)return i.routeConfig._injector;for(let e=i.parent;e;e=e.parent){let t=e.routeConfig;if(t?._loadedInjector)return t._loadedInjector;if(t?._injector)return t._injector}return null}var ip=class{rootInjector;outlet=null;route=null;children;attachRef=null;get injector(){return Sl(this.route?.snapshot)??this.rootInjector}constructor(e){this.rootInjector=e,this.children=new Il(this.rootInjector)}},Il=(()=>{class i{rootInjector;contexts=new Map;constructor(t){this.rootInjector=t}onChildOutletCreated(t,n){let r=this.getOrCreateContext(t);r.outlet=n,this.contexts.set(t,r)}onChildOutletDestroyed(t){let n=this.getContext(t);n&&(n.outlet=null,n.attachRef=null)}onOutletDeactivated(){let t=this.contexts;return this.contexts=new Map,t}onOutletReAttached(t){this.contexts=t}getOrCreateContext(t){let n=this.getContext(t);return n||(n=new ip(this.rootInjector),this.contexts.set(t,n)),n}getContext(t){return this.contexts.get(t)||null}static \u0275fac=function(n){return new(n||i)(je(An))};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})(),rp=class{_root;constructor(e){this._root=e}get root(){return this._root.value}parent(e){let t=this.pathFromRoot(e);return t.length>1?t[t.length-2]:null}children(e){let t=Fv(e,this._root);return t?t.children.map(n=>n.value):[]}firstChild(e){let t=Fv(e,this._root);return t&&t.children.length>0?t.children[0].value:null}siblings(e){let t=kv(e,this._root);return t.length<2?[]:t[t.length-2].children.map(r=>r.value).filter(r=>r!==e)}pathFromRoot(e){return kv(e,this._root).map(t=>t.value)}};function Fv(i,e){if(i===e.value)return e;for(let t of e.children){let n=Fv(i,t);if(n)return n}return null}function kv(i,e){if(i===e.value)return[e];for(let t of e.children){let n=kv(i,t);if(n.length)return n.unshift(e),n}return[]}var Ti=class{value;children;constructor(e,t){this.value=e,this.children=t}toString(){return`TreeNode(${this.value})`}};function gl(i){let e={};return i&&i.children.forEach(t=>e[t.value.outlet]=t),e}var bu=class extends rp{snapshot;constructor(e,t){super(e),this.snapshot=t,Hv(this,e)}toString(){return this.snapshot.toString()}};function PA(i){let e=NL(i),t=new Dt([new Vs("",{})]),n=new Dt({}),r=new Dt({}),s=new Dt({}),o=new Dt(""),a=new Us(t,n,s,o,r,Ue,i,e.root);return a.snapshot=e.root,new bu(new Ti(a,[]),e)}function NL(i){let e={},t={},n={},s=new No([],e,n,"",t,Ue,i,null,{});return new xu("",new Ti(s,[]))}var Us=class{urlSubject;paramsSubject;queryParamsSubject;fragmentSubject;dataSubject;outlet;component;snapshot;_futureSnapshot;_routerState;_paramMap;_queryParamMap;title;url;params;queryParams;fragment;data;constructor(e,t,n,r,s,o,a,l){this.urlSubject=e,this.paramsSubject=t,this.queryParamsSubject=n,this.fragmentSubject=r,this.dataSubject=s,this.outlet=o,this.component=a,this._futureSnapshot=l,this.title=this.dataSubject?.pipe(It(c=>c[Tu]))??Je(void 0),this.url=e,this.params=t,this.queryParams=n,this.fragment=r,this.data=s}get routeConfig(){return this._futureSnapshot.routeConfig}get root(){return this._routerState.root}get parent(){return this._routerState.parent(this)}get firstChild(){return this._routerState.firstChild(this)}get children(){return this._routerState.children(this)}get pathFromRoot(){return this._routerState.pathFromRoot(this)}get paramMap(){return this._paramMap??=this.params.pipe(It(e=>Lo(e))),this._paramMap}get queryParamMap(){return this._queryParamMap??=this.queryParams.pipe(It(e=>Lo(e))),this._queryParamMap}toString(){return this.snapshot?this.snapshot.toString():`Future(${this._futureSnapshot})`}};function sp(i,e,t="emptyOnly"){let n,{routeConfig:r}=i;return e!==null&&(t==="always"||r?.path===""||!e.component&&!e.routeConfig?.loadComponent)?n={params:K(K({},e.params),i.params),data:K(K({},e.data),i.data),resolve:K(K(K(K({},i.data),e.data),r?.data),i._resolvedData)}:n={params:K({},i.params),data:K({},i.data),resolve:K(K({},i.data),i._resolvedData??{})},r&&NA(r)&&(n.resolve[Tu]=r.title),n}var No=class{url;params;queryParams;fragment;data;outlet;component;routeConfig;_resolve;_resolvedData;_routerState;_paramMap;_queryParamMap;get title(){return this.data?.[Tu]}constructor(e,t,n,r,s,o,a,l,c){this.url=e,this.params=t,this.queryParams=n,this.fragment=r,this.data=s,this.outlet=o,this.component=a,this.routeConfig=l,this._resolve=c}get root(){return this._routerState.root}get parent(){return this._routerState.parent(this)}get firstChild(){return this._routerState.firstChild(this)}get children(){return this._routerState.children(this)}get pathFromRoot(){return this._routerState.pathFromRoot(this)}get paramMap(){return this._paramMap??=Lo(this.params),this._paramMap}get queryParamMap(){return this._queryParamMap??=Lo(this.queryParams),this._queryParamMap}toString(){let e=this.url.map(n=>n.toString()).join("/"),t=this.routeConfig?this.routeConfig.path:"";return`Route(url:'${e}', path:'${t}')`}},xu=class extends rp{url;constructor(e,t){super(t),this.url=e,Hv(this,t)}toString(){return OA(this._root)}};function Hv(i,e){e.value._routerState=i,e.children.forEach(t=>Hv(i,t))}function OA(i){let e=i.children.length>0?` { ${i.children.map(OA).join(", ")} } `:"";return`${i.value}${e}`}function Mv(i){if(i.snapshot){let e=i.snapshot,t=i._futureSnapshot;i.snapshot=t,Or(e.queryParams,t.queryParams)||i.queryParamsSubject.next(t.queryParams),e.fragment!==t.fragment&&i.fragmentSubject.next(t.fragment),Or(e.params,t.params)||i.paramsSubject.next(t.params),aL(e.url,t.url)||i.urlSubject.next(t.url),Or(e.data,t.data)||i.dataSubject.next(t.data)}else i.snapshot=i._futureSnapshot,i.dataSubject.next(i._futureSnapshot.data)}function Bv(i,e){let t=Or(i.params,e.params)&&hL(i.url,e.url),n=!i.parent!=!e.parent;return t&&!n&&(!i.parent||Bv(i.parent,e.parent))}function NA(i){return typeof i.title=="string"||i.title===null}var LA=new Ve(""),Iu=(()=>{class i{activated=null;get activatedComponentRef(){return this.activated}_activatedRoute=null;name=Ue;activateEvents=new zn;deactivateEvents=new zn;attachEvents=new zn;detachEvents=new zn;routerOutletData=UE();parentContexts=ae(Il);location=ae(Mo);changeDetector=ae(Pf);inputBinder=ae(cp,{optional:!0});supportsBindingToComponentInputs=!0;ngOnChanges(t){if(t.name){let{firstChange:n,previousValue:r}=t.name;if(n)return;this.isTrackedInParentContexts(r)&&(this.deactivate(),this.parentContexts.onChildOutletDestroyed(r)),this.initializeOutletWithName()}}ngOnDestroy(){this.isTrackedInParentContexts(this.name)&&this.parentContexts.onChildOutletDestroyed(this.name),this.inputBinder?.unsubscribeFromRouteData(this)}isTrackedInParentContexts(t){return this.parentContexts.getContext(t)?.outlet===this}ngOnInit(){this.initializeOutletWithName()}initializeOutletWithName(){if(this.parentContexts.onChildOutletCreated(this.name,this),this.activated)return;let t=this.parentContexts.getContext(this.name);t?.route&&(t.attachRef?this.attach(t.attachRef,t.route):this.activateWith(t.route,t.injector))}get isActivated(){return!!this.activated}get component(){if(!this.activated)throw new Le(4012,!1);return this.activated.instance}get activatedRoute(){if(!this.activated)throw new Le(4012,!1);return this._activatedRoute}get activatedRouteData(){return this._activatedRoute?this._activatedRoute.snapshot.data:{}}detach(){if(!this.activated)throw new Le(4012,!1);this.location.detach();let t=this.activated;return this.activated=null,this._activatedRoute=null,this.detachEvents.emit(t.instance),t}attach(t,n){this.activated=t,this._activatedRoute=n,this.location.insert(t.hostView),this.inputBinder?.bindActivatedRouteToOutletComponent(this),this.attachEvents.emit(t.instance)}deactivate(){if(this.activated){let t=this.component;this.activated.destroy(),this.activated=null,this._activatedRoute=null,this.deactivateEvents.emit(t)}}activateWith(t,n){if(this.isActivated)throw new Le(4013,!1);this._activatedRoute=t;let r=this.location,o=t.snapshot.component,a=this.parentContexts.getOrCreateContext(this.name).children,l=new Vv(t,a,r.injector,this.routerOutletData);this.activated=r.createComponent(o,{index:r.length,injector:l,environmentInjector:n}),this.changeDetector.markForCheck(),this.inputBinder?.bindActivatedRouteToOutletComponent(this),this.activateEvents.emit(this.activated.instance)}static \u0275fac=function(n){return new(n||i)};static \u0275dir=If({type:i,selectors:[["router-outlet"]],inputs:{name:"name",routerOutletData:[1,"routerOutletData"]},outputs:{activateEvents:"activate",deactivateEvents:"deactivate",attachEvents:"attach",detachEvents:"detach"},exportAs:["outlet"],features:[hf]})}return i})(),Vv=class{route;childContexts;parent;outletData;constructor(e,t,n,r){this.route=e,this.childContexts=t,this.parent=n,this.outletData=r}get(e,t){return e===Us?this.route:e===Il?this.childContexts:e===LA?this.outletData:this.parent.get(e,t)}},cp=new Ve("");var $v=(()=>{class i{static \u0275fac=function(n){return new(n||i)};static \u0275cmp=sr({type:i,selectors:[["ng-component"]],exportAs:["emptyRouterOutlet"],decls:1,vars:0,template:function(n,r){n&1&&dl(0,"router-outlet")},dependencies:[Iu],encapsulation:2})}return i})();function Wv(i){let e=i.children&&i.children.map(Wv),t=e?ct(K({},i),{children:e}):K({},i);return!t.component&&!t.loadComponent&&(e||t.loadChildren)&&t.outlet&&t.outlet!==Ue&&(t.component=$v),t}function LL(i,e,t){let n=Cu(i,e._root,t?t._root:void 0);return new bu(n,e)}function Cu(i,e,t){if(t&&i.shouldReuseRoute(e.value,t.value.snapshot)){let n=t.value;n._futureSnapshot=e.value;let r=FL(i,e,t);return new Ti(n,r)}else{if(i.shouldAttach(e.value)){let s=i.retrieve(e.value);if(s!==null){let o=s.route;return o.value._futureSnapshot=e.value,o.children=e.children.map(a=>Cu(i,a)),o}}let n=kL(e.value),r=e.children.map(s=>Cu(i,s));return new Ti(n,r)}}function FL(i,e,t){return e.children.map(n=>{for(let r of t.children)if(i.shouldReuseRoute(n.value,r.value.snapshot))return Cu(i,n,r);return Cu(i,n)})}function kL(i){return new Us(new Dt(i.url),new Dt(i.params),new Dt(i.queryParams),new Dt(i.fragment),new Dt(i.data),i.outlet,i.component,i)}var Cl=class{redirectTo;navigationBehaviorOptions;constructor(e,t){this.redirectTo=e,this.navigationBehaviorOptions=t}},FA="ngNavigationCancelingError";function op(i,e){let{redirectTo:t,navigationBehaviorOptions:n}=vl(e)?{redirectTo:e,navigationBehaviorOptions:void 0}:e,r=kA(!1,Wn.Redirect);return r.url=t,r.navigationBehaviorOptions=n,r}function kA(i,e){let t=new Error(`NavigationCancelingError: ${i||""}`);return t[FA]=!0,t.cancellationCode=e,t}function BL(i){return BA(i)&&vl(i.url)}function BA(i){return!!i&&i[FA]}var VL=(i,e,t,n)=>It(r=>(new Gv(e,r.targetRouterState,r.currentRouterState,t,n).activate(i),r)),Gv=class{routeReuseStrategy;futureState;currState;forwardEvent;inputBindingEnabled;constructor(e,t,n,r,s){this.routeReuseStrategy=e,this.futureState=t,this.currState=n,this.forwardEvent=r,this.inputBindingEnabled=s}activate(e){let t=this.futureState._root,n=this.currState?this.currState._root:null;this.deactivateChildRoutes(t,n,e),Mv(this.futureState.root),this.activateChildRoutes(t,n,e)}deactivateChildRoutes(e,t,n){let r=gl(t);e.children.forEach(s=>{let o=s.value.outlet;this.deactivateRoutes(s,r[o],n),delete r[o]}),Object.values(r).forEach(s=>{this.deactivateRouteAndItsChildren(s,n)})}deactivateRoutes(e,t,n){let r=e.value,s=t?t.value:null;if(r===s)if(r.component){let o=n.getContext(r.outlet);o&&this.deactivateChildRoutes(e,t,o.children)}else this.deactivateChildRoutes(e,t,n);else s&&this.deactivateRouteAndItsChildren(t,n)}deactivateRouteAndItsChildren(e,t){e.value.component&&this.routeReuseStrategy.shouldDetach(e.value.snapshot)?this.detachAndStoreRouteSubtree(e,t):this.deactivateRouteAndOutlet(e,t)}detachAndStoreRouteSubtree(e,t){let n=t.getContext(e.value.outlet),r=n&&e.value.component?n.children:t,s=gl(e);for(let o of Object.values(s))this.deactivateRouteAndItsChildren(o,r);if(n&&n.outlet){let o=n.outlet.detach(),a=n.children.onOutletDeactivated();this.routeReuseStrategy.store(e.value.snapshot,{componentRef:o,route:e,contexts:a})}}deactivateRouteAndOutlet(e,t){let n=t.getContext(e.value.outlet),r=n&&e.value.component?n.children:t,s=gl(e);for(let o of Object.values(s))this.deactivateRouteAndItsChildren(o,r);n&&(n.outlet&&(n.outlet.deactivate(),n.children.onOutletDeactivated()),n.attachRef=null,n.route=null)}activateChildRoutes(e,t,n){let r=gl(t);e.children.forEach(s=>{this.activateRoutes(s,r[s.value.outlet],n),this.forwardEvent(new np(s.value.snapshot))}),e.children.length&&this.forwardEvent(new ep(e.value.snapshot))}activateRoutes(e,t,n){let r=e.value,s=t?t.value:null;if(Mv(r),r===s)if(r.component){let o=n.getOrCreateContext(r.outlet);this.activateChildRoutes(e,t,o.children)}else this.activateChildRoutes(e,t,n);else if(r.component){let o=n.getOrCreateContext(r.outlet);if(this.routeReuseStrategy.shouldAttach(r.snapshot)){let a=this.routeReuseStrategy.retrieve(r.snapshot);this.routeReuseStrategy.store(r.snapshot,null),o.children.onOutletReAttached(a.contexts),o.attachRef=a.componentRef,o.route=a.route.value,o.outlet&&o.outlet.attach(a.componentRef,a.route.value),Mv(a.route.value),this.activateChildRoutes(e,null,o.children)}else o.attachRef=null,o.route=r,o.outlet&&o.outlet.activateWith(r,o.injector),this.activateChildRoutes(e,null,o.children)}else this.activateChildRoutes(e,null,n)}},ap=class{path;route;constructor(e){this.path=e,this.route=this.path[this.path.length-1]}},yl=class{component;route;constructor(e,t){this.component=e,this.route=t}};function GL(i,e,t){let n=i._root,r=e?e._root:null;return du(n,r,t,[n.value])}function UL(i){let e=i.routeConfig?i.routeConfig.canActivateChild:null;return!e||e.length===0?null:{node:i,guards:e}}function El(i,e){let t=Symbol(),n=e.get(i,t);return n===t?typeof i=="function"&&!g_(i)?i:e.get(i):n}function du(i,e,t,n,r={canDeactivateChecks:[],canActivateChecks:[]}){let s=gl(e);return i.children.forEach(o=>{zL(o,s[o.value.outlet],t,n.concat([o.value]),r),delete s[o.value.outlet]}),Object.entries(s).forEach(([o,a])=>mu(a,t.getContext(o),r)),r}function zL(i,e,t,n,r={canDeactivateChecks:[],canActivateChecks:[]}){let s=i.value,o=e?e.value:null,a=t?t.getContext(i.value.outlet):null;if(o&&s.routeConfig===o.routeConfig){let l=HL(o,s,s.routeConfig.runGuardsAndResolvers);l?r.canActivateChecks.push(new ap(n)):(s.data=o.data,s._resolvedData=o._resolvedData),s.component?du(i,e,a?a.children:null,n,r):du(i,e,t,n,r),l&&a&&a.outlet&&a.outlet.isActivated&&r.canDeactivateChecks.push(new yl(a.outlet.component,o))}else o&&mu(e,a,r),r.canActivateChecks.push(new ap(n)),s.component?du(i,null,a?a.children:null,n,r):du(i,null,t,n,r);return r}function HL(i,e,t){if(typeof t=="function")return t(i,e);switch(t){case"pathParamsChange":return!Oo(i.url,e.url);case"pathParamsOrQueryParamsChange":return!Oo(i.url,e.url)||!Or(i.queryParams,e.queryParams);case"always":return!0;case"paramsOrQueryParamsChange":return!Bv(i,e)||!Or(i.queryParams,e.queryParams);case"paramsChange":default:return!Bv(i,e)}}function mu(i,e,t){let n=gl(i),r=i.value;Object.entries(n).forEach(([s,o])=>{r.component?e?mu(o,e.children.getContext(s),t):mu(o,null,t):mu(o,e,t)}),r.component?e&&e.outlet&&e.outlet.isActivated?t.canDeactivateChecks.push(new yl(e.outlet.component,r)):t.canDeactivateChecks.push(new yl(null,r)):t.canDeactivateChecks.push(new yl(null,r))}function Eu(i){return typeof i=="function"}function $L(i){return typeof i=="boolean"}function WL(i){return i&&Eu(i.canLoad)}function jL(i){return i&&Eu(i.canActivate)}function qL(i){return i&&Eu(i.canActivateChild)}function YL(i){return i&&Eu(i.canDeactivate)}function KL(i){return i&&Eu(i.canMatch)}function VA(i){return i instanceof ao||i?.name==="EmptyError"}var Gf=Symbol("INITIAL_VALUE");function Tl(){return vr(i=>Yg(i.map(e=>e.pipe(ki(1),Qg(Gf)))).pipe(It(e=>{for(let t of e)if(t!==!0){if(t===Gf)return Gf;if(t===!1||XL(t))return t}return!0}),yr(e=>e!==Gf),ki(1)))}function XL(i){return vl(i)||i instanceof Cl}function GA(i){return i.aborted?Je(void 0).pipe(ki(1)):new st(e=>{let t=()=>{e.next(),e.complete()};return i.addEventListener("abort",t),()=>i.removeEventListener("abort",t)})}function UA(i){return xc(GA(i))}function ZL(i,e){return vn(t=>{let{targetSnapshot:n,currentSnapshot:r,guards:{canActivateChecks:s,canDeactivateChecks:o}}=t;return o.length===0&&s.length===0?Je(ct(K({},t),{guardsResult:!0})):QL(o,n,r,i).pipe(vn(a=>a&&$L(a)?JL(n,s,i,e):Je(a)),It(a=>ct(K({},t),{guardsResult:a})))})}function QL(i,e,t,n){return cn(i).pipe(vn(r=>rF(r.component,r.route,t,e,n)),Qr(r=>r!==!0,!0))}function JL(i,e,t,n){return cn(e).pipe(lo(r=>Is(tF(r.route.parent,n),eF(r.route,n),iF(i,r.path,t),nF(i,r.route,t))),Qr(r=>r!==!0,!0))}function eF(i,e){return i!==null&&e&&e(new tp(i)),Je(!0)}function tF(i,e){return i!==null&&e&&e(new Jf(i)),Je(!0)}function nF(i,e,t){let n=e.routeConfig?e.routeConfig.canActivate:null;if(!n||n.length===0)return Je(!0);let r=n.map(s=>vc(()=>{let o=Sl(e)??t,a=El(s,o),l=jL(a)?a.canActivate(e,i):Hn(o,()=>a(e,i));return ko(l).pipe(Qr())}));return Je(r).pipe(Tl())}function iF(i,e,t){let n=e[e.length-1],s=e.slice(0,e.length-1).reverse().map(o=>UL(o)).filter(o=>o!==null).map(o=>vc(()=>{let a=o.guards.map(l=>{let c=Sl(o.node)??t,u=El(l,c),h=qL(u)?u.canActivateChild(n,i):Hn(c,()=>u(n,i));return ko(h).pipe(Qr())});return Je(a).pipe(Tl())}));return Je(s).pipe(Tl())}function rF(i,e,t,n,r){let s=e&&e.routeConfig?e.routeConfig.canDeactivate:null;if(!s||s.length===0)return Je(!0);let o=s.map(a=>{let l=Sl(e)??r,c=El(a,l),u=YL(c)?c.canDeactivate(i,e,t,n):Hn(l,()=>c(i,e,t,n));return ko(u).pipe(Qr())});return Je(o).pipe(Tl())}function sF(i,e,t,n,r){let s=e.canLoad;if(s===void 0||s.length===0)return Je(!0);let o=s.map(a=>{let l=El(a,i),c=WL(l)?l.canLoad(e,t):Hn(i,()=>l(e,t)),u=ko(c);return r?u.pipe(UA(r)):u});return Je(o).pipe(Tl(),zA(n))}function zA(i){return zg(un(e=>{if(typeof e!="boolean")throw op(i,e)}),It(e=>e===!0))}function oF(i,e,t,n,r){let s=e.canMatch;if(!s||s.length===0)return Je(!0);let o=s.map(a=>{let l=El(a,i),c=KL(l)?l.canMatch(e,t):Hn(i,()=>l(e,t)),u=ko(c);return r?u.pipe(UA(r)):u});return Je(o).pipe(Tl(),zA(n))}var Po=class HA extends Error{segmentGroup;constructor(e){super(),this.segmentGroup=e||null,Object.setPrototypeOf(this,HA.prototype)}},Uv=class $A extends Error{urlTree;constructor(e){super(),this.urlTree=e,Object.setPrototypeOf(this,$A.prototype)}};function aF(i){throw new Le(4e3,!1)}function lF(i){throw kA(!1,Wn.GuardRejected)}var cF=class{urlSerializer;urlTree;constructor(e,t){this.urlSerializer=e,this.urlTree=t}lineralizeSegments(e,t){return T(this,null,function*(){let n=[],r=t.root;for(;;){if(n=n.concat(r.segments),r.numberOfChildren===0)return n;if(r.numberOfChildren>1||!r.children[Ue])throw aF(`${e.redirectTo}`);r=r.children[Ue]}})}applyRedirectCommands(e,t,n,r,s){return T(this,null,function*(){let o=yield uF(t,r,s);if(o instanceof ar)throw new Uv(o);let a=this.applyRedirectCreateUrlTree(o,this.urlSerializer.parse(o),e,n);if(o[0]==="/")throw new Uv(a);return a})}applyRedirectCreateUrlTree(e,t,n,r){let s=this.createSegmentGroup(e,t.root,n,r);return new ar(s,this.createQueryParams(t.queryParams,this.urlTree.queryParams),t.fragment)}createQueryParams(e,t){let n={};return Object.entries(e).forEach(([r,s])=>{if(typeof s=="string"&&s[0]===":"){let a=s.substring(1);n[r]=t[a]}else n[r]=s}),n}createSegmentGroup(e,t,n,r){let s=this.createSegments(e,t.segments,n,r),o={};return Object.entries(t.children).forEach(([a,l])=>{o[a]=this.createSegmentGroup(e,l,n,r)}),new ut(s,o)}createSegments(e,t,n,r){return t.map(s=>s.path[0]===":"?this.findPosParam(e,s,r):this.findOrReturn(s,n))}findPosParam(e,t,n){let r=n[t.path.substring(1)];if(!r)throw new Le(4001,!1);return r}findOrReturn(e,t){let n=0;for(let r of t){if(r.path===e.path)return t.splice(n),r;n++}return e}};function uF(i,e,t){if(typeof i=="string")return Promise.resolve(i);let n=i,{queryParams:r,fragment:s,routeConfig:o,url:a,outlet:l,params:c,data:u,title:h}=e;return $f(ko(Hn(t,()=>n({params:c,data:u,queryParams:r,fragment:s,routeConfig:o,url:a,outlet:l,title:h}))))}var zv={matched:!1,consumedSegments:[],remainingSegments:[],parameters:{},positionalParamSegments:{}};function hF(i,e,t,n,r,s){let o=WA(i,e,t);return o.matched?(n=PL(e,n),oF(n,e,t,r,s).pipe(It(a=>a===!0?o:K({},zv)))):Je(o)}function WA(i,e,t){if(e.path==="**")return dF(t);if(e.path==="")return e.pathMatch==="full"&&(i.hasChildren()||t.length>0)?K({},zv):{matched:!0,consumedSegments:[],remainingSegments:t,parameters:{},positionalParamSegments:{}};let r=(e.matcher||mA)(t,i,e);if(!r)return K({},zv);let s={};Object.entries(r.posParams??{}).forEach(([a,l])=>{s[a]=l.path});let o=r.consumed.length>0?K(K({},s),r.consumed[r.consumed.length-1].parameters):s;return{matched:!0,consumedSegments:r.consumed,remainingSegments:t.slice(r.consumed.length),parameters:o,positionalParamSegments:r.posParams??{}}}function dF(i){return{matched:!0,parameters:i.length>0?_A(i).parameters:{},consumedSegments:i,remainingSegments:[],positionalParamSegments:{}}}function dA(i,e,t,n){return t.length>0&&mF(i,t,n)?{segmentGroup:new ut(e,pF(n,new ut(t,i.children))),slicedSegments:[]}:t.length===0&&gF(i,t,n)?{segmentGroup:new ut(i.segments,fF(i,t,n,i.children)),slicedSegments:t}:{segmentGroup:new ut(i.segments,i.children),slicedSegments:t}}function fF(i,e,t,n){let r={};for(let s of t)if(up(i,e,s)&&!n[or(s)]){let o=new ut([],{});r[or(s)]=o}return K(K({},n),r)}function pF(i,e){let t={};t[Ue]=e;for(let n of i)if(n.path===""&&or(n)!==Ue){let r=new ut([],{});t[or(n)]=r}return t}function mF(i,e,t){return t.some(n=>up(i,e,n)&&or(n)!==Ue)}function gF(i,e,t){return t.some(n=>up(i,e,n))}function up(i,e,t){return(i.hasChildren()||e.length>0)&&t.pathMatch==="full"?!1:t.path===""}function _F(i,e,t){return e.length===0&&!i.children[t]}var yF=class{};function vF(i,e,t,n,r,s,o="emptyOnly",a){return T(this,null,function*(){return new xF(i,e,t,n,r,o,s,a).recognize()})}var bF=31,xF=class{injector;configLoader;rootComponentType;config;urlTree;paramsInheritanceStrategy;urlSerializer;abortSignal;applyRedirects;absoluteRedirectCount=0;allowRedirects=!0;constructor(e,t,n,r,s,o,a,l){this.injector=e,this.configLoader=t,this.rootComponentType=n,this.config=r,this.urlTree=s,this.paramsInheritanceStrategy=o,this.urlSerializer=a,this.abortSignal=l,this.applyRedirects=new cF(this.urlSerializer,this.urlTree)}noMatchError(e){return new Le(4002,`'${e.segmentGroup}'`)}recognize(){return T(this,null,function*(){let e=dA(this.urlTree.root,[],[],this.config).segmentGroup,{children:t,rootSnapshot:n}=yield this.match(e),r=new Ti(n,t),s=new xu("",r),o=AA(n,[],this.urlTree.queryParams,this.urlTree.fragment);return o.queryParams=this.urlTree.queryParams,s.url=this.urlSerializer.serialize(o),{state:s,tree:o}})}match(e){return T(this,null,function*(){let t=new No([],Object.freeze({}),Object.freeze(K({},this.urlTree.queryParams)),this.urlTree.fragment,Object.freeze({}),Ue,this.rootComponentType,null,{});try{return{children:yield this.processSegmentGroup(this.injector,this.config,e,Ue,t),rootSnapshot:t}}catch(n){if(n instanceof Uv)return this.urlTree=n.urlTree,this.match(n.urlTree.root);throw n instanceof Po?this.noMatchError(n):n}})}processSegmentGroup(e,t,n,r,s){return T(this,null,function*(){if(n.segments.length===0&&n.hasChildren())return this.processChildren(e,t,n,s);let o=yield this.processSegment(e,t,n,n.segments,r,!0,s);return o instanceof Ti?[o]:[]})}processChildren(e,t,n,r){return T(this,null,function*(){let s=[];for(let l of Object.keys(n.children))l==="primary"?s.unshift(l):s.push(l);let o=[];for(let l of s){let c=n.children[l],u=OL(t,l),h=yield this.processSegmentGroup(e,u,c,l,r);o.push(...h)}let a=jA(o);return CF(a),a})}processSegment(e,t,n,r,s,o,a){return T(this,null,function*(){for(let l of t)try{return yield this.processSegmentAgainstRoute(l._injector??e,t,l,n,r,s,o,a)}catch(c){if(c instanceof Po||VA(c))continue;throw c}if(_F(n,r,s))return new yF;throw new Po(n)})}processSegmentAgainstRoute(e,t,n,r,s,o,a,l){return T(this,null,function*(){if(or(n)!==o&&(o===Ue||!up(r,s,n)))throw new Po(r);if(n.redirectTo===void 0)return this.matchSegmentAgainstRoute(e,r,n,s,o,l);if(this.allowRedirects&&a)return this.expandSegmentAgainstRouteUsingRedirect(e,r,t,n,s,o,l);throw new Po(r)})}expandSegmentAgainstRouteUsingRedirect(e,t,n,r,s,o,a){return T(this,null,function*(){let{matched:l,parameters:c,consumedSegments:u,positionalParamSegments:h,remainingSegments:d}=WA(t,r,s);if(!l)throw new Po(t);typeof r.redirectTo=="string"&&r.redirectTo[0]==="/"&&(this.absoluteRedirectCount++,this.absoluteRedirectCount>bF&&(this.allowRedirects=!1));let f=new No(s,c,Object.freeze(K({},this.urlTree.queryParams)),this.urlTree.fragment,fA(r),or(r),r.component??r._loadedComponent??null,r,pA(r)),p=sp(f,a,this.paramsInheritanceStrategy);if(f.params=Object.freeze(p.params),f.data=Object.freeze(p.data),this.abortSignal.aborted)throw new Error(this.abortSignal.reason);let g=yield this.applyRedirects.applyRedirectCommands(u,r.redirectTo,h,f,e),_=yield this.applyRedirects.lineralizeSegments(r,g);return this.processSegment(e,n,t,_.concat(d),o,!1,a)})}matchSegmentAgainstRoute(e,t,n,r,s,o){return T(this,null,function*(){if(this.abortSignal.aborted)throw new Error(this.abortSignal.reason);let a=yield $f(hF(t,n,r,e,this.urlSerializer,this.abortSignal));if(n.path==="**"&&(t.children={}),!a?.matched)throw new Po(t);e=n._injector??e;let{routes:l}=yield this.getChildConfig(e,n,r),c=n._loadedInjector??e,{parameters:u,consumedSegments:h,remainingSegments:d}=a,f=new No(h,u,Object.freeze(K({},this.urlTree.queryParams)),this.urlTree.fragment,fA(n),or(n),n.component??n._loadedComponent??null,n,pA(n)),p=sp(f,o,this.paramsInheritanceStrategy);f.params=Object.freeze(p.params),f.data=Object.freeze(p.data);let{segmentGroup:g,slicedSegments:_}=dA(t,h,d,l);if(_.length===0&&g.hasChildren()){let E=yield this.processChildren(c,l,g,f);return new Ti(f,E)}if(l.length===0&&_.length===0)return new Ti(f,[]);let y=or(n)===s,C=yield this.processSegment(c,l,g,_,y?Ue:s,!0,f);return new Ti(f,C instanceof Ti?[C]:[])})}getChildConfig(e,t,n){return T(this,null,function*(){if(t.children)return{routes:t.children,injector:e};if(t.loadChildren){if(t._loadedRoutes!==void 0)return{routes:t._loadedRoutes,injector:t._loadedInjector};if(this.abortSignal.aborted)throw new Error(this.abortSignal.reason);if(yield $f(sF(e,t,n,this.urlSerializer,this.abortSignal))){let s=yield this.configLoader.loadChildren(e,t);return t._loadedRoutes=s.routes,t._loadedInjector=s.injector,s}throw lF(t)}return{routes:[],injector:e}})}};function CF(i){i.sort((e,t)=>e.value.outlet===Ue?-1:t.value.outlet===Ue?1:e.value.outlet.localeCompare(t.value.outlet))}function TF(i){let e=i.value.routeConfig;return e&&e.path===""}function jA(i){let e=[],t=new Set;for(let n of i){if(!TF(n)){e.push(n);continue}let r=e.find(s=>n.value.routeConfig===s.value.routeConfig);r!==void 0?(r.children.push(...n.children),t.add(r)):e.push(n)}for(let n of t){let r=jA(n.children);e.push(new Ti(n.value,r))}return e.filter(n=>!t.has(n))}function fA(i){return i.data||{}}function pA(i){return i.resolve||{}}var SF=new Ve("",{factory:()=>vF});function IF(i,e,t,n,r,s,o){let a=i.get(SF);return vn(l=>Je(l).pipe(vr(c=>a(i,e,t,n,c.extractedUrl,r,s,o)),It(({state:c,tree:u})=>ct(K({},l),{targetSnapshot:c,urlAfterRedirects:u}))))}function EF(i,e){return vn(t=>{let{targetSnapshot:n,guards:{canActivateChecks:r}}=t;if(!r.length)return Je(t);let s=new Set(r.map(l=>l.route)),o=new Set;for(let l of s)if(!o.has(l))for(let c of qA(l))o.add(c);let a=0;return cn(o).pipe(lo(l=>s.has(l)?AF(l,n,i,e):(l.data=sp(l,l.parent,i).resolve,Je(void 0))),un(()=>a++),pd(1),vn(l=>a===o.size?Je(t):ii))})}function qA(i){let e=i.children.map(t=>qA(t)).flat();return[i,...e]}function AF(i,e,t,n){let r=i.routeConfig,s=i._resolve;return r?.title!==void 0&&!NA(r)&&(s[Tu]=r.title),vc(()=>(i.data=sp(i,i.parent,t).resolve,wF(s,i,e,n).pipe(It(o=>(i._resolvedData=o,i.data=K(K({},i.data),o),null)))))}function wF(i,e,t,n){let r=Pv(i);if(r.length===0)return Je({});let s={};return cn(r).pipe(vn(o=>MF(i[o],e,t,n).pipe(Qr(),un(a=>{if(a instanceof Cl)throw op(new Gs,a);s[o]=a}))),pd(1),It(()=>s),bc(o=>VA(o)?ii:qg(o)))}function MF(i,e,t,n){let r=Sl(e)??n,s=El(i,r),o=s.resolve?s.resolve(e,t):Hn(r,()=>s(e,t));return ko(o)}function Dv(i){return vr(e=>{let t=i(e);return t?cn(t).pipe(It(()=>e)):Je(e)})}var jv=(()=>{class i{buildTitle(t){let n,r=t.root;for(;r!==void 0;)n=this.getResolvedTitleForRoute(r)??n,r=r.children.find(s=>s.outlet===Ue);return n}getResolvedTitleForRoute(t){return t.data[Tu]}static \u0275fac=function(n){return new(n||i)};static \u0275prov=Me({token:i,factory:()=>ae(YA),providedIn:"root"})}return i})(),YA=(()=>{class i extends jv{title;constructor(t){super(),this.title=t}updateTitle(t){let n=this.buildTitle(t);n!==void 0&&this.title.setTitle(n)}static \u0275fac=function(n){return new(n||i)(je(oA))};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})(),Au=new Ve("",{factory:()=>({})}),wu=new Ve(""),KA=(()=>{class i{componentLoaders=new WeakMap;childrenLoaders=new WeakMap;onLoadStartListener;onLoadEndListener;compiler=ae(hv);loadComponent(t,n){return T(this,null,function*(){if(this.componentLoaders.get(n))return this.componentLoaders.get(n);if(n._loadedComponent)return Promise.resolve(n._loadedComponent);this.onLoadStartListener&&this.onLoadStartListener(n);let r=T(this,null,function*(){try{let s=yield yA(Hn(t,()=>n.loadComponent())),o=yield QA(ZA(s));return this.onLoadEndListener&&this.onLoadEndListener(n),n._loadedComponent=o,o}finally{this.componentLoaders.delete(n)}});return this.componentLoaders.set(n,r),r})}loadChildren(t,n){if(this.childrenLoaders.get(n))return this.childrenLoaders.get(n);if(n._loadedRoutes)return Promise.resolve({routes:n._loadedRoutes,injector:n._loadedInjector});this.onLoadStartListener&&this.onLoadStartListener(n);let r=T(this,null,function*(){try{let s=yield XA(n,this.compiler,t,this.onLoadEndListener);return n._loadedRoutes=s.routes,n._loadedInjector=s.injector,s}finally{this.childrenLoaders.delete(n)}});return this.childrenLoaders.set(n,r),r}static \u0275fac=function(n){return new(n||i)};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();function XA(i,e,t,n){return T(this,null,function*(){let r=yield yA(Hn(t,()=>i.loadChildren())),s=yield QA(ZA(r)),o;s instanceof Sf||Array.isArray(s)?o=s:o=yield e.compileModuleAsync(s),n&&n(i);let a,l,c=!1;return Array.isArray(o)?(l=o,c=!0):(a=o.create(t).injector,l=a.get(wu,[],{optional:!0,self:!0}).flat()),{routes:l.map(Wv),injector:a}})}function DF(i){return i&&typeof i=="object"&&"default"in i}function ZA(i){return DF(i)?i.default:i}function QA(i){return T(this,null,function*(){return i})}var hp=(()=>{class i{static \u0275fac=function(n){return new(n||i)};static \u0275prov=Me({token:i,factory:()=>ae(RF),providedIn:"root"})}return i})(),RF=(()=>{class i{shouldProcessUrl(t){return!0}extract(t){return t}merge(t,n){return t}static \u0275fac=function(n){return new(n||i)};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})(),JA=new Ve("");var PF=()=>{},ew=new Ve(""),tw=(()=>{class i{currentNavigation=oi(null,{equal:()=>!1});currentTransition=null;lastSuccessfulNavigation=oi(null);events=new Xt;transitionAbortWithErrorSubject=new Xt;configLoader=ae(KA);environmentInjector=ae(An);destroyRef=ae(tl);urlSerializer=ae(Su);rootContexts=ae(Il);location=ae(pl);inputBindingEnabled=ae(cp,{optional:!0})!==null;titleStrategy=ae(jv);options=ae(Au,{optional:!0})||{};paramsInheritanceStrategy=this.options.paramsInheritanceStrategy||"emptyOnly";urlHandlingStrategy=ae(hp);createViewTransition=ae(JA,{optional:!0});navigationErrorHandler=ae(ew,{optional:!0});navigationId=0;get hasRequestedNavigation(){return this.navigationId!==0}transitions;afterPreactivation=()=>Je(void 0);rootComponentType=null;destroyed=!1;constructor(){let t=r=>this.events.next(new Zf(r)),n=r=>this.events.next(new Qf(r));this.configLoader.onLoadEndListener=n,this.configLoader.onLoadStartListener=t,this.destroyRef.onDestroy(()=>{this.destroyed=!0})}complete(){this.transitions?.complete()}handleNavigationRequest(t){let n=++this.navigationId;Hi(()=>{this.transitions?.next(ct(K({},t),{extractedUrl:this.urlHandlingStrategy.extract(t.rawUrl),targetSnapshot:null,targetRouterState:null,guards:{canActivateChecks:[],canDeactivateChecks:[]},guardsResult:null,id:n}))})}setupNavigations(t){return this.transitions=new Dt(null),this.transitions.pipe(yr(n=>n!==null),vr(n=>{let r=!1,s=new AbortController;return Je(n).pipe(vr(o=>{if(this.navigationId>n.id)return this.cancelNavigationTransition(n,"",Wn.SupersededByNewNavigation),ii;this.currentTransition=n;let a=this.lastSuccessfulNavigation();this.currentNavigation.set({id:o.id,initialUrl:o.rawUrl,extractedUrl:o.extractedUrl,targetBrowserUrl:typeof o.extras.browserUrl=="string"?this.urlSerializer.parse(o.extras.browserUrl):o.extras.browserUrl,trigger:o.source,extras:o.extras,previousNavigation:a?ct(K({},a),{previousNavigation:null}):null,abort:()=>s.abort()});let l=!t.navigated||this.isUpdatingInternalState()||this.isUpdatedBrowserUrl(),c=o.extras.onSameUrlNavigation??t.onSameUrlNavigation;if(!l&&c!=="reload")return this.events.next(new cs(o.id,this.urlSerializer.serialize(o.rawUrl),"",_u.IgnoredSameUrlNavigation)),o.resolve(!1),ii;if(this.urlHandlingStrategy.shouldProcessUrl(o.rawUrl))return Je(o).pipe(vr(u=>(this.events.next(new Fo(u.id,this.urlSerializer.serialize(u.extractedUrl),u.source,u.restoredState)),u.id!==this.navigationId?ii:Promise.resolve(u))),IF(this.environmentInjector,this.configLoader,this.rootComponentType,t.config,this.urlSerializer,this.paramsInheritanceStrategy,s.signal),un(u=>{n.targetSnapshot=u.targetSnapshot,n.urlAfterRedirects=u.urlAfterRedirects,this.currentNavigation.update(d=>(d.finalUrl=u.urlAfterRedirects,d));let h=new yu(u.id,this.urlSerializer.serialize(u.extractedUrl),this.urlSerializer.serialize(u.urlAfterRedirects),u.targetSnapshot);this.events.next(h)}));if(l&&this.urlHandlingStrategy.shouldProcessUrl(o.currentRawUrl)){let{id:u,extractedUrl:h,source:d,restoredState:f,extras:p}=o,g=new Fo(u,this.urlSerializer.serialize(h),d,f);this.events.next(g);let _=PA(this.rootComponentType).snapshot;return this.currentTransition=n=ct(K({},o),{targetSnapshot:_,urlAfterRedirects:h,extras:ct(K({},p),{skipLocationChange:!1,replaceUrl:!1})}),this.currentNavigation.update(y=>(y.finalUrl=h,y)),Je(n)}else return this.events.next(new cs(o.id,this.urlSerializer.serialize(o.extractedUrl),"",_u.IgnoredByUrlHandlingStrategy)),o.resolve(!1),ii}),un(o=>{let a=new qf(o.id,this.urlSerializer.serialize(o.extractedUrl),this.urlSerializer.serialize(o.urlAfterRedirects),o.targetSnapshot);this.events.next(a)}),It(o=>(this.currentTransition=n=ct(K({},o),{guards:GL(o.targetSnapshot,o.currentSnapshot,this.rootContexts)}),n)),ZL(this.environmentInjector,o=>this.events.next(o)),un(o=>{if(n.guardsResult=o.guardsResult,o.guardsResult&&typeof o.guardsResult!="boolean")throw op(this.urlSerializer,o.guardsResult);let a=new Yf(o.id,this.urlSerializer.serialize(o.extractedUrl),this.urlSerializer.serialize(o.urlAfterRedirects),o.targetSnapshot,!!o.guardsResult);this.events.next(a)}),yr(o=>o.guardsResult?!0:(this.cancelNavigationTransition(o,"",Wn.GuardRejected),!1)),Dv(o=>{if(o.guards.canActivateChecks.length!==0)return Je(o).pipe(un(a=>{let l=new Kf(a.id,this.urlSerializer.serialize(a.extractedUrl),this.urlSerializer.serialize(a.urlAfterRedirects),a.targetSnapshot);this.events.next(l)}),vr(a=>{let l=!1;return Je(a).pipe(EF(this.paramsInheritanceStrategy,this.environmentInjector),un({next:()=>l=!0,complete:()=>{l||this.cancelNavigationTransition(a,"",Wn.NoDataFromResolver)}}))}),un(a=>{let l=new Xf(a.id,this.urlSerializer.serialize(a.extractedUrl),this.urlSerializer.serialize(a.urlAfterRedirects),a.targetSnapshot);this.events.next(l)}))}),Dv(o=>{let a=c=>{let u=[];if(c.routeConfig?._loadedComponent)c.component=c.routeConfig?._loadedComponent;else if(c.routeConfig?.loadComponent){let h=Sl(c)??this.environmentInjector;u.push(this.configLoader.loadComponent(h,c.routeConfig).then(d=>{c.component=d}))}for(let h of c.children)u.push(...a(h));return u},l=a(o.targetSnapshot.root);return l.length===0?Je(o):cn(Promise.all(l).then(()=>o))}),Dv(()=>this.afterPreactivation()),vr(()=>{let{currentSnapshot:o,targetSnapshot:a}=n,l=this.createViewTransition?.(this.environmentInjector,o.root,a.root);return l?cn(l).pipe(It(()=>n)):Je(n)}),It(o=>{let a=LL(t.routeReuseStrategy,o.targetSnapshot,o.currentRouterState);return this.currentTransition=n=ct(K({},o),{targetRouterState:a}),this.currentNavigation.update(l=>(l.targetRouterState=a,l)),n}),un(()=>{this.events.next(new vu)}),VL(this.rootContexts,t.routeReuseStrategy,o=>this.events.next(o),this.inputBindingEnabled),ki(1),xc(GA(s.signal).pipe(yr(()=>!r&&!n.targetRouterState),un(()=>{this.cancelNavigationTransition(n,s.signal.reason+"",Wn.Aborted)}))),un({next:o=>{r=!0,this.currentNavigation.update(a=>(a.abort=PF,a)),this.lastSuccessfulNavigation.set(Hi(this.currentNavigation)),this.events.next(new ls(o.id,this.urlSerializer.serialize(o.extractedUrl),this.urlSerializer.serialize(o.urlAfterRedirects))),this.titleStrategy?.updateTitle(o.targetRouterState.snapshot),o.resolve(!0)},complete:()=>{r=!0}}),xc(this.transitionAbortWithErrorSubject.pipe(un(o=>{throw o}))),Zg(()=>{s.abort(),r||this.cancelNavigationTransition(n,"",Wn.SupersededByNewNavigation),this.currentTransition?.id===n.id&&(this.currentNavigation.set(null),this.currentTransition=null)}),bc(o=>{if(this.destroyed)return n.resolve(!1),ii;if(r=!0,BA(o))this.events.next(new Nr(n.id,this.urlSerializer.serialize(n.extractedUrl),o.message,o.cancellationCode)),BL(o)?this.events.next(new xl(o.url,o.navigationBehaviorOptions)):n.resolve(!1);else{let a=new bl(n.id,this.urlSerializer.serialize(n.extractedUrl),o,n.targetSnapshot??void 0);try{let l=Hn(this.environmentInjector,()=>this.navigationErrorHandler?.(a));if(l instanceof Cl){let{message:c,cancellationCode:u}=op(this.urlSerializer,l);this.events.next(new Nr(n.id,this.urlSerializer.serialize(n.extractedUrl),c,u)),this.events.next(new xl(l.redirectTo,l.navigationBehaviorOptions))}else throw this.events.next(a),o}catch(l){this.options.resolveNavigationPromiseOnError?n.resolve(!1):n.reject(l)}}return ii}))}))}cancelNavigationTransition(t,n,r){let s=new Nr(t.id,this.urlSerializer.serialize(t.extractedUrl),n,r);this.events.next(s),t.resolve(!1)}isUpdatingInternalState(){return this.currentTransition?.extractedUrl.toString()!==this.currentTransition?.currentUrlTree.toString()}isUpdatedBrowserUrl(){let t=this.urlHandlingStrategy.extract(this.urlSerializer.parse(this.location.path(!0))),n=Hi(this.currentNavigation),r=n?.targetBrowserUrl??n?.extractedUrl;return t.toString()!==r?.toString()&&!n?.extras.skipLocationChange}static \u0275fac=function(n){return new(n||i)};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();function OF(i){return i!==pu}var nw=(()=>{class i{static \u0275fac=function(n){return new(n||i)};static \u0275prov=Me({token:i,factory:()=>ae(NF),providedIn:"root"})}return i})(),lp=class{shouldDetach(e){return!1}store(e,t){}shouldAttach(e){return!1}retrieve(e){return null}shouldReuseRoute(e,t){return e.routeConfig===t.routeConfig}},NF=(()=>{class i extends lp{static \u0275fac=(()=>{let t;return function(r){return(t||(t=ff(i)))(r||i)}})();static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})(),qv=(()=>{class i{urlSerializer=ae(Su);options=ae(Au,{optional:!0})||{};canceledNavigationResolution=this.options.canceledNavigationResolution||"replace";location=ae(pl);urlHandlingStrategy=ae(hp);urlUpdateStrategy=this.options.urlUpdateStrategy||"deferred";currentUrlTree=new ar;getCurrentUrlTree(){return this.currentUrlTree}rawUrlTree=this.currentUrlTree;getRawUrlTree(){return this.rawUrlTree}createBrowserPath({finalUrl:t,initialUrl:n,targetBrowserUrl:r}){let s=t!==void 0?this.urlHandlingStrategy.merge(t,n):n,o=r??s;return o instanceof ar?this.urlSerializer.serialize(o):o}commitTransition({targetRouterState:t,finalUrl:n,initialUrl:r}){n&&t?(this.currentUrlTree=n,this.rawUrlTree=this.urlHandlingStrategy.merge(n,r),this.routerState=t):this.rawUrlTree=r}routerState=PA(null);getRouterState(){return this.routerState}stateMemento=this.createStateMemento();updateStateMemento(){this.stateMemento=this.createStateMemento()}createStateMemento(){return{rawUrlTree:this.rawUrlTree,currentUrlTree:this.currentUrlTree,routerState:this.routerState}}resetInternalState({finalUrl:t}){this.routerState=this.stateMemento.routerState,this.currentUrlTree=this.stateMemento.currentUrlTree,this.rawUrlTree=this.urlHandlingStrategy.merge(this.currentUrlTree,t??this.rawUrlTree)}static \u0275fac=function(n){return new(n||i)};static \u0275prov=Me({token:i,factory:()=>ae(iw),providedIn:"root"})}return i})(),iw=(()=>{class i extends qv{currentPageId=0;lastSuccessfulId=-1;restoredState(){return this.location.getState()}get browserPageId(){return this.canceledNavigationResolution!=="computed"?this.currentPageId:this.restoredState()?.\u0275routerPageId??this.currentPageId}registerNonRouterCurrentEntryChangeListener(t){return this.location.subscribe(n=>{n.type==="popstate"&&setTimeout(()=>{t(n.url,n.state,"popstate")})})}handleRouterEvent(t,n){t instanceof Fo?this.updateStateMemento():t instanceof cs?this.commitTransition(n):t instanceof yu?this.urlUpdateStrategy==="eager"&&(n.extras.skipLocationChange||this.setBrowserUrl(this.createBrowserPath(n),n)):t instanceof vu?(this.commitTransition(n),this.urlUpdateStrategy==="deferred"&&!n.extras.skipLocationChange&&this.setBrowserUrl(this.createBrowserPath(n),n)):t instanceof Nr&&t.code!==Wn.SupersededByNewNavigation&&t.code!==Wn.Redirect?this.restoreHistory(n):t instanceof bl?this.restoreHistory(n,!0):t instanceof ls&&(this.lastSuccessfulId=t.id,this.currentPageId=this.browserPageId)}setBrowserUrl(t,{extras:n,id:r}){let{replaceUrl:s,state:o}=n;if(this.location.isCurrentPathEqualTo(t)||s){let a=this.browserPageId,l=K(K({},o),this.generateNgRouterState(r,a));this.location.replaceState(t,"",l)}else{let a=K(K({},o),this.generateNgRouterState(r,this.browserPageId+1));this.location.go(t,"",a)}}restoreHistory(t,n=!1){if(this.canceledNavigationResolution==="computed"){let r=this.browserPageId,s=this.currentPageId-r;s!==0?this.location.historyGo(s):this.getCurrentUrlTree()===t.finalUrl&&s===0&&(this.resetInternalState(t),this.resetUrlToCurrentUrlTree())}else this.canceledNavigationResolution==="replace"&&(n&&this.resetInternalState(t),this.resetUrlToCurrentUrlTree())}resetUrlToCurrentUrlTree(){this.location.replaceState(this.urlSerializer.serialize(this.getRawUrlTree()),"",this.generateNgRouterState(this.lastSuccessfulId,this.currentPageId))}generateNgRouterState(t,n){return this.canceledNavigationResolution==="computed"?{navigationId:t,\u0275routerPageId:n}:{navigationId:t}}static \u0275fac=(()=>{let t;return function(r){return(t||(t=ff(i)))(r||i)}})();static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();function Yv(i,e){i.events.pipe(yr(t=>t instanceof ls||t instanceof Nr||t instanceof bl||t instanceof cs),It(t=>t instanceof ls||t instanceof cs?0:(t instanceof Nr?t.code===Wn.Redirect||t.code===Wn.SupersededByNewNavigation:!1)?2:1),yr(t=>t!==2),ki(1)).subscribe(()=>{e()})}var LF={paths:"exact",fragment:"ignored",matrixParams:"ignored",queryParams:"exact"},FF={paths:"subset",fragment:"ignored",matrixParams:"ignored",queryParams:"subset"},Lr=(()=>{class i{get currentUrlTree(){return this.stateManager.getCurrentUrlTree()}get rawUrlTree(){return this.stateManager.getRawUrlTree()}disposed=!1;nonRouterCurrentEntryChangeSubscription;console=ae(ov);stateManager=ae(qv);options=ae(Au,{optional:!0})||{};pendingTasks=ae(rs);urlUpdateStrategy=this.options.urlUpdateStrategy||"deferred";navigationTransitions=ae(tw);urlSerializer=ae(Su);location=ae(pl);urlHandlingStrategy=ae(hp);injector=ae(An);_events=new Xt;get events(){return this._events}get routerState(){return this.stateManager.getRouterState()}navigated=!1;routeReuseStrategy=ae(nw);onSameUrlNavigation=this.options.onSameUrlNavigation||"ignore";config=ae(wu,{optional:!0})?.flat()??[];componentInputBindingEnabled=!!ae(cp,{optional:!0});currentNavigation=this.navigationTransitions.currentNavigation.asReadonly();constructor(){this.resetConfig(this.config),this.navigationTransitions.setupNavigations(this).subscribe({error:t=>{this.console.warn(t)}}),this.subscribeToNavigationEvents()}eventsSubscription=new Bt;subscribeToNavigationEvents(){let t=this.navigationTransitions.events.subscribe(n=>{try{let r=this.navigationTransitions.currentTransition,s=Hi(this.navigationTransitions.currentNavigation);if(r!==null&&s!==null){if(this.stateManager.handleRouterEvent(n,s),n instanceof Nr&&n.code!==Wn.Redirect&&n.code!==Wn.SupersededByNewNavigation)this.navigated=!0;else if(n instanceof ls)this.navigated=!0;else if(n instanceof xl){let o=n.navigationBehaviorOptions,a=this.urlHandlingStrategy.merge(n.url,r.currentRawUrl),l=K({browserUrl:r.extras.browserUrl,info:r.extras.info,skipLocationChange:r.extras.skipLocationChange,replaceUrl:r.extras.replaceUrl||this.urlUpdateStrategy==="eager"||OF(r.source)},o);this.scheduleNavigation(a,pu,null,l,{resolve:r.resolve,reject:r.reject,promise:r.promise})}}RL(n)&&this._events.next(n)}catch(r){this.navigationTransitions.transitionAbortWithErrorSubject.next(r)}});this.eventsSubscription.add(t)}resetRootComponentType(t){this.routerState.root.component=t,this.navigationTransitions.rootComponentType=t}initialNavigation(){this.setUpLocationChangeListener(),this.navigationTransitions.hasRequestedNavigation||this.navigateToSyncWithBrowser(this.location.path(!0),pu,this.stateManager.restoredState())}setUpLocationChangeListener(){this.nonRouterCurrentEntryChangeSubscription??=this.stateManager.registerNonRouterCurrentEntryChangeListener((t,n,r)=>{this.navigateToSyncWithBrowser(t,r,n)})}navigateToSyncWithBrowser(t,n,r){let s={replaceUrl:!0},o=r?.navigationId?r:null;if(r){let l=K({},r);delete l.navigationId,delete l.\u0275routerPageId,Object.keys(l).length!==0&&(s.state=l)}let a=this.parseUrl(t);this.scheduleNavigation(a,n,o,s).catch(l=>{this.disposed||this.injector.get(zi)(l)})}get url(){return this.serializeUrl(this.currentUrlTree)}getCurrentNavigation(){return Hi(this.navigationTransitions.currentNavigation)}get lastSuccessfulNavigation(){return this.navigationTransitions.lastSuccessfulNavigation}resetConfig(t){this.config=t.map(Wv),this.navigated=!1}ngOnDestroy(){this.dispose()}dispose(){this._events.unsubscribe(),this.navigationTransitions.complete(),this.nonRouterCurrentEntryChangeSubscription&&(this.nonRouterCurrentEntryChangeSubscription.unsubscribe(),this.nonRouterCurrentEntryChangeSubscription=void 0),this.disposed=!0,this.eventsSubscription.unsubscribe()}createUrlTree(t,n={}){let{relativeTo:r,queryParams:s,fragment:o,queryParamsHandling:a,preserveFragment:l}=n,c=l?this.currentUrlTree.fragment:o,u=null;switch(a??this.options.defaultQueryParamsHandling){case"merge":u=K(K({},this.currentUrlTree.queryParams),s);break;case"preserve":u=this.currentUrlTree.queryParams;break;default:u=s||null}u!==null&&(u=this.removeEmptyProps(u));let h;try{let d=r?r.snapshot:this.routerState.snapshot.root;h=wA(d)}catch{(typeof t[0]!="string"||t[0][0]!=="/")&&(t=[]),h=this.currentUrlTree.root}return MA(h,t,u,c??null,this.urlSerializer)}navigateByUrl(t,n={skipLocationChange:!1}){let r=vl(t)?t:this.parseUrl(t),s=this.urlHandlingStrategy.merge(r,this.rawUrlTree);return this.scheduleNavigation(s,pu,null,n)}navigate(t,n={skipLocationChange:!1}){return kF(t),this.navigateByUrl(this.createUrlTree(t,n),n)}serializeUrl(t){return this.urlSerializer.serialize(t)}parseUrl(t){try{return this.urlSerializer.parse(t)}catch{return this.console.warn($a(4018,!1)),this.urlSerializer.parse("/")}}isActive(t,n){let r;if(n===!0?r=K({},LF):n===!1?r=K({},FF):r=n,vl(t))return aA(this.currentUrlTree,t,r);let s=this.parseUrl(t);return aA(this.currentUrlTree,s,r)}removeEmptyProps(t){return Object.entries(t).reduce((n,[r,s])=>(s!=null&&(n[r]=s),n),{})}scheduleNavigation(t,n,r,s,o){if(this.disposed)return Promise.resolve(!1);let a,l,c;o?(a=o.resolve,l=o.reject,c=o.promise):c=new Promise((h,d)=>{a=h,l=d});let u=this.pendingTasks.add();return Yv(this,()=>{queueMicrotask(()=>this.pendingTasks.remove(u))}),this.navigationTransitions.handleNavigationRequest({source:n,restoredState:r,currentUrlTree:this.currentUrlTree,currentRawUrl:this.currentUrlTree,rawUrl:t,extras:s,resolve:a,reject:l,promise:c,currentSnapshot:this.routerState.snapshot,currentRouterState:this.routerState}),c.catch(h=>Promise.reject(h))}static \u0275fac=function(n){return new(n||i)};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})}return i})();function kF(i){for(let e=0;e<i.length;e++)if(i[e]==null)throw new Le(4008,!1)}var VF=new Ve("");function Kv(i,...e){return qa([{provide:wu,multi:!0,useValue:i},[],{provide:Us,useFactory:GF},{provide:Af,multi:!0,useFactory:UF},e.map(t=>t.\u0275providers)])}function GF(){return ae(Lr).routerState.root}function UF(){let i=ae(xr);return e=>{let t=i.get(Ro);if(e!==t.components[0])return;let n=i.get(Lr),r=i.get(zF);i.get(HF)===1&&n.initialNavigation(),i.get($F,null,{optional:!0})?.setUpPreloading(),i.get(VF,null,{optional:!0})?.init(),n.resetRootComponentType(t.componentTypes[0]),r.closed||(r.next(),r.complete(),r.unsubscribe())}}var zF=new Ve("",{factory:()=>new Xt}),HF=new Ve("",{factory:()=>1});var $F=new Ve("");var ai=(()=>{class i{static get ForceFullSceneLoadingForIncremental(){return i._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(t){i._ForceFullSceneLoadingForIncremental=t}static get ShowLoadingScreen(){return i._ShowLoadingScreen}static set ShowLoadingScreen(t){i._ShowLoadingScreen=t}static get loggingLevel(){return i._LoggingLevel}static set loggingLevel(t){i._LoggingLevel=t}static get CleanBoneMatrixWeights(){return i._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(t){i._CleanBoneMatrixWeights=t}}return i._ForceFullSceneLoadingForIncremental=!1,i._ShowLoadingScreen=!0,i._CleanBoneMatrixWeights=!1,i._LoggingLevel=0,i})();function rw(i,e){return T(this,null,function*(){let t=e.method||"GET";return yield new Promise((n,r)=>{let s=new to;s.addEventListener("readystatechange",()=>{if(s.readyState==4)if(s.status==200){let o={};if(e.responseHeaders)for(let a of e.responseHeaders)o[a]=s.getResponseHeader(a)||"";n({response:s.response,headerValues:o})}else r(`Unable to fetch data from ${i}. Error code: ${s.status}`)}),s.open(t,i),s.send()})})}function qF(i){return!!i.createPlugin}function YF(i){return!!i.name}var sw=new B,Fr={},Xv=!1;function dp(){return Fr[".babylon"]}function KF(i){for(let e in Fr){let t=Fr[e];if(t.mimeType===i)return t}}function Zv(i,e){let t=Fr[i];return t||(N.Warn("Unable to find a plugin to load "+i+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),e?dp():void 0)}function XF(i){return!!Fr[i]}function ZF(i){for(let e in Fr){let t=Fr[e].plugin;if(t.canDirectLoad&&t.canDirectLoad(i))return Fr[e]}return dp()}function QF(i){let e=i.indexOf("?");e!==-1&&(i=i.substring(0,e));let t=i.lastIndexOf(".");return i.substring(t,i.length).toLowerCase()}function JF(i){return i.substring(0,5)==="data:"?i.substring(5):null}function Qv(i,e,t){let r="Unable to load from "+(i.rawData?"binary data":i.url);return e?r+=`: ${e}`:t&&(r+=`: ${t}`),r}function Jv(i,e,t,n,r,s,o,a,l){return T(this,null,function*(){let c=JF(i.url);if(i.rawData&&!o)throw"When using ArrayBufferView to load data the file extension must be provided.";let u=!c&&!o?QF(i.url):"",h=o?Zv(o,!0):c?ZF(i.url):Zv(u,!1);if(!h&&u){if(i.url&&!i.url.startsWith("blob:")){let f=yield rw(i.url,{method:"HEAD",responseHeaders:["Content-Type"]}),p=f.headerValues?f.headerValues["Content-Type"]:"";p&&(h=KF(p))}h||(h=dp())}if(!h)throw new Error(`No plugin or fallback for ${o??i.url}`);if(l?.[h.plugin.name]?.enabled===!1)throw new Error(`The '${h.plugin.name}' plugin is disabled via the loader options passed to the loading operation.`);if(i.rawData&&!h.isBinary)throw"Loading from ArrayBufferView can not be used with plugins that don't support binary loading.";return(f=>{if(qF(h.plugin)){let g=h.plugin.createPlugin(l??{});return g instanceof Promise?(g.then(f).catch(_=>{r("Error instantiating plugin.",_)}),null):(f(g),g)}else return f(h.plugin),h.plugin})(f=>{if(!f)throw`The loader plugin corresponding to the '${o}' file type has not been found. If using es6, please import the plugin you wish to use before.`;if(sw.notifyObservers(f),c&&(f.canDirectLoad&&f.canDirectLoad(i.url)||!Rh(i.url))){if(f.directLoad){let v=f.directLoad(e,c);v instanceof Promise?v.then(x=>{t(f,x)}).catch(x=>{r("Error in directLoad of _loadData: "+x,x)}):t(f,v)}else t(f,c);return}let p=h.isBinary,g=(v,x)=>{if(e.isDisposed){r("Scene has been disposed");return}t(f,v,x)},_=null,y=!1;f.onDisposeObservable?.add(()=>{y=!0,_&&(_.abort(),_=null),s()});let C=()=>{if(y)return;let v=(x,b)=>{r(x?.statusText,b)};if(!f.loadFile&&i.rawData)throw"Plugin does not support loading ArrayBufferView.";_=f.loadFile?f.loadFile(e,i.rawData||i.file||i.url,i.rootUrl,g,n,p,v,a):e._loadFile(i.file||i.url,g,n,!0,p,v)},E=e.getEngine(),I=E.enableOfflineSupport;if(I){let v=!1;for(let x of e.disableOfflineSupportExceptionRules)if(x.test(i.url)){v=!0;break}I=!v}I&&ne.OfflineProviderFactory?e.offlineProvider=ne.OfflineProviderFactory(i.url,C,E.disableManifestCheck):C()})})}function eb(i,e){let t,n,r=null,s=null;if(!e)t=i,n=z.GetFilename(i),i=z.GetFolderPath(i);else if(YF(e))t=`file:${e.name}`,n=e.name,r=e;else if(ArrayBuffer.isView(e))t="",n=ba(),s=e;else if(e.startsWith("data:"))t=e,n="";else if(i){let o=e;if(o.substring(0,1)==="/")return z.Error("Wrong sceneFilename parameter"),null;t=i+o,n=o}else t=e,n=z.GetFilename(e),i=z.GetFolderPath(e);return{url:t,rootUrl:i,name:n,file:r,rawData:s}}function tb(i){if(typeof i.extensions=="string"){let e=i.extensions;Fr[e.toLowerCase()]={plugin:i,isBinary:!1}}else{let e=i.extensions,t=Object.keys(e);for(let n of t)Fr[n.toLowerCase()]={plugin:i,isBinary:e[n].isBinary,mimeType:e[n].mimeType}}}function ow(u,h){return T(this,arguments,function*(i,e,t="",n=Ie.LastCreatedScene,r=null,s=null,o=null,a=null,l="",c={}){if(!n)return N.Error("No scene available to import mesh to"),null;let d=eb(e,t);if(!d)return null;let f={};n.addPendingData(f);let p=()=>{n.removePendingData(f)},g=(C,E)=>{let I=Qv(d,C,E);o?o(n,I,new ga(I,ma.SceneLoaderError,E)):N.Error(I),p()},_=s?C=>{try{s(C)}catch(E){g("Error in onProgress callback: "+E,E)}}:void 0,y=(C,E,I,v,x,b,D,M)=>{if(n.importedMeshesFiles.push(d.url),r)try{r(C,E,I,v,x,b,D,M)}catch(R){g("Error in onSuccess callback: "+R,R)}n.removePendingData(f)};return yield Jv(d,n,(C,E,I)=>{if(C.rewriteRootURL&&(d.rootUrl=C.rewriteRootURL(d.rootUrl,I)),C.importMesh){let v=C,x=[],b=[],D=[];if(!v.importMesh(i,n,E,d.rootUrl,x,b,D,g))return;n.loadingPluginName=C.name,y(x,b,D,[],[],[],[],[])}else C.importMeshAsync(i,n,E,d.rootUrl,_,d.name).then(x=>{n.loadingPluginName=C.name,y(x.meshes,x.particleSystems,x.skeletons,x.animationGroups,x.transformNodes,x.geometries,x.lights,x.spriteManagers)}).catch(x=>{g(x.message,x)})},_,g,p,a,l,c)})}function ek(i,e,t,n,r,s,o,a){return T(this,null,function*(){return yield new Promise((l,c)=>{try{ow(i,e,t,n,(u,h,d,f,p,g,_,y)=>{l({meshes:u,particleSystems:h,skeletons:d,animationGroups:f,transformNodes:p,geometries:g,lights:_,spriteManagers:y})},r,(u,h,d)=>{c(d||new Error(h))},s,o,a).catch(c)}catch(u){c(u)}})})}function aw(c){return T(this,arguments,function*(i,e="",t=Ie.LastCreatedEngine,n=null,r=null,s=null,o=null,a="",l={}){if(!t){z.Error("No engine available");return}yield nb(i,e,new Pe(t),n,r,s,o,a,l)})}function tk(i,e,t,n,r,s,o){return T(this,null,function*(){return yield new Promise((a,l)=>{aw(i,e,t,c=>{a(c)},n,(c,u,h)=>{l(h||new Error(u))},r,s,o)})})}function nb(c){return T(this,arguments,function*(i,e="",t=Ie.LastCreatedScene,n=null,r=null,s=null,o=null,a="",l={}){if(!t)return N.Error("No scene available to append to"),null;let u=eb(i,e);if(!u)return null;let h={};t.addPendingData(h);let d=()=>{t.removePendingData(h)};ai.ShowLoadingScreen&&!Xv&&(Xv=!0,t.getEngine().displayLoadingUI(),t.executeWhenReady(()=>{t.getEngine().hideLoadingUI(),Xv=!1}));let f=(_,y)=>{let C=Qv(u,_,y);s?s(t,C,new ga(C,ma.SceneLoaderError,y)):N.Error(C),d()},p=r?_=>{try{r(_)}catch(y){f("Error in onProgress callback",y)}}:void 0,g=()=>{if(n)try{n(t)}catch(_){f("Error in onSuccess callback",_)}t.removePendingData(h)};return yield Jv(u,t,(_,y)=>{if(_.load){if(!_.load(t,y,u.rootUrl,f))return;t.loadingPluginName=_.name,g()}else _.loadAsync(t,y,u.rootUrl,p,u.name).then(()=>{t.loadingPluginName=_.name,g()}).catch(E=>{f(E.message,E)})},p,f,d,o,a,l)})}function nk(i,e,t,n,r,s,o){return T(this,null,function*(){return yield new Promise((a,l)=>{try{nb(i,e,t,c=>{a(c)},n,(c,u,h)=>{l(h||new Error(u))},r,s,o).catch(l)}catch(c){l(c)}})})}function ib(c){return T(this,arguments,function*(i,e="",t=Ie.LastCreatedScene,n=null,r=null,s=null,o=null,a="",l={}){if(!t)return N.Error("No scene available to load asset container to"),null;let u=eb(i,e);if(!u)return null;let h={};t.addPendingData(h);let d=()=>{t.removePendingData(h)},f=(_,y)=>{let C=Qv(u,_,y);s?s(t,C,new ga(C,ma.SceneLoaderError,y)):N.Error(C),d()},p=r?_=>{try{r(_)}catch(y){f("Error in onProgress callback",y)}}:void 0,g=_=>{if(n)try{n(_)}catch(y){f("Error in onSuccess callback",y)}t.removePendingData(h)};return yield Jv(u,t,(_,y)=>{if(_.loadAssetContainer){let E=_.loadAssetContainer(t,y,u.rootUrl,f);if(!E)return;E.populateRootNodes(),t.loadingPluginName=_.name,g(E)}else _.loadAssetContainerAsync?_.loadAssetContainerAsync(t,y,u.rootUrl,p,u.name).then(E=>{E.populateRootNodes(),t.loadingPluginName=_.name,g(E)}).catch(E=>{f(E.message,E)}):f("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")},p,f,d,o,a,l)})}function lw(i,e,t){return T(this,null,function*(){let{rootUrl:n="",onProgress:r,pluginExtension:s,name:o,pluginOptions:a}=t??{};return yield cw(n,i,e,r,s,o,a)})}function cw(i,e,t,n,r,s,o){return T(this,null,function*(){return yield new Promise((a,l)=>{try{ib(i,e,t,c=>{a(c)},n,(c,u,h)=>{l(h||new Error(u))},r,s,o).catch(l)}catch(c){l(c)}})})}function uw(d){return T(this,arguments,function*(i,e="",t=Ie.LastCreatedScene,n=!0,r=0,s=null,o=null,a=null,l=null,c=null,u="",h={}){if(!t){N.Error("No scene available to load animations to");return}if(n){for(let y of t.animatables)y.reset();t.stopAllAnimations();let g=t.animationGroups.slice();for(let y of g)y.dispose();let _=t.getNodes();for(let y of _)y.animations&&(y.animations=[])}else switch(r){case 0:let g=t.animationGroups.slice();for(let _ of g)_.dispose();break;case 1:for(let _ of t.animationGroups)_.stop();break;case 2:for(let _ of t.animationGroups)_.reset(),_.restart();break;case 3:break;default:N.Error("Unknown animation group loading mode value '"+r+"'");return}let f=t.animatables.length;yield ib(i,e,t,g=>{g.mergeAnimationsTo(t,t.animatables.slice(f),s),g.dispose(),t.onAnimationFileImportedObservable.notifyObservers(t),o&&o(t)},a,l,c,u,h)})}function ik(i,e,t,n,r,s,o,a,l,c){return T(this,null,function*(){return yield new Promise((u,h)=>{try{uw(i,e,t,n,r,s,d=>{u(d)},o,(d,f,p)=>{h(p||new Error(f))},a,l,c).catch(h)}catch(d){h(d)}})})}var Bo=(()=>{class i{static get ForceFullSceneLoadingForIncremental(){return ai.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(t){ai.ForceFullSceneLoadingForIncremental=t}static get ShowLoadingScreen(){return ai.ShowLoadingScreen}static set ShowLoadingScreen(t){ai.ShowLoadingScreen=t}static get loggingLevel(){return ai.loggingLevel}static set loggingLevel(t){ai.loggingLevel=t}static get CleanBoneMatrixWeights(){return ai.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(t){ai.CleanBoneMatrixWeights=t}static GetDefaultPlugin(){return dp()}static GetPluginForExtension(t){return Zv(t,!0)?.plugin}static IsPluginForExtensionAvailable(t){return XF(t)}static RegisterPlugin(t){tb(t)}static ImportMesh(t,n,r,s,o,a,l,c,u,h){ow(t,n,r,s,o,a,l,c,u,h).catch(d=>l?.(Ie.LastCreatedScene,d?.message,d))}static ImportMeshAsync(t,n,r,s,o,a,l){return T(this,null,function*(){return yield ek(t,n,r,s,o,a,l)})}static Load(t,n,r,s,o,a,l,c){aw(t,n,r,s,o,a,l,c).catch(u=>a?.(Ie.LastCreatedScene,u?.message,u))}static LoadAsync(t,n,r,s,o,a){return T(this,null,function*(){return yield tk(t,n,r,s,o,a)})}static Append(t,n,r,s,o,a,l,c){nb(t,n,r,s,o,a,l,c).catch(u=>a?.(r??Ie.LastCreatedScene,u?.message,u))}static AppendAsync(t,n,r,s,o,a){return T(this,null,function*(){return yield nk(t,n,r,s,o,a)})}static LoadAssetContainer(t,n,r,s,o,a,l,c){ib(t,n,r,s,o,a,l,c).catch(u=>a?.(r??Ie.LastCreatedScene,u?.message,u))}static LoadAssetContainerAsync(t,n,r,s,o,a){return T(this,null,function*(){return yield cw(t,n,r,s,o,a)})}static ImportAnimations(t,n,r,s,o,a,l,c,u,h,d){uw(t,n,r,s,o,a,l,c,u,h,d).catch(f=>u?.(r??Ie.LastCreatedScene,f?.message,f))}static ImportAnimationsAsync(t,n,r,s,o,a,l,c,u,h,d){return T(this,null,function*(){return yield ik(t,n,r,s,o,a,c,h,d)})}}return i.NO_LOGGING=0,i.MINIMAL_LOGGING=1,i.SUMMARY_LOGGING=2,i.DETAILED_LOGGING=3,i.OnPluginActivatedObservable=sw,i})();var jt=class i{get boundingBias(){return this._boundingBias}set boundingBias(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)}static CreateGeometryForMesh(e){let t=new i(i.RandomId(),e.getScene());return t.applyToMesh(e),t}get meshes(){return this._meshes}constructor(e,t,n,r=!1,s=null){this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._extend={minimum:new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),maximum:new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=t||Ie.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=r,n?this.setAllVerticesData(n,r):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),s&&(this.applyToMesh(s),s.computeWorldMatrix(!0)))}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return this.delayLoadState===1||this.delayLoadState===0}get doNotSerialize(){for(let e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0}_rebuild(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable,"Geometry_"+this.id+"_IndexBuffer"));let e=new Set;for(let t in this._vertexBuffers)e.add(this._vertexBuffers[t].getWrapperBuffer());e.forEach(t=>{t._rebuild()})}setAllVerticesData(e,t){e.applyToGeometry(this,t),this._notifyUpdate()}setVerticesData(e,t,n=!1,r){n&&Array.isArray(t)&&(t=new Float32Array(t));let s=new S(this._engine,t,e,{updatable:n,postponeInternalCreation:this._meshes.length===0,stride:r,label:"Geometry_"+this.id+"_"+e});this.setVerticesBuffer(s)}removeVerticesData(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}setVerticesBuffer(e,t=null,n=!0){let r=e.getKind();this._vertexBuffers[r]&&n&&this._vertexBuffers[r].dispose(),e._buffer&&e._ownsBuffer&&e._buffer._increaseReferences(),this._vertexBuffers[r]=e;let s=this._meshes,o=s.length;if(r===S.PositionKind){this._totalVertices=t??e._maxVerticesCount,this._updateExtend(this.useBoundingInfoFromGeometry&&this._boundingInfo?null:e.getFloatData(this._totalVertices)),this._resetPointsArrayCache();let a=this._extend&&this._extend.minimum||new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),l=this._extend&&this._extend.maximum||new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);for(let c=0;c<o;c++){let u=s[c];u.buildBoundingInfo(a,l),u._createGlobalSubMesh(u.isUnIndexed),u.computeWorldMatrix(!0),u.synchronizeInstances()}}this._notifyUpdate(r)}updateVerticesDataDirectly(e,t,n,r=!1){let s=this.getVertexBuffer(e);s&&(s.updateDirectly(t,n,r),this._notifyUpdate(e))}updateVerticesData(e,t,n=!1){let r=this.getVertexBuffer(e);r&&(r.update(t),e===S.PositionKind&&this._updateBoundingInfo(n,t),this._notifyUpdate(e))}_updateBoundingInfo(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e){let n=this._meshes;for(let r of n){r.hasBoundingInfo?r.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):r.buildBoundingInfo(this._extend.minimum,this._extend.maximum);let s=r.subMeshes;for(let o of s)o.refreshBoundingInfo()}}}_bind(e,t,n,r){if(!e)return;t===void 0&&(t=this._indexBuffer);let s=this.getVertexBuffers();if(!s)return;if(t!=this._indexBuffer||!this._vertexArrayObjects&&!r){this._engine.bindBuffers(s,t,e,n);return}let o=r||this._vertexArrayObjects,a=this._engine;o[e.key]||(o[e.key]=a.recordVertexArrayObject(s,t,e,n)),a.bindVertexArrayObject(o[e.key],t)}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(e,t,n){let r=this.getVertexBuffer(e);return r?r.getFloatData(this._totalVertices,n||t&&this._meshes.length!==1):null}copyVerticesData(e,t){let n=this.getVertexBuffer(e);if(!n)return;t[e]||(t[e]=new Float32Array(this._totalVertices*n.getSize()));let r=n.getData();r&&mT(r,n.getSize(),n.type,n.byteOffset,n.byteStride,n.normalized,this._totalVertices,t[e])}isVertexBufferUpdatable(e){let t=this._vertexBuffers[e];return t?t.isUpdatable():!1}getVertexBuffer(e){return this.isReady()?this._vertexBuffers[e]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(e){return this._vertexBuffers?this._vertexBuffers[e]!==void 0:this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}getVerticesDataKinds(){let e=[],t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e}updateIndices(e,t,n=!1){if(this._indexBuffer)if(!this._indexBufferIsUpdatable)this.setIndices(e,null,!0);else{let r=e.length!==this._indices.length;if(n||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),r)for(let s of this._meshes)s._createGlobalSubMesh(!0)}}setIndexBuffer(e,t,n,r=null){this._indices=[],this._indexBufferIsUpdatable=!1,this._indexBuffer=e,this._totalVertices=t,this._totalIndices=n,r===null?e.is32Bits=t>65535:e.is32Bits=r;for(let s of this._meshes)s._createGlobalSubMesh(!0),s.synchronizeInstances();this._notifyUpdate()}setIndices(e,t=null,n=!1,r=!1){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=n,this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,n,"Geometry_"+this.id+"_IndexBuffer")),t!=null&&(this._totalVertices=t);for(let s of this._meshes)s._createGlobalSubMesh(!r),s.synchronizeInstances();this._notifyUpdate()}getTotalIndices(){return this.isReady()?this._totalIndices!==void 0?this._totalIndices:this._indices.length:0}getIndices(e,t){if(!this.isReady())return null;let n=this._indices;return!t&&(!e||this._meshes.length===1)?n:n.slice()}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(e=null){!e||!this._vertexArrayObjects||this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])}releaseForMesh(e,t){let n=this._meshes,r=n.indexOf(e);r!==-1&&(n.splice(r,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,n.length===0&&t&&this.dispose())}applyToMesh(e){if(e._geometry===this)return;let t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();let n=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),n.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}_updateExtend(e=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&(e=this.getVerticesData(S.PositionKind),!e))return;this._extend=GT(e,0,this._totalVertices,this.boundingBias,3)}}_applyToMesh(e){for(let t in this._vertexBuffers){let n=this._vertexBuffers[t];n._buffer.getBuffer()||n.create(),t===S.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo())}!this._indexBuffer&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable,"Geometry_"+this.id+"_IndexBuffer")),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()}_notifyUpdate(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(let t of this._meshes)t._markSubMeshesAsAttributesDirty()}load(e,t){if(this.delayLoadState!==2){if(this.isReady()){t&&t();return}this.delayLoadState=2,this._queueLoad(e,t)}}_queueLoad(e,t){this.delayLoadingFile&&(e.addPendingData(this),e._loadFile(this.delayLoadingFile,n=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(n),this),this.delayLoadState=1,this._delayInfo=[],e.removePendingData(this);let r=this._meshes,s=r.length;for(let o=0;o<s;o++)this._applyToMesh(r[o]);t&&t()},void 0,!0))}toLeftHanded(){let e=this.getIndices(!1);if(e!=null&&e.length>0){for(let r=0;r<e.length;r+=3){let s=e[r+0];e[r+0]=e[r+2],e[r+2]=s}this.setIndices(e)}let t=this.getVerticesData(S.PositionKind,!1);if(t!=null&&t.length>0){for(let r=0;r<t.length;r+=3)t[r+2]=-t[r+2];this.setVerticesData(S.PositionKind,t,!1)}let n=this.getVerticesData(S.NormalKind,!1);if(n!=null&&n.length>0){for(let r=0;r<n.length;r+=3)n[r+2]=-n[r+2];this.setVerticesData(S.NormalKind,n,!1)}}_resetPointsArrayCache(){this._positions=null}_generatePointsArray(){if(this._positions)return!0;let e=this.getVerticesData(S.PositionKind);if(!e||e.length===0)return!1;for(let t=this._positionsCache.length*3,n=this._positionsCache.length;t<e.length;t+=3,++n)this._positionsCache[n]=m.FromArray(e,t);for(let t=0,n=0;t<e.length;t+=3,++n)this._positionsCache[n].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(let n in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[n]);this._vertexArrayObjects={};let e=this._meshes,t=e.length;for(let n=0;n<t;n++)e[n]._invalidateInstanceVertexArrayObject()}}dispose(){let e=this._meshes,t=e.length,n;for(n=0;n<t;n++)this.releaseForMesh(e[n]);this._meshes.length=0,this._disposeVertexArrayObjects();for(let r in this._vertexBuffers)this._vertexBuffers[r].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){let r=this._parentContainer.geometries.indexOf(this);r>-1&&this._parentContainer.geometries.splice(r,1),this._parentContainer=null}this._isDisposed=!0}copy(e){let t=new i(e,this._scene),n=this.getIndices(void 0,!0);n&&t.setIndices(n);let r=!1,s;for(s in this._vertexBuffers){let o=this.getVertexBuffer(s),a=o.getData();if(!a)continue;let l=o.isUpdatable(),c=o.getSize(),{type:u,byteOffset:h,byteStride:d,normalized:f}=o;r=r||l;let p=pT(a,c,u,h,d,this._totalVertices,!0),g=new S(this._engine,p,s,{updatable:l,useBytes:!1,stride:c,size:c,offset:0,type:u,normalized:f,takeBufferOwnership:!0});t.setVerticesBuffer(g,this._totalVertices)}t._updatable=r,t.delayLoadState=this.delayLoadState,t.delayLoadingFile=this.delayLoadingFile,t._delayLoadingFunction=this._delayLoadingFunction;for(s in this._delayInfo)t._delayInfo=t._delayInfo||[],t._delayInfo.push(s);return t._boundingInfo=new Xr(this._extend.minimum,this._extend.maximum),t}serialize(){let e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,Tt&&Tt.HasTags(this)&&(e.tags=Tt.GetTags(this)),e}_toNumberArray(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}clearCachedData(){this._indices=[],this._resetPointsArrayCache();for(let e in this._vertexBuffers)Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)&&(this._vertexBuffers[e]._buffer._data=null)}serializeVerticeData(){let e=this.serialize();return this.isVerticesDataPresent(S.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(S.PositionKind)),this.isVertexBufferUpdatable(S.PositionKind)&&(e.positionsUpdatable=!0)),this.isVerticesDataPresent(S.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(S.NormalKind)),this.isVertexBufferUpdatable(S.NormalKind)&&(e.normalsUpdatable=!0)),this.isVerticesDataPresent(S.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(S.TangentKind)),this.isVertexBufferUpdatable(S.TangentKind)&&(e.tangentsUpdatable=!0)),this.isVerticesDataPresent(S.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(S.UVKind)),this.isVertexBufferUpdatable(S.UVKind)&&(e.uvsUpdatable=!0)),this.isVerticesDataPresent(S.UV2Kind)&&(e.uvs2=this._toNumberArray(this.getVerticesData(S.UV2Kind)),this.isVertexBufferUpdatable(S.UV2Kind)&&(e.uvs2Updatable=!0)),this.isVerticesDataPresent(S.UV3Kind)&&(e.uvs3=this._toNumberArray(this.getVerticesData(S.UV3Kind)),this.isVertexBufferUpdatable(S.UV3Kind)&&(e.uvs3Updatable=!0)),this.isVerticesDataPresent(S.UV4Kind)&&(e.uvs4=this._toNumberArray(this.getVerticesData(S.UV4Kind)),this.isVertexBufferUpdatable(S.UV4Kind)&&(e.uvs4Updatable=!0)),this.isVerticesDataPresent(S.UV5Kind)&&(e.uvs5=this._toNumberArray(this.getVerticesData(S.UV5Kind)),this.isVertexBufferUpdatable(S.UV5Kind)&&(e.uvs5Updatable=!0)),this.isVerticesDataPresent(S.UV6Kind)&&(e.uvs6=this._toNumberArray(this.getVerticesData(S.UV6Kind)),this.isVertexBufferUpdatable(S.UV6Kind)&&(e.uvs6Updatable=!0)),this.isVerticesDataPresent(S.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(S.ColorKind)),this.isVertexBufferUpdatable(S.ColorKind)&&(e.colorsUpdatable=!0)),this.isVerticesDataPresent(S.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(S.MatricesIndicesKind)),e.matricesIndicesExpanded=!0,this.isVertexBufferUpdatable(S.MatricesIndicesKind)&&(e.matricesIndicesUpdatable=!0)),this.isVerticesDataPresent(S.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(S.MatricesWeightsKind)),this.isVertexBufferUpdatable(S.MatricesWeightsKind)&&(e.matricesWeightsUpdatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e}static ExtractFromMesh(e,t){let n=e._geometry;return n?n.copy(t):null}static RandomId(){return z.RandomId()}static _GetGeometryByLoadedUniqueId(e,t){for(let n=0;n<t.geometries.length;n++)if(t.geometries[n]._loadedUniqueId===e)return t.geometries[n];return null}static _ImportGeometry(e,t){let n=t.getScene(),r=e.geometryUniqueId,s=e.geometryId;if(r||s){let o=r?this._GetGeometryByLoadedUniqueId(r,n):n.getGeometryById(s);o&&o.applyToMesh(t)}else if(e instanceof ArrayBuffer){let o=t._binaryInfo;if(o.positionsAttrDesc&&o.positionsAttrDesc.count>0){let a=new Float32Array(e,o.positionsAttrDesc.offset,o.positionsAttrDesc.count);t.setVerticesData(S.PositionKind,a,!1)}if(o.normalsAttrDesc&&o.normalsAttrDesc.count>0){let a=new Float32Array(e,o.normalsAttrDesc.offset,o.normalsAttrDesc.count);t.setVerticesData(S.NormalKind,a,!1)}if(o.tangetsAttrDesc&&o.tangetsAttrDesc.count>0){let a=new Float32Array(e,o.tangetsAttrDesc.offset,o.tangetsAttrDesc.count);t.setVerticesData(S.TangentKind,a,!1)}if(o.uvsAttrDesc&&o.uvsAttrDesc.count>0){let a=new Float32Array(e,o.uvsAttrDesc.offset,o.uvsAttrDesc.count);if(we)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(S.UVKind,a,!1)}if(o.uvs2AttrDesc&&o.uvs2AttrDesc.count>0){let a=new Float32Array(e,o.uvs2AttrDesc.offset,o.uvs2AttrDesc.count);if(we)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(S.UV2Kind,a,!1)}if(o.uvs3AttrDesc&&o.uvs3AttrDesc.count>0){let a=new Float32Array(e,o.uvs3AttrDesc.offset,o.uvs3AttrDesc.count);if(we)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(S.UV3Kind,a,!1)}if(o.uvs4AttrDesc&&o.uvs4AttrDesc.count>0){let a=new Float32Array(e,o.uvs4AttrDesc.offset,o.uvs4AttrDesc.count);if(we)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(S.UV4Kind,a,!1)}if(o.uvs5AttrDesc&&o.uvs5AttrDesc.count>0){let a=new Float32Array(e,o.uvs5AttrDesc.offset,o.uvs5AttrDesc.count);if(we)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(S.UV5Kind,a,!1)}if(o.uvs6AttrDesc&&o.uvs6AttrDesc.count>0){let a=new Float32Array(e,o.uvs6AttrDesc.offset,o.uvs6AttrDesc.count);if(we)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(S.UV6Kind,a,!1)}if(o.colorsAttrDesc&&o.colorsAttrDesc.count>0){let a=new Float32Array(e,o.colorsAttrDesc.offset,o.colorsAttrDesc.count);t.setVerticesData(S.ColorKind,a,!1,o.colorsAttrDesc.stride)}if(o.matricesIndicesAttrDesc&&o.matricesIndicesAttrDesc.count>0){let a=new Int32Array(e,o.matricesIndicesAttrDesc.offset,o.matricesIndicesAttrDesc.count),l=[];for(let c=0;c<a.length;c++){let u=a[c];l.push(u&255),l.push((u&65280)>>8),l.push((u&16711680)>>16),l.push(u>>24&255)}t.setVerticesData(S.MatricesIndicesKind,l,!1)}if(o.matricesIndicesExtraAttrDesc&&o.matricesIndicesExtraAttrDesc.count>0){let a=new Int32Array(e,o.matricesIndicesExtraAttrDesc.offset,o.matricesIndicesExtraAttrDesc.count),l=[];for(let c=0;c<a.length;c++){let u=a[c];l.push(u&255),l.push((u&65280)>>8),l.push((u&16711680)>>16),l.push(u>>24&255)}t.setVerticesData(S.MatricesIndicesExtraKind,l,!1)}if(o.matricesWeightsAttrDesc&&o.matricesWeightsAttrDesc.count>0){let a=new Float32Array(e,o.matricesWeightsAttrDesc.offset,o.matricesWeightsAttrDesc.count);t.setVerticesData(S.MatricesWeightsKind,a,!1)}if(o.indicesAttrDesc&&o.indicesAttrDesc.count>0){let a=new Int32Array(e,o.indicesAttrDesc.offset,o.indicesAttrDesc.count);t.setIndices(a,null)}if(o.subMeshesAttrDesc&&o.subMeshesAttrDesc.count>0){let a=new Int32Array(e,o.subMeshesAttrDesc.offset,o.subMeshesAttrDesc.count*5);t.subMeshes=[];for(let l=0;l<o.subMeshesAttrDesc.count;l++){let c=a[l*5+0],u=a[l*5+1],h=a[l*5+2],d=a[l*5+3],f=a[l*5+4];ei.AddToMesh(c,u,h,d,f,t)}}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(S.PositionKind,e.positions,e.positions._updatable||e.positionsUpdatable),t.setVerticesData(S.NormalKind,e.normals,e.normals._updatable||e.normalsUpdatable),e.tangents&&t.setVerticesData(S.TangentKind,e.tangents,e.tangents._updatable||e.tangentsUpdatable),e.uvs&&t.setVerticesData(S.UVKind,e.uvs,e.uvs._updatable||e.uvsUpdatable),e.uvs2&&t.setVerticesData(S.UV2Kind,e.uvs2,e.uvs2._updatable||e.uvs2Updatable),e.uvs3&&t.setVerticesData(S.UV3Kind,e.uvs3,e.uvs3._updatable||e.uvs3Updatable),e.uvs4&&t.setVerticesData(S.UV4Kind,e.uvs4,e.uvs4._updatable||e.uvs4Updatable),e.uvs5&&t.setVerticesData(S.UV5Kind,e.uvs5,e.uvs5._updatable||e.uvs5Updatable),e.uvs6&&t.setVerticesData(S.UV6Kind,e.uvs6,e.uvs6._updatable||e.uvs6Updatable),e.colors&&t.setVerticesData(S.ColorKind,le.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(!e.matricesIndices._isExpanded&&!e.matricesIndicesExpanded){let o=[];for(let a=0;a<e.matricesIndices.length;a++){let l=e.matricesIndices[a];o.push(l&255),o.push((l&65280)>>8),o.push((l&16711680)>>16),o.push(l>>24&255)}t.setVerticesData(S.MatricesIndicesKind,o,e.matricesIndices._updatable||e.matricesIndicesUpdatable)}else delete e.matricesIndices._isExpanded,delete e.matricesIndicesExpanded,t.setVerticesData(S.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable||e.matricesIndicesUpdatable);if(e.matricesIndicesExtra)if(e.matricesIndicesExtraExpanded||e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,delete e.matricesIndicesExtraExpanded,t.setVerticesData(S.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable||e.matricesIndicesExtraUpdatable);else{let o=[];for(let a=0;a<e.matricesIndicesExtra.length;a++){let l=e.matricesIndicesExtra[a];o.push(l&255),o.push((l&65280)>>8),o.push((l&16711680)>>16),o.push(l>>24&255)}t.setVerticesData(S.MatricesIndicesExtraKind,o,e.matricesIndicesExtra._updatable||e.matricesIndicesExtraUpdatable)}e.matricesWeights&&(i._CleanMatricesWeights(e,t),t.setVerticesData(S.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(S.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null)}if(e.subMeshes){t.subMeshes=[];for(let o=0;o<e.subMeshes.length;o++){let a=e.subMeshes[o];ei.AddToMesh(a.materialIndex,a.verticesStart,a.verticesCount,a.indexStart,a.indexCount,t)}}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),t._shouldGenerateFlatShading=!1),t.computeWorldMatrix(!0),n.onMeshImportedObservable.notifyObservers(t)}static _CleanMatricesWeights(e,t){if(!ai.CleanBoneMatrixWeights)return;let r=0;if(e.skeletonId>-1){let h=t.getScene().getLastSkeletonById(e.skeletonId);if(!h)return;r=h.bones.length}else return;let s=t.getVerticesData(S.MatricesIndicesKind),o=t.getVerticesData(S.MatricesIndicesExtraKind),a=e.matricesWeights,l=e.matricesWeightsExtra,c=e.numBoneInfluencer,u=a.length;for(let h=0;h<u;h+=4){let d=0,f=-1;for(let p=0;p<4;p++){let g=a[h+p];d+=g,g<.001&&f<0&&(f=p)}if(l)for(let p=0;p<4;p++){let g=l[h+p];d+=g,g<.001&&f<0&&(f=p+4)}if((f<0||f>c-1)&&(f=c-1),d>.001){let p=1/d;for(let g=0;g<4;g++)a[h+g]*=p;if(l)for(let g=0;g<4;g++)l[h+g]*=p}else f>=4?(l[h+f-4]=1-d,o[h+f-4]=r):(a[h+f]=1-d,s[h+f]=r)}t.setVerticesData(S.MatricesIndicesKind,s),e.matricesWeightsExtra&&t.setVerticesData(S.MatricesIndicesExtraKind,o)}static Parse(e,t,n){let r=new i(e.id,t,void 0,e.updatable);return r._loadedUniqueId=e.uniqueId,Tt&&Tt.AddTagsTo(r,e.tags),e.delayLoadingFile?(r.delayLoadState=4,r.delayLoadingFile=n+e.delayLoadingFile,r._boundingInfo=new Xr(m.FromArray(e.boundingBoxMinimum),m.FromArray(e.boundingBoxMaximum)),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(S.UVKind),e.hasUVs2&&r._delayInfo.push(S.UV2Kind),e.hasUVs3&&r._delayInfo.push(S.UV3Kind),e.hasUVs4&&r._delayInfo.push(S.UV4Kind),e.hasUVs5&&r._delayInfo.push(S.UV5Kind),e.hasUVs6&&r._delayInfo.push(S.UV6Kind),e.hasColors&&r._delayInfo.push(S.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(S.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(S.MatricesWeightsKind),r._delayLoadingFunction=X.ImportVertexData):X.ImportVertexData(e,r),t.pushGeometry(r,!0),r}};var zs=class i extends Oe{get subMaterials(){return this._subMaterials}set subMaterials(e){this._subMaterials=e,this._hookArray(e)}getChildren(){return this.subMaterials}constructor(e,t){super(e,t,!0),this._waitingSubMaterialsUniqueIds=[],this.getScene().addMultiMaterial(this),this.subMaterials=[],this._storeEffectOnSubMeshes=!0}_hookArray(e){let t=e.push;e.push=(...r)=>{let s=t.apply(e,r);return this._markAllSubMeshesAsTexturesDirty(),s};let n=e.splice;e.splice=(r,s)=>{let o=n.apply(e,[r,s]);return this._markAllSubMeshesAsTexturesDirty(),o}}getSubMaterial(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map(e=>e?e.getActiveTextures():[]))}hasTexture(e){if(super.hasTexture(e))return!0;for(let t=0;t<this.subMaterials.length;t++)if(this.subMaterials[t]?.hasTexture(e))return!0;return!1}getClassName(){return"MultiMaterial"}isReadyForSubMesh(e,t,n){for(let r=0;r<this.subMaterials.length;r++){let s=this.subMaterials[r];if(s){if(s._storeEffectOnSubMeshes){if(!s.isReadyForSubMesh(e,t,n))return!1;continue}if(!s.isReady(e))return!1}}return!0}clone(e,t){let n=new i(e,this.getScene());for(let r=0;r<this.subMaterials.length;r++){let s=null,o=this.subMaterials[r];t&&o?s=o.clone(e+"-"+o.name):s=this.subMaterials[r],n.subMaterials.push(s)}return n}serialize(){let e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,Tt&&(e.tags=Tt.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(let t=0;t<this.subMaterials.length;t++){let n=this.subMaterials[t];n?(e.materialsUniqueIds.push(n.uniqueId),e.materials.push(n.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e}dispose(e,t,n){let r=this.getScene();if(!r)return;if(n)for(let o=0;o<this.subMaterials.length;o++){let a=this.subMaterials[o];a&&a.dispose(e,t)}let s=r.multiMaterials.indexOf(this);s>=0&&r.multiMaterials.splice(s,1),super.dispose(e,t)}static ParseMultiMaterial(e,t){let n=new i(e.name,t);if(n.id=e.id,n._loadedUniqueId=e.uniqueId,Tt&&Tt.AddTagsTo(n,e.tags),e.materialsUniqueIds)n._waitingSubMaterialsUniqueIds=e.materialsUniqueIds;else for(let r of e.materials)n.subMaterials.push(t.getLastMaterialById(r));return n}};ue("BABYLON.MultiMaterial",zs);var fp=class{constructor(e,t){this.distanceOrScreenCoverage=e,this.mesh=t}};var Al=class{},rb=class{constructor(){this.batchCache=new pp(this),this.batchCacheReplacementModeInFrozenMode=new pp(this),this.instancesBufferSize=512*4}},sb=class{constructor(){this.renderPasses={}}},pp=class{constructor(e){this.parent=e,this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=[],this.hardwareInstancedRendering=[]}},ob=class{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=512,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}},ab=class{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0,this._overrideRenderingFillMode=null}},kr={source:null,parent:null,doNotCloneChildren:!1,clonePhysicsImpostor:!0,cloneThinInstances:!1},A=class i extends _i{static _GetDefaultSideOrientation(e){return e||i.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels()}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(S.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(S.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new B),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new B),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new B),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new B),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new B),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){return(this.forcedInstanceCount||this._thinInstanceDataStorage.instancesCount||0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e}get sideOrientation(){return this._internalMeshDataInfo._sideOrientation}set sideOrientation(e){this._internalMeshDataInfo._sideOrientation=e,this._internalAbstractMeshDataInfo._sideOrientationHint=this._scene.useRightHandedSystem&&e===1||!this._scene.useRightHandedSystem&&e===0}get _effectiveSideOrientation(){return this._internalMeshDataInfo._effectiveSideOrientation}get overrideMaterialSideOrientation(){return this.sideOrientation}set overrideMaterialSideOrientation(e){this.sideOrientation=e,this.material&&(this.material.sideOrientation=null)}get overrideRenderingFillMode(){return this._internalMeshDataInfo._overrideRenderingFillMode}set overrideRenderingFillMode(e){this._internalMeshDataInfo._overrideRenderingFillMode=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){e&&(this.material&&this.material.sideOrientation===null||this._internalAbstractMeshDataInfo._sideOrientationHint)&&(e.sideOrientation=null),this._setMaterial(e)}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){let e=this._instanceDataStorage.renderPasses[this._instanceDataStorage.engine.isWebGPU?this._instanceDataStorage.engine.currentRenderPassId:0];return e?e.instancesData:void 0}get previousWorldMatrixInstancedBuffer(){let e=this._instanceDataStorage.renderPasses[this._instanceDataStorage.engine.isWebGPU?this._instanceDataStorage.engine.currentRenderPassId:0];return e?e.instancesPreviousData:void 0}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(e){this._instanceDataStorage.forceMatrixUpdates=e}_copySource(e,t,n=!0,r=!1){let s=this.getScene();if(e._geometry&&e._geometry.applyToMesh(this),xt.DeepCopy(e,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo","physicsBody","physicsImpostor"],["_poseMatrix"]),this._internalMeshDataInfo._source=e,s.useClonedMeshMap&&(e._internalMeshDataInfo.meshMap||(e._internalMeshDataInfo.meshMap={}),e._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=e._originalBuilderSideOrientation,this._creationDataStorage=e._creationDataStorage,e._ranges){let o=e._ranges;for(let a in o)Object.prototype.hasOwnProperty.call(o,a)&&o[a]&&this.createAnimationRange(a,o[a].from,o[a].to)}if(e.metadata&&e.metadata.clone?this.metadata=e.metadata.clone():this.metadata=e.metadata,this._internalMetadata=e._internalMetadata,Tt&&Tt.HasTags(e)&&Tt.AddTagsTo(this,Tt.GetTags(e,!0)),this.setEnabled(e.isEnabled(!1)),this.parent=e.parent,this.setPivotMatrix(e.getPivotMatrix(),this._postMultiplyPivotMatrix),this.id=this.name+"."+e.id,this.material=e.material,!t){let o=e.getDescendants(!0);for(let a=0;a<o.length;a++){let l=o[a];l._isMesh?(kr.parent=this,kr.doNotCloneChildren=t,kr.clonePhysicsImpostor=n,kr.cloneThinInstances=r,l.clone(this.name+"."+l.name,kr)):l.clone&&l.clone(this.name+"."+l.name,this)}}if(e.morphTargetManager&&(this.morphTargetManager=e.morphTargetManager),s.getPhysicsEngine){let o=s.getPhysicsEngine();if(n&&o)if(o.getPluginVersion()===1){let a=o.getImpostorForPhysicsObject(e);a&&(this.physicsImpostor=a.clone(this))}else o.getPluginVersion()===2&&e.physicsBody&&e.physicsBody.clone(this)}for(let o=0;o<s.particleSystems.length;o++){let a=s.particleSystems[o];a.emitter===e&&a.clone(a.name,this)}if(this.skeleton=e.skeleton,r&&(e._thinInstanceDataStorage.matrixData?(this.thinInstanceSetBuffer("matrix",new Float32Array(e._thinInstanceDataStorage.matrixData),16,!e._thinInstanceDataStorage.matrixBuffer.isUpdatable()),this._thinInstanceDataStorage.matrixBufferSize=e._thinInstanceDataStorage.matrixBufferSize,this._thinInstanceDataStorage.instancesCount=e._thinInstanceDataStorage.instancesCount):this._thinInstanceDataStorage.matrixBufferSize=e._thinInstanceDataStorage.matrixBufferSize,e._userThinInstanceBuffersStorage)){let o=e._userThinInstanceBuffersStorage;for(let a in o.data)this.thinInstanceSetBuffer(a,new Float32Array(o.data[a]),o.strides[a],!o.vertexBuffers?.[a]?.isUpdatable()),this._userThinInstanceBuffersStorage.sizes[a]=o.sizes[a]}this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}constructor(e,t=null,n=null,r=null,s,o=!0){super(e,t),this._internalMeshDataInfo=new ab,this.delayLoadState=0,this.instances=[],this._creationDataStorage=null,this._geometry=null,this._thinInstanceDataStorage=new ob,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=i.DEFAULTSIDE,this.ignoreCameraMaxZ=!1,t=this.getScene(),this._instanceDataStorage=new sb,this._instanceDataStorage.engine=t.getEngine(),this._scene.useRightHandedSystem?this.sideOrientation=0:this.sideOrientation=1,this._onBeforeDraw=(c,u,h)=>{c&&h&&(this._uniformBuffer?this.transferToEffect(u):h.bindOnlyWorldMatrix(u))};let a=null,l=!1;if(n&&n._addToSceneRootNodes===void 0){let c=n;a=c.parent??null,r=c.source??null,s=c.doNotCloneChildren??!1,o=c.clonePhysicsImpostor??!0,l=c.cloneThinInstances??!1}else a=n;r&&this._copySource(r,s,o,l),a!==null&&(this.parent=a),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=c=>{c.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add(()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))}))},this.onMeshReadyObservable=new B(this._internalMeshDataInfo._onMeshReadyObserverAdded),r&&r.onClonedObservable.notifyObservers(this)}instantiateHierarchy(e=null,t,n){let r=this.getTotalVertices()===0||t&&t.doNotInstantiate&&(t.doNotInstantiate===!0||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));r.parent=e||this.parent,r.position=this.position.clone(),r.scaling=this.scaling.clone(),this.rotationQuaternion?r.rotationQuaternion=this.rotationQuaternion.clone():r.rotation=this.rotation.clone(),n&&n(this,r);for(let s of this.getChildTransformNodes(!0))s.getClassName()==="InstancedMesh"&&r.getClassName()==="Mesh"&&s.sourceMesh===this?s.instantiateHierarchy(r,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:r},n):s.instantiateHierarchy(r,t,n);return r}getClassName(){return"Mesh"}get _isMesh(){return!0}toString(e){let t=super.toString(e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let n=0;n<this.animations.length;n++)t+=", animation[0]: "+this.animations[n].toString(e);if(e)if(this._geometry){let n=this.getIndices(),r=this.getVerticesData(S.PositionKind);r&&n&&(t+=", flat shading: "+(r.length/3===n.length?"YES":"NO"))}else t+=", flat shading: UNKNOWN";return t}_unBindEffect(){super._unBindEffect();for(let e of this.instances)e._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){let e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort((t,n)=>t.distanceOrScreenCoverage<n.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>n.distanceOrScreenCoverage?-e:0)}addLODLevel(e,t){if(t&&t._masterMesh)return N.Warn("You cannot use a mesh as LOD level twice"),this;let n=new fp(e,t);return this._internalMeshDataInfo._LODLevels.push(n),t&&(t._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){let t=this._internalMeshDataInfo;for(let n=0;n<t._LODLevels.length;n++){let r=t._LODLevels[n];if(r.distanceOrScreenCoverage===e)return r.mesh}return null}removeLODLevel(e){let t=this._internalMeshDataInfo;for(let n=0;n<t._LODLevels.length;n++)t._LODLevels[n].mesh===e&&(t._LODLevels.splice(n,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,t){let n=this._internalMeshDataInfo;if(!n._LODLevels||n._LODLevels.length===0)return this;let r=t||this.getBoundingInfo().boundingSphere,s=e.mode===Ne.ORTHOGRAPHIC_CAMERA?e.minZ:r.centerWorld.subtract(e.globalPosition).length(),o=s,a=1;if(n._useLODScreenCoverage){let l=e.screenArea,c=r.radiusWorld*e.minZ/s;c=c*c*Math.PI,o=c/l,a=-1}if(a*n._LODLevels[n._LODLevels.length-1].distanceOrScreenCoverage>a*o)return this.onLODLevelSelection&&this.onLODLevelSelection(o,this,this),this;for(let l=0;l<n._LODLevels.length;l++){let c=n._LODLevels[l];if(a*c.distanceOrScreenCoverage<a*o){if(c.mesh){if(c.mesh.delayLoadState===4)return c.mesh._checkDelayState(),this;if(c.mesh.delayLoadState===2)return this;c.mesh._preActivate(),c.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(o,this,c.mesh),c.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(o,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return this._geometry===null||this._geometry===void 0?0:this._geometry.getTotalVertices()}getVerticesData(e,t,n,r){if(!this._geometry)return null;let s=r?void 0:this._userInstancedBuffersStorage?.vertexBuffers[e]?.getFloatData(this.instances.length+1,n||t&&this._geometry.meshes.length!==1);return s||(s=this._geometry.getVerticesData(e,t,n)),s}copyVerticesData(e,t){this._geometry&&this._geometry.copyVerticesData(e,t)}getVertexBuffer(e,t){return this._geometry?(t?void 0:this._userInstancedBuffersStorage?.vertexBuffers[e])??this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e,t){return this._geometry?!t&&this._userInstancedBuffersStorage?.vertexBuffers[e]!==void 0||this._geometry.isVerticesDataPresent(e):this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}isVertexBufferUpdatable(e,t){if(!this._geometry)return this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1;if(!t){let n=this._userInstancedBuffersStorage?.vertexBuffers[e];if(n)return n.isUpdatable()}return this._geometry.isVertexBufferUpdatable(e)}getVerticesDataKinds(e){if(!this._geometry){let n=[];if(this._delayInfo)for(let r of this._delayInfo)n.push(r);return n}let t=this._geometry.getVerticesDataKinds();if(!e&&this._userInstancedBuffersStorage)for(let n in this._userInstancedBuffersStorage.vertexBuffers)t.indexOf(n)===-1&&t.push(n);return t}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}get isBlocked(){return this._masterMesh!==null&&this._masterMesh!==void 0}isReady(e=!1,t=!1){if(this.delayLoadState===2||!super.isReady(e))return!1;if(!this.subMeshes||this.subMeshes.length===0||!e)return!0;let n=this.getEngine(),r=this.getScene(),s=t||n.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();let o=this.material||r.defaultMaterial;if(o){if(o._storeEffectOnSubMeshes)for(let l of this.subMeshes){let c=l.getMaterial();if(c){if(c._storeEffectOnSubMeshes){if(!c.isReadyForSubMesh(this,l,s))return!1}else if(!c.isReady(this,s))return!1}}else if(!o.isReady(this,s))return!1}let a=n.currentRenderPassId;for(let l of this.lightSources){let c=l.getShadowGenerators();if(!c)continue;let u=c.values();for(let h=u.next();h.done!==!0;h=u.next()){let d=h.value;if(d&&(!d.getShadowMap()?.renderList||d.getShadowMap()?.renderList&&d.getShadowMap()?.renderList?.indexOf(this)!==-1)){let p=d.getShadowMap().renderPassIds??[n.currentRenderPassId];for(let g=0;g<p.length;++g){n.currentRenderPassId=p[g];for(let _ of this.subMeshes)if(!d.isReady(_,s,_.getMaterial()?.needAlphaBlendingForMesh(this)??!1))return n.currentRenderPassId=a,!1}n.currentRenderPassId=a}}}for(let l of this._internalMeshDataInfo._LODLevels)if(l.mesh&&!l.mesh.isReady(s))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e}_getInstanceDataStorage(){let e=this._instanceDataStorage.engine.isWebGPU?this._instanceDataStorage.engine.currentRenderPassId:0,t=this._instanceDataStorage.renderPasses[e];return t||(t=new rb,this._instanceDataStorage.renderPasses[e]=t),t}_preActivate(){let e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t?this:(e._preActivateId=t,this._getInstanceDataStorage().visibleInstances=null,this)}_preActivateForIntermediateRendering(e){let t=this._getInstanceDataStorage();return t.visibleInstances&&(t.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,t){let n=this._getInstanceDataStorage();return n.visibleInstances||(n.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId,intermediateDefaultRenderId:-1}),n.visibleInstances[t]||(n.previousRenderId!==void 0&&this._instanceDataStorage.isFrozen&&(n.visibleInstances[n.previousRenderId]=null),n.previousRenderId=t,n.visibleInstances[t]=new Array),n.visibleInstances[t].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let n;typeof e=="object"?n=e:n={applySkeleton:e,applyMorph:t};let r=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getData(n,null,S.PositionKind),r),this}_createGlobalSubMesh(e){let t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){let n=this.getIndices();if(!n)return null;let r=n.length,s=!1;if(e)s=!0;else for(let o of this.subMeshes){if(o.indexStart+o.indexCount>r){s=!0;break}if(o.verticesStart+o.verticesCount>t){s=!0;break}}if(!s)return this.subMeshes[0]}return this.releaseSubMeshes(),new ei(0,0,t,0,this.getTotalIndices()||(this.isUnIndexed?t:0),this)}subdivide(e){if(e<1)return;let t=this.getTotalIndices(),n=t/e|0,r=0;for(;n%3!==0;)n++;this.releaseSubMeshes();for(let s=0;s<e&&!(r>=t);s++)ei.CreateFromIndices(0,r,s===e-1?t-r:n,this,void 0,!1),r+=n;this.refreshBoundingInfo(),this.synchronizeInstances()}setVerticesData(e,t,n=!1,r){if(this._geometry)this._geometry.setVerticesData(e,t,n,r);else{let s=new X;s.set(t,e);let o=this.getScene();new jt(jt.RandomId(),o,s,n,this)}return this}removeVerticesData(e){this._geometry&&this._geometry.removeVerticesData(e)}markVerticesDataAsUpdatable(e,t=!0){let n=this.getVertexBuffer(e);!n||n.isUpdatable()===t||this.setVerticesData(e,this.getVerticesData(e),t)}setVerticesBuffer(e,t=!0){return this._geometry||(this._geometry=jt.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}updateVerticesData(e,t,n,r){return this._geometry?(r?(this.makeGeometryUnique(),this.updateVerticesData(e,t,n,!1)):this._geometry.updateVerticesData(e,t,n),this):this}updateMeshPositions(e,t=!0){let n=this.getVerticesData(S.PositionKind);if(!n)return this;if(e(n),this.updateVerticesData(S.PositionKind,n,!1,!1),t){let r=this.getIndices(),s=this.getVerticesData(S.NormalKind);if(!s)return this;X.ComputeNormals(n,r,s),this.updateVerticesData(S.NormalKind,s,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry)return this;if(this._geometry.meshes.length===1)return this;let e=this._geometry,t=this._geometry.copy(jt.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}setIndexBuffer(e,t,n,r=null){let s=this._geometry;s||(s=new jt(jt.RandomId(),this.getScene(),void 0,void 0,this)),s.setIndexBuffer(e,t,n,r)}setIndices(e,t=null,n=!1,r=!1){if(this._geometry)this._geometry.setIndices(e,t,n,r);else{let s=new X;s.indices=e;let o=this.getScene();new jt(jt.RandomId(),o,s,n,this)}return this}updateIndices(e,t,n=!1){return this._geometry?(this._geometry.updateIndices(e,t,n),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(e,t,n,r=!0){if(!this._geometry)return this;let s=this.getScene().getEngine(),o;if(this._unIndexed)switch(this._getRenderingFillMode(n)){case Oe.WireFrameFillMode:o=e._getLinesIndexBuffer(this.getIndices(),s);break;default:o=null;break}else switch(this._getRenderingFillMode(n)){case Oe.PointFillMode:o=null;break;case Oe.WireFrameFillMode:o=e._getLinesIndexBuffer(this.getIndices(),s);break;default:case Oe.TriangleFillMode:o=this._geometry.getIndexBuffer();break}return this._bindDirect(t,o,r)}_bindDirect(e,t,n=!0){if(!this._geometry)return this;if(this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(e),!n||!this._userInstancedBuffersStorage||this.hasThinInstances)this._geometry._bind(e,t);else{if(this._instanceDataStorage.engine.isWebGPU&&this._userInstancedBuffersStorage.renderPasses&&this._userInstancedBuffersStorage.renderPasses[this._instanceDataStorage.engine.currentRenderPassId]){let r=this._userInstancedBuffersStorage.renderPasses[this._instanceDataStorage.engine.currentRenderPassId];for(let s in r)this._userInstancedBuffersStorage.vertexBuffers[s]=r[s]}this._geometry._bind(e,t,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects)}return this}_draw(e,t,n){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);let s=this.getScene().getEngine(),o=s._currentMaterialContext,a=o&&o.useVertexPulling;return this._unIndexed&&t!==Oe.WireFrameFillMode||t==Oe.PointFillMode?s.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||n):t==Oe.WireFrameFillMode?s.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||n):a?s.drawArraysType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||n):s.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||n),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,t=!1){let n=this._getInstanceDataStorage();if(this._instanceDataStorage.isFrozen){if(t)return n.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,n.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,n.batchCacheReplacementModeInFrozenMode;if(n.previousBatch)return n.previousBatch}let r=this.getScene(),s=r._isInIntermediateRendering(),o=s?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,a=n.batchCache;if(a.mustReturn=!1,a.renderSelf[e]=t||!o&&this.isEnabled()&&this.isVisible,a.visibleInstances[e]=null,n.visibleInstances&&!t){let l=n.visibleInstances,c=r.getRenderId(),u=s?l.intermediateDefaultRenderId:l.defaultRenderId;a.visibleInstances[e]=l[c],!a.visibleInstances[e]&&u&&(a.visibleInstances[e]=l[u])}return a.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&a.visibleInstances[e]!==null&&a.visibleInstances[e]!==void 0,n.previousBatch=a,a}_updateInstancedBuffers(e,t,n,r,s,o){let a=t.visibleInstances[e._id],l=a?a.length:0,c=t.parent,u=this._instanceDataStorage,h=c.instancesBuffer,d=c.instancesPreviousBuffer,f=0,p=0,g=t.renderSelf[e._id],_=this._scene.floatingOriginOffset,y=!h||n!==c.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!c.instancesPreviousBuffer;if(!this._instanceDataStorage.manualUpdate&&(!u.isFrozen||y)){let C=this.getWorldMatrix();if(g&&(this._scene.needsPreviousWorldMatrices&&(u.masterMeshPreviousWorldMatrix?(u.masterMeshPreviousWorldMatrix.copyToArray(c.instancesPreviousData,f),u.masterMeshPreviousWorldMatrix.copyFrom(C)):(u.masterMeshPreviousWorldMatrix=C.clone(),u.masterMeshPreviousWorldMatrix.copyToArray(c.instancesPreviousData,f))),C.copyToArray(c.instancesData,f),c.instancesData[f+12]-=_.x,c.instancesData[f+13]-=_.y,c.instancesData[f+14]-=_.z,f+=16,p++),a){if(i.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&e.getMaterial()?.needAlphaBlendingForMesh(e.getRenderingMesh())){let E=this._scene.activeCamera.globalPosition;for(let I=0;I<a.length;I++){let v=a[I];v._distanceToCamera=m.Distance(v.getBoundingInfo().boundingSphere.centerWorld,E)}a.sort((I,v)=>I._distanceToCamera>v._distanceToCamera?-1:I._distanceToCamera<v._distanceToCamera?1:0)}for(let E=0;E<a.length;E++){let I=a[E],v=I.getWorldMatrix();v.copyToArray(c.instancesData,f),this._scene.needsPreviousWorldMatrices&&(I._previousWorldMatrix?(I._previousWorldMatrix.copyToArray(c.instancesPreviousData,f),I._previousWorldMatrix.copyFrom(v)):(I._previousWorldMatrix=v.clone(),I._previousWorldMatrix.copyToArray(c.instancesPreviousData,f))),c.instancesData[f+12]-=_.x,c.instancesData[f+13]-=_.y,c.instancesData[f+14]-=_.z,f+=16,p++}}}else p=(g?1:0)+l;if(y){h&&h.dispose(),d&&d.dispose(),h=new Cn(r,c.instancesData,!0,16,!1,!0),c.instancesBuffer=h,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0});let C;if(this._instanceDataStorage.engine.isWebGPU){this._userInstancedBuffersStorage.renderPasses||(this._userInstancedBuffersStorage.renderPasses={});let E=this._instanceDataStorage.engine.currentRenderPassId;C=this._userInstancedBuffersStorage.renderPasses[E],C||(this._userInstancedBuffersStorage.renderPasses[E]=C={})}else C=this._userInstancedBuffersStorage.vertexBuffers;C.world0=h.createVertexBuffer("world0",0,4),C.world1=h.createVertexBuffer("world1",4,4),C.world2=h.createVertexBuffer("world2",8,4),C.world3=h.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(d=new Cn(r,c.instancesPreviousData,!0,16,!1,!0),c.instancesPreviousBuffer=d,C.previousWorld0=d.createVertexBuffer("previousWorld0",0,4),C.previousWorld1=d.createVertexBuffer("previousWorld1",4,4),C.previousWorld2=d.createVertexBuffer("previousWorld2",8,4),C.previousWorld3=d.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()}else(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&(h.updateDirectly(c.instancesData,0,p),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&d.updateDirectly(c.instancesPreviousData,0,p));this._processInstancedBuffers(a,g),o&&s!==void 0&&(this.getScene()._activeIndices.addCount(e.indexCount*p,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(e,o,s),this._draw(e,s,p)),this._scene.needsPreviousWorldMatrices&&!y&&this._instanceDataStorage.manualUpdate&&(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&!this._instanceDataStorage.previousManualUpdate&&d.updateDirectly(c.instancesData,0,p)}_renderWithInstances(e,t,n,r,s){let o=n.visibleInstances[e._id],a=o?o.length:0,l=n.parent,c=l.instancesBufferSize,h=(a+1)*16*4;for(;l.instancesBufferSize<h;)l.instancesBufferSize*=2;return(!l.instancesData||c!=l.instancesBufferSize)&&(l.instancesData=new Float32Array(l.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!l.instancesPreviousData||c!=l.instancesBufferSize)&&(l.instancesPreviousData=new Float32Array(l.instancesBufferSize/4)),this._updateInstancedBuffers(e,n,c,s,t,r),s.unbindInstanceAttributes(),this}_renderWithThinInstances(e,t,n,r){let s=this._thinInstanceDataStorage?.instancesCount??0;this.getScene()._activeIndices.addCount(e.indexCount*s,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(e,n,t),this._draw(e,t,s),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,s):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),r.unbindInstanceAttributes()}_processInstancedBuffers(e,t){}_processRendering(e,t,n,r,s,o,a,l){let c=this.getScene(),u=c.getEngine();if(r=this._getRenderingFillMode(r),o&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,r,n,u),this;if(o)this._renderWithInstances(t,r,s,n,u);else{u._currentDrawContext&&(u._currentDrawContext.useInstancing=!1);let h=0;s.renderSelf[t._id]&&(a&&a(!1,e.getWorldMatrix(),l),h++,this._draw(t,r,this._instanceDataStorage.overridenInstanceCount));let d=s.visibleInstances[t._id];if(d){let f=d.length;h+=f;for(let p=0;p<f;p++){let _=d[p].getWorldMatrix();a&&a(!0,_,l),this._draw(t,r)}}c._activeIndices.addCount(t.indexCount*h,!1)}return this}_rebuild(e=!1){for(let t in this._instanceDataStorage.renderPasses){let n=this._instanceDataStorage.renderPasses[t];n.instancesBuffer&&(e&&n.instancesBuffer.dispose(),n.instancesBuffer=null)}if(this._userInstancedBuffersStorage){for(let t in this._userInstancedBuffersStorage.vertexBuffers){let n=this._userInstancedBuffersStorage.vertexBuffers[t];n&&(e&&n.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e)}_freeze(){if(this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1;for(let e in this._instanceDataStorage.renderPasses){let t=this._instanceDataStorage.renderPasses[e];t.previousBatch=null}}renderWithRenderPassId(e,t,n,r,s=!0){let o=this._scene.getEngine(),a=o.currentRenderPassId;if(e!==void 0&&(o.currentRenderPassId=e),r)(!s||s&&r.isInFrustum(this._scene._frustumPlanes))&&this.render(r,!!t,n);else for(let l=0;l<this.subMeshes.length;l++){let c=this.subMeshes[l];(!s||s&&c.isInFrustum(this._scene._frustumPlanes))&&this.render(c,!!t,n)}return e!==void 0&&(o.currentRenderPassId=a),this}directRender(){if(!this.subMeshes)return this;for(let e of this.subMeshes)this.render(e,!1);return this}render(e,t,n){let r=this.getScene();this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1;let s=r.activeCameras?.length??0;if((s>1&&r.activeCamera===r.activeCameras[0]||s<=1)&&this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;let a=this._getInstancesRenderList(e._id,!!n);if(a.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;let l=r.getEngine(),c=0,u=null;this.ignoreCameraMaxZ&&r.activeCamera&&!r._isInIntermediateRendering()&&(c=r.activeCamera.maxZ,u=r.activeCamera,r.activeCamera.maxZ=0,r.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);let h=e.getRenderingMesh(),d=a.hardwareInstancedRendering[e._id]||h.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,f=this._instanceDataStorage,p=e.getMaterial();if(!p)return u&&(u.maxZ=c,r.updateTransformMatrix(!0)),this;if(!f.isFrozen||!this._internalMeshDataInfo._effectiveMaterial||this._internalMeshDataInfo._effectiveMaterial!==p){if(p._storeEffectOnSubMeshes){if(!p.isReadyForSubMesh(this,e,d))return u&&(u.maxZ=c,r.updateTransformMatrix(!0)),this}else if(!p.isReady(this,d))return u&&(u.maxZ=c,r.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=p}else if(p._storeEffectOnSubMeshes&&!e._drawWrapper?._wasPreviouslyReady||!p._storeEffectOnSubMeshes&&!p._getDrawWrapper()._wasPreviouslyReady)return u&&(u.maxZ=c,r.updateTransformMatrix(!0)),this;if(t){let b=this._internalMeshDataInfo._effectiveMaterial;if(b.alphaModes.length===1)l.setAlphaMode(b.alphaMode);else for(let D=0;D<b.alphaModes.length;D++){let M=b.alphaModes[D];l.setAlphaMode(M!==void 0?M:2,!1,D)}}let g;this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?g=e._drawWrapper:g=this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();let _=g?.effect??null;for(let b of r._beforeRenderingMeshStage)b.action(this,e,a,_);if(!g||!_)return u&&(u.maxZ=c,r.updateTransformMatrix(!0)),this;let y=n||this,C;if(!f.isFrozen&&(this._internalMeshDataInfo._effectiveMaterial.backFaceCulling||this._internalMeshDataInfo._effectiveMaterial.sideOrientation!==null||this._internalMeshDataInfo._effectiveMaterial._twoSidedLighting)){let b=y._getWorldMatrixDeterminant();C=this._internalMeshDataInfo._effectiveMaterial._getEffectiveOrientation(this),b<0&&(C=C===Oe.ClockWiseSideOrientation?Oe.CounterClockWiseSideOrientation:Oe.ClockWiseSideOrientation),this._internalMeshDataInfo._effectiveSideOrientation=C}else C=this._internalMeshDataInfo._effectiveSideOrientation;let E=this._internalMeshDataInfo._effectiveMaterial._preBind(g,this._internalMeshDataInfo._effectiveSideOrientation);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&l.setDepthWrite(!0);let I=this._internalMeshDataInfo._effectiveMaterial,v=I.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),d||this._bind(e,_,v,!1);let x=y.getWorldMatrix();I._storeEffectOnSubMeshes?I.bindForSubMesh(x,this,e):I.bind(x,this),!I.backFaceCulling&&I.separateCullingPass&&(l.setState(!0,I.zOffset,!1,!E,I.cullBackFaces,I.stencil,I.zOffsetUnits),this._processRendering(this,e,_,v,a,d,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),l.setState(!0,I.zOffset,!1,E,I.cullBackFaces,I.stencil,I.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,_,v,a,d,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(let b of r._afterRenderingMeshStage)b.action(this,e,a,_);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),u&&(u.maxZ=c,r.updateTransformMatrix(!0)),r.performancePriority===2&&!f.isFrozen&&this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(S.MatricesWeightsKind)&&(this.isVerticesDataPresent(S.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){let e=this.getVerticesData(S.MatricesWeightsKind),t=e.length;for(let n=0;n<t;n+=4){let r=e[n]+e[n+1]+e[n+2]+e[n+3];if(r===0)e[n]=1;else{let s=1/r;e[n]*=s,e[n+1]*=s,e[n+2]*=s,e[n+3]*=s}}this.setVerticesData(S.MatricesWeightsKind,e)}_normalizeSkinWeightsAndExtra(){let e=this.getVerticesData(S.MatricesWeightsExtraKind),t=this.getVerticesData(S.MatricesWeightsKind),n=t.length;for(let r=0;r<n;r+=4){let s=t[r]+t[r+1]+t[r+2]+t[r+3];if(s+=e[r]+e[r+1]+e[r+2]+e[r+3],s===0)t[r]=1;else{let o=1/s;t[r]*=o,t[r+1]*=o,t[r+2]*=o,t[r+3]*=o,e[r]*=o,e[r+1]*=o,e[r+2]*=o,e[r+3]*=o}}this.setVerticesData(S.MatricesWeightsKind,t),this.setVerticesData(S.MatricesWeightsKind,e)}validateSkinning(){let e=this.getVerticesData(S.MatricesWeightsExtraKind),t=this.getVerticesData(S.MatricesWeightsKind);if(t===null||this.skeleton==null)return{skinned:!1,valid:!0,report:"not skinned"};let n=t.length,r=0,s=0,o=0,a=0,l=e===null?4:8,c=[];for(let _=0;_<=l;_++)c[_]=0;let u=.001;for(let _=0;_<n;_+=4){let y=t[_],C=y,E=C===0?0:1;for(let I=1;I<l;I++){let v=I<4?t[_+I]:e[_+I-4];v>y&&r++,v!==0&&E++,C+=v,y=v}if(c[E]++,E>o&&(o=E),C===0)s++;else{let I=1/C,v=0;for(let x=0;x<l;x++)x<4?v+=Math.abs(t[_+x]-t[_+x]*I):v+=Math.abs(e[_+x-4]-e[_+x-4]*I);v>u&&a++}}let h=this.skeleton.bones.length,d=this.getVerticesData(S.MatricesIndicesKind),f=this.getVerticesData(S.MatricesIndicesExtraKind),p=0;for(let _=0;_<n;_+=4)for(let y=0;y<l;y++){let C=y<4?d[_+y]:f[_+y-4];(C>=h||C<0)&&p++}let g="Number of Weights = "+n/4+`
Maximum influences = `+o+`
Missing Weights = `+s+`
Not Sorted = `+r+`
Not Normalized = `+a+`
WeightCounts = [`+c+`]
Number of bones = `+h+`
Bad Bone Indices = `+p;return{skinned:!0,valid:s===0&&a===0&&p===0,report:g}}_checkDelayState(){let e=this.getScene();return this._geometry?this._geometry.load(e):this.delayLoadState===4&&(this.delayLoadState=2,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);let t=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;return z.LoadFile(this.delayLoadingFile,n=>{n instanceof ArrayBuffer?this._delayLoadingFunction(n,this):this._delayLoadingFunction(JSON.parse(n),this);for(let r of this.instances)r.refreshBoundingInfo(),r._syncSubMeshes();this.delayLoadState=1,e.removePendingData(this)},()=>{},e.offlineProvider,t),this}isInFrustum(e){return this.delayLoadState===2||!super.isInFrustum(e)?!1:(this._checkDelayState(),!0)}setMaterialById(e){let t=this.getScene().materials,n;for(n=t.length-1;n>-1;n--)if(t[n].id===e)return this.material=t[n],this;let r=this.getScene().multiMaterials;for(n=r.length-1;n>-1;n--)if(r[n].id===e)return this.material=r[n],this;return this}getAnimatables(){let e=[];return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(S.PositionKind))return this;let t=this.subMeshes.splice(0);this._resetPointsArrayCache();let n=this.getVerticesData(S.PositionKind),r=m.Zero(),s;for(s=0;s<n.length;s+=3)m.TransformCoordinatesFromFloatsToRef(n[s],n[s+1],n[s+2],e,r).toArray(n,s);if(this.setVerticesData(S.PositionKind,n,this.getVertexBuffer(S.PositionKind).isUpdatable()),this.isVerticesDataPresent(S.NormalKind)){for(n=this.getVerticesData(S.NormalKind),s=0;s<n.length;s+=3)m.TransformNormalFromFloatsToRef(n[s],n[s+1],n[s+2],e,r).normalize().toArray(n,s);this.setVerticesData(S.NormalKind,n,this.getVertexBuffer(S.NormalKind).isUpdatable())}if(this.isVerticesDataPresent(S.TangentKind)){for(n=this.getVerticesData(S.TangentKind),s=0;s<n.length;s+=4)m.TransformNormalFromFloatsToRef(n[s],n[s+1],n[s+2],e,r).normalize().toArray(n,s);this.setVerticesData(S.TangentKind,n,this.getVertexBuffer(S.TangentKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}bakeCurrentTransformIntoVertices(e=!0,t=!1){return t&&this.makeGeometryUnique(),this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions||this._geometry&&this._geometry._positions||null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return this._geometry?this._geometry._generatePointsArray():!1}clone(e="",t=null,n,r=!0){if(t&&t._addToSceneRootNodes===void 0){let s=t;return kr.source=this,kr.doNotCloneChildren=s.doNotCloneChildren,kr.clonePhysicsImpostor=s.clonePhysicsImpostor,kr.cloneThinInstances=s.cloneThinInstances,new i(e,this.getScene(),kr)}return new i(e,this.getScene(),t,this,n,r)}dispose(e,t=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);let n=this._internalMeshDataInfo;if(n._onBeforeDrawObservable&&n._onBeforeDrawObservable.clear(),n._onBeforeBindObservable&&n._onBeforeBindObservable.clear(),n._onBeforeRenderObservable&&n._onBeforeRenderObservable.clear(),n._onAfterRenderObservable&&n._onAfterRenderObservable.clear(),n._onBetweenPassObservable&&n._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(n.meshMap)for(let r in n.meshMap){let s=n.meshMap[r];s&&(s._internalMeshDataInfo._source=null,n.meshMap[r]=void 0)}n._source&&n._source._internalMeshDataInfo.meshMap&&(n._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{let r=this.getScene().meshes;for(let s of r){let o=s;o._internalMeshDataInfo&&o._internalMeshDataInfo._source&&o._internalMeshDataInfo._source===this&&(o._internalMeshDataInfo._source=null)}}n._source=null,this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,t)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,t,n,r,s,o,a=!1,l){let c=this.getScene(),u=h=>{let d=h.width,f=h.height,g=this.getEngine().createCanvas(d,f).getContext("2d");g.drawImage(h,0,0);let _=g.getImageData(0,0,d,f).data;this.applyDisplacementMapFromBuffer(_,d,f,t,n,s,o,a),r&&r(this)};return z.LoadImage(e,u,l||(()=>{}),c.offlineProvider),this}applyDisplacementMapFromBuffer(e,t,n,r,s,o,a,l=!1){if(!this.isVerticesDataPresent(S.PositionKind)||!this.isVerticesDataPresent(S.NormalKind)||!this.isVerticesDataPresent(S.UVKind))return N.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;let c=this.getVerticesData(S.PositionKind,!0,!0),u=this.getVerticesData(S.NormalKind),h=this.getVerticesData(S.UVKind),d=m.Zero(),f=m.Zero(),p=_e.Zero();o=o||_e.Zero(),a=a||new _e(1,1);for(let g=0;g<c.length;g+=3){m.FromArrayToRef(c,g,d),m.FromArrayToRef(u,g,f),_e.FromArrayToRef(h,g/3*2,p);let _=Math.abs(p.x*a.x+o.x%1)*(t-1)%t|0,y=Math.abs(p.y*a.y+o.y%1)*(n-1)%n|0,C=(_+y*t)*4,E=e[C]/255,I=e[C+1]/255,v=e[C+2]/255,x=E*.3+I*.59+v*.11;f.normalize(),f.scaleInPlace(r+(s-r)*x),d=d.add(f),d.toArray(c,g)}return X.ComputeNormals(c,this.getIndices(),u),l?(this.setVerticesData(S.PositionKind,c),this.setVerticesData(S.NormalKind,u),this.setVerticesData(S.UVKind,h)):(this.updateVerticesData(S.PositionKind,c),this.updateVerticesData(S.NormalKind,u)),this}_getFlattenedNormals(e,t){let n=new Float32Array(e.length*3),r=0,s=this.sideOrientation===(this._scene.useRightHandedSystem?1:0);for(let o=0;o<e.length;o+=3){let a=m.FromArray(t,e[o]*3),l=m.FromArray(t,e[o+1]*3),c=m.FromArray(t,e[o+2]*3),u=a.subtract(l),h=c.subtract(l),d=m.Normalize(m.Cross(u,h));s&&d.scaleInPlace(-1);for(let f=0;f<3;f++)n[r++]=d.x,n[r++]=d.y,n[r++]=d.z}return n}_convertToUnIndexedMesh(e=!1){let t=this.getVerticesDataKinds().filter(l=>!this.getVertexBuffer(l)?.getIsInstanced()),n=this.getIndices(),r={},s=(l,c)=>{let u=new Float32Array(n.length*c),h=0;for(let d=0;d<n.length;d++)for(let f=0;f<c;f++)u[h++]=l[n[d]*c+f];return u},o=this.getBoundingInfo(),a=this.geometry?this.subMeshes.slice(0):[];for(let l of t)r[l]=this.getVerticesData(l);for(let l of t){let c=this.getVertexBuffer(l),u=c.getSize();if(e&&l===S.NormalKind){let h=this._getFlattenedNormals(n,r[S.PositionKind]);this.setVerticesData(S.NormalKind,h,c.isUpdatable(),u)}else this.setVerticesData(l,s(r[l],u),c.isUpdatable(),u)}if(this.morphTargetManager){for(let l=0;l<this.morphTargetManager.numTargets;l++){let c=this.morphTargetManager.getTarget(l),u=c.getPositions();c.setPositions(s(u,3));let h=c.getNormals();h&&c.setNormals(e?this._getFlattenedNormals(n,u):s(h,3));let d=c.getTangents();d&&c.setTangents(s(d,3));let f=c.getUVs();f&&c.setUVs(s(f,2));let p=c.getColors();p&&c.setColors(s(p,4))}this.morphTargetManager.synchronize()}for(let l=0;l<n.length;l++)n[l]=l;this.setIndices(n),this._unIndexed=!0,this.releaseSubMeshes();for(let l of a){let c=l.getBoundingInfo();ei.AddToMesh(l.materialIndex,l.indexStart,l.indexCount,l.indexStart,l.indexCount,this).setBoundingInfo(c)}return this.setBoundingInfo(o),this.synchronizeInstances(),this}convertToFlatShadedMesh(){return this._convertToUnIndexedMesh(!0)}convertToUnIndexedMesh(){return this._convertToUnIndexedMesh()}flipFaces(e=!1){let t=X.ExtractFromMesh(this),n;if(e&&this.isVerticesDataPresent(S.NormalKind)&&t.normals){for(n=0;n<t.normals.length;n++)t.normals[n]*=-1;this.setVerticesData(S.NormalKind,t.normals,this.isVertexBufferUpdatable(S.NormalKind))}if(t.indices){let r;for(n=0;n<t.indices.length;n+=3)r=t.indices[n+1],t.indices[n+1]=t.indices[n+2],t.indices[n+2]=r;this.setIndices(t.indices,null,this.isVertexBufferUpdatable(S.PositionKind),!0)}return this}increaseVertices(e=1){let t=X.ExtractFromMesh(this),n=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,r=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,s=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,o=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(!n||!r)N.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions");else{t.indices=n,t.positions=r,s&&(t.uvs=s),o&&(t.normals=o);let a=e+1,l=[];for(let v=0;v<a+1;v++)l[v]=[];let c,u,h=new m(0,0,0),d=new m(0,0,0),f=new _e(0,0),p=[],g=[],_=[],y,C=r.length,E;s&&(E=s.length);let I;o&&(I=o.length);for(let v=0;v<n.length;v+=3){g[0]=n[v],g[1]=n[v+1],g[2]=n[v+2];for(let x=0;x<3;x++)if(c=g[x],u=g[(x+1)%3],_[c]===void 0&&_[u]===void 0?(_[c]=[],_[u]=[]):(_[c]===void 0&&(_[c]=[]),_[u]===void 0&&(_[u]=[])),_[c][u]===void 0&&_[u][c]===void 0){_[c][u]=[],h.x=(r[3*u]-r[3*c])/a,h.y=(r[3*u+1]-r[3*c+1])/a,h.z=(r[3*u+2]-r[3*c+2])/a,o&&(d.x=(o[3*u]-o[3*c])/a,d.y=(o[3*u+1]-o[3*c+1])/a,d.z=(o[3*u+2]-o[3*c+2])/a),s&&(f.x=(s[2*u]-s[2*c])/a,f.y=(s[2*u+1]-s[2*c+1])/a),_[c][u].push(c);for(let b=1;b<a;b++)_[c][u].push(r.length/3),r[C++]=r[3*c]+b*h.x,r[C++]=r[3*c+1]+b*h.y,r[C++]=r[3*c+2]+b*h.z,o&&(o[I++]=o[3*c]+b*d.x,o[I++]=o[3*c+1]+b*d.y,o[I++]=o[3*c+2]+b*d.z),s&&(s[E++]=s[2*c]+b*f.x,s[E++]=s[2*c+1]+b*f.y);_[c][u].push(u),_[u][c]=[],y=_[c][u].length;for(let b=0;b<y;b++)_[u][c][b]=_[c][u][y-1-b]}l[0][0]=n[v],l[1][0]=_[n[v]][n[v+1]][1],l[1][1]=_[n[v]][n[v+2]][1];for(let x=2;x<a;x++){l[x][0]=_[n[v]][n[v+1]][x],l[x][x]=_[n[v]][n[v+2]][x],h.x=(r[3*l[x][x]]-r[3*l[x][0]])/x,h.y=(r[3*l[x][x]+1]-r[3*l[x][0]+1])/x,h.z=(r[3*l[x][x]+2]-r[3*l[x][0]+2])/x,o&&(d.x=(o[3*l[x][x]]-o[3*l[x][0]])/x,d.y=(o[3*l[x][x]+1]-o[3*l[x][0]+1])/x,d.z=(o[3*l[x][x]+2]-o[3*l[x][0]+2])/x),s&&(f.x=(s[2*l[x][x]]-s[2*l[x][0]])/x,f.y=(s[2*l[x][x]+1]-s[2*l[x][0]+1])/x);for(let b=1;b<x;b++)l[x][b]=r.length/3,r[C++]=r[3*l[x][0]]+b*h.x,r[C++]=r[3*l[x][0]+1]+b*h.y,r[C++]=r[3*l[x][0]+2]+b*h.z,o&&(o[I++]=o[3*l[x][0]]+b*d.x,o[I++]=o[3*l[x][0]+1]+b*d.y,o[I++]=o[3*l[x][0]+2]+b*d.z),s&&(s[E++]=s[2*l[x][0]]+b*f.x,s[E++]=s[2*l[x][0]+1]+b*f.y)}l[a]=_[n[v+1]][n[v+2]],p.push(l[0][0],l[1][0],l[1][1]);for(let x=1;x<a;x++){let b;for(b=0;b<x;b++)p.push(l[x][b],l[x+1][b],l[x+1][b+1]),p.push(l[x][b],l[x+1][b+1],l[x][b+1]);p.push(l[x][b],l[x+1][b],l[x+1][b+1])}}t.indices=p,t.applyToMesh(this,this.isVertexBufferUpdatable(S.PositionKind))}}forceSharedVertices(){let e=X.ExtractFromMesh(this),t=e.uvs,n=e.indices,r=e.positions,s=e.colors,o=e.matricesIndices,a=e.matricesWeights,l=e.matricesIndicesExtra,c=e.matricesWeightsExtra;if(n===void 0||r===void 0||n===null||r===null)N.Warn("VertexData contains empty entries");else{let u=[],h=[],d=[],f=[],p=[],g=[],_=[],y=[],C=[],E=0,I={},v,x;for(let D=0;D<n.length;D+=3){x=[n[D],n[D+1],n[D+2]],C=[];for(let M=0;M<3;M++){C[M]="";for(let R=0;R<3;R++)Math.abs(r[3*x[M]+R])<1e-8&&(r[3*x[M]+R]=0),C[M]+=r[3*x[M]+R]+"|"}if(!(C[0]==C[1]||C[0]==C[2]||C[1]==C[2]))for(let M=0;M<3;M++){if(v=I[C[M]],v===void 0){I[C[M]]=E,v=E++;for(let R=0;R<3;R++)u.push(r[3*x[M]+R]);if(s!=null)for(let R=0;R<4;R++)f.push(s[4*x[M]+R]);if(t!=null)for(let R=0;R<2;R++)d.push(t[2*x[M]+R]);if(o!=null)for(let R=0;R<4;R++)p.push(o[4*x[M]+R]);if(a!=null)for(let R=0;R<4;R++)g.push(a[4*x[M]+R]);if(l!=null)for(let R=0;R<4;R++)_.push(l[4*x[M]+R]);if(c!=null)for(let R=0;R<4;R++)y.push(c[4*x[M]+R])}h.push(v)}}let b=[];X.ComputeNormals(u,h,b),e.positions=u,e.indices=h,e.normals=b,t!=null&&(e.uvs=d),s!=null&&(e.colors=f),o!=null&&(e.matricesIndices=p),a!=null&&(e.matricesWeights=g),l!=null&&(e.matricesIndicesExtra=_),a!=null&&(e.matricesWeightsExtra=y),e.applyToMesh(this,this.isVertexBufferUpdatable(S.PositionKind))}}static _instancedMeshFactory(e,t){throw Bn("InstancedMesh")}static _PhysicsImpostorParser(e,t,n){throw Bn("PhysicsImpostor")}createInstance(e){let t=i._instancedMeshFactory(e,this);return t.parent=this.parent,t}synchronizeInstances(){for(let e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}optimizeIndices(e){let t=this.getIndices(),n=this.getVerticesData(S.PositionKind);if(!n||!t)return this;let r=[];for(let o=0;o<n.length;o=o+3)r.push(m.FromArray(n,o));let s=[];return LT.SyncAsyncForLoop(r.length,40,o=>{let a=r.length-1-o,l=r[a];for(let c=0;c<a;++c){let u=r[c];if(l.equals(u)){s[a]=c;break}}},()=>{for(let a=0;a<t.length;++a)t[a]=s[t[a]]||t[a];let o=this.subMeshes.slice(0);this.setIndices(t),this.subMeshes=o,e&&e(this)}),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),Tt&&Tt.HasTags(this)&&(e.tags=Tt.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.alwaysSelectAsActiveMesh=this.alwaysSelectAsActiveMesh,e.checkCollisions=this.checkCollisions,e.ellipsoid=this.ellipsoid.asArray(),e.ellipsoidOffset=this.ellipsoidOffset.asArray(),e.doNotSyncBoundingInfo=this.doNotSyncBoundingInfo,e.isBlocker=this.isBlocker,e.sideOrientation=this.sideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;let t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(let n=0;n<this.subMeshes.length;n++){let r=this.subMeshes[n];e.subMeshes.push({materialIndex:r.materialIndex,verticesStart:r.verticesStart,verticesCount:r.verticesCount,indexStart:r.indexStart,indexCount:r.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(Ge.NAME_PHYSICSENGINE)){let n=this.getPhysicsImpostor();n&&(e.physicsMass=n.getParam("mass"),e.physicsFriction=n.getParam("friction"),e.physicsRestitution=n.getParam("mass"),e.physicsImpostor=n.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let n=0;n<this.instances.length;n++){let r=this.instances[n];if(r.doNotSerialize)continue;let s={name:r.name,id:r.id,isEnabled:r.isEnabled(!1),isVisible:r.isVisible,isPickable:r.isPickable,checkCollisions:r.checkCollisions,position:r.position.asArray(),scaling:r.scaling.asArray()};if(r.parent&&r.parent._serializeAsParent(s),r.rotationQuaternion?s.rotationQuaternion=r.rotationQuaternion.asArray():r.rotation&&(s.rotation=r.rotation.asArray()),this.getScene()._getComponent(Ge.NAME_PHYSICSENGINE)){let o=r.getPhysicsImpostor();o&&(s.physicsMass=o.getParam("mass"),s.physicsFriction=o.getParam("friction"),s.physicsRestitution=o.getParam("mass"),s.physicsImpostor=o.type)}r.metadata&&(s.metadata=r.metadata),r.actionManager&&(s.actions=r.actionManager.serialize(r.name)),e.instances.push(s),Xe.AppendSerializedAnimations(r,s),s.ranges=r.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){let n={data:{},sizes:{},strides:{}};for(let r in this._userThinInstanceBuffersStorage.data)n.data[r]=Array.from(this._userThinInstanceBuffersStorage.data[r]),n.sizes[r]=this._userThinInstanceBuffersStorage.sizes[r],n.strides[r]=this._userThinInstanceBuffersStorage.strides[r];e.thinInstances.userThinInstance=n}return Xe.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();let e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices()){N.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),this.morphTargetManager=null;return}if(e.isUsingTextureForTargets)return;for(let t=0;t<e.numInfluencers;t++){let n=e.getActiveTarget(t),r=n.getPositions();if(!r){N.Error("Invalid morph target. Target must have positions.");return}this.geometry.setVerticesData(S.PositionKind+t,r,!1,3);let s=n.getNormals();s&&this.geometry.setVerticesData(S.NormalKind+t,s,!1,3);let o=n.getTangents();o&&this.geometry.setVerticesData(S.TangentKind+t,o,!1,3);let a=n.getUVs();a&&this.geometry.setVerticesData(S.UVKind+"_"+t,a,!1,2);let l=n.getUV2s();l&&this.geometry.setVerticesData(S.UV2Kind+"_"+t,l,!1,2);let c=n.getColors();c&&this.geometry.setVerticesData(S.ColorKind+t,c,!1,4)}}else{let t=0;for(;this.geometry.isVerticesDataPresent(S.PositionKind+t);)this.geometry.removeVerticesData(S.PositionKind+t),this.geometry.isVerticesDataPresent(S.NormalKind+t)&&this.geometry.removeVerticesData(S.NormalKind+t),this.geometry.isVerticesDataPresent(S.TangentKind+t)&&this.geometry.removeVerticesData(S.TangentKind+t),this.geometry.isVerticesDataPresent(S.UVKind+t)&&this.geometry.removeVerticesData(S.UVKind+"_"+t),this.geometry.isVerticesDataPresent(S.UV2Kind+t)&&this.geometry.removeVerticesData(S.UV2Kind+"_"+t),this.geometry.isVerticesDataPresent(S.ColorKind+t)&&this.geometry.removeVerticesData(S.ColorKind+t),t++}}static Parse(e,t,n){let r;if(e.type&&e.type==="LinesMesh"?r=i._LinesMeshParser(e,t):e.type&&e.type==="GroundMesh"?r=i._GroundMeshParser(e,t):e.type&&e.type==="GoldbergMesh"?r=i._GoldbergMeshParser(e,t):e.type&&e.type==="GreasedLineMesh"?r=i._GreasedLineMeshParser(e,t):e.type&&e.type==="TrailMesh"?r=i._TrailMeshParser(e,t):r=new i(e.name,t),r.id=e.id,r._waitingParsedUniqueId=e.uniqueId,Tt&&Tt.AddTagsTo(r,e.tags),r.position=m.FromArray(e.position),e.metadata!==void 0&&(r.metadata=e.metadata),e.rotationQuaternion?r.rotationQuaternion=J.FromArray(e.rotationQuaternion):e.rotation&&(r.rotation=m.FromArray(e.rotation)),r.scaling=m.FromArray(e.scaling),e.localMatrix?r.setPreTransformMatrix(V.FromArray(e.localMatrix)):e.pivotMatrix&&r.setPivotMatrix(V.FromArray(e.pivotMatrix)),r.setEnabled(e.isEnabled),r.isVisible=e.isVisible,r.infiniteDistance=e.infiniteDistance,r.alwaysSelectAsActiveMesh=!!e.alwaysSelectAsActiveMesh,r.showBoundingBox=e.showBoundingBox,r.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,e.applyFog!==void 0&&(r.applyFog=e.applyFog),e.pickable!==void 0&&(r.isPickable=e.pickable),e.alphaIndex!==void 0&&(r.alphaIndex=e.alphaIndex),r.receiveShadows=e.receiveShadows,e.billboardMode!==void 0&&(r.billboardMode=e.billboardMode),e.visibility!==void 0&&(r.visibility=e.visibility),r.checkCollisions=e.checkCollisions,r.doNotSyncBoundingInfo=!!e.doNotSyncBoundingInfo,e.ellipsoid&&(r.ellipsoid=m.FromArray(e.ellipsoid)),e.ellipsoidOffset&&(r.ellipsoidOffset=m.FromArray(e.ellipsoidOffset)),e.overrideMaterialSideOrientation!=null&&(r.sideOrientation=e.overrideMaterialSideOrientation),e.sideOrientation!==void 0&&(r.sideOrientation=e.sideOrientation),e.isBlocker!==void 0&&(r.isBlocker=e.isBlocker),r._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(r._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.actions!==void 0&&(r._waitingData.actions=e.actions),e.overlayAlpha!==void 0&&(r.overlayAlpha=e.overlayAlpha),e.overlayColor!==void 0&&(r.overlayColor=G.FromArray(e.overlayColor)),e.renderOverlay!==void 0&&(r.renderOverlay=e.renderOverlay),r.isUnIndexed=!!e.isUnIndexed,r.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(r.delayLoadState=4,r.delayLoadingFile=n+e.delayLoadingFile,r.buildBoundingInfo(m.FromArray(e.boundingBoxMinimum),m.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(r._binaryInfo=e._binaryInfo),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(S.UVKind),e.hasUVs2&&r._delayInfo.push(S.UV2Kind),e.hasUVs3&&r._delayInfo.push(S.UV3Kind),e.hasUVs4&&r._delayInfo.push(S.UV4Kind),e.hasUVs5&&r._delayInfo.push(S.UV5Kind),e.hasUVs6&&r._delayInfo.push(S.UV6Kind),e.hasColors&&r._delayInfo.push(S.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(S.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(S.MatricesWeightsKind),r._delayLoadingFunction=jt._ImportGeometry,ai.ForceFullSceneLoadingForIncremental&&r._checkDelayState()):jt._ImportGeometry(e,r),e.materialUniqueId?r._waitingMaterialId=e.materialUniqueId:e.materialId&&(r._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(r._waitingMorphTargetManagerId=e.morphTargetManagerId),e.skeletonId!==void 0&&e.skeletonId!==null&&(r.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(r.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(let s=0;s<e.animations.length;s++){let o=e.animations[s],a=Ct("BABYLON.Animation");a&&r.animations.push(a.Parse(o))}kt.ParseAnimationRanges(r,e,t)}if(e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?r.layerMask=Math.abs(parseInt(e.layerMask)):r.layerMask=268435455,e.physicsImpostor&&(r.physicsImpostor=i._PhysicsImpostorParser(t,r,e)),e.lodMeshIds&&(r._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(let s=0;s<e.instances.length;s++){let o=e.instances[s],a=r.createInstance(o.name);if(o.id&&(a.id=o.id),Tt&&(o.tags?Tt.AddTagsTo(a,o.tags):Tt.AddTagsTo(a,e.tags)),a.position=m.FromArray(o.position),o.metadata!==void 0&&(a.metadata=o.metadata),o.parentId!==void 0&&(a._waitingParentId=o.parentId),o.parentInstanceIndex!==void 0&&(a._waitingParentInstanceIndex=o.parentInstanceIndex),o.isEnabled!==void 0&&o.isEnabled!==null&&a.setEnabled(o.isEnabled),o.isVisible!==void 0&&o.isVisible!==null&&(a.isVisible=o.isVisible),o.isPickable!==void 0&&o.isPickable!==null&&(a.isPickable=o.isPickable),o.rotationQuaternion?a.rotationQuaternion=J.FromArray(o.rotationQuaternion):o.rotation&&(a.rotation=m.FromArray(o.rotation)),a.scaling=m.FromArray(o.scaling),o.checkCollisions!=null&&o.checkCollisions!=null&&(a.checkCollisions=o.checkCollisions),o.pickable!=null&&o.pickable!=null&&(a.isPickable=o.pickable),o.showBoundingBox!=null&&o.showBoundingBox!=null&&(a.showBoundingBox=o.showBoundingBox),o.showSubMeshesBoundingBox!=null&&o.showSubMeshesBoundingBox!=null&&(a.showSubMeshesBoundingBox=o.showSubMeshesBoundingBox),o.alphaIndex!=null&&o.showSubMeshesBoundingBox!=null&&(a.alphaIndex=o.alphaIndex),o.physicsImpostor&&(a.physicsImpostor=i._PhysicsImpostorParser(t,a,o)),o.actions!==void 0&&(a._waitingData.actions=o.actions),o.animations){for(let l=0;l<o.animations.length;l++){let c=o.animations[l],u=Ct("BABYLON.Animation");u&&a.animations.push(u.Parse(c))}kt.ParseAnimationRanges(a,o,t),o.autoAnimate&&t.beginAnimation(a,o.autoAnimateFrom,o.autoAnimateTo,o.autoAnimateLoop,o.autoAnimateSpeed||1)}}if(e.thinInstances){let s=e.thinInstances;if(r.thinInstanceEnablePicking=!!s.enablePicking,s.matrixData?(r.thinInstanceSetBuffer("matrix",new Float32Array(s.matrixData),16,!1),r._thinInstanceDataStorage.matrixBufferSize=s.matrixBufferSize,r._thinInstanceDataStorage.instancesCount=s.instancesCount):r._thinInstanceDataStorage.matrixBufferSize=s.matrixBufferSize,e.thinInstances.userThinInstance){let o=e.thinInstances.userThinInstance;for(let a in o.data)r.thinInstanceSetBuffer(a,new Float32Array(o.data[a]),o.strides[a],!1),r._userThinInstanceBuffersStorage.sizes[a]=o.sizes[a]}}return r}setPositionsForCPUSkinning(){let e=this._internalMeshDataInfo;if(!e._sourcePositions){let t=this.getVerticesData(S.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(S.PositionKind)||this.setVerticesData(S.PositionKind,t,!0)}return e._sourcePositions}setNormalsForCPUSkinning(){let e=this._internalMeshDataInfo;if(!e._sourceNormals){let t=this.getVerticesData(S.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(S.NormalKind)||this.setVerticesData(S.NormalKind,t,!0)}return e._sourceNormals}applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(S.PositionKind))return this;if(!this.isVerticesDataPresent(S.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(S.MatricesWeightsKind))return this;let t=this.isVerticesDataPresent(S.NormalKind),n=this._internalMeshDataInfo;if(!n._sourcePositions){let y=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=y}t&&!n._sourceNormals&&this.setNormalsForCPUSkinning();let r=this.getVerticesData(S.PositionKind);if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r));let s=this.getVerticesData(S.NormalKind);if(t){if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s))}let o=this.getVerticesData(S.MatricesIndicesKind),a=this.getVerticesData(S.MatricesWeightsKind);if(!a||!o)return this;let l=this.numBoneInfluencers>4,c=l?this.getVerticesData(S.MatricesIndicesExtraKind):null,u=l?this.getVerticesData(S.MatricesWeightsExtraKind):null,h=e.getTransformMatrices(this),d=m.Zero(),f=new V,p=new V,g=0,_;for(let y=0;y<r.length;y+=3,g+=4){let C;for(_=0;_<4;_++)C=a[g+_],C>0&&(V.FromFloat32ArrayToRefScaled(h,Math.floor(o[g+_]*16),C,p),f.addToSelf(p));if(l)for(_=0;_<4;_++)C=u[g+_],C>0&&(V.FromFloat32ArrayToRefScaled(h,Math.floor(c[g+_]*16),C,p),f.addToSelf(p));m.TransformCoordinatesFromFloatsToRef(n._sourcePositions[y],n._sourcePositions[y+1],n._sourcePositions[y+2],f,d),d.toArray(r,y),t&&(m.TransformNormalFromFloatsToRef(n._sourceNormals[y],n._sourceNormals[y+1],n._sourceNormals[y+2],f,d),d.toArray(s,y)),f.reset()}return this.updateVerticesData(S.PositionKind,r),t&&this.updateVerticesData(S.NormalKind,s),this}static MinMax(e){let t=null,n=null;for(let r of e){let o=r.getBoundingInfo().boundingBox;!t||!n?(t=o.minimumWorld.clone(),n=o.maximumWorld.clone()):(t.minimizeInPlace(o.minimumWorld),n.maximizeInPlace(o.maximumWorld))}return!t||!n?{min:m.Zero(),max:m.Zero()}:{min:t,max:n}}static Center(e){let t=e instanceof Array?i.MinMax(e):e;return m.Center(t.min,t.max)}static MergeMeshes(e,t=!0,n,r,s,o){return kT(i._MergeMeshesCoroutine(e,t,n,r,s,o,!1))}static MergeMeshesAsync(e,t=!0,n,r,s,o){return T(this,null,function*(){return yield BT(i._MergeMeshesCoroutine(e,t,n,r,s,o,!0),FT())})}static*_MergeMeshesCoroutine(e,t=!0,n,r,s,o,a){if(e=e.filter(Boolean),e.length===0)return null;let l;if(!n){let b=0;for(l=0;l<e.length;l++)if(b+=e[l].getTotalVertices(),b>=65536)return N.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}o&&(s=!1);let c=new Array,u=new Array,h=new Array,d=e[0].sideOrientation;for(l=0;l<e.length;l++){let b=e[l];if(b.isAnInstance)return N.Warn("Cannot merge instance meshes."),null;if(d!==b.sideOrientation)return N.Warn("Cannot merge meshes with different sideOrientation values."),null;if(s&&h.push({start:0,count:b.getTotalIndices()}),o){let D=h.reduce((M,R)=>Math.max(M,R.start+R.count),0);if(b.material){let M=b.material;if(M instanceof zs){for(let R=0;R<M.subMaterials.length;R++)c.indexOf(M.subMaterials[R])<0&&c.push(M.subMaterials[R]);for(let R=0;R<b.subMeshes.length;R++)u.push(c.indexOf(M.subMaterials[b.subMeshes[R].materialIndex])),h.push({start:D+b.subMeshes[R].indexStart,count:b.subMeshes[R].indexCount})}else{c.indexOf(M)<0&&c.push(M);for(let R=0;R<b.subMeshes.length;R++)u.push(c.indexOf(M)),h.push({start:D+b.subMeshes[R].indexStart,count:b.subMeshes[R].indexCount})}}else for(let M=0;M<b.subMeshes.length;M++)u.push(0),h.push({start:D+b.subMeshes[M].indexStart,count:b.subMeshes[M].indexCount})}}let f=e[0],p=b=>{let D=b.computeWorldMatrix(!0);return{vertexData:X.ExtractFromMesh(b,!1,!1),transform:D}},{vertexData:g,transform:_}=p(f);a&&(yield);let y=new Array(e.length-1);for(let b=1;b<e.length;b++)y[b-1]=p(e[b]),a&&(yield);let C=g._mergeCoroutine(_,y,n,a,!t),E=C.next();for(;!E.done;)a&&(yield),E=C.next();let I=E.value;r||(r=new i(f.name+"_merged",f.getScene()));let v=I._applyToCoroutine(r,void 0,a),x=v.next();for(;!x.done;)a&&(yield),x=v.next();if(r.checkCollisions=f.checkCollisions,r.sideOrientation=f.sideOrientation,t)for(l=0;l<e.length;l++)e[l].dispose();if(s||o){for(r.releaseSubMeshes(),l=0;l<h.length;)ei.CreateFromIndices(0,h[l].start,h[l].count,r,void 0,!1),l++;for(let b of r.subMeshes)b.refreshBoundingInfo();r.computeWorldMatrix(!0)}if(o){let b=new zs(f.name+"_merged",f.getScene());b.subMaterials=c;for(let D=0;D<r.subMeshes.length;D++)r.subMeshes[D].materialIndex=u[D];r.material=b}else r.material=f.material;return r}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}removeInstance(e){let t=e._indexInSourceMeshInstanceArray;if(t!=-1){if(t!==this.instances.length-1){let n=this.instances[this.instances.length-1];this.instances[t]=n,n._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this._scene.useRightHandedSystem&&this.sideOrientation===Oe.CounterClockWiseSideOrientation}_getRenderingFillMode(e){let t=this.getScene();return t.forcePointsCloud?Oe.PointFillMode:t.forceWireframe?Oe.WireFrameFillMode:this.overrideRenderingFillMode??e}setMaterialByID(e){return this.setMaterialById(e)}static CreateRibbon(e,t,n,r,s,o,a,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateDisc(e,t,n,r,s,o){throw new Error("Import MeshBuilder to populate this function")}static CreateBox(e,t,n,r,s){throw new Error("Import MeshBuilder to populate this function")}static CreateSphere(e,t,n,r,s,o){throw new Error("Import MeshBuilder to populate this function")}static CreateHemisphere(e,t,n,r){throw new Error("Import MeshBuilder to populate this function")}static CreateCylinder(e,t,n,r,s,o,a,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateTorus(e,t,n,r,s,o,a){throw new Error("Import MeshBuilder to populate this function")}static CreateTorusKnot(e,t,n,r,s,o,a,l,c,u){throw new Error("Import MeshBuilder to populate this function")}static CreateLines(e,t,n,r,s){throw new Error("Import MeshBuilder to populate this function")}static CreateDashedLines(e,t,n,r,s,o,a,l){throw new Error("Import MeshBuilder to populate this function")}static CreatePolygon(e,t,n,r,s,o,a){throw new Error("Import MeshBuilder to populate this function")}static ExtrudePolygon(e,t,n,r,s,o,a,l){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShape(e,t,n,r,s,o,a,l,c,u){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShapeCustom(e,t,n,r,s,o,a,l,c,u,h,d){throw new Error("Import MeshBuilder to populate this function")}static CreateLathe(e,t,n,r,s,o,a){throw new Error("Import MeshBuilder to populate this function")}static CreatePlane(e,t,n,r,s){throw new Error("Import MeshBuilder to populate this function")}static CreateGround(e,t,n,r,s,o){throw new Error("Import MeshBuilder to populate this function")}static CreateTiledGround(e,t,n,r,s,o,a,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateGroundFromHeightMap(e,t,n,r,s,o,a,l,c,u,h){throw new Error("Import MeshBuilder to populate this function")}static CreateTube(e,t,n,r,s,o,a,l,c,u){throw new Error("Import MeshBuilder to populate this function")}static CreatePolyhedron(e,t,n){throw new Error("Import MeshBuilder to populate this function")}static CreateIcoSphere(e,t,n){throw new Error("Import MeshBuilder to populate this function")}static CreateDecal(e,t,n,r,s,o){throw new Error("Import MeshBuilder to populate this function")}static CreateCapsule(e,t,n){throw new Error("Import MeshBuilder to populate this function")}static ExtendToGoldberg(e){throw new Error("Import MeshBuilder to populate this function")}};A.FRONTSIDE=X.FRONTSIDE;A.BACKSIDE=X.BACKSIDE;A.DOUBLESIDE=X.DOUBLESIDE;A.DEFAULTSIDE=X.DEFAULTSIDE;A.NO_CAP=0;A.CAP_START=1;A.CAP_END=2;A.CAP_ALL=3;A.NO_FLIP=0;A.FLIP_TILE=1;A.ROTATE_TILE=2;A.FLIP_ROW=3;A.ROTATE_ROW=4;A.FLIP_N_ROTATE_TILE=5;A.FLIP_N_ROTATE_ROW=6;A.CENTER=0;A.LEFT=1;A.RIGHT=2;A.TOP=3;A.BOTTOM=4;A.INSTANCEDMESH_SORT_TRANSPARENT=!1;A._GroundMeshParser=(i,e)=>{throw Bn("GroundMesh")};A._GoldbergMeshParser=(i,e)=>{throw Bn("GoldbergMesh")};A._LinesMeshParser=(i,e)=>{throw Bn("LinesMesh")};A._GreasedLineMeshParser=(i,e)=>{throw Bn("GreasedLineMesh")};A._GreasedLineRibbonMeshParser=(i,e)=>{throw Bn("GreasedLineRibbonMesh")};A._TrailMeshParser=(i,e)=>{throw Bn("TrailMesh")};ue("BABYLON.Mesh",A);A._instancedMeshFactory=(i,e)=>{let t=new us(i,e);if(e.instancedBuffers){t.instancedBuffers={};for(let n in e.instancedBuffers)t.instancedBuffers[n]=e.instancedBuffers[n]}return t};var us=class extends _i{constructor(e,t){super(e,t.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,t.addInstance(this),this._sourceMesh=t,this._unIndexed=t._unIndexed,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scaling.copyFrom(t.scaling),t.rotationQuaternion&&(this.rotationQuaternion=t.rotationQuaternion.clone()),this.animations=t.animations.slice();for(let n of t.getAnimationRanges())n!=null&&this.createAnimationRange(n.name,n.from,n.to);if(this.infiniteDistance=t.infiniteDistance,this.setPivotMatrix(t.getPivotMatrix()),!t.skeleton&&!t.morphTargetManager&&t.hasBoundingInfo){let n=t.getBoundingInfo();this.buildBoundingInfo(n.minimum,n.maximum)}else this.refreshBoundingInfo(!0,!0);this._syncSubMeshes()}getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}set receiveShadows(e){this._sourceMesh?.receiveShadows!==e&&z.Warn("Setting receiveShadows on an instanced mesh has no effect")}get material(){return this._sourceMesh.material}set material(e){this._sourceMesh?.material!==e&&z.Warn("Setting material on an instanced mesh has no effect")}get visibility(){return this._sourceMesh.visibility}set visibility(e){this._sourceMesh?.visibility!==e&&z.Warn("Setting visibility on an instanced mesh has no effect")}get skeleton(){return this._sourceMesh.skeleton}set skeleton(e){this._sourceMesh?.skeleton!==e&&z.Warn("Setting skeleton on an instanced mesh has no effect")}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){!this._sourceMesh||e===this._sourceMesh.renderingGroupId||N.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}get geometry(){return this._sourceMesh._geometry}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,t,n){return this._sourceMesh.getVerticesData(e,t,n)}copyVerticesData(e,t){this._sourceMesh.copyVerticesData(e,t)}getVertexBuffer(e,t){return this._sourceMesh.getVertexBuffer(e,t)}setVerticesData(e,t,n,r){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,n,r),this.sourceMesh}updateVerticesData(e,t,n,r){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,n,r),this.sourceMesh}setIndices(e,t=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let n;typeof e=="object"?n=e:n={applySkeleton:e,applyMorph:t};let r=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getData(n,null,S.PositionKind),r),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,t){if(super._activate(e,t),this._sourceMesh.subMeshes||N.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD!==this._sourceMesh&&this._currentLOD.billboardMode!==ln.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new V);let e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,U.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(U.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;let t=this.sourceMesh.getLODLevels();if(!t||t.length===0)this._currentLOD=this.sourceMesh;else{let n=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,n.boundingSphere)}return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,t=null,n,r){let s=(r||this._sourceMesh).createInstance(e);if(xt.DeepCopy(this,s,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo","geometry"],[]),t&&(s.parent=t),!n)for(let o=0;o<this.getScene().meshes.length;o++){let a=this.getScene().meshes[o];a.parent===this&&a.clone(a.name,s)}return s.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(s),s}dispose(e,t=!1){this._sourceMesh.removeInstance(this),super.dispose(e,t)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,t,n){let r=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,t&&t.newSourcedMesh);r&&n&&n(this,r);for(let s of this.getChildTransformNodes(!0))s.instantiateHierarchy(r,t,n);return r}};A.prototype.registerInstancedBuffer=function(i,e){if(this._userInstancedBuffersStorage?.vertexBuffers[i]?.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(let t of this.instances)t.instancedBuffers={}}this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this.instancedBuffers[i]=null,this._userInstancedBuffersStorage.strides[i]=e,this._userInstancedBuffersStorage.sizes[i]=e*32,this._userInstancedBuffersStorage.data[i]=new Float32Array(this._userInstancedBuffersStorage.sizes[i]),this._userInstancedBuffersStorage.vertexBuffers[i]=new S(this.getEngine(),this._userInstancedBuffersStorage.data[i],i,!0,!1,e,!0);for(let t of this.instances)t.instancedBuffers[i]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()};A.prototype._processInstancedBuffers=function(i,e){let t=i?i.length:0;for(let n in this.instancedBuffers){let r=this._userInstancedBuffersStorage.sizes[n],s=this._userInstancedBuffersStorage.strides[n],o=(t+1)*s;for(;r<o;)r*=2;this._userInstancedBuffersStorage.data[n].length!=r&&(this._userInstancedBuffersStorage.data[n]=new Float32Array(r),this._userInstancedBuffersStorage.sizes[n]=r,this._userInstancedBuffersStorage.vertexBuffers[n]&&(this._userInstancedBuffersStorage.vertexBuffers[n].dispose(),this._userInstancedBuffersStorage.vertexBuffers[n]=null));let a=this._userInstancedBuffersStorage.data[n],l=0;if(e){let c=this.instancedBuffers[n];c.toArray?c.toArray(a,l):c.copyToArray?c.copyToArray(a,l):a[l]=c,l+=s}for(let c=0;c<t;c++){let h=i[c].instancedBuffers[n];h.toArray?h.toArray(a,l):h.copyToArray?h.copyToArray(a,l):a[l]=h,l+=s}this._userInstancedBuffersStorage.vertexBuffers[n]?this._userInstancedBuffersStorage.vertexBuffers[n].updateDirectly(a,0):(this._userInstancedBuffersStorage.vertexBuffers[n]=new S(this.getEngine(),this._userInstancedBuffersStorage.data[n],n,!0,!1,s,!0),this._invalidateInstanceVertexArrayObject())}};A.prototype._invalidateInstanceVertexArrayObject=function(){if(!(!this._userInstancedBuffersStorage||this._userInstancedBuffersStorage.vertexArrayObjects===void 0)){for(let i in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[i]);this._userInstancedBuffersStorage.vertexArrayObjects={}}};A.prototype._disposeInstanceSpecificData=function(){for(let i in this._instanceDataStorage.renderPasses)this._instanceDataStorage.renderPasses[i].instancesBuffer?.dispose();for(this._instanceDataStorage.renderPasses={};this.instances.length;)this.instances[0].dispose();for(let i in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[i]&&this._userInstancedBuffersStorage.vertexBuffers[i].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};ue("BABYLON.InstancedMesh",us);var mp=class{constructor(){this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.sounds=null,this.effectLayers=[],this.layers=[],this.reflectionProbes=[]}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=[];e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes);for(let t of this.skeletons)e=e.concat(t.bones);return e}},lb=class extends mp{},cb=class{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){let e=this.rootNodes;for(let r of e)r.dispose();e.length=0;let t=this.skeletons;for(let r of t)r.dispose();t.length=0;let n=this.animationGroups;for(let r of n)r.dispose();n.length=0}},gp=class extends mp{constructor(e){super(),this._wasAddedToScene=!1,e=e||Ie.LastCreatedScene,e&&(this.scene=e,this.proceduralTextures=[],e.onDisposeObservable.add(()=>{this._wasAddedToScene||this.dispose()}),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{for(let t of this.geometries)t._rebuild();for(let t of this.meshes)t._rebuild();for(let t of this.particleSystems)t.rebuild();for(let t of this.textures)t._rebuild()}))}_topologicalSort(e){let t=new Map;for(let a of e)t.set(a.uniqueId,a);let n={dependsOn:new Map,dependedBy:new Map};for(let a of e){let l=a.uniqueId;n.dependsOn.set(l,new Set),n.dependedBy.set(l,new Set)}for(let a of e){let l=a.uniqueId,c=n.dependsOn.get(l);if(a instanceof us){let h=a.sourceMesh;t.has(h.uniqueId)&&(c.add(h.uniqueId),n.dependedBy.get(h.uniqueId).add(l))}let u=n.dependedBy.get(l);for(let h of a.getDescendants()){let d=h.uniqueId;t.has(d)&&(u.add(d),n.dependsOn.get(d).add(l))}}let r=[],s=[];for(let a of e){let l=a.uniqueId;n.dependsOn.get(l).size===0&&(s.push(a),t.delete(l))}let o=s;for(;o.length>0;){let a=o.shift();r.push(a);let l=n.dependedBy.get(a.uniqueId);for(let c of Array.from(l.values())){let u=n.dependsOn.get(c);u.delete(a.uniqueId),u.size===0&&t.get(c)&&(o.push(t.get(c)),t.delete(c))}}return t.size>0&&(N.Error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach(a=>{N.Error(a.name)})),r}_addNodeAndDescendantsToList(e,t,n,r){if(!(!n||r&&!r(n)||t.has(n.uniqueId))){e.push(n),t.add(n.uniqueId);for(let s of n.getDescendants(!0))this._addNodeAndDescendantsToList(e,t,s,r)}}_isNodeInContainer(e){return e instanceof _i&&this.meshes.indexOf(e)!==-1||e instanceof ln&&this.transformNodes.indexOf(e)!==-1||e instanceof an&&this.lights.indexOf(e)!==-1||e instanceof Ne&&this.cameras.indexOf(e)!==-1}_isValidHierarchy(){for(let e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return N.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(let e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return N.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(let e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return N.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(let e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return N.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,n){this._isValidHierarchy()||z.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");let r={},s={},o=new cb,a=[],l=[],c=K({doNotInstantiate:!0},n),u=(g,_)=>{if(r[g.uniqueId]=_.uniqueId,s[_.uniqueId]=_,e&&(_.name=e(g.name)),_ instanceof A){let y=_;if(y.morphTargetManager){let C=g.morphTargetManager;y.morphTargetManager=C.clone();for(let E=0;E<C.numTargets;E++){let I=C.getTarget(E),v=y.morphTargetManager.getTarget(E);r[I.uniqueId]=v.uniqueId,s[v.uniqueId]=v}}}},h=[],d=new Set;for(let g of this.transformNodes)g.parent===null&&this._addNodeAndDescendantsToList(h,d,g,c.predicate);for(let g of this.meshes)g.parent===null&&this._addNodeAndDescendantsToList(h,d,g,c.predicate);let f=this._topologicalSort(h),p=(g,_)=>{if(u(g,_),g.parent){let y=r[g.parent.uniqueId],C=s[y];C?_.parent=C:_.parent=g.parent}if(_.position&&g.position&&_.position.copyFrom(g.position),_.rotationQuaternion&&g.rotationQuaternion&&_.rotationQuaternion.copyFrom(g.rotationQuaternion),_.rotation&&g.rotation&&_.rotation.copyFrom(g.rotation),_.scaling&&g.scaling&&_.scaling.copyFrom(g.scaling),_.material){let y=_;if(y.material)if(t){let C=g.material;if(l.indexOf(C)===-1){let E=C.clone(e?e(C.name):"Clone of "+C.name);if(l.push(C),r[C.uniqueId]=E.uniqueId,s[E.uniqueId]=E,C.getClassName()==="MultiMaterial"){let I=C;for(let v of I.subMaterials)v&&(E=v.clone(e?e(v.name):"Clone of "+v.name),l.push(v),r[v.uniqueId]=E.uniqueId,s[E.uniqueId]=E);I.subMaterials=I.subMaterials.map(v=>v&&s[r[v.uniqueId]])}}y.getClassName()!=="InstancedMesh"&&(y.material=s[r[C.uniqueId]])}else y.material.getClassName()==="MultiMaterial"?this.scene.multiMaterials.indexOf(y.material)===-1&&this.scene.addMultiMaterial(y.material):this.scene.materials.indexOf(y.material)===-1&&this.scene.addMaterial(y.material)}_.parent===null&&o.rootNodes.push(_)};for(let g of f)if(g.getClassName()==="InstancedMesh"){let _=g,y=_.sourceMesh,C=r[y.uniqueId],I=(typeof C=="number"?s[C]:y).createInstance(_.name);p(_,I)}else{let _=!0;g.getClassName()==="TransformNode"||g.getClassName()==="Node"||g.skeleton||!g.getTotalVertices||g.getTotalVertices()===0?_=!1:c.doNotInstantiate&&(typeof c.doNotInstantiate=="function"?_=!c.doNotInstantiate(g):_=!c.doNotInstantiate);let y=_?g.createInstance(`instance of ${g.name}`):g.clone(`Clone of ${g.name}`,null,!0);if(!y)throw new Error(`Could not clone or instantiate node on Asset Container ${g.name}`);p(g,y)}for(let g of this.skeletons){if(c.predicate&&!c.predicate(g))continue;let _=g.clone(e?e(g.name):"Clone of "+g.name);for(let y of this.meshes)if(y.skeleton===g&&!y.isAnInstance){let C=s[r[y.uniqueId]];if(!C||C.isAnInstance||(C.skeleton=_,a.indexOf(_)!==-1))continue;a.push(_);for(let E of _.bones)E._linkedTransformNode&&(E._linkedTransformNode=s[r[E._linkedTransformNode.uniqueId]])}o.skeletons.push(_)}for(let g of this.animationGroups){if(c.predicate&&!c.predicate(g))continue;let _=g.clone(e?e(g.name):"Clone of "+g.name,y=>s[r[y.uniqueId]]||y);o.animationGroups.push(_)}return o}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||z.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(let e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){let t=[];for(let n of this.cameras)e&&!e(n)||(this.scene.addCamera(n),t.push(n));for(let n of this.lights)e&&!e(n)||(this.scene.addLight(n),t.push(n));for(let n of this.meshes)e&&!e(n)||(this.scene.addMesh(n),t.push(n));for(let n of this.skeletons)e&&!e(n)||this.scene.addSkeleton(n);for(let n of this.animations)e&&!e(n)||this.scene.addAnimation(n);for(let n of this.animationGroups)e&&!e(n)||this.scene.addAnimationGroup(n);for(let n of this.multiMaterials)e&&!e(n)||this.scene.addMultiMaterial(n);for(let n of this.materials)e&&!e(n)||this.scene.addMaterial(n);for(let n of this.morphTargetManagers)e&&!e(n)||this.scene.addMorphTargetManager(n);for(let n of this.geometries)e&&!e(n)||this.scene.addGeometry(n);for(let n of this.transformNodes)e&&!e(n)||(this.scene.addTransformNode(n),t.push(n));for(let n of this.actionManagers)e&&!e(n)||this.scene.addActionManager(n);for(let n of this.textures)e&&!e(n)||this.scene.addTexture(n);for(let n of this.reflectionProbes)e&&!e(n)||this.scene.addReflectionProbe(n);if(t.length){let n=new Set(this.scene.meshes);for(let r of this.scene.lights)n.add(r);for(let r of this.scene.cameras)n.add(r);for(let r of this.scene.transformNodes)n.add(r);for(let r of this.skeletons)for(let s of r.bones)n.add(s);for(let r of t)r.parent&&!n.has(r.parent)&&(r.setParent?r.setParent(null):r.parent=null)}}removeAllFromScene(){this._isValidHierarchy()||z.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(let e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){for(let t of this.cameras)e&&!e(t)||this.scene.removeCamera(t);for(let t of this.lights)e&&!e(t)||this.scene.removeLight(t);for(let t of this.meshes)e&&!e(t)||this.scene.removeMesh(t,!0);for(let t of this.skeletons)e&&!e(t)||this.scene.removeSkeleton(t);for(let t of this.animations)e&&!e(t)||this.scene.removeAnimation(t);for(let t of this.animationGroups)e&&!e(t)||this.scene.removeAnimationGroup(t);for(let t of this.multiMaterials)e&&!e(t)||this.scene.removeMultiMaterial(t);for(let t of this.materials)e&&!e(t)||this.scene.removeMaterial(t);for(let t of this.morphTargetManagers)e&&!e(t)||this.scene.removeMorphTargetManager(t);for(let t of this.geometries)e&&!e(t)||this.scene.removeGeometry(t);for(let t of this.transformNodes)e&&!e(t)||this.scene.removeTransformNode(t);for(let t of this.actionManagers)e&&!e(t)||this.scene.removeActionManager(t);for(let t of this.textures)e&&!e(t)||this.scene.removeTexture(t);for(let t of this.reflectionProbes)e&&!e(t)||this.scene.removeReflectionProbe(t)}dispose(){let e=this.cameras.slice(0);for(let p of e)p.dispose();this.cameras.length=0;let t=this.lights.slice(0);for(let p of t)p.dispose();this.lights.length=0;let n=this.meshes.slice(0);for(let p of n)p.dispose();this.meshes.length=0;let r=this.skeletons.slice(0);for(let p of r)p.dispose();this.skeletons.length=0;let s=this.animationGroups.slice(0);for(let p of s)p.dispose();this.animationGroups.length=0;let o=this.multiMaterials.slice(0);for(let p of o)p.dispose();this.multiMaterials.length=0;let a=this.materials.slice(0);for(let p of a)p.dispose();this.materials.length=0;let l=this.geometries.slice(0);for(let p of l)p.dispose();this.geometries.length=0;let c=this.transformNodes.slice(0);for(let p of c)p.dispose();this.transformNodes.length=0;let u=this.actionManagers.slice(0);for(let p of u)p.dispose();this.actionManagers.length=0;let h=this.textures.slice(0);for(let p of h)p.dispose();this.textures.length=0;let d=this.reflectionProbes.slice(0);for(let p of d)p.dispose();this.reflectionProbes.length=0;let f=this.morphTargetManagers.slice(0);for(let p of f)p.dispose();this.morphTargetManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(let p of this.scene._serializableComponents)p.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,n){if(!(!e||!t))for(let r of e){let s=!0;if(n){for(let o of n)if(r===o){s=!1;break}}s&&(t.push(r),r._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,e===void 0&&(e=new lb);for(let t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||(t==="_environmentTexture"?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){let e=new A("assetContainerRootMesh",this.scene);for(let t of this.meshes)t.parent||e.addChild(t);return this.meshes.unshift(e),e}mergeAnimationsTo(e=Ie.LastCreatedScene,t,n=null){if(!e)return N.Error("No scene available to merge animations to"),[];let r=n||(l=>{let c=null,u=l.animations.length?l.animations[0].targetProperty:"",h=l.name.split(".").join("").split("_primitive")[0];switch(u){case"position":case"rotationQuaternion":c=e.getTransformNodeByName(l.name)||e.getTransformNodeByName(h);break;case"influence":c=e.getMorphTargetByName(l.name)||e.getMorphTargetByName(h);break;default:c=e.getNodeByName(l.name)||e.getNodeByName(h)}return c}),s=this.getNodes();for(let l of s){let c=r(l);if(c!==null){for(let u of l.animations){let h=c.animations.filter(d=>d.targetProperty===u.targetProperty);for(let d of h){let f=c.animations.indexOf(d,0);f>-1&&c.animations.splice(f,1)}}c.animations=c.animations.concat(l.animations)}}let o=[],a=this.animationGroups.slice();for(let l of a){o.push(l.clone(l.name,r));for(let c of l.animatables)c.stop()}for(let l of t){let c=r(l.target);c&&(e.beginAnimation(c,l.fromFrame,l.toFrame,l.loopAnimation,l.speedRatio,l.onAnimationEnd?l.onAnimationEnd:void 0,void 0,!0,void 0,l.onAnimationLoop?l.onAnimationLoop:void 0),e.stopAnimation(l.target))}return o}populateRootNodes(){this.rootNodes.length=0;for(let e of this.meshes)!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e);for(let e of this.transformNodes)!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e);for(let e of this.lights)!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e);for(let e of this.cameras)!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)}addAllAssetsToContainer(e){if(!e)return;let t=[],n=new Set;for(t.push(e);t.length>0;){let r=t.pop();if(r instanceof A?(r.geometry&&this.geometries.indexOf(r.geometry)===-1&&this.geometries.push(r.geometry),this.meshes.push(r)):r instanceof us?this.meshes.push(r):r instanceof ln?this.transformNodes.push(r):r instanceof an?this.lights.push(r):r instanceof Ne&&this.cameras.push(r),r instanceof _i){if(r.material&&this.materials.indexOf(r.material)===-1){this.materials.push(r.material);for(let s of r.material.getActiveTextures())this.textures.indexOf(s)===-1&&this.textures.push(s)}r.skeleton&&this.skeletons.indexOf(r.skeleton)===-1&&this.skeletons.push(r.skeleton),r.morphTargetManager&&this.morphTargetManagers.indexOf(r.morphTargetManager)===-1&&this.morphTargetManagers.push(r.morphTargetManager)}for(let s of r.getChildren())n.has(s)||t.push(s);n.add(r)}this.populateRootNodes()}_getByTags(e,t,n){if(t===void 0)return e;let r=[];for(let s in e){let o=e[s];Tt&&Tt.MatchesQuery(o,t)&&(!n||n(o))&&r.push(o)}return r}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialsByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}};var Vo=class{constructor(e){this.byteOffset=0,this.buffer=e}loadAsync(e){return T(this,null,function*(){let t=yield this.buffer.readAsync(this.byteOffset,e);this._dataView=new DataView(t.buffer,t.byteOffset,t.byteLength),this._dataByteOffset=0})}readUint32(){let e=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,e}readUint8Array(e){let t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,this.byteOffset+=e,t}readString(e){return rT(this.readUint8Array(e))}skipBytes(e){this._dataByteOffset+=e,this.byteOffset+=e}};function ub(i,e,t,n){let r={externalResourceFunction:n};return t&&(r.uri=e==="file:"?t:e+t),ArrayBuffer.isView(i)?GLTFValidator.validateBytes(i,r):GLTFValidator.validateString(i,r)}function rk(){let i=[];onmessage=e=>{let t=e.data;switch(t.id){case"init":{importScripts(t.url);break}case"validate":{ub(t.data,t.rootUrl,t.fileName,n=>new Promise((r,s)=>{let o=i.length;i.push({resolve:r,reject:s}),postMessage({id:"getExternalResource",index:o,uri:n})})).then(n=>{postMessage({id:"validate.resolve",value:n})},n=>{postMessage({id:"validate.reject",reason:n})});break}case"getExternalResource.resolve":{i[t.index].resolve(t.value);break}case"getExternalResource.reject":{i[t.index].reject(t.reason);break}}}}var Mu=class{static ValidateAsync(e,t,n,r){return typeof Worker=="function"?new Promise((s,o)=>{let a=`${ub}(${rk})()`,l=URL.createObjectURL(new Blob([a],{type:"application/javascript"})),c=new Worker(l),u=d=>{c.removeEventListener("error",u),c.removeEventListener("message",h),o(d)},h=d=>{let f=d.data;switch(f.id){case"getExternalResource":{r(f.uri).then(p=>{c.postMessage({id:"getExternalResource.resolve",index:f.index,value:p},[p.buffer])},p=>{c.postMessage({id:"getExternalResource.reject",index:f.index,reason:p})});break}case"validate.resolve":{c.removeEventListener("error",u),c.removeEventListener("message",h),s(f.value),c.terminate();break}case"validate.reject":c.removeEventListener("error",u),c.removeEventListener("message",h),o(f.reason),c.terminate()}};if(c.addEventListener("error",u),c.addEventListener("message",h),c.postMessage({id:"init",url:z.GetBabylonScriptURL(this.Configuration.url)}),ArrayBuffer.isView(e)){let d=e.slice();c.postMessage({id:"validate",data:d,rootUrl:t,fileName:n},[d.buffer])}else c.postMessage({id:"validate",data:e,rootUrl:t,fileName:n})}):(this._LoadScriptPromise||(this._LoadScriptPromise=z.LoadBabylonScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(()=>ub(e,t,n,r)))}};Mu.Configuration={url:`${z._DefaultCdnUrl}/gltf_validator.js`};var hs="Z2xURg",Du={name:"gltf",extensions:{".gltf":{isBinary:!1,mimeType:"model/gltf+json"},".glb":{isBinary:!0,mimeType:"model/gltf-binary"}},canDirectLoad(i){return i.indexOf("asset")!==-1&&i.indexOf("version")!==-1||i.startsWith("data:base64,"+hs)||i.startsWith("data:;base64,"+hs)||i.startsWith("data:application/octet-stream;base64,"+hs)||i.startsWith("data:model/gltf-binary;base64,"+hs)}};function hw(i,e,t){try{return Promise.resolve(new Uint8Array(i,e,t))}catch(n){return Promise.reject(n)}}function sk(i,e,t){try{if(e<0||e>=i.byteLength)throw new RangeError("Offset is out of range.");if(e+t>i.byteLength)throw new RangeError("Length is out of range.");return Promise.resolve(new Uint8Array(i.buffer,i.byteOffset+e,t))}catch(n){return Promise.reject(n)}}var Ru=(function(i){return i[i.AUTO=0]="AUTO",i[i.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED",i})(Ru||{}),wl=(function(i){return i[i.NONE=0]="NONE",i[i.FIRST=1]="FIRST",i[i.ALL=2]="ALL",i})(wl||{}),li=(function(i){return i[i.LOADING=0]="LOADING",i[i.READY=1]="READY",i[i.COMPLETE=2]="COMPLETE",i})(li||{}),_p=class{constructor(){this.alwaysComputeBoundingBox=!1,this.alwaysComputeSkeletonRootNode=!1,this.animationStartMode=wl.FIRST,this.compileMaterials=!1,this.compileShadowGenerators=!1,this.coordinateSystemMode=Ru.AUTO,this.createInstances=!0,this.loadAllMaterials=!1,this.loadMorphTargets=!0,this.loadNodeAnimations=!0,this.loadOnlyMaterials=!1,this.loadSkins=!0,this.skipMaterials=!1,this.targetFps=60,this.transparencyAsCoverage=!1,this.useClipPlane=!1,this.useGltfTextureNames=!1,this.useRangeRequests=!1,this.useSRGBBuffers=!0,this.validate=!1,this.useOpenPBR=!1}},ok=new _p,hb=class extends _p{constructor(){super(...arguments),this.extensionOptions={},this.preprocessUrlAsync=e=>Promise.resolve(e)}copyFrom(e){e&&(this.alwaysComputeBoundingBox=e.alwaysComputeBoundingBox??this.alwaysComputeBoundingBox,this.alwaysComputeSkeletonRootNode=e.alwaysComputeSkeletonRootNode??this.alwaysComputeSkeletonRootNode,this.animationStartMode=e.animationStartMode??this.animationStartMode,this.capturePerformanceCounters=e.capturePerformanceCounters??this.capturePerformanceCounters,this.compileMaterials=e.compileMaterials??this.compileMaterials,this.compileShadowGenerators=e.compileShadowGenerators??this.compileShadowGenerators,this.coordinateSystemMode=e.coordinateSystemMode??this.coordinateSystemMode,this.createInstances=e.createInstances??this.createInstances,this.customRootNode=e.customRootNode,this.extensionOptions=e.extensionOptions??this.extensionOptions,this.loadAllMaterials=e.loadAllMaterials??this.loadAllMaterials,this.loadMorphTargets=e.loadMorphTargets??this.loadMorphTargets,this.loadNodeAnimations=e.loadNodeAnimations??this.loadNodeAnimations,this.loadOnlyMaterials=e.loadOnlyMaterials??this.loadOnlyMaterials,this.loadSkins=e.loadSkins??this.loadSkins,this.loggingEnabled=e.loggingEnabled??this.loggingEnabled,this.onCameraLoaded=e.onCameraLoaded,this.onMaterialLoaded=e.onMaterialLoaded,this.onMeshLoaded=e.onMeshLoaded,this.onParsed=e.onParsed,this.onSkinLoaded=e.onSkinLoaded,this.onTextureLoaded=e.onTextureLoaded,this.onValidated=e.onValidated,this.preprocessUrlAsync=e.preprocessUrlAsync??this.preprocessUrlAsync,this.skipMaterials=e.skipMaterials??this.skipMaterials,this.targetFps=e.targetFps??this.targetFps,this.transparencyAsCoverage=e.transparencyAsCoverage??this.transparencyAsCoverage,this.useClipPlane=e.useClipPlane??this.useClipPlane,this.useGltfTextureNames=e.useGltfTextureNames??this.useGltfTextureNames,this.useOpenPBR=e.useOpenPBR??this.useOpenPBR,this.useRangeRequests=e.useRangeRequests??this.useRangeRequests,this.useSRGBBuffers=e.useSRGBBuffers??this.useSRGBBuffers,this.validate=e.validate??this.validate)}},Br=(()=>{class i extends hb{constructor(t){super(),this.onParsedObservable=new B,this.onMeshLoadedObservable=new B,this.onSkinLoadedObservable=new B,this.onTextureLoadedObservable=new B,this.onMaterialLoadedObservable=new B,this.onCameraLoadedObservable=new B,this.onCompleteObservable=new B,this.onErrorObservable=new B,this.onDisposeObservable=new B,this.onExtensionLoadedObservable=new B,this.onValidatedObservable=new B,this._loader=null,this._state=null,this._requests=new Array,this.name=Du.name,this.extensions=Du.extensions,this.onLoaderStateChangedObservable=new B,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled,this.copyFrom(Object.assign(K({},ok),t))}set onParsed(t){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),t&&(this._onParsedObserver=this.onParsedObservable.add(t))}set onMeshLoaded(t){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),t&&(this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(t))}set onSkinLoaded(t){this._onSkinLoadedObserver&&this.onSkinLoadedObservable.remove(this._onSkinLoadedObserver),t&&(this._onSkinLoadedObserver=this.onSkinLoadedObservable.add(n=>t(n.node,n.skinnedNode)))}set onTextureLoaded(t){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),t&&(this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(t))}set onMaterialLoaded(t){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),t&&(this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(t))}set onCameraLoaded(t){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),t&&(this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(t))}set onComplete(t){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(t)}set onError(t){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(t)}set onDispose(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)}set onExtensionLoaded(t){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(t)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(t){this._loggingEnabled!==t&&(this._loggingEnabled=t,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(t){this._capturePerformanceCounters!==t&&(this._capturePerformanceCounters=t,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(t){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(t)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(let t of this._requests)t.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=t=>Promise.resolve(t),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(t,n,r,s,o,a,l,c){if(ArrayBuffer.isView(n))return this._loadBinary(t,n,r,s,l,c),null;this._progressCallback=o;let u=n.name||z.GetFilename(n);if(a){if(this.useRangeRequests){this.validate&&N.Warn("glTF validation is not supported when range requests are enabled");let h={abort:()=>{},onCompleteObservable:new B},d={readAsync:(f,p)=>new Promise((g,_)=>{this._loadFile(t,n,y=>{g(new Uint8Array(y))},!0,y=>{_(y)},y=>{y.setRequestHeader("Range",`bytes=${f}-${f+p-1}`)})}),byteLength:0};return this._unpackBinaryAsync(new Vo(d)).then(f=>{h.onCompleteObservable.notifyObservers(h),s(f)},l?f=>l(void 0,f):void 0),h}return this._loadFile(t,n,h=>{this._validate(t,new Uint8Array(h,0,h.byteLength),r,u),this._unpackBinaryAsync(new Vo({readAsync:(d,f)=>hw(h,d,f),byteLength:h.byteLength})).then(d=>{s(d)},l?d=>l(void 0,d):void 0)},!0,l)}else return this._loadFile(t,n,h=>{try{this._validate(t,h,r,u),s({json:this._parseJson(h)})}catch{l&&l()}},!1,l)}_loadBinary(t,n,r,s,o,a){this._validate(t,new Uint8Array(n.buffer,n.byteOffset,n.byteLength),r,a),this._unpackBinaryAsync(new Vo({readAsync:(l,c)=>sk(n,l,c),byteLength:n.byteLength})).then(l=>{s(l)},o?l=>o(void 0,l):void 0)}importMeshAsync(t,n,r,s,o,a){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(r),this.onParsedObservable.clear(),this._log(`Loading ${a||""}`),this._loader=this._getLoader(r),this._loader.importMeshAsync(t,n,null,r,s,o,a)))}loadAsync(t,n,r,s,o){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(n),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(n),this._loader.loadAsync(t,n,r,s,o)))}loadAssetContainerAsync(t,n,r,s,o){return Promise.resolve().then(()=>{this.onParsedObservable.notifyObservers(n),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(n);let a=new gp(t),l=[];this.onMaterialLoadedObservable.add(d=>{l.push(d)});let c=[];this.onTextureLoadedObservable.add(d=>{c.push(d)});let u=[];this.onCameraLoadedObservable.add(d=>{u.push(d)});let h=[];return this.onMeshLoadedObservable.add(d=>{d.morphTargetManager&&h.push(d.morphTargetManager)}),this._loader.importMeshAsync(null,t,a,n,r,s,o).then(d=>(Array.prototype.push.apply(a.geometries,d.geometries),Array.prototype.push.apply(a.meshes,d.meshes),Array.prototype.push.apply(a.particleSystems,d.particleSystems),Array.prototype.push.apply(a.skeletons,d.skeletons),Array.prototype.push.apply(a.animationGroups,d.animationGroups),Array.prototype.push.apply(a.materials,l),Array.prototype.push.apply(a.textures,c),Array.prototype.push.apply(a.lights,d.lights),Array.prototype.push.apply(a.transformNodes,d.transformNodes),Array.prototype.push.apply(a.cameras,u),Array.prototype.push.apply(a.morphTargetManagers,h),a))})}canDirectLoad(t){return Du.canDirectLoad(t)}directLoad(t,n){if(n.startsWith("base64,"+hs)||n.startsWith(";base64,"+hs)||n.startsWith("application/octet-stream;base64,"+hs)||n.startsWith("model/gltf-binary;base64,"+hs)){let r=Ph(n);return this._validate(t,new Uint8Array(r,0,r.byteLength)),this._unpackBinaryAsync(new Vo({readAsync:(s,o)=>hw(r,s,o),byteLength:r.byteLength}))}return this._validate(t,n),Promise.resolve({json:this._parseJson(n)})}createPlugin(t){return new i(t[Du.name])}get loaderState(){return this._state}whenCompleteAsync(){return new Promise((t,n)=>{this.onCompleteObservable.addOnce(()=>{t()}),this.onErrorObservable.addOnce(r=>{n(r)})})}_setState(t){this._state!==t&&(this._state=t,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(li[this._state]))}_loadFile(t,n,r,s,o,a){let l=t._loadFile(n,r,c=>{this._onProgress(c,l)},!0,s,o,a);return l.onCompleteObservable.add(()=>{l._lengthComputable=!0,l._total=l._loaded}),this._requests.push(l),l}_onProgress(t,n){if(!this._progressCallback)return;n._lengthComputable=t.lengthComputable,n._loaded=t.loaded,n._total=t.total;let r=!0,s=0,o=0;for(let a of this._requests){if(a._lengthComputable===void 0||a._loaded===void 0||a._total===void 0)return;r=r&&a._lengthComputable,s+=a._loaded,o+=a._total}this._progressCallback({lengthComputable:r,loaded:s,total:r?o:0})}_validate(t,n,r="",s=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),Mu.ValidateAsync(n,r,s,o=>this.preprocessUrlAsync(r+o).then(a=>t._loadFileAsync(a,void 0,!0,!0).then(l=>new Uint8Array(l,0,l.byteLength)))).then(o=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(o),this.onValidatedObservable.clear()},o=>{this._endPerformanceCounter("Validate JSON"),z.Warn(`Failed to validate: ${o.message}`),this.onValidatedObservable.clear()}))}_getLoader(t){let n=t.json.asset||{};this._log(`Asset version: ${n.version}`),n.minVersion&&this._log(`Asset minimum version: ${n.minVersion}`),n.generator&&this._log(`Asset generator: ${n.generator}`);let r=i._parseVersion(n.version);if(!r)throw new Error("Invalid version: "+n.version);if(n.minVersion!==void 0){let a=i._parseVersion(n.minVersion);if(!a)throw new Error("Invalid minimum version: "+n.minVersion);if(i._compareVersion(a,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+n.minVersion)}let o={1:i._CreateGLTF1Loader,2:i._CreateGLTF2Loader}[r.major];if(!o)throw new Error("Unsupported version: "+n.version);return o(this)}_parseJson(t){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${t.length}`);let n=JSON.parse(t);return this._endPerformanceCounter("Parse JSON"),n}_unpackBinaryAsync(t){return this._startPerformanceCounter("Unpack Binary"),t.loadAsync(20).then(()=>{let n={Magic:1179937895},r=t.readUint32();if(r!==n.Magic)throw new ga("Unexpected magic: "+r,ma.GLTFLoaderUnexpectedMagicError);let s=t.readUint32();this.loggingEnabled&&this._log(`Binary version: ${s}`);let o=t.readUint32();!this.useRangeRequests&&o!==t.buffer.byteLength&&N.Warn(`Length in header does not match actual data length: ${o} != ${t.buffer.byteLength}`);let a;switch(s){case 1:{a=this._unpackBinaryV1Async(t,o);break}case 2:{a=this._unpackBinaryV2Async(t,o);break}default:throw new Error("Unsupported version: "+s)}return this._endPerformanceCounter("Unpack Binary"),a})}_unpackBinaryV1Async(t,n){let r={JSON:0},s=t.readUint32(),o=t.readUint32();if(o!==r.JSON)throw new Error(`Unexpected content format: ${o}`);let a=n-t.byteOffset,l={json:this._parseJson(t.readString(s)),bin:null};if(a!==0){let c=t.byteOffset;l.bin={readAsync:(u,h)=>t.buffer.readAsync(c+u,h),byteLength:a}}return Promise.resolve(l)}_unpackBinaryV2Async(t,n){let r={JSON:1313821514,BIN:5130562},s=t.readUint32();if(t.readUint32()!==r.JSON)throw new Error("First chunk format is not JSON");return t.byteOffset+s===n?t.loadAsync(s).then(()=>({json:this._parseJson(t.readString(s)),bin:null})):t.loadAsync(s+8).then(()=>{let a={json:this._parseJson(t.readString(s)),bin:null},l=()=>{let c=t.readUint32();switch(t.readUint32()){case r.JSON:throw new Error("Unexpected JSON chunk");case r.BIN:{let h=t.byteOffset;a.bin={readAsync:(d,f)=>t.buffer.readAsync(h+d,f),byteLength:c},t.skipBytes(c);break}default:{t.skipBytes(c);break}}return t.byteOffset!==n?t.loadAsync(8).then(l):Promise.resolve(a)};return l()})}static _parseVersion(t){if(t==="1.0"||t==="1.0.1")return{major:1,minor:0};let n=(t+"").match(/^(\d+)\.(\d+)/);return n?{major:parseInt(n[1]),minor:parseInt(n[2])}:null}static _compareVersion(t,n){return t.major>n.major?1:t.major<n.major?-1:t.minor>n.minor?1:t.minor<n.minor?-1:0}_logOpen(t){this._log(t),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(t){let n=i._logSpaces.substring(0,this._logIndentLevel*2);N.Log(`${n}${t}`)}_logDisabled(t){}_startPerformanceCounterEnabled(t){z.StartPerformanceCounter(t)}_startPerformanceCounterDisabled(t){}_endPerformanceCounterEnabled(t){z.EndPerformanceCounter(t)}_endPerformanceCounterDisabled(t){}}return i.IncrementalLoading=!0,i.HomogeneousCoordinates=!1,i._logSpaces="                                ",i})();tb(new Br);var ds=(function(i){return i[i.BYTE=5120]="BYTE",i[i.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",i[i.SHORT=5122]="SHORT",i[i.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",i[i.FLOAT=5126]="FLOAT",i})(ds||{}),db=(function(i){return i[i.FRAGMENT=35632]="FRAGMENT",i[i.VERTEX=35633]="VERTEX",i})(db||{}),Dn=(function(i){return i[i.BYTE=5120]="BYTE",i[i.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",i[i.SHORT=5122]="SHORT",i[i.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",i[i.INT=5124]="INT",i[i.UNSIGNED_INT=5125]="UNSIGNED_INT",i[i.FLOAT=5126]="FLOAT",i[i.FLOAT_VEC2=35664]="FLOAT_VEC2",i[i.FLOAT_VEC3=35665]="FLOAT_VEC3",i[i.FLOAT_VEC4=35666]="FLOAT_VEC4",i[i.INT_VEC2=35667]="INT_VEC2",i[i.INT_VEC3=35668]="INT_VEC3",i[i.INT_VEC4=35669]="INT_VEC4",i[i.BOOL=35670]="BOOL",i[i.BOOL_VEC2=35671]="BOOL_VEC2",i[i.BOOL_VEC3=35672]="BOOL_VEC3",i[i.BOOL_VEC4=35673]="BOOL_VEC4",i[i.FLOAT_MAT2=35674]="FLOAT_MAT2",i[i.FLOAT_MAT3=35675]="FLOAT_MAT3",i[i.FLOAT_MAT4=35676]="FLOAT_MAT4",i[i.SAMPLER_2D=35678]="SAMPLER_2D",i})(Dn||{}),Pu=(function(i){return i[i.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",i[i.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",i[i.REPEAT=10497]="REPEAT",i})(Pu||{}),$i=(function(i){return i[i.NEAREST=9728]="NEAREST",i[i.LINEAR=9728]="LINEAR",i[i.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",i[i.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",i[i.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",i[i.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",i})($i||{});var fb=(function(i){return i[i.FRONT=1028]="FRONT",i[i.BACK=1029]="BACK",i[i.FRONT_AND_BACK=1032]="FRONT_AND_BACK",i})(fb||{}),At=(function(i){return i[i.ZERO=0]="ZERO",i[i.ONE=1]="ONE",i[i.SRC_COLOR=768]="SRC_COLOR",i[i.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",i[i.DST_COLOR=774]="DST_COLOR",i[i.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",i[i.SRC_ALPHA=770]="SRC_ALPHA",i[i.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",i[i.DST_ALPHA=772]="DST_ALPHA",i[i.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",i[i.CONSTANT_COLOR=32769]="CONSTANT_COLOR",i[i.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",i[i.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",i[i.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",i[i.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",i})(At||{});kt.AddNodeConstructor("TargetCamera",(i,e)=>()=>new pn(i,m.Zero(),e));var yp=V.Zero(),pb=J.Identity(),pn=class i extends Ne{constructor(e,t,n,r=!0){super(e,t,n,r),this.cameraDirection=new m(0,0,0),this.cameraRotation=new _e(0,0),this.updateUpVectorFromRotation=!1,this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this._panningEpsilon=Pt,this._rotationEpsilon=Pt,this.lockedTarget=null,this._currentTarget=m.Zero(),this._initialFocalDistance=1,this._viewMatrix=V.Zero(),this._cameraTransformMatrix=V.Zero(),this._cameraRotationMatrix=V.Zero(),this._transformedReferencePoint=m.Zero(),this._deferredPositionUpdate=new m,this._deferredRotationQuaternionUpdate=new J,this._deferredRotationUpdate=new m,this._deferredUpdated=!1,this._deferOnly=!1,this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0,this._referencePoint=m.Forward(this.getScene().useRightHandedSystem),this.rotation=new m(0,this.getScene().useRightHandedSystem?Math.PI:0,0)}getFrontPosition(e){this.getWorldMatrix();let t=U.Vector3[0],n=U.Vector3[1];return n.set(0,0,this._scene.useRightHandedSystem?-1:1),this.getDirectionToRef(n,t),t.scaleInPlace(e),this.globalPosition.add(t)}_getLockedTargetPosition(){if(!this.lockedTarget)return null;if(this.lockedTarget.absolutePosition){let e=this.lockedTarget;e.computeWorldMatrix().getTranslationToRef(e.absolutePosition)}return this.lockedTarget.absolutePosition||this.lockedTarget}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return super._restoreStateValues()?(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&this._storedRotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0):!1}_initCache(){super._initCache(),this._cache.lockedTarget=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new J(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}_updateCache(e){e||super._updateCache();let t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return!1;let e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){let e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(e.getFps()*100))}setTarget(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=Pt),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),this.getScene().useRightHandedSystem?V.LookAtRHToRef(this.position,e,m.UpReadOnly,yp):V.LookAtLHToRef(this.position,e,m.UpReadOnly,yp),yp.invert();let t=this.rotationQuaternion||pb;J.FromRotationMatrixToRef(yp,t),t.toEulerAnglesToRef(this.rotation),this.rotation.z=0}get target(){return this.getTarget()}set target(e){this.setTarget(e)}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent){this.parent.getWorldMatrix().invertToRef(U.Matrix[0]),m.TransformNormalToRef(this.cameraDirection,U.Matrix[0],U.Vector3[0]),this._deferredPositionUpdate.addInPlace(U.Vector3[0]),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate);return}this._deferredPositionUpdate.addInPlace(this.cameraDirection),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate)}_checkInputs(){let e=this.invertRotation?-this.inverseRotationSpeed:1,t=this._decideIfNeedsToMove(),n=this.cameraRotation.x||this.cameraRotation.y;this._deferredUpdated=!1,this._deferredRotationUpdate.copyFrom(this.rotation),this._deferredPositionUpdate.copyFrom(this.position),this.rotationQuaternion&&this._deferredRotationQuaternionUpdate.copyFrom(this.rotationQuaternion),t&&this._updatePosition(),n&&(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this._deferredRotationUpdate),this._deferredRotationUpdate.x+=this.cameraRotation.x*e,this._deferredRotationUpdate.y+=this.cameraRotation.y*e,this.noRotationConstraint||(this._deferredRotationUpdate.x>1.570796&&(this._deferredRotationUpdate.x=1.570796),this._deferredRotationUpdate.x<-1.570796&&(this._deferredRotationUpdate.x=-1.570796)),this._deferOnly?this._deferredUpdated=!0:this.rotation.copyFrom(this._deferredRotationUpdate),this.rotationQuaternion&&this._deferredRotationUpdate.lengthSquared()&&(J.RotationYawPitchRollToRef(this._deferredRotationUpdate.y,this._deferredRotationUpdate.x,this._deferredRotationUpdate.z,this._deferredRotationQuaternionUpdate),this._deferOnly?this._deferredUpdated=!0:this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate)));let r=this.speed*this._panningEpsilon,s=this.speed*this._rotationEpsilon;t&&(Math.abs(this.cameraDirection.x)<r&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<r&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<r&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),n&&(Math.abs(this.cameraRotation.x)<s&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<s&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs()}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):V.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}_rotateUpVectorWithCameraRotationMatrix(){return m.TransformNormalToRef(m.UpReadOnly,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),m.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?Vn.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(J.FromEulerVectorToRef(this.rotation,pb),Vn.Y.rotateByQuaternionToRef(pb,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(e,t,n){if(this.getScene().useRightHandedSystem?V.LookAtRHToRef(e,t,n,this._viewMatrix):V.LookAtLHToRef(e,t,n,this._viewMatrix),this.parent){let r=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(r,this._viewMatrix),this._viewMatrix.invert(),this._markSyncedWithParent()}}createRigCamera(e,t){if(this.cameraRigMode!==Ne.RIG_MODE_NONE){let n=new i(e,this.position.clone(),this.getScene());return n.isRigCamera=!0,n.rigParent=this,this.cameraRigMode===Ne.RIG_MODE_VR&&(this.rotationQuaternion||(this.rotationQuaternion=new J),n._cameraRigParams={},n.rotationQuaternion=new J),n.mode=this.mode,n.orthoLeft=this.orthoLeft,n.orthoRight=this.orthoRight,n.orthoTop=this.orthoTop,n.orthoBottom=this.orthoBottom,n}return null}_updateRigCameras(){let e=this._rigCameras[0],t=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case Ne.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ne.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ne.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case Ne.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ne.RIG_MODE_STEREOSCOPIC_INTERLACED:{let n=this.cameraRigMode===Ne.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,r=this.cameraRigMode===Ne.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*n,e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*r,t);break}case Ne.RIG_MODE_VR:e.rotationQuaternion&&t.rotationQuaternion&&this.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position);break}super._updateRigCameras()}_getRigCamPositionAndTarget(e,t){this.getTarget().subtractToRef(this.position,i._TargetFocalPoint),i._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);let r=i._TargetFocalPoint.addInPlace(this.position);V.TranslationToRef(-r.x,-r.y,-r.z,i._TargetTransformMatrix),i._TargetTransformMatrix.multiplyToRef(V.RotationAxis(t.upVector,e),i._RigCamTransformMatrix),V.TranslationToRef(r.x,r.y,r.z,i._TargetTransformMatrix),i._RigCamTransformMatrix.multiplyToRef(i._TargetTransformMatrix,i._RigCamTransformMatrix),m.TransformCoordinatesToRef(this.position,i._RigCamTransformMatrix,t.position),t.setTarget(r)}getClassName(){return"TargetCamera"}};pn._RigCamTransformMatrix=new V;pn._TargetTransformMatrix=new V;pn._TargetFocalPoint=new m;w([L()],pn.prototype,"updateUpVectorFromRotation",void 0);w([yn()],pn.prototype,"rotation",void 0);w([L()],pn.prototype,"speed",void 0);w([fh("lockedTargetId")],pn.prototype,"lockedTarget",void 0);var Lt={},Ml=class{constructor(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=()=>{}}add(e){let t=e.getSimpleName();if(this.attached[t]){N.Warn("camera input of type "+t+" already exists on camera");return}this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl(this.noPreventDefault)}remove(e){for(let t in this.attached){let n=this.attached[t];if(n===e){n.detachControl(),n.camera=null,delete this.attached[t],this.rebuildInputCheck();return}}}removeByType(e){for(let t in this.attached){let n=this.attached[t];n.getClassName()===e&&(n.detachControl(),n.camera=null,delete this.attached[t],this.rebuildInputCheck())}}_addCheckInputs(e){let t=this.checkInputs;return()=>{t(),e()}}attachInput(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)}attachElement(e=!1){if(!this.attachedToElement){e=Ne.ForceAttachControlToAlwaysPreventDefault?!1:e,this.attachedToElement=!0,this.noPreventDefault=e;for(let t in this.attached)this.attached[t].attachControl(e)}}detachElement(e=!1){for(let t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=!1}rebuildInputCheck(){this.checkInputs=()=>{};for(let e in this.attached){let t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}}clear(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=()=>{}}serialize(e){let t={};for(let n in this.attached){let r=this.attached[n],s=Xe.Serialize(r);t[r.getClassName()]=s}e.inputsmgr=t}parse(e){let t=e.inputsmgr;if(t){this.clear();for(let n in t){let r=Lt[n];if(r){let s=t[n],o=Xe.Parse(()=>new r,s,null);this.add(o)}}}else for(let n in this.attached){let r=Lt[this.attached[n].getClassName()];if(r){let s=Xe.Parse(()=>new r,e,null);this.remove(this.attached[n]),this.add(s)}}}};var Rn=class{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array}attachControl(e){e=z.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{let n=t.event;if(!n.metaKey){if(t.type===mh.KEYDOWN)(this.keysUp.indexOf(n.keyCode)!==-1||this.keysDown.indexOf(n.keyCode)!==-1||this.keysLeft.indexOf(n.keyCode)!==-1||this.keysRight.indexOf(n.keyCode)!==-1||this.keysUpward.indexOf(n.keyCode)!==-1||this.keysDownward.indexOf(n.keyCode)!==-1||this.keysRotateLeft.indexOf(n.keyCode)!==-1||this.keysRotateRight.indexOf(n.keyCode)!==-1||this.keysRotateUp.indexOf(n.keyCode)!==-1||this.keysRotateDown.indexOf(n.keyCode)!==-1)&&(this._keys.indexOf(n.keyCode)===-1&&this._keys.push(n.keyCode),e||n.preventDefault());else if(this.keysUp.indexOf(n.keyCode)!==-1||this.keysDown.indexOf(n.keyCode)!==-1||this.keysLeft.indexOf(n.keyCode)!==-1||this.keysRight.indexOf(n.keyCode)!==-1||this.keysUpward.indexOf(n.keyCode)!==-1||this.keysDownward.indexOf(n.keyCode)!==-1||this.keysRotateLeft.indexOf(n.keyCode)!==-1||this.keysRotateRight.indexOf(n.keyCode)!==-1||this.keysRotateUp.indexOf(n.keyCode)!==-1||this.keysRotateDown.indexOf(n.keyCode)!==-1){let r=this._keys.indexOf(n.keyCode);r>=0&&this._keys.splice(r,1),e||n.preventDefault()}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){let e=this.camera;for(let t=0;t<this._keys.length;t++){let n=this._keys[t],r=e._computeLocalCameraSpeed();this.keysLeft.indexOf(n)!==-1?e._localDirection.copyFromFloats(-r,0,0):this.keysUp.indexOf(n)!==-1?e._localDirection.copyFromFloats(0,0,r):this.keysRight.indexOf(n)!==-1?e._localDirection.copyFromFloats(r,0,0):this.keysDown.indexOf(n)!==-1?e._localDirection.copyFromFloats(0,0,-r):this.keysUpward.indexOf(n)!==-1?e._localDirection.copyFromFloats(0,r,0):this.keysDownward.indexOf(n)!==-1?e._localDirection.copyFromFloats(0,-r,0):this.keysRotateLeft.indexOf(n)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):this.keysRotateRight.indexOf(n)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):this.keysRotateUp.indexOf(n)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):this.keysRotateDown.indexOf(n)!==-1&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),m.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){let e=this.camera._calculateHandednessMultiplier();return this.rotationSpeed*this._engine.getDeltaTime()/1e3*e}};w([L()],Rn.prototype,"keysUp",void 0);w([L()],Rn.prototype,"keysUpward",void 0);w([L()],Rn.prototype,"keysDown",void 0);w([L()],Rn.prototype,"keysDownward",void 0);w([L()],Rn.prototype,"keysLeft",void 0);w([L()],Rn.prototype,"keysRight",void 0);w([L()],Rn.prototype,"rotationSpeed",void 0);w([L()],Rn.prototype,"keysRotateLeft",void 0);w([L()],Rn.prototype,"keysRotateRight",void 0);w([L()],Rn.prototype,"keysRotateUp",void 0);w([L()],Rn.prototype,"keysRotateDown",void 0);Lt.FreeCameraKeyboardMoveInput=Rn;var Go=class{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new B,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}attachControl(e){e=z.BackCompatCameraNoPreventDefault(arguments);let t=this.camera.getEngine(),n=t.getInputElement();this._pointerInput||(this._pointerInput=r=>{let s=r.event,o=s.pointerType==="touch";if(!this.touchEnabled&&o||r.type!==Ae.POINTERMOVE&&this.buttons.indexOf(s.button)===-1)return;let a=s.target;if(r.type===Ae.POINTERDOWN){if(o&&this._activePointerId!==-1||!o&&this._currentActiveButton!==-1)return;this._activePointerId=s.pointerId;try{a?.setPointerCapture(s.pointerId)}catch{}this._currentActiveButton===-1&&(this._currentActiveButton=s.button),this._previousPosition={x:s.clientX,y:s.clientY},e||(s.preventDefault(),n&&n.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(r.event)}else if(r.type===Ae.POINTERUP){if(o&&this._activePointerId!==s.pointerId||!o&&this._currentActiveButton!==s.button)return;try{a?.releasePointerCapture(s.pointerId)}catch{}this._currentActiveButton=-1,this._previousPosition=null,e||s.preventDefault(),this._activePointerId=-1}else if(r.type===Ae.POINTERMOVE&&(this._activePointerId===s.pointerId||!o)){if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(r.event);else if(this._previousPosition){let l=this.camera._calculateHandednessMultiplier(),c=(s.clientX-this._previousPosition.x)*l,u=(s.clientY-this._previousPosition.y)*l;this._allowCameraRotation&&(this.camera.cameraRotation.y+=c/this.angularSensibility,this.camera.cameraRotation.x+=u/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:c,offsetY:u}),this._previousPosition={x:s.clientX,y:s.clientY},e||s.preventDefault()}}}),this._onMouseMove=r=>{if(!t.isPointerLock)return;let s=this.camera._calculateHandednessMultiplier();this.camera.cameraRotation.y+=r.movementX*s/this.angularSensibility,this.camera.cameraRotation.x+=r.movementY*s/this.angularSensibility,this._previousPosition=null,e||r.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Ae.POINTERDOWN|Ae.POINTERUP|Ae.POINTERMOVE),n&&(this._contextMenuBind=r=>this.onContextMenu(r),n.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){let t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._activePointerId=-1,this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}};w([L()],Go.prototype,"buttons",void 0);w([L()],Go.prototype,"angularSensibility",void 0);Lt.FreeCameraMouseInput=Go;var Uo=class{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new B,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=z.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Ae.POINTERWHEEL)return;let n=t.event,r=n.deltaMode===gh.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*r*n.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*r*n.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*r*n.deltaZ/this._normalize,n.preventDefault&&(e||n.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Ae.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}};w([L()],Uo.prototype,"wheelPrecisionX",void 0);w([L()],Uo.prototype,"wheelPrecisionY",void 0);w([L()],Uo.prototype,"wheelPrecisionZ",void 0);var ot=(function(i){return i[i.MoveRelative=0]="MoveRelative",i[i.RotateRelative=1]="RotateRelative",i[i.MoveScene=2]="MoveScene",i})(ot||{}),ci=class extends Uo{constructor(){super(...arguments),this._moveRelative=m.Zero(),this._rotateRelative=m.Zero(),this._moveScene=m.Zero(),this._wheelXAction=ot.MoveRelative,this._wheelXActionCoordinate=0,this._wheelYAction=ot.MoveRelative,this._wheelYActionCoordinate=2,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){e===null&&this._wheelXAction!==ot.MoveRelative||(this._wheelXAction=ot.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==ot.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){e===null&&this._wheelYAction!==ot.MoveRelative||(this._wheelYAction=ot.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==ot.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){e===null&&this._wheelZAction!==ot.MoveRelative||(this._wheelZAction=ot.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==ot.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){e===null&&this._wheelXAction!==ot.RotateRelative||(this._wheelXAction=ot.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==ot.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){e===null&&this._wheelYAction!==ot.RotateRelative||(this._wheelYAction=ot.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==ot.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){e===null&&this._wheelZAction!==ot.RotateRelative||(this._wheelZAction=ot.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==ot.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){e===null&&this._wheelXAction!==ot.MoveScene||(this._wheelXAction=ot.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==ot.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){e===null&&this._wheelYAction!==ot.MoveScene||(this._wheelYAction=ot.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==ot.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){e===null&&this._wheelZAction!==ot.MoveScene||(this._wheelZAction=ot.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==ot.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(this._wheelDeltaX===0&&this._wheelDeltaY===0&&this._wheelDeltaZ==0)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);let e=V.Zero();this.camera.getViewMatrix().invertToRef(e);let t=m.Zero();m.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,n){if(e===0||t===null||n===null)return;let r=null;switch(t){case ot.MoveRelative:r=this._moveRelative;break;case ot.RotateRelative:r=this._rotateRelative;break;case ot.MoveScene:r=this._moveScene;break}switch(n){case 0:r.set(e,0,0);break;case 1:r.set(0,e,0);break;case 2:r.set(0,0,e);break}}};w([L()],ci.prototype,"wheelXMoveRelative",null);w([L()],ci.prototype,"wheelYMoveRelative",null);w([L()],ci.prototype,"wheelZMoveRelative",null);w([L()],ci.prototype,"wheelXRotateRelative",null);w([L()],ci.prototype,"wheelYRotateRelative",null);w([L()],ci.prototype,"wheelZRotateRelative",null);w([L()],ci.prototype,"wheelXMoveScene",null);w([L()],ci.prototype,"wheelYMoveScene",null);w([L()],ci.prototype,"wheelZMoveScene",null);Lt.FreeCameraMouseWheelInput=ci;var zo=class{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=z.IsSafari()}attachControl(e){e=z.BackCompatCameraNoPreventDefault(arguments);let t=null;if(this._pointerInput===void 0&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=n=>{let r=n.event,s=r.pointerType==="mouse"||this._isSafari&&typeof r.pointerType>"u";if(!(!this.allowMouse&&s)){if(n.type===Ae.POINTERDOWN){if(e||r.preventDefault(),this._pointerPressed.push(r.pointerId),this._pointerPressed.length!==1)return;t={x:r.clientX,y:r.clientY}}else if(n.type===Ae.POINTERUP){e||r.preventDefault();let o=this._pointerPressed.indexOf(r.pointerId);if(o===-1||(this._pointerPressed.splice(o,1),o!=0))return;t=null,this._offsetX=null,this._offsetY=null}else if(n.type===Ae.POINTERMOVE){if(e||r.preventDefault(),!t||this._pointerPressed.indexOf(r.pointerId)!=0)return;this._offsetX=r.clientX-t.x,this._offsetY=-(r.clientY-t.y)}}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Ae.POINTERDOWN|Ae.POINTERUP|Ae.POINTERMOVE),this._onLostFocus){let r=this.camera.getEngine().getInputElement();r&&r.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){let t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(this._offsetX===null||this._offsetY===null||this._offsetX===0&&this._offsetY===0)return;let e=this.camera,t=e._calculateHandednessMultiplier();if(e.cameraRotation.y=this._offsetX*t/this.touchAngularSensibility,this.singleFingerRotate&&this._pointerPressed.length===1||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-(this._offsetY*t)/this.touchAngularSensibility;else{let r=e._computeLocalCameraSpeed(),s=new m(0,0,this.touchMoveSensibility!==0?r*this._offsetY/this.touchMoveSensibility:0);V.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(m.TransformCoordinates(s,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}};w([L()],zo.prototype,"touchAngularSensibility",void 0);w([L()],zo.prototype,"touchMoveSensibility",void 0);Lt.FreeCameraTouchInput=zo;var Hs=class extends Ml{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new Rn),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new Go(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new ci,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new zo),this}clear(){super.clear(),this._mouseInput=null}};var Ot=class extends pn{get angularSensibility(){let e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){let t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){let e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){let t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){let e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){let t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){let e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){let t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){let e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){let t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){let e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){let t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){let e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){let t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){let e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){let t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){let e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){let t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}get keysRotateUp(){let e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){let t=this.inputs.attached.keyboard;t&&(t.keysRotateUp=e)}get keysRotateDown(){let e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){let t=this.inputs.attached.keyboard;t&&(t.keysRotateDown=e)}constructor(e,t,n,r=!0){super(e,t,n,r),this.ellipsoid=new m(.5,1,.5),this.ellipsoidOffset=new m(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=m.Zero(),this._diffPosition=m.Zero(),this._newPosition=m.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(s,o,a=null)=>{this._newPosition.copyFrom(o),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>ne.CollisionsEpsilon&&(this.position.addToRef(this._diffPosition,this._deferredPositionUpdate),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate),this.onCollide&&a&&this.onCollide(a))},this.inputs=new Hs(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=z.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new m(0,0,0),this.cameraRotation=new _e(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;this.parent?t=m.TransformCoordinates(this.position,this.parent.getWorldMatrix()):t=this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);let n=this.getScene().collisionCoordinator;this._collider||(this._collider=n.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let r=e;this.applyGravity&&(r=e.add(this.getScene().gravity)),n.getNewPosition(this._oldPosition,r,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=m.Zero(),this._transformedDirection=m.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}};w([yn()],Ot.prototype,"ellipsoid",void 0);w([yn()],Ot.prototype,"ellipsoidOffset",void 0);w([L()],Ot.prototype,"checkCollisions",void 0);w([L()],Ot.prototype,"applyGravity",void 0);ue("BABYLON.FreeCamera",Ot);var jn=class i extends te{constructor(e,t,n,r,s,o=!0,a=!1,l=3,c=0,u,h,d){super(null,s,!o,a,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,u),this.format=r,this._engine&&(!this._engine._caps.textureFloatLinearFiltering&&c===1&&(l=1),!this._engine._caps.textureHalfFloatLinearFiltering&&c===2&&(l=1),this._texture=this._engine.createRawTexture(e,t,n,r,o,a,l,null,c,u??0,h??!1),this.wrapU=te.CLAMP_ADDRESSMODE,this.wrapV=te.CLAMP_ADDRESSMODE,this._waitingForData=!!d&&!e)}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer),this._waitingForData=!1}clone(){if(!this._texture)return super.clone();let e=new i(null,this.getSize().width,this.getSize().height,this.format,this.getScene(),this._texture.generateMipMaps,this._invertY,this.samplingMode,this._texture.type,this._texture._creationFlags,this._useSRGBBuffer);return e._texture=this._texture,this._texture.incrementReferences(),e}isReady(){return super.isReady()&&!this._waitingForData}static CreateLuminanceTexture(e,t,n,r,s=!0,o=!1,a=3){return new i(e,t,n,1,r,s,o,a)}static CreateLuminanceAlphaTexture(e,t,n,r,s=!0,o=!1,a=3){return new i(e,t,n,2,r,s,o,a)}static CreateAlphaTexture(e,t,n,r,s=!0,o=!1,a=3){return new i(e,t,n,0,r,s,o,a)}static CreateRGBTexture(e,t,n,r,s=!0,o=!1,a=3,l=0,c=0,u=!1){return new i(e,t,n,4,r,s,o,a,l,c,u)}static CreateRGBATexture(e,t,n,r,s=!0,o=!1,a=3,l=0,c=0,u=!1,h=!1){return new i(e,t,n,5,r,s,o,a,l,c,u,h)}static CreateRGBAStorageTexture(e,t,n,r,s=!0,o=!1,a=3,l=0,c=!1){return new i(e,t,n,5,r,s,o,a,l,1,c)}static CreateRTexture(e,t,n,r,s=!0,o=!1,a=te.TRILINEAR_SAMPLINGMODE,l=1){return new i(e,t,n,6,r,s,o,a,l)}static CreateRStorageTexture(e,t,n,r,s=!0,o=!1,a=te.TRILINEAR_SAMPLINGMODE,l=1){return new i(e,t,n,6,r,s,o,a,l,1)}};var Ho=class i{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,t,n){this.name=e,this.id=t,this.bones=[],this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=V.Identity(),this._currentRenderId=-1,this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new B,this.metadata=null,this.bones=[],this._scene=n||Ie.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;let r=this._scene.getEngine().getCaps();this._canUseTextureForBones=r.textureFloat&&r.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter(e=>!e.getParent())}getTransformMatrices(e){if(this.needInitialSkinMatrix){if(!e)throw new Error("getTransformMatrices: When using the needInitialSkinMatrix flag, a mesh must be provided");return e._bonesTransformMatrices||this.prepare(!0),e._bonesTransformMatrices}return(!this._transformMatrices||this._isDirty)&&this.prepare(!this._transformMatrices),this._transformMatrices}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){t+=", Ranges: {";let n=!0;for(let r in this._ranges)n&&(t+=", ",n=!1),t+=r;t+="}"}return t}getBoneIndexByName(e){for(let t=0,n=this.bones.length;t<n;t++)if(this.bones[t].name===e)return t;return-1}createAnimationRange(e,t,n){if(!this._ranges[e]){this._ranges[e]=new Tg(e,t,n);for(let r=0,s=this.bones.length;r<s;r++)this.bones[r].animations[0]&&this.bones[r].animations[0].createRange(e,t,n)}}deleteAnimationRange(e,t=!0){for(let n=0,r=this.bones.length;n<r;n++)this.bones[n].animations[0]&&this.bones[n].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){let e=[],t;for(t in this._ranges)e.push(this._ranges[t]);return e}copyAnimationRange(e,t,n=!1){if(this._ranges[t]||!e.getAnimationRange(t))return!1;let r=!0,s=this._getHighestAnimationFrame()+1,o={},a=e.bones,l,c;for(c=0,l=a.length;c<l;c++)o[a[c].name]=a[c];this.bones.length!==a.length&&(N.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${a.length}`),r=!1);let u=n&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(c=0,l=this.bones.length;c<l;c++){let d=this.bones[c].name,f=o[d];f?r=r&&this.bones[c].copyAnimationRange(f,t,s,n,u):(N.Warn("copyAnimationRange: not same rig, missing source bone "+d),r=!1)}let h=e.getAnimationRange(t);return h&&(this._ranges[t]=new Tg(t,h.from+s,h.to+s)),r}returnToRest(){for(let e of this.bones)e._index!==-1&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,n=this.bones.length;t<n;t++)if(this.bones[t].animations[0]){let r=this.bones[t].animations[0].getHighestFrame();e<r&&(e=r)}return e}beginAnimation(e,t,n,r){let s=this.getAnimationRange(e);return s?this._scene.beginAnimation(this,s.from,s.to,t,n,r):null}static MakeAnimationAdditive(e,t=0,n){let r=e.getAnimationRange(n);if(!r)return null;let s=e._scene.getAllAnimatablesByTarget(e),o=null;for(let l=0;l<s.length;l++){let c=s[l];if(c.fromFrame===r?.from&&c.toFrame===r?.to){o=c;break}}let a=e.getAnimatables();for(let l=0;l<a.length;l++){let u=a[l].animations;if(u)for(let h=0;h<u.length;h++)H.MakeAnimationAdditive(u[h],t,n)}return o&&(o.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){let t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let n=0;n<this.bones.length;n++){let r=this.bones[n];r._childUpdateId++;let s=r.getParent();if(s?r.getLocalMatrix().multiplyToRef(s.getFinalMatrix(),r.getFinalMatrix()):t?r.getLocalMatrix().multiplyToRef(t,r.getFinalMatrix()):r.getFinalMatrix().copyFrom(r.getLocalMatrix()),r._index!==-1){let o=r._index===null?n:r._index;r.getAbsoluteInverseBindMatrix().multiplyToArray(r.getFinalMatrix(),e,o*16)}}this._identity.copyToArray(e,this.bones.length*16)}prepare(e=!1){if(!e){let t=this.getScene().getRenderId();if(this._currentRenderId===t)return;this._currentRenderId=t}if(this._numBonesWithLinkedTransformNode>0){for(let t of this.bones)if(t._linkedTransformNode){let n=t._linkedTransformNode;t.position=n.position,n.rotationQuaternion?t.rotationQuaternion=n.rotationQuaternion:t.rotation=n.rotation,t.scaling=n.scaling}}if(this.needInitialSkinMatrix)for(let t of this._meshesWithPoseMatrix){let n=t.getPoseMatrix(),r=this._isDirty;if((!t._bonesTransformMatrices||t._bonesTransformMatrices.length!==16*(this.bones.length+1))&&(t._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),r=!0),!!r){if(this._synchronizedWithMesh!==t){this._synchronizedWithMesh=t;for(let s of this.bones)s.getParent()||(s.getBindMatrix().multiplyToRef(n,U.Matrix[1]),s._updateAbsoluteBindMatrices(U.Matrix[1]));if(this.isUsingTextureForMatrices){let s=(this.bones.length+1)*4;(!t._transformMatrixTexture||t._transformMatrixTexture.getSize().width!==s)&&(t._transformMatrixTexture&&t._transformMatrixTexture.dispose(),t._transformMatrixTexture=jn.CreateRGBATexture(t._bonesTransformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(t._bonesTransformMatrices,n),this.isUsingTextureForMatrices&&t._transformMatrixTexture&&t._transformMatrixTexture.update(t._bonesTransformMatrices)}}else{if(!this._isDirty)return;(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=jn.CreateRGBATexture(this._transformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,t){let n=new i(e,t||e,this._scene);n.needInitialSkinMatrix=this.needInitialSkinMatrix,n.metadata=this.metadata;for(let r=0;r<this.bones.length;r++){let s=this.bones[r],o=null,a=s.getParent();if(a){let c=this.bones.indexOf(a);o=n.bones[c]}let l=new gr(s.name,n,o,s.getBindMatrix().clone(),s.getRestMatrix().clone());l._index=s._index,s._linkedTransformNode&&l.linkTransformNode(s._linkedTransformNode),xt.DeepCopy(s.animations,l.animations)}if(this._ranges){n._ranges={};for(let r in this._ranges){let s=this._ranges[r];s&&(n._ranges[r]=s.clone())}}return this._isDirty=!0,n.prepare(!0),n}enableBlending(e=.01){for(let t of this.bones)for(let n of t.animations)n.enableBlending=!0,n.blendingSpeed=e}dispose(){if(this._meshesWithPoseMatrix.length=0,this.metadata=null,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){let e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){let e={};e.name=this.name,e.id=this.id,this.dimensionsAtRest&&(e.dimensionsAtRest=this.dimensionsAtRest.asArray()),e.bones=[],e.needInitialSkinMatrix=this.needInitialSkinMatrix,this.metadata&&(e.metadata=this.metadata);for(let t=0;t<this.bones.length;t++){let n=this.bones[t],r=n.getParent(),s={parentBoneIndex:r?this.bones.indexOf(r):-1,index:n.getIndex(),name:n.name,id:n.id,matrix:n.getBindMatrix().asArray(),rest:n.getRestMatrix().asArray(),linkedTransformNodeId:n.getTransformNode()?.id};e.bones.push(s),n.length&&(s.length=n.length),n.metadata&&(s.metadata=n.metadata),n.animations&&n.animations.length>0&&(s.animation=n.animations[0].serialize()),e.ranges=[];for(let o in this._ranges){let a=this._ranges[o];if(!a)continue;let l={};l.name=o,l.from=a.from,l.to=a.to,e.ranges.push(l)}}return e}static Parse(e,t){let n=new i(e.name,e.id,t);e.dimensionsAtRest&&(n.dimensionsAtRest=m.FromArray(e.dimensionsAtRest)),n.needInitialSkinMatrix=e.needInitialSkinMatrix,e.metadata&&(n.metadata=e.metadata);let r;for(r=0;r<e.bones.length;r++){let s=e.bones[r],o=e.bones[r].index,a=null;s.parentBoneIndex>-1&&(a=n.bones[s.parentBoneIndex]);let l=s.rest?V.FromArray(s.rest):null,c=new gr(s.name,n,a,V.FromArray(s.matrix),l,null,o);s.id!==void 0&&s.id!==null&&(c.id=s.id),s.length&&(c.length=s.length),s.metadata&&(c.metadata=s.metadata),s.animation&&c.animations.push(H.Parse(s.animation)),s.linkedTransformNodeId!==void 0&&s.linkedTransformNodeId!==null&&(n._hasWaitingData=!0,c._waitingTransformNodeId=s.linkedTransformNodeId)}if(e.ranges)for(r=0;r<e.ranges.length;r++){let s=e.ranges[r];n.createAnimationRange(s.name,s.from,s.to)}return n}computeAbsoluteMatrices(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteMatrices(),this._absoluteTransformIsDirty=!1)}computeAbsoluteTransforms(e=!1){this.computeAbsoluteMatrices(e)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){let e=[],t=new Array(this.bones.length);for(let n=0;n<this.bones.length;n++)this._sortBones(n,e,t);this.bones=e}_sortBones(e,t,n){if(n[e])return;n[e]=!0;let r=this.bones[e];if(!r)return;r._index===void 0&&(r._index=e);let s=r.getParent();s&&this._sortBones(this.bones.indexOf(s),t,n),t.push(r)}setCurrentPoseAsRest(){for(let e of this.bones)e.setCurrentPoseAsRest()}};var mb={effect:null,subMesh:null},gb=class extends Nh(Cs){},_b=class extends Ra(gb){constructor(e){super(e),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_POSITION=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.MORPHTARGETS_UV2=!1,this.MORPHTARGETS_COLOR=!1,this.MORPHTARGETTEXTURE_HASPOSITIONS=!1,this.MORPHTARGETTEXTURE_HASNORMALS=!1,this.MORPHTARGETTEXTURE_HASTANGENTS=!1,this.MORPHTARGETTEXTURE_HASUVS=!1,this.MORPHTARGETTEXTURE_HASUV2S=!1,this.MORPHTARGETTEXTURE_HASCOLORS=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_COLOR=!1,this.PREPASS_COLOR_INDEX=-1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO=!1,this.PREPASS_ALBEDO_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.PREPASS_NORMALIZED_VIEW_DEPTH=!1,this.PREPASS_NORMALIZED_VIEW_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_VELOCITY_LINEAR=!1,this.PREPASS_VELOCITY_LINEAR_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.AREALIGHTSUPPORTED=!0,this.USE_VERTEX_PULLING=!1,this.CLUSTLIGHT_SLICES=0,this.CLUSTLIGHT_BATCH=0,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.DECAL_AFTER_DETAIL=!1,this.rebuild()}},yb=class extends Oa(_r){},Z=class i extends yb{get isPrePassCapable(){return!this.disableDepthWrite}get canRenderToMRT(){return!0}constructor(e,t,n=!1){super(e,t,void 0,n||i.ForceGLSL),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new G(0,0,0),this.diffuseColor=new G(1,1,1),this.specularColor=new G(1,1,1),this.emissiveColor=new G(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._applyDecalMapAfterDetailMap=!1,this._shadersLoaded=!1,this._renderTargets=new Ca(16),this._globalAmbientColor=new G(0,0,0),this._cacheHasRenderTargetTextures=!1,this.detailMap=new zT(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new Oh,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),i.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),i.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}get hasRenderTargetTextures(){return i.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget||i.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}needAlphaBlending(){return this._hasTransparencyMode?this._transparencyModeIsBlend:this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled}needAlphaTesting(){return this._hasTransparencyMode?this._transparencyModeIsTest:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===Oe.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==Oe.MATERIAL_OPAQUE}_hasAlphaChannel(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,t,n=!1){this._uniformBufferLayoutBuilt||this.buildUniformLayout();let r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===n)return!0;t.materialDefines||(this._callbackPluginEventGeneric(4,this._eventInfo),t.materialDefines=new _b(this._eventInfo.defineNames));let s=this.getScene(),o=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;let a=s.getEngine();o._needNormals=Sh(s,e,o,!0,this._maxSimultaneousLights,this._disableLighting),Eh(s,o);let l=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(Ah(s,o,this.canRenderToMRT&&!l),wT(s,o,l),Pa.PrepareDefines(a.currentRenderPassId,e,o),o._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,o._needUVs=!1;for(let u=1;u<=6;++u)o["MAINUV"+u]=!1;if(s.texturesEnabled){if(o.DIFFUSEDIRECTUV=0,o.BUMPDIRECTUV=0,o.AMBIENTDIRECTUV=0,o.OPACITYDIRECTUV=0,o.EMISSIVEDIRECTUV=0,o.SPECULARDIRECTUV=0,o.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&i.DiffuseTextureEnabled)if(this._diffuseTexture.isReadyOrNotBlocking())pr(this._diffuseTexture,o,"DIFFUSE");else return!1;else o.DIFFUSE=!1;if(this._ambientTexture&&i.AmbientTextureEnabled)if(this._ambientTexture.isReadyOrNotBlocking())pr(this._ambientTexture,o,"AMBIENT");else return!1;else o.AMBIENT=!1;if(this._opacityTexture&&i.OpacityTextureEnabled)if(this._opacityTexture.isReadyOrNotBlocking())pr(this._opacityTexture,o,"OPACITY"),o.OPACITYRGB=this._opacityTexture.getAlphaFromRGB;else return!1;else o.OPACITY=!1;if(this._reflectionTexture&&i.ReflectionTextureEnabled?(o.ROUGHNESS=this._roughness>0,o.REFLECTIONOVERALPHA=this._useReflectionOverAlpha):(o.ROUGHNESS=!1,o.REFLECTIONOVERALPHA=!1),!Ih(s,this._reflectionTexture,o))return!1;if(this._emissiveTexture&&i.EmissiveTextureEnabled)if(this._emissiveTexture.isReadyOrNotBlocking())pr(this._emissiveTexture,o,"EMISSIVE");else return!1;else o.EMISSIVE=!1;if(this._lightmapTexture&&i.LightmapTextureEnabled)if(this._lightmapTexture.isReadyOrNotBlocking())pr(this._lightmapTexture,o,"LIGHTMAP"),o.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,o.RGBDLIGHTMAP=this._lightmapTexture.isRGBD;else return!1;else o.LIGHTMAP=!1;if(this._specularTexture&&i.SpecularTextureEnabled)if(this._specularTexture.isReadyOrNotBlocking())pr(this._specularTexture,o,"SPECULAR"),o.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha;else return!1;else o.SPECULAR=!1;if(s.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&i.BumpTextureEnabled){if(this._bumpTexture.isReady())pr(this._bumpTexture,o,"BUMP"),o.PARALLAX=this._useParallax,o.PARALLAX_RHS=s.useRightHandedSystem,o.PARALLAXOCCLUSION=this._useParallaxOcclusion;else return!1;o.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else o.BUMP=!1,o.PARALLAX=!1,o.PARALLAX_RHS=!1,o.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&i.RefractionTextureEnabled)if(this._refractionTexture.isReadyOrNotBlocking())o._needUVs=!0,o.REFRACTION=!0,o.REFRACTIONMAP_3D=this._refractionTexture.isCube,o.RGBDREFRACTION=this._refractionTexture.isRGBD,o.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize;else return!1;else o.REFRACTION=!1;o.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else o.DIFFUSE=!1,o.AMBIENT=!1,o.OPACITY=!1,o.REFLECTION=!1,o.EMISSIVE=!1,o.LIGHTMAP=!1,o.BUMP=!1,o.REFRACTION=!1;o.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),o.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,o.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,o.SPECULAROVERALPHA=this._useSpecularOverAlpha,o.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,o.ALPHATEST_AFTERALLALPHACOMPUTATIONS=this.transparencyMode!==null,o.ALPHABLEND=this.transparencyMode===null||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=o,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(o._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(o),o.IS_REFLECTION_LINEAR=this.reflectionTexture!=null&&!this.reflectionTexture.gammaSpace,o.IS_REFRACTION_LINEAR=this.refractionTexture!=null&&!this.refractionTexture.gammaSpace}if(o._areFresnelDirty&&(i.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(o.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,o.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,o.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,o.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,o.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,o.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,o._needNormals=!0,o.FRESNEL=!0):o.FRESNEL=!1),o.AREALIGHTUSED||o.CLUSTLIGHT_BATCH){for(let u=0;u<e.lightSources.length;u++)if(!e.lightSources[u]._isReady())return!1}Aa(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),o,this._applyDecalMapAfterDetailMap,this._useVertexPulling,t.getRenderingMesh(),this._isVertexOutputInvariant),wa(s,a,this,o,n,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=o,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),Ma(e,o,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);let c=!1;if(o.isDirty){let u=o._areLightsDisposed;o.markAsProcessed();let h=new fr;o.REFLECTION&&h.addFallback(0,"REFLECTION"),o.SPECULAR&&h.addFallback(0,"SPECULAR"),o.BUMP&&h.addFallback(0,"BUMP"),o.PARALLAX&&h.addFallback(1,"PARALLAX"),o.PARALLAX_RHS&&h.addFallback(1,"PARALLAX_RHS"),o.PARALLAXOCCLUSION&&h.addFallback(0,"PARALLAXOCCLUSION"),o.SPECULAROVERALPHA&&h.addFallback(0,"SPECULAROVERALPHA"),o.FOG&&h.addFallback(1,"FOG"),o.POINTSIZE&&h.addFallback(0,"POINTSIZE"),o.LOGARITHMICDEPTH&&h.addFallback(0,"LOGARITHMICDEPTH"),Th(o,h,this._maxSimultaneousLights),o.SPECULARTERM&&h.addFallback(0,"SPECULARTERM"),o.DIFFUSEFRESNEL&&h.addFallback(1,"DIFFUSEFRESNEL"),o.OPACITYFRESNEL&&h.addFallback(2,"OPACITYFRESNEL"),o.REFLECTIONFRESNEL&&h.addFallback(3,"REFLECTIONFRESNEL"),o.EMISSIVEFRESNEL&&h.addFallback(4,"EMISSIVEFRESNEL"),o.FRESNEL&&h.addFallback(4,"FRESNEL"),o.MULTIVIEW&&h.addFallback(0,"MULTIVIEW");let d=[S.PositionKind];o.NORMAL&&d.push(S.NormalKind),o.TANGENT&&d.push(S.TangentKind);for(let x=1;x<=6;++x)o["UV"+x]&&d.push(`uv${x===1?"":x}`);o.VERTEXCOLOR&&d.push(S.ColorKind),Ch(d,e,o,h),Ea(d,o),ST(d,e,o),AT(d,e,o);let f="default",p=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices","cameraInfo"],g=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler","areaLightsLTC1Sampler","areaLightsLTC2Sampler"];wh(p,g,!1);let _=["Material","Scene","Mesh"],y={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:o.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=h,this._eventInfo.fallbackRank=0,this._eventInfo.defines=o,this._eventInfo.uniforms=p,this._eventInfo.attributes=d,this._eventInfo.samplers=g,this._eventInfo.uniformBuffersNames=_,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=y,this._callbackPluginEventGeneric(128,this._eventInfo),Pa.AddUniformsAndSamplers(p,g),Oh.AddUniforms(p),Oh.AddSamplers(g),gi&&(gi.PrepareUniforms(p,o),gi.PrepareSamplers(g,o)),Mh({uniformsNames:p,uniformBuffersNames:_,samplers:g,defines:o,maxSimultaneousLights:this._maxSimultaneousLights}),Zn(p);let C={};this.customShaderNameResolve&&(f=this.customShaderNameResolve(f,p,_,g,o,d,C));let E=o.toString(),I=t.effect,v=s.getEngine().createEffect(f,{attributes:d,uniformsNames:p,uniformBuffersNames:_,samplers:g,defines:E,fallbacks:h,onCompiled:this.onCompiled,onError:this.onError,indexParameters:y,processFinalCode:C.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:o.PREPASS,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:()=>T(this,null,function*(){this._shaderLanguage===1?yield Promise.all([import("./chunk-3IT6PLKA.js"),import("./chunk-VYLKOKGV.js")]):yield Promise.all([import("./chunk-UOVU2D4O.js"),import("./chunk-C76OWDMN.js")]),this._shadersLoaded=!0})},a);if(this._eventInfo.customCode=void 0,v)if(this._onEffectCreatedObservable&&(mb.effect=v,mb.subMesh=t,this._onEffectCreatedObservable.notifyObservers(mb)),this.allowShaderHotSwapping&&I&&!v.isReady()){if(v=I,o.markAsUnprocessed(),c=this.isFrozen,u)return o._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),t.setEffect(v,o,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(o._renderId=s.getRenderId(),r._wasPreviouslyReady=!c,r._wasPreviouslyUsingInstances=n,this._checkScenePerformancePriority(),!0)}buildUniformLayout(){let e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),e.addUniform("cameraInfo",4),Dh(e,!1,!0),super.buildUniformLayout()}bindForSubMesh(e,t,n){let r=this.getScene(),s=n.materialDefines;if(!s)return;let o=n.effect;if(!o)return;this._activeEffect=o,t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(o,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,t,e,this.isFrozen),Pa.Bind(r.getEngine().currentRenderPassId,this._activeEffect,t,e,this);let a=r.activeCamera;a?this._uniformBuffer.updateFloat4("cameraInfo",a.minZ,a.maxZ,0,0):this._uniformBuffer.updateFloat4("cameraInfo",0,0,0,0),this._eventInfo.subMesh=n,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),s.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));let l=this._mustRebind(r,o,n,t.visibility);Ia(t,o);let c=this._uniformBuffer;if(l){if(this.bindViewProjection(o),!c.useUbo||!this.isFrozen||!c.isSync||n._drawWrapper._forceRebindOnNextCall){if(i.FresnelEnabled&&s.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(c.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),c.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&c.updateColor4("opacityParts",new G(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(c.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),c.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(c.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),c.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(c.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),c.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),r.texturesEnabled&&(this._diffuseTexture&&i.DiffuseTextureEnabled&&(c.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),mr(this._diffuseTexture,c,"diffuse")),this._ambientTexture&&i.AmbientTextureEnabled&&(c.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),mr(this._ambientTexture,c,"ambient")),this._opacityTexture&&i.OpacityTextureEnabled&&(c.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),mr(this._opacityTexture,c,"opacity")),this._hasAlphaChannel()&&c.updateFloat("alphaCutOff",this.alphaCutOff),bh(r,s,c,G.White(),this._reflectionTexture,!1,!1,!0,!1,!1,!1,this.roughness),(!this._reflectionTexture||!i.ReflectionTextureEnabled)&&c.updateFloat2("vReflectionInfos",0,this.roughness),this._emissiveTexture&&i.EmissiveTextureEnabled&&(c.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),mr(this._emissiveTexture,c,"emissive")),this._lightmapTexture&&i.LightmapTextureEnabled&&(c.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),mr(this._lightmapTexture,c,"lightmap")),this._specularTexture&&i.SpecularTextureEnabled&&(c.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),mr(this._specularTexture,c,"specular")),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&i.BumpTextureEnabled&&(c.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),mr(this._bumpTexture,c,"bump"),r._mirroredCameraPosition?c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&i.RefractionTextureEnabled)){let u=1;if(this._refractionTexture.isCube||(c.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(u=this._refractionTexture.depth)),c.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,u,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){let h=this._refractionTexture;c.updateVector3("vRefractionPosition",h.boundingBoxPosition),c.updateVector3("vRefractionSize",h.boundingBoxSize)}}this.pointsCloud&&c.updateFloat("pointSize",this.pointSize),c.updateColor4("vSpecularColor",this.specularColor,this.specularPower),c.updateColor3("vEmissiveColor",i.EmissiveTextureEnabled?this.emissiveColor:G.BlackReadOnly),c.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),r.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),c.updateColor3("vAmbientColor",this._globalAmbientColor)}r.texturesEnabled&&(this._diffuseTexture&&i.DiffuseTextureEnabled&&o.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&i.AmbientTextureEnabled&&o.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&i.OpacityTextureEnabled&&o.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&i.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?o.setTexture("reflectionCubeSampler",this._reflectionTexture):o.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&i.EmissiveTextureEnabled&&o.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&i.LightmapTextureEnabled&&o.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&i.SpecularTextureEnabled&&o.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&i.BumpTextureEnabled&&o.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&i.RefractionTextureEnabled&&(this._refractionTexture.isCube?o.setTexture("refractionCubeSampler",this._refractionTexture):o.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(o),this._eventInfo.subMesh=n,this._callbackPluginEventBindForSubMesh(this._eventInfo),Qn(o,this,r),this.bindEyePosition(o)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(l||!this.isFrozen)&&(r.lightsEnabled&&!this._disableLighting&&xh(r,t,o,s,this._maxSimultaneousLights),(r.fogEnabled&&t.applyFog&&r.fogMode!==Pe.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||s.PREPASS||s.CLUSTLIGHT_BATCH)&&this.bindView(o),Ni(r,t,o),s.NUM_MORPH_INFLUENCERS&&Sa(t,o),s.BAKED_VERTEX_ANIMATION_TEXTURE&&t.bakedVertexAnimationManager?.bind(o,s.INSTANCES),this.useLogarithmicDepth&&Jn(s,o,r),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect,n),c.update()}getAnimatables(){let e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){let e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._diffuseTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._specularTexture===e||this._bumpTexture===e||this._lightmapTexture===e||this._refractionTexture===e)}dispose(e,t){t&&(this._diffuseTexture?.dispose(),this._ambientTexture?.dispose(),this._opacityTexture?.dispose(),this._reflectionTexture?.dispose(),this._emissiveTexture?.dispose(),this._specularTexture?.dispose(),this._bumpTexture?.dispose(),this._lightmapTexture?.dispose(),this._refractionTexture?.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}clone(e,t=!0,n=""){let r=Xe.Clone(()=>new i(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return r.name=e,r.id=e,this.stencil.copyTo(r.stencil),this._clonePlugins(r,n),r}static Parse(e,t,n){let r=Xe.Parse(()=>new i(e.name,t),e,t,n);return e.stencil&&r.stencil.parse(e.stencil,t,n),Oe._ParsePlugins(e,r,t,n),r}static get DiffuseTextureEnabled(){return rt.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){rt.DiffuseTextureEnabled=e}static get DetailTextureEnabled(){return rt.DetailTextureEnabled}static set DetailTextureEnabled(e){rt.DetailTextureEnabled=e}static get AmbientTextureEnabled(){return rt.AmbientTextureEnabled}static set AmbientTextureEnabled(e){rt.AmbientTextureEnabled=e}static get OpacityTextureEnabled(){return rt.OpacityTextureEnabled}static set OpacityTextureEnabled(e){rt.OpacityTextureEnabled=e}static get ReflectionTextureEnabled(){return rt.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){rt.ReflectionTextureEnabled=e}static get EmissiveTextureEnabled(){return rt.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){rt.EmissiveTextureEnabled=e}static get SpecularTextureEnabled(){return rt.SpecularTextureEnabled}static set SpecularTextureEnabled(e){rt.SpecularTextureEnabled=e}static get BumpTextureEnabled(){return rt.BumpTextureEnabled}static set BumpTextureEnabled(e){rt.BumpTextureEnabled=e}static get LightmapTextureEnabled(){return rt.LightmapTextureEnabled}static set LightmapTextureEnabled(e){rt.LightmapTextureEnabled=e}static get RefractionTextureEnabled(){return rt.RefractionTextureEnabled}static set RefractionTextureEnabled(e){rt.RefractionTextureEnabled=e}static get ColorGradingTextureEnabled(){return rt.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){rt.ColorGradingTextureEnabled=e}static get FresnelEnabled(){return rt.FresnelEnabled}static set FresnelEnabled(e){rt.FresnelEnabled=e}};Z.ForceGLSL=!1;w([Gn("diffuseTexture")],Z.prototype,"_diffuseTexture",void 0);w([Re("_markAllSubMeshesAsTexturesAndMiscDirty")],Z.prototype,"diffuseTexture",void 0);w([Gn("ambientTexture")],Z.prototype,"_ambientTexture",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],Z.prototype,"ambientTexture",void 0);w([Gn("opacityTexture")],Z.prototype,"_opacityTexture",void 0);w([Re("_markAllSubMeshesAsTexturesAndMiscDirty")],Z.prototype,"opacityTexture",void 0);w([Gn("reflectionTexture")],Z.prototype,"_reflectionTexture",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],Z.prototype,"reflectionTexture",void 0);w([Gn("emissiveTexture")],Z.prototype,"_emissiveTexture",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],Z.prototype,"emissiveTexture",void 0);w([Gn("specularTexture")],Z.prototype,"_specularTexture",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],Z.prototype,"specularTexture",void 0);w([Gn("bumpTexture")],Z.prototype,"_bumpTexture",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],Z.prototype,"bumpTexture",void 0);w([Gn("lightmapTexture")],Z.prototype,"_lightmapTexture",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],Z.prototype,"lightmapTexture",void 0);w([Gn("refractionTexture")],Z.prototype,"_refractionTexture",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],Z.prototype,"refractionTexture",void 0);w([pi("ambient")],Z.prototype,"ambientColor",void 0);w([pi("diffuse")],Z.prototype,"diffuseColor",void 0);w([pi("specular")],Z.prototype,"specularColor",void 0);w([pi("emissive")],Z.prototype,"emissiveColor",void 0);w([L()],Z.prototype,"specularPower",void 0);w([L("useAlphaFromDiffuseTexture")],Z.prototype,"_useAlphaFromDiffuseTexture",void 0);w([Re("_markAllSubMeshesAsTexturesAndMiscDirty")],Z.prototype,"useAlphaFromDiffuseTexture",void 0);w([L("useEmissiveAsIllumination")],Z.prototype,"_useEmissiveAsIllumination",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],Z.prototype,"useEmissiveAsIllumination",void 0);w([L("linkEmissiveWithDiffuse")],Z.prototype,"_linkEmissiveWithDiffuse",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],Z.prototype,"linkEmissiveWithDiffuse",void 0);w([L("useSpecularOverAlpha")],Z.prototype,"_useSpecularOverAlpha",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],Z.prototype,"useSpecularOverAlpha",void 0);w([L("useReflectionOverAlpha")],Z.prototype,"_useReflectionOverAlpha",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],Z.prototype,"useReflectionOverAlpha",void 0);w([L("disableLighting")],Z.prototype,"_disableLighting",void 0);w([Re("_markAllSubMeshesAsLightsDirty")],Z.prototype,"disableLighting",void 0);w([L("useObjectSpaceNormalMap")],Z.prototype,"_useObjectSpaceNormalMap",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],Z.prototype,"useObjectSpaceNormalMap",void 0);w([L("useParallax")],Z.prototype,"_useParallax",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],Z.prototype,"useParallax",void 0);w([L("useParallaxOcclusion")],Z.prototype,"_useParallaxOcclusion",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],Z.prototype,"useParallaxOcclusion",void 0);w([L()],Z.prototype,"parallaxScaleBias",void 0);w([L("roughness")],Z.prototype,"_roughness",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],Z.prototype,"roughness",void 0);w([L()],Z.prototype,"indexOfRefraction",void 0);w([L()],Z.prototype,"invertRefractionY",void 0);w([L()],Z.prototype,"alphaCutOff",void 0);w([L("useLightmapAsShadowmap")],Z.prototype,"_useLightmapAsShadowmap",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],Z.prototype,"useLightmapAsShadowmap",void 0);w([va("diffuseFresnelParameters")],Z.prototype,"_diffuseFresnelParameters",void 0);w([Re("_markAllSubMeshesAsFresnelDirty")],Z.prototype,"diffuseFresnelParameters",void 0);w([va("opacityFresnelParameters")],Z.prototype,"_opacityFresnelParameters",void 0);w([Re("_markAllSubMeshesAsFresnelAndMiscDirty")],Z.prototype,"opacityFresnelParameters",void 0);w([va("reflectionFresnelParameters")],Z.prototype,"_reflectionFresnelParameters",void 0);w([Re("_markAllSubMeshesAsFresnelDirty")],Z.prototype,"reflectionFresnelParameters",void 0);w([va("refractionFresnelParameters")],Z.prototype,"_refractionFresnelParameters",void 0);w([Re("_markAllSubMeshesAsFresnelDirty")],Z.prototype,"refractionFresnelParameters",void 0);w([va("emissiveFresnelParameters")],Z.prototype,"_emissiveFresnelParameters",void 0);w([Re("_markAllSubMeshesAsFresnelDirty")],Z.prototype,"emissiveFresnelParameters",void 0);w([L("useReflectionFresnelFromSpecular")],Z.prototype,"_useReflectionFresnelFromSpecular",void 0);w([Re("_markAllSubMeshesAsFresnelDirty")],Z.prototype,"useReflectionFresnelFromSpecular",void 0);w([L("useGlossinessFromSpecularMapAlpha")],Z.prototype,"_useGlossinessFromSpecularMapAlpha",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],Z.prototype,"useGlossinessFromSpecularMapAlpha",void 0);w([L("maxSimultaneousLights")],Z.prototype,"_maxSimultaneousLights",void 0);w([Re("_markAllSubMeshesAsLightsDirty")],Z.prototype,"maxSimultaneousLights",void 0);w([L("invertNormalMapX")],Z.prototype,"_invertNormalMapX",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],Z.prototype,"invertNormalMapX",void 0);w([L("invertNormalMapY")],Z.prototype,"_invertNormalMapY",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],Z.prototype,"invertNormalMapY",void 0);w([L("twoSidedLighting")],Z.prototype,"_twoSidedLighting",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],Z.prototype,"twoSidedLighting",void 0);w([L("applyDecalMapAfterDetailMap")],Z.prototype,"_applyDecalMapAfterDetailMap",void 0);w([Re("_markAllSubMeshesAsMiscDirty")],Z.prototype,"applyDecalMapAfterDetailMap",void 0);ue("BABYLON.StandardMaterial",Z);Pe.DefaultMaterialFactory=i=>new Z("default material",i);var vb={effect:null,subMesh:null},Wi=class i extends _r{constructor(e,t,n,r={},s=!0){super(e,t,s),this._textures={},this._internalTextures={},this._textureArrays={},this._externalTextures={},this._floats={},this._ints={},this._uints={},this._floatsArrays={},this._colors3={},this._colors3Arrays={},this._colors4={},this._colors4Arrays={},this._vectors2={},this._vectors3={},this._vectors4={},this._quaternions={},this._quaternionsArrays={},this._matrices={},this._matrixArrays={},this._matrices3x3={},this._matrices2x2={},this._vectors2Arrays={},this._vectors3Arrays={},this._vectors4Arrays={},this._uniformBuffers={},this._textureSamplers={},this._storageBuffers={},this._cachedWorldViewMatrix=new V,this._cachedWorldViewProjectionMatrix=new V,this._multiview=!1,this._materialHelperNeedsPreviousMatrices=!1,this._shaderPath=n,this._options=K({needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1},r)}get shaderPath(){return this._shaderPath}set shaderPath(e){this._shaderPath=e}get options(){return this._options}get isMultiview(){return this._multiview}getClassName(){return"ShaderMaterial"}needAlphaBlending(){return this.alpha<1||this._options.needAlphaBlending}needAlphaTesting(){return this._options.needAlphaTesting}_checkUniform(e){this._options.uniforms.indexOf(e)===-1&&this._options.uniforms.push(e)}setTexture(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._textures[e]=t,this}setInternalTexture(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._internalTextures[e]=t,this}removeTexture(e){delete this._textures[e]}setTextureArray(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=t,this}setExternalTexture(e,t){return this._options.externalTextures.indexOf(e)===-1&&this._options.externalTextures.push(e),this._externalTextures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setUInt(e,t){return this._checkUniform(e),this._uints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor3Array(e,t){return this._checkUniform(e),this._colors3Arrays[e]=t.reduce((n,r)=>(n.push(r.r,r.g,r.b),n),[]),this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setColor4Array(e,t){return this._checkUniform(e),this._colors4Arrays[e]=t.reduce((n,r)=>(n.push(r.r,r.g,r.b,r.a),n),[]),this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setQuaternion(e,t){return this._checkUniform(e),this._quaternions[e]=t,this}setQuaternionArray(e,t){return this._checkUniform(e),this._quaternionsArrays[e]=t.reduce((n,r)=>(r.toArray(n,n.length),n),[]),this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}setMatrices(e,t){this._checkUniform(e);let n=new Float32Array(t.length*16);for(let r=0;r<t.length;r++)t[r].copyToArray(n,r*16);return this._matrixArrays[e]=n,this}setMatrix3x3(e,t){return this._checkUniform(e),this._matrices3x3[e]=t,this}setMatrix2x2(e,t){return this._checkUniform(e),this._matrices2x2[e]=t,this}setArray2(e,t){return this._checkUniform(e),this._vectors2Arrays[e]=t,this}setArray3(e,t){return this._checkUniform(e),this._vectors3Arrays[e]=t,this}setArray4(e,t){return this._checkUniform(e),this._vectors4Arrays[e]=t,this}setUniformBuffer(e,t){return this._options.uniformBuffers.indexOf(e)===-1&&this._options.uniformBuffers.push(e),this._uniformBuffers[e]=t,this}setTextureSampler(e,t){return this._options.samplerObjects.indexOf(e)===-1&&this._options.samplerObjects.push(e),this._textureSamplers[e]=t,this}setStorageBuffer(e,t){return this._options.storageBuffers.indexOf(e)===-1&&this._options.storageBuffers.push(e),this._storageBuffers[e]=t,this}setDefine(e,t){let n=e.trimEnd()+" ",r=this.options.defines.findIndex(s=>s===e||s.startsWith(n));return r>=0&&this.options.defines.splice(r,1),(typeof t!="boolean"||t)&&this.options.defines.push(n+t),this}isReadyForSubMesh(e,t,n){return this.isReady(e,n,t)}isReady(e,t,n){let r=n&&this._storeEffectOnSubMeshes;if(this.isFrozen){let x=r?n._drawWrapper:this._drawWrapper;if(x.effect&&x._wasPreviouslyReady&&x._wasPreviouslyUsingInstances===t)return!0}let s=this.getScene(),o=s.getEngine(),a=[],l=[],c=null,u=this._shaderPath,h=this._options.uniforms,d=this._options.uniformBuffers,f=this._options.samplers;o.getCaps().multiview&&s.activeCamera&&s.activeCamera.outputRenderTarget&&s.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,a.push("#define MULTIVIEW"),h.indexOf("viewProjection")!==-1&&h.indexOf("viewProjectionR")===-1&&h.push("viewProjectionR"));for(let x=0;x<this._options.defines.length;x++){let b=this._options.defines[x].indexOf("#define")===0?this._options.defines[x]:`#define ${this._options.defines[x]}`;a.push(b)}for(let x=0;x<this._options.attributes.length;x++)l.push(this._options.attributes[x]);if(e&&e.isVerticesDataPresent(S.ColorKind)&&(l.indexOf(S.ColorKind)===-1&&l.push(S.ColorKind),a.push("#define VERTEXCOLOR")),t&&(a.push("#define INSTANCES"),vh(l,this._materialHelperNeedsPreviousMatrices),e?.hasThinInstances&&(a.push("#define THIN_INSTANCES"),e&&e.isVerticesDataPresent(S.ColorInstanceKind)&&(l.push(S.ColorInstanceKind),a.push("#define INSTANCESCOLOR")))),e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){l.push(S.MatricesIndicesKind),l.push(S.MatricesWeightsKind),e.numBoneInfluencers>4&&(l.push(S.MatricesIndicesExtraKind),l.push(S.MatricesWeightsExtraKind));let x=e.skeleton;a.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),c=new fr,c.addCPUSkinningFallback(0,e),x.isUsingTextureForMatrices?(a.push("#define BONETEXTURE"),h.indexOf("boneTextureWidth")===-1&&h.push("boneTextureWidth"),this._options.samplers.indexOf("boneSampler")===-1&&this._options.samplers.push("boneSampler")):(a.push("#define BonesPerMesh "+(x.bones.length+1)),h.indexOf("mBones")===-1&&h.push("mBones"))}else a.push("#define NUM_BONE_INFLUENCERS 0");let p=0,g=e?e.morphTargetManager:null;if(g){let x=a.indexOf("#define UV1")!==-1,b=a.indexOf("#define UV2")!==-1,D=a.indexOf("#define TANGENT")!==-1,M=a.indexOf("#define NORMAL")!==-1,R=a.indexOf("#define VERTEXCOLOR")!==-1;p=yh(g,a,l,e,!0,M,D,x,b,R),g.isUsingTextureForTargets&&(h.indexOf("morphTargetTextureIndices")===-1&&h.push("morphTargetTextureIndices"),this._options.samplers.indexOf("morphTargets")===-1&&this._options.samplers.push("morphTargets")),p>0&&(h=h.slice(),h.push("morphTargetInfluences"),h.push("morphTargetCount"),h.push("morphTargetTextureInfo"),h.push("morphTargetTextureIndices"))}else a.push("#define NUM_MORPH_INFLUENCERS 0");if(e){let x=e.bakedVertexAnimationManager;x&&x.isEnabled&&(a.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),h.indexOf("bakedVertexAnimationSettings")===-1&&h.push("bakedVertexAnimationSettings"),h.indexOf("bakedVertexAnimationTextureSizeInverted")===-1&&h.push("bakedVertexAnimationTextureSizeInverted"),h.indexOf("bakedVertexAnimationTime")===-1&&h.push("bakedVertexAnimationTime"),this._options.samplers.indexOf("bakedVertexAnimationTexture")===-1&&this._options.samplers.push("bakedVertexAnimationTexture"),t&&l.push("bakedVertexAnimationSettingsInstanced"))}for(let x in this._textures)if(!this._textures[x].isReady())return!1;for(let x in this._internalTextures)if(!this._internalTextures[x].isReady)return!1;e&&this.needAlphaTestingForMesh(e)&&a.push("#define ALPHATEST"),this._options.useClipPlane!==!1&&(Zn(h),xs(this,s,a)),s.fogEnabled&&e?.applyFog&&s.fogMode!==Pe.FOGMODE_NONE&&(a.push("#define FOG"),h.indexOf("view")===-1&&h.push("view"),h.indexOf("vFogInfos")===-1&&h.push("vFogInfos"),h.indexOf("vFogColor")===-1&&h.push("vFogColor")),this._useLogarithmicDepth&&(a.push("#define LOGARITHMICDEPTH"),h.indexOf("logarithmicDepthConstant")===-1&&h.push("logarithmicDepthConstant")),this.customShaderNameResolve&&(h=h.slice(),d=d.slice(),f=f.slice(),u=this.customShaderNameResolve(this.name,h,d,f,a,l));let _=n?n.getRenderingMesh():e;if(_&&this.useVertexPulling){a.push("#define USE_VERTEX_PULLING");let x=_.geometry?.getIndexBuffer();x&&(a.push("#define VERTEX_PULLING_USE_INDEX_BUFFER"),x.is32Bits&&a.push("#define VERTEX_PULLING_INDEX_BUFFER_32BITS"))}let y=r?n._getDrawWrapper(void 0,!0):this._drawWrapper,C=y?.effect??null,E=y?.defines??null,I=a.join(`
`),v=C;return E!==I&&(v=o.createEffect(u,{attributes:l,uniformsNames:h,uniformBuffersNames:d,samplers:f,defines:I,fallbacks:c,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:p},shaderLanguage:this._options.shaderLanguage,extraInitializationsAsync:this._options.extraInitializationsAsync},o),r?n.setEffect(v,I,this._materialContext):y&&y.setEffect(v,I),this._onEffectCreatedObservable&&(vb.effect=v,vb.subMesh=n??e?.subMeshes[0]??null,this._onEffectCreatedObservable.notifyObservers(vb))),y._wasPreviouslyUsingInstances=!!t,v?.isReady()?(C!==v&&s.resetCachedMaterial(),y._wasPreviouslyReady=!0,!0):!1}bindOnlyWorldMatrix(e,t){let n=t??this.getEffect();if(!n)return;let r=this._options.uniforms;r.indexOf("world")!==-1&&n.setMatrix("world",e);let s=this.getScene();r.indexOf("worldView")!==-1&&(e.multiplyToRef(s.getViewMatrix(),this._cachedWorldViewMatrix),n.setMatrix("worldView",this._cachedWorldViewMatrix)),r.indexOf("worldViewProjection")!==-1&&(e.multiplyToRef(s.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),n.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)),r.indexOf("view")!==-1&&n.setMatrix("view",s.getViewMatrix())}bindForSubMesh(e,t,n){this.bind(e,t,n._drawWrapperOverride?.effect,n)}bind(e,t,n,r){let s=r&&this._storeEffectOnSubMeshes,o=n??(s?r.effect:this.getEffect());if(!o)return;let a=this.getScene();this._activeEffect=o,this.bindOnlyWorldMatrix(e,n);let l=this._options.uniformBuffers,c=!1;if(o&&l&&l.length>0&&a.getEngine().supportsUniformBuffers)for(let h=0;h<l.length;++h)switch(l[h]){case"Mesh":t&&(t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e));break;case"Scene":IT(o,a.getSceneUniformBuffer()),a.finalizeSceneUbo(),c=!0;break}let u=t&&s?this._mustRebind(a,o,r,t.visibility):a.getCachedMaterial()!==this;if(o&&u){!c&&this._options.uniforms.indexOf("view")!==-1&&o.setMatrix("view",a.getViewMatrix()),!c&&this._options.uniforms.indexOf("projection")!==-1&&o.setMatrix("projection",a.getProjectionMatrix()),!c&&this._options.uniforms.indexOf("viewProjection")!==-1&&(o.setMatrix("viewProjection",a.getTransformMatrix()),this._multiview&&o.setMatrix("viewProjectionR",a._transformMatrixR)),a.activeCamera&&this._options.uniforms.indexOf("cameraPosition")!==-1&&o.setVector3("cameraPosition",a.activeCamera.globalPosition),Ia(t,o),Qn(o,this,a),this._useLogarithmicDepth&&Jn(s?r.materialDefines:o.defines,o,a),t&&Ni(a,t,o);let h;for(h in this._textures)o.setTexture(h,this._textures[h]);for(h in this._internalTextures)o._bindTexture(h,this._internalTextures[h]);for(h in this._textureArrays)o.setTextureArray(h,this._textureArrays[h]);for(h in this._ints)o.setInt(h,this._ints[h]);for(h in this._uints)o.setUInt(h,this._uints[h]);for(h in this._floats)o.setFloat(h,this._floats[h]);for(h in this._floatsArrays)o.setArray(h,this._floatsArrays[h]);for(h in this._colors3)o.setColor3(h,this._colors3[h]);for(h in this._colors3Arrays)o.setArray3(h,this._colors3Arrays[h]);for(h in this._colors4){let _=this._colors4[h];o.setFloat4(h,_.r,_.g,_.b,_.a)}for(h in this._colors4Arrays)o.setArray4(h,this._colors4Arrays[h]);for(h in this._vectors2)o.setVector2(h,this._vectors2[h]);for(h in this._vectors3)o.setVector3(h,this._vectors3[h]);for(h in this._vectors4)o.setVector4(h,this._vectors4[h]);for(h in this._quaternions)o.setQuaternion(h,this._quaternions[h]);for(h in this._matrices)o.setMatrix(h,this._matrices[h]);for(h in this._matrixArrays)o.setMatrices(h,this._matrixArrays[h]);for(h in this._matrices3x3)o.setMatrix3x3(h,this._matrices3x3[h]);for(h in this._matrices2x2)o.setMatrix2x2(h,this._matrices2x2[h]);for(h in this._vectors2Arrays)o.setArray2(h,this._vectors2Arrays[h]);for(h in this._vectors3Arrays)o.setArray3(h,this._vectors3Arrays[h]);for(h in this._vectors4Arrays)o.setArray4(h,this._vectors4Arrays[h]);for(h in this._quaternionsArrays)o.setArray4(h,this._quaternionsArrays[h]);for(h in this._uniformBuffers){let _=this._uniformBuffers[h].getBuffer();_&&o.bindUniformBuffer(_,h)}let d=a.getEngine(),f=d.setExternalTexture;if(f)for(h in this._externalTextures)f.call(d,h,this._externalTextures[h]);let p=d.setTextureSampler;if(p)for(h in this._textureSamplers)p.call(d,h,this._textureSamplers[h]);let g=d.setStorageBuffer;if(g)for(h in this._storageBuffers)g.call(d,h,this._storageBuffers[h])}if(o&&t&&(u||!this.isFrozen)){Sa(t,o),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(o);let h=t.bakedVertexAnimationManager;if(h&&h.isEnabled){let d=s?r._drawWrapper:this._drawWrapper;t.bakedVertexAnimationManager?.bind(o,!!d._wasPreviouslyUsingInstances)}}this._afterBind(t,o,r)}getActiveTextures(){let e=super.getActiveTextures();for(let t in this._textures)e.push(this._textures[t]);for(let t in this._textureArrays){let n=this._textureArrays[t];for(let r=0;r<n.length;r++)e.push(n[r])}return e}hasTexture(e){if(super.hasTexture(e))return!0;for(let n in this._textures)if(this._textures[n]===e)return!0;let t=e.getInternalTexture();for(let n in this._internalTextures)if(this._internalTextures[n]===t)return!0;for(let n in this._textureArrays){let r=this._textureArrays[n];for(let s=0;s<r.length;s++)if(r[s]===e)return!0}return!1}clone(e){let t=Xe.Clone(()=>new i(e,this.getScene(),this._shaderPath,this._options,this._storeEffectOnSubMeshes),this);t.name=e,t.id=e,typeof t._shaderPath=="object"&&(t._shaderPath=K({},t._shaderPath)),this._options=K({},this._options);let n=Object.keys(this._options);for(let r of n){let s=this._options[r];Array.isArray(s)&&(this._options[r]=s.slice(0))}this.stencil.copyTo(t.stencil);for(let r in this._textures)t.setTexture(r,this._textures[r]);for(let r in this._internalTextures)t.setInternalTexture(r,this._internalTextures[r]);for(let r in this._textureArrays)t.setTextureArray(r,this._textureArrays[r]);for(let r in this._externalTextures)t.setExternalTexture(r,this._externalTextures[r]);for(let r in this._ints)t.setInt(r,this._ints[r]);for(let r in this._uints)t.setUInt(r,this._uints[r]);for(let r in this._floats)t.setFloat(r,this._floats[r]);for(let r in this._floatsArrays)t.setFloats(r,this._floatsArrays[r]);for(let r in this._colors3)t.setColor3(r,this._colors3[r]);for(let r in this._colors3Arrays)t._colors3Arrays[r]=this._colors3Arrays[r];for(let r in this._colors4)t.setColor4(r,this._colors4[r]);for(let r in this._colors4Arrays)t._colors4Arrays[r]=this._colors4Arrays[r];for(let r in this._vectors2)t.setVector2(r,this._vectors2[r]);for(let r in this._vectors3)t.setVector3(r,this._vectors3[r]);for(let r in this._vectors4)t.setVector4(r,this._vectors4[r]);for(let r in this._quaternions)t.setQuaternion(r,this._quaternions[r]);for(let r in this._quaternionsArrays)t._quaternionsArrays[r]=this._quaternionsArrays[r];for(let r in this._matrices)t.setMatrix(r,this._matrices[r]);for(let r in this._matrixArrays)t._matrixArrays[r]=this._matrixArrays[r].slice();for(let r in this._matrices3x3)t.setMatrix3x3(r,this._matrices3x3[r]);for(let r in this._matrices2x2)t.setMatrix2x2(r,this._matrices2x2[r]);for(let r in this._vectors2Arrays)t.setArray2(r,this._vectors2Arrays[r]);for(let r in this._vectors3Arrays)t.setArray3(r,this._vectors3Arrays[r]);for(let r in this._vectors4Arrays)t.setArray4(r,this._vectors4Arrays[r]);for(let r in this._uniformBuffers)t.setUniformBuffer(r,this._uniformBuffers[r]);for(let r in this._textureSamplers)t.setTextureSampler(r,this._textureSamplers[r]);for(let r in this._storageBuffers)t.setStorageBuffer(r,this._storageBuffers[r]);return t}dispose(e,t,n){if(t){let r;for(r in this._textures)this._textures[r].dispose();for(r in this._internalTextures)this._internalTextures[r].dispose();for(r in this._textureArrays){let s=this._textureArrays[r];for(let o=0;o<s.length;o++)s[o].dispose()}}this._textures={},this._internalTextures={},super.dispose(e,t,n)}serialize(){let e=Xe.Serialize(this);e.customType="BABYLON.ShaderMaterial",e.uniqueId=this.uniqueId,e.options=this._options,e.shaderPath=this._shaderPath,e.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes;let t;e.stencil=this.stencil.serialize(),e.textures={};for(t in this._textures)e.textures[t]=this._textures[t].serialize();e.textureArrays={};for(t in this._textureArrays){e.textureArrays[t]=[];let n=this._textureArrays[t];for(let r=0;r<n.length;r++)e.textureArrays[t].push(n[r].serialize())}e.ints={};for(t in this._ints)e.ints[t]=this._ints[t];e.uints={};for(t in this._uints)e.uints[t]=this._uints[t];e.floats={};for(t in this._floats)e.floats[t]=this._floats[t];e.floatsArrays={};for(t in this._floatsArrays)e.floatsArrays[t]=this._floatsArrays[t];e.colors3={};for(t in this._colors3){let n=this._colors3[t];e.colors3[t]=[n.r,n.g,n.b]}e.colors3Arrays={};for(t in this._colors3Arrays)e.colors3Arrays[t]=this._colors3Arrays[t];e.colors4={};for(t in this._colors4){let n=this._colors4[t];e.colors4[t]=[n.r,n.g,n.b,n.a]}e.colors4Arrays={};for(t in this._colors4Arrays)e.colors4Arrays[t]=this._colors4Arrays[t];e.vectors2={};for(t in this._vectors2){let n=this._vectors2[t];e.vectors2[t]=[n.x,n.y]}e.vectors3={};for(t in this._vectors3){let n=this._vectors3[t];e.vectors3[t]=[n.x,n.y,n.z]}e.vectors4={};for(t in this._vectors4){let n=this._vectors4[t];e.vectors4[t]=[n.x,n.y,n.z,n.w]}e.quaternions={};for(t in this._quaternions)e.quaternions[t]=this._quaternions[t].asArray();e.matrices={};for(t in this._matrices)e.matrices[t]=this._matrices[t].asArray();e.matrixArray={};for(t in this._matrixArrays)e.matrixArray[t]=this._matrixArrays[t];e.matrices3x3={};for(t in this._matrices3x3)e.matrices3x3[t]=this._matrices3x3[t];e.matrices2x2={};for(t in this._matrices2x2)e.matrices2x2[t]=this._matrices2x2[t];e.vectors2Arrays={};for(t in this._vectors2Arrays)e.vectors2Arrays[t]=this._vectors2Arrays[t];e.vectors3Arrays={};for(t in this._vectors3Arrays)e.vectors3Arrays[t]=this._vectors3Arrays[t];e.vectors4Arrays={};for(t in this._vectors4Arrays)e.vectors4Arrays[t]=this._vectors4Arrays[t];e.quaternionsArrays={};for(t in this._quaternionsArrays)e.quaternionsArrays[t]=this._quaternionsArrays[t];return e}static Parse(e,t,n){let r=Xe.Parse(()=>new i(e.name,t,e.shaderPath,e.options,e.storeEffectOnSubMeshes),e,t,n),s;e.stencil&&r.stencil.parse(e.stencil,t,n);for(s in e.textures)r.setTexture(s,te.Parse(e.textures[s],t,n));for(s in e.textureArrays){let o=e.textureArrays[s],a=[];for(let l=0;l<o.length;l++)a.push(te.Parse(o[l],t,n));r.setTextureArray(s,a)}for(s in e.ints)r.setInt(s,e.ints[s]);for(s in e.uints)r.setUInt(s,e.uints[s]);for(s in e.floats)r.setFloat(s,e.floats[s]);for(s in e.floatsArrays)r.setFloats(s,e.floatsArrays[s]);for(s in e.colors3){let o=e.colors3[s];r.setColor3(s,{r:o[0],g:o[1],b:o[2]})}for(s in e.colors3Arrays){let o=e.colors3Arrays[s].reduce((a,l,c)=>(c%3===0?a.push([l]):a[a.length-1].push(l),a),[]).map(a=>({r:a[0],g:a[1],b:a[2]}));r.setColor3Array(s,o)}for(s in e.colors4){let o=e.colors4[s];r.setColor4(s,{r:o[0],g:o[1],b:o[2],a:o[3]})}for(s in e.colors4Arrays){let o=e.colors4Arrays[s].reduce((a,l,c)=>(c%4===0?a.push([l]):a[a.length-1].push(l),a),[]).map(a=>({r:a[0],g:a[1],b:a[2],a:a[3]}));r.setColor4Array(s,o)}for(s in e.vectors2){let o=e.vectors2[s];r.setVector2(s,{x:o[0],y:o[1]})}for(s in e.vectors3){let o=e.vectors3[s];r.setVector3(s,{x:o[0],y:o[1],z:o[2]})}for(s in e.vectors4){let o=e.vectors4[s];r.setVector4(s,{x:o[0],y:o[1],z:o[2],w:o[3]})}for(s in e.quaternions)r.setQuaternion(s,J.FromArray(e.quaternions[s]));for(s in e.matrices)r.setMatrix(s,V.FromArray(e.matrices[s]));for(s in e.matrixArray)r._matrixArrays[s]=new Float32Array(e.matrixArray[s]);for(s in e.matrices3x3)r.setMatrix3x3(s,e.matrices3x3[s]);for(s in e.matrices2x2)r.setMatrix2x2(s,e.matrices2x2[s]);for(s in e.vectors2Arrays)r.setArray2(s,e.vectors2Arrays[s]);for(s in e.vectors3Arrays)r.setArray3(s,e.vectors3Arrays[s]);for(s in e.vectors4Arrays)r.setArray4(s,e.vectors4Arrays[s]);for(s in e.quaternionsArrays)r.setArray4(s,e.quaternionsArrays[s]);return r}static ParseFromFileAsync(e,t,n,r=""){return T(this,null,function*(){return yield new Promise((s,o)=>{let a=new to;a.addEventListener("readystatechange",()=>{if(a.readyState==4)if(a.status==200){let l=JSON.parse(a.responseText),c=this.Parse(l,n||Ie.LastCreatedScene,r);e&&(c.name=e),s(c)}else o("Unable to load the ShaderMaterial")}),a.open("GET",t),a.send()})})}static ParseFromSnippetAsync(e,t,n=""){return T(this,null,function*(){return yield new Promise((r,s)=>{let o=new to;o.addEventListener("readystatechange",()=>{if(o.readyState==4)if(o.status==200){let a=JSON.parse(JSON.parse(o.responseText).jsonPayload),l=JSON.parse(a.shaderMaterial),c=this.Parse(l,t||Ie.LastCreatedScene,n);c.snippetId=e,r(c)}else s("Unable to load the snippet "+e)}),o.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),o.send()})})}};Wi.SnippetUrl="https://snippet.babylonjs.com";Wi.CreateFromSnippetAsync=Wi.ParseFromSnippetAsync;ue("BABYLON.ShaderMaterial",Wi);kt.AddNodeConstructor("Light_Type_3",(i,e)=>()=>new Pn(i,m.Zero(),e));var Pn=class extends an{constructor(e,t,n){super(e,n),this.groundColor=new G(0,0,0),this.direction=t||m.Up()}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(e){return this.direction=m.Normalize(e.subtract(m.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(e,t){let n=m.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",n.x,n.y,n.z,0,t),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),t),this}transferToNodeMaterialEffect(e,t){let n=m.Normalize(this.direction);return e.setFloat3(t,n.x,n.y,n.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=V.Identity()),this._worldMatrix}getTypeID(){return an.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(e,t){e["HEMILIGHT"+t]=!0}};w([pi()],Pn.prototype,"groundColor",void 0);w([yn()],Pn.prototype,"direction",void 0);ue("BABYLON.HemisphericLight",Pn);kt.AddNodeConstructor("Light_Type_0",(i,e)=>()=>new Ii(i,m.Zero(),e));var Ii=class extends DT{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){let t=this.needCube();if(this._direction=e,this.needCube()!==t&&this._shadowGenerators){let n=this._shadowGenerators.values();for(let r=n.next();r.done!==!0;r=n.next())r.value.recreateShadowMap()}}constructor(e,t,n){super(e,n),this._shadowAngle=Math.PI/2,this.position=t}getClassName(){return"PointLight"}getTypeID(){return an.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new m(1,0,0);case 1:return new m(-1,0,0);case 2:return new m(0,-1,0);case 3:return new m(0,1,0);case 4:return new m(0,0,1);case 5:return new m(0,0,-1)}return m.Zero()}_setDefaultShadowProjectionMatrix(e,t,n){let r=this.getScene().activeCamera,s=this.getDepthMinZ(r),o=this.getDepthMaxZ(r),a=this.getScene().getEngine().useReverseDepthBuffer;V.PerspectiveFovLHToRef(this.shadowAngle,1,a?o:s,a?s:o,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,a)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){let n=this._scene.floatingOriginOffset;return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x-n.x,this.transformedPosition.y-n.y,this.transformedPosition.z-n.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x-n.x,this.position.y-n.y,this.position.z-n.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){let n=this._scene.floatingOriginOffset;return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x-n.x,this.transformedPosition.y-n.y,this.transformedPosition.z-n.z):e.setFloat3(t,this.position.x-n.x,this.position.y-n.y,this.position.z-n.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=!0}};w([L()],Ii.prototype,"shadowAngle",null);ue("BABYLON.PointLight",Ii);var On=(()=>{class i{static SetMatrix(t,n,r,s,o){let a=null;if(r.semantic==="MODEL"?a=n.getWorldMatrix():r.semantic==="PROJECTION"?a=t.getProjectionMatrix():r.semantic==="VIEW"?a=t.getViewMatrix():r.semantic==="MODELVIEWINVERSETRANSPOSE"?a=V.Transpose(n.getWorldMatrix().multiply(t.getViewMatrix()).invert()):r.semantic==="MODELVIEW"?a=n.getWorldMatrix().multiply(t.getViewMatrix()):r.semantic==="MODELVIEWPROJECTION"?a=n.getWorldMatrix().multiply(t.getTransformMatrix()):r.semantic==="MODELINVERSE"?a=n.getWorldMatrix().invert():r.semantic==="VIEWINVERSE"?a=t.getViewMatrix().invert():r.semantic==="PROJECTIONINVERSE"?a=t.getProjectionMatrix().invert():r.semantic==="MODELVIEWINVERSE"?a=n.getWorldMatrix().multiply(t.getViewMatrix()).invert():r.semantic==="MODELVIEWPROJECTIONINVERSE"?a=n.getWorldMatrix().multiply(t.getTransformMatrix()).invert():r.semantic==="MODELINVERSETRANSPOSE"&&(a=V.Transpose(n.getWorldMatrix().invert())),a)switch(r.type){case Dn.FLOAT_MAT2:o.setMatrix2x2(s,V.GetAsMatrix2x2(a));break;case Dn.FLOAT_MAT3:o.setMatrix3x3(s,V.GetAsMatrix3x3(a));break;case Dn.FLOAT_MAT4:o.setMatrix(s,a);break;default:break}}static SetUniform(t,n,r,s){switch(s){case Dn.FLOAT:return t.setFloat(n,r),!0;case Dn.FLOAT_VEC2:return t.setVector2(n,_e.FromArray(r)),!0;case Dn.FLOAT_VEC3:return t.setVector3(n,m.FromArray(r)),!0;case Dn.FLOAT_VEC4:return t.setVector4(n,ht.FromArray(r)),!0;default:return!1}}static GetWrapMode(t){switch(t){case Pu.CLAMP_TO_EDGE:return te.CLAMP_ADDRESSMODE;case Pu.MIRRORED_REPEAT:return te.MIRROR_ADDRESSMODE;case Pu.REPEAT:return te.WRAP_ADDRESSMODE;default:return te.WRAP_ADDRESSMODE}}static GetByteStrideFromType(t){switch(t.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}}static GetTextureFilterMode(t){switch(t){case $i.LINEAR:case $i.LINEAR_MIPMAP_NEAREST:case $i.LINEAR_MIPMAP_LINEAR:return te.TRILINEAR_SAMPLINGMODE;case $i.NEAREST:case $i.NEAREST_MIPMAP_NEAREST:return te.NEAREST_SAMPLINGMODE;default:return te.BILINEAR_SAMPLINGMODE}}static GetBufferFromBufferView(t,n,r,s,o){r=n.byteOffset+r;let a=t.loadedBufferViews[n.buffer];if(r+s>a.byteLength)throw new Error("Buffer access is out of range");let l=a.buffer;switch(r+=a.byteOffset,o){case ds.BYTE:return new Int8Array(l,r,s);case ds.UNSIGNED_BYTE:return new Uint8Array(l,r,s);case ds.SHORT:return new Int16Array(l,r,s);case ds.UNSIGNED_SHORT:return new Uint16Array(l,r,s);default:return new Float32Array(l,r,s)}}static GetBufferFromAccessor(t,n){let r=t.bufferViews[n.bufferView],s=n.count*i.GetByteStrideFromType(n);return i.GetBufferFromBufferView(t,r,n.byteOffset,s,n.componentType)}static DecodeBufferToText(t){let n="",r=t.byteLength;for(let s=0;s<r;++s)n+=String.fromCharCode(t[s]);return n}static GetDefaultMaterial(t){if(!i._DefaultMaterial){Ft.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join(`
`),Ft.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join(`
`);let n={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},r={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};i._DefaultMaterial=new Wi("GLTFDefaultMaterial",t,n,r),i._DefaultMaterial.setColor4("u_emission",new le(.5,.5,.5,1))}return i._DefaultMaterial}}return i._DefaultMaterial=null,i})();var $o=(function(i){return i[i.IDENTIFIER=1]="IDENTIFIER",i[i.UNKNOWN=2]="UNKNOWN",i[i.END_OF_INPUT=3]="END_OF_INPUT",i})($o||{}),vp=class{constructor(e){this._pos=0,this.currentToken=$o.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}getNextToken(){if(this.isEnd())return $o.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=$o.UNKNOWN,this.currentString==="_"||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=$o.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||this.currentString==="_");)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken}peek(){return this._toParse[this._pos]}read(){return this._toParse[this._pos++]}forward(){this._pos++}isEnd(){return this._pos>=this._maxPos}},_w=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],yw=["world","view","projection","worldView","worldViewProjection","mBones"],ak=["translation","rotation","scale"],lk=["position","rotationQuaternion","scaling"],ck=(i,e)=>{for(let t in i){let n=i[t];e.buffers[t]=n,e.buffersCount++}},uk=(i,e)=>{for(let t in i){let n=i[t];e.shaders[t]=n,e.shaderscount++}},Nn=(i,e,t)=>{for(let n in i){let r=i[n];t[e][n]=r}},hk=i=>{if(i)for(let e=0;e<i.length/2;e++)i[e*2+1]=1-i[e*2+1]},dw=i=>{if(i.semantic==="NORMAL")return"normal";if(i.semantic==="POSITION")return"position";if(i.semantic==="JOINT")return"matricesIndices";if(i.semantic==="WEIGHT")return"matricesWeights";if(i.semantic==="COLOR")return"color";if(i.semantic&&i.semantic.indexOf("TEXCOORD_")!==-1){let e=Number(i.semantic.split("_")[1]);return"uv"+(e===0?"":e+1)}return null},dk=i=>{for(let e in i.animations){let t=i.animations[e];if(!t.channels||!t.samplers)continue;let n=null;for(let r=0;r<t.channels.length;r++){let s=t.channels[r],o=t.samplers[s.sampler];if(!o)continue;let a=null,l=null;t.parameters?(a=t.parameters[o.input],l=t.parameters[o.output]):(a=o.input,l=o.output);let c=On.GetBufferFromAccessor(i,i.accessors[a]),u=On.GetBufferFromAccessor(i,i.accessors[l]),h=s.target.id,d=i.scene.getNodeById(h);if(d===null&&(d=i.scene.getNodeByName(h)),d===null){z.Warn("Creating animation named "+e+". But cannot find node named "+h+" to attach to");continue}let f=d instanceof gr,p=s.target.path,g=ak.indexOf(p);g!==-1&&(p=lk[g]);let _=H.ANIMATIONTYPE_MATRIX;f||(p==="rotationQuaternion"?(_=H.ANIMATIONTYPE_QUATERNION,d.rotationQuaternion=new J):_=H.ANIMATIONTYPE_VECTOR3);let y=null,C=[],E=0,I=!1;f&&n&&n.getKeys().length===c.length&&(y=n,I=!0),I||(i.scene._blockEntityCollection=!!i.assetContainer,y=new H(e,f?"_matrix":p,1,_,H.ANIMATIONLOOPMODE_CYCLE),i.scene._blockEntityCollection=!1);for(let v=0;v<c.length;v++){let x=null;if(p==="rotationQuaternion"?(x=J.FromArray([u[E],u[E+1],u[E+2],u[E+3]]),E+=4):(x=m.FromArray([u[E],u[E+1],u[E+2]]),E+=3),f){let b=d,D=m.Zero(),M=new J,R=m.Zero(),W=b.getBaseMatrix();I&&n&&(W=n.getKeys()[v].value),W.decompose(R,M,D),p==="position"?D=x:p==="rotationQuaternion"?M=x:R=x,x=V.Compose(R,M,D)}I?n&&(n.getKeys()[v].value=x):C.push({frame:c[v],value:x})}!I&&y&&(y.setKeys(C),d.animations.push(y)),n=y,i.scene.stopAnimation(d),i.scene.beginAnimation(d,0,c[c.length-1],!0,1)}}},Cb=i=>{let e=null;if(i.translation||i.rotation||i.scale){let t=m.FromArray(i.scale||[1,1,1]),n=J.FromArray(i.rotation||[0,0,0,1]),r=m.FromArray(i.translation||[0,0,0]);e=V.Compose(t,n,r)}else e=V.FromArray(i.matrix);return e},vw=(i,e,t,n)=>{for(let s=0;s<n.bones.length;s++)if(n.bones[s].name===t)return n.bones[s];let r=i.nodes;for(let s in r){let o=r[s];if(!o.jointName)continue;let a=o.children;for(let l=0;l<a.length;l++){let c=i.nodes[a[l]];if(c.jointName&&c.jointName===t){let u=Cb(o),h=new gr(o.name||"",n,vw(i,e,o.jointName,n),u);return h.id=s,h}}}return null},fk=(i,e)=>{for(let t=0;t<i.length;t++){let n=i[t];for(let r=0;r<n.node.children.length;r++)if(n.node.children[r]===e)return n.bone}return null},bb=(i,e)=>{let t=i.nodes,n=t[e];if(n)return{node:n,id:e};for(let r in t)if(n=t[r],n.jointName===e)return{node:n,id:r};return null},pk=(i,e)=>{for(let t=0;t<i.jointNames.length;t++)if(i.jointNames[t]===e)return!0;return!1},mk=(i,e,t,n)=>{for(let r in i.nodes){let s=i.nodes[r],o=r;if(!s.jointName||pk(t,s.jointName))continue;let a=Cb(s),l=new gr(s.name||"",e,null,a);l.id=o,n.push({bone:l,node:s,id:o})}for(let r=0;r<n.length;r++){let s=n[r],o=s.node.children;for(let a=0;a<o.length;a++){let l=null;for(let c=0;c<n.length;c++)if(n[c].id===o[a]){l=n[c];break}l&&(l.bone._parent=s.bone,s.bone.children.push(l.bone))}}},gk=(i,e,t,n)=>{if(n||(n=new Ho(e.name||"","",i.scene)),!e.babylonSkeleton)return n;let r=[],s=[];mk(i,n,e,r),n.bones=[];for(let a=0;a<e.jointNames.length;a++){let l=bb(i,e.jointNames[a]);if(!l)continue;let c=l.node;if(!c){z.Warn("Joint named "+e.jointNames[a]+" does not exist");continue}let u=l.id,h=i.scene.getBoneById(u);if(h){n.bones.push(h);continue}let d=!1,f=null;for(let _=0;_<a;_++){let y=bb(i,e.jointNames[_]);if(!y)continue;let C=y.node;if(!C){z.Warn("Joint named "+e.jointNames[_]+" does not exist when looking for parent");continue}let E=C.children;if(E){d=!1;for(let I=0;I<E.length;I++)if(E[I]===u){f=vw(i,e,e.jointNames[_],n),d=!0;break}if(d)break}}let p=Cb(c);!f&&r.length>0&&(f=fk(r,u),f&&s.indexOf(f)===-1&&s.push(f));let g=new gr(c.jointName||"",n,f,p);g.id=u}let o=n.bones;n.bones=[];for(let a=0;a<e.jointNames.length;a++){let l=bb(i,e.jointNames[a]);if(l){for(let c=0;c<o.length;c++)if(o[c].id===l.id){n.bones.push(o[c]);break}}}n.prepare();for(let a=0;a<s.length;a++)n.bones.push(s[a]);return n},fw=(i,e,t,n,r)=>{if(r||(i.scene._blockEntityCollection=!!i.assetContainer,r=new A(e.name||"",i.scene),r._parentContainer=i.assetContainer,i.scene._blockEntityCollection=!1,r.id=n),!e.babylonNode)return r;let s=[],o=null,a=[],l=[],c=[],u=[];for(let f=0;f<t.length;f++){let p=t[f],g=i.meshes[p];if(g)for(let _=0;_<g.primitives.length;_++){let y=new X,C=g.primitives[_];C.mode;let E=C.attributes,I=null,v=null;for(let b in E)if(I=i.accessors[E[b]],v=On.GetBufferFromAccessor(i,I),b==="NORMAL")y.normals=new Float32Array(v.length),y.normals.set(v);else if(b==="POSITION"){if(Br.HomogeneousCoordinates){y.positions=new Float32Array(v.length-v.length/4);for(let D=0;D<v.length;D+=4)y.positions[D]=v[D],y.positions[D+1]=v[D+1],y.positions[D+2]=v[D+2]}else y.positions=new Float32Array(v.length),y.positions.set(v);l.push(y.positions.length)}else if(b.indexOf("TEXCOORD_")!==-1){let D=Number(b.split("_")[1]),M=S.UVKind+(D===0?"":D+1),R=new Float32Array(v.length);R.set(v),hk(R),y.set(R,M)}else b==="JOINT"?(y.matricesIndices=new Float32Array(v.length),y.matricesIndices.set(v)):b==="WEIGHT"?(y.matricesWeights=new Float32Array(v.length),y.matricesWeights.set(v)):b==="COLOR"&&(y.colors=new Float32Array(v.length),y.colors.set(v));if(I=i.accessors[C.indices],I)v=On.GetBufferFromAccessor(i,I),y.indices=new Int32Array(v.length),y.indices.set(v),u.push(y.indices.length);else{let b=[];for(let D=0;D<y.positions.length/3;D++)b.push(D);y.indices=new Int32Array(b),u.push(y.indices.length)}o?o.merge(y):o=y;let x=i.scene.getMaterialById(C.material);s.push(x===null?On.GetDefaultMaterial(i.scene):x),a.push(a.length===0?0:a[a.length-1]+l[l.length-2]),c.push(c.length===0?0:c[c.length-1]+u[u.length-2])}}let h;i.scene._blockEntityCollection=!!i.assetContainer,s.length>1?(h=new zs("multimat"+n,i.scene),h.subMaterials=s):h=new Z("multimat"+n,i.scene),s.length===1&&(h=s[0]),h._parentContainer=i.assetContainer,r.material||(r.material=h),new jt(n,i.scene,o,!1,r),r.computeWorldMatrix(!0),i.scene._blockEntityCollection=!1,r.subMeshes=[];let d=0;for(let f=0;f<t.length;f++){let p=t[f],g=i.meshes[p];if(g)for(let _=0;_<g.primitives.length;_++)g.primitives[_].mode,ei.AddToMesh(d,a[d],l[d],c[d],u[d],r,r,!0),d++}return r},xb=(i,e,t,n)=>{i.position&&(i.position=e),(i.rotationQuaternion||i.rotation)&&(i.rotationQuaternion=t),i.scaling&&(i.scaling=n)},_k=(i,e)=>{if(e.matrix){let t=new m(0,0,0),n=new J,r=new m(0,0,0);V.FromArray(e.matrix).decompose(r,n,t),xb(i,t,n,r)}else e.translation&&e.rotation&&e.scale&&xb(i,m.FromArray(e.translation),J.FromArray(e.rotation),m.FromArray(e.scale));i.computeWorldMatrix(!0)},yk=(i,e,t)=>{let n=null;if(i.importOnlyMeshes&&(e.skin||e.meshes)&&i.importMeshesNames&&i.importMeshesNames.length>0&&i.importMeshesNames.indexOf(e.name||"")===-1)return null;if(e.skin){if(e.meshes){let r=i.skins[e.skin],s=fw(i,e,e.meshes,t,e.babylonNode);s.skeleton=i.scene.getLastSkeletonById(e.skin),s.skeleton===null&&(s.skeleton=gk(i,r,s,r.babylonSkeleton),r.babylonSkeleton||(r.babylonSkeleton=s.skeleton)),n=s}}else if(e.meshes)n=fw(i,e,e.mesh?[e.mesh]:e.meshes,t,e.babylonNode);else if(e.light&&!e.babylonNode&&!i.importOnlyMeshes){let r=i.lights[e.light];if(r){if(r.type==="ambient"){let s=r[r.type],o=new Pn(e.light,m.Zero(),i.scene);o.name=e.name||"",s.color&&(o.diffuse=G.FromArray(s.color)),n=o}else if(r.type==="directional"){let s=r[r.type],o=new Da(e.light,m.Zero(),i.scene);o.name=e.name||"",s.color&&(o.diffuse=G.FromArray(s.color)),n=o}else if(r.type==="point"){let s=r[r.type],o=new Ii(e.light,m.Zero(),i.scene);o.name=e.name||"",s.color&&(o.diffuse=G.FromArray(s.color)),n=o}else if(r.type==="spot"){let s=r[r.type],o=new Ts(e.light,m.Zero(),m.Zero(),0,0,i.scene);o.name=e.name||"",s.color&&(o.diffuse=G.FromArray(s.color)),s.fallOfAngle&&(o.angle=s.fallOfAngle),s.fallOffExponent&&(o.exponent=s.fallOffExponent),n=o}}}else if(e.camera&&!e.babylonNode&&!i.importOnlyMeshes){let r=i.cameras[e.camera];if(r){if(i.scene._blockEntityCollection=!!i.assetContainer,r.type==="orthographic"){let s=new Ot(e.camera,m.Zero(),i.scene,!1);s.name=e.name||"",s.mode=Ne.ORTHOGRAPHIC_CAMERA,s.attachControl(),n=s,s._parentContainer=i.assetContainer}else if(r.type==="perspective"){let s=r[r.type],o=new Ot(e.camera,m.Zero(),i.scene,!1);o.name=e.name||"",o.attachControl(),s.aspectRatio||(s.aspectRatio=i.scene.getEngine().getRenderWidth()/i.scene.getEngine().getRenderHeight()),s.znear&&s.zfar&&(o.maxZ=s.zfar,o.minZ=s.znear),n=o,o._parentContainer=i.assetContainer}i.scene._blockEntityCollection=!1}}if(!e.jointName){if(e.babylonNode)return e.babylonNode;if(n===null){i.scene._blockEntityCollection=!!i.assetContainer;let r=new A(e.name||"",i.scene);r._parentContainer=i.assetContainer,i.scene._blockEntityCollection=!1,e.babylonNode=r,n=r}}if(n!==null){if(e.matrix&&n instanceof A)_k(n,e);else{let r=e.translation||[0,0,0],s=e.rotation||[0,0,0,1],o=e.scale||[1,1,1];xb(n,m.FromArray(r),J.FromArray(s),m.FromArray(o))}n.updateCache(!0),e.babylonNode=n}return n},Ou=(i,e,t,n=!1)=>{let r=i.nodes[e],s=null;if(i.importOnlyMeshes&&!n&&i.importMeshesNames?i.importMeshesNames.indexOf(r.name||"")!==-1||i.importMeshesNames.length===0?n=!0:n=!1:n=!0,!r.jointName&&n&&(s=yk(i,r,e),s!==null&&(s.id=e,s.parent=t)),r.children)for(let o=0;o<r.children.length;o++)Ou(i,r.children[o],s,n)},pw=i=>{let e=i.currentScene;if(e)for(let t=0;t<e.nodes.length;t++)Ou(i,e.nodes[t],null);else for(let t in i.scenes){e=i.scenes[t];for(let n=0;n<e.nodes.length;n++)Ou(i,e.nodes[n],null)}dk(i);for(let t=0;t<i.scene.skeletons.length;t++){let n=i.scene.skeletons[t];i.scene.beginAnimation(n,0,Number.MAX_VALUE,!0,1)}},vk=(i,e,t,n,r,s,o)=>{let a=s.values||r.parameters;for(let l in t){let c=t[l],u=c.type;if(u===Dn.FLOAT_MAT2||u===Dn.FLOAT_MAT3||u===Dn.FLOAT_MAT4){if(c.semantic&&!c.source&&!c.node)On.SetMatrix(e.scene,i,c,l,n.getEffect());else if(c.semantic&&(c.source||c.node)){let h=e.scene.getNodeByName(c.source||c.node||"");if(h===null&&(h=e.scene.getNodeById(c.source||c.node||"")),h===null)continue;On.SetMatrix(e.scene,h,c,l,n.getEffect())}}else{let h=a[r.uniforms[l]];if(!h)continue;if(u===Dn.SAMPLER_2D){let d=e.textures[s.values?h:c.value].babylonTexture;if(d==null)continue;n.getEffect().setTexture(l,d)}else On.SetUniform(n.getEffect(),l,h,u)}}o(n)},bk=(i,e,t,n,r)=>{let s=n.values||t.parameters,o=t.uniforms;for(let a in r){let l=r[a],c=l.type,u=s[o[a]];if(u===void 0&&(u=l.value),!u)continue;let h=d=>f=>{l.value&&d&&(e.setTexture(d,f),delete r[d])};c===Dn.SAMPLER_2D?Ai.LoadTextureAsync(i,n.values?u:l.value,h(a),()=>h(null)):l.value&&On.SetUniform(e,a,n.values?u:l.value,c)&&delete r[a]}},xk=(i,e,t)=>(n,r)=>{e.dispose(!0),t("Cannot compile program named "+i.name+". Error: "+r+". Default material will be applied")},Ck=(i,e,t,n,r,s)=>o=>{bk(i,e,t,n,r),e.onBind=a=>{vk(a,i,r,e,t,n,s)}},mw=(i,e,t)=>{for(let n in e.uniforms){let r=e.uniforms[n],s=e.parameters[r];if(i.currentIdentifier===n&&s.semantic&&!s.source&&!s.node){let o=_w.indexOf(s.semantic);if(o!==-1)return delete t[n],yw[o]}}return i.currentIdentifier},gw=i=>{for(let e in i.materials)Ai.LoadMaterialAsync(i,e,()=>{},()=>{})},Ei=class{static CreateRuntime(e,t,n){let r={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:t,rootUrl:n,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&Nn(e.extensions,"extensions",r),e.extensionsUsed&&Nn(e.extensionsUsed,"extensionsUsed",r),e.buffers&&ck(e.buffers,r),e.bufferViews&&Nn(e.bufferViews,"bufferViews",r),e.accessors&&Nn(e.accessors,"accessors",r),e.meshes&&Nn(e.meshes,"meshes",r),e.lights&&Nn(e.lights,"lights",r),e.cameras&&Nn(e.cameras,"cameras",r),e.nodes&&Nn(e.nodes,"nodes",r),e.images&&Nn(e.images,"images",r),e.textures&&Nn(e.textures,"textures",r),e.shaders&&uk(e.shaders,r),e.programs&&Nn(e.programs,"programs",r),e.samplers&&Nn(e.samplers,"samplers",r),e.techniques&&Nn(e.techniques,"techniques",r),e.materials&&Nn(e.materials,"materials",r),e.animations&&Nn(e.animations,"animations",r),e.skins&&Nn(e.skins,"skins",r),e.scenes&&(r.scenes=e.scenes),e.scene&&e.scenes&&(r.currentScene=e.scenes[e.scene]),r}static LoadBufferAsync(e,t,n,r,s){let o=e.buffers[t];z.IsBase64(o.uri)?setTimeout(()=>n(new Uint8Array(z.DecodeBase64(o.uri)))):z.LoadFile(e.rootUrl+o.uri,a=>n(new Uint8Array(a)),s,void 0,!0,a=>{a&&r(a.status+" "+a.statusText)})}static LoadTextureBufferAsync(e,t,n,r){let s=e.textures[t];if(!s||!s.source){r("");return}if(s.babylonTexture){n(null);return}let o=e.images[s.source];z.IsBase64(o.uri)?setTimeout(()=>n(new Uint8Array(z.DecodeBase64(o.uri)))):z.LoadFile(e.rootUrl+o.uri,a=>n(new Uint8Array(a)),void 0,void 0,!0,a=>{a&&r(a.status+" "+a.statusText)})}static CreateTextureAsync(e,t,n,r){let s=e.textures[t];if(s.babylonTexture){r(s.babylonTexture);return}let o=e.samplers[s.sampler],a=o.minFilter===$i.NEAREST_MIPMAP_NEAREST||o.minFilter===$i.NEAREST_MIPMAP_LINEAR||o.minFilter===$i.LINEAR_MIPMAP_NEAREST||o.minFilter===$i.LINEAR_MIPMAP_LINEAR,l=te.BILINEAR_SAMPLINGMODE,c=n==null?new Blob:new Blob([n]),u=URL.createObjectURL(c),h=()=>URL.revokeObjectURL(u),d=new te(u,e.scene,!a,!0,l,h,h);o.wrapS!==void 0&&(d.wrapU=On.GetWrapMode(o.wrapS)),o.wrapT!==void 0&&(d.wrapV=On.GetWrapMode(o.wrapT)),d.name=t,s.babylonTexture=d,r(d)}static LoadShaderStringAsync(e,t,n,r){let s=e.shaders[t];if(z.IsBase64(s.uri)){let o=atob(s.uri.split(",")[1]);n&&n(o)}else z.LoadFile(e.rootUrl+s.uri,n,void 0,void 0,!1,o=>{o&&r&&r(o.status+" "+o.statusText)})}static LoadMaterialAsync(e,t,n,r){let s=e.materials[t];if(!s.technique){r&&r("No technique found.");return}let o=e.techniques[s.technique];if(!o){e.scene._blockEntityCollection=!!e.assetContainer;let x=new Z(t,e.scene);x._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,x.diffuseColor=new G(.5,.5,.5),x.sideOrientation=Oe.CounterClockWiseSideOrientation,n(x);return}let a=e.programs[o.program],l=o.states,c=Ft.ShadersStore[a.vertexShader+"VertexShader"],u=Ft.ShadersStore[a.fragmentShader+"PixelShader"],h="",d="",f=new vp(c),p=new vp(u),g={},_=[],y=[],C=[];for(let x in o.uniforms){let b=o.uniforms[x],D=o.parameters[b];if(g[x]=D,D.semantic&&!D.node&&!D.source){let M=_w.indexOf(D.semantic);M!==-1?(_.push(yw[M]),delete g[x]):_.push(x)}else D.type===Dn.SAMPLER_2D?C.push(x):_.push(x)}for(let x in o.attributes){let b=o.attributes[x],D=o.parameters[b];if(D.semantic){let M=dw(D);M&&y.push(M)}}for(;!f.isEnd()&&f.getNextToken();){if(f.currentToken!==$o.IDENTIFIER){h+=f.currentString;continue}let b=!1;for(let D in o.attributes){let M=o.attributes[D],R=o.parameters[M];if(f.currentIdentifier===D&&R.semantic){h+=dw(R),b=!0;break}}b||(h+=mw(f,o,g))}for(;!p.isEnd()&&p.getNextToken();){if(p.currentToken!==$o.IDENTIFIER){d+=p.currentString;continue}d+=mw(p,o,g)}let E={vertex:a.vertexShader+t,fragment:a.fragmentShader+t},I={attributes:y,uniforms:_,samplers:C,needAlphaBlending:l&&l.enable&&l.enable.indexOf(3042)!==-1};Ft.ShadersStore[a.vertexShader+t+"VertexShader"]=h,Ft.ShadersStore[a.fragmentShader+t+"PixelShader"]=d;let v=new Wi(t,e.scene,E,I);if(v.onError=xk(a,v,r),v.onCompiled=Ck(e,v,o,s,g,n),v.sideOrientation=Oe.CounterClockWiseSideOrientation,l&&l.functions){let x=l.functions;x.cullFace&&x.cullFace[0]!==fb.BACK&&(v.backFaceCulling=!1);let b=x.blendFuncSeparate;b&&(b[0]===At.SRC_ALPHA&&b[1]===At.ONE_MINUS_SRC_ALPHA&&b[2]===At.ONE&&b[3]===At.ONE?v.alphaMode=Zr.ALPHA_COMBINE:b[0]===At.ONE&&b[1]===At.ONE&&b[2]===At.ZERO&&b[3]===At.ONE?v.alphaMode=Zr.ALPHA_ONEONE:b[0]===At.SRC_ALPHA&&b[1]===At.ONE&&b[2]===At.ZERO&&b[3]===At.ONE?v.alphaMode=Zr.ALPHA_ADD:b[0]===At.ZERO&&b[1]===At.ONE_MINUS_SRC_COLOR&&b[2]===At.ONE&&b[3]===At.ONE?v.alphaMode=Zr.ALPHA_SUBTRACT:b[0]===At.DST_COLOR&&b[1]===At.ZERO&&b[2]===At.ONE&&b[3]===At.ONE?v.alphaMode=Zr.ALPHA_MULTIPLY:b[0]===At.SRC_ALPHA&&b[1]===At.ONE_MINUS_SRC_COLOR&&b[2]===At.ONE&&b[3]===At.ONE&&(v.alphaMode=Zr.ALPHA_MAXIMIZED))}}},Wo=(()=>{class i{static RegisterExtension(t){if(i.Extensions[t.name]){z.Error('Tool with the same name "'+t.name+'" already exists');return}i.Extensions[t.name]=t}dispose(){}_importMeshAsync(t,n,r,s,o,a,l,c){return n.useRightHandedSystem=!0,Ai.LoadRuntimeAsync(n,r,s,u=>{u.assetContainer=o,u.importOnlyMeshes=!0,t===""?u.importMeshesNames=[]:typeof t=="string"?u.importMeshesNames=[t]:t&&!(t instanceof Array)?u.importMeshesNames=[t]:(u.importMeshesNames=[],z.Warn("Argument meshesNames must be of type string or string[]")),this._createNodes(u);let h=[],d=[];for(let f in u.nodes){let p=u.nodes[f];p.babylonNode instanceof _i&&h.push(p.babylonNode)}for(let f in u.skins){let p=u.skins[f];p.babylonSkeleton instanceof Ho&&d.push(p.babylonSkeleton)}this._loadBuffersAsync(u,()=>{this._loadShadersAsync(u,()=>{gw(u),pw(u),!Br.IncrementalLoading&&a&&a(h,d)})}),Br.IncrementalLoading&&a&&a(h,d)},c),!0}importMeshAsync(t,n,r,s,o,a){return new Promise((l,c)=>{this._importMeshAsync(t,n,s,o,r,(u,h)=>{l({meshes:u,particleSystems:[],skeletons:h,animationGroups:[],lights:[],transformNodes:[],geometries:[],spriteManagers:[]})},a,u=>{c(new Error(u))})})}_loadAsync(t,n,r,s,o,a){t.useRightHandedSystem=!0,Ai.LoadRuntimeAsync(t,n,r,l=>{Ai.LoadRuntimeExtensionsAsync(l,()=>{this._createNodes(l),this._loadBuffersAsync(l,()=>{this._loadShadersAsync(l,()=>{gw(l),pw(l),Br.IncrementalLoading||s()})}),Br.IncrementalLoading&&s()},a)},a)}loadAsync(t,n,r,s){return T(this,null,function*(){return yield new Promise((o,a)=>{this._loadAsync(t,n,r,()=>{o()},s,l=>{a(new Error(l))})})})}_loadShadersAsync(t,n){let r=!1,s=(o,a)=>{Ai.LoadShaderStringAsync(t,o,l=>{l instanceof ArrayBuffer||(t.loadedShaderCount++,l&&(Ft.ShadersStore[o+(a.type===db.VERTEX?"VertexShader":"PixelShader")]=l),t.loadedShaderCount===t.shaderscount&&n())},()=>{z.Error("Error when loading shader program named "+o+" located at "+a.uri)})};for(let o in t.shaders){r=!0;let a=t.shaders[o];a?s.bind(this,o,a)():z.Error("No shader named: "+o)}r||n()}_loadBuffersAsync(t,n){let r=!1,s=(o,a)=>{Ai.LoadBufferAsync(t,o,l=>{t.loadedBufferCount++,l&&(l.byteLength!=t.buffers[o].byteLength&&z.Error("Buffer named "+o+" is length "+l.byteLength+". Expected: "+a.byteLength),t.loadedBufferViews[o]=l),t.loadedBufferCount===t.buffersCount&&n()},()=>{z.Error("Error when loading buffer named "+o+" located at "+a.uri)})};for(let o in t.buffers){r=!0;let a=t.buffers[o];a?s.bind(this,o,a)():z.Error("No buffer named: "+o)}r||n()}_createNodes(t){let n=t.currentScene;if(n)for(let r=0;r<n.nodes.length;r++)Ou(t,n.nodes[r],null);else for(let r in t.scenes){n=t.scenes[r];for(let s=0;s<n.nodes.length;s++)Ou(t,n.nodes[s],null)}}}return i.Extensions={},i})(),Ai=class i{constructor(e){this._name=e}get name(){return this._name}loadRuntimeAsync(e,t,n,r,s){return!1}loadRuntimeExtensionsAsync(e,t,n){return!1}loadBufferAsync(e,t,n,r,s){return!1}loadTextureBufferAsync(e,t,n,r){return!1}createTextureAsync(e,t,n,r,s){return!1}loadShaderStringAsync(e,t,n,r){return!1}loadMaterialAsync(e,t,n,r){return!1}static LoadRuntimeAsync(e,t,n,r,s){i._ApplyExtensions(o=>o.loadRuntimeAsync(e,t,n,r,s),()=>{setTimeout(()=>{r&&r(Ei.CreateRuntime(t.json,e,n))})})}static LoadRuntimeExtensionsAsync(e,t,n){i._ApplyExtensions(r=>r.loadRuntimeExtensionsAsync(e,t,n),()=>{setTimeout(()=>{t()})})}static LoadBufferAsync(e,t,n,r,s){i._ApplyExtensions(o=>o.loadBufferAsync(e,t,n,r,s),()=>{Ei.LoadBufferAsync(e,t,n,r,s)})}static LoadTextureAsync(e,t,n,r){i._LoadTextureBufferAsync(e,t,s=>{s&&i._CreateTextureAsync(e,t,s,n,r)},r)}static LoadShaderStringAsync(e,t,n,r){i._ApplyExtensions(s=>s.loadShaderStringAsync(e,t,n,r),()=>{Ei.LoadShaderStringAsync(e,t,n,r)})}static LoadMaterialAsync(e,t,n,r){i._ApplyExtensions(s=>s.loadMaterialAsync(e,t,n,r),()=>{Ei.LoadMaterialAsync(e,t,n,r)})}static _LoadTextureBufferAsync(e,t,n,r){i._ApplyExtensions(s=>s.loadTextureBufferAsync(e,t,n,r),()=>{Ei.LoadTextureBufferAsync(e,t,n,r)})}static _CreateTextureAsync(e,t,n,r,s){i._ApplyExtensions(o=>o.createTextureAsync(e,t,n,r,s),()=>{Ei.CreateTextureAsync(e,t,n,r)})}static _ApplyExtensions(e,t){for(let n in Wo.Extensions){let r=Wo.Extensions[n];if(e(r))return}t()}};Br._CreateGLTF1Loader=()=>new Wo;var Tk="binary_glTF",Tb=class extends Ai{constructor(){super("KHR_binary_glTF")}loadRuntimeAsync(e,t,n,r){let s=t.json.extensionsUsed;return!s||s.indexOf(this.name)===-1||!t.bin?!1:(this._bin=t.bin,r(Ei.CreateRuntime(t.json,e,n)),!0)}loadBufferAsync(e,t,n,r){return e.extensionsUsed.indexOf(this.name)===-1||t!==Tk?!1:(this._bin.readAsync(0,this._bin.byteLength).then(n,s=>r(s.message)),!0)}loadTextureBufferAsync(e,t,n){let r=e.textures[t],s=e.images[r.source];if(!s.extensions||!(this.name in s.extensions))return!1;let o=s.extensions[this.name],a=e.bufferViews[o.bufferView],l=On.GetBufferFromBufferView(e,a,0,a.byteLength,ds.UNSIGNED_BYTE);return n(l),!0}loadShaderStringAsync(e,t,n){let r=e.shaders[t];if(!r.extensions||!(this.name in r.extensions))return!1;let s=r.extensions[this.name],o=e.bufferViews[s.bufferView],a=On.GetBufferFromBufferView(e,o,0,o.byteLength,ds.UNSIGNED_BYTE);return setTimeout(()=>{let l=On.DecodeBufferToText(a);n(l)}),!0}};Wo.RegisterExtension(new Tb);var Sb=class extends Ai{constructor(){super("KHR_materials_common")}loadRuntimeExtensionsAsync(e){if(!e.extensions)return!1;let t=e.extensions[this.name];if(!t)return!1;let n=t.lights;if(n)for(let r in n){let s=n[r];switch(s.type){case"ambient":{let o=new Pn(s.name,new m(0,1,0),e.scene),a=s.ambient;a&&(o.diffuse=G.FromArray(a.color||[1,1,1]));break}case"point":{let o=new Ii(s.name,new m(10,10,10),e.scene),a=s.point;a&&(o.diffuse=G.FromArray(a.color||[1,1,1]));break}case"directional":{let o=new Da(s.name,new m(0,-1,0),e.scene),a=s.directional;a&&(o.diffuse=G.FromArray(a.color||[1,1,1]));break}case"spot":{let o=s.spot;if(o){let a=new Ts(s.name,new m(0,10,0),new m(0,-1,0),o.fallOffAngle||Math.PI,o.fallOffExponent||0,e.scene);a.diffuse=G.FromArray(o.color||[1,1,1])}break}default:z.Warn('GLTF Material Common extension: light type "'+s.type+"\u201D not supported");break}}return!1}loadMaterialAsync(e,t,n,r){let s=e.materials[t];if(!s||!s.extensions)return!1;let o=s.extensions[this.name];if(!o)return!1;let a=new Z(t,e.scene);return a.sideOrientation=Oe.CounterClockWiseSideOrientation,o.technique==="CONSTANT"&&(a.disableLighting=!0),a.backFaceCulling=o.doubleSided===void 0?!1:!o.doubleSided,a.alpha=o.values.transparency===void 0?1:o.values.transparency,a.specularPower=o.values.shininess===void 0?0:o.values.shininess,typeof o.values.ambient=="string"?this._loadTexture(e,o.values.ambient,a,"ambientTexture",r):a.ambientColor=G.FromArray(o.values.ambient||[0,0,0]),typeof o.values.diffuse=="string"?this._loadTexture(e,o.values.diffuse,a,"diffuseTexture",r):a.diffuseColor=G.FromArray(o.values.diffuse||[0,0,0]),typeof o.values.emission=="string"?this._loadTexture(e,o.values.emission,a,"emissiveTexture",r):a.emissiveColor=G.FromArray(o.values.emission||[0,0,0]),typeof o.values.specular=="string"?this._loadTexture(e,o.values.specular,a,"specularTexture",r):a.specularColor=G.FromArray(o.values.specular||[0,0,0]),!0}_loadTexture(e,t,n,r,s){Ei.LoadTextureBufferAsync(e,t,o=>{Ei.CreateTextureAsync(e,t,o,a=>n[r]=a)},s)}};Wo.RegisterExtension(new Sb);var fs=class{get resolve(){return this._resolve}get reject(){return this._reject}constructor(){this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}};var jo=class i{get influence(){return this._influence}set influence(e){if(this._influence===e)return;let t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(t===0||e===0)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}constructor(e,t=0,n=null){this.name=e,this.animations=[],this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uv2s=null,this._colors=null,this._uniqueId=0,this.onInfluenceChanged=new B,this._onDataLayoutChanged=new B,this._animationPropertiesOverride=null,this.id=e,this._scene=n||Ie.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}get hasUV2s(){return!!this._uv2s}get hasColors(){return!!this._colors}get vertexCount(){return this._positions?this._positions.length/3:this._normals?this._normals.length/3:this._tangents?this._tangents.length/3:this._uvs?this._uvs.length/2:this._uv2s?this._uv2s.length/2:this._colors?this._colors.length/4:0}setPositions(e){let t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){let t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){let t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){let t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}setUV2s(e){let t=this.hasUV2s;this._uv2s=e,t!==this.hasUV2s&&this._onDataLayoutChanged.notifyObservers(void 0)}getUV2s(){return this._uv2s}setColors(e){let t=this.hasColors;this._colors=e,t!==this.hasColors&&this._onDataLayoutChanged.notifyObservers(void 0)}getColors(){return this._colors}clone(){let e=Xe.Clone(()=>new i(this.name,this.influence,this._scene),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e._uv2s=this._uv2s,e._colors=this._colors,e}serialize(){let e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),this.id!=null&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),this.hasUV2s&&(e.uv2s=Array.prototype.slice.call(this.getUV2s())),this.hasColors&&(e.colors=Array.prototype.slice.call(this.getColors())),Xe.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){let n=new i(e.name,e.influence);if(n.setPositions(e.positions),e.id!=null&&(n.id=e.id),e.normals&&n.setNormals(e.normals),e.tangents&&n.setTangents(e.tangents),e.uvs&&n.setUVs(e.uvs),e.uv2s&&n.setUV2s(e.uv2s),e.colors&&n.setColors(e.colors),e.animations){for(let r=0;r<e.animations.length;r++){let s=e.animations[r],o=Ct("BABYLON.Animation");o&&n.animations.push(o.Parse(s))}e.autoAnimate&&t&&t.beginAnimation(n,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return n}static FromMesh(e,t,n){t||(t=e.name);let r=new i(t,n,e.getScene());return r.setPositions(e.getVerticesData(S.PositionKind)),e.isVerticesDataPresent(S.NormalKind)&&r.setNormals(e.getVerticesData(S.NormalKind)),e.isVerticesDataPresent(S.TangentKind)&&r.setTangents(e.getVerticesData(S.TangentKind)),e.isVerticesDataPresent(S.UVKind)&&r.setUVs(e.getVerticesData(S.UVKind)),e.isVerticesDataPresent(S.UV2Kind)&&r.setUV2s(e.getVerticesData(S.UV2Kind)),e.isVerticesDataPresent(S.ColorKind)&&r.setColors(e.getVerticesData(S.ColorKind)),r}};w([L()],jo.prototype,"id",void 0);var bp=class i extends te{get depth(){return this._depth}constructor(e,t,n,r,s,o,a=!0,l=!1,c=te.TRILINEAR_SAMPLINGMODE,u=0,h){super(null,o,!a,l),this.format=s,this._texture=o.getEngine().createRawTexture2DArray(e,t,n,r,s,a,l,c,null,u,h),this._depth=r,this.is2DArray=!0}update(e){this._texture&&this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,n,r,s,o=!0,a=!1,l=3,c=0){return new i(e,t,n,r,5,s,o,a,l,c)}};var bw=(()=>{class i{set areUpdatesFrozen(t){t?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(this._forceUpdateWhenUnfrozen),this._forceUpdateWhenUnfrozen=!1))}get areUpdatesFrozen(){return this._blockCounter>0}constructor(t=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new Ca(16),this._supportsPositions=!1,this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._supportsUV2s=!1,this._supportsColors=!1,this._vertexCount=0,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._mustSynchronize=!0,this._forceUpdateWhenUnfrozen=!1,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._parentContainer=null,this.optimizeInfluencers=!0,this.enablePositionMorphing=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this.enableUV2Morphing=!0,this.enableColorMorphing=!0,this._numMaxInfluencers=0,this._useTextureToStoreTargets=!0,this.metadata=null,this._influencesAreDirty=!1,this._needUpdateInfluences=!1,t||(t=Ie.LastCreatedScene),this._scene=t,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();let n=this._scene.getEngine().getCaps();this._canUseTextureForTargets=n.canUseGLVertexID&&n.textureFloat&&n.maxVertexTextureImageUnits>0&&n.texture2DArrayMaxLayerCount>1}}get numMaxInfluencers(){return i.ConstantTargetCountForTextureMode>0&&this.isUsingTextureForTargets?i.ConstantTargetCountForTextureMode:this._numMaxInfluencers}set numMaxInfluencers(t){this._numMaxInfluencers!==t&&(this._numMaxInfluencers=t,this._mustSynchronize=!0,this._syncActiveTargets())}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsPositions(){return this._supportsPositions&&this.enablePositionMorphing}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get supportsUV2s(){return this._supportsUV2s&&this.enableUV2Morphing}get supportsColors(){return this._supportsColors&&this.enableColorMorphing}get hasPositions(){return this._supportsPositions}get hasNormals(){return this._supportsNormals}get hasTangents(){return this._supportsTangents}get hasUVs(){return this._supportsUVs}get hasUV2s(){return this._supportsUV2s}get hasColors(){return this._supportsColors}get numTargets(){return this._targets.length}get numInfluencers(){return this._influencesAreDirty&&this._syncActiveTargets(),this._activeTargets.length}get influences(){return this._influencesAreDirty&&this._syncActiveTargets(),this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(t){this._useTextureToStoreTargets!==t&&(this._useTextureToStoreTargets=t,this._mustSynchronize=!0,this._syncActiveTargets())}get isUsingTextureForTargets(){return i.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets&&!this._scene?.getEngine().getCaps().disableMorphTargetTexture}getActiveTarget(t){return this._influencesAreDirty&&this._syncActiveTargets(),this._activeTargets.data[t]}getTarget(t){return this._targets[t]}getTargetByName(t){for(let n of this._targets)if(n.name===t)return n;return null}addTarget(t){this._targets.push(t),this._targetInfluenceChangedObservers.push(t.onInfluenceChanged.add(n=>{this.areUpdatesFrozen&&n&&(this._forceUpdateWhenUnfrozen=!0),this._influencesAreDirty=!0,this._needUpdateInfluences=this._needUpdateInfluences||n})),this._targetDataLayoutChangedObservers.push(t._onDataLayoutChanged.add(()=>{this._mustSynchronize=!0,this._syncActiveTargets()})),this._mustSynchronize=!0,this._syncActiveTargets()}removeTarget(t){let n=this._targets.indexOf(t);n>=0&&(this._targets.splice(n,1),t.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(n,1)[0]),t._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(n,1)[0]),this._mustSynchronize=!0,this._syncActiveTargets()),this._scene&&this._scene.stopAnimation(t)}_bind(t){this._influencesAreDirty&&this._syncActiveTargets(),t.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),t.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),t.setTexture("morphTargets",this._targetStoreTexture),t.setFloat("morphTargetCount",this.numInfluencers)}clone(){let t=new i(this._scene);t.areUpdatesFrozen=!0;for(let n of this._targets)t.addTarget(n.clone());return t.areUpdatesFrozen=!1,t.enablePositionMorphing=this.enablePositionMorphing,t.enableNormalMorphing=this.enableNormalMorphing,t.enableTangentMorphing=this.enableTangentMorphing,t.enableUVMorphing=this.enableUVMorphing,t.enableUV2Morphing=this.enableUV2Morphing,t.enableColorMorphing=this.enableColorMorphing,t.metadata=this.metadata,t}serialize(){let t={};t.id=this.uniqueId,t.targets=[];for(let n of this._targets)t.targets.push(n.serialize());return this.metadata&&(t.metadata=this.metadata),t}_syncActiveTargets(t=!1){if(this.areUpdatesFrozen)return;t=t||this._needUpdateInfluences,this._needUpdateInfluences=!1,this._influencesAreDirty=!1;let n=!!this._targetStoreTexture,r=this.isUsingTextureForTargets;(this._mustSynchronize||n!==r)&&(this._mustSynchronize=!1,this.synchronize());let s=0;this._activeTargets.reset(),(!this._morphTargetTextureIndices||this._morphTargetTextureIndices.length!==this._targets.length)&&(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let o=-1;for(let a of this._targets)if(o++,!(a.influence===0&&this.optimizeInfluencers)){if(this._activeTargets.length>=i.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(a),this._morphTargetTextureIndices[s]=o,this._tempInfluences[s++]=a.influence}this._morphTargetTextureIndices.length!==s&&(this._morphTargetTextureIndices=this._morphTargetTextureIndices.slice(0,s)),(!this._influences||this._influences.length!==s)&&(this._influences=new Float32Array(s));for(let a=0;a<s;a++)this._influences[a]=this._tempInfluences[a];if(t&&this._scene)for(let a of this._scene.meshes)a.morphTargetManager===this&&(r?a._markSubMeshesAsAttributesDirty():a._syncGeometryWithMorphTargetManager())}synchronize(){if(!this._scene||this.areUpdatesFrozen)return;let t=this._scene.getEngine();this._supportsPositions=!0,this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._supportsUV2s=!0,this._supportsColors=!0,this._vertexCount=0,this._targetStoreTexture?.dispose(),this._targetStoreTexture=null,this.isUsingTextureForTargets&&this._targets.length>t.getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1);for(let n of this._targets){this._supportsPositions=this._supportsPositions&&n.hasPositions,this._supportsNormals=this._supportsNormals&&n.hasNormals,this._supportsTangents=this._supportsTangents&&n.hasTangents,this._supportsUVs=this._supportsUVs&&n.hasUVs,this._supportsUV2s=this._supportsUV2s&&n.hasUV2s,this._supportsColors=this._supportsColors&&n.hasColors;let r=n.vertexCount;if(this._vertexCount===0)this._vertexCount=r;else if(this._vertexCount!==r){N.Error(`Incompatible target. Targets must all have the same vertices count. Current vertex count: ${this._vertexCount}, vertex count for target "${n.name}": ${r}`);return}}if(this.isUsingTextureForTargets){this._textureVertexStride=0,this._supportsPositions&&this._textureVertexStride++,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._supportsUV2s&&this._textureVertexStride++,this._supportsColors&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride||1,this._textureHeight=1;let n=t.getCaps().maxTextureSize;this._textureWidth>n&&(this._textureHeight=Math.ceil(this._textureWidth/n),this._textureWidth=n);let r=this._targets.length,s=new Float32Array(r*this._textureWidth*this._textureHeight*4),o=0;for(let a=0;a<r;a++){let l=this._targets[a],c=l.getPositions(),u=l.getNormals(),h=l.getUVs(),d=l.getTangents(),f=l.getUV2s(),p=l.getColors();o=a*this._textureWidth*this._textureHeight*4;for(let g=0;g<this._vertexCount;g++)this._supportsPositions&&c&&(s[o]=c[g*3],s[o+1]=c[g*3+1],s[o+2]=c[g*3+2],o+=4),this._supportsNormals&&u&&(s[o]=u[g*3],s[o+1]=u[g*3+1],s[o+2]=u[g*3+2],o+=4),this._supportsUVs&&h&&(s[o]=h[g*2],s[o+1]=h[g*2+1],o+=4),this._supportsTangents&&d&&(s[o]=d[g*3],s[o+1]=d[g*3+1],s[o+2]=d[g*3+2],o+=4),this._supportsUV2s&&f&&(s[o]=f[g*2],s[o+1]=f[g*2+1],o+=4),this._supportsColors&&p&&(s[o]=p[g*4],s[o+1]=p[g*4+1],s[o+2]=p[g*4+2],s[o+3]=p[g*4+3],o+=4)}this._targetStoreTexture=bp.CreateRGBATexture(s,this._textureWidth,this._textureHeight,r,this._scene,!1,!1,1,1),this._targetStoreTexture.name=`Morph texture_${this.uniqueId}`}for(let n of this._scene.meshes)n.morphTargetManager===this&&n._syncGeometryWithMorphTargetManager()}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this.metadata=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){let t=this._parentContainer.morphTargetManagers.indexOf(this);t>-1&&this._parentContainer.morphTargetManagers.splice(t,1),this._parentContainer=null}for(let t of this._targets)this._scene.stopAnimation(t)}}static Parse(t,n){let r=new i(n);for(let s of t.targets)r.addTarget(jo.Parse(s,n));return t.metadata&&(r.metadata=t.metadata),r}}return i.EnableTextureStorage=!0,i.MaxActiveMorphTargetsInVertexAttributeMode=8,i.ConstantTargetCountForTextureMode=0,i})();var Ib=new Map,xw=Ib;function fe(i,e,t){he(i)&&N.Warn(`Extension with the name '${i}' already exists`),Ib.set(i,{isGLTFExtension:e,factory:t})}function he(i){return Ib.delete(i)}function Eb(...i){let e=t=>!!t&&typeof t=="object";return i.reduce((t,n)=>{let r=Object.keys(n);for(let s of r){let o=t[s],a=n[s];Array.isArray(o)&&Array.isArray(a)?t[s]=o.concat(...a):e(o)&&e(a)?t[s]=Eb(o,a):t[s]=a}return t},{})}var Nu=class{constructor(e){this._factory=e}get value(){return this._factory&&(this._value=this._factory(),this._factory=void 0),this._value}};var Ik=new Nu(()=>import("./chunk-NVXHYZRX.js")),Ek=new Nu(()=>import("./chunk-XN3D2FU2.js"));var se=class{static Get(e,t,n){if(!t||n==null||!t[n])throw new Error(`${e}: Failed to find index (${n})`);return t[n]}static TryGet(e,t){return!e||t==null||!e[t]?null:e[t]}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}};function Ab(i){if(i.min&&i.max){let e=i.min,t=i.max,n=U.Vector3[0].copyFromFloats(e[0],e[1],e[2]),r=U.Vector3[1].copyFromFloats(t[0],t[1],t[2]);if(i.normalized&&i.componentType!==5126){let s=1;switch(i.componentType){case 5120:s=127;break;case 5121:s=255;break;case 5122:s=32767;break;case 5123:s=65535;break}let o=1/s;n.scaleInPlace(o),r.scaleInPlace(o)}return new Xr(n,r)}return null}var me=(()=>{class i{static RegisterExtension(t,n){fe(t,!1,n)}static UnregisterExtension(t){return he(t)}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}get rootUrl(){return this._rootUrl}constructor(t){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._allMaterialsDirtyRequired=!1,this._skipStartAnimationStep=!1,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._materialAdapterCache=new WeakMap,this._pbrMaterialImpl=null,this._parent=t}_getOrCreateMaterialAdapter(t){let n=this._materialAdapterCache.get(t);if(!n){if(this._pbrMaterialImpl)n=new this._pbrMaterialImpl.adapterClass(t);else throw new Error("Appropriate material adapter class not found");this._materialAdapterCache.set(t,n)}return n}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(t=>t.dispose&&t.dispose()),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}importMeshAsync(t,n,r,s,o,a,l=""){return T(this,null,function*(){return yield Promise.resolve().then(()=>T(this,null,function*(){this._babylonScene=n,this._assetContainer=r,this._loadData(s);let c=null;if(t){let u={};if(this._gltf.nodes)for(let d of this._gltf.nodes)d.name&&(u[d.name]=d.index);c=(t instanceof Array?t:[t]).map(d=>{let f=u[d];if(f===void 0)throw new Error(`Failed to find node '${d}'`);return f})}return yield this._loadAsync(o,l,c,()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries(),spriteManagers:[]}))}))})}loadAsync(t,n,r,s,o=""){return T(this,null,function*(){return this._babylonScene=t,this._loadData(n),yield this._loadAsync(r,o,null,()=>{})})}_loadAsync(t,n,r,s){return T(this,null,function*(){return yield Promise.resolve().then(()=>T(this,null,function*(){this._rootUrl=t,this._uniqueRootUrl=!t.startsWith("file:")&&n?t:`${t}${Date.now()}/`,this._fileName=n,this._allMaterialsDirtyRequired=!1,yield this._loadExtensionsAsync(),!this.parent.skipMaterials&&this._pbrMaterialImpl==null&&(this.parent.useOpenPBR||this.isExtensionUsed("KHR_materials_openpbr")?this._pbrMaterialImpl={materialClass:(yield import("./chunk-LU2DSSF3.js")).OpenPBRMaterial,adapterClass:(yield import("./chunk-ATBMA4WZ.js")).OpenPBRMaterialLoadingAdapter}:this._pbrMaterialImpl={materialClass:(yield import("./chunk-OPIBKIBP.js")).PBRMaterial,adapterClass:(yield import("./chunk-HPCBU7DH.js")).PBRMaterialLoadingAdapter});let o=`${li[li.LOADING]} => ${li[li.READY]}`,a=`${li[li.LOADING]} => ${li[li.COMPLETE]}`;this._parent._startPerformanceCounter(o),this._parent._startPerformanceCounter(a),this._parent._setState(li.LOADING),this._extensionsOnLoading();let l=new Array,c=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials){if(r)l.push(this.loadSceneAsync("/nodes",{nodes:r,index:-1}));else if(this._gltf.scene!=null||this._gltf.scenes&&this._gltf.scenes[0]){let h=se.Get("/scene",this._gltf.scenes,this._gltf.scene||0);l.push(this.loadSceneAsync(`/scenes/${h.index}`,h))}}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let h=0;h<this._gltf.materials.length;++h){let d=this._gltf.materials[h],f="/materials/"+h,p=Oe.TriangleFillMode;l.push(this._loadMaterialAsync(f,d,null,p,()=>{}))}return this._allMaterialsDirtyRequired?this._babylonScene.blockMaterialDirtyMechanism=c:this._babylonScene._forceBlockMaterialDirtyMechanism(c),this._parent.compileMaterials&&l.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&l.push(this._compileShadowGeneratorsAsync()),yield Promise.all(l).then(()=>{this._rootBabylonMesh&&this._rootBabylonMesh!==this._parent.customRootNode&&this._rootBabylonMesh.setEnabled(!0);for(let h of this._babylonScene.materials){let d=h;d.maxSimultaneousLights!==void 0&&(d.maxSimultaneousLights=Math.max(d.maxSimultaneousLights,this._babylonScene.lights.length))}return this._extensionsOnReady(),this._parent._setState(li.READY),this._skipStartAnimationStep||this._startAnimations(),s()}).then(h=>(this._parent._endPerformanceCounter(o),z.SetImmediate(()=>{this._disposed||Promise.all(this._completePromises).then(()=>{this._parent._endPerformanceCounter(a),this._parent._setState(li.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()},d=>{this._parent.onErrorObservable.notifyObservers(d),this._parent.onErrorObservable.clear(),this.dispose()})}),h))})).catch(o=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(o),this._parent.onErrorObservable.clear(),this.dispose()),o})})}_loadData(t){if(this._gltf=t.json,this._setupData(),t.bin){let n=this._gltf.buffers;if(n&&n[0]&&!n[0].uri){let r=n[0];(r.byteLength<t.bin.byteLength-3||r.byteLength>t.bin.byteLength)&&N.Warn(`Binary buffer length (${r.byteLength}) from JSON does not match chunk length (${t.bin.byteLength})`),this._bin=t.bin}else N.Warn("Unexpected BIN chunk")}}_setupData(){if(se.Assign(this._gltf.accessors),se.Assign(this._gltf.animations),se.Assign(this._gltf.buffers),se.Assign(this._gltf.bufferViews),se.Assign(this._gltf.cameras),se.Assign(this._gltf.images),se.Assign(this._gltf.materials),se.Assign(this._gltf.meshes),se.Assign(this._gltf.nodes),se.Assign(this._gltf.samplers),se.Assign(this._gltf.scenes),se.Assign(this._gltf.skins),se.Assign(this._gltf.textures),this._gltf.nodes){let t={};for(let r of this._gltf.nodes)if(r.children)for(let s of r.children)t[s]=r.index;let n=this._createRootNode();for(let r of this._gltf.nodes){let s=t[r.index];r.parent=s===void 0?n:this._gltf.nodes[s]}}}_loadExtensionsAsync(){return T(this,null,function*(){let t=[];if(xw.forEach((n,r)=>{this.parent.extensionOptions[r]?.enabled===!1?n.isGLTFExtension&&this.isExtensionUsed(r)&&N.Warn(`Extension ${r} is used but has been explicitly disabled.`):(!n.isGLTFExtension||this.isExtensionUsed(r))&&t.push(T(this,null,function*(){let s=yield n.factory(this);return s.name!==r&&N.Warn(`The name of the glTF loader extension instance does not match the registered name: ${s.name} !== ${r}`),this._parent.onExtensionLoadedObservable.notifyObservers(s),s}))}),this._extensions.push(...yield Promise.all(t)),this._extensions.sort((n,r)=>(n.order||Number.MAX_VALUE)-(r.order||Number.MAX_VALUE)),this._parent.onExtensionLoadedObservable.clear(),this._gltf.extensionsRequired){for(let n of this._gltf.extensionsRequired)if(!this._extensions.some(s=>s.name===n&&s.enabled))throw this.parent.extensionOptions[n]?.enabled===!1?new Error(`Required extension ${n} is disabled`):new Error(`Required extension ${n} is not available`)}})}_createRootNode(){if(this._parent.customRootNode!==void 0)return this._rootBabylonMesh=this._parent.customRootNode,{_babylonTransformNode:this._rootBabylonMesh===null?void 0:this._rootBabylonMesh,index:-1};this._babylonScene._blockEntityCollection=!!this._assetContainer;let t=new A("__root__",this._babylonScene);this._rootBabylonMesh=t,this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);let n={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case Ru.AUTO:{this._babylonScene.useRightHandedSystem||(n.rotation=[0,1,0,0],n.scale=[1,1,-1],i._LoadTransform(n,this._rootBabylonMesh));break}case Ru.FORCE_RIGHT_HANDED:{this._babylonScene.useRightHandedSystem=!0;break}default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(t),n}loadSceneAsync(t,n){let r=this._extensionsLoadSceneAsync(t,n);if(r)return r;let s=new Array;if(this.logOpen(`${t} ${n.name||""}`),n.nodes)for(let o of n.nodes){let a=se.Get(`${t}/nodes/${o}`,this._gltf.nodes,o);s.push(this.loadNodeAsync(`/nodes/${a.index}`,a,l=>{l.parent=this._rootBabylonMesh}))}for(let o of this._postSceneLoadActions)o();return s.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(s).then(()=>{})}_forEachPrimitive(t,n){if(t._primitiveBabylonMeshes)for(let r of t._primitiveBabylonMeshes)n(r)}_getGeometries(){let t=[],n=this._gltf.nodes;if(n)for(let r of n)this._forEachPrimitive(r,s=>{let o=s.geometry;o&&t.indexOf(o)===-1&&t.push(o)});return t}_getMeshes(){let t=[];this._rootBabylonMesh instanceof _i&&t.push(this._rootBabylonMesh);let n=this._gltf.nodes;if(n)for(let r of n)this._forEachPrimitive(r,s=>{t.push(s)});return t}_getTransformNodes(){let t=[],n=this._gltf.nodes;if(n)for(let r of n)r._babylonTransformNode&&r._babylonTransformNode.getClassName()==="TransformNode"&&t.push(r._babylonTransformNode),r._babylonTransformNodeForSkin&&t.push(r._babylonTransformNodeForSkin);return t}_getSkeletons(){let t=[],n=this._gltf.skins;if(n)for(let r of n)r._data&&t.push(r._data.babylonSkeleton);return t}_getAnimationGroups(){let t=[],n=this._gltf.animations;if(n)for(let r of n)r._babylonAnimationGroup&&t.push(r._babylonAnimationGroup);return t}_startAnimations(){switch(this._parent.animationStartMode){case wl.NONE:break;case wl.FIRST:{let t=this._getAnimationGroups();t.length!==0&&t[0].start(!0);break}case wl.ALL:{let t=this._getAnimationGroups();for(let n of t)n.start(!0);break}default:{N.Error(`Invalid animation start mode (${this._parent.animationStartMode})`);return}}}loadNodeAsync(t,n,r=()=>{}){let s=this._extensionsLoadNodeAsync(t,n,r);if(s)return s;if(n._babylonTransformNode)throw new Error(`${t}: Invalid recursive node hierarchy`);let o=new Array;this.logOpen(`${t} ${n.name||""}`);let a=u=>{if(i.AddPointerMetadata(u,t),i._LoadTransform(n,u),n.camera!=null){let h=se.Get(`${t}/camera`,this._gltf.cameras,n.camera);o.push(this.loadCameraAsync(`/cameras/${h.index}`,h,d=>{d.parent=u,this._babylonScene.useRightHandedSystem||(u.scaling.x=-1)}))}if(n.children)for(let h of n.children){let d=se.Get(`${t}/children/${h}`,this._gltf.nodes,h);o.push(this.loadNodeAsync(`/nodes/${d.index}`,d,f=>{f.parent=u}))}r(u)},l=n.mesh!=null,c=this._parent.loadSkins&&n.skin!=null;if(!l||c){let u=n.name||`node${n.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;let h=new ln(u,this._babylonScene);h._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n.mesh==null?n._babylonTransformNode=h:n._babylonTransformNodeForSkin=h,a(h)}if(l)if(c){let u=se.Get(`${t}/mesh`,this._gltf.meshes,n.mesh);o.push(this._loadMeshAsync(`/meshes/${u.index}`,n,u,h=>{let d=n._babylonTransformNodeForSkin;h.metadata=Eb(d.metadata,h.metadata||{});let f=se.Get(`${t}/skin`,this._gltf.skins,n.skin);o.push(this._loadSkinAsync(`/skins/${f.index}`,n,f,p=>{this._forEachPrimitive(n,g=>{g.skeleton=p}),this._postSceneLoadActions.push(()=>{if(f.skeleton!=null){let g=se.Get(`/skins/${f.index}/skeleton`,this._gltf.nodes,f.skeleton).parent;n.index===g.index?h.parent=d.parent:h.parent=g._babylonTransformNode}else h.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:d,skinnedNode:h})})}))}))}else{let u=se.Get(`${t}/mesh`,this._gltf.meshes,n.mesh);o.push(this._loadMeshAsync(`/meshes/${u.index}`,n,u,a))}return this.logClose(),Promise.all(o).then(()=>(this._forEachPrimitive(n,u=>{let h=u;!h.isAnInstance&&h.geometry&&h.geometry.useBoundingInfoFromGeometry?u._updateBoundingInfo():u.refreshBoundingInfo(!0,!0)}),n._babylonTransformNode))}_loadMeshAsync(t,n,r,s){let o=r.primitives;if(!o||!o.length)throw new Error(`${t}: Primitives are missing`);o[0].index==null&&se.Assign(o);let a=new Array;this.logOpen(`${t} ${r.name||""}`);let l=n.name||`node${n.index}`;if(o.length===1){let c=r.primitives[0];a.push(this._loadMeshPrimitiveAsync(`${t}/primitives/${c.index}`,l,n,r,c,u=>{n._babylonTransformNode=u,n._primitiveBabylonMeshes=[u]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,n._babylonTransformNode=new ln(l,this._babylonScene),n._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n._primitiveBabylonMeshes=[];for(let c of o)a.push(this._loadMeshPrimitiveAsync(`${t}/primitives/${c.index}`,`${l}_primitive${c.index}`,n,r,c,u=>{u.parent=n._babylonTransformNode,n._primitiveBabylonMeshes.push(u)}))}return s(n._babylonTransformNode),this.logClose(),Promise.all(a).then(()=>n._babylonTransformNode)}_loadMeshPrimitiveAsync(t,n,r,s,o,a){let l=this._extensionsLoadMeshPrimitiveAsync(t,n,r,s,o,a);if(l)return l;this.logOpen(`${t}`);let c=this._disableInstancedMesh===0&&this._parent.createInstances&&r.skin==null&&!s.primitives[0].targets,u,h;if(c&&o._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,u=o._instanceData.babylonSourceMesh.createInstance(n),u._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,h=o._instanceData.promise;else{let d=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;let f=new A(n,this._babylonScene);if(f._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,f.sideOrientation=this._babylonScene.useRightHandedSystem?Oe.CounterClockWiseSideOrientation:Oe.ClockWiseSideOrientation,this._createMorphTargets(t,r,s,o,f),d.push(this._loadVertexDataAsync(t,o,f).then(p=>T(this,null,function*(){return yield this._loadMorphTargetsAsync(t,o,f,p).then(()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,p.applyToMesh(f),p._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)})}))),!this.parent.skipMaterials){let p=i._GetDrawMode(t,o.mode);if(o.material==null){let g=this._defaultBabylonMaterialData[p];g||(g=this._createDefaultMaterial("__GLTFLoader._default",p),this._parent.onMaterialLoadedObservable.notifyObservers(g),this._defaultBabylonMaterialData[p]=g),f.material=g}else{let g=se.Get(`${t}/material`,this._gltf.materials,o.material);d.push(this._loadMaterialAsync(`/materials/${g.index}`,g,f,p,_=>{f.material=_}))}}h=Promise.all(d),c&&(o._instanceData={babylonSourceMesh:f,promise:h}),u=f}return i.AddPointerMetadata(u,t),this._parent.onMeshLoadedObservable.notifyObservers(u),a(u),this.logClose(),h.then(()=>u)}_loadVertexDataAsync(t,n,r){let s=this._extensionsLoadVertexDataAsync(t,n,r);if(s)return s;let o=n.attributes;if(!o)throw new Error(`${t}: Attributes are missing`);let a=new Array,l=new jt(r.name,this._babylonScene);if(n.indices==null)r.isUnIndexed=!0;else{let u=se.Get(`${t}/indices`,this._gltf.accessors,n.indices);a.push(this._loadIndicesAccessorAsync(`/accessors/${u.index}`,u).then(h=>{l.setIndices(h)}))}let c=(u,h,d)=>{if(o[u]==null)return;r._delayInfo=r._delayInfo||[],r._delayInfo.indexOf(h)===-1&&r._delayInfo.push(h);let f=se.Get(`${t}/attributes/${u}`,this._gltf.accessors,o[u]);a.push(this._loadVertexAccessorAsync(`/accessors/${f.index}`,f,h).then(p=>{if(p.getKind()===S.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!r.skeleton){let g=Ab(f);g&&(l._boundingInfo=g,l.useBoundingInfoFromGeometry=!0)}l.setVerticesBuffer(p,f.count)})),h==S.MatricesIndicesExtraKind&&(r.numBoneInfluencers=8),d&&d(f)};return c("POSITION",S.PositionKind),c("NORMAL",S.NormalKind),c("TANGENT",S.TangentKind),c("TEXCOORD_0",S.UVKind),c("TEXCOORD_1",S.UV2Kind),c("TEXCOORD_2",S.UV3Kind),c("TEXCOORD_3",S.UV4Kind),c("TEXCOORD_4",S.UV5Kind),c("TEXCOORD_5",S.UV6Kind),c("JOINTS_0",S.MatricesIndicesKind),c("WEIGHTS_0",S.MatricesWeightsKind),c("JOINTS_1",S.MatricesIndicesExtraKind),c("WEIGHTS_1",S.MatricesWeightsExtraKind),c("COLOR_0",S.ColorKind,u=>{u.type==="VEC4"&&(r.hasVertexAlpha=!0)}),Promise.all(a).then(()=>l)}_createMorphTargets(t,n,r,s,o){if(!s.targets||!this._parent.loadMorphTargets)return;if(n._numMorphTargets==null)n._numMorphTargets=s.targets.length;else if(s.targets.length!==n._numMorphTargets)throw new Error(`${t}: Primitives do not have the same number of targets`);let a=r.extras?r.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,o.morphTargetManager=new bw(this._babylonScene),o.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,o.morphTargetManager.areUpdatesFrozen=!0;for(let l=0;l<s.targets.length;l++){let c=n.weights?n.weights[l]:r.weights?r.weights[l]:0,u=a?a[l]:`morphTarget${l}`;o.morphTargetManager.addTarget(new jo(u,c,o.getScene()))}}_loadMorphTargetsAsync(t,n,r,s){if(!n.targets||!this._parent.loadMorphTargets)return Promise.resolve();let o=new Array,a=r.morphTargetManager;for(let l=0;l<a.numTargets;l++){let c=a.getTarget(l);o.push(this._loadMorphTargetVertexDataAsync(`${t}/targets/${l}`,s,n.targets[l],c))}return Promise.all(o).then(()=>{a.areUpdatesFrozen=!1})}_loadMorphTargetVertexDataAsync(t,n,r,s){return T(this,null,function*(){let o=new Array,a=(l,c,u)=>{if(r[l]==null)return;let h=n.getVertexBuffer(c);if(!h)return;let d=se.Get(`${t}/${l}`,this._gltf.accessors,r[l]);o.push(this._loadFloatAccessorAsync(`/accessors/${d.index}`,d).then(f=>{u(h,f)}))};return a("POSITION",S.PositionKind,(l,c)=>{let u=new Float32Array(c.length);l.forEach(c.length,(h,d)=>{u[d]=c[d]+h}),s.setPositions(u)}),a("NORMAL",S.NormalKind,(l,c)=>{let u=new Float32Array(c.length);l.forEach(u.length,(h,d)=>{u[d]=c[d]+h}),s.setNormals(u)}),a("TANGENT",S.TangentKind,(l,c)=>{let u=new Float32Array(c.length/3*4),h=0;l.forEach(c.length/3*4,(d,f)=>{(f+1)%4!==0&&(u[h]=c[h]+d,h++)}),s.setTangents(u)}),a("TEXCOORD_0",S.UVKind,(l,c)=>{let u=new Float32Array(c.length);l.forEach(c.length,(h,d)=>{u[d]=c[d]+h}),s.setUVs(u)}),a("TEXCOORD_1",S.UV2Kind,(l,c)=>{let u=new Float32Array(c.length);l.forEach(c.length,(h,d)=>{u[d]=c[d]+h}),s.setUV2s(u)}),a("COLOR_0",S.ColorKind,(l,c)=>{let u=null,h=l.getSize();if(h===3){u=new Float32Array(c.length/3*4),l.forEach(c.length,(d,f)=>{let p=Math.floor(f/3),g=f%3;u[4*p+g]=c[3*p+g]+d});for(let d=0;d<c.length/3;++d)u[4*d+3]=1}else if(h===4)u=new Float32Array(c.length),l.forEach(c.length,(d,f)=>{u[f]=c[f]+d});else throw new Error(`${t}: Invalid number of components (${h}) for COLOR_0 attribute`);s.setColors(u)}),yield Promise.all(o).then(()=>{})})}static _LoadTransform(t,n){if(t.skin!=null)return;let r=m.Zero(),s=J.Identity(),o=m.One();t.matrix?V.FromArray(t.matrix).decompose(o,s,r):(t.translation&&(r=m.FromArray(t.translation)),t.rotation&&(s=J.FromArray(t.rotation)),t.scale&&(o=m.FromArray(t.scale))),n.position=r,n.rotationQuaternion=s,n.scaling=o}_loadSkinAsync(t,n,r,s){if(!this._parent.loadSkins)return Promise.resolve();let o=this._extensionsLoadSkinAsync(t,n,r);if(o)return o;if(r._data)return s(r._data.babylonSkeleton),r._data.promise;let a=`skeleton${r.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;let l=new Ho(r.name||a,a,this._babylonScene);l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(t,r,l);let c=this._loadSkinInverseBindMatricesDataAsync(t,r).then(u=>{this._updateBoneMatrices(l,u)});return r._data={babylonSkeleton:l,promise:c},s(l),c}_loadBones(t,n,r){if(n.skeleton==null||this._parent.alwaysComputeSkeletonRootNode){let o=this._findSkeletonRootNode(`${t}/joints`,n.joints);if(o)if(n.skeleton===void 0)n.skeleton=o.index;else{let a=(c,u)=>{for(;u.parent;u=u.parent)if(u.parent===c)return!0;return!1},l=se.Get(`${t}/skeleton`,this._gltf.nodes,n.skeleton);l!==o&&!a(l,o)&&(N.Warn(`${t}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),n.skeleton=o.index)}else N.Warn(`${t}: Failed to find common root`)}let s={};for(let o of n.joints){let a=se.Get(`${t}/joints/${o}`,this._gltf.nodes,o);this._loadBone(a,n,r,s)}}_findSkeletonRootNode(t,n){if(n.length===0)return null;let r={};for(let o of n){let a=[],l=se.Get(`${t}/${o}`,this._gltf.nodes,o);for(;l.index!==-1;)a.unshift(l),l=l.parent;r[o]=a}let s=null;for(let o=0;;++o){let a=r[n[0]];if(o>=a.length)return s;let l=a[o];for(let c=1;c<n.length;++c)if(a=r[n[c]],o>=a.length||l!==a[o])return s;s=l}}_loadBone(t,n,r,s){t._isJoint=!0;let o=s[t.index];if(o)return o;let a=null;t.index!==n.skeleton&&(t.parent&&t.parent.index!==-1?a=this._loadBone(t.parent,n,r,s):n.skeleton!==void 0&&N.Warn(`/skins/${n.index}/skeleton: Skeleton node is not a common root`));let l=n.joints.indexOf(t.index);return o=new gr(t.name||`joint${t.index}`,r,a,this._getNodeMatrix(t),null,null,l),s[t.index]=o,this._postSceneLoadActions.push(()=>{o.linkTransformNode(t._babylonTransformNode)}),o}_loadSkinInverseBindMatricesDataAsync(t,n){if(n.inverseBindMatrices==null)return Promise.resolve(null);let r=se.Get(`${t}/inverseBindMatrices`,this._gltf.accessors,n.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${r.index}`,r)}_updateBoneMatrices(t,n){for(let r of t.bones){let s=V.Identity(),o=r._index;n&&o!==-1&&(V.FromArrayToRef(n,o*16,s),s.invertToRef(s));let a=r.getParent();a&&s.multiplyToRef(a.getAbsoluteInverseBindMatrix(),s),r.updateMatrix(s,!1,!1),r._updateAbsoluteBindMatrices(void 0,!1)}}_getNodeMatrix(t){return t.matrix?V.FromArray(t.matrix):V.Compose(t.scale?m.FromArray(t.scale):m.One(),t.rotation?J.FromArray(t.rotation):J.Identity(),t.translation?m.FromArray(t.translation):m.Zero())}loadCameraAsync(t,n,r=()=>{}){let s=this._extensionsLoadCameraAsync(t,n,r);if(s)return s;let o=new Array;this.logOpen(`${t} ${n.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;let a=new Ot(n.name||`camera${n.index}`,m.Zero(),this._babylonScene,!1);switch(a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n._babylonCamera=a,a.setTarget(new m(0,0,-1)),n.type){case"perspective":{let l=n.perspective;if(!l)throw new Error(`${t}: Camera perspective properties are missing`);a.fov=l.yfov,a.minZ=l.znear,a.maxZ=l.zfar||0;break}case"orthographic":{if(!n.orthographic)throw new Error(`${t}: Camera orthographic properties are missing`);a.mode=Ne.ORTHOGRAPHIC_CAMERA,a.orthoLeft=-n.orthographic.xmag,a.orthoRight=n.orthographic.xmag,a.orthoBottom=-n.orthographic.ymag,a.orthoTop=n.orthographic.ymag,a.minZ=n.orthographic.znear,a.maxZ=n.orthographic.zfar;break}default:throw new Error(`${t}: Invalid camera type (${n.type})`)}return i.AddPointerMetadata(a,t),this._parent.onCameraLoadedObservable.notifyObservers(a),r(a),this.logClose(),Promise.all(o).then(()=>a)}_loadAnimationsAsync(){this._parent._startPerformanceCounter("Load animations");let t=this._gltf.animations;if(!t)return Promise.resolve();let n=new Array;for(let r=0;r<t.length;r++){let s=t[r];n.push(this.loadAnimationAsync(`/animations/${s.index}`,s).then(o=>{o.targetedAnimations.length===0&&o.dispose()}))}return Promise.all(n).then(()=>{this._parent._endPerformanceCounter("Load animations")})}loadAnimationAsync(t,n){this._parent._startPerformanceCounter("Load animation");let r=this._extensionsLoadAnimationAsync(t,n);return r||Ik.value.then(({AnimationGroup:s})=>{this._babylonScene._blockEntityCollection=!!this._assetContainer;let o=new s(n.name||`animation${n.index}`,this._babylonScene);o._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n._babylonAnimationGroup=o;let a=new Array;se.Assign(n.channels),se.Assign(n.samplers);for(let l of n.channels)a.push(this._loadAnimationChannelAsync(`${t}/channels/${l.index}`,t,n,l,(c,u)=>{c.animations=c.animations||[],c.animations.push(u),o.addTargetedAnimation(u,c)}));return this._parent._endPerformanceCounter("Load animation"),Promise.all(a).then(()=>(o.normalize(0),o))})}_loadAnimationChannelAsync(t,n,r,s,o){let a=this._extensionsLoadAnimationChannelAsync(t,n,r,s,o);if(a)return a;if(s.target.node==null)return Promise.resolve();let l=se.Get(`${t}/target/node`,this._gltf.nodes,s.target.node),c=s.target.path,u=c==="weights";return u&&!l._numMorphTargets||!u&&!l._babylonTransformNode||!this._parent.loadNodeAnimations&&!u&&!l._isJoint?Promise.resolve():Ek.value.then(()=>{let h;switch(c){case"translation":{h=dc("/nodes/{}/translation")?.interpolation;break}case"rotation":{h=dc("/nodes/{}/rotation")?.interpolation;break}case"scale":{h=dc("/nodes/{}/scale")?.interpolation;break}case"weights":{h=dc("/nodes/{}/weights")?.interpolation;break}default:throw new Error(`${t}/target/path: Invalid value (${s.target.path})`)}if(!h)throw new Error(`${t}/target/path: Could not find interpolation properties for target path (${s.target.path})`);let d={object:l,info:h};return this._loadAnimationChannelFromTargetInfoAsync(t,n,r,s,d,o)})}_loadAnimationChannelFromTargetInfoAsync(t,n,r,s,o,a){let l=this.parent.targetFps,c=1/l,u=se.Get(`${t}/sampler`,r.samplers,s.sampler);return this._loadAnimationSamplerAsync(`${n}/samplers/${s.sampler}`,u).then(h=>{let d=0,f=o.object,p=o.info;for(let g of p){let _=g.getStride(f),y=h.input,C=h.output,E=new Array(y.length),I=0;switch(h.interpolation){case"STEP":{for(let v=0;v<y.length;v++){let x=g.getValue(f,C,I,1);I+=_,E[v]={frame:y[v]*l,value:x,interpolation:1}}break}case"CUBICSPLINE":{for(let v=0;v<y.length;v++){let x=g.getValue(f,C,I,c);I+=_;let b=g.getValue(f,C,I,1);I+=_;let D=g.getValue(f,C,I,c);I+=_,E[v]={frame:y[v]*l,inTangent:x,value:b,outTangent:D}}break}case"LINEAR":{for(let v=0;v<y.length;v++){let x=g.getValue(f,C,I,1);I+=_,E[v]={frame:y[v]*l,value:x}}break}}if(I>0){let v=`${r.name||`animation${r.index}`}_channel${s.index}_${d}`,x=g.buildAnimations(f,v,l,E);for(let b of x)d++,a(b.babylonAnimatable,b.babylonAnimation)}}})}_loadAnimationSamplerAsync(t,n){if(n._data)return n._data;let r=n.interpolation||"LINEAR";switch(r){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${t}/interpolation: Invalid value (${n.interpolation})`)}let s=se.Get(`${t}/input`,this._gltf.accessors,n.input),o=se.Get(`${t}/output`,this._gltf.accessors,n.output);return n._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${s.index}`,s),this._loadFloatAccessorAsync(`/accessors/${o.index}`,o)]).then(([a,l])=>({input:a,interpolation:r,output:l})),n._data}loadBufferAsync(t,n,r,s){let o=this._extensionsLoadBufferAsync(t,n,r,s);if(o)return o;if(!n._data)if(n.uri)n._data=this.loadUriAsync(`${t}/uri`,n,n.uri);else{if(!this._bin)throw new Error(`${t}: Uri is missing or the binary glTF is missing its binary chunk`);n._data=this._bin.readAsync(0,n.byteLength)}return n._data.then(a=>{try{return new Uint8Array(a.buffer,a.byteOffset+r,s)}catch(l){throw new Error(`${t}: ${l.message}`)}})}loadBufferViewAsync(t,n){let r=this._extensionsLoadBufferViewAsync(t,n);if(r)return r;if(n._data)return n._data;let s=se.Get(`${t}/buffer`,this._gltf.buffers,n.buffer);return n._data=this.loadBufferAsync(`/buffers/${s.index}`,s,n.byteOffset||0,n.byteLength),n._data}_loadAccessorAsync(t,n,r){if(n._data)return n._data;let s=i._GetNumComponents(t,n.type),o=s*S.GetTypeByteLength(n.componentType),a=s*n.count;if(n.bufferView==null)n._data=Promise.resolve(new r(a));else{let l=se.Get(`${t}/bufferView`,this._gltf.bufferViews,n.bufferView);n._data=this.loadBufferViewAsync(`/bufferViews/${l.index}`,l).then(c=>{if(n.componentType===5126&&!n.normalized&&(!l.byteStride||l.byteStride===o))return i._GetTypedArray(t,n.componentType,c,n.byteOffset,a);{let u=new r(a);return S.ForEach(c,n.byteOffset||0,l.byteStride||o,s,n.componentType,u.length,n.normalized||!1,(h,d)=>{u[d]=h}),u}})}if(n.sparse){let l=n.sparse;n._data=n._data.then(c=>{let u=c,h=se.Get(`${t}/sparse/indices/bufferView`,this._gltf.bufferViews,l.indices.bufferView),d=se.Get(`${t}/sparse/values/bufferView`,this._gltf.bufferViews,l.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${h.index}`,h),this.loadBufferViewAsync(`/bufferViews/${d.index}`,d)]).then(([f,p])=>{let g=i._GetTypedArray(`${t}/sparse/indices`,l.indices.componentType,f,l.indices.byteOffset,l.count),_=s*l.count,y;if(n.componentType===5126&&!n.normalized)y=i._GetTypedArray(`${t}/sparse/values`,n.componentType,p,l.values.byteOffset,_);else{let E=i._GetTypedArray(`${t}/sparse/values`,n.componentType,p,l.values.byteOffset,_);y=new r(_),S.ForEach(E,0,o,s,n.componentType,y.length,n.normalized||!1,(I,v)=>{y[v]=I})}let C=0;for(let E=0;E<g.length;E++){let I=g[E]*s;for(let v=0;v<s;v++)u[I++]=y[C++]}return u})})}return n._data}_loadFloatAccessorAsync(t,n){return this._loadAccessorAsync(t,n,Float32Array)}_loadIndicesAccessorAsync(t,n){if(n.type!=="SCALAR")throw new Error(`${t}/type: Invalid value ${n.type}`);if(n.componentType!==5121&&n.componentType!==5123&&n.componentType!==5125)throw new Error(`${t}/componentType: Invalid value ${n.componentType}`);if(n._data)return n._data;if(n.sparse){let r=i._GetTypedArrayConstructor(`${t}/componentType`,n.componentType);n._data=this._loadAccessorAsync(t,n,r)}else{let r=se.Get(`${t}/bufferView`,this._gltf.bufferViews,n.bufferView);n._data=this.loadBufferViewAsync(`/bufferViews/${r.index}`,r).then(s=>i._GetTypedArray(t,n.componentType,s,n.byteOffset,n.count))}return n._data}_loadVertexBufferViewAsync(t){if(t._babylonBuffer)return t._babylonBuffer;let n=this._babylonScene.getEngine();return t._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${t.index}`,t).then(r=>new Cn(n,r,!1)),t._babylonBuffer}_loadVertexAccessorAsync(t,n,r){if(n._babylonVertexBuffer?.[r])return n._babylonVertexBuffer[r];n._babylonVertexBuffer||(n._babylonVertexBuffer={});let s=this._babylonScene.getEngine();if(n.sparse||n.bufferView==null)n._babylonVertexBuffer[r]=this._loadFloatAccessorAsync(t,n).then(o=>new S(s,o,r,!1));else{let o=se.Get(`${t}/bufferView`,this._gltf.bufferViews,n.bufferView);n._babylonVertexBuffer[r]=this._loadVertexBufferViewAsync(o).then(a=>{let l=i._GetNumComponents(t,n.type);return new S(s,a,r,!1,void 0,o.byteStride,void 0,n.byteOffset,l,n.componentType,n.normalized,!0,void 0,!0)})}return n._babylonVertexBuffer[r]}_loadMaterialMetallicRoughnessPropertiesAsync(t,n,r){let s=new Array,o=this._getOrCreateMaterialAdapter(r);return n&&(n.baseColorFactor?(o.baseColor=G.FromArray(n.baseColorFactor),o.geometryOpacity=n.baseColorFactor[3]):o.baseColor=G.White(),o.baseMetalness=n.metallicFactor==null?1:n.metallicFactor,o.specularRoughness=n.roughnessFactor==null?1:n.roughnessFactor,n.baseColorTexture&&s.push(this.loadTextureInfoAsync(`${t}/baseColorTexture`,n.baseColorTexture,a=>{a.name=`${r.name} (Base Color)`,o.baseColorTexture=a})),n.metallicRoughnessTexture&&(n.metallicRoughnessTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${t}/metallicRoughnessTexture`,n.metallicRoughnessTexture,a=>{a.name=`${r.name} (Metallic Roughness)`,o.baseMetalnessTexture=a,o.specularRoughnessTexture=a})),o.useRoughnessFromMetallicTextureGreen=!0,o.useMetallicFromMetallicTextureBlue=!0)),Promise.all(s).then(()=>{})}_loadMaterialAsync(t,n,r,s,o=()=>{}){let a=this._extensionsLoadMaterialAsync(t,n,r,s,o);if(a)return a;n._data=n._data||{};let l=n._data[s];if(!l){this.logOpen(`${t} ${n.name||""}`);let c=this.createMaterial(t,n,s);l={babylonMaterial:c,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(t,n,c)},n._data[s]=l,i.AddPointerMetadata(c,t),this._parent.onMaterialLoadedObservable.notifyObservers(c),this.logClose()}return r&&(l.babylonMeshes.push(r),r.onDisposeObservable.addOnce(()=>{let c=l.babylonMeshes.indexOf(r);c!==-1&&l.babylonMeshes.splice(c,1)})),o(l.babylonMaterial),l.promise.then(()=>l.babylonMaterial)}_createDefaultMaterial(t,n){if(!this._pbrMaterialImpl)throw new Error("PBR Material class not loaded");this._babylonScene._blockEntityCollection=!!this._assetContainer;let r=new this._pbrMaterialImpl.materialClass(t,this._babylonScene);r._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,r.fillMode=n,r.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_OPAQUE;let s=this._getOrCreateMaterialAdapter(r);return s.transparencyAsAlphaCoverage=this._parent.transparencyAsCoverage,s.baseMetalness=1,s.specularRoughness=1,r}createMaterial(t,n,r){let s=this._extensionsCreateMaterial(t,n,r);if(s)return s;let o=n.name||`material${n.index}`;return this._createDefaultMaterial(o,r)}loadMaterialPropertiesAsync(t,n,r){let s=this._extensionsLoadMaterialPropertiesAsync(t,n,r);if(s)return s;let o=new Array;return o.push(this.loadMaterialBasePropertiesAsync(t,n,r)),n.pbrMetallicRoughness&&o.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${t}/pbrMetallicRoughness`,n.pbrMetallicRoughness,r)),this.loadMaterialAlphaProperties(t,n,r),Promise.all(o).then(()=>{})}loadMaterialBasePropertiesAsync(t,n,r){let s=new Array,o=this._getOrCreateMaterialAdapter(r);o.emissionColor=n.emissiveFactor?G.FromArray(n.emissiveFactor):new G(0,0,0),n.doubleSided&&(o.backFaceCulling=!1,o.twoSidedLighting=!0),n.normalTexture&&(n.normalTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${t}/normalTexture`,n.normalTexture,u=>{u.name=`${r.name} (Normal)`,o.geometryNormalTexture=u,n.normalTexture?.scale!=null&&(u.level=n.normalTexture.scale)})),o.setNormalMapInversions(!this._babylonScene.useRightHandedSystem,this._babylonScene.useRightHandedSystem));let a,l=1,c;return n.occlusionTexture&&(n.occlusionTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${t}/occlusionTexture`,n.occlusionTexture,u=>{u.name=`${r.name} (Occlusion)`,a=u})),n.occlusionTexture.strength!=null&&(l=n.occlusionTexture.strength)),n.emissiveTexture&&s.push(this.loadTextureInfoAsync(`${t}/emissiveTexture`,n.emissiveTexture,u=>{u.name=`${r.name} (Emissive)`,c=u})),Promise.all(s).then(()=>{a&&(o.ambientOcclusionTexture=a,o.ambientOcclusionTextureStrength=l),c&&(o.emissionColorTexture=c)})}loadMaterialAlphaProperties(t,n,r){if(!this._pbrMaterialImpl)throw new Error(`${t}: Material type not supported`);let s=this._getOrCreateMaterialAdapter(r),o=s.baseColorTexture;switch(n.alphaMode||"OPAQUE"){case"OPAQUE":{r.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_OPAQUE,r.alpha=1;break}case"MASK":{r.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_ALPHATEST,s.alphaCutOff=n.alphaCutoff==null?.5:n.alphaCutoff,o&&(o.hasAlpha=!0);break}case"BLEND":{r.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_ALPHABLEND,o&&(o.hasAlpha=!0,s.useAlphaFromBaseColorTexture=!0);break}default:throw new Error(`${t}/alphaMode: Invalid value (${n.alphaMode})`)}}loadTextureInfoAsync(t,n,r=()=>{}){let s=this._extensionsLoadTextureInfoAsync(t,n,r);if(s)return s;if(this.logOpen(`${t}`),n.texCoord>=6)throw new Error(`${t}/texCoord: Invalid value (${n.texCoord})`);let o=se.Get(`${t}/index`,this._gltf.textures,n.index);o._textureInfo=n;let a=this._loadTextureAsync(`/textures/${n.index}`,o,l=>{l.coordinatesIndex=n.texCoord||0,i.AddPointerMetadata(l,t),this._parent.onTextureLoadedObservable.notifyObservers(l),r(l)});return this.logClose(),a}_loadTextureAsync(t,n,r=()=>{}){let s=this._extensionsLoadTextureAsync(t,n,r);if(s)return s;this.logOpen(`${t} ${n.name||""}`);let o=n.sampler==null?i.DefaultSampler:se.Get(`${t}/sampler`,this._gltf.samplers,n.sampler),a=se.Get(`${t}/source`,this._gltf.images,n.source),l=this._createTextureAsync(t,o,a,r,void 0,!n._textureInfo.nonColorData);return this.logClose(),l}_createTextureAsync(t,n,r,s=()=>{},o,a){let l=this._loadSampler(`/samplers/${n.index}`,n),c=new Array,u=new fs;this._babylonScene._blockEntityCollection=!!this._assetContainer;let h={noMipmap:l.noMipMaps,invertY:!1,samplingMode:l.samplingMode,onLoad:()=>{this._disposed||u.resolve()},onError:(f,p)=>{this._disposed||u.reject(new Error(`${t}: ${p&&p.message?p.message:f||"Failed to load texture"}`))},mimeType:r.mimeType??NT(r.uri??""),loaderOptions:o,useSRGBBuffer:!!a&&this._parent.useSRGBBuffers},d=new te(null,this._babylonScene,h);return d._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,c.push(u.promise),c.push(this.loadImageAsync(`/images/${r.index}`,r).then(f=>{let p=r.uri||`${this._fileName}#image${r.index}`,g=`data:${this._uniqueRootUrl}${p}`;d.updateURL(g,f);let _=d.getInternalTexture();_&&(_.label=r.name)})),d.wrapU=l.wrapU,d.wrapV=l.wrapV,s(d),this._parent.useGltfTextureNames&&(d.name=r.name||r.uri||`image${r.index}`),Promise.all(c).then(()=>d)}_loadSampler(t,n){return n._data||(n._data={noMipMaps:n.minFilter===9728||n.minFilter===9729,samplingMode:i._GetTextureSamplingMode(t,n),wrapU:i._GetTextureWrapMode(`${t}/wrapS`,n.wrapS),wrapV:i._GetTextureWrapMode(`${t}/wrapT`,n.wrapT)}),n._data}loadImageAsync(t,n){if(!n._data){if(this.logOpen(`${t} ${n.name||""}`),n.uri)n._data=this.loadUriAsync(`${t}/uri`,n,n.uri);else{let r=se.Get(`${t}/bufferView`,this._gltf.bufferViews,n.bufferView);n._data=this.loadBufferViewAsync(`/bufferViews/${r.index}`,r)}this.logClose()}return n._data}loadUriAsync(t,n,r){let s=this._extensionsLoadUriAsync(t,n,r);if(s)return s;if(!i._ValidateUri(r))throw new Error(`${t}: '${r}' is invalid`);if(Rh(r)){let o=new Uint8Array(Ph(r));return this.log(`${t}: Decoded ${r.substring(0,64)}... (${o.length} bytes)`),Promise.resolve(o)}return this.log(`${t}: Loading ${r}`),this._parent.preprocessUrlAsync(this._rootUrl+r).then(o=>new Promise((a,l)=>{this._parent._loadFile(this._babylonScene,o,c=>{this._disposed||(this.log(`${t}: Loaded ${r} (${c.byteLength} bytes)`),a(new Uint8Array(c)))},!0,c=>{l(new OT(`${t}: Failed to load '${r}'${c?": "+c.status+" "+c.statusText:""}`,c))})}))}static AddPointerMetadata(t,n){t.metadata=t.metadata||{};let r=t._internalMetadata=t._internalMetadata||{},s=r.gltf=r.gltf||{};(s.pointers=s.pointers||[]).push(n)}static _GetTextureWrapMode(t,n){switch(n=n??10497,n){case 33071:return te.CLAMP_ADDRESSMODE;case 33648:return te.MIRROR_ADDRESSMODE;case 10497:return te.WRAP_ADDRESSMODE;default:return N.Warn(`${t}: Invalid value (${n})`),te.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(t,n){let r=n.magFilter==null?9729:n.magFilter,s=n.minFilter==null?9987:n.minFilter;if(r===9729)switch(s){case 9728:return te.LINEAR_NEAREST;case 9729:return te.LINEAR_LINEAR;case 9984:return te.LINEAR_NEAREST_MIPNEAREST;case 9985:return te.LINEAR_LINEAR_MIPNEAREST;case 9986:return te.LINEAR_NEAREST_MIPLINEAR;case 9987:return te.LINEAR_LINEAR_MIPLINEAR;default:return N.Warn(`${t}/minFilter: Invalid value (${s})`),te.LINEAR_LINEAR_MIPLINEAR}else switch(r!==9728&&N.Warn(`${t}/magFilter: Invalid value (${r})`),s){case 9728:return te.NEAREST_NEAREST;case 9729:return te.NEAREST_LINEAR;case 9984:return te.NEAREST_NEAREST_MIPNEAREST;case 9985:return te.NEAREST_LINEAR_MIPNEAREST;case 9986:return te.NEAREST_NEAREST_MIPLINEAR;case 9987:return te.NEAREST_LINEAR_MIPLINEAR;default:return N.Warn(`${t}/minFilter: Invalid value (${s})`),te.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(t,n){try{return fT(n)}catch(r){throw new Error(`${t}: ${r.message}`)}}static _GetTypedArray(t,n,r,s,o){let a=r.buffer;s=r.byteOffset+(s||0);let l=i._GetTypedArrayConstructor(`${t}/componentType`,n),c=S.GetTypeByteLength(n);return s%c!==0?(N.Warn(`${t}: Copying buffer as byte offset (${s}) is not a multiple of component type byte length (${c})`),new l(a.slice(s,s+o*c),0)):new l(a,s,o)}static _GetNumComponents(t,n){switch(n){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${t}: Invalid type (${n})`)}static _ValidateUri(t){return z.IsBase64(t)||t.indexOf("..")===-1}static _GetDrawMode(t,n){switch(n==null&&(n=4),n){case 0:return Oe.PointListDrawMode;case 1:return Oe.LineListDrawMode;case 2:return Oe.LineLoopDrawMode;case 3:return Oe.LineStripDrawMode;case 4:return Oe.TriangleFillMode;case 5:return Oe.TriangleStripDrawMode;case 6:return Oe.TriangleFanDrawMode}throw new Error(`${t}: Invalid mesh primitive mode (${n})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");let t=new Array;if(this._gltf.materials){for(let n of this._gltf.materials)if(n._data)for(let r in n._data){let s=n._data[r];for(let o of s.babylonMeshes){o.computeWorldMatrix(!0);let a=s.babylonMaterial;t.push(a.forceCompilationAsync(o)),t.push(a.forceCompilationAsync(o,{useInstances:!0})),this._parent.useClipPlane&&(t.push(a.forceCompilationAsync(o,{clipPlane:!0})),t.push(a.forceCompilationAsync(o,{clipPlane:!0,useInstances:!0})))}}}return Promise.all(t).then(()=>{this._parent._endPerformanceCounter("Compile materials")})}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");let t=new Array,n=this._babylonScene.lights;for(let r of n){let s=r.getShadowGenerator();s&&t.push(s.forceCompilationAsync())}return Promise.all(t).then(()=>{this._parent._endPerformanceCounter("Compile shadow generators")})}_forEachExtensions(t){for(let n of this._extensions)n.enabled&&t(n)}_applyExtensions(t,n,r){for(let s of this._extensions)if(s.enabled){let o=`${s.name}.${n}`,a=t;a._activeLoaderExtensionFunctions=a._activeLoaderExtensionFunctions||{};let l=a._activeLoaderExtensionFunctions;if(!l[o]){l[o]=!0;try{let c=r(s);if(c)return c}finally{delete l[o]}}}return null}_extensionsOnLoading(){this._forEachExtensions(t=>t.onLoading&&t.onLoading())}_extensionsOnReady(){this._forEachExtensions(t=>t.onReady&&t.onReady())}_extensionsLoadSceneAsync(t,n){return this._applyExtensions(n,"loadScene",r=>r.loadSceneAsync&&r.loadSceneAsync(t,n))}_extensionsLoadNodeAsync(t,n,r){return this._applyExtensions(n,"loadNode",s=>s.loadNodeAsync&&s.loadNodeAsync(t,n,r))}_extensionsLoadCameraAsync(t,n,r){return this._applyExtensions(n,"loadCamera",s=>s.loadCameraAsync&&s.loadCameraAsync(t,n,r))}_extensionsLoadVertexDataAsync(t,n,r){return this._applyExtensions(n,"loadVertexData",s=>s._loadVertexDataAsync&&s._loadVertexDataAsync(t,n,r))}_extensionsLoadMeshPrimitiveAsync(t,n,r,s,o,a){return this._applyExtensions(o,"loadMeshPrimitive",l=>l._loadMeshPrimitiveAsync&&l._loadMeshPrimitiveAsync(t,n,r,s,o,a))}_extensionsLoadMaterialAsync(t,n,r,s,o){return this._applyExtensions(n,"loadMaterial",a=>a._loadMaterialAsync&&a._loadMaterialAsync(t,n,r,s,o))}_extensionsCreateMaterial(t,n,r){return this._applyExtensions(n,"createMaterial",s=>s.createMaterial&&s.createMaterial(t,n,r))}_extensionsLoadMaterialPropertiesAsync(t,n,r){return this._applyExtensions(n,"loadMaterialProperties",s=>s.loadMaterialPropertiesAsync&&s.loadMaterialPropertiesAsync(t,n,r))}_extensionsLoadTextureInfoAsync(t,n,r){return this._applyExtensions(n,"loadTextureInfo",s=>s.loadTextureInfoAsync&&s.loadTextureInfoAsync(t,n,r))}_extensionsLoadTextureAsync(t,n,r){return this._applyExtensions(n,"loadTexture",s=>s._loadTextureAsync&&s._loadTextureAsync(t,n,r))}_extensionsLoadAnimationAsync(t,n){return this._applyExtensions(n,"loadAnimation",r=>r.loadAnimationAsync&&r.loadAnimationAsync(t,n))}_extensionsLoadAnimationChannelAsync(t,n,r,s,o){return this._applyExtensions(r,"loadAnimationChannel",a=>a._loadAnimationChannelAsync&&a._loadAnimationChannelAsync(t,n,r,s,o))}_extensionsLoadSkinAsync(t,n,r){return this._applyExtensions(r,"loadSkin",s=>s._loadSkinAsync&&s._loadSkinAsync(t,n,r))}_extensionsLoadUriAsync(t,n,r){return this._applyExtensions(n,"loadUri",s=>s._loadUriAsync&&s._loadUriAsync(t,n,r))}_extensionsLoadBufferViewAsync(t,n){return this._applyExtensions(n,"loadBufferView",r=>r.loadBufferViewAsync&&r.loadBufferViewAsync(t,n))}_extensionsLoadBufferAsync(t,n,r,s){return this._applyExtensions(n,"loadBuffer",o=>o.loadBufferAsync&&o.loadBufferAsync(t,n,r,s))}static LoadExtensionAsync(t,n,r,s){if(!n.extensions)return null;let a=n.extensions[r];return a?s(`${t}/extensions/${r}`,a):null}static LoadExtraAsync(t,n,r,s){if(!n.extras)return null;let a=n.extras[r];return a?s(`${t}/extras/${r}`,a):null}isExtensionUsed(t){return!!this._gltf.extensionsUsed&&this._gltf.extensionsUsed.indexOf(t)!==-1}logOpen(t){this._parent._logOpen(t)}logClose(){this._parent._logClose()}log(t){this._parent._log(t)}startPerformanceCounter(t){this._parent._startPerformanceCounter(t)}endPerformanceCounter(t){this._parent._endPerformanceCounter(t)}}return i.DefaultSampler={index:-1},i})();Br._CreateGLTF2Loader=i=>new me(i);var Cw=.8,mn=class i extends xa{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;let t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(V.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,n){let r="";for(let s of e)r+=s;return new i(r,t,null,n,e)}static CreateFromPrefilteredData(e,t,n=null,r=!0){let s=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;let o=new i(e,t,null,!1,null,null,null,void 0,!0,n,r);return t.useDelayedTextureLoading=s,o}constructor(e,t,n=null,r=!1,s=null,o=null,a=null,l=5,c=!1,u=null,h=!1,d=Cw,f=0,p,g){super(t),this.onLoadObservable=new B,this.boundingBoxPosition=m.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this._textureMatrixRefraction=new V,this._buffer=null,this.name=e,this.url=e,this._noMipmap=r,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=V.Identity(),this.coordinatesMode=te.CUBIC_MODE;let _=null,y=null;n!==null&&!Array.isArray(n)?(_=n.extensions??null,this._noMipmap=n.noMipmap??!1,s=n.files??null,y=n.buffer??null,this._format=n.format??5,c=n.prefiltered??!1,u=n.forcedExtension??null,this._createPolynomials=n.createPolynomials??!1,this._lodScale=n.lodScale??Cw,this._lodOffset=n.lodOffset??0,this._loaderOptions=n.loaderOptions,this._useSRGBBuffer=n.useSRGBBuffer,o=n.onLoad??null,a=n.onError??null):(this._noMipmap=r,this._format=l,this._createPolynomials=h,_=n,this._loaderOptions=p,this._useSRGBBuffer=g,this._lodScale=d,this._lodOffset=f),!(!e&&!s)&&this.updateURL(e,u,o,c,a,_,this.getScene()?.useDelayedTextureLoading,s,y)}getClassName(){return"CubeTexture"}updateURL(e,t=null,n=null,r=!1,s=null,o=null,a=!1,l=null,c=null){(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,t&&(this._forcedExtension=t);let u=e.lastIndexOf("."),h=t||(u>-1?e.substring(u).toLowerCase():""),d=h.indexOf(".dds")===0,f=h.indexOf(".env")===0,p=h.indexOf(".basis")===0;if(f?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=r,r&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),l)this._files=l;else if(!p&&!f&&!d&&!o&&(o=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,o){for(let g=0;g<o.length;g++)this._files.push(e+o[g]);this._extensions=o}this._buffer=c,a?(this.delayLoadState=4,this._delayedOnLoad=n,this._delayedOnError=s):this._loadTexture(n,s)}delayLoad(e){this.delayLoadState===4&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){if(e.updateFlag===this._textureMatrix.updateFlag||(e.isIdentity()!==this._textureMatrix.isIdentity()&&this.getScene()?.markAllMaterialsAsDirty(1,s=>s.getActiveTextures().indexOf(this)!==-1),this._textureMatrix=e,!this.getScene()?.useRightHandedSystem))return;let t=U.Vector3[0],n=U.Quaternion[0],r=U.Vector3[1];this._textureMatrix.decompose(t,n,r),n.z*=-1,n.w*=-1,V.ComposeToRef(t,n,r,this._textureMatrixRefraction)}getRefractionTextureMatrix(){return this.getScene()?.useRightHandedSystem?this._textureMatrixRefraction:this._textureMatrix}_loadTexture(e=null,t=null){let n=this.getScene(),r=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);let s=()=>{this.onLoadObservable.notifyObservers(this),r&&(r.dispose(),this.getScene()?.markAllMaterialsAsDirty(1)),e&&e()},o=(a,l)=>{this._loadingError=!0,this._errorObject={message:a,exception:l},t&&t(a,l),te.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?z.SetImmediate(()=>s()):this._texture.onLoadedObservable.add(()=>s()):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,n,this._lodScale,this._lodOffset,e,o,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,n,this._files,this._noMipmap,e,o,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer,this._buffer),this._texture?.onLoadedObservable.add(()=>this.onLoadObservable.notifyObservers(this)))}static Parse(e,t,n){let r=Xe.Parse(()=>{let s=!1;return e.prefiltered&&(s=e.prefiltered),new i(n+(e.url??e.name),t,e.extensions,!1,e.files||null,null,null,void 0,s,e.forcedExtension)},e,t);if(e.boundingBoxPosition&&(r.boundingBoxPosition=m.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(r.boundingBoxSize=m.FromArray(e.boundingBoxSize)),e.animations)for(let s=0;s<e.animations.length;s++){let o=e.animations[s],a=Ct("BABYLON.Animation");a&&r.animations.push(a.Parse(o))}return r}clone(){let e=0,t=Xe.Clone(()=>{let n=new i(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=n.uniqueId,n},this);return t.uniqueId=e,t}};w([L()],mn.prototype,"url",void 0);w([yn()],mn.prototype,"boundingBoxPosition",void 0);w([yn()],mn.prototype,"boundingBoxSize",null);w([L("rotationY")],mn.prototype,"rotationY",null);w([L("files")],mn.prototype,"_files",void 0);w([L("forcedExtension")],mn.prototype,"_forcedExtension",void 0);w([L("extensions")],mn.prototype,"_extensions",void 0);w([yg("textureMatrix")],mn.prototype,"_textureMatrix",void 0);w([yg("textureMatrixRefraction")],mn.prototype,"_textureMatrixRefraction",void 0);te._CubeTextureParser=mn.Parse;ue("BABYLON.CubeTexture",mn);var xp=class i extends mn{constructor(e,t,n,r=5,s=0,o=!1,a=!1,l=3,c=null){super("",e),this._texture=e.getEngine().createRawCubeTexture(t,n,r,s,o,a,l,c)}update(e,t,n,r,s=null){this._texture.getEngine().updateRawCubeTexture(this._texture,e,t,n,r,s)}updateRGBDAsync(e,t=null,n=.8,r=0){return RT(this._texture,e,t,n,r).then(()=>{})}clone(){return Xe.Clone(()=>{let e=this.getScene(),t=this._texture,n=new i(e,t._bufferViewArray,t.width,t.format,t.type,t.generateMipMaps,t.invertY,t.samplingMode,t._compression);return t.source===13&&n.updateRGBDAsync(t._bufferViewArrayArray,t._sphericalPolynomial,t._lodGenerationScale,t._lodGenerationOffset),n},this)}};var Cp="EXT_lights_image_based",wb=class{constructor(e){this.name=Cp,this._loader=e,this.enabled=this._loader.isExtensionUsed(Cp)}dispose(){this._loader=null,delete this._lights}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._lights=t.lights}}loadSceneAsync(e,t){return me.LoadExtensionAsync(e,t,this.name,(n,r)=>T(this,null,function*(){this._loader._allMaterialsDirtyRequired=!0;let s=new Array;s.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(`${n}`);let o=se.Get(`${n}/light`,this._lights,r.light);return s.push(this._loadLightAsync(`/extensions/${this.name}/lights/${r.light}`,o).then(a=>{this._loader.babylonScene.environmentTexture=a})),this._loader.logClose(),yield Promise.all(s).then(()=>{})}))}_loadLightAsync(e,t){if(!t._loaded){let n=new Array;this._loader.logOpen(`${e}`);let r=new Array(t.specularImages.length);for(let s=0;s<t.specularImages.length;s++){let o=t.specularImages[s];r[s]=new Array(o.length);for(let a=0;a<o.length;a++){let l=`${e}/specularImages/${s}/${a}`;this._loader.logOpen(`${l}`);let c=o[a],u=se.Get(l,this._loader.gltf.images,c);n.push(this._loader.loadImageAsync(`/images/${c}`,u).then(h=>{r[s][a]=h})),this._loader.logClose()}}this._loader.logClose(),t._loaded=Promise.all(n).then(()=>T(this,null,function*(){let s=new xp(this._loader.babylonScene,null,t.specularImageSize);if(s.name=t.name||"environment",t._babylonTexture=s,t.intensity!=null&&(s.level=t.intensity),t.rotation){let c=J.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(c=J.Inverse(c)),V.FromQuaternionToRef(c,s.getReflectionTextureMatrix())}if(!t.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);let o=lT.FromArray(t.irradianceCoefficients);o.scaleInPlace(t.intensity),o.convertIrradianceToLambertianRadiance();let a=cT.FromHarmonics(o),l=(r.length-1)/Math.log2(t.specularImageSize);return yield s.updateRGBDAsync(r,a,l)}))}return t._loaded.then(()=>t._babylonTexture)}};he(Cp);fe(Cp,!0,i=>new wb(i));A.prototype.thinInstanceAdd=function(i,e=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return N.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(i)?i.length:1);let t=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(i))for(let n=0;n<i.length;++n)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,i[n],n===i.length-1&&e);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,i,e);return t};A.prototype.thinInstanceAddSelf=function(i=!0){return this.thinInstanceAdd(V.IdentityReadOnly,i)};A.prototype.thinInstanceRegisterAttribute=function(i,e){i===S.ColorKind&&(i=S.ColorInstanceKind),this.removeVerticesData(i),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[i]=e,this._userThinInstanceBuffersStorage.sizes[i]=e*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[i]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[i]),this._userThinInstanceBuffersStorage.vertexBuffers[i]=new S(this.getEngine(),this._userThinInstanceBuffersStorage.data[i],i,!0,!1,e,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[i])};A.prototype.thinInstanceSetMatrixAt=function(i,e,t=!0){if(!this._thinInstanceDataStorage.matrixData||i>=this._thinInstanceDataStorage.instancesCount)return!1;let n=this._thinInstanceDataStorage.matrixData;return e.copyToArray(n,i*16),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[i]=e),t&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0};A.prototype.thinInstanceSetAttributeAt=function(i,e,t,n=!0){return i===S.ColorKind&&(i=S.ColorInstanceKind),!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[i]||e>=this._thinInstanceDataStorage.instancesCount?!1:(this._thinInstanceUpdateBufferSize(i,0),this._userThinInstanceBuffersStorage.data[i].set(t,e*this._userThinInstanceBuffersStorage.strides[i]),n&&this.thinInstanceBufferUpdated(i),!0)};Object.defineProperty(A.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(i){let e=this._thinInstanceDataStorage.matrixData??this.source?._thinInstanceDataStorage.matrixData,t=e?e.length/16:0;i<=t&&(this._thinInstanceDataStorage.instancesCount=i)},enumerable:!0,configurable:!0});A.prototype._thinInstanceCreateMatrixBuffer=function(i,e,t=!0){let n=new Cn(this.getEngine(),e,!t,16,!1,!0);for(let r=0;r<4;r++)this.setVerticesBuffer(n.createVertexBuffer(i+r,r*4,4));return n};A.prototype.thinInstanceSetBuffer=function(i,e,t=0,n=!0){if(t=t||16,i==="matrix")this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=e?e.length:32*t,this._thinInstanceDataStorage.matrixData=e,this._thinInstanceDataStorage.worldMatrices=null,e!==null?(this._thinInstanceDataStorage.instancesCount=e.length/t,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",e,n),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo());else if(i==="previousMatrix")this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=e,e!==null&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",e,n));else if(i==="splatIndex"&&e){this._thinInstanceInitializeUserStorage(),this._thinInstanceDataStorage.instancesCount=e.length/t,this._userThinInstanceBuffersStorage.data[i]=e,this._userThinInstanceBuffersStorage.strides[i]=t,this._userThinInstanceBuffersStorage.sizes[i]=e.length;let r=new Cn(this.getEngine(),e,!0,16,!1,!0);this._thinInstanceDataStorage.matrixBuffer=r;for(let s=0;s<4;s++)this.setVerticesBuffer(r.createVertexBuffer(i+s,s*4,4))}else i===S.ColorKind&&(i=S.ColorInstanceKind),e===null?this._userThinInstanceBuffersStorage?.data[i]&&(this.removeVerticesData(i),delete this._userThinInstanceBuffersStorage.data[i],delete this._userThinInstanceBuffersStorage.strides[i],delete this._userThinInstanceBuffersStorage.sizes[i],delete this._userThinInstanceBuffersStorage.vertexBuffers[i]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[i]=e,this._userThinInstanceBuffersStorage.strides[i]=t,this._userThinInstanceBuffersStorage.sizes[i]=e.length,this._userThinInstanceBuffersStorage.vertexBuffers[i]=new S(this.getEngine(),e,i,!n,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[i]))};A.prototype.thinInstanceBufferUpdated=function(i){i==="matrix"?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.matrixBuffer&&!this._thinInstanceDataStorage.matrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(i),this._thinInstanceDataStorage.matrixBuffer?.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount)):i==="previousMatrix"?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.previousMatrixBuffer&&!this._thinInstanceDataStorage.previousMatrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(i),this._thinInstanceDataStorage.previousMatrixBuffer?.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount)):i==="splatIndex"?this._thinInstanceDataStorage.matrixBuffer?.updateDirectly(this._userThinInstanceBuffersStorage.data[i],0,this._thinInstanceDataStorage.instancesCount):(i===S.ColorKind&&(i=S.ColorInstanceKind),this._userThinInstanceBuffersStorage?.vertexBuffers[i]&&(this.thinInstanceAllowAutomaticStaticBufferRecreation&&!this._userThinInstanceBuffersStorage.vertexBuffers[i].isUpdatable()&&this._thinInstanceRecreateBuffer(i),this._userThinInstanceBuffersStorage.vertexBuffers[i].updateDirectly(this._userThinInstanceBuffersStorage.data[i],0)))};A.prototype.thinInstancePartialBufferUpdate=function(i,e,t){i==="matrix"?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(e,t):(i===S.ColorKind&&(i=S.ColorInstanceKind),this._userThinInstanceBuffersStorage?.vertexBuffers[i]&&this._userThinInstanceBuffersStorage.vertexBuffers[i].updateDirectly(e,t))};A.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];let i=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=[];for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e)this._thinInstanceDataStorage.worldMatrices[e]=V.FromArray(i,e*16)}return this._thinInstanceDataStorage.worldMatrices};A.prototype.thinInstanceRefreshBoundingInfo=function(i=!1,e=!1,t=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;let n=this._thinInstanceDataStorage.boundingVectors;if(i||!this.rawBoundingInfo){n.length=0,this.refreshBoundingInfo(e,t);let o=this.getBoundingInfo();this.rawBoundingInfo=new Xr(o.minimum,o.maximum)}let r=this.getBoundingInfo(),s=this._thinInstanceDataStorage.matrixData;if(n.length===0)for(let o=0;o<r.boundingBox.vectors.length;++o)n.push(r.boundingBox.vectors[o].clone());U.Vector3[0].setAll(Number.POSITIVE_INFINITY),U.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let o=0;o<this._thinInstanceDataStorage.instancesCount;++o){V.FromArrayToRef(s,o*16,U.Matrix[0]);for(let a=0;a<n.length;++a)m.TransformCoordinatesToRef(n[a],U.Matrix[0],U.Vector3[2]),U.Vector3[0].minimizeInPlace(U.Vector3[2]),U.Vector3[1].maximizeInPlace(U.Vector3[2])}r.reConstruct(U.Vector3[0],U.Vector3[1]),this._updateBoundingInfo()};A.prototype._thinInstanceRecreateBuffer=function(i,e=!0){i==="matrix"?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",this._thinInstanceDataStorage.matrixData,e)):i==="previousMatrix"?this._scene.needsPreviousWorldMatrices&&(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.previousMatrixData??this._thinInstanceDataStorage.matrixData,e)):(i===S.ColorKind&&(i=S.ColorInstanceKind),this._userThinInstanceBuffersStorage.vertexBuffers[i]?.dispose(),this._userThinInstanceBuffersStorage.vertexBuffers[i]=new S(this.getEngine(),this._userThinInstanceBuffersStorage.data[i],i,!e,!1,this._userThinInstanceBuffersStorage.strides[i],!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[i]))};A.prototype._thinInstanceUpdateBufferSize=function(i,e=1){i===S.ColorKind&&(i=S.ColorInstanceKind);let t=i==="matrix";if(!t&&(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.strides[i]))return;let n=t?16:this._userThinInstanceBuffersStorage.strides[i],r=t?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[i],s=t?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[i],o=(this._thinInstanceDataStorage.instancesCount+e)*n,a=r;for(;a<o;)a*=2;if(!s||r!=a){if(!s)s=new Float32Array(a);else{let l=new Float32Array(a);l.set(s,0),s=l}t?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",s,!1),this._thinInstanceDataStorage.matrixData=s,this._thinInstanceDataStorage.matrixBufferSize=a,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",s,!1))):(this._userThinInstanceBuffersStorage.vertexBuffers[i]?.dispose(),this._userThinInstanceBuffersStorage.data[i]=s,this._userThinInstanceBuffersStorage.sizes[i]=a,this._userThinInstanceBuffersStorage.vertexBuffers[i]=new S(this.getEngine(),s,i,!0,!1,n,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[i]))}};A.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})};A.prototype._disposeThinInstanceSpecificData=function(){this._thinInstanceDataStorage?.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null),this._thinInstanceDataStorage?.previousMatrixBuffer&&(this._thinInstanceDataStorage.previousMatrixBuffer.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null)};var Tp="EXT_mesh_gpu_instancing",Mb=class{constructor(e){this.name=Tp,this._loader=e,this.enabled=this._loader.isExtensionUsed(Tp)}dispose(){this._loader=null}loadNodeAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){this._loader._disableInstancedMesh++;let o=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,n);if(this._loader._disableInstancedMesh--,!t._primitiveBabylonMeshes)return yield o;let a=new Array,l=0,c=u=>{if(s.attributes[u]==null){a.push(Promise.resolve(null));return}let h=se.Get(`${r}/attributes/${u}`,this._loader.gltf.accessors,s.attributes[u]);if(a.push(this._loader._loadFloatAccessorAsync(`/accessors/${h.bufferView}`,h)),l===0)l=h.count;else if(l!==h.count)throw new Error(`${r}/attributes: Instance buffer accessors do not have the same count.`)};return c("TRANSLATION"),c("ROTATION"),c("SCALE"),c("_COLOR_0"),yield o.then(u=>T(this,null,function*(){let[h,d,f,p]=yield Promise.all(a),g=new Float32Array(l*16);U.Vector3[0].copyFromFloats(0,0,0),U.Quaternion[0].copyFromFloats(0,0,0,1),U.Vector3[1].copyFromFloats(1,1,1);for(let _=0;_<l;++_)h&&m.FromArrayToRef(h,_*3,U.Vector3[0]),d&&J.FromArrayToRef(d,_*4,U.Quaternion[0]),f&&m.FromArrayToRef(f,_*3,U.Vector3[1]),V.ComposeToRef(U.Vector3[1],U.Quaternion[0],U.Vector3[0],U.Matrix[0]),U.Matrix[0].copyToArray(g,_*16);for(let _ of t._primitiveBabylonMeshes)_.thinInstanceSetBuffer("matrix",g,16,!0),p&&(p.length===l*3?_.thinInstanceSetBuffer("color",p,3,!0):p.length===l*4?_.thinInstanceSetBuffer("color",p,4,!0):N.Warn("Unexpected size of _COLOR_0 attribute for mesh "+_.name));return u}))}))}};he(Tp);fe(Tp,!0,i=>new Mb(i));var Db=0,Sp=null,Dl=class i{static get Default(){return i._Default||(i._Default=new i),i._Default}constructor(){let e=i.Configuration.decoder;this._decoderModulePromise=z.LoadBabylonScriptAsync(e.url).then(()=>MeshoptDecoder.ready)}dispose(){delete this._decoderModulePromise}decodeGltfBufferAsync(e,t,n,r,s){return T(this,null,function*(){yield this._decoderModulePromise,Db===0&&(MeshoptDecoder.useWorkers(1),Db=1);let o=yield MeshoptDecoder.decodeGltfBufferAsync(t,n,e,r,s);return Sp!==null&&clearTimeout(Sp),Sp=setTimeout(()=>{MeshoptDecoder.useWorkers(0),Db=0,Sp=null},1e3),o})}};Dl.Configuration={decoder:{url:`${z._DefaultCdnUrl}/meshopt_decoder.js`}};Dl._Default=null;var Ip="EXT_meshopt_compression",Rb=class{constructor(e){this.name=Ip,this.enabled=e.isExtensionUsed(Ip),this._loader=e}dispose(){this._loader=null}loadBufferViewAsync(e,t){return me.LoadExtensionAsync(e,t,this.name,(n,r)=>T(this,null,function*(){let s=t;if(s._meshOptData)return yield s._meshOptData;let o=se.Get(`${e}/buffer`,this._loader.gltf.buffers,r.buffer);return s._meshOptData=this._loader.loadBufferAsync(`/buffers/${o.index}`,o,r.byteOffset||0,r.byteLength).then(a=>T(this,null,function*(){return yield Dl.Default.decodeGltfBufferAsync(a,r.count,r.byteStride,r.mode,r.filter)})),yield s._meshOptData}))}};he(Ip);fe(Ip,!0,i=>new Rb(i));var Ep="EXT_texture_webp",Pb=class{constructor(e){this.name=Ep,this._loader=e,this.enabled=e.isExtensionUsed(Ep)}dispose(){this._loader=null}_loadTextureAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){let o=t.sampler==null?me.DefaultSampler:se.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=se.Get(`${r}/source`,this._loader.gltf.images,s.source);return yield this._loader._createTextureAsync(e,o,a,l=>{n(l)},void 0,!t._textureInfo.nonColorData)}))}};he(Ep);fe(Ep,!0,i=>new Pb(i));var Ap="EXT_texture_avif",Ob=class{constructor(e){this.name=Ap,this._loader=e,this.enabled=e.isExtensionUsed(Ap)}dispose(){this._loader=null}_loadTextureAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){let o=t.sampler==null?me.DefaultSampler:se.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=se.Get(`${r}/source`,this._loader.gltf.images,s.source);return yield this._loader._createTextureAsync(e,o,a,l=>{n(l)},void 0,!t._textureInfo.nonColorData)}))}};he(Ap);fe(Ap,!0,i=>new Ob(i));var wp="EXT_lights_ies",Nb=class{constructor(e){this.name=wp,this._loader=e,this.enabled=this._loader.isExtensionUsed(wp)}dispose(){this._loader=null,delete this._lights}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._lights=t.lights,se.Assign(this._lights)}}loadNodeAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){this._loader._allMaterialsDirtyRequired=!0;let o,a,l=yield this._loader.loadNodeAsync(e,t,u=>{a=se.Get(r,this._lights,s.light);let h=a.name||u.name;this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,o=new Ts(h,m.Zero(),m.Backward(),0,1,this._loader.babylonScene),o.angle=Math.PI/2,o.innerAngle=0,o._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,a._babylonLight=o,o.falloffType=an.FALLOFF_GLTF,o.diffuse=s.color?G.FromArray(s.color):G.White(),o.intensity=s.multiplier||1,o.range=Number.MAX_VALUE,o.parent=u,this._loader._babylonLights.push(o),me.AddPointerMetadata(o,r),n(u)}),c;if(a.uri)c=yield this._loader.loadUriAsync(e,a,a.uri);else{let u=se.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,a.bufferView);c=yield this._loader.loadBufferViewAsync(`/bufferViews/${u.index}`,u)}return o.iesProfileTexture=new te(name+"_iesProfile",this._loader.babylonScene,!0,!1,void 0,null,null,c,!0,void 0,void 0,void 0,void 0,".ies"),l}))}};he(wp);fe(wp,!0,i=>new Nb(i));function Mp(i,e,t,n,r){let s=i,o=null,a=null,l=null;try{o=new s.Decoder,a=new s.DecoderBuffer,a.Init(e,e.byteLength);let c,u=o.GetEncodedGeometryType(a);switch(u){case s.TRIANGULAR_MESH:{let f=new s.Mesh;if(c=o.DecodeBufferToMesh(a,f),!c.ok()||f.ptr===0)throw new Error(c.error_msg());let g=f.num_faces()*3,_=g*4,y=s._malloc(_);try{o.GetTrianglesUInt32Array(f,_,y);let C=new Uint32Array(g);C.set(new Uint32Array(s.HEAPF32.buffer,y,g)),n(C)}finally{s._free(y)}l=f;break}case s.POINT_CLOUD:{let f=new s.PointCloud;if(c=o.DecodeBufferToPointCloud(a,f),!c.ok()||!f.ptr)throw new Error(c.error_msg());l=f;break}default:throw new Error(`Invalid geometry type ${u}`)}let h=l.num_points(),d=(f,p,g,_)=>{let y=_.data_type(),C=_.num_components(),E=_.normalized(),I=_.byte_stride(),v=_.byte_offset(),b={[s.DT_FLOAT32]:{typedArrayConstructor:Float32Array,heap:s.HEAPF32},[s.DT_INT8]:{typedArrayConstructor:Int8Array,heap:s.HEAP8},[s.DT_INT16]:{typedArrayConstructor:Int16Array,heap:s.HEAP16},[s.DT_INT32]:{typedArrayConstructor:Int32Array,heap:s.HEAP32},[s.DT_UINT8]:{typedArrayConstructor:Uint8Array,heap:s.HEAPU8},[s.DT_UINT16]:{typedArrayConstructor:Uint16Array,heap:s.HEAPU16},[s.DT_UINT32]:{typedArrayConstructor:Uint32Array,heap:s.HEAPU32}}[y];if(!b)throw new Error(`Invalid data type ${y}`);let D=h*C,M=D*b.typedArrayConstructor.BYTES_PER_ELEMENT,R=s._malloc(M);try{f.GetAttributeDataArrayForAllPoints(p,_,y,M,R);let W=new b.typedArrayConstructor(b.heap.buffer,R,D);r(g,W.slice(),C,v,I,E)}finally{s._free(R)}};if(t)for(let f in t){let p=t[f],g=o.GetAttributeByUniqueId(l,p);d(o,l,f,g)}else{let f={position:s.POSITION,normal:s.NORMAL,color:s.COLOR,uv:s.TEX_COORD};for(let p in f){let g=o.GetAttributeId(l,f[p]);if(g!==-1){let _=o.GetAttribute(l,g);d(o,l,p,_)}}}return h}finally{l&&s.destroy(l),a&&s.destroy(a),o&&s.destroy(o)}}function Tw(){let i;onmessage=e=>{let t=e.data;switch(t.id){case"init":{t.url&&importScripts(t.url);let n=t.wasmBinary?{wasmBinary:t.wasmBinary}:{};i=DracoDecoderModule(n),postMessage({id:"initDone"});break}case"decodeMesh":{if(!i)throw new Error("Draco decoder module is not available");i.then(n=>{let r=Mp(n,t.dataView,t.attributes,s=>{postMessage({id:"indices",data:s},[s.buffer])},(s,o,a,l,c,u)=>{postMessage({id:"attribute",kind:s,data:o,size:a,byteOffset:l,byteStride:c,normalized:u},[o.buffer])});postMessage({id:"decodeMeshDone",totalVertices:r})});break}}}}function Sw(i,e,t){return T(this,null,function*(){return yield new Promise((n,r)=>{let s=a=>{i.removeEventListener("error",s),i.removeEventListener("message",o),r(a)},o=a=>{a.data.id==="initDone"&&(i.removeEventListener("error",s),i.removeEventListener("message",o),n(i))};if(i.addEventListener("error",s),i.addEventListener("message",o),!e)i.postMessage({id:"init",url:t});else{let a=e.slice(0);i.postMessage({id:"init",url:t,wasmBinary:a},[a])}})})}function Ak(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)}function Iw(i){return!!(i.wasmUrl&&(i.wasmBinary||i.wasmBinaryUrl)&&typeof WebAssembly=="object"||i.fallbackUrl)}var Dp=class{constructor(e){if(e.workerPool){this._workerPoolPromise=Promise.resolve(e.workerPool);return}let t=e.wasmBinary,n=e.numWorkers??Ak(),r=n&&typeof Worker=="function"&&typeof URL=="function",s=r||!e.jsModule,o=e.wasmUrl&&e.wasmBinaryUrl&&typeof WebAssembly=="object"?{url:s?z.GetBabylonScriptURL(e.wasmUrl,!0):"",wasmBinaryPromise:t?Promise.resolve(t):z.LoadFileAsync(z.GetBabylonScriptURL(e.wasmBinaryUrl,!0))}:{url:s?z.GetBabylonScriptURL(e.fallbackUrl):"",wasmBinaryPromise:Promise.resolve(void 0)};r?this._workerPoolPromise=o.wasmBinaryPromise.then(a=>{let l=this._getWorkerContent(),c=URL.createObjectURL(new Blob([l],{type:"application/javascript"}));return new PT(n,()=>{let u=new Worker(c);return Sw(u,a,o.url)})}):this._modulePromise=o.wasmBinaryPromise.then(a=>T(this,null,function*(){if(!this._isModuleAvailable()&&!e.jsModule){if(!o.url)throw new Error("Draco codec module is not available");yield z.LoadBabylonScriptAsync(o.url)}return yield this._createModuleAsync(a,e.jsModule)}))}whenReadyAsync(){return T(this,null,function*(){if(this._workerPoolPromise){yield this._workerPoolPromise;return}if(this._modulePromise){yield this._modulePromise;return}})}dispose(){this._workerPoolPromise&&this._workerPoolPromise.then(e=>{e.dispose()}),delete this._workerPoolPromise,delete this._modulePromise}};var qo=class i extends Dp{static get DefaultAvailable(){return Iw(i.DefaultConfiguration)}static get Default(){return i._Default??(i._Default=new i),i._Default}static ResetDefault(e){i._Default&&(e||i._Default.dispose(),i._Default=null)}_isModuleAvailable(){return typeof DracoDecoderModule<"u"}_createModuleAsync(e,t){return T(this,null,function*(){return{module:yield(t||DracoDecoderModule)({wasmBinary:e})}})}_getWorkerContent(){return`${Mp}(${Tw})()`}constructor(e=i.DefaultConfiguration){super(e)}decodeMeshToMeshDataAsync(e,t,n){let r=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e.buffer,e.byteOffset,e.byteLength),s=(o,a)=>n&&n[o]!==void 0?(a!==n[o]&&N.Warn(`Normalized flag from Draco data (${a}) does not match normalized flag from glTF accessor (${n[o]}). Using flag from glTF accessor.`),n[o]):a;if(this._workerPoolPromise)return this._workerPoolPromise.then(o=>T(this,null,function*(){return yield new Promise((a,l)=>{o.push((c,u)=>{let h=null,d=[],f=_=>{c.removeEventListener("error",f),c.removeEventListener("message",p),l(_),u()},p=_=>{let y=_.data;switch(y.id){case"indices":{h=y.data;break}case"attribute":{d.push({kind:y.kind,data:y.data,size:y.size,byteOffset:y.byteOffset,byteStride:y.byteStride,normalized:s(y.kind,y.normalized)});break}case"decodeMeshDone":{c.removeEventListener("error",f),c.removeEventListener("message",p),a({indices:h,attributes:d,totalVertices:y.totalVertices}),u();break}}};c.addEventListener("error",f),c.addEventListener("message",p);let g=r.slice();c.postMessage({id:"decodeMesh",dataView:g,attributes:t},[g.buffer])})})}));if(this._modulePromise)return this._modulePromise.then(o=>{let a=null,l=[],c=Mp(o.module,r,t,u=>{a=u},(u,h,d,f,p,g)=>{l.push({kind:u,data:h,size:d,byteOffset:f,byteStride:p,normalized:g})});return{indices:a,attributes:l,totalVertices:c}});throw new Error("Draco decoder module is not available")}decodeMeshToGeometryAsync(e,t,n,r){return T(this,null,function*(){let s=yield this.decodeMeshToMeshDataAsync(n,r),o=new jt(e,t);s.indices&&o.setIndices(s.indices);for(let a of s.attributes)o.setVerticesBuffer(new S(t.getEngine(),a.data,a.kind,!1,void 0,a.byteStride,void 0,a.byteOffset,a.size,void 0,a.normalized,!0),s.totalVertices);return o})}_decodeMeshToGeometryForGltfAsync(e,t,n,r,s,o){return T(this,null,function*(){let a=yield this.decodeMeshToMeshDataAsync(n,r,s),l=new jt(e,t);o&&(l._boundingInfo=o,l.useBoundingInfoFromGeometry=!0),a.indices&&l.setIndices(a.indices);for(let c of a.attributes)l.setVerticesBuffer(new S(t.getEngine(),c.data,c.kind,!1,void 0,c.byteStride,void 0,c.byteOffset,c.size,void 0,c.normalized,!0),a.totalVertices);return l})}};qo.DefaultConfiguration={wasmUrl:`${z._DefaultCdnUrl}/draco_wasm_wrapper_gltf.js`,wasmBinaryUrl:`${z._DefaultCdnUrl}/draco_decoder_gltf.wasm`,fallbackUrl:`${z._DefaultCdnUrl}/draco_decoder_gltf.js`};qo._Default=null;var Rp="KHR_draco_mesh_compression",Lb=class{constructor(e){this.name=Rp,this.useNormalizedFlagFromAccessor=!0,this._loader=e,this.enabled=qo.DefaultAvailable&&this._loader.isExtensionUsed(Rp)}dispose(){delete this.dracoDecoder,this._loader=null}_loadVertexDataAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){if(t.mode!=null&&t.mode!==4&&t.mode!==5)throw new Error(`${e}: Unsupported mode ${t.mode}`);let o={},a={},l=(u,h)=>{let d=s.attributes[u];if(d!=null&&(n._delayInfo=n._delayInfo||[],n._delayInfo.indexOf(h)===-1&&n._delayInfo.push(h),o[h]=d,this.useNormalizedFlagFromAccessor)){let f=se.TryGet(this._loader.gltf.accessors,t.attributes[u]);f&&(a[h]=f.normalized||!1)}};l("POSITION",S.PositionKind),l("NORMAL",S.NormalKind),l("TANGENT",S.TangentKind),l("TEXCOORD_0",S.UVKind),l("TEXCOORD_1",S.UV2Kind),l("TEXCOORD_2",S.UV3Kind),l("TEXCOORD_3",S.UV4Kind),l("TEXCOORD_4",S.UV5Kind),l("TEXCOORD_5",S.UV6Kind),l("JOINTS_0",S.MatricesIndicesKind),l("WEIGHTS_0",S.MatricesWeightsKind),l("COLOR_0",S.ColorKind);let c=se.Get(r,this._loader.gltf.bufferViews,s.bufferView);return c._dracoBabylonGeometry||(c._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${c.index}`,c).then(u=>T(this,null,function*(){let h=this.dracoDecoder||qo.Default,d=se.TryGet(this._loader.gltf.accessors,t.attributes.POSITION),f=!this._loader.parent.alwaysComputeBoundingBox&&!n.skeleton&&d?Ab(d):null;return yield h._decodeMeshToGeometryForGltfAsync(n.name,this._loader.babylonScene,u,o,a,f).catch(p=>{throw new Error(`${e}: ${p.message}`)})}))),yield c._dracoBabylonGeometry}))}};he(Rp);fe(Rp,!0,i=>new Lb(i));var Pp="KHR_lights_punctual",Fb=class{constructor(e){this.name=Pp,this._loader=e,this.enabled=this._loader.isExtensionUsed(Pp)}dispose(){this._loader=null,delete this._lights}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._lights=t.lights,se.Assign(this._lights)}}loadNodeAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){return this._loader._allMaterialsDirtyRequired=!0,yield this._loader.loadNodeAsync(e,t,o=>{let a,l=se.Get(r,this._lights,s.light),c=l.name||o.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,l.type){case"directional":{let u=new Da(c,m.Backward(),this._loader.babylonScene);u.position.setAll(0),a=u;break}case"point":{a=new Ii(c,m.Zero(),this._loader.babylonScene);break}case"spot":{let u=new Ts(c,m.Zero(),m.Backward(),0,1,this._loader.babylonScene);u.angle=(l.spot&&l.spot.outerConeAngle||Math.PI/4)*2,u.innerAngle=(l.spot&&l.spot.innerConeAngle||0)*2,a=u;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${r}: Invalid light type (${l.type})`)}a._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,l._babylonLight=a,a.falloffType=an.FALLOFF_GLTF,a.diffuse=l.color?G.FromArray(l.color):G.White(),a.intensity=l.intensity==null?1:l.intensity,a.range=l.range==null?Number.MAX_VALUE:l.range,a.parent=o,this._loader._babylonLights.push(a),me.AddPointerMetadata(a,r),n(o)})}))}};he(Pp);fe(Pp,!0,i=>new Fb(i));function Ew(){return T(this,null,function*(){let i=new Uint16Array(16384),e=new Uint16Array(4096*4),t=yield z.LoadFileAsync(z.GetAssetUrl("https://assets.babylonjs.com/core/areaLights/areaLightsLTC.bin")),n=new Uint16Array(t),r=n.length/8;for(let s=0;s<r;s++)i[s*4]=n[s*8],i[s*4+1]=n[s*8+1],i[s*4+2]=n[s*8+2],i[s*4+3]=n[s*8+3],e[s*4]=n[s*8+4],e[s*4+1]=n[s*8+5],e[s*4+2]=n[s*8+6],e[s*4+3]=n[s*8+7];return[i,e]})}function wk(i){let e=i.useDelayedTextureLoading;i.useDelayedTextureLoading=!1;let t=i._blockEntityCollection;i._blockEntityCollection=!1,i._ltcTextures={LTC1:jn.CreateRGBATexture(null,64,64,i.getEngine(),!1,!1,2,2,0,!1,!0),LTC2:jn.CreateRGBATexture(null,64,64,i.getEngine(),!1,!1,2,2,0,!1,!0)},i._blockEntityCollection=t,i._ltcTextures.LTC1.wrapU=te.CLAMP_ADDRESSMODE,i._ltcTextures.LTC1.wrapV=te.CLAMP_ADDRESSMODE,i._ltcTextures.LTC2.wrapU=te.CLAMP_ADDRESSMODE,i._ltcTextures.LTC2.wrapV=te.CLAMP_ADDRESSMODE,i.useDelayedTextureLoading=e,Ew().then(n=>{i._ltcTextures&&((i._ltcTextures?.LTC1).update(n[0]),(i._ltcTextures?.LTC2).update(n[1]),i.onDisposeObservable.addOnce(()=>{i._ltcTextures?.LTC1.dispose(),i._ltcTextures?.LTC2.dispose()}))}).catch(n=>{N.Error(`Area Light fail to get LTC textures data. Error: ${n}`)})}var Op=class extends an{constructor(e,t,n){super(e,n),this.position=t,this._scene._ltcTextures||wk(this._scene)}transferTexturesToEffect(e){return this._scene._ltcTextures&&(e.setTexture("areaLightsLTC1Sampler",this._scene._ltcTextures.LTC1),e.setTexture("areaLightsLTC2Sampler",this._scene._ltcTextures.LTC2)),this}prepareLightSpecificDefines(e,t){e["AREALIGHT"+t]=!0,e.AREALIGHTUSED=!0}_isReady(){return this._scene._ltcTextures?this._scene._ltcTextures.LTC1.isReady()&&this._scene._ltcTextures.LTC2.isReady():!1}};kt.AddNodeConstructor("Light_Type_4",(i,e)=>()=>new ps(i,m.Zero(),1,1,e));var ps=class extends Op{get width(){return this._width.x}set width(e){this._width.x=e}get height(){return this._height.y}set height(e){this._height.y=e}constructor(e,t,n,r,s){super(e,t,s),this._width=new m(n,0,0),this._height=new m(0,r,0),this._pointTransformedPosition=m.Zero(),this._pointTransformedWidth=m.Zero(),this._pointTransformedHeight=m.Zero()}getClassName(){return"RectAreaLight"}getTypeID(){return an.LIGHTTYPEID_RECT_AREALIGHT}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightWidth",4),this._uniformBuffer.addUniform("vLightHeight",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeTransformedInformation(){return this.parent&&this.parent.getWorldMatrix?(m.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this._pointTransformedPosition),m.TransformNormalToRef(this._width,this.parent.getWorldMatrix(),this._pointTransformedWidth),m.TransformNormalToRef(this._height,this.parent.getWorldMatrix(),this._pointTransformedHeight),!0):!1}transferToEffect(e,t){let n=this._scene.floatingOriginOffset;return this._computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this._pointTransformedPosition.x-n.x,this._pointTransformedPosition.y-n.y,this._pointTransformedPosition.z-n.z,0,t),this._uniformBuffer.updateFloat4("vLightWidth",this._pointTransformedWidth.x/2,this._pointTransformedWidth.y/2,this._pointTransformedWidth.z/2,0,t),this._uniformBuffer.updateFloat4("vLightHeight",this._pointTransformedHeight.x/2,this._pointTransformedHeight.y/2,this._pointTransformedHeight.z/2,0,t)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x-n.x,this.position.y-n.y,this.position.z-n.z,0,t),this._uniformBuffer.updateFloat4("vLightWidth",this._width.x/2,this._width.y/2,this._width.z/2,0,t),this._uniformBuffer.updateFloat4("vLightHeight",this._height.x/2,this._height.y/2,this._height.z/2,0,t)),this}transferToNodeMaterialEffect(e,t){let n=this._scene.floatingOriginOffset;return this._computeTransformedInformation()?e.setFloat3(t,this._pointTransformedPosition.x-n.x,this._pointTransformedPosition.y-n.y,this._pointTransformedPosition.z-n.z):e.setFloat3(t,this.position.x-n.x,this.position.y-n.y,this.position.z-n.z),this}};w([L()],ps.prototype,"width",null);w([L()],ps.prototype,"height",null);ue("BABYLON.RectAreaLight",ps);var Np="EXT_lights_area",kb=class{constructor(e){this.name=Np,this._loader=e,this.enabled=this._loader.isExtensionUsed(Np)}dispose(){this._loader=null,delete this._lights}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._lights=t.lights,se.Assign(this._lights)}}loadNodeAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){return this._loader._allMaterialsDirtyRequired=!0,yield this._loader.loadNodeAsync(e,t,o=>{let a,l=se.Get(r,this._lights,s.light),c=l.name||o.name;this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer;let u=l.size!==void 0?l.size:1;switch(l.type){case"rect":{let d=l.rect?.aspect!==void 0?l.rect.aspect*u:u,f=u;a=new ps(c,m.Zero(),d,f,this._loader.babylonScene);break}case"disk":{let d=Math.sqrt(u*u*.25*Math.PI);a=new ps(c,m.Zero(),d,d,this._loader.babylonScene);break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${r}: Invalid area light type (${l.type})`)}a._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,l._babylonLight=a,a.falloffType=an.FALLOFF_GLTF,a.diffuse=l.color?G.FromArray(l.color):G.White(),a.intensity=l.intensity==null?1:l.intensity;let h=new ln(`${c}_orientation`,this._loader.babylonScene);h.rotationQuaternion=J.RotationAxis(m.Up(),Math.PI),h.parent=o,a.parent=h,this._loader._babylonLights.push(a),me.AddPointerMetadata(a,r),n(o)})}))}};he(Np);fe(Np,!0,i=>new kb(i));var Lp="KHR_materials_pbrSpecularGlossiness",Bb=class{constructor(e){this.name=Lp,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(Lp)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){let o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,n)),o.push(this._loadSpecularGlossinessPropertiesAsync(r,s,n)),this._loader.loadMaterialAlphaProperties(e,t,n),yield Promise.all(o).then(()=>{})}))}_loadSpecularGlossinessPropertiesAsync(e,t,n){if(!(n instanceof Na))throw new Error(`${e}: Material type not supported`);let r=new Array;return n.metallic=null,n.roughness=null,t.diffuseFactor?(n.albedoColor=G.FromArray(t.diffuseFactor),n.alpha=t.diffuseFactor[3]):n.albedoColor=G.White(),n.reflectivityColor=t.specularFactor?G.FromArray(t.specularFactor):G.White(),n.microSurface=t.glossinessFactor==null?1:t.glossinessFactor,t.diffuseTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTexture`,t.diffuseTexture,s=>{s.name=`${n.name} (Diffuse)`,n.albedoTexture=s})),t.specularGlossinessTexture&&(r.push(this._loader.loadTextureInfoAsync(`${e}/specularGlossinessTexture`,t.specularGlossinessTexture,s=>{s.name=`${n.name} (Specular Glossiness)`,n.reflectivityTexture=s,n.reflectivityTexture.hasAlpha=!0})),n.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(r).then(()=>{})}};he(Lp);fe(Lp,!0,i=>new Bb(i));var Fp="KHR_materials_unlit",Vb=class{constructor(e){this.name=Fp,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(Fp)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,()=>T(this,null,function*(){return yield this._loadUnlitPropertiesAsync(e,t,n)}))}_loadUnlitPropertiesAsync(e,t,n){let r=this._loader._getOrCreateMaterialAdapter(n),s=new Array,o=t.pbrMetallicRoughness;return o&&(o.baseColorFactor&&(r.baseColor=G.FromArray(o.baseColorFactor),r.geometryOpacity=o.baseColorFactor[3]),o.baseColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/baseColorTexture`,o.baseColorTexture,a=>{a.name=`${n.name} (Base Color)`,r.baseColorTexture=a}))),r.isUnlit=!0,t.doubleSided&&(r.backFaceCulling=!1,r.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,t,n),Promise.all(s).then(()=>{})}};he(Fp);fe(Fp,!0,i=>new Vb(i));var kp="KHR_materials_clearcoat",Gb=class{constructor(e){this.name=kp,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(kp)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){let o=new Array;o.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),o.push(this._loadClearCoatPropertiesAsync(r,s,n)),yield Promise.all(o)}))}_loadClearCoatPropertiesAsync(e,t,n){let r=this._loader._getOrCreateMaterialAdapter(n),s=new Array;return r.configureCoat(),r.coatWeight=t.clearcoatFactor!==void 0?t.clearcoatFactor:0,r.coatRoughness=t.clearcoatRoughnessFactor!==void 0?t.clearcoatRoughnessFactor:0,t.clearcoatTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,t.clearcoatTexture,o=>{o.name=`${n.name} (ClearCoat)`,r.coatWeightTexture=o})),t.clearcoatRoughnessTexture&&(t.clearcoatRoughnessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,t.clearcoatRoughnessTexture,o=>{o.name=`${n.name} (ClearCoat Roughness)`,r.coatRoughnessTexture=o}))),t.clearcoatNormalTexture&&(t.clearcoatNormalTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,t.clearcoatNormalTexture,o=>{o.name=`${n.name} (ClearCoat Normal)`,r.geometryCoatNormalTexture=o,t.clearcoatNormalTexture?.scale!=null&&(r.geometryCoatNormalTextureScale=t.clearcoatNormalTexture.scale)})),r.setNormalMapInversions(!n.getScene().useRightHandedSystem,n.getScene().useRightHandedSystem)),Promise.all(s).then(()=>{})}};he(kp);fe(kp,!0,i=>new Gb(i));var Bp="KHR_materials_coat",Ub=class{constructor(e){this.name=Bp,this.order=191,this.useOpenPBR=!1,this._loader=e,this.enabled=this._loader.isExtensionUsed(Bp)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){let o=new Array;o.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),t.extensions&&t.extensions.KHR_materials_openpbr&&(this.useOpenPBR=!0),o.push(this._loadCoatPropertiesAsync(r,s,n)),yield Promise.all(o)}))}_loadCoatPropertiesAsync(e,t,n){let r=this._loader._getOrCreateMaterialAdapter(n),s=new Array;r.configureCoat(),r.coatWeight=t.coatFactor!==void 0?t.coatFactor:0,r.coatRoughness=t.coatRoughnessFactor!==void 0?t.coatRoughnessFactor:0,t.coatTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/coatTexture`,t.coatTexture,c=>{c.name=`${n.name} (Coat)`,r.coatWeightTexture=c})),t.coatRoughnessTexture&&(t.coatRoughnessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/coatRoughnessTexture`,t.coatRoughnessTexture,c=>{c.name=`${n.name} (Coat Roughness)`,r.coatRoughnessTexture=c}))),t.coatNormalTexture&&(t.coatNormalTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/coatNormalTexture`,t.coatNormalTexture,c=>{c.name=`${n.name} (Coat Normal)`,r.geometryCoatNormalTexture=c,t.coatNormalTexture?.scale!=null&&(r.geometryCoatNormalTextureScale=t.coatNormalTexture.scale)})),r.setNormalMapInversions(!n.getScene().useRightHandedSystem,n.getScene().useRightHandedSystem)),r.coatDarkening=t.coatDarkeningFactor!==void 0?t.coatDarkeningFactor:1,r.coatIor=t.coatIor!==void 0?t.coatIor:1.5;let o=G.White();t.coatColorFactor!==void 0&&o.fromArray(t.coatColorFactor),r.coatColor=o,t.coatColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/coatColorTexture`,t.coatColorTexture,c=>{c.name=`${n.name} (Coat Color)`,r.coatColorTexture=c}));let a=t.coatAnisotropyStrength??0,l=t.coatAnisotropyRotation??0;return r.coatRoughnessAnisotropy=a,r.geometryCoatTangentAngle=l,this.useOpenPBR||r.configureGltfStyleAnisotropy(!0),t.coatAnisotropyTexture&&(t.coatAnisotropyTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/coatAnisotropyTexture`,t.coatAnisotropyTexture,c=>{c.name=`${n.name} (Coat Anisotropy)`,r.geometryCoatTangentTexture=c}))),Promise.all(s).then(()=>{})}};he(Bp);fe(Bp,!0,i=>new Ub(i));var Vp="KHR_materials_iridescence",zb=class{constructor(e){this.name=Vp,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(Vp)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),o.push(this._loadIridescencePropertiesAsync(r,s,n)),yield Promise.all(o).then(()=>{})}))}_loadIridescencePropertiesAsync(e,t,n){let r=this._loader._getOrCreateMaterialAdapter(n),s=new Array;return r.thinFilmWeight=t.iridescenceFactor??0,r.thinFilmIor=t.iridescenceIor??t.iridescenceIOR??1.3,r.thinFilmThicknessMinimum=t.iridescenceThicknessMinimum??100,r.thinFilmThicknessMaximum=t.iridescenceThicknessMaximum??400,t.iridescenceTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,t.iridescenceTexture,o=>{o.name=`${n.name} (Iridescence)`,r.thinFilmWeightTexture=o})),t.iridescenceThicknessTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,t.iridescenceThicknessTexture,o=>{o.name=`${n.name} (Iridescence Thickness)`,r.thinFilmThicknessTexture=o})),Promise.all(s).then(()=>{})}};he(Vp);fe(Vp,!0,i=>new zb(i));var Gp="KHR_materials_anisotropy",Hb=class{constructor(e){this.name=Gp,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(Gp)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){let o=new Array;o.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),o.push(this._loadAnisotropyPropertiesAsync(r,s,n)),yield Promise.all(o)}))}_loadAnisotropyPropertiesAsync(e,t,n){return T(this,null,function*(){let r=this._loader._getOrCreateMaterialAdapter(n),s=new Array,o=t.anisotropyStrength??0,a=t.anisotropyRotation??0;r.specularRoughnessAnisotropy=o,r.geometryTangentAngle=a;let l=t.extensions??{};(!l.EXT_materials_anisotropy_openpbr||!l.EXT_materials_anisotropy_openpbr.openPbrAnisotropyEnabled)&&r.configureGltfStyleAnisotropy(!0),t.anisotropyTexture&&(t.anisotropyTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/anisotropyTexture`,t.anisotropyTexture,c=>{c.name=`${n.name} (Anisotropy Intensity)`,r.geometryTangentTexture=c}))),yield Promise.all(s)})}};he(Gp);fe(Gp,!0,i=>new Hb(i));var Up="KHR_materials_emissive_strength",$b=class{constructor(e){this.name=Up,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(Up)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){return yield this._loader.loadMaterialPropertiesAsync(e,t,n),this._loadEmissiveProperties(r,s,n),yield Promise.resolve()}))}_loadEmissiveProperties(e,t,n){if(t.emissiveStrength!==void 0){let r=this._loader._getOrCreateMaterialAdapter(n);r.emissionLuminance=t.emissiveStrength}}};he(Up);fe(Up,!0,i=>new $b(i));var zp="KHR_materials_sheen",Wb=class{constructor(e){this.name=zp,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(zp)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),o.push(this._loadSheenPropertiesAsync(r,s,n)),yield Promise.all(o).then(()=>{})}))}_loadSheenPropertiesAsync(e,t,n){let r=this._loader._getOrCreateMaterialAdapter(n),s=new Array;r.configureFuzz();let o=t.sheenColorFactor!==void 0?G.FromArray(t.sheenColorFactor):G.Black(),a=t.sheenRoughnessFactor!==void 0?t.sheenRoughnessFactor:0;return r.fuzzWeight=1,r.fuzzColor=o,r.fuzzRoughness=a,t.sheenColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,t.sheenColorTexture,l=>{l.name=`${n.name} (Sheen Color)`,r.fuzzColorTexture=l})),t.sheenRoughnessTexture&&(t.sheenRoughnessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,t.sheenRoughnessTexture,l=>{l.name=`${n.name} (Sheen Roughness)`,r.fuzzRoughnessTexture=l}))),Promise.all(s).then(()=>{})}};he(zp);fe(zp,!0,i=>new Wb(i));var Hp="KHR_materials_fuzz",jb=class{constructor(e){this.name=Hp,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(Hp)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),o.push(this._loadFuzzPropertiesAsync(r,s,n)),yield Promise.all(o).then(()=>{})}))}_loadFuzzPropertiesAsync(e,t,n){let r=this._loader._getOrCreateMaterialAdapter(n),s=new Array;return r.configureFuzz(),r.fuzzWeight=t.fuzzFactor!==void 0?t.fuzzFactor:0,r.fuzzColor=t.fuzzColorFactor!==void 0?G.FromArray(t.fuzzColorFactor):G.White(),r.fuzzRoughness=t.fuzzRoughnessFactor!==void 0?t.fuzzRoughnessFactor:.5,t.fuzzTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/fuzzTexture`,t.fuzzTexture,o=>{o.name=`${n.name} (Fuzz)`,r.fuzzWeightTexture=o})),t.fuzzColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/fuzzColorTexture`,t.fuzzColorTexture,o=>{o.name=`${n.name} (Fuzz Color)`,r.fuzzColorTexture=o})),t.fuzzRoughnessTexture&&(t.fuzzRoughnessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/fuzzRoughnessTexture`,t.fuzzRoughnessTexture,o=>{o.name=`${n.name} (Fuzz Roughness)`,r.fuzzRoughnessTexture=o}))),Promise.all(s).then(()=>{})}};he(Hp);fe(Hp,!0,i=>new jb(i));var $p="KHR_materials_specular",qb=class{constructor(e){this.name=$p,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed($p)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){let o=new Array;o.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),o.push(this._loadSpecularPropertiesAsync(r,s,n));let a=this._loader._getOrCreateMaterialAdapter(n);return s.extensions&&s.extensions.EXT_materials_specular_edge_color&&s.extensions.EXT_materials_specular_edge_color.specularEdgeColorEnabled&&a.enableSpecularEdgeColor(!0),yield Promise.all(o).then(()=>{})}))}_loadSpecularPropertiesAsync(e,t,n){let r=this._loader._getOrCreateMaterialAdapter(n),s=new Array;return r.specularWeight=t.specularFactor??1,r.specularColor=t.specularColorFactor!==void 0?G.FromArray(t.specularColorFactor):new G(1,1,1),t.specularTexture&&(t.specularTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,t.specularTexture,o=>{o.name=`${n.name} (Specular)`,r.specularWeightTexture=o}))),t.specularColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,t.specularColorTexture,o=>{o.name=`${n.name} (Specular Color)`,r.specularColorTexture=o})),Promise.all(s).then(()=>{})}};he($p);fe($p,!0,i=>new qb(i));var Wp="KHR_materials_ior",Mk=(()=>{class i{constructor(t){this.name=Wp,this.order=180,this._loader=t,this.enabled=this._loader.isExtensionUsed(Wp)}dispose(){this._loader=null}loadMaterialPropertiesAsync(t,n,r){return me.LoadExtensionAsync(t,n,this.name,(s,o)=>T(this,null,function*(){let a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(t,n,r)),a.push(this._loadIorPropertiesAsync(s,o,r)),yield Promise.all(a).then(()=>{})}))}_loadIorPropertiesAsync(t,n,r){let s=this._loader._getOrCreateMaterialAdapter(r),o=n.ior!==void 0?n.ior:i._DEFAULT_IOR;return s.specularIor=o,Promise.resolve()}}return i._DEFAULT_IOR=1.5,i})();he(Wp);fe(Wp,!0,i=>new Mk(i));var bn="KHR_materials_variants",Yb=class i{constructor(e){this.name=bn,this._loader=e,this.enabled=this._loader.isExtensionUsed(bn)&&!this._loader.parent.skipMaterials}dispose(){this._loader=null}static GetAvailableVariants(e){let t=this._GetExtensionMetadata(e);return t?Object.keys(t.variants):[]}getAvailableVariants(e){return i.GetAvailableVariants(e)}static SelectVariant(e,t){let n=this._GetExtensionMetadata(e);if(!n)throw new Error(`Cannot select variant on a glTF mesh that does not have the ${bn} extension`);let r=s=>{let o=n.variants[s];if(o)for(let a of o)a.mesh.material=a.material};if(t instanceof Array)for(let s of t)r(s);else r(t);n.lastSelected=t}selectVariant(e,t){i.SelectVariant(e,t)}static Reset(e){let t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot reset on a glTF mesh that does not have the ${bn} extension`);for(let n of t.original)n.mesh.material=n.material;t.lastSelected=null}reset(e){i.Reset(e)}static GetLastSelectedVariant(e){let t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${bn} extension`);return t.lastSelected}getLastSelectedVariant(e){return i.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){return e?._internalMetadata?.gltf?.[bn]||null}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._variants=t.variants}}onReady(){let e=this._loader.rootBabylonMesh;if(e){let t=this._loader.parent.extensionOptions[bn];t?.defaultVariant&&i.SelectVariant(e,t.defaultVariant),t?.onLoaded?.({get variants(){return i.GetAvailableVariants(e)},get selectedVariant(){let n=i.GetLastSelectedVariant(e);return n?Array.isArray(n)?n[0]:n:i.GetAvailableVariants(e)[0]},set selectedVariant(n){i.SelectVariant(e,n)}})}}_loadMeshPrimitiveAsync(e,t,n,r,s,o){return me.LoadExtensionAsync(e,s,this.name,(a,l)=>T(this,null,function*(){let c=new Array;return c.push(this._loader._loadMeshPrimitiveAsync(e,t,n,r,s,u=>{if(o(u),u instanceof A){let h=me._GetDrawMode(e,s.mode),d=this._loader.rootBabylonMesh,f=d?d._internalMetadata=d._internalMetadata||{}:{},p=f.gltf=f.gltf||{},g=p[bn]=p[bn]||{lastSelected:null,original:[],variants:{}};g.original.push({mesh:u,material:u.material});for(let _=0;_<l.mappings.length;++_){let y=l.mappings[_],C=se.Get(`${a}/mappings/${_}/material`,this._loader.gltf.materials,y.material);c.push(this._loader._loadMaterialAsync(`#/materials/${y.material}`,C,u,h,E=>{for(let I=0;I<y.variants.length;++I){let v=y.variants[I],x=se.Get(`/extensions/${bn}/variants/${v}`,this._variants,v);g.variants[x.name]=g.variants[x.name]||[],g.variants[x.name].push({mesh:u,material:E}),u.onClonedObservable.add(b=>{let D=b,M=null,R=D;do{if(R=R.parent,!R)return;M=i._GetExtensionMetadata(R)}while(M===null);if(d&&M===i._GetExtensionMetadata(d)){R._internalMetadata={};for(let W in d._internalMetadata)R._internalMetadata[W]=d._internalMetadata[W];R._internalMetadata.gltf=[];for(let W in d._internalMetadata.gltf)R._internalMetadata.gltf[W]=d._internalMetadata.gltf[W];R._internalMetadata.gltf[bn]={lastSelected:null,original:[],variants:{}};for(let W of M.original)R._internalMetadata.gltf[bn].original.push({mesh:W.mesh,material:W.material});for(let W in M.variants)if(Object.prototype.hasOwnProperty.call(M.variants,W)){R._internalMetadata.gltf[bn].variants[W]=[];for(let ie of M.variants[W])R._internalMetadata.gltf[bn].variants[W].push({mesh:ie.mesh,material:ie.material})}M=R._internalMetadata.gltf[bn]}for(let W of M.original)W.mesh===u&&(W.mesh=D);for(let W of M.variants[x.name])W.mesh===u&&(W.mesh=D)})}}))}}})),yield Promise.all(c).then(([u])=>u)}))}};he(bn);fe(bn,!0,i=>new Yb(i));var Kb=class i{static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:Zr.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}constructor(e,t){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options=K(K({},i._GetDefaultOptions()),e),this._scene=t,this._scene._transmissionHelper=this,this.onErrorObservable=new B,this._scene.onDisposeObservable.addOnce(()=>{this.dispose()}),this._parseScene(),this._setupRenderTargets()}updateOptions(e){if(!Object.keys(e).filter(s=>this._options[s]!==e[s]).length)return;let n=K(K({},this._options),e),r=this._options;this._options=n,n.renderSize!==r.renderSize||n.renderTargetTextureType!==r.renderTargetTextureType||n.generateMipmaps!==r.generateMipmaps||!this._opaqueRenderTarget?this._setupRenderTargets():(this._opaqueRenderTarget.samples=n.samples,this._opaqueRenderTarget.lodGenerationScale=n.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=n.lodGenerationOffset)}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return!!e?.subSurface?.isRefractionEnabled}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),z.SetImmediate(()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,this._transparentMeshesCache.indexOf(e)===-1&&this._transparentMeshesCache.push(e)):this._opaqueMeshesCache.indexOf(e)===-1&&this._opaqueMeshesCache.push(e)})}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let t=this._transparentMeshesCache.indexOf(e);t!==-1&&this._transparentMeshesCache.splice(t,1),t=this._opaqueMeshesCache.indexOf(e),t!==-1&&this._opaqueMeshesCache.splice(t,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){let t=this._transparentMeshesCache.indexOf(e),n=this._opaqueMeshesCache.indexOf(e);if(this._shouldRenderAsTransmission(e.material)){if(e.material){let s=e.material.subSurface;s&&(s.refractionTexture=this._opaqueRenderTarget)}n!==-1?(this._opaqueMeshesCache.splice(n,1),this._transparentMeshesCache.push(e)):t===-1&&this._transparentMeshesCache.push(e)}else t!==-1?(this._transparentMeshesCache.splice(t,1),this._opaqueMeshesCache.push(e)):n===-1&&this._opaqueMeshesCache.push(e)}_isRenderTargetValid(){return this._opaqueRenderTarget?.getInternalTexture()!==null}_setupRenderTargets(){this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new Tn("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=this._options.clearColor?.clone()??this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples,this._opaqueRenderTarget.renderSprites=!0,this._opaqueRenderTarget.renderParticles=!0,this._opaqueRenderTarget.disableImageProcessing=!0;let e;this._opaqueRenderTarget.onBeforeBindObservable.add(t=>{e=this._scene.environmentIntensity,this._scene.environmentIntensity=1,this._options.clearColor?t.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(t.clearColor,this._scene.getEngine().useExactSrgbConversions)}),this._opaqueRenderTarget.onAfterUnbindObservable.add(()=>{this._scene.environmentIntensity=e});for(let t of this._transparentMeshesCache)this._shouldRenderAsTransmission(t.material)&&(t.material.refractionTexture=this._opaqueRenderTarget)}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}},jp="KHR_materials_transmission",Xb=class{constructor(e){this.name=jp,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(jp),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),o.push(this._loadTransparentPropertiesAsync(r,t,n,s)),yield Promise.all(o).then(()=>{})}))}_loadTransparentPropertiesAsync(e,t,n,r){let s=this._loader._getOrCreateMaterialAdapter(n),o=r.transmissionFactor!==void 0?r.transmissionFactor:0;if(o===0)return Promise.resolve();if(s.configureTransmission(),s.transmissionWeight=o,o>0){let l=n.getScene();l._transmissionHelper?l._transmissionHelper?._isRenderTargetValid()||l._transmissionHelper?._setupRenderTargets():new Kb({},n.getScene())}let a=Promise.resolve(null);return r.transmissionTexture&&(r.transmissionTexture.nonColorData=!0,a=this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,r.transmissionTexture,l=>{l.name=`${n.name} (Transmission)`,s.transmissionWeightTexture=l})),a.then(()=>{})}};he(jp);fe(jp,!0,i=>new Xb(i));var qp="KHR_materials_diffuse_transmission",Zb=class{constructor(e){this.name=qp,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(qp),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),o.push(this._loadTranslucentPropertiesAsync(r,t,n,s)),yield Promise.all(o).then(()=>{})}))}_loadTranslucentPropertiesAsync(e,t,n,r){let s=this._loader._getOrCreateMaterialAdapter(n);s.configureSubsurface(),s.subsurfaceWeight=r.diffuseTransmissionFactor??0,s.subsurfaceColor=r.diffuseTransmissionColorFactor!==void 0?G.FromArray(r.diffuseTransmissionColorFactor):G.White();let o=new Array;return r.diffuseTransmissionTexture&&(r.diffuseTransmissionTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTransmissionTexture`,r.diffuseTransmissionTexture).then(a=>{a.name=`${n.name} (Diffuse Transmission)`,s.subsurfaceWeightTexture=a}))),r.diffuseTransmissionColorTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTransmissionColorTexture`,r.diffuseTransmissionColorTexture).then(a=>{a.name=`${n.name} (Diffuse Transmission Color)`,s.subsurfaceColorTexture=a})),Promise.all(o).then(()=>{})}};he(qp);fe(qp,!0,i=>new Zb(i));var Yp="KHR_materials_volume",Qb=class{constructor(e){this.name=Yp,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(Yp),this.enabled&&this._loader._disableInstancedMesh++}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),o.push(this._loadVolumePropertiesAsync(r,t,n,s)),yield Promise.all(o).then(()=>{})}))}_loadVolumePropertiesAsync(e,t,n,r){let s=this._loader._getOrCreateMaterialAdapter(n);if(s.transmissionWeight===0&&s.subsurfaceWeight===0||!r.thicknessFactor)return Promise.resolve();s.transmissionDepth=r.attenuationDistance!==void 0?r.attenuationDistance:Number.MAX_VALUE,s.transmissionColor=r.attenuationColor!==void 0&&r.attenuationColor.length==3?G.FromArray(r.attenuationColor):G.White(),s.volumeThickness=r.thicknessFactor??0;let o=new Array;return r.thicknessTexture&&(r.thicknessTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/thicknessTexture`,r.thicknessTexture,a=>{a.name=`${n.name} (Thickness)`,s.volumeThicknessTexture=a}))),Promise.all(o).then(()=>{})}};he(Yp);fe(Yp,!0,i=>new Qb(i));var Kp="KHR_materials_dispersion",Jb=class{constructor(e){this.name=Kp,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(Kp)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),o.push(this._loadDispersionPropertiesAsync(r,t,n,s)),yield Promise.all(o).then(()=>{})}))}_loadDispersionPropertiesAsync(e,t,n,r){let s=this._loader._getOrCreateMaterialAdapter(n);return s.transmissionWeight>0||!r.dispersion||(s.transmissionDispersionAbbeNumber=20/r.dispersion),Promise.resolve()}};he(Kp);fe(Kp,!0,i=>new Jb(i));var Xp="KHR_materials_diffuse_roughness",ex=class{constructor(e){this.name=Xp,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(Xp)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,n)),o.push(this._loadDiffuseRoughnessPropertiesAsync(r,s,n)),yield Promise.all(o).then(()=>{})}))}_loadDiffuseRoughnessPropertiesAsync(e,t,n){let r=this._loader._getOrCreateMaterialAdapter(n),s=new Array;return r.baseDiffuseRoughness=t.diffuseRoughnessFactor??0,t.diffuseRoughnessTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/diffuseRoughnessTexture`,t.diffuseRoughnessTexture,o=>{o.name=`${n.name} (Diffuse Roughness)`,r.baseDiffuseRoughnessTexture=o})),Promise.all(s).then(()=>{})}};he(Xp);fe(Xp,!0,i=>new ex(i));var Zp="KHR_mesh_quantization",tx=class{constructor(e){this.name=Zp,this.enabled=e.isExtensionUsed(Zp)}dispose(){}};he(Zp);fe(Zp,!0,i=>new tx(i));var Qp="KHR_texture_basisu",nx=class{constructor(e){this.name=Qp,this._loader=e,this.enabled=e.isExtensionUsed(Qp)}dispose(){this._loader=null}_loadTextureAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){let o=t.sampler==null?me.DefaultSampler:se.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=se.Get(`${r}/source`,this._loader.gltf.images,s.source);return yield this._loader._createTextureAsync(e,o,a,l=>{n(l)},t._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!t._textureInfo.nonColorData)}))}};he(Qp);fe(Qp,!0,i=>new nx(i));var Jp="KHR_texture_transform",ix=class{constructor(e){this.name=Jp,this._loader=e,this.enabled=this._loader.isExtensionUsed(Jp)}dispose(){this._loader=null}loadTextureInfoAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){return yield this._loader.loadTextureInfoAsync(e,t,o=>{if(!(o instanceof te))throw new Error(`${r}: Texture type not supported`);s.offset&&(o.uOffset=s.offset[0],o.vOffset=s.offset[1]),o.uRotationCenter=0,o.vRotationCenter=0,s.rotation&&(o.wAng=-s.rotation),s.scale&&(o.uScale=s.scale[0],o.vScale=s.scale[1]),s.texCoord!=null&&(o.coordinatesIndex=s.texCoord),n(o)})}))}};he(Jp);fe(Jp,!0,i=>new ix(i));var em="KHR_xmp_json_ld",rx=class{constructor(e){this.name=em,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(em)}dispose(){this._loader=null}onLoading(){if(this._loader.rootBabylonMesh===null)return;let e=this._loader.gltf.extensions?.KHR_xmp_json_ld,t=this._loader.gltf.asset?.extensions?.KHR_xmp_json_ld;if(e&&t){let n=+t.packet;e.packets&&n<e.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=e.packets[n])}}};he(em);fe(em,!0,i=>new rx(i));function ms(i,e,t,n){return G.FromArray(e,t).scale(n)}function Dk(i,e,t,n){return e[t+3]*n}function tt(i,e,t,n){return e[t]*n}function ox(i,e,t,n){return-e[t]*n}function tm(i,e,t,n){return e[t+1]*n}function Aw(i,e,t,n){return e[t]*n*2}function nn(i){return{scale:[new et(H.ANIMATIONTYPE_FLOAT,`${i}.uScale`,tt,()=>2),new et(H.ANIMATIONTYPE_FLOAT,`${i}.vScale`,tm,()=>2)],offset:[new et(H.ANIMATIONTYPE_FLOAT,`${i}.uOffset`,tt,()=>2),new et(H.ANIMATIONTYPE_FLOAT,`${i}.vOffset`,tm,()=>2)],rotation:[new et(H.ANIMATIONTYPE_FLOAT,`${i}.wAng`,ox,()=>1)]}}var lr=class extends fc{buildAnimations(e,t,n,r){return[{babylonAnimatable:e._babylonCamera,babylonAnimation:this._buildAnimation(t,n,r)}]}},et=class extends fc{buildAnimations(e,t,n,r){let s=[];for(let o in e._data)s.push({babylonAnimatable:e._data[o].babylonMaterial,babylonAnimation:this._buildAnimation(t,n,r)});return s}},wi=class extends fc{buildAnimations(e,t,n,r){return[{babylonAnimatable:e._babylonLight,babylonAnimation:this._buildAnimation(t,n,r)}]}},sx=class extends fc{buildAnimations(e,t,n,r){return e._primitiveBabylonMeshes?e._primitiveBabylonMeshes.map(s=>({babylonAnimatable:s,babylonAnimation:this._buildAnimation(t,n,r)})):[]}};ee("/cameras/{}/orthographic/xmag",[new lr(H.ANIMATIONTYPE_FLOAT,"orthoLeft",ox,()=>1),new lr(H.ANIMATIONTYPE_FLOAT,"orthoRight",tm,()=>1)]);ee("/cameras/{}/orthographic/ymag",[new lr(H.ANIMATIONTYPE_FLOAT,"orthoBottom",ox,()=>1),new lr(H.ANIMATIONTYPE_FLOAT,"orthoTop",tm,()=>1)]);ee("/cameras/{}/orthographic/zfar",[new lr(H.ANIMATIONTYPE_FLOAT,"maxZ",tt,()=>1)]);ee("/cameras/{}/orthographic/znear",[new lr(H.ANIMATIONTYPE_FLOAT,"minZ",tt,()=>1)]);ee("/cameras/{}/perspective/yfov",[new lr(H.ANIMATIONTYPE_FLOAT,"fov",tt,()=>1)]);ee("/cameras/{}/perspective/zfar",[new lr(H.ANIMATIONTYPE_FLOAT,"maxZ",tt,()=>1)]);ee("/cameras/{}/perspective/znear",[new lr(H.ANIMATIONTYPE_FLOAT,"minZ",tt,()=>1)]);ee("/materials/{}/pbrMetallicRoughness/baseColorFactor",[new et(H.ANIMATIONTYPE_COLOR3,"albedoColor",ms,()=>4),new et(H.ANIMATIONTYPE_FLOAT,"alpha",Dk,()=>4)]);ee("/materials/{}/pbrMetallicRoughness/metallicFactor",[new et(H.ANIMATIONTYPE_FLOAT,"metallic",tt,()=>1)]);ee("/materials/{}/pbrMetallicRoughness/metallicFactor",[new et(H.ANIMATIONTYPE_FLOAT,"roughness",tt,()=>1)]);var ax=nn("albedoTexture");ee("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/scale",ax.scale);ee("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/offset",ax.offset);ee("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/rotation",ax.rotation);var lx=nn("metallicTexture");ee("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/scale",lx.scale);ee("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/offset",lx.offset);ee("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/rotation",lx.rotation);ee("/materials/{}/emissiveFactor",[new et(H.ANIMATIONTYPE_COLOR3,"emissiveColor",ms,()=>3)]);var cx=nn("bumpTexture");ee("/materials/{}/normalTexture/scale",[new et(H.ANIMATIONTYPE_FLOAT,"bumpTexture.level",tt,()=>1)]);ee("/materials/{}/normalTexture/extensions/KHR_texture_transform/scale",cx.scale);ee("/materials/{}/normalTexture/extensions/KHR_texture_transform/offset",cx.offset);ee("/materials/{}/normalTexture/extensions/KHR_texture_transform/rotation",cx.rotation);ee("/materials/{}/occlusionTexture/strength",[new et(H.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",tt,()=>1)]);var ux=nn("ambientTexture");ee("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/scale",ux.scale);ee("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/offset",ux.offset);ee("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/rotation",ux.rotation);var hx=nn("emissiveTexture");ee("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/scale",hx.scale);ee("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/offset",hx.offset);ee("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/rotation",hx.rotation);ee("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyStrength",[new et(H.ANIMATIONTYPE_FLOAT,"anisotropy.intensity",tt,()=>1)]);ee("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyRotation",[new et(H.ANIMATIONTYPE_FLOAT,"anisotropy.angle",tt,()=>1)]);var dx=nn("anisotropy.texture");ee("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/scale",dx.scale);ee("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/offset",dx.offset);ee("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/rotation",dx.rotation);ee("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatFactor",[new et(H.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",tt,()=>1)]);ee("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessFactor",[new et(H.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",tt,()=>1)]);var fx=nn("clearCoat.texture");ee("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/scale",fx.scale);ee("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/offset",fx.offset);ee("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/rotation",fx.rotation);var px=nn("clearCoat.bumpTexture");ee("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/scale",[new et(H.ANIMATIONTYPE_FLOAT,"clearCoat.bumpTexture.level",tt,()=>1)]);ee("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/scale",px.scale);ee("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/offset",px.offset);ee("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/rotation",px.rotation);var mx=nn("clearCoat.textureRoughness");ee("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/scale",mx.scale);ee("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/offset",mx.offset);ee("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/rotation",mx.rotation);ee("/materials/{}/extensions/KHR_materials_dispersion/dispersionFactor",[new et(H.ANIMATIONTYPE_FLOAT,"subSurface.dispersion",tt,()=>1)]);ee("/materials/{}/extensions/KHR_materials_emissive_strength/emissiveStrength",[new et(H.ANIMATIONTYPE_FLOAT,"emissiveIntensity",tt,()=>1)]);ee("/materials/{}/extensions/KHR_materials_ior/ior",[new et(H.ANIMATIONTYPE_FLOAT,"indexOfRefraction",tt,()=>1)]);ee("/materials/{}/extensions/KHR_materials_iridescence/iridescenceFactor",[new et(H.ANIMATIONTYPE_FLOAT,"iridescence.intensity",tt,()=>1)]);ee("/materials/{}/extensions/KHR_materials_iridescence/iridescenceIor",[new et(H.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",tt,()=>1)]);ee("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessMinimum",[new et(H.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",tt,()=>1)]);ee("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessMaximum",[new et(H.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",tt,()=>1)]);var gx=nn("iridescence.texture");ee("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/scale",gx.scale);ee("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/offset",gx.offset);ee("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/rotation",gx.rotation);var _x=nn("iridescence.thicknessTexture");ee("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/scale",_x.scale);ee("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/offset",_x.offset);ee("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/rotation",_x.rotation);ee("/materials/{}/extensions/KHR_materials_sheen/sheenColorFactor",[new et(H.ANIMATIONTYPE_COLOR3,"sheen.color",ms,()=>3)]);ee("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessFactor",[new et(H.ANIMATIONTYPE_FLOAT,"sheen.roughness",tt,()=>1)]);var yx=nn("sheen.texture");ee("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/scale",yx.scale);ee("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/offset",yx.offset);ee("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/rotation",yx.rotation);var vx=nn("sheen.textureRoughness");ee("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/scale",vx.scale);ee("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/offset",vx.offset);ee("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/rotation",vx.rotation);ee("/materials/{}/extensions/KHR_materials_specular/specularFactor",[new et(H.ANIMATIONTYPE_FLOAT,"metallicF0Factor",tt,()=>1)]);ee("/materials/{}/extensions/KHR_materials_specular/specularColorFactor",[new et(H.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",ms,()=>3)]);var bx=nn("metallicReflectanceTexture");ee("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/scale",bx.scale);ee("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/offset",bx.offset);ee("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/rotation",bx.rotation);var xx=nn("reflectanceTexture");ee("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/scale",xx.scale);ee("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/offset",xx.offset);ee("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/rotation",xx.rotation);ee("/materials/{}/extensions/KHR_materials_transmission/transmissionFactor",[new et(H.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",tt,()=>1)]);var Cx=nn("subSurface.refractionIntensityTexture");ee("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/scale",Cx.scale);ee("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/offset",Cx.offset);ee("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/rotation",Cx.rotation);ee("/materials/{}/extensions/KHR_materials_volume/attenuationColor",[new et(H.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",ms,()=>3)]);ee("/materials/{}/extensions/KHR_materials_volume/attenuationDistance",[new et(H.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",tt,()=>1)]);ee("/materials/{}/extensions/KHR_materials_volume/thicknessFactor",[new et(H.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",tt,()=>1)]);var Tx=nn("subSurface.thicknessTexture");ee("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/scale",Tx.scale);ee("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/offset",Tx.offset);ee("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/rotation",Tx.rotation);ee("/materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionFactor",[new et(H.ANIMATIONTYPE_FLOAT,"subSurface.translucencyIntensity",tt,()=>1)]);var Sx=nn("subSurface.translucencyIntensityTexture");ee("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/scale",Sx.scale);ee("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/offset",Sx.offset);ee("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/rotation",Sx.rotation);ee("/materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorFactor",[new et(H.ANIMATIONTYPE_COLOR3,"subSurface.translucencyColor",ms,()=>3)]);var Ix=nn("subSurface.translucencyColorTexture");ee("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/scale",Ix.scale);ee("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/offset",Ix.offset);ee("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/rotation",Ix.rotation);ee("/extensions/KHR_lights_punctual/lights/{}/color",[new wi(H.ANIMATIONTYPE_COLOR3,"diffuse",ms,()=>3)]);ee("/extensions/KHR_lights_punctual/lights/{}/intensity",[new wi(H.ANIMATIONTYPE_FLOAT,"intensity",tt,()=>1)]);ee("/extensions/KHR_lights_punctual/lights/{}/range",[new wi(H.ANIMATIONTYPE_FLOAT,"range",tt,()=>1)]);ee("/extensions/KHR_lights_punctual/lights/{}/spot/innerConeAngle",[new wi(H.ANIMATIONTYPE_FLOAT,"innerAngle",Aw,()=>1)]);ee("/extensions/KHR_lights_punctual/lights/{}/spot/outerConeAngle",[new wi(H.ANIMATIONTYPE_FLOAT,"angle",Aw,()=>1)]);ee("/extensions/EXT_lights_area/lights/{}/color",[new wi(H.ANIMATIONTYPE_COLOR3,"diffuse",ms,()=>3)]);ee("/extensions/EXT_lights_area/lights/{}/intensity",[new wi(H.ANIMATIONTYPE_FLOAT,"intensity",tt,()=>1)]);ee("/extensions/EXT_lights_area/lights/{}/size",[new wi(H.ANIMATIONTYPE_FLOAT,"radius",tt,()=>1)]);ee("/extensions/EXT_lights_area/lights/{}/rect/aspect",[new wi(H.ANIMATIONTYPE_FLOAT,"radius",tt,()=>1)]);ee("/nodes/{}/extensions/EXT_lights_ies/color",[new wi(H.ANIMATIONTYPE_COLOR3,"diffuse",ms,()=>3)]);ee("/nodes/{}/extensions/EXT_lights_ies/multiplier",[new wi(H.ANIMATIONTYPE_FLOAT,"intensity",tt,()=>1)]);ee("/nodes/{}/extensions/KHR_node_visibility/visible",[new sx(H.ANIMATIONTYPE_FLOAT,"isVisible",tt,()=>1)]);var nm="KHR_animation_pointer",Ex=class{constructor(e){this.name=nm,this._loader=e,this._pathToObjectConverter=Lh(this._loader.gltf)}get enabled(){return this._loader.isExtensionUsed(nm)}dispose(){this._loader=null,delete this._pathToObjectConverter}_loadAnimationChannelAsync(e,t,n,r,s){let o=r.target.extensions?.KHR_animation_pointer;if(!o||!this._pathToObjectConverter)return null;r.target.path!=="pointer"&&N.Warn(`${e}/target/path: Value (${r.target.path}) must be (pointer) when using the ${this.name} extension`),r.target.node!=null&&N.Warn(`${e}/target/node: Value (${r.target.node}) must not be present when using the ${this.name} extension`);let a=`${e}/extensions/${this.name}`,l=o.pointer;if(!l)throw new Error(`${a}: Pointer is missing`);try{let c=this._pathToObjectConverter.convert(l);if(!c.info.interpolation)throw new Error(`${a}/pointer: Interpolation is missing`);return this._loader._loadAnimationChannelFromTargetInfoAsync(e,t,n,r,{object:c.object,info:c.info.interpolation},s)}catch{return N.Warn(`${a}/pointer: Invalid pointer (${l}) skipped`),null}}};he(nm);fe(nm,!0,i=>new Ex(i));var im=class i{constructor(e,t,n){this.frame=e,this.action=t,this.onlyOnce=n,this.isDone=!1}_clone(){return new i(this.frame,this.action,this.onlyOnce)}};var $s=(()=>{class i{get loop(){return this._loop}set loop(t){t!==this._loop&&(this._loop=t,this.updateOptions({loop:t}))}get currentTime(){if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;if(ne.audioEngine?.audioContext&&(this.isPlaying||this.isPaused)){let t=this.isPaused?0:ne.audioEngine.audioContext.currentTime-this._startTime;return this._currentTime+t}return 0}get spatialSound(){return this._spatialSound}set spatialSound(t){if(t==this._spatialSound)return;let n=this.isPlaying;this.pause(),t?(this._spatialSound=t,this._updateSpatialParameters()):this._disableSpatialSound(),n&&this.play()}constructor(t,n,r,s=null,o){if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new B,this._spatialSound=!1,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._currentTime=0,this._position=m.Zero(),this._localDirection=new m(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=t,r=r||Ie.LastCreatedScene,!!r)if(this._scene=r,i._SceneComponentInitialization(r),this._readyToPlayCallback=s,this._customAttenuationFunction=(a,l,c,u,h)=>l<c?a*(1-l/c):0,o&&(this.autoplay=o.autoplay||!1,this._loop=o.loop||!1,o.volume!==void 0&&(this._volume=o.volume),this._spatialSound=o.spatialSound??!1,this.maxDistance=o.maxDistance??100,this.useCustomAttenuation=o.useCustomAttenuation??!1,this.rolloffFactor=o.rolloffFactor||1,this.refDistance=o.refDistance||1,this.distanceModel=o.distanceModel||"linear",this._playbackRate=o.playbackRate||1,this._streaming=o.streaming??!1,this._length=o.length,this._offset=o.offset),ne.audioEngine?.canUseWebAudio&&ne.audioEngine.audioContext){this._soundGain=ne.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);let a=!0;if(n)try{typeof n=="string"?(this._urlType="String",this._url=n):n instanceof ArrayBuffer?this._urlType="ArrayBuffer":n instanceof HTMLMediaElement?this._urlType="MediaElement":n instanceof MediaStream?this._urlType="MediaStream":n instanceof AudioBuffer?this._urlType="AudioBuffer":Array.isArray(n)&&(this._urlType="Array");let l=[],c=!1;switch(this._urlType){case"MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=ne.audioEngine.audioContext.createMediaElementSource(n),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=ne.audioEngine.audioContext.createMediaStreamSource(n),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":n.byteLength>0&&(c=!0,this._soundLoaded(n));break;case"AudioBuffer":this._audioBufferLoaded(n);break;case"String":l.push(n);case"Array":l.length===0&&(l=n);for(let u=0;u<l.length;u++){let h=l[u];if(c=o&&o.skipCodecCheck||h.indexOf(".mp3",h.length-4)!==-1&&ne.audioEngine.isMP3supported||h.indexOf(".ogg",h.length-4)!==-1&&ne.audioEngine.isOGGsupported||h.indexOf(".wav",h.length-4)!==-1||h.indexOf(".m4a",h.length-4)!==-1||h.indexOf(".mp4",h.length-4)!==-1||h.indexOf("blob:")!==-1,c){this._streaming?(this._htmlAudioElement=new Audio(h),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,z.SetCorsBehavior(h,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",()=>{this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback()},{once:!0}),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(h,d=>{this._soundLoaded(d)},void 0,!0,!0,d=>{d&&N.Error("XHR "+d.status+" error on: "+h+"."),N.Error("Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)});break}}break;default:a=!1;break}a?c||(this._isReadyToPlay=!0,this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)):N.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch{N.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),ne.audioEngine&&!ne.audioEngine.WarnedWebAudioUnsupported&&(N.Error("Web Audio is not supported by your browser."),ne.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)}dispose(){ne.audioEngine?.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,this.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement),this._htmlAudioElement=null),this._streamingSource&&(this._streamingSource.disconnect(),this._streamingSource=null),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null),this._clearTimeoutsAndObservers())}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}_audioBufferLoaded(t){ne.audioEngine?.audioContext&&(this._audioBuffer=t,this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback())}_soundLoaded(t){ne.audioEngine?.audioContext&&ne.audioEngine.audioContext.decodeAudioData(t,n=>{this._audioBufferLoaded(n)},n=>{N.Error("Error while decoding audio data for: "+this.name+" / Error: "+n)})}setAudioBuffer(t){ne.audioEngine?.canUseWebAudio&&(this._audioBuffer=t,this._isReadyToPlay=!0)}updateOptions(t){t&&(this.loop=t.loop??this.loop,this.maxDistance=t.maxDistance??this.maxDistance,this.useCustomAttenuation=t.useCustomAttenuation??this.useCustomAttenuation,this.rolloffFactor=t.rolloffFactor??this.rolloffFactor,this.refDistance=t.refDistance??this.refDistance,this.distanceModel=t.distanceModel??this.distanceModel,this._playbackRate=t.playbackRate??this._playbackRate,this._length=t.length??void 0,this.spatialSound=t.spatialSound??this._spatialSound,this._setOffset(t.offset??void 0),this.setVolume(t.volume??this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),this._offset!==void 0&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),this._length!==void 0&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(this._offset|0)+this._length))))}_createSpatialParameters(){ne.audioEngine?.canUseWebAudio&&ne.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=this._soundPanner??ne.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))}_disableSpatialSound(){this._spatialSound&&(this._inputAudioNode=this._soundGain,this._soundPanner?.disconnect(),this._soundPanner=null,this._spatialSound=!1)}_updateSpatialParameters(){this._spatialSound&&(this._soundPanner?this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel):this._createSpatialParameters())}switchPanningModelToHRTF(){this._panningModel="HRTF",this._switchPanningModel()}switchPanningModelToEqualPower(){this._panningModel="equalpower",this._switchPanningModel()}_switchPanningModel(){ne.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)}connectToSoundTrackAudioNode(t){ne.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(t),this._isOutputConnected=!0)}setDirectionalCone(t,n,r){if(n<t){N.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=t,this._coneOuterAngle=n,this._coneOuterGain=r,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(t){if(t!=this._coneInnerAngle){if(this._coneOuterAngle<t){N.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=t,ne.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(t){if(t!=this._coneOuterAngle){if(t<this._coneInnerAngle){N.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=t,ne.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}}setPosition(t){t.equals(this._position)||(this._position.copyFrom(t),ne.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z))}setLocalDirectionToMesh(t){this._localDirection=t,ne.audioEngine?.canUseWebAudio&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this._soundPanner)return;let t=this._connectedTransformNode.getWorldMatrix(),n=m.TransformNormal(this._localDirection,t);n.normalize(),this._soundPanner.orientationX.value=n.x,this._soundPanner.orientationY.value=n.y,this._soundPanner.orientationZ.value=n.z}updateDistanceFromListener(){if(ne.audioEngine?.canUseWebAudio&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){let t=this._scene.audioListenerPositionProvider?this._connectedTransformNode.position.subtract(this._scene.audioListenerPositionProvider()).length():this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,t,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(t){this._customAttenuationFunction=t}play(t,n,r){if(this._isReadyToPlay&&this._scene.audioEnabled&&ne.audioEngine?.audioContext)try{this._clearTimeoutsAndObservers();let s=t?ne.audioEngine?.audioContext.currentTime+t:ne.audioEngine?.audioContext.currentTime;if((!this._soundSource||!this._streamingSource)&&this._spatialSound&&this._soundPanner&&(!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(!this._streamingSource&&this._htmlAudioElement&&(this._streamingSource=ne.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=()=>{this._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource&&(this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode)),this._htmlAudioElement){let o=()=>{if(ne.audioEngine?.unlocked){if(!this._htmlAudioElement)return;this._htmlAudioElement.currentTime=n??0;let a=this._htmlAudioElement.play();a!==void 0&&a.catch(()=>{ne.audioEngine?.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=ne.audioEngine?.onAudioUnlockedObservable.addOnce(()=>{o()}))})}else(this.loop||this.autoplay)&&(this._audioUnlockedObserver=ne.audioEngine?.onAudioUnlockedObservable.addOnce(()=>{o()}))};o()}}else{let o=()=>{if(ne.audioEngine?.audioContext){if(r=r||this._length,n!==void 0&&this._setOffset(n),this._soundSource){let a=this._soundSource;a.onended=()=>{a.disconnect()}}if(this._soundSource=ne.audioEngine?.audioContext.createBufferSource(),this._soundSource&&this._inputAudioNode){this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,n!==void 0&&(this._soundSource.loopStart=n),r!==void 0&&(this._soundSource.loopEnd=(n|0)+r),this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=()=>{this._onended()},s=t?ne.audioEngine?.audioContext.currentTime+t:ne.audioEngine.audioContext.currentTime;let a=((this.isPaused?this.currentTime:0)+(this._offset??0))%this._soundSource.buffer.duration;this._soundSource.start(s,a,this.loop?void 0:r)}}};ne.audioEngine?.audioContext.state==="suspended"?this._tryToPlayTimeout=setTimeout(()=>{ne.audioEngine?.audioContext.state==="suspended"?(ne.audioEngine.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=ne.audioEngine.onAudioUnlockedObservable.addOnce(()=>{o()}))):o()},500):o()}this._startTime=s,this.isPlaying=!0,this.isPaused=!1}catch(s){N.Error("Error while trying to play audio: "+this.name+", "+s.message)}}_onended(){this.isPlaying=!1,this._startTime=0,this._currentTime=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)}stop(t){if(this.isPlaying)if(this._clearTimeoutsAndObservers(),this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):this._streamingSource?.disconnect(),this.isPlaying=!1;else if(ne.audioEngine?.audioContext&&this._soundSource){let n=t?ne.audioEngine.audioContext.currentTime+t:void 0;this._soundSource.onended=()=>{this.isPlaying=!1,this.isPaused=!1,this._startTime=0,this._currentTime=0,this._soundSource&&(this._soundSource.onended=()=>{}),this._onended()},this._soundSource.stop(n)}else this.isPlaying=!1;else this.isPaused&&(this.isPaused=!1,this._startTime=0,this._currentTime=0)}pause(){this.isPlaying&&(this._clearTimeoutsAndObservers(),this._streaming?(this._htmlAudioElement?this._htmlAudioElement.pause():this._streamingSource?.disconnect(),this.isPlaying=!1,this.isPaused=!0):ne.audioEngine?.audioContext&&this._soundSource&&(this._soundSource.onended=()=>{},this._soundSource.stop(),this.isPlaying=!1,this.isPaused=!0,this._currentTime+=ne.audioEngine.audioContext.currentTime-this._startTime))}setVolume(t,n){ne.audioEngine?.canUseWebAudio&&this._soundGain&&(n&&ne.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(ne.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,ne.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(t,ne.audioEngine.audioContext.currentTime+n)):this._soundGain.gain.value=t),this._volume=t}setPlaybackRate(t){this._playbackRate=t,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))}getPlaybackRate(){return this._playbackRate}getVolume(){return this._volume}attachToMesh(t){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=t,this._spatialSound||(this._spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=n=>this._onRegisterAfterWorldMatrixUpdate(n),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(t){if(!t.getBoundingInfo)this.setPosition(t.absolutePosition);else{let r=t.getBoundingInfo();this.setPosition(r.boundingSphere.centerWorld)}ne.audioEngine?.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(this._streaming)return null;{let t=()=>{gg(()=>this._isReadyToPlay,()=>{r._audioBuffer=this.getAudioBuffer(),r._isReadyToPlay=!0,r.autoplay&&r.play(0,this._offset,this._length)},void 0,300)},n={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},r=new i(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,n);return this.useCustomAttenuation&&r.setAttenuationFunction(this._customAttenuationFunction),r.setPosition(this._position),r.setPlaybackRate(this._playbackRate),t(),r}}getAudioBuffer(){return this._audioBuffer}getSoundSource(){return this._soundSource}getSoundGain(){return this._soundGain}serialize(){let t={name:this.name,url:this._url,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(t.connectedMeshId=this._connectedTransformNode.id),t.position=this._position.asArray(),t.refDistance=this.refDistance,t.distanceModel=this.distanceModel,t.isDirectional=this._isDirectional,t.localDirectionToMesh=this._localDirection.asArray(),t.coneInnerAngle=this._coneInnerAngle,t.coneOuterAngle=this._coneOuterAngle,t.coneOuterGain=this._coneOuterGain),t}static Parse(t,n,r,s){let o=t.name,a;t.url?a=r+t.url:a=r+o;let l={autoplay:t.autoplay,loop:t.loop,volume:t.volume,spatialSound:t.spatialSound,maxDistance:t.maxDistance,rolloffFactor:t.rolloffFactor,refDistance:t.refDistance,distanceModel:t.distanceModel,playbackRate:t.playbackRate},c;if(!s)c=new i(o,a,n,()=>{n.removePendingData(c)},l),n.addPendingData(c);else{let u=()=>{gg(()=>s._isReadyToPlay,()=>{c._audioBuffer=s.getAudioBuffer(),c._isReadyToPlay=!0,c.autoplay&&c.play(0,c._offset,c._length)},void 0,300)};c=new i(o,new ArrayBuffer(0),n,null,l),u()}if(t.position){let u=m.FromArray(t.position);c.setPosition(u)}if(t.isDirectional&&(c.setDirectionalCone(t.coneInnerAngle||360,t.coneOuterAngle||360,t.coneOuterGain||0),t.localDirectionToMesh)){let u=m.FromArray(t.localDirectionToMesh);c.setLocalDirectionToMesh(u)}if(t.connectedMeshId){let u=n.getMeshById(t.connectedMeshId);u&&c.attachToMesh(u)}return t.metadata&&(c.metadata=t.metadata),c}_setOffset(t){this._offset!==t&&(this.isPaused&&(this.stop(),this.isPaused=!1),this._offset=t)}_clearTimeoutsAndObservers(){this._tryToPlayTimeout&&(clearTimeout(this._tryToPlayTimeout),this._tryToPlayTimeout=null),this._audioUnlockedObserver&&(ne.audioEngine?.onAudioUnlockedObservable.remove(this._audioUnlockedObserver),this._audioUnlockedObserver=null)}}return i._SceneComponentInitialization=e=>{throw Bn("AudioSceneComponent")},i})();ue("BABYLON.Sound",$s);var rm=class{constructor(e,t,n){if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],t.length!==n.length)throw new Error("Sounds length does not equal weights length");this.loop=e,this._weights=n;let r=0;for(let o of n)r+=o;let s=r>0?1/r:0;for(let o=0;o<this._weights.length;o++)this._weights[o]*=s;this._sounds=t;for(let o of this._sounds)o.onEndedObservable.add(()=>{this._onended()})}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!==this._coneInnerAngle){if(this._coneOuterAngle<e){N.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e;for(let t of this._sounds)t.directionalConeInnerAngle=e}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!==this._coneOuterAngle){if(e<this._coneInnerAngle){N.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e;for(let t of this._sounds)t.directionalConeOuterAngle=e}}get volume(){return this._volume}set volume(e){if(e!==this._volume)for(let t of this._sounds)t.setVolume(e)}_onended(){this._currentIndex!==void 0&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1}pause(){this.isPlaying&&(this.isPaused=!0,this._currentIndex!==void 0&&this._sounds[this._currentIndex].pause())}stop(){this.isPlaying=!1,this._currentIndex!==void 0&&this._sounds[this._currentIndex].stop()}play(e){if(!this.isPaused){this.stop();let n=Math.random(),r=0;for(let s=0;s<this._weights.length;s++)if(r+=this._weights[s],n<=r){this._currentIndex=s;break}}let t=this._sounds[this._currentIndex??0];t.isReady()?t.play(0,this.isPaused?void 0:e):t.autoplay=!0,this.isPlaying=!0,this.isPaused=!1}};var sm=class{constructor(e,t={}){this.id=-1,this._isInitialized=!1,e=e||Ie.LastCreatedScene,e&&(this._scene=e,this.soundCollection=[],this._options=t,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1))}_initializeSoundTrackAudioGraph(){ne.audioEngine?.canUseWebAudio&&ne.audioEngine.audioContext&&(this._outputAudioNode=ne.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(ne.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)}dispose(){if(ne.audioEngine&&ne.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}}addSound(e){this._isInitialized||this._initializeSoundTrackAudioGraph(),ne.audioEngine?.canUseWebAudio&&this._outputAudioNode&&e.connectToSoundTrackAudioNode(this._outputAudioNode),e.soundTrackId!==void 0&&(e.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(e):this._scene.soundTracks&&this._scene.soundTracks[e.soundTrackId].removeSound(e)),this.soundCollection.push(e),e.soundTrackId=this.id}removeSound(e){let t=this.soundCollection.indexOf(e);t!==-1&&this.soundCollection.splice(t,1)}setVolume(e){ne.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.gain.value=e)}switchPanningModelToHRTF(){if(ne.audioEngine?.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToHRTF()}switchPanningModelToEqualPower(){if(ne.audioEngine?.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToEqualPower()}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,ne.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,ne.audioEngine.masterGain))}};var om=[];var am=class{constructor(e){this._mainBuses=new Set,this._sounds=new Set,this._soundsArray=null,this._nodes=new Set,this._defaultMainBus=null,this._parameterRampDuration=.01,om.push(this),typeof e.parameterRampDuration=="number"&&(this.parameterRampDuration=e.parameterRampDuration)}get defaultMainBus(){return this._mainBuses.size===0?null:(this._defaultMainBus||(this._defaultMainBus=Array.from(this._mainBuses)[0]),this._defaultMainBus)}get parameterRampDuration(){return this._parameterRampDuration}set parameterRampDuration(e){this._parameterRampDuration=Math.max(0,e)}get sounds(){return this._soundsArray||(this._soundsArray=Array.from(this._sounds)),this._soundsArray}dispose(){om.includes(this)&&om.splice(om.indexOf(this),1);let e=this._nodes.values();for(let t=e.next();!t.done;t=e.next())t.value.dispose();this._mainBuses.clear(),this._nodes.clear(),this._sounds.clear(),this._disposeSoundsArray(),this._defaultMainBus=null}unlockAsync(){return this.resumeAsync()}_addMainBus(e){this._mainBuses.add(e),this._addNode(e)}_removeMainBus(e){this._mainBuses.delete(e),this._defaultMainBus=null,this._removeNode(e)}_addNode(e){this._nodes.add(e)}_removeNode(e){this._nodes.delete(e)}_addSound(e){this._disposeSoundsArray(),this._sounds.add(e),this._addNode(e)}_removeSound(e){this._disposeSoundsArray(),this._sounds.delete(e),this._removeNode(e)}_disposeSoundsArray(){this._soundsArray&&(this._soundsArray.length=0,this._soundsArray=null)}};var ww={position:m.Zero(),rotation:m.Zero(),rotationQuaternion:new J};function Mw(i){return i.listenerEnabled||i.listenerMinUpdateTime!==void 0||i.listenerPosition!==void 0||i.listenerRotation!==void 0||i.listenerRotationQuaternion!==void 0}var lm=class{};var cm=class extends lm{constructor(){super(),this._attacherComponent=null,this._attacherComponent=new Sg(this)}get isAttached(){return this._attacherComponent!==null&&this._attacherComponent.isAttached}attach(e,t=!1,n=3){this._attacherComponent||(this._attacherComponent=new Sg(this)),this._attacherComponent.attach(e,t,n)}detach(){this._attacherComponent?.detach()}dispose(){this._attacherComponent?.dispose(),this._attacherComponent=null}setOptions(e){e.listenerMinUpdateTime!==void 0&&(this.minUpdateTime=e.listenerMinUpdateTime),e.listenerPosition&&(this.position=e.listenerPosition.clone()),e.listenerRotationQuaternion?this.rotationQuaternion=e.listenerRotationQuaternion.clone():e.listenerRotation?this.rotation=e.listenerRotation.clone():this.rotationQuaternion=ww.rotationQuaternion.clone(),this.update()}};var Ax=V.Zero(),wx=new J,Dw=m.Zero(),Rw=m.Zero();function Rx(i,e,t){let n=i._audioContext.listener;return n.forwardX&&n.forwardY&&n.forwardZ&&n.positionX&&n.positionY&&n.positionZ&&n.upX&&n.upY&&n.upZ?new Mx(i,e,t):new Dx(i,e,t)}var um=class extends cm{constructor(e,t,n){super(),this._lastPosition=m.Zero(),this._lastRotation=m.Zero(),this._lastRotationQuaternion=new J,this.position=m.Zero(),this.rotation=m.Zero(),this.rotationQuaternion=new J,this._listener=e._audioContext.listener,this.engine=e,this._updaterComponent=new HT(this,t,n)}dispose(){super.dispose(),this._updaterComponent.dispose(),this._updaterComponent=null}get minUpdateTime(){return this._updaterComponent.minUpdateTime}set minUpdateTime(e){this._updaterComponent.minUpdateTime=e}update(){this.isAttached?this._attacherComponent?.update():(this._updatePosition(),this._updateRotation())}_updatePosition(){this._lastPosition.equalsWithEpsilon(this.position)||(this._setWebAudioPosition(this.position),this._lastPosition.copyFrom(this.position))}_updateRotation(){if(!this._lastRotationQuaternion.equalsWithEpsilon(this.rotationQuaternion))wx.copyFrom(this.rotationQuaternion),this._lastRotationQuaternion.copyFrom(this.rotationQuaternion);else if(!this._lastRotation.equalsWithEpsilon(this.rotation))J.FromEulerAnglesToRef(this.rotation.x,this.rotation.y,this.rotation.z,wx),this._lastRotation.copyFrom(this.rotation);else return;V.FromQuaternionToRef(wx,Ax),m.TransformNormalToRef(m.RightHandedForwardReadOnly,Ax,Dw),m.TransformNormalToRef(m.Up(),Ax,Rw),this._setWebAudioOrientation(Dw,Rw)}},Mx=class extends um{constructor(e,t,n){super(e,t,n);let r=e._audioContext.listener;this._forwardX=new Li(e,r.forwardX),this._forwardY=new Li(e,r.forwardY),this._forwardZ=new Li(e,r.forwardZ),this._positionX=new Li(e,r.positionX),this._positionY=new Li(e,r.positionY),this._positionZ=new Li(e,r.positionZ),this._upX=new Li(e,r.upX),this._upY=new Li(e,r.upY),this._upZ=new Li(e,r.upZ)}_setWebAudioPosition(e){this.isAttached&&(this._positionX.isRamping||this._positionY.isRamping||this._positionZ.isRamping)||(this._positionX.targetValue=e.x,this._positionY.targetValue=e.y,this._positionZ.targetValue=e.z)}_setWebAudioOrientation(e,t){this.isAttached&&(this._forwardX.isRamping||this._forwardY.isRamping||this._forwardZ.isRamping||this._upX.isRamping||this._upY.isRamping||this._upZ.isRamping)||(this._forwardX.targetValue=e.x,this._forwardY.targetValue=e.y,this._forwardZ.targetValue=e.z,this._upX.targetValue=t.x,this._upY.targetValue=t.y,this._upZ.targetValue=t.z)}},Dx=class extends um{_setWebAudioPosition(e){this._listener.setPosition(e.x,e.y,e.z)}_setWebAudioOrientation(e,t){this._listener.setOrientation(e.x,e.y,e.z,t.x,t.y,t.z)}};var hm=class extends $T{constructor(e){super(e,1)}};var dm=class extends hm{constructor(e){super(e),this._setGainNode(new GainNode(e._audioContext))}dispose(){super.dispose(),this._volume.dispose(),this._gainNode.disconnect(),this._destinationNode.disconnect()}get _inNode(){return this._gainNode}set _inNode(e){this._gainNode!==e&&this._setGainNode(e)}get volume(){return this._volume.targetValue}set volume(e){this._volume.targetValue=e}get _destinationNode(){return this.engine._audioDestination}getClassName(){return"_WebAudioMainOut"}setVolume(e,t=null){this._volume.setTargetValue(e,t)}_setGainNode(e){this._gainNode!==e&&(this._gainNode?.disconnect(),e.connect(this._destinationNode),this._volume=new Li(this.engine,e.gain),this._gainNode=e)}};var fm=class{constructor(e,t){this._button=null,this._enabled=!0,this._style=null,this._onStateChanged=()=>{this._button&&(this._engine.state==="running"?this._hide():this._show())},this._engine=e;let n=t||Ie.LastCreatedEngine?.getInputElement()?.parentElement||document.body,r=(n?.offsetTop||0)+20;this._style=document.createElement("style"),this._style.appendChild(document.createTextNode(`.babylonUnmute{position:absolute;top:${r}px;margin-left:20px;height:40px;width:60px;background-color:rgba(51,51,51,0.7);background-image:url("data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E");background-size:80%;background-repeat:no-repeat;background-position:center;background-position-y:4px;border:none;outline:none;transition:transform 0.125s ease-out;cursor:pointer;z-index:9999;}.babylonUnmute:hover{transform:scale(1.05)}`)),document.head.appendChild(this._style),this._button=document.createElement("button"),this._button.className="babylonUnmute",this._button.id="babylonUnmuteButton",this._button.addEventListener("click",()=>{this._engine.unlockAsync()}),n.appendChild(this._button),this._engine.stateChangedObservable.add(this._onStateChanged)}dispose(){this._button?.remove(),this._button=null,this._style?.remove(),this._style=null,this._engine.stateChangedObservable.removeCallback(this._onStateChanged)}get enabled(){return this._enabled}set enabled(e){this._enabled=e,e?this._engine.state!=="running"&&this._show():this._hide()}_show(){!this._button||!this._enabled||(this._button.style.display="block")}_hide(){this._button&&(this._button.style.display="none")}};var Rk={aac:"audio/aac",ac3:"audio/ac3",flac:"audio/flac",m4a:"audio/mp4",mp3:'audio/mpeg; codecs="mp3"',mp4:"audio/mp4",ogg:'audio/ogg; codecs="vorbis"',wav:"audio/wav",webm:'audio/webm; codecs="vorbis"'},pm=class extends am{constructor(e={}){super(e),this._audioContextStarted=!1,this._destinationNode=null,this._invalidFormats=new Set,this._isUpdating=!1,this._listener=null,this._listenerAutoUpdate=!0,this._listenerMinUpdateTime=0,this._pauseCalled=!1,this._resumeOnInteraction=!0,this._resumeOnPause=!0,this._resumeOnPauseRetryInterval=1e3,this._resumeOnPauseTimerId=null,this._resumePromise=null,this._silentHtmlAudio=null,this._unmuteUI=null,this._updateObservable=null,this._validFormats=new Set,this._volume=1,this._isUsingOfflineAudioContext=!1,this.isReadyPromise=new Promise(t=>{this._resolveIsReadyPromise=t}),this.stateChangedObservable=new B,this.userGestureObservable=new B,this._initAudioContextAsync=()=>T(this,null,function*(){this._audioContext.addEventListener("statechange",this._onAudioContextStateChange),this._mainOut=new dm(this),this._mainOut.volume=this._volume,yield this.createMainBusAsync("default")}),this._onAudioContextStateChange=()=>{this.state==="running"&&(clearInterval(this._resumeOnPauseTimerId),this._audioContextStarted=!0,this._resumePromise=null),(this.state==="suspended"||this.state==="interrupted")&&this._audioContextStarted&&this._resumeOnPause&&!this._pauseCalled&&(clearInterval(this._resumeOnPauseTimerId),this._resumeOnPauseTimerId=setInterval(()=>{this.resumeAsync()},this._resumeOnPauseRetryInterval)),this.stateChangedObservable.notifyObservers(this.state)},this._onUserGestureAsync=()=>T(this,null,function*(){if(this._resumeOnInteraction&&(yield this._audioContext.resume()),!this._silentHtmlAudio){this._silentHtmlAudio=document.createElement("audio");let t=this._silentHtmlAudio;t.controls=!1,t.preload="auto",t.loop=!0,t.src="data:audio/wav;base64,UklGRjAAAABXQVZFZm10IBAAAAABAAEAgLsAAAB3AQACABAAZGF0YQwAAAAAAAEA/v8CAP//AQA=",t.play()}this.userGestureObservable.notifyObservers()}),this._startUpdating=()=>{if(!this._isUpdating)if(this._isUpdating=!0,this.state==="running")this._update();else{let t=()=>{this.state==="running"&&(this._update(),this.stateChangedObservable.removeCallback(t))};this.stateChangedObservable.add(t)}},this._update=()=>{this._updateObservable?.hasObservers()?(this._updateObservable.notifyObservers(),requestAnimationFrame(this._update)):this._isUpdating=!1},typeof e.listenerAutoUpdate=="boolean"&&(this._listenerAutoUpdate=e.listenerAutoUpdate),typeof e.listenerMinUpdateTime=="number"&&(this._listenerMinUpdateTime=e.listenerMinUpdateTime),this._volume=e.volume??1,e.audioContext?(this._isUsingOfflineAudioContext=e.audioContext instanceof OfflineAudioContext,this._audioContext=e.audioContext):this._audioContext=new AudioContext,e.disableDefaultUI||(this._unmuteUI=new fm(this,e.defaultUIParentElement))}_initAsync(e){return T(this,null,function*(){this._resumeOnInteraction=typeof e.resumeOnInteraction=="boolean"?e.resumeOnInteraction:!0,this._resumeOnPause=typeof e.resumeOnPause=="boolean"?e.resumeOnPause:!0,this._resumeOnPauseRetryInterval=e.resumeOnPauseRetryInterval??1e3,document.addEventListener("click",this._onUserGestureAsync),yield this._initAudioContextAsync(),Mw(e)&&(this._listener=Rx(this,this._listenerAutoUpdate,this._listenerMinUpdateTime),this._listener.setOptions(e)),this._resolveIsReadyPromise()})}get currentTime(){return this._audioContext.currentTime??0}get _inNode(){return this._audioContext.destination}get mainOut(){return this._mainOut}get listener(){return this._listener??(this._listener=Rx(this,this._listenerAutoUpdate,this._listenerMinUpdateTime))}get state(){return this._isUsingOfflineAudioContext?"running":this._audioContext.state}get volume(){return this._volume}set volume(e){this._volume!==e&&(this._volume=e,this._mainOut&&(this._mainOut.volume=e))}get _audioDestination(){return this._destinationNode?this._destinationNode:this._destinationNode=this._audioContext.destination}set _audioDestination(e){this._destinationNode=e}get _unmuteUIEnabled(){return this._unmuteUI?this._unmuteUI.enabled:!1}set _unmuteUIEnabled(e){this._unmuteUI&&(this._unmuteUI.enabled=e)}createBusAsync(n){return T(this,arguments,function*(e,t={}){let r=yield import("./chunk-RBRW3HDK.js"),s=new r._WebAudioBus(e,this,t);return yield s._initAsync(t),s})}createMainBusAsync(n){return T(this,arguments,function*(e,t={}){let r=yield import("./chunk-B6B52PFK.js"),s=new r._WebAudioMainBus(e,this);return yield s._initAsync(t),s})}createMicrophoneSoundSourceAsync(e,t){return T(this,null,function*(){let n;try{n=yield navigator.mediaDevices.getUserMedia({audio:!0})}catch(r){throw new Error("Unable to access microphone: "+r)}return yield this.createSoundSourceAsync(e,new MediaStreamAudioSourceNode(this._audioContext,{mediaStream:n}),K({outBusAutoDefault:!1},t))})}createSoundAsync(r,s){return T(this,arguments,function*(e,t,n={}){let o=yield import("./chunk-PV5JN4D3.js"),a=new o._WebAudioStaticSound(e,this,n);return yield a._initAsync(t,n),a})}createSoundBufferAsync(n){return T(this,arguments,function*(e,t={}){let r=yield import("./chunk-PV5JN4D3.js"),s=new r._WebAudioStaticSoundBuffer(this);return yield s._initAsync(e,t),s})}createSoundSourceAsync(r,s){return T(this,arguments,function*(e,t,n={}){let o=yield import("./chunk-ODOERIEW.js"),a=new o._WebAudioSoundSource(e,t,this,n);return yield a._initAsync(n),a})}createStreamingSoundAsync(r,s){return T(this,arguments,function*(e,t,n={}){let o=yield import("./chunk-O6XRBI7X.js"),a=new o._WebAudioStreamingSound(e,this,n);return yield a._initAsync(t,n),a})}dispose(){super.dispose(),this._listener?.dispose(),this._listener=null,this._audioContext.state!=="closed"&&!this._isUsingOfflineAudioContext&&this._audioContext.close(),document.removeEventListener("click",this._onUserGestureAsync),this._audioContext.removeEventListener("statechange",this._onAudioContextStateChange),this._silentHtmlAudio?.remove(),this._updateObservable?.clear(),this._updateObservable=null,this._unmuteUI?.dispose(),this._unmuteUI=null,this.stateChangedObservable.clear()}flagInvalidFormat(e){this._invalidFormats.add(e)}isFormatValid(e){if(this._validFormats.has(e))return!0;if(this._invalidFormats.has(e))return!1;let t=Rk[e];return t===void 0?!1:new Audio().canPlayType(t)===""?(this._invalidFormats.add(e),!1):(this._validFormats.add(e),!0)}pauseAsync(){return T(this,null,function*(){yield this._audioContext.suspend(),this._pauseCalled=!0})}resumeAsync(){return this._pauseCalled=!1,this._resumePromise?this._resumePromise:(this._resumePromise=this._audioContext.resume(),this._resumePromise)}setVolume(e,t=null){if(this._mainOut)this._mainOut.setVolume(e,t);else throw new Error("Main output not initialized yet.")}_addMainBus(e){super._addMainBus(e)}_removeMainBus(e){super._removeMainBus(e)}_addNode(e){super._addNode(e)}_removeNode(e){super._removeNode(e)}_addSound(e){super._addSound(e)}_removeSound(e){super._removeSound(e)}_addUpdateObserver(e){this._updateObservable||(this._updateObservable=new B),this._updateObservable.add(e),this._startUpdating()}_removeUpdateObserver(e){this._updateObservable&&this._updateObservable.removeCallback(e)}};ne.AudioEngineFactory=(i,e,t)=>new Px(i,e,t);var Px=class{get masterGain(){return this._masterGain}set masterGain(e){this._masterGain=this._v2.mainOut._inNode=e}get useCustomUnlockedButton(){return this._useCustomUnlockedButton}set useCustomUnlockedButton(e){this._useCustomUnlockedButton=e,this._v2._unmuteUIEnabled=!e}get audioContext(){return this._v2.state==="running"&&this._triggerRunningStateAsync(),this._v2._audioContext}constructor(e=null,t=null,n=null){this._audioContext=null,this._tryToRun=!1,this._useCustomUnlockedButton=!1,this.canUseWebAudio=!0,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!1,this.onAudioUnlockedObservable=new B,this.onAudioLockedObservable=new B;let r=new pm({audioContext:t||void 0,defaultUIParentElement:e?.parentElement?e.parentElement:void 0});r._unmuteUIEnabled=!1,this._masterGain=new GainNode(r._audioContext),r._audioDestination=n,r.stateChangedObservable.add(s=>{s==="running"?(this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)):(this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this))}),r._initAsync({resumeOnInteraction:!1}).then(()=>{let s=r.defaultMainBus._outNode;s&&(s.disconnect(r.mainOut._inNode),s.connect(this._masterGain)),r.mainOut._inNode=this._masterGain,r.stateChangedObservable.notifyObservers(r.state)}),this.isMP3supported=r.isFormatValid("mp3"),this.isOGGsupported=r.isFormatValid("ogg"),this._v2=r}lock(){this._v2._audioContext.suspend(),this._useCustomUnlockedButton||(this._v2._unmuteUIEnabled=!0)}unlock(){if(this._audioContext?.state==="running"){this.unlocked||(this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this));return}this._triggerRunningStateAsync()}_resumeAudioContextOnStateChange(){this._audioContext?.addEventListener("statechange",()=>{this.unlocked&&this._audioContext?.state!=="running"&&this._resumeAudioContextAsync()},{once:!0,passive:!0,signal:AbortSignal.timeout(3e3)})}_resumeAudioContextAsync(){return this._v2._isUsingOfflineAudioContext?Promise.resolve():this._v2._audioContext.resume()}dispose(){this._v2.dispose(),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()}getGlobalVolume(){return this.masterGain.gain.value}setGlobalVolume(e){this.masterGain.gain.value=e}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._v2._audioContext.destination)}_triggerRunningStateAsync(){return T(this,null,function*(){this._tryToRun||(this._tryToRun=!0,yield this._resumeAudioContextAsync(),this._tryToRun=!1,this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this))})}};var Pk={},Ox={};function Ws(i,e){Pk[i]=e}function Pw(i,e){Ox[i]=e}function Ow(i){return Ox[i]?Ox[i]:null}Ws(Ge.NAME_AUDIO,(i,e,t,n)=>{let r=[],s;if(t.sounds=t.sounds||[],i.sounds!==void 0&&i.sounds!==null)for(let o=0,a=i.sounds.length;o<a;o++){let l=i.sounds[o];ne.audioEngine?.canUseWebAudio?(l.url||(l.url=l.name),r[l.url]?t.sounds.push($s.Parse(l,e,n,r[l.url])):(s=$s.Parse(l,e,n),r[l.url]=s,t.sounds.push(s))):t.sounds.push(new $s(l.name,null,e))}r=[]});Object.defineProperty(Pe.prototype,"mainSoundTrack",{get:function(){let i=this._getComponent(Ge.NAME_AUDIO);return i||(i=new qn(this),this._addComponent(i)),this._mainSoundTrack||(this._mainSoundTrack=new sm(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0});Pe.prototype.getSoundByName=function(i){let e;for(e=0;e<this.mainSoundTrack.soundCollection.length;e++)if(this.mainSoundTrack.soundCollection[e].name===i)return this.mainSoundTrack.soundCollection[e];if(this.soundTracks){for(let t=0;t<this.soundTracks.length;t++)for(e=0;e<this.soundTracks[t].soundCollection.length;e++)if(this.soundTracks[t].soundCollection[e].name===i)return this.soundTracks[t].soundCollection[e]}return null};Object.defineProperty(Pe.prototype,"audioEnabled",{get:function(){let i=this._getComponent(Ge.NAME_AUDIO);return i||(i=new qn(this),this._addComponent(i)),i.audioEnabled},set:function(i){let e=this._getComponent(Ge.NAME_AUDIO);e||(e=new qn(this),this._addComponent(e)),i?e.enableAudio():e.disableAudio()},enumerable:!0,configurable:!0});Object.defineProperty(Pe.prototype,"headphone",{get:function(){let i=this._getComponent(Ge.NAME_AUDIO);return i||(i=new qn(this),this._addComponent(i)),i.headphone},set:function(i){let e=this._getComponent(Ge.NAME_AUDIO);e||(e=new qn(this),this._addComponent(e)),i?e.switchAudioModeForHeadphones():e.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0});Object.defineProperty(Pe.prototype,"audioListenerPositionProvider",{get:function(){let i=this._getComponent(Ge.NAME_AUDIO);return i||(i=new qn(this),this._addComponent(i)),i.audioListenerPositionProvider},set:function(i){let e=this._getComponent(Ge.NAME_AUDIO);if(e||(e=new qn(this),this._addComponent(e)),i&&typeof i!="function")throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");e.audioListenerPositionProvider=i},enumerable:!0,configurable:!0});Object.defineProperty(Pe.prototype,"audioListenerRotationProvider",{get:function(){let i=this._getComponent(Ge.NAME_AUDIO);return i||(i=new qn(this),this._addComponent(i)),i.audioListenerRotationProvider},set:function(i){let e=this._getComponent(Ge.NAME_AUDIO);if(e||(e=new qn(this),this._addComponent(e)),i&&typeof i!="function")throw new Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");e.audioListenerRotationProvider=i},enumerable:!0,configurable:!0});Object.defineProperty(Pe.prototype,"audioPositioningRefreshRate",{get:function(){let i=this._getComponent(Ge.NAME_AUDIO);return i||(i=new qn(this),this._addComponent(i)),i.audioPositioningRefreshRate},set:function(i){let e=this._getComponent(Ge.NAME_AUDIO);e||(e=new qn(this),this._addComponent(e)),e.audioPositioningRefreshRate=i},enumerable:!0,configurable:!0});var qn=class i{get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}constructor(e){this.name=Ge.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this._cachedCameraDirection=new m,this._cachedCameraPosition=new m,this._lastCheck=0,this._invertMatrixTemp=new V,this._cameraDirectionTemp=new m,e=e||Ie.LastCreatedScene,e&&(this.scene=e,e.soundTracks=[],e.sounds=[])}register(){this.scene._afterRenderStage.registerStep(Ge.STEP_AFTERRENDER_AUDIO,this,this._afterRender)}rebuild(){}serialize(e){if(e.sounds=[],this.scene.soundTracks)for(let t=0;t<this.scene.soundTracks.length;t++){let n=this.scene.soundTracks[t];for(let r=0;r<n.soundCollection.length;r++)e.sounds.push(n.soundCollection[r].serialize())}}addFromContainer(e){if(e.sounds)for(let t of e.sounds)t.play(),t.autoplay=!0,this.scene.mainSoundTrack.addSound(t)}removeFromContainer(e,t=!1){if(e.sounds)for(let n of e.sounds)n.stop(),n.autoplay=!1,this.scene.mainSoundTrack.removeSound(n),t&&n.dispose()}dispose(){let e=this.scene;if(e._mainSoundTrack&&e.mainSoundTrack.dispose(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].dispose()}disableAudio(){let e=this.scene;this._audioEnabled=!1,ne.audioEngine&&ne.audioEngine.audioContext&&ne.audioEngine.audioContext.suspend();let t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].pause();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let n=0;n<e.soundTracks[t].soundCollection.length;n++)e.soundTracks[t].soundCollection[n].pause()}enableAudio(){let e=this.scene;this._audioEnabled=!0,ne.audioEngine&&ne.audioEngine.audioContext&&ne.audioEngine.audioContext.resume();let t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].isPaused&&e.mainSoundTrack.soundCollection[t].play();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let n=0;n<e.soundTracks[t].soundCollection.length;n++)e.soundTracks[t].soundCollection[n].isPaused&&e.soundTracks[t].soundCollection[n].play()}switchAudioModeForHeadphones(){let e=this.scene;if(this._headphone=!0,e.mainSoundTrack.switchPanningModelToHRTF(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){let e=this.scene;if(this._headphone=!1,e.mainSoundTrack.switchPanningModelToEqualPower(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToEqualPower()}_afterRender(){let e=Zi.Now;if(this._lastCheck&&e-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=e;let t=this.scene;if(!this._audioEnabled||!t._mainSoundTrack||!t.soundTracks||t._mainSoundTrack.soundCollection.length===0&&t.soundTracks.length===1)return;let n=ne.audioEngine;if(n&&n.audioContext){let r=t.activeCamera;if(t.activeCameras&&t.activeCameras.length>0&&(r=t.activeCameras[0]),this.audioListenerPositionProvider){let o=this.audioListenerPositionProvider();n.audioContext.listener.setPosition(o.x||0,o.y||0,o.z||0)}else r?this._cachedCameraPosition.equals(r.globalPosition)||(this._cachedCameraPosition.copyFrom(r.globalPosition),n.audioContext.listener.setPosition(r.globalPosition.x,r.globalPosition.y,r.globalPosition.z)):n.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){let o=this.audioListenerRotationProvider();n.audioContext.listener.setOrientation(o.x||0,o.y||0,o.z||0,0,1,0)}else r?(r.rigCameras&&r.rigCameras.length>0&&(r=r.rigCameras[0]),r.getViewMatrix().invertToRef(this._invertMatrixTemp),m.TransformNormalToRef(i._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),!isNaN(this._cameraDirectionTemp.x)&&!isNaN(this._cameraDirectionTemp.y)&&!isNaN(this._cameraDirectionTemp.z)&&(this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),n.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0)))):n.audioContext.listener.setOrientation(0,0,0,0,1,0);let s;for(s=0;s<t.mainSoundTrack.soundCollection.length;s++){let o=t.mainSoundTrack.soundCollection[s];o.useCustomAttenuation&&o.updateDistanceFromListener()}if(t.soundTracks)for(s=0;s<t.soundTracks.length;s++)for(let o=0;o<t.soundTracks[s].soundCollection.length;o++){let a=t.soundTracks[s].soundCollection[o];a.useCustomAttenuation&&a.updateDistanceFromListener()}}}};qn._CameraDirection=new m(0,0,-1);$s._SceneComponentInitialization=i=>{let e=i._getComponent(Ge.NAME_AUDIO);e||(e=new qn(i),i._addComponent(e))};var mm="MSFT_audio_emitter",Nx=class{constructor(e){this.name=mm,this._loader=e,this.enabled=this._loader.isExtensionUsed(mm)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,se.Assign(this._clips),se.Assign(this._emitters)}}loadSceneAsync(e,t){return me.LoadExtensionAsync(e,t,this.name,(n,r)=>T(this,null,function*(){let s=new Array;s.push(this._loader.loadSceneAsync(e,t));for(let o of r.emitters){let a=se.Get(`${n}/emitters`,this._emitters,o);if(a.refDistance!=null||a.maxDistance!=null||a.rolloffFactor!=null||a.distanceModel!=null||a.innerAngle!=null||a.outerAngle!=null)throw new Error(`${n}: Direction or Distance properties are not allowed on emitters attached to a scene`);s.push(this._loadEmitterAsync(`${n}/emitters/${a.index}`,a))}yield Promise.all(s)}))}loadNodeAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){let o=new Array,a=yield this._loader.loadNodeAsync(r,t,l=>{for(let c of s.emitters){let u=se.Get(`${r}/emitters`,this._emitters,c);o.push(this._loadEmitterAsync(`${r}/emitters/${u.index}`,u).then(()=>{for(let h of u._babylonSounds)h.attachToMesh(l),(u.innerAngle!=null||u.outerAngle!=null)&&(h.setLocalDirectionToMesh(m.Forward()),h.setDirectionalCone(2*z.ToDegrees(u.innerAngle==null?Math.PI:u.innerAngle),2*z.ToDegrees(u.outerAngle==null?Math.PI:u.outerAngle),0))}))}n(l)});return yield Promise.all(o),a}))}loadAnimationAsync(e,t){return me.LoadExtensionAsync(e,t,this.name,(n,r)=>T(this,null,function*(){let s=yield this._loader.loadAnimationAsync(e,t),o=new Array;se.Assign(r.events);for(let a of r.events)o.push(this._loadAnimationEventAsync(`${n}/events/${a.index}`,e,t,a,s));return yield Promise.all(o),s}))}_loadClipAsync(e,t){if(t._objectURL)return t._objectURL;let n;if(t.uri)n=this._loader.loadUriAsync(e,t,t.uri);else{let r=se.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,t.bufferView);n=this._loader.loadBufferViewAsync(`/bufferViews/${r.index}`,r)}return t._objectURL=n.then(r=>URL.createObjectURL(new Blob([r],{type:t.mimeType}))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){let n=new Array,r=t.name||`emitter${t.index}`,s={loop:!1,autoplay:!1,volume:t.volume==null?1:t.volume};for(let a=0;a<t.clips.length;a++){let l=`/extensions/${this.name}/clips`,c=se.Get(l,this._clips,t.clips[a].clip);n.push(this._loadClipAsync(`${l}/${t.clips[a].clip}`,c).then(u=>{let h=t._babylonSounds[a]=new $s(r,u,this._loader.babylonScene,null,s);h.refDistance=t.refDistance||1,h.maxDistance=t.maxDistance||256,h.rolloffFactor=t.rolloffFactor||1,h.distanceModel=t.distanceModel||"exponential"}))}let o=Promise.all(n).then(()=>{let a=t.clips.map(c=>c.weight||1),l=new rm(t.loop||!1,t._babylonSounds,a);t.innerAngle&&(l.directionalConeInnerAngle=2*z.ToDegrees(t.innerAngle)),t.outerAngle&&(l.directionalConeOuterAngle=2*z.ToDegrees(t.outerAngle)),t.volume&&(l.volume=t.volume),t._babylonData.sound=l});t._babylonData={loaded:o}}return t._babylonData.loaded}_getEventAction(e,t,n,r,s){switch(n){case"play":return o=>{let a=(s||0)+(o-r);t.play(a)};case"stop":return()=>{t.stop()};case"pause":return()=>{t.pause()};default:throw new Error(`${e}: Unsupported action ${n}`)}}_loadAnimationEventAsync(e,t,n,r,s){if(s.targetedAnimations.length==0)return Promise.resolve();let o=s.targetedAnimations[0],a=r.emitter,l=se.Get(`/extensions/${this.name}/emitters`,this._emitters,a);return this._loadEmitterAsync(e,l).then(()=>{let c=l._babylonData.sound;if(c){let u=new im(r.time,this._getEventAction(e,c,r.action,r.time,r.startOffset));o.animation.addEvent(u),s.onAnimationGroupEndObservable.add(()=>{c.stop()}),s.onAnimationGroupPauseObservable.add(()=>{c.pause()})}})}};he(mm);fe(mm,!0,i=>new Nx(i));var Lu="MSFT_lod",Lx=class{constructor(e){this.name=Lu,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new B,this.onMaterialLODsLoadedObservable=new B,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.maxLODsToLoad=this._loader.parent.extensionOptions[Lu]?.maxLODsToLoad??this.maxLODsToLoad,this.enabled=this._loader.isExtensionUsed(Lu)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){let t=Promise.all(this._nodePromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())});this._loader._completePromises.push(t)}for(let e=0;e<this._materialPromiseLODs.length;e++){let t=Promise.all(this._materialPromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())});this._loader._completePromises.push(t)}}loadSceneAsync(e,t){let n=this._loader.loadSceneAsync(e,t);return this._loadBufferLOD(this._bufferLODs,0),n}loadNodeAsync(e,t,n){return me.LoadExtensionAsync(e,t,this.name,(r,s)=>T(this,null,function*(){let o,a=this._getLODs(r,t,this._loader.gltf.nodes,s.ids);this._loader.logOpen(`${r}`);for(let l=0;l<a.length;l++){let c=a[l];l!==0&&(this._nodeIndexLOD=l,this._nodeSignalLODs[l]=this._nodeSignalLODs[l]||new fs);let u=d=>{n(d),d.setEnabled(!1)},h=this._loader.loadNodeAsync(`/nodes/${c.index}`,c,u).then(d=>{if(l!==0){let f=a[l-1];f._babylonTransformNode&&(this._disposeTransformNode(f._babylonTransformNode),delete f._babylonTransformNode)}return d.setEnabled(!0),d});this._nodePromiseLODs[l]=this._nodePromiseLODs[l]||[],l===0?o=h:(this._nodeIndexLOD=null,this._nodePromiseLODs[l].push(h))}return this._loader.logClose(),yield o}))}_loadMaterialAsync(e,t,n,r,s){return this._nodeIndexLOD?null:me.LoadExtensionAsync(e,t,this.name,(o,a)=>T(this,null,function*(){let l,c=this._getLODs(o,t,this._loader.gltf.materials,a.ids);this._loader.logOpen(`${o}`);for(let u=0;u<c.length;u++){let h=c[u];u!==0&&(this._materialIndexLOD=u);let d=this._loader._loadMaterialAsync(`/materials/${h.index}`,h,n,r,f=>{u===0&&s(f)}).then(f=>{if(u!==0){s(f);let p=c[u-1]._data;p[r]&&(this._disposeMaterials([p[r].babylonMaterial]),delete p[r])}return f});this._materialPromiseLODs[u]=this._materialPromiseLODs[u]||[],u===0?l=d:(this._materialIndexLOD=null,this._materialPromiseLODs[u].push(d))}return this._loader.logClose(),yield l}))}_loadUriAsync(e,t,n){if(this._nodeIndexLOD!==null){this._loader.log("deferred");let r=this._nodeIndexLOD-1;return this._nodeSignalLODs[r]=this._nodeSignalLODs[r]||new fs,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(()=>T(this,null,function*(){return yield this._loader.loadUriAsync(e,t,n)}))}else if(this._materialIndexLOD!==null){this._loader.log("deferred");let r=this._materialIndexLOD-1;return this._materialSignalLODs[r]=this._materialSignalLODs[r]||new fs,this._materialSignalLODs[r].promise.then(()=>T(this,null,function*(){return yield this._loader.loadUriAsync(e,t,n)}))}return null}loadBufferAsync(e,t,n,r){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);let s=(o,a)=>T(this,null,function*(){let l=n,c=l+r-1,u=o[a];return u?(u.start=Math.min(u.start,l),u.end=Math.max(u.end,c)):(u={start:l,end:c,loaded:new fs},o[a]=u),yield u.loaded.promise.then(h=>new Uint8Array(h.buffer,h.byteOffset+n-u.start,r))});return this._loader.log("deferred"),this._nodeIndexLOD!==null?s(this._nodeBufferLODs,this._nodeIndexLOD):this._materialIndexLOD!==null?s(this._materialBufferLODs,this._materialIndexLOD):s(this._bufferLODs,0)}return null}_loadBufferLOD(e,t){let n=e[t];n&&(this._loader.log(`Loading buffer range [${n.start}-${n.end}]`),this._loader.bin.readAsync(n.start,n.end-n.start+1).then(r=>{n.loaded.resolve(r)},r=>{n.loaded.reject(r)}))}_getLODs(e,t,n,r){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");let s=[];for(let o=r.length-1;o>=0;o--)if(s.push(se.Get(`${e}/ids/${r[o]}`,n,r[o])),s.length===this.maxLODsToLoad)return s;return s.push(t),s}_disposeTransformNode(e){let t=[],n=e.material;n&&t.push(n);for(let s of e.getChildMeshes())s.material&&t.push(s.material);e.dispose();let r=t.filter(s=>this._loader.babylonScene.meshes.every(o=>o.material!=s));this._disposeMaterials(r)}_disposeMaterials(e){let t={};for(let n of e){for(let r of n.getActiveTextures())t[r.uniqueId]=r;n.dispose()}for(let n in t)for(let r of this._loader.babylonScene.materials)r.hasTexture(t[n])&&delete t[n];for(let n in t)t[n].dispose()}};he(Lu);fe(Lu,!0,i=>new Lx(i));var gm="MSFT_minecraftMesh",Fx=class{constructor(e){this.name=gm,this._loader=e,this.enabled=this._loader.isExtensionUsed(gm)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return me.LoadExtraAsync(e,t,this.name,(r,s)=>T(this,null,function*(){if(s){if(!this._loader._pbrMaterialImpl)throw new Error(`${r}: Material type not supported`);let o=this._loader.loadMaterialPropertiesAsync(e,t,n);return n.needAlphaBlending()&&(n.forceDepthWrite=!0,n.separateCullingPass=!0),n.backFaceCulling=n.forceDepthWrite,n.twoSidedLighting=!0,yield o}}))}};he(gm);fe(gm,!0,i=>new Fx(i));var _m="MSFT_sRGBFactors",kx=class{constructor(e){this.name=_m,this._loader=e,this.enabled=this._loader.isExtensionUsed(_m)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,n){return me.LoadExtraAsync(e,t,this.name,(r,s)=>T(this,null,function*(){if(s){let o=this._loader._getOrCreateMaterialAdapter(n),a=this._loader.loadMaterialPropertiesAsync(e,t,n),l=n.getScene().getEngine().useExactSrgbConversions;return o.baseColorTexture||o.baseColor.toLinearSpaceToRef(o.baseColor,l),o.specularColorTexture||o.specularColor.toLinearSpaceToRef(o.specularColor,l),yield a}}))}};he(_m);fe(_m,!0,i=>new kx(i));var Bx={};function Nw(i,e,t){Bx[`${i}/${e}`]=t}function Lw(i){switch(i){case"FlowGraphPlayAnimationBlock":return()=>T(null,null,function*(){return(yield import("./chunk-IWBH5AWQ.js")).FlowGraphPlayAnimationBlock});case"FlowGraphStopAnimationBlock":return()=>T(null,null,function*(){return(yield import("./chunk-SYUEEVYK.js")).FlowGraphStopAnimationBlock});case"FlowGraphPauseAnimationBlock":return()=>T(null,null,function*(){return(yield import("./chunk-UWYB2JGW.js")).FlowGraphPauseAnimationBlock});case"FlowGraphInterpolationBlock":return()=>T(null,null,function*(){return(yield import("./chunk-B3TBZJCT.js")).FlowGraphInterpolationBlock});case"FlowGraphSceneReadyEventBlock":return()=>T(null,null,function*(){return(yield import("./chunk-DKTEIM3F.js")).FlowGraphSceneReadyEventBlock});case"FlowGraphSceneTickEventBlock":return()=>T(null,null,function*(){return(yield import("./chunk-O5G6NIGD.js")).FlowGraphSceneTickEventBlock});case"FlowGraphSendCustomEventBlock":return()=>T(null,null,function*(){return(yield import("./chunk-APC5A5IM.js")).FlowGraphSendCustomEventBlock});case"FlowGraphReceiveCustomEventBlock":return()=>T(null,null,function*(){return(yield import("./chunk-GC3SYUXH.js")).FlowGraphReceiveCustomEventBlock});case"FlowGraphMeshPickEventBlock":return()=>T(null,null,function*(){return(yield import("./chunk-BHKU4LWE.js")).FlowGraphMeshPickEventBlock});case"FlowGraphEBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphEBlock});case"FlowGraphPIBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphPiBlock});case"FlowGraphInfBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphInfBlock});case"FlowGraphNaNBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphNaNBlock});case"FlowGraphRandomBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphRandomBlock});case"FlowGraphAddBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphAddBlock});case"FlowGraphSubtractBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphSubtractBlock});case"FlowGraphMultiplyBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphMultiplyBlock});case"FlowGraphDivideBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphDivideBlock});case"FlowGraphAbsBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphAbsBlock});case"FlowGraphSignBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphSignBlock});case"FlowGraphTruncBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphTruncBlock});case"FlowGraphFloorBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphFloorBlock});case"FlowGraphCeilBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphCeilBlock});case"FlowGraphRoundBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphRoundBlock});case"FlowGraphFractBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphFractionBlock});case"FlowGraphNegationBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphNegationBlock});case"FlowGraphModuloBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphModuloBlock});case"FlowGraphMinBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphMinBlock});case"FlowGraphMaxBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphMaxBlock});case"FlowGraphClampBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphClampBlock});case"FlowGraphSaturateBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphSaturateBlock});case"FlowGraphMathInterpolationBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphMathInterpolationBlock});case"FlowGraphEqualityBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphEqualityBlock});case"FlowGraphLessThanBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphLessThanBlock});case"FlowGraphLessThanOrEqualBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphLessThanOrEqualBlock});case"FlowGraphGreaterThanBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphGreaterThanBlock});case"FlowGraphGreaterThanOrEqualBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphGreaterThanOrEqualBlock});case"FlowGraphIsNaNBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphIsNanBlock});case"FlowGraphIsInfBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphIsInfinityBlock});case"FlowGraphDegToRadBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphDegToRadBlock});case"FlowGraphRadToDegBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphRadToDegBlock});case"FlowGraphSinBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphSinBlock});case"FlowGraphCosBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphCosBlock});case"FlowGraphTanBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphTanBlock});case"FlowGraphASinBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphAsinBlock});case"FlowGraphACosBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphAcosBlock});case"FlowGraphATanBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphAtanBlock});case"FlowGraphATan2Block":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphAtan2Block});case"FlowGraphSinhBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphSinhBlock});case"FlowGraphCoshBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphCoshBlock});case"FlowGraphTanhBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphTanhBlock});case"FlowGraphASinhBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphAsinhBlock});case"FlowGraphACoshBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphAcoshBlock});case"FlowGraphATanhBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphAtanhBlock});case"FlowGraphExponentialBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphExpBlock});case"FlowGraphLogBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphLogBlock});case"FlowGraphLog2Block":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphLog2Block});case"FlowGraphLog10Block":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphLog10Block});case"FlowGraphSquareRootBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphSquareRootBlock});case"FlowGraphPowerBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphPowerBlock});case"FlowGraphCubeRootBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphCubeRootBlock});case"FlowGraphBitwiseAndBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphBitwiseAndBlock});case"FlowGraphBitwiseOrBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphBitwiseOrBlock});case"FlowGraphBitwiseNotBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphBitwiseNotBlock});case"FlowGraphBitwiseXorBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphBitwiseXorBlock});case"FlowGraphBitwiseLeftShiftBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphBitwiseLeftShiftBlock});case"FlowGraphBitwiseRightShiftBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphBitwiseRightShiftBlock});case"FlowGraphLengthBlock":return()=>T(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphLengthBlock});case"FlowGraphNormalizeBlock":return()=>T(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphNormalizeBlock});case"FlowGraphDotBlock":return()=>T(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphDotBlock});case"FlowGraphCrossBlock":return()=>T(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphCrossBlock});case"FlowGraphRotate2DBlock":return()=>T(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphRotate2DBlock});case"FlowGraphRotate3DBlock":return()=>T(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphRotate3DBlock});case"FlowGraphTransposeBlock":return()=>T(null,null,function*(){return(yield import("./chunk-AXVMSDDC.js")).FlowGraphTransposeBlock});case"FlowGraphDeterminantBlock":return()=>T(null,null,function*(){return(yield import("./chunk-AXVMSDDC.js")).FlowGraphDeterminantBlock});case"FlowGraphInvertMatrixBlock":return()=>T(null,null,function*(){return(yield import("./chunk-AXVMSDDC.js")).FlowGraphInvertMatrixBlock});case"FlowGraphMatrixMultiplicationBlock":return()=>T(null,null,function*(){return(yield import("./chunk-AXVMSDDC.js")).FlowGraphMatrixMultiplicationBlock});case"FlowGraphBranchBlock":return()=>T(null,null,function*(){return(yield import("./chunk-NZYBIKGY.js")).FlowGraphBranchBlock});case"FlowGraphSetDelayBlock":return()=>T(null,null,function*(){return(yield import("./chunk-5JNRLMPI.js")).FlowGraphSetDelayBlock});case"FlowGraphCancelDelayBlock":return()=>T(null,null,function*(){return(yield import("./chunk-3SUJL3OR.js")).FlowGraphCancelDelayBlock});case"FlowGraphCallCounterBlock":return()=>T(null,null,function*(){return(yield import("./chunk-L2A45L5C.js")).FlowGraphCallCounterBlock});case"FlowGraphDebounceBlock":return()=>T(null,null,function*(){return(yield import("./chunk-DDQBYROT.js")).FlowGraphDebounceBlock});case"FlowGraphThrottleBlock":return()=>T(null,null,function*(){return(yield import("./chunk-AWU4CHHC.js")).FlowGraphThrottleBlock});case"FlowGraphDoNBlock":return()=>T(null,null,function*(){return(yield import("./chunk-TFFHTY5Y.js")).FlowGraphDoNBlock});case"FlowGraphFlipFlopBlock":return()=>T(null,null,function*(){return(yield import("./chunk-ERTQHUJL.js")).FlowGraphFlipFlopBlock});case"FlowGraphForLoopBlock":return()=>T(null,null,function*(){return(yield import("./chunk-Z5Q52LBM.js")).FlowGraphForLoopBlock});case"FlowGraphMultiGateBlock":return()=>T(null,null,function*(){return(yield import("./chunk-SCU2NHAE.js")).FlowGraphMultiGateBlock});case"FlowGraphSequenceBlock":return()=>T(null,null,function*(){return(yield import("./chunk-SKAZSHFG.js")).FlowGraphSequenceBlock});case"FlowGraphSwitchBlock":return()=>T(null,null,function*(){return(yield import("./chunk-MFQEQ24R.js")).FlowGraphSwitchBlock});case"FlowGraphWaitAllBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XTRXXOHV.js")).FlowGraphWaitAllBlock});case"FlowGraphWhileLoopBlock":return()=>T(null,null,function*(){return(yield import("./chunk-NUEBBE4M.js")).FlowGraphWhileLoopBlock});case"FlowGraphConsoleLogBlock":return()=>T(null,null,function*(){return(yield import("./chunk-WWQR5TRT.js")).FlowGraphConsoleLogBlock});case"FlowGraphConditionalBlock":return()=>T(null,null,function*(){return(yield import("./chunk-LIGVGKV3.js")).FlowGraphConditionalDataBlock});case"FlowGraphConstantBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XN2NZR3U.js")).FlowGraphConstantBlock});case"FlowGraphTransformCoordinatesSystemBlock":return()=>T(null,null,function*(){return(yield import("./chunk-Y3X3H66N.js")).FlowGraphTransformCoordinatesSystemBlock});case"FlowGraphGetAssetBlock":return()=>T(null,null,function*(){return(yield import("./chunk-4GDXF62J.js")).FlowGraphGetAssetBlock});case"FlowGraphGetPropertyBlock":return()=>T(null,null,function*(){return(yield import("./chunk-3UQJTCDS.js")).FlowGraphGetPropertyBlock});case"FlowGraphSetPropertyBlock":return()=>T(null,null,function*(){return(yield import("./chunk-VSH4CFZJ.js")).FlowGraphSetPropertyBlock});case"FlowGraphGetVariableBlock":return()=>T(null,null,function*(){return(yield import("./chunk-FJIILSM2.js")).FlowGraphGetVariableBlock});case"FlowGraphSetVariableBlock":return()=>T(null,null,function*(){return(yield import("./chunk-NFODLYWC.js")).FlowGraphSetVariableBlock});case"FlowGraphJsonPointerParserBlock":return()=>T(null,null,function*(){return(yield import("./chunk-ADVS33HD.js")).FlowGraphJsonPointerParserBlock});case"FlowGraphLeadingZerosBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphLeadingZerosBlock});case"FlowGraphTrailingZerosBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphTrailingZerosBlock});case"FlowGraphOneBitsCounterBlock":return()=>T(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphOneBitsCounterBlock});case"FlowGraphCombineVector2Block":return()=>T(null,null,function*(){return(yield import("./chunk-YMNX5GDI.js")).FlowGraphCombineVector2Block});case"FlowGraphCombineVector3Block":return()=>T(null,null,function*(){return(yield import("./chunk-YMNX5GDI.js")).FlowGraphCombineVector3Block});case"FlowGraphCombineVector4Block":return()=>T(null,null,function*(){return(yield import("./chunk-YMNX5GDI.js")).FlowGraphCombineVector4Block});case"FlowGraphCombineMatrixBlock":return()=>T(null,null,function*(){return(yield import("./chunk-YMNX5GDI.js")).FlowGraphCombineMatrixBlock});case"FlowGraphExtractVector2Block":return()=>T(null,null,function*(){return(yield import("./chunk-YMNX5GDI.js")).FlowGraphExtractVector2Block});case"FlowGraphExtractVector3Block":return()=>T(null,null,function*(){return(yield import("./chunk-YMNX5GDI.js")).FlowGraphExtractVector3Block});case"FlowGraphExtractVector4Block":return()=>T(null,null,function*(){return(yield import("./chunk-YMNX5GDI.js")).FlowGraphExtractVector4Block});case"FlowGraphExtractMatrixBlock":return()=>T(null,null,function*(){return(yield import("./chunk-YMNX5GDI.js")).FlowGraphExtractMatrixBlock});case"FlowGraphTransformVectorBlock":return()=>T(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphTransformBlock});case"FlowGraphTransformCoordinatesBlock":return()=>T(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphTransformCoordinatesBlock});case"FlowGraphConjugateBlock":return()=>T(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphConjugateBlock});case"FlowGraphAngleBetweenBlock":return()=>T(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphAngleBetweenBlock});case"FlowGraphQuaternionFromAxisAngleBlock":return()=>T(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphQuaternionFromAxisAngleBlock});case"FlowGraphAxisAngleFromQuaternionBlock":return()=>T(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphAxisAngleFromQuaternionBlock});case"FlowGraphQuaternionFromDirectionsBlock":return()=>T(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphQuaternionFromDirectionsBlock});case"FlowGraphMatrixDecompose":return()=>T(null,null,function*(){return(yield import("./chunk-AXVMSDDC.js")).FlowGraphMatrixDecomposeBlock});case"FlowGraphMatrixCompose":return()=>T(null,null,function*(){return(yield import("./chunk-AXVMSDDC.js")).FlowGraphMatrixComposeBlock});case"FlowGraphBooleanToFloat":return()=>T(null,null,function*(){return(yield import("./chunk-UREIDWMS.js")).FlowGraphBooleanToFloat});case"FlowGraphBooleanToInt":return()=>T(null,null,function*(){return(yield import("./chunk-UREIDWMS.js")).FlowGraphBooleanToInt});case"FlowGraphFloatToBoolean":return()=>T(null,null,function*(){return(yield import("./chunk-UREIDWMS.js")).FlowGraphFloatToBoolean});case"FlowGraphIntToBoolean":return()=>T(null,null,function*(){return(yield import("./chunk-UREIDWMS.js")).FlowGraphIntToBoolean});case"FlowGraphIntToFloat":return()=>T(null,null,function*(){return(yield import("./chunk-UREIDWMS.js")).FlowGraphIntToFloat});case"FlowGraphFloatToInt":return()=>T(null,null,function*(){return(yield import("./chunk-UREIDWMS.js")).FlowGraphFloatToInt});case"FlowGraphEasingBlock":return()=>T(null,null,function*(){return(yield import("./chunk-MD3TQGGZ.js")).FlowGraphEasingBlock});case"FlowGraphBezierCurveEasing":return()=>T(null,null,function*(){return(yield import("./chunk-IO5SQJ5H.js")).FlowGraphBezierCurveEasingBlock});case"FlowGraphPointerOverEventBlock":return()=>T(null,null,function*(){return(yield import("./chunk-7IWPLIVX.js")).FlowGraphPointerOverEventBlock});case"FlowGraphPointerOutEventBlock":return()=>T(null,null,function*(){return(yield import("./chunk-7MO6QT47.js")).FlowGraphPointerOutEventBlock});case"FlowGraphContextBlock":return()=>T(null,null,function*(){return(yield import("./chunk-ZBPSPPJM.js")).FlowGraphContextBlock});case"FlowGraphArrayIndexBlock":return()=>T(null,null,function*(){return(yield import("./chunk-OM3ZAA7I.js")).FlowGraphArrayIndexBlock});case"FlowGraphCodeExecutionBlock":return()=>T(null,null,function*(){return(yield import("./chunk-AXADXAMC.js")).FlowGraphCodeExecutionBlock});case"FlowGraphIndexOfBlock":return()=>T(null,null,function*(){return(yield import("./chunk-BMUR2JGV.js")).FlowGraphIndexOfBlock});case"FlowGraphFunctionReference":return()=>T(null,null,function*(){return(yield import("./chunk-GX5IGO4H.js")).FlowGraphFunctionReferenceBlock});case"FlowGraphDataSwitchBlock":return()=>T(null,null,function*(){return(yield import("./chunk-3M5NJU3J.js")).FlowGraphDataSwitchBlock});default:if(Bx[i])return Bx[i];throw new Error(`Unknown block name ${i}`)}}function Ok(i,e){for(let t of i)for(let n of t.dataOutputs)if(n.uniqueId===e)return n;throw new Error("Could not find data out connection with unique id "+e)}function Nk(i,e){for(let t of i)if(t instanceof Ig){for(let n of t.signalInputs)if(n.uniqueId===e)return n}throw new Error("Could not find signal in connection with unique id "+e)}function Fw(i,e){return T(this,null,function*(){let t=yield Promise.all(i.allBlocks.map(n=>T(null,null,function*(){return yield Lw(n.className)()})));return Lk(i,e,t)})}function Lk(i,e,t){let n=e.coordinator.createGraph(),r=[],s=e.valueParseFunction??Fh;for(let o=0;o<i.allBlocks.length;o++){let a=i.allBlocks[o],l=kk(a,{scene:e.coordinator.config.scene,pathConverter:e.pathConverter,assetsContainer:e.coordinator.config.scene,valueParseFunction:s},t[o]);r.push(l),l instanceof qT&&n.addEventBlock(l)}for(let o of r){for(let a of o.dataInputs)for(let l of a.connectedPointIds){let c=Ok(r,l);a.connectTo(c)}if(o instanceof Ig)for(let a of o.signalOutputs)for(let l of a.connectedPointIds){let c=Nk(r,l);a.connectTo(c)}}for(let o of i.executionContexts)Fk(o,{graph:n,valueParseFunction:s},i.rightHanded);return n}function Fk(i,e,t){let n=e.graph.createContext();i.enableLogging&&(n.enableLogging=!0),n.treatDataAsRightHanded=t||!1;let r=e.valueParseFunction??Fh;n.uniqueId=i.uniqueId;let s=n.getScene();if(i._assetsContext){let o=i._assetsContext,a={meshes:o.meshes?.map(l=>s.getMeshById(l)),lights:o.lights?.map(l=>s.getLightByName(l)),cameras:o.cameras?.map(l=>s.getCameraByName(l)),materials:o.materials?.map(l=>s.getMaterialById(l)),textures:o.textures?.map(l=>s.getTextureByName(l)),animations:o.animations?.map(l=>s.animations.find(c=>c.name===l)),skeletons:o.skeletons?.map(l=>s.getSkeletonByName(l)),particleSystems:o.particleSystems?.map(l=>s.getParticleSystemById(l)),animationGroups:o.animationGroups?.map(l=>s.getAnimationGroupByName(l)),transformNodes:o.transformNodes?.map(l=>s.getTransformNodeById(l)),rootNodes:[],multiMaterials:[],morphTargetManagers:[],geometries:[],actionManagers:[],environmentTexture:null,postProcesses:[],sounds:null,effectLayers:[],layers:[],reflectionProbes:[],lensFlareSystems:[],proceduralTextures:[],getNodes:function(){throw new Error("Function not implemented.")}};n.assetsContext=a}for(let o in i._userVariables){let a=r(o,i._userVariables,n.assetsContext,s);n.userVariables[o]=a}for(let o in i._connectionValues){let a=r(o,i._connectionValues,n.assetsContext,s);n._setConnectionValueByKey(o,a)}return n}function kk(i,e,t){let n={},r=e.valueParseFunction??Fh;if(i.config)for(let o in i.config)n[o]=r(o,i.config,e.assetsContainer||e.scene,e.scene);if(jT(i.className)){if(!e.pathConverter)throw new Error("Path converter is required for this block");n.pathConverter=e.pathConverter}let s=new t(n);s.uniqueId=i.uniqueId;for(let o=0;o<i.dataInputs.length;o++){let a=s.getDataInput(i.dataInputs[o].name);if(a)a.deserialize(i.dataInputs[o]);else throw new Error("Could not find data input with name "+i.dataInputs[o].name+" in block "+i.className)}for(let o=0;o<i.dataOutputs.length;o++){let a=s.getDataOutput(i.dataOutputs[o].name);if(a)a.deserialize(i.dataOutputs[o]);else throw new Error("Could not find data output with name "+i.dataOutputs[o].name+" in block "+i.className)}return s.metadata=i.metadata,s.deserialize&&s.deserialize(i),s}function Vx(i){let[e,t]=i.split(":");return Gx({op:e,extension:t})}function Gx(i,e=!0){let t=i.extension?ym[i.extension]?.[i.op]:Bk[i.op];if(!t&&(N.Warn(`No mapping found for operation ${i.op} and extension ${i.extension||"KHR_interactivity"}`),e)){let n={},r={flows:{}};if(i.inputValueSockets){n.values={};for(let s in i.inputValueSockets)n.values[s]={name:s}}return i.outputValueSockets&&(r.values={},Object.keys(i.outputValueSockets).forEach(s=>{r.values[s]={name:s}})),{blocks:[],inputs:n,outputs:r}}return t}function Fu(i,e,t){ym[e]||(ym[e]={}),ym[e][i]=t}var ym={BABYLON:{"flow/log":{blocks:["FlowGraphConsoleLogBlock"],inputs:{values:{message:{name:"message"}}}}}},Bk={"event/onStart":{blocks:["FlowGraphSceneReadyEventBlock"],outputs:{flows:{out:{name:"done"}}}},"event/onTick":{blocks:["FlowGraphSceneTickEventBlock"],inputs:{},outputs:{values:{timeSinceLastTick:{name:"deltaTime",gltfType:"number"}},flows:{out:{name:"done"}}}},"event/send":{blocks:["FlowGraphSendCustomEventBlock"],extraProcessor(i,e,t,n,r){if(e.op!=="event/send"||!i.configuration||Object.keys(i.configuration).length!==1)throw new Error("Receive event should have a single configuration object, the event itself");let o=i.configuration.event.value[0];if(typeof o!="number")throw new Error("Event id should be a number");let a=n.arrays.events[o],l=r[0];return l.config||(l.config={}),l.config.eventId=a.eventId,l.config.eventData=a.eventData,r}},"event/receive":{blocks:["FlowGraphReceiveCustomEventBlock"],outputs:{flows:{out:{name:"done"}}},validation(i,e){if(!i.configuration)return N.Error("Receive event should have a configuration object"),{valid:!1,error:"Receive event should have a configuration object"};let t=i.configuration.event;if(!t)return N.Error("Receive event should have a single configuration object, the event itself"),{valid:!1,error:"Receive event should have a single configuration object, the event itself"};let n=t.value[0];return typeof n!="number"?(N.Error("Event id should be a number"),{valid:!1,error:"Event id should be a number"}):e.events?.[n]?{valid:!0}:(N.Error(`Event with id ${n} not found`),{valid:!1,error:`Event with id ${n} not found`})},extraProcessor(i,e,t,n,r){if(e.op!=="event/receive"||!i.configuration||Object.keys(i.configuration).length!==1)throw new Error("Receive event should have a single configuration object, the event itself");let o=i.configuration.event.value[0];if(typeof o!="number")throw new Error("Event id should be a number");let a=n.arrays.events[o],l=r[0];return l.config||(l.config={}),l.config.eventId=a.eventId,l.config.eventData=a.eventData,r}},"math/E":ye("FlowGraphEBlock"),"math/Pi":ye("FlowGraphPIBlock"),"math/Inf":ye("FlowGraphInfBlock"),"math/NaN":ye("FlowGraphNaNBlock"),"math/abs":ye("FlowGraphAbsBlock"),"math/sign":ye("FlowGraphSignBlock"),"math/trunc":ye("FlowGraphTruncBlock"),"math/floor":ye("FlowGraphFloorBlock"),"math/ceil":ye("FlowGraphCeilBlock"),"math/round":{blocks:["FlowGraphRoundBlock"],configuration:{},inputs:{values:{a:{name:"a"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(i,e,t,n,r){var s;return(s=r[0]).config||(s.config={}),r[0].config.roundHalfAwayFromZero=!0,r}},"math/fract":ye("FlowGraphFractBlock"),"math/neg":ye("FlowGraphNegationBlock"),"math/add":ye("FlowGraphAddBlock",["a","b"],!0),"math/sub":ye("FlowGraphSubtractBlock",["a","b"],!0),"math/mul":{blocks:["FlowGraphMultiplyBlock"],extraProcessor(i,e,t,n,r){var s;(s=r[0]).config||(s.config={}),r[0].config.useMatrixPerComponent=!0,r[0].config.preventIntegerFloatArithmetic=!0;let o=-1;return Object.keys(i.values||{}).find(a=>i.values?.[a].type!==void 0?(o=i.values[a].type,!0):!1),o!==-1&&(r[0].config.type=n.arrays.types[o].flowGraphType),r},validation(i){return i.values?kw(i):{valid:!0}}},"math/div":ye("FlowGraphDivideBlock",["a","b"],!0),"math/rem":ye("FlowGraphModuloBlock",["a","b"]),"math/min":ye("FlowGraphMinBlock",["a","b"]),"math/max":ye("FlowGraphMaxBlock",["a","b"]),"math/clamp":ye("FlowGraphClampBlock",["a","b","c"]),"math/saturate":ye("FlowGraphSaturateBlock"),"math/mix":ye("FlowGraphMathInterpolationBlock",["a","b","c"]),"math/eq":ye("FlowGraphEqualityBlock",["a","b"]),"math/lt":ye("FlowGraphLessThanBlock",["a","b"]),"math/le":ye("FlowGraphLessThanOrEqualBlock",["a","b"]),"math/gt":ye("FlowGraphGreaterThanBlock",["a","b"]),"math/ge":ye("FlowGraphGreaterThanOrEqualBlock",["a","b"]),"math/isNaN":ye("FlowGraphIsNaNBlock"),"math/isInf":ye("FlowGraphIsInfBlock"),"math/select":{blocks:["FlowGraphConditionalBlock"],inputs:{values:{condition:{name:"condition"},a:{name:"onTrue"},b:{name:"onFalse"}}},outputs:{values:{value:{name:"output"}}}},"math/random":{blocks:["FlowGraphRandomBlock"],outputs:{values:{value:{name:"value"}}}},"math/sin":ye("FlowGraphSinBlock"),"math/cos":ye("FlowGraphCosBlock"),"math/tan":ye("FlowGraphTanBlock"),"math/asin":ye("FlowGraphASinBlock"),"math/acos":ye("FlowGraphACosBlock"),"math/atan":ye("FlowGraphATanBlock"),"math/atan2":ye("FlowGraphATan2Block",["a","b"]),"math/sinh":ye("FlowGraphSinhBlock"),"math/cosh":ye("FlowGraphCoshBlock"),"math/tanh":ye("FlowGraphTanhBlock"),"math/asinh":ye("FlowGraphASinhBlock"),"math/acosh":ye("FlowGraphACoshBlock"),"math/atanh":ye("FlowGraphATanhBlock"),"math/exp":ye("FlowGraphExponentialBlock"),"math/log":ye("FlowGraphLogBlock"),"math/log2":ye("FlowGraphLog2Block"),"math/log10":ye("FlowGraphLog10Block"),"math/sqrt":ye("FlowGraphSquareRootBlock"),"math/cbrt":ye("FlowGraphCubeRootBlock"),"math/pow":ye("FlowGraphPowerBlock",["a","b"]),"math/length":ye("FlowGraphLengthBlock"),"math/normalize":ye("FlowGraphNormalizeBlock"),"math/dot":ye("FlowGraphDotBlock",["a","b"]),"math/cross":ye("FlowGraphCrossBlock",["a","b"]),"math/rotate2D":{blocks:["FlowGraphRotate2DBlock"],inputs:{values:{a:{name:"a"},angle:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/rotate3D":{blocks:["FlowGraphRotate3DBlock"],inputs:{values:{a:{name:"a"},rotation:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/transform":{blocks:["FlowGraphTransformVectorBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/combine2":{blocks:["FlowGraphCombineVector2Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/combine3":{blocks:["FlowGraphCombineVector3Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/combine4":{blocks:["FlowGraphCombineVector4Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/extract2":{blocks:["FlowGraphExtractVector2Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"}}}},"math/extract3":{blocks:["FlowGraphExtractVector3Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"}}}},"math/extract4":{blocks:["FlowGraphExtractVector4Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"}}}},"math/transpose":ye("FlowGraphTransposeBlock"),"math/determinant":ye("FlowGraphDeterminantBlock"),"math/inverse":ye("FlowGraphInvertMatrixBlock"),"math/matMul":ye("FlowGraphMatrixMultiplicationBlock",["a","b"]),"math/matCompose":{blocks:["FlowGraphMatrixCompose"],inputs:{values:{translation:{name:"position",gltfType:"float3"},rotation:{name:"rotationQuaternion",gltfType:"float4"},scale:{name:"scaling",gltfType:"float3"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(i,e,t,n,r,s){let o=r[0].dataInputs.find(a=>a.name==="rotationQuaternion");if(!o)throw new Error("Rotation quaternion input not found");return s._connectionValues[o.uniqueId]&&(s._connectionValues[o.uniqueId].type="Quaternion"),r}},"math/matDecompose":{blocks:["FlowGraphMatrixDecompose"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{translation:{name:"position"},rotation:{name:"rotationQuaternion"},scale:{name:"scaling"}}}},"math/quatConjugate":ye("FlowGraphConjugateBlock",["a"]),"math/quatMul":{blocks:["FlowGraphMultiplyBlock"],inputs:{values:{a:{name:"a",gltfType:"vector4"},b:{name:"b",gltfType:"vector4"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(i,e,t,n,r){var s;return(s=r[0]).config||(s.config={}),r[0].config.type="Quaternion",r}},"math/quatAngleBetween":ye("FlowGraphAngleBetweenBlock",["a","b"]),"math/quatFromAxisAngle":{blocks:["FlowGraphQuaternionFromAxisAngleBlock"],inputs:{values:{axis:{name:"a",gltfType:"float3"},angle:{name:"b",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/quatToAxisAngle":ye("FlowGraphAxisAngleFromQuaternionBlock",["a"]),"math/quatFromDirections":ye("FlowGraphQuaternionFromDirectionsBlock",["a","b"]),"math/combine2x2":{blocks:["FlowGraphCombineMatrix2DBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(i,e,t,n,r){var s;return(s=r[0]).config||(s.config={}),r[0].config.inputIsColumnMajor=!0,r}},"math/extract2x2":{blocks:["FlowGraphExtractMatrix2DBlock"],inputs:{values:{a:{name:"input",gltfType:"float2x2"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"}}}},"math/combine3x3":{blocks:["FlowGraphCombineMatrix3DBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"},e:{name:"input_4",gltfType:"number"},f:{name:"input_5",gltfType:"number"},g:{name:"input_6",gltfType:"number"},h:{name:"input_7",gltfType:"number"},i:{name:"input_8",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(i,e,t,n,r){var s;return(s=r[0]).config||(s.config={}),r[0].config.inputIsColumnMajor=!0,r}},"math/extract3x3":{blocks:["FlowGraphExtractMatrix3DBlock"],inputs:{values:{a:{name:"input",gltfType:"float3x3"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"},4:{name:"output_4"},5:{name:"output_5"},6:{name:"output_6"},7:{name:"output_7"},8:{name:"output_8"}}}},"math/combine4x4":{blocks:["FlowGraphCombineMatrixBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"},e:{name:"input_4",gltfType:"number"},f:{name:"input_5",gltfType:"number"},g:{name:"input_6",gltfType:"number"},h:{name:"input_7",gltfType:"number"},i:{name:"input_8",gltfType:"number"},j:{name:"input_9",gltfType:"number"},k:{name:"input_10",gltfType:"number"},l:{name:"input_11",gltfType:"number"},m:{name:"input_12",gltfType:"number"},n:{name:"input_13",gltfType:"number"},o:{name:"input_14",gltfType:"number"},p:{name:"input_15",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(i,e,t,n,r){var s;return(s=r[0]).config||(s.config={}),r[0].config.inputIsColumnMajor=!0,r}},"math/extract4x4":{blocks:["FlowGraphExtractMatrixBlock"],configuration:{},inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"},4:{name:"output_4"},5:{name:"output_5"},6:{name:"output_6"},7:{name:"output_7"},8:{name:"output_8"},9:{name:"output_9"},10:{name:"output_10"},11:{name:"output_11"},12:{name:"output_12"},13:{name:"output_13"},14:{name:"output_14"},15:{name:"output_15"}}}},"math/not":{blocks:["FlowGraphBitwiseNotBlock"],inputs:{values:{a:{name:"a"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(i,e,t,n,r,s){var o;(o=r[0]).config||(o.config={});let a=r[0].dataInputs[0];return r[0].config.valueType=s._connectionValues[a.uniqueId]?.type??"FlowGraphInteger",r}},"math/and":{blocks:["FlowGraphBitwiseAndBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(i,e,t,n,r,s){var o;(o=r[0]).config||(o.config={});let a=r[0].dataInputs[0],l=r[0].dataInputs[1];return r[0].config.valueType=s._connectionValues[a.uniqueId]?.type??s._connectionValues[l.uniqueId]?.type??"FlowGraphInteger",r}},"math/or":{blocks:["FlowGraphBitwiseOrBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(i,e,t,n,r,s){var o;(o=r[0]).config||(o.config={});let a=r[0].dataInputs[0],l=r[0].dataInputs[1];return r[0].config.valueType=s._connectionValues[a.uniqueId]?.type??s._connectionValues[l.uniqueId]?.type??"FlowGraphInteger",r}},"math/xor":{blocks:["FlowGraphBitwiseXorBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(i,e,t,n,r,s){var o;(o=r[0]).config||(o.config={});let a=r[0].dataInputs[0],l=r[0].dataInputs[1];return r[0].config.valueType=s._connectionValues[a.uniqueId]?.type??s._connectionValues[l.uniqueId]?.type??"FlowGraphInteger",r}},"math/asr":ye("FlowGraphBitwiseRightShiftBlock",["a","b"]),"math/lsl":ye("FlowGraphBitwiseLeftShiftBlock",["a","b"]),"math/clz":ye("FlowGraphLeadingZerosBlock"),"math/ctz":ye("FlowGraphTrailingZerosBlock"),"math/popcnt":ye("FlowGraphOneBitsCounterBlock"),"math/rad":ye("FlowGraphDegToRadBlock"),"math/deg":ye("FlowGraphRadToDegBlock"),"type/boolToInt":ye("FlowGraphBooleanToInt"),"type/boolToFloat":ye("FlowGraphBooleanToFloat"),"type/intToBool":ye("FlowGraphIntToBoolean"),"type/intToFloat":ye("FlowGraphIntToFloat"),"type/floatToInt":ye("FlowGraphFloatToInt"),"type/floatToBool":ye("FlowGraphFloatToBoolean"),"flow/sequence":{blocks:["FlowGraphSequenceBlock"],extraProcessor(i,e,t,n,r){let s=r[0];return s.config||(s.config={}),s.config.outputSignalCount=Object.keys(i.flows||[]).length,s.signalOutputs.forEach((o,a)=>{o.name="out_"+a}),r}},"flow/branch":{blocks:["FlowGraphBranchBlock"],outputs:{flows:{true:{name:"onTrue"},false:{name:"onFalse"}}}},"flow/switch":{blocks:["FlowGraphSwitchBlock"],configuration:{cases:{name:"cases",inOptions:!0,defaultValue:[]}},inputs:{values:{selection:{name:"case"},default:{name:"default"}}},validation(i){if(i.configuration&&i.configuration.cases){let e=i.configuration.cases.value;if(!e.every(r=>typeof r=="number"&&/^-?\d+$/.test(r.toString())))return N.Warn("Switch cases should be integers. Using empty array instead."),i.configuration.cases.value=[],{valid:!0};let n=new Set(e);i.configuration.cases.value=Array.from(n)}return{valid:!0}},extraProcessor(i,e,t,n,r){if(e.op!=="flow/switch"||!i.flows||Object.keys(i.flows).length===0)throw new Error("Switch should have a single configuration object, the cases array");return r[0].signalOutputs.forEach(o=>{o.name!=="default"&&(o.name="out_"+o.name)}),r}},"flow/while":{blocks:["FlowGraphWhileLoopBlock"],outputs:{flows:{loopBody:{name:"executionFlow"}}}},"flow/for":{blocks:["FlowGraphForLoopBlock"],configuration:{initialIndex:{name:"initialIndex",gltfType:"number",inOptions:!0,defaultValue:0}},inputs:{values:{startIndex:{name:"startIndex",gltfType:"number"},endIndex:{name:"endIndex",gltfType:"number"}}},outputs:{values:{index:{name:"index"}},flows:{loopBody:{name:"executionFlow"}}},extraProcessor(i,e,t,n,r){let s=r[0];return s.config||(s.config={}),s.config.incrementIndexWhenLoopDone=!0,r}},"flow/doN":{blocks:["FlowGraphDoNBlock"],configuration:{},inputs:{values:{n:{name:"maxExecutions",gltfType:"number"}}},outputs:{values:{currentCount:{name:"executionCount"}}}},"flow/multiGate":{blocks:["FlowGraphMultiGateBlock"],configuration:{isRandom:{name:"isRandom",gltfType:"boolean",inOptions:!0,defaultValue:!1},isLoop:{name:"isLoop",gltfType:"boolean",inOptions:!0,defaultValue:!1}},extraProcessor(i,e,t,n,r){if(e.op!=="flow/multiGate"||!i.flows||Object.keys(i.flows).length===0)throw new Error("MultiGate should have a single configuration object, the number of output flows");let s=r[0];return s.config||(s.config={}),s.config.outputSignalCount=Object.keys(i.flows).length,s.signalOutputs.forEach((o,a)=>{o.name="out_"+a}),r}},"flow/waitAll":{blocks:["FlowGraphWaitAllBlock"],configuration:{inputFlows:{name:"inputSignalCount",gltfType:"number",inOptions:!0,defaultValue:0}},inputs:{flows:{reset:{name:"reset"},"[segment]":{name:"in_$1"}}},validation(i){return typeof i.configuration?.inputFlows?.value[0]!="number"&&(i.configuration=i.configuration||{inputFlows:{value:[0]}},i.configuration.inputFlows.value=[0]),{valid:!0}}},"flow/throttle":{blocks:["FlowGraphThrottleBlock"],outputs:{flows:{err:{name:"error"}}}},"flow/setDelay":{blocks:["FlowGraphSetDelayBlock"],outputs:{flows:{err:{name:"error"}}}},"flow/cancelDelay":{blocks:["FlowGraphCancelDelayBlock"]},"variable/get":{blocks:["FlowGraphGetVariableBlock"],validation(i){return i.configuration?.variable?.value?{valid:!0}:(N.Error("Variable get block should have a variable configuration"),{valid:!1,error:"Variable get block should have a variable configuration"})},configuration:{variable:{name:"variable",gltfType:"number",flowGraphType:"string",inOptions:!0,isVariable:!0,dataTransformer(i,e){return[e.getVariableName(i[0])]}}}},"variable/set":{blocks:["FlowGraphSetVariableBlock"],configuration:{variable:{name:"variable",gltfType:"number",flowGraphType:"string",inOptions:!0,isVariable:!0,dataTransformer(i,e){return[e.getVariableName(i[0])]}}}},"variable/setMultiple":{blocks:["FlowGraphSetVariableBlock"],configuration:{variables:{name:"variables",gltfType:"number",flowGraphType:"string",inOptions:!0,dataTransformer(i,e){return[i[0].map(t=>e.getVariableName(t))]}}},extraProcessor(i,e,t,n,r){return r[0].dataInputs.forEach(o=>{o.name=n.getVariableName(+o.name)}),r}},"variable/interpolate":{blocks:["FlowGraphInterpolationBlock","FlowGraphContextBlock","FlowGraphPlayAnimationBlock","FlowGraphBezierCurveEasing","FlowGraphGetVariableBlock"],configuration:{variable:{name:"propertyName",inOptions:!0,isVariable:!0,dataTransformer(i,e){return[e.getVariableName(i[0])]}},useSlerp:{name:"animationType",inOptions:!0,defaultValue:!1,dataTransformer:i=>i[0]===!0?["Quaternion"]:[void 0]}},inputs:{values:{value:{name:"value_1"},duration:{name:"duration_1",gltfType:"number"},p1:{name:"controlPoint1",toBlock:"FlowGraphBezierCurveEasing"},p2:{name:"controlPoint2",toBlock:"FlowGraphBezierCurveEasing"}},flows:{in:{name:"in",toBlock:"FlowGraphPlayAnimationBlock"}}},outputs:{flows:{err:{name:"error",toBlock:"FlowGraphPlayAnimationBlock"},out:{name:"out",toBlock:"FlowGraphPlayAnimationBlock"},done:{name:"done",toBlock:"FlowGraphPlayAnimationBlock"}}},interBlockConnectors:[{input:"object",output:"userVariables",inputBlockIndex:2,outputBlockIndex:1,isVariable:!0},{input:"animation",output:"animation",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0},{input:"easingFunction",output:"easingFunction",inputBlockIndex:0,outputBlockIndex:3,isVariable:!0},{input:"value_0",output:"value",inputBlockIndex:0,outputBlockIndex:4,isVariable:!0}],extraProcessor(i,e,t,n,r){var s,o;let a=r[0],l=i.configuration?.variable.value[0];if(typeof l!="number")throw N.Error("Variable index is not defined for variable interpolation block"),new Error("Variable index is not defined for variable interpolation block");let c=n.arrays.staticVariables[l];typeof a.config.animationType.value>"u"&&(n.arrays.staticVariables,a.config.animationType.value=WT(c.type));let u=r[4];return u.config||(u.config={}),(s=u.config).variable||(s.variable={}),u.config.variable.value=n.getVariableName(l),(o=r[3]).config||(o.config={}),r}},"pointer/get":{blocks:["FlowGraphGetPropertyBlock","FlowGraphJsonPointerParserBlock"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customGetFunction",output:"getFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(i,e,t,n,r){return r.forEach(s=>{s.className==="FlowGraphJsonPointerParserBlock"&&(s.config||(s.config={}),s.config.outputValue=!0)}),r}},"pointer/set":{blocks:["FlowGraphSetPropertyBlock","FlowGraphJsonPointerParserBlock"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{value:{name:"value"},"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customSetFunction",output:"setFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(i,e,t,n,r){return r.forEach(s=>{s.className==="FlowGraphJsonPointerParserBlock"&&(s.config||(s.config={}),s.config.outputValue=!0)}),r}},"pointer/interpolate":{blocks:["FlowGraphInterpolationBlock","FlowGraphJsonPointerParserBlock","FlowGraphPlayAnimationBlock","FlowGraphBezierCurveEasing"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{value:{name:"value_1"},"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"},duration:{name:"duration_1",gltfType:"number"},p1:{name:"controlPoint1",toBlock:"FlowGraphBezierCurveEasing"},p2:{name:"controlPoint2",toBlock:"FlowGraphBezierCurveEasing"}},flows:{in:{name:"in",toBlock:"FlowGraphPlayAnimationBlock"}}},outputs:{flows:{err:{name:"error",toBlock:"FlowGraphPlayAnimationBlock"},out:{name:"out",toBlock:"FlowGraphPlayAnimationBlock"},done:{name:"done",toBlock:"FlowGraphPlayAnimationBlock"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:2,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customBuildAnimation",output:"generateAnimationsFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"animation",output:"animation",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0},{input:"easingFunction",output:"easingFunction",inputBlockIndex:0,outputBlockIndex:3,isVariable:!0},{input:"value_0",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(i,e,t,n,r){return r.forEach(s=>{s.className==="FlowGraphJsonPointerParserBlock"?(s.config||(s.config={}),s.config.outputValue=!0):s.className==="FlowGraphInterpolationBlock"&&(s.config||(s.config={}),Object.keys(i.values||[]).forEach(o=>{let a=i.values?.[o];if(o==="value"&&a){let l=a.type;l!==void 0&&(s.config.animationType=n.arrays.types[l].flowGraphType)}}))}),r}},"animation/start":{blocks:["FlowGraphPlayAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"},speed:{name:"speed",gltfType:"number"},startTime:{name:"from",gltfType:"number",dataTransformer:(i,e)=>[i[0]*e._animationTargetFps]},endTime:{name:"to",gltfType:"number",dataTransformer:(i,e)=>[i[0]*e._animationTargetFps]}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(i,e,t,n,r,s,o){let a=r[r.length-1];return a.config||(a.config={}),a.config.glTF=o,r}},"animation/stop":{blocks:["FlowGraphStopAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(i,e,t,n,r,s,o){let a=r[r.length-1];return a.config||(a.config={}),a.config.glTF=o,r}},"animation/stopAt":{blocks:["FlowGraphStopAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{},inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"},stopTime:{name:"stopAtFrame",gltfType:"number",dataTransformer:(i,e)=>[i[0]*e._animationTargetFps]}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(i,e,t,n,r,s,o){let a=r[r.length-1];return a.config||(a.config={}),a.config.glTF=o,r}},"math/switch":{blocks:["FlowGraphDataSwitchBlock"],configuration:{cases:{name:"cases",inOptions:!0,defaultValue:[]}},inputs:{values:{selection:{name:"case"}}},validation(i){if(i.configuration&&i.configuration.cases){let e=i.configuration.cases.value;if(!e.every(r=>typeof r=="number"&&/^-?\d+$/.test(r.toString())))return N.Warn("Switch cases should be integers. Using empty array instead."),i.configuration.cases.value=[],{valid:!0};let n=new Set(e);i.configuration.cases.value=Array.from(n)}return{valid:!0}},extraProcessor(i,e,t,n,r){let s=r[0];return s.dataInputs.forEach(o=>{o.name!=="default"&&o.name!=="case"&&(o.name="in_"+o.name)}),s.config||(s.config={}),s.config.treatCasesAsIntegers=!0,r}},"debug/log":{blocks:["FlowGraphConsoleLogBlock"],configuration:{message:{name:"messageTemplate",inOptions:!0}}}};function ye(i,e=["a"],t){return{blocks:[i],inputs:{values:e.reduce((n,r)=>(n[r]={name:r},n),{})},outputs:{values:{value:{name:"value"}}},extraProcessor(n,r,s,o,a){var l;if(t){(l=a[0]).config||(l.config={}),a[0].config.preventIntegerFloatArithmetic=!0;let c=-1;Object.keys(n.values||{}).find(u=>n.values?.[u].type!==void 0?(c=n.values[u].type,!0):!1),c!==-1&&(a[0].config.type=o.arrays.types[c].flowGraphType)}return a},validation(n){return t?kw(n):{valid:!0}}}}function kw(i){if(i.values){let e=Object.keys(i.values).map(n=>i.values[n].type).filter(n=>n!==void 0);if(!e.every(n=>n===e[0]))return{valid:!1,error:"All inputs must be of the same type"}}return{valid:!0}}var Vk={float:{length:1,flowGraphType:"number",elementType:"number"},bool:{length:1,flowGraphType:"boolean",elementType:"boolean"},float2:{length:2,flowGraphType:"Vector2",elementType:"number"},float3:{length:3,flowGraphType:"Vector3",elementType:"number"},float4:{length:4,flowGraphType:"Vector4",elementType:"number"},float4x4:{length:16,flowGraphType:"Matrix",elementType:"number"},float2x2:{length:4,flowGraphType:"Matrix2D",elementType:"number"},float3x3:{length:9,flowGraphType:"Matrix3D",elementType:"number"},int:{length:1,flowGraphType:"FlowGraphInteger",elementType:"number"}},vm=class{constructor(e,t,n=60){this._interactivityGraph=e,this._gltf=t,this._animationTargetFps=n,this._types=[],this._mappings=[],this._staticVariables=[],this._events=[],this._internalEventsCounter=0,this._nodes=[],this._parseTypes(),this._parseDeclarations(),this._parseVariables(),this._parseEvents(),this._parseNodes()}get arrays(){return{types:this._types,mappings:this._mappings,staticVariables:this._staticVariables,events:this._events,nodes:this._nodes}}_parseTypes(){if(this._interactivityGraph.types)for(let e of this._interactivityGraph.types)this._types.push(Vk[e.signature])}_parseDeclarations(){if(this._interactivityGraph.declarations)for(let e of this._interactivityGraph.declarations){let t=Gx(e);if(!t)throw N.Error(["No mapping found for declaration",e]),new Error("Error parsing declarations");this._mappings.push({flowGraphMapping:t,fullOperationName:e.extension?e.op+":"+e.extension:e.op})}}_parseVariables(){if(this._interactivityGraph.variables)for(let e of this._interactivityGraph.variables){let t=this._parseVariable(e);this._staticVariables.push(t)}}_parseVariable(e,t){let n=this._types[e.type];if(!n)throw N.Error(["No type found for variable",e]),new Error("Error parsing variables");if(e.value&&e.value.length!==n.length)throw N.Error(["Invalid value length for variable",e,n]),new Error("Error parsing variables");let r=e.value||[];if(!r.length)switch(n.flowGraphType){case"boolean":r.push(!1);break;case"FlowGraphInteger":r.push(0);break;case"number":r.push(NaN);break;case"Vector2":r.push(NaN,NaN);break;case"Vector3":r.push(NaN,NaN,NaN);break;case"Vector4":case"Matrix2D":case"Quaternion":r.fill(NaN,0,4);break;case"Matrix":r.fill(NaN,0,16);break;case"Matrix3D":r.fill(NaN,0,9);break;default:break}return n.elementType==="number"&&typeof r[0]=="string"&&(r[0]=parseFloat(r[0])),{type:n.flowGraphType,value:t?t(r,this):r}}_parseEvents(){if(this._interactivityGraph.events)for(let e of this._interactivityGraph.events){let t={eventId:e.id||"internalEvent_"+this._internalEventsCounter++};e.values&&(t.eventData=Object.keys(e.values).map(n=>{let r=e.values?.[n];if(!r)throw N.Error(["No value found for event key",n]),new Error("Error parsing events");let s=this._types[r.type];if(!s)throw N.Error(["No type found for event value",r]),new Error("Error parsing events");let o=typeof r.value<"u"?this._parseVariable(r):void 0;return{id:n,type:s.flowGraphType,eventData:!0,value:o}})),this._events.push(t)}}_parseNodes(){if(this._interactivityGraph.nodes)for(let e of this._interactivityGraph.nodes){if(typeof e.declaration!="number")throw N.Error(["No declaration found for node",e]),new Error("Error parsing nodes");let t=this._mappings[e.declaration];if(!t)throw N.Error(["No mapping found for node",e]),new Error("Error parsing nodes");if(t.flowGraphMapping.validation){let r=t.flowGraphMapping.validation(e,this._interactivityGraph,this._gltf);if(!r.valid)throw new Error(`Error validating interactivity node ${this._interactivityGraph.declarations?.[e.declaration].op} - ${r.error}`)}let n=[];for(let r of t.flowGraphMapping.blocks){let s=this._getEmptyBlock(r,t.fullOperationName);this._parseNodeConfiguration(e,s,t.flowGraphMapping,r),n.push(s)}this._nodes.push({blocks:n,fullOperationName:t.fullOperationName})}}_getEmptyBlock(e,t){return{uniqueId:ba(),className:e,dataInputs:[],dataOutputs:[],signalInputs:[],signalOutputs:[],config:{},type:t,metadata:{}}}_parseNodeConfiguration(e,t,n,r){let s=t.config;if(e.configuration){let o=Object.keys(e.configuration);for(let a of o){let l=e.configuration?.[a];if(!l)throw N.Error(["No value found for node configuration",a]),new Error("Error parsing node configuration");let c=n.configuration?.[a];if(c&&c.toBlock?c.toBlock===r:n.blocks.indexOf(r)===0){let h=c?.name||a;(!l||typeof l.value>"u")&&typeof c?.defaultValue<"u"?s[h]={value:c.defaultValue}:l.value.length>=0?s[h]={value:l.value.length===1?l.value[0]:l.value}:N.Warn(["Invalid value for node configuration",l]),c&&c.dataTransformer&&(s[h].value=c.dataTransformer([s[h].value],this)[0])}}}}_parseNodeConnections(e){for(let t=0;t<this._nodes.length;t++){let n=this._interactivityGraph.nodes?.[t];if(!n)throw N.Error(["No node found for interactivity node",this._nodes[t]]),new Error("Error parsing node connections");let r=this._nodes[t],s=this._mappings[n.declaration];if(!s)throw N.Error(["No mapping found for node",n]),new Error("Error parsing node connections");let o=n.flows||{},a=Object.keys(o).sort();for(let u of a){let h=o[u],d=s.flowGraphMapping.outputs?.flows?.[u],f=d?.name||u,p=this._createNewSocketConnection(f,!0);(d&&d.toBlock&&r.blocks.find(D=>D.className===d.toBlock)||r.blocks[0]).signalOutputs.push(p);let _=h.node,y=this._nodes[_];if(!y)throw N.Error(["No node found for input node id",_]),new Error("Error parsing node connections");let C=Vx(y.fullOperationName);if(!C)throw N.Error(["No mapping found for input node",y]),new Error("Error parsing node connections");let E=C.inputs?.flows?.[h.socket||"in"],I=!1;if(!E)for(let D in C.inputs?.flows)D.startsWith("[")&&D.endsWith("]")&&(I=!0,E=C.inputs?.flows?.[D]);let v=E?I?E.name.replace("$1",h.socket||""):E.name:h.socket||"in",x=E&&E.toBlock&&y.blocks.find(D=>D.className===E.toBlock)||y.blocks[0],b=x.signalInputs.find(D=>D.name===v);b||(b=this._createNewSocketConnection(v),x.signalInputs.push(b)),b.connectedPointIds.push(p.uniqueId),p.connectedPointIds.push(b.uniqueId)}let l=n.values||{},c=Object.keys(l);for(let u of c){let h=l[u],d=s.flowGraphMapping.inputs?.values?.[u],f=!1;if(!d)for(let y in s.flowGraphMapping.inputs?.values)y.startsWith("[")&&y.endsWith("]")&&(f=!0,d=s.flowGraphMapping.inputs?.values?.[y]);let p=d?f?d.name.replace("$1",u):d.name:u,g=this._createNewSocketConnection(p);if((d&&d.toBlock&&r.blocks.find(y=>y.className===d.toBlock)||r.blocks[0]).dataInputs.push(g),h.value!==void 0){let y=this._parseVariable(h,d&&d.dataTransformer);e._connectionValues[g.uniqueId]=y}else if(typeof h.node<"u"){let y=h.node,C=h.socket||"value",E=this._nodes[y];if(!E)throw N.Error(["No node found for output socket reference",h]),new Error("Error parsing node connections");let I=Vx(E.fullOperationName);if(!I)throw N.Error(["No mapping found for output socket reference",h]),new Error("Error parsing node connections");let v=I.outputs?.values?.[C],x=!1;if(!v)for(let R in I.outputs?.values)R.startsWith("[")&&R.endsWith("]")&&(x=!0,v=I.outputs?.values?.[R]);let b=v?x?v.name.replace("$1",C):v?.name:C,D=v&&v.toBlock&&E.blocks.find(R=>R.className===v.toBlock)||E.blocks[0],M=D.dataOutputs.find(R=>R.name===b);M||(M=this._createNewSocketConnection(b,!0),D.dataOutputs.push(M)),g.connectedPointIds.push(M.uniqueId),M.connectedPointIds.push(g.uniqueId)}else throw N.Error(["Invalid value for value connection",h]),new Error("Error parsing node connections")}if(s.flowGraphMapping.interBlockConnectors)for(let u of s.flowGraphMapping.interBlockConnectors){let h=u.input,d=u.output,f=u.isVariable;this._connectFlowGraphNodes(h,d,r.blocks[u.inputBlockIndex],r.blocks[u.outputBlockIndex],f)}if(s.flowGraphMapping.extraProcessor){let u=this._interactivityGraph.declarations?.[n.declaration];if(!u)throw N.Error(["No declaration found for extra processor",n]),new Error("Error parsing node connections");r.blocks=s.flowGraphMapping.extraProcessor(n,u,s.flowGraphMapping,this,r.blocks,e,this._gltf)}}}_createNewSocketConnection(e,t){return{uniqueId:ba(),name:e,_connectionType:t?1:0,connectedPointIds:[]}}_connectFlowGraphNodes(e,t,n,r,s){let o=s?n.dataInputs:n.signalInputs,a=s?r.dataOutputs:r.signalOutputs,l=o.find(u=>u.name===e)||this._createNewSocketConnection(e),c=a.find(u=>u.name===t)||this._createNewSocketConnection(t,!0);o.find(u=>u.name===e)||o.push(l),a.find(u=>u.name===t)||a.push(c),l.connectedPointIds.push(c.uniqueId),c.connectedPointIds.push(l.uniqueId)}getVariableName(e){return"staticVariable_"+e}serializeToFlowGraph(){let e={uniqueId:ba(),_userVariables:{},_connectionValues:{}};this._parseNodeConnections(e);for(let n=0;n<this._staticVariables.length;n++){let r=this._staticVariables[n];e._userVariables[this.getVariableName(n)]=r}return{rightHanded:!0,allBlocks:this._nodes.reduce((n,r)=>n.concat(r.blocks),[]),executionContexts:[e]}}};var ku="KHR_interactivity",Ux=class{constructor(e){this._loader=e,this.name=ku,this.enabled=this._loader.isExtensionUsed(ku),this._pathConverter=Lh(this._loader.gltf),e._skipStartAnimationStep=!0;let t=e.babylonScene;t&&Gk(t)}dispose(){this._loader=null,delete this._pathConverter}onReady(){return T(this,null,function*(){if(!this._loader.babylonScene||!this._pathConverter)return;let e=this._loader.babylonScene,t=this._loader.gltf.extensions?.KHR_interactivity;if(!t)return;let n=new Eg({scene:e});n.dispatchEventsSynchronously=!1;let r=t.graphs.map(s=>new vm(s,this._loader.gltf,this._loader.parent.targetFps).serializeToFlowGraph());yield Promise.all(r.map(s=>T(this,null,function*(){return yield Fw(s,{coordinator:n,pathConverter:this._pathConverter})}))),n.start()})}};function Gk(i){ti("/extensions/KHR_interactivity/?/activeCamera/rotation",{get:()=>{if(!i.activeCamera)return new J(NaN,NaN,NaN,NaN);let e=J.FromRotationMatrix(i.activeCamera.getWorldMatrix()).normalize();return i.useRightHandedSystem||(e.w*=-1,e.x*=-1),e},type:"Quaternion",getTarget:()=>i.activeCamera}),ti("/extensions/KHR_interactivity/?/activeCamera/position",{get:()=>{if(!i.activeCamera)return new m(NaN,NaN,NaN);let e=i.activeCamera.getWorldMatrix().getTranslation();return i.useRightHandedSystem||(e.x*=-1),e},type:"Vector3",getTarget:()=>i.activeCamera}),ti("/animations/{}/extensions/KHR_interactivity/isPlaying",{get:e=>e._babylonAnimationGroup?.isPlaying??!1,type:"boolean",getTarget:e=>e._babylonAnimationGroup}),ti("/animations/{}/extensions/KHR_interactivity/minTime",{get:e=>(e._babylonAnimationGroup?.from??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup}),ti("/animations/{}/extensions/KHR_interactivity/maxTime",{get:e=>(e._babylonAnimationGroup?.to??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup}),ti("/animations/{}/extensions/KHR_interactivity/playhead",{get:e=>(e._babylonAnimationGroup?.getCurrentFrame()??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup}),ti("/animations/{}/extensions/KHR_interactivity/virtualPlayhead",{get:e=>(e._babylonAnimationGroup?.getCurrentFrame()??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup})}Nw(ku,"FlowGraphGLTFDataProvider",()=>T(null,null,function*(){return(yield import("./chunk-K4FU3CPJ.js")).FlowGraphGLTFDataProvider}));he(ku);fe(ku,!0,i=>new Ux(i));var bm="KHR_node_visibility";ti("/nodes/{}/extensions/KHR_node_visibility/visible",{get:i=>{let e=i._babylonTransformNode;return e&&e.isVisible!==void 0?e.isVisible:!0},set:(i,e)=>{e._primitiveBabylonMeshes?.forEach(t=>{t.inheritVisibility=!0}),e._babylonTransformNode&&(e._babylonTransformNode.isVisible=i),e._primitiveBabylonMeshes?.forEach(t=>{t.isVisible=i})},getTarget:i=>i._babylonTransformNode,getPropertyName:[()=>"isVisible"],type:"boolean"});var zx=class{constructor(e){this.name=bm,this._loader=e,this.enabled=e.isExtensionUsed(bm)}onReady(){if(!this._loader)return;let e=this._loader.gltf.nodes;if(e)for(let t of e){let n=t._babylonTransformNode;n&&(n.inheritVisibility=!0,t.extensions&&t.extensions.KHR_node_visibility&&t.extensions.KHR_node_visibility.visible===!1&&(n.isVisible=!1))}}dispose(){delete this._loader}};he(bm);fe(bm,!0,i=>new zx(i));var Bu="KHR_node_selectability";Fu("event/onSelect",Bu,{blocks:["FlowGraphMeshPickEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(i){return["pickedMesh_"+i[0]]}}},outputs:{values:{selectedNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"},selectionPoint:{name:"pickedPoint"},selectionRayOrigin:{name:"pickOrigin"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"asset",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"pickedMesh",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(i,e,t,n,r,s,o){let a=r[r.length-1];a.config=a.config||{},a.config.glTF=o;let l=i.configuration?.nodeIndex?.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");let c="pickedMesh_"+l;return r[1].config.variable=c,s._userVariables[c]={className:"Mesh",id:o?.nodes?.[l]._babylonTransformNode?.id,uniqueId:o?.nodes?.[l]._babylonTransformNode?.uniqueId},r}});ti("/nodes/{}/extensions/KHR_node_selectability/selectable",{get:i=>{let e=i._babylonTransformNode;return e&&e.isPickable!==void 0?e.isPickable:!0},set:(i,e)=>{e._primitiveBabylonMeshes?.forEach(t=>{t.isPickable=i})},getTarget:i=>i._babylonTransformNode,getPropertyName:[()=>"isPickable"],type:"boolean"});var Hx=class{constructor(e){this.name=Bu,this._loader=e,this.enabled=e.isExtensionUsed(Bu)}onReady(){return T(this,null,function*(){this._loader.gltf.nodes?.forEach(e=>{e.extensions?.KHR_node_selectability&&e.extensions?.KHR_node_selectability.selectable===!1&&e._babylonTransformNode?.getChildMeshes().forEach(t=>{t.isPickable=!1})})})}dispose(){this._loader=null}};he(Bu);fe(Bu,!0,i=>new Hx(i));var Rl="KHR_node_hoverability",Bw="targetMeshPointerOver_";Fu("event/onHoverIn",Rl,{blocks:["FlowGraphPointerOverEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(i){return[Bw+i[0]]}}},outputs:{values:{hoverNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"targetMesh",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"meshUnderPointer",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(i,e,t,n,r,s,o){let a=r[r.length-1];a.config=a.config||{},a.config.glTF=o;let l=i.configuration?.nodeIndex?.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");let c=Bw+l;return r[1].config.variable=c,s._userVariables[c]={className:"Mesh",id:o?.nodes?.[l]._babylonTransformNode?.id,uniqueId:o?.nodes?.[l]._babylonTransformNode?.uniqueId},r}});var Vw="targetMeshPointerOut_";Fu("event/onHoverOut",Rl,{blocks:["FlowGraphPointerOutEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(i){return[Vw+i[0]]}}},outputs:{values:{hoverNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"targetMesh",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"meshOutOfPointer",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(i,e,t,n,r,s,o){let a=r[r.length-1];a.config=a.config||{},a.config.glTF=o;let l=i.configuration?.nodeIndex?.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");let c=Vw+l;return r[1].config.variable=c,s._userVariables[c]={className:"Mesh",id:o?.nodes?.[l]._babylonTransformNode?.id,uniqueId:o?.nodes?.[l]._babylonTransformNode?.uniqueId},r}});ti("/nodes/{}/extensions/KHR_node_hoverability/hoverable",{get:i=>{let e=i._babylonTransformNode;return e&&e.pointerOverDisableMeshTesting!==void 0?e.pointerOverDisableMeshTesting:!0},set:(i,e)=>{e._primitiveBabylonMeshes?.forEach(t=>{t.pointerOverDisableMeshTesting=!i})},getTarget:i=>i._babylonTransformNode,getPropertyName:[()=>"pointerOverDisableMeshTesting"],type:"boolean"});var $x=class{constructor(e){this.name=Rl,this._loader=e,this.enabled=e.isExtensionUsed(Rl)}onReady(){return T(this,null,function*(){this._loader.gltf.nodes?.forEach(e=>{e.extensions?.KHR_node_hoverability&&e.extensions?.KHR_node_hoverability.hoverable===!1&&e._babylonTransformNode?.getChildMeshes().forEach(t=>{t.pointerOverDisableMeshTesting=!0})})})}dispose(){this._loader=null}};he(Rl);fe(Rl,!0,i=>new $x(i));var jx="ExtrasAsMetadata",Wx=class{_assignExtras(e,t){if(t.extras&&Object.keys(t.extras).length>0){let n=e.metadata=e.metadata||{},r=n.gltf=n.gltf||{};r.extras=t.extras}}constructor(e){this.name=jx,this.enabled=!0,this._loader=e}dispose(){this._loader=null}loadNodeAsync(e,t,n){return this._loader.loadNodeAsync(e,t,r=>{this._assignExtras(r,t),n(r)})}loadCameraAsync(e,t,n){return this._loader.loadCameraAsync(e,t,r=>{this._assignExtras(r,t),n(r)})}createMaterial(e,t,n){let r=this._loader.createMaterial(e,t,n);return this._assignExtras(r,t),r}};he(jx);fe(jx,!1,i=>new Wx(i));var Pl=(()=>{class i{get camera(){return this._options.camera}set camera(t){this._options.camera=t}get renderingGroupId(){return this._options.renderingGroupId}set renderingGroupId(t){this._options.renderingGroupId=t}get objectRenderer(){return this._objectRenderer}get shaderLanguage(){return this._shaderLanguage}setMaterialForRendering(t,n){if(this._objectRenderer.setMaterialForRendering(t,n),Array.isArray(t))for(let r=0;r<t.length;++r){let s=t[r];n?this._materialForRendering[s.uniqueId]=[s,n]:delete this._materialForRendering[s.uniqueId]}else n?this._materialForRendering[t.uniqueId]=[t,n]:delete this._materialForRendering[t.uniqueId]}getEffectIntensity(t){return this._effectIntensity[t.uniqueId]??1}setEffectIntensity(t,n){this._effectIntensity[t.uniqueId]=n}constructor(t,n,r=!1,s=!1,o){this._additionalImportShadersAsync=o,this._vertexBuffers={},this._dontCheckIfReady=!1,this._shouldRender=!0,this._emissiveTextureAndColor={texture:null,color:new le},this._effectIntensity={},this._postProcesses=[],this.neutralColor=new le,this.isEnabled=!0,this.disableBoundingBoxesFromEffectLayer=!1,this.onDisposeObservable=new B,this.onBeforeRenderLayerObservable=new B,this.onBeforeComposeObservable=new B,this.onBeforeRenderMeshToEffect=new B,this.onAfterRenderMeshToEffect=new B,this.onAfterComposeObservable=new B,this.onBeforeBlurObservable=new B,this.onAfterBlurObservable=new B,this._shaderLanguage=0,this._materialForRendering={},this._shadersLoaded=!1,this.name=t,this._scene=n||Ie.LastCreatedScene,this._dontCheckIfReady=s,this._scene.getEngine().isWebGPU&&!r&&!i.ForceGLSL&&(this._shaderLanguage=1),this._engine=this._scene.getEngine(),this._mergeDrawWrapper=[],this._generateIndexBuffer(),this._generateVertexBuffer()}getEffectName(){return""}isReady(t,n){return!0}needStencil(){return!1}_createMergeEffect(){throw new Error("Effect Layer: no merge effect defined")}_createTextureAndPostProcesses(){}_internalCompose(t,n){}_setEmissiveTextureAndColor(t,n,r){}_numInternalDraws(){return 1}_init(t){this._options=K({mainTextureRatio:.5,mainTextureFixedSize:0,mainTextureType:0,alphaBlendingMode:2,camera:null,renderingGroupId:-1},t),this._createObjectRenderer()}_generateIndexBuffer(){let t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=this._engine.createIndexBuffer(t)}_generateVertexBuffer(){let t=[];t.push(1,1),t.push(-1,1),t.push(-1,-1),t.push(1,-1);let n=new S(this._engine,t,S.PositionKind,!1,!1,2);this._vertexBuffers[S.PositionKind]=n}_createObjectRenderer(){this._objectRenderer=new gT(`ObjectRenderer for thin effect layer ${this.name}`,this._scene,{doNotChangeAspectRatio:!0}),this._objectRenderer.activeCamera=this._options.camera,this._objectRenderer.renderParticles=!1,this._objectRenderer.renderList=null;let t=!!this._scene.getBoundingBoxRenderer,n=!1;t&&(this._objectRenderer.onBeforeRenderObservable.add(()=>{n=this._scene.getBoundingBoxRenderer().enabled,this._scene.getBoundingBoxRenderer().enabled=!this.disableBoundingBoxesFromEffectLayer&&n}),this._objectRenderer.onAfterRenderObservable.add(()=>{this._scene.getBoundingBoxRenderer().enabled=n})),this._objectRenderer.customIsReadyFunction=(r,s,o)=>{if((o||s===0)&&r.subMeshes)for(let a=0;a<r.subMeshes.length;++a){let l=r.subMeshes[a],c=l.getMaterial(),u=l.getRenderingMesh();if(!c)continue;let d=u._getInstancesRenderList(l._id,!!l.getReplacementMesh()).hardwareInstancedRendering[l._id]||u.hasThinInstances;if(this._setEmissiveTextureAndColor(u,l,c),!this._isSubMeshReady(l,d,this._emissiveTextureAndColor.texture))return!1}return!0},this._objectRenderer.customRenderFunction=(r,s,o,a)=>{this.onBeforeRenderLayerObservable.notifyObservers(this);let l,c=this._scene.getEngine();if(a.length){for(c.setColorWrite(!1),l=0;l<a.length;l++)this._renderSubMesh(a.data[l]);c.setColorWrite(!0)}for(l=0;l<r.length;l++)this._renderSubMesh(r.data[l]);for(l=0;l<s.length;l++)this._renderSubMesh(s.data[l]);let u=c.getAlphaMode();for(l=0;l<o.length;l++){let h=o.data[l],d=h.getMaterial();if(d&&d.needDepthPrePass){let f=d.getScene().getEngine();f.setColorWrite(!1),this._renderSubMesh(h),f.setColorWrite(!0)}this._renderSubMesh(h,!0)}c.setAlphaMode(u)}}_addCustomEffectDefines(t){}_internalIsSubMeshReady(t,n,r){let s=this._scene.getEngine(),o=t.getMesh(),a=o._internalAbstractMeshDataInfo._materialForRenderPass?.[s.currentRenderPassId];if(a)return a.isReadyForSubMesh(o,t,n);let l=t.getMaterial();if(!l)return!1;if(this._useMeshMaterial(t.getRenderingMesh()))return l.isReadyForSubMesh(t.getMesh(),t,n);let c=[],u=[S.PositionKind],h=!1,d=!1,f=!1;if(l){let I=l.needAlphaTestingForMesh(o),v=l.getAlphaTestTexture(),x=v&&v.hasAlpha&&(l.useAlphaFromDiffuseTexture||l._useAlphaFromAlbedoTexture);v&&(I||x)&&(c.push("#define DIFFUSE"),o.isVerticesDataPresent(S.UV2Kind)&&v.coordinatesIndex===1?(c.push("#define DIFFUSEUV2"),d=!0):o.isVerticesDataPresent(S.UVKind)&&(c.push("#define DIFFUSEUV1"),h=!0),I&&(c.push("#define ALPHATEST"),c.push("#define ALPHATESTVALUE 0.4")),v.gammaSpace||c.push("#define DIFFUSE_ISLINEAR"));let b=l.opacityTexture;b&&(c.push("#define OPACITY"),o.isVerticesDataPresent(S.UV2Kind)&&b.coordinatesIndex===1?(c.push("#define OPACITYUV2"),d=!0):o.isVerticesDataPresent(S.UVKind)&&(c.push("#define OPACITYUV1"),h=!0))}r&&(c.push("#define EMISSIVE"),o.isVerticesDataPresent(S.UV2Kind)&&r.coordinatesIndex===1?(c.push("#define EMISSIVEUV2"),d=!0):o.isVerticesDataPresent(S.UVKind)&&(c.push("#define EMISSIVEUV1"),h=!0),r.gammaSpace||c.push("#define EMISSIVE_ISLINEAR")),o.useVertexColors&&o.isVerticesDataPresent(S.ColorKind)&&o.hasVertexAlpha&&l.transparencyMode!==Oe.MATERIAL_OPAQUE&&(u.push(S.ColorKind),c.push("#define VERTEXALPHA")),h&&(u.push(S.UVKind),c.push("#define UV1")),d&&(u.push(S.UV2Kind),c.push("#define UV2"));let p=new fr;if(o.useBones&&o.computeBonesUsingShaders){u.push(S.MatricesIndicesKind),u.push(S.MatricesWeightsKind),o.numBoneInfluencers>4&&(u.push(S.MatricesIndicesExtraKind),u.push(S.MatricesWeightsExtraKind)),c.push("#define NUM_BONE_INFLUENCERS "+o.numBoneInfluencers);let I=o.skeleton;I&&I.isUsingTextureForMatrices?c.push("#define BONETEXTURE"):c.push("#define BonesPerMesh "+(I?I.bones.length+1:0)),o.numBoneInfluencers>0&&p.addCPUSkinningFallback(0,o)}else c.push("#define NUM_BONE_INFLUENCERS 0");let g=o.morphTargetManager?yh(o.morphTargetManager,c,u,o,!0,!1,!1,h,d,f):0;n&&(c.push("#define INSTANCES"),vh(u),t.getRenderingMesh().hasThinInstances&&c.push("#define THIN_INSTANCES")),xs(l,this._scene,c),this._addCustomEffectDefines(c);let _=t._getDrawWrapper(void 0,!0),y=_.defines,C=c.join(`
`);if(y!==C){let I=["world","mBones","viewProjection","glowColor","morphTargetInfluences","morphTargetCount","boneTextureWidth","diffuseMatrix","emissiveMatrix","opacityMatrix","opacityIntensity","morphTargetTextureInfo","morphTargetTextureIndices","glowIntensity"];Zn(I),_.setEffect(this._engine.createEffect("glowMapGeneration",u,I,["diffuseSampler","emissiveSampler","opacitySampler","boneSampler","morphTargets"],C,p,void 0,void 0,{maxSimultaneousMorphTargets:g},this._shaderLanguage,this._shadersLoaded?void 0:()=>T(this,null,function*(){yield this._importShadersAsync(),this._shadersLoaded=!0})),C)}return _.effect.isReady()&&(this._dontCheckIfReady||!this._dontCheckIfReady&&this.isLayerReady())}_isSubMeshReady(t,n,r){return this._internalIsSubMeshReady(t,n,r)}_importShadersAsync(){return T(this,null,function*(){this._shaderLanguage===1?yield Promise.all([import("./chunk-KL44RPIS.js"),import("./chunk-IX7PO7BN.js")]):yield Promise.all([import("./chunk-EHNKPXI2.js"),import("./chunk-HLJZYT6E.js")]),this._additionalImportShadersAsync?.()})}_internalIsLayerReady(){let t=!0;for(let r=0;r<this._postProcesses.length;r++)t=this._postProcesses[r].isReady()&&t;let n=this._numInternalDraws();for(let r=0;r<n;++r){let s=this._mergeDrawWrapper[r];s||(s=this._mergeDrawWrapper[r]=new mi(this._engine),s.setEffect(this._createMergeEffect())),t=s.effect.isReady()&&t}return t}isLayerReady(){return this._internalIsLayerReady()}compose(){if(!this._dontCheckIfReady&&!this.isLayerReady())return!1;let t=this._scene.getEngine(),n=this._numInternalDraws();this.onBeforeComposeObservable.notifyObservers(this);let r=t.getAlphaMode();for(let s=0;s<n;++s){let o=this._mergeDrawWrapper[s];t.enableEffect(o),t.setState(!1),t.bindBuffers(this._vertexBuffers,this._indexBuffer,o.effect),t.setAlphaMode(this._options.alphaBlendingMode),this._internalCompose(o.effect,s)}return t.setAlphaMode(r),this.onAfterComposeObservable.notifyObservers(this),!0}_internalHasMesh(t){return this.renderingGroupId===-1||t.renderingGroupId===this.renderingGroupId}hasMesh(t){return this._internalHasMesh(t)}_internalShouldRender(){return this.isEnabled&&this._shouldRender}shouldRender(){return this._internalShouldRender()}_shouldRenderMesh(t){return!0}_internalCanRenderMesh(t,n){return!n.needAlphaBlendingForMesh(t)}_canRenderMesh(t,n){return this._internalCanRenderMesh(t,n)}_renderSubMesh(t,n=!1){if(!this._internalShouldRender())return;let r=t.getMaterial(),s=t.getMesh(),o=t.getReplacementMesh(),a=t.getRenderingMesh(),l=t.getEffectiveMesh(),c=this._scene,u=c.getEngine();if(l._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!r||!this._canRenderMesh(a,r))return;let h=r._getEffectiveOrientation(a);l._getWorldMatrixDeterminant()<0&&(h=h===Oe.ClockWiseSideOrientation?Oe.CounterClockWiseSideOrientation:Oe.ClockWiseSideOrientation);let f=h===Oe.ClockWiseSideOrientation;u.setState(r.backFaceCulling,r.zOffset,void 0,f,r.cullBackFaces,void 0,r.zOffsetUnits);let p=a._getInstancesRenderList(t._id,!!o);if(p.mustReturn||!this._shouldRenderMesh(a))return;let g=p.hardwareInstancedRendering[t._id]||a.hasThinInstances;if(this._setEmissiveTextureAndColor(a,t,r),this.onBeforeRenderMeshToEffect.notifyObservers(s),this._useMeshMaterial(a))t.getMaterial()._glowModeEnabled=!0,a.render(t,n,o||void 0),t.getMaterial()._glowModeEnabled=!1;else if(this._isSubMeshReady(t,g,this._emissiveTextureAndColor.texture)){let _=l._internalAbstractMeshDataInfo._materialForRenderPass?.[u.currentRenderPassId],y=t._getDrawWrapper();if(!y&&_&&(y=_._getDrawWrapper()),!y)return;let C=y.effect;if(u.enableEffect(y),g||a._bind(t,C,r.fillMode),_?_.bindForSubMesh(l.getWorldMatrix(),l,t):(C.setMatrix("viewProjection",c.getTransformMatrix()),C.setMatrix("world",l.getWorldMatrix()),C.setFloat4("glowColor",this._emissiveTextureAndColor.color.r,this._emissiveTextureAndColor.color.g,this._emissiveTextureAndColor.color.b,this._emissiveTextureAndColor.color.a)),!_){let E=r.needAlphaTestingForMesh(l),I=r.getAlphaTestTexture(),v=I&&I.hasAlpha&&(r.useAlphaFromDiffuseTexture||r._useAlphaFromAlbedoTexture);if(I&&(E||v)){C.setTexture("diffuseSampler",I);let b=I.getTextureMatrix();b&&C.setMatrix("diffuseMatrix",b)}let x=r.opacityTexture;if(x){C.setTexture("opacitySampler",x),C.setFloat("opacityIntensity",x.level);let b=x.getTextureMatrix();b&&C.setMatrix("opacityMatrix",b)}if(this._emissiveTextureAndColor.texture&&(C.setTexture("emissiveSampler",this._emissiveTextureAndColor.texture),C.setMatrix("emissiveMatrix",this._emissiveTextureAndColor.texture.getTextureMatrix())),a.useBones&&a.computeBonesUsingShaders&&a.skeleton){let b=a.skeleton;if(b.isUsingTextureForMatrices){let D=b.getTransformMatrixTexture(a);if(!D)return;C.setTexture("boneSampler",D),C.setFloat("boneTextureWidth",4*(b.bones.length+1))}else C.setMatrices("mBones",b.getTransformMatrices(a))}Sa(a,C),a.morphTargetManager&&a.morphTargetManager.isUsingTextureForTargets&&a.morphTargetManager._bind(C),n&&u.setAlphaMode(r.alphaMode),C.setFloat("glowIntensity",this.getEffectIntensity(a)),Qn(C,r,c)}a._processRendering(l,t,C,r.fillMode,p,g,(E,I)=>C.setMatrix("world",I))}else this._objectRenderer.resetRefreshCounter();this.onAfterRenderMeshToEffect.notifyObservers(s)}_useMeshMaterial(t){return!1}_rebuild(){let t=this._vertexBuffers[S.PositionKind];t&&t._rebuild(),this._generateIndexBuffer()}dispose(){let t=this._vertexBuffers[S.PositionKind];t&&(t.dispose(),this._vertexBuffers[S.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);for(let n of this._mergeDrawWrapper)n.dispose();this._mergeDrawWrapper=[],this._objectRenderer.dispose(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderLayerObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear()}}return i.ForceGLSL=!1,i})();var ui=class i{get _shouldRender(){return this._thinEffectLayer._shouldRender}set _shouldRender(e){this._thinEffectLayer._shouldRender=e}get _emissiveTextureAndColor(){return this._thinEffectLayer._emissiveTextureAndColor}set _emissiveTextureAndColor(e){this._thinEffectLayer._emissiveTextureAndColor=e}get _effectIntensity(){return this._thinEffectLayer._effectIntensity}set _effectIntensity(e){this._thinEffectLayer._effectIntensity=e}static get ForceGLSL(){return Pl.ForceGLSL}static set ForceGLSL(e){Pl.ForceGLSL=e}get name(){return this._thinEffectLayer.name}set name(e){this._thinEffectLayer.name=e}get neutralColor(){return this._thinEffectLayer.neutralColor}set neutralColor(e){this._thinEffectLayer.neutralColor=e}get isEnabled(){return this._thinEffectLayer.isEnabled}set isEnabled(e){this._thinEffectLayer.isEnabled=e}get camera(){return this._thinEffectLayer.camera}get renderingGroupId(){return this._thinEffectLayer.renderingGroupId}set renderingGroupId(e){this._thinEffectLayer.renderingGroupId=e}get disableBoundingBoxesFromEffectLayer(){return this._thinEffectLayer.disableBoundingBoxesFromEffectLayer}set disableBoundingBoxesFromEffectLayer(e){this._thinEffectLayer.disableBoundingBoxesFromEffectLayer=e}get mainTexture(){return this._mainTexture}get _shaderLanguage(){return this._thinEffectLayer.shaderLanguage}get shaderLanguage(){return this._thinEffectLayer.shaderLanguage}setMaterialForRendering(e,t){this._thinEffectLayer.setMaterialForRendering(e,t)}getEffectIntensity(e){return this._thinEffectLayer.getEffectIntensity(e)}setEffectIntensity(e,t){this._thinEffectLayer.setEffectIntensity(e,t)}constructor(e,t,n=!1,r){this._mainTextureCreatedSize={width:0,height:0},this._maxSize=0,this._mainTextureDesiredSize={width:0,height:0},this._postProcesses=[],this._textures=[],this.uniqueId=_h.UniqueId,this.onDisposeObservable=new B,this.onBeforeRenderMainTextureObservable=new B,this.onBeforeComposeObservable=new B,this.onBeforeRenderMeshToEffect=new B,this.onAfterRenderMeshToEffect=new B,this.onAfterComposeObservable=new B,this.onSizeChangedObservable=new B,this._internalThinEffectLayer=!r,r||(r=new Pl(e,t,n,!1,this._importShadersAsync.bind(this)),r.getEffectName=this.getEffectName.bind(this),r.isReady=this.isReady.bind(this),r._createMergeEffect=this._createMergeEffect.bind(this),r._createTextureAndPostProcesses=this._createTextureAndPostProcesses.bind(this),r._internalCompose=this._internalRender.bind(this),r._setEmissiveTextureAndColor=this._setEmissiveTextureAndColor.bind(this),r._numInternalDraws=this._numInternalDraws.bind(this),r._addCustomEffectDefines=this._addCustomEffectDefines.bind(this),r.hasMesh=this.hasMesh.bind(this),r.shouldRender=this.shouldRender.bind(this),r._shouldRenderMesh=this._shouldRenderMesh.bind(this),r._canRenderMesh=this._canRenderMesh.bind(this),r._useMeshMaterial=this._useMeshMaterial.bind(this)),this._thinEffectLayer=r,this.name=e,this._scene=t||Ie.LastCreatedScene,i._SceneComponentInitialization(this._scene),this._engine=this._scene.getEngine(),this._maxSize=this._engine.getCaps().maxTextureSize,this._scene.addEffectLayer(this),this._thinEffectLayer.onDisposeObservable.add(()=>{this.onDisposeObservable.notifyObservers(this)}),this._thinEffectLayer.onBeforeRenderLayerObservable.add(()=>{this.onBeforeRenderMainTextureObservable.notifyObservers(this)}),this._thinEffectLayer.onBeforeComposeObservable.add(()=>{this.onBeforeComposeObservable.notifyObservers(this)}),this._thinEffectLayer.onBeforeRenderMeshToEffect.add(s=>{this.onBeforeRenderMeshToEffect.notifyObservers(s)}),this._thinEffectLayer.onAfterRenderMeshToEffect.add(s=>{this.onAfterRenderMeshToEffect.notifyObservers(s)}),this._thinEffectLayer.onAfterComposeObservable.add(()=>{this.onAfterComposeObservable.notifyObservers(this)})}get _shadersLoaded(){return this._thinEffectLayer._shadersLoaded}set _shadersLoaded(e){this._thinEffectLayer._shadersLoaded=e}_numInternalDraws(){return this._internalThinEffectLayer?1:this._thinEffectLayer._numInternalDraws()}_init(e){this._effectLayerOptions=K({mainTextureRatio:.5,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0,generateStencilBuffer:!1},e),this._setMainTextureSize(),this._thinEffectLayer._init(e),this._createMainTexture(),this._createTextureAndPostProcesses()}_setMainTextureSize(){this._effectLayerOptions.mainTextureFixedSize?(this._mainTextureDesiredSize.width=this._effectLayerOptions.mainTextureFixedSize,this._mainTextureDesiredSize.height=this._effectLayerOptions.mainTextureFixedSize):(this._mainTextureDesiredSize.width=this._engine.getRenderWidth()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.height=this._engine.getRenderHeight()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.width=this._engine.needPOTTextures?Kr(this._mainTextureDesiredSize.width,this._maxSize):this._mainTextureDesiredSize.width,this._mainTextureDesiredSize.height=this._engine.needPOTTextures?Kr(this._mainTextureDesiredSize.height,this._maxSize):this._mainTextureDesiredSize.height),this._mainTextureDesiredSize.width=Math.floor(this._mainTextureDesiredSize.width),this._mainTextureDesiredSize.height=Math.floor(this._mainTextureDesiredSize.height)}_createMainTexture(){this._mainTexture=new Tn("EffectLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,{type:this._effectLayerOptions.mainTextureType,samplingMode:te.TRILINEAR_SAMPLINGMODE,generateStencilBuffer:this._effectLayerOptions.generateStencilBuffer,existingObjectRenderer:this._thinEffectLayer.objectRenderer}),this._mainTexture.activeCamera=this._effectLayerOptions.camera,this._mainTexture.wrapU=te.CLAMP_ADDRESSMODE,this._mainTexture.wrapV=te.CLAMP_ADDRESSMODE,this._mainTexture.anisotropicFilteringLevel=1,this._mainTexture.updateSamplingMode(te.BILINEAR_SAMPLINGMODE),this._mainTexture.renderParticles=!1,this._mainTexture.renderList=null,this._mainTexture.ignoreCameraViewport=!0,this._mainTexture.onClearObservable.add(e=>{e.clear(this.neutralColor,!0,!0,!0)})}_addCustomEffectDefines(e){}_isReady(e,t,n){return this._internalThinEffectLayer?this._thinEffectLayer._internalIsSubMeshReady(e,t,n):this._thinEffectLayer._isSubMeshReady(e,t,n)}_importShadersAsync(){return T(this,null,function*(){})}_arePostProcessAndMergeReady(){return this._internalThinEffectLayer?this._thinEffectLayer._internalIsLayerReady():this._thinEffectLayer.isLayerReady()}isLayerReady(){return this._arePostProcessAndMergeReady()&&this._mainTexture.isReady()}render(){this._thinEffectLayer.compose()&&(this._setMainTextureSize(),(this._mainTextureCreatedSize.width!==this._mainTextureDesiredSize.width||this._mainTextureCreatedSize.height!==this._mainTextureDesiredSize.height)&&this._mainTextureDesiredSize.width!==0&&this._mainTextureDesiredSize.height!==0&&(this.onSizeChangedObservable.notifyObservers(this),this._disposeTextureAndPostProcesses(),this._createMainTexture(),this._createTextureAndPostProcesses(),this._mainTextureCreatedSize.width=this._mainTextureDesiredSize.width,this._mainTextureCreatedSize.height=this._mainTextureDesiredSize.height))}hasMesh(e){return this._internalThinEffectLayer?this._thinEffectLayer._internalHasMesh(e):this._thinEffectLayer.hasMesh(e)}shouldRender(){return this._internalThinEffectLayer?this._thinEffectLayer._internalShouldRender():this._thinEffectLayer.shouldRender()}_shouldRenderMesh(e){return this._internalThinEffectLayer?!0:this._thinEffectLayer._shouldRenderMesh(e)}_canRenderMesh(e,t){return this._internalThinEffectLayer?this._thinEffectLayer._internalCanRenderMesh(e,t):this._thinEffectLayer._canRenderMesh(e,t)}_shouldRenderEmissiveTextureForMesh(){return!0}_useMeshMaterial(e){return this._internalThinEffectLayer?!1:this._thinEffectLayer._useMeshMaterial(e)}_rebuild(){this._thinEffectLayer._rebuild()}_disposeTextureAndPostProcesses(){this._mainTexture.dispose();for(let e=0;e<this._postProcesses.length;e++)this._postProcesses[e]&&this._postProcesses[e].dispose();this._postProcesses=[];for(let e=0;e<this._textures.length;e++)this._textures[e]&&this._textures[e].dispose();this._textures=[]}dispose(){this._thinEffectLayer.dispose(),this._disposeTextureAndPostProcesses(),this._scene.removeEffectLayer(this),this.onDisposeObservable.clear(),this.onBeforeRenderMainTextureObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear(),this.onSizeChangedObservable.clear()}getClassName(){return"EffectLayer"}static Parse(e,t,n){return z.Instantiate(e.customType).Parse(e,t,n)}};ui._SceneComponentInitialization=i=>{throw Bn("EffectLayerSceneComponent")};w([L()],ui.prototype,"name",null);w([hT()],ui.prototype,"neutralColor",null);w([L()],ui.prototype,"isEnabled",null);w([dT()],ui.prototype,"camera",null);w([L()],ui.prototype,"renderingGroupId",null);w([L()],ui.prototype,"disableBoundingBoxesFromEffectLayer",null);Ws(Ge.NAME_EFFECTLAYER,(i,e,t,n)=>{if(i.effectLayers){t.effectLayers||(t.effectLayers=[]);for(let r=0;r<i.effectLayers.length;r++){let s=ui.Parse(i.effectLayers[r],e,n);t.effectLayers.push(s)}}});var qx=class{constructor(e){this.name=Ge.NAME_EFFECTLAYER,this._renderEffects=!1,this._needStencil=!1,this._previousStencilState=!1,this.scene=e||Ie.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine())}register(){this.scene._isReadyForMeshStage.registerStep(Ge.STEP_ISREADYFORMESH_EFFECTLAYER,this,this._isReadyForMesh),this.scene._cameraDrawRenderTargetStage.registerStep(Ge.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER,this,this._renderMainTexture),this.scene._beforeCameraDrawStage.registerStep(Ge.STEP_BEFORECAMERADRAW_EFFECTLAYER,this,this._setStencil),this.scene._afterRenderingGroupDrawStage.registerStep(Ge.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW,this,this._drawRenderingGroup),this.scene._afterCameraDrawStage.registerStep(Ge.STEP_AFTERCAMERADRAW_EFFECTLAYER,this,this._setStencilBack),this.scene._afterCameraDrawStage.registerStep(Ge.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW,this,this._drawCamera)}rebuild(){let e=this.scene.effectLayers;for(let t of e)t._rebuild()}serialize(e){e.effectLayers=[];let t=this.scene.effectLayers;for(let n of t)n.serialize&&e.effectLayers.push(n.serialize())}addFromContainer(e){if(e.effectLayers)for(let t of e.effectLayers)this.scene.addEffectLayer(t)}removeFromContainer(e,t){if(e.effectLayers)for(let n of e.effectLayers)this.scene.removeEffectLayer(n),t&&n.dispose()}dispose(){let e=this.scene.effectLayers;for(;e.length;)e[0].dispose()}_isReadyForMesh(e,t){let n=this._engine.currentRenderPassId,r=this.scene.effectLayers;for(let s of r){if(!s.hasMesh(e))continue;let o=s._mainTexture;this._engine.currentRenderPassId=o.renderPassId;for(let a of e.subMeshes)if(!s.isReady(a,t))return this._engine.currentRenderPassId=n,!1}return this._engine.currentRenderPassId=n,!0}_renderMainTexture(e){this._renderEffects=!1,this._needStencil=!1;let t=!1,n=this.scene.effectLayers;if(n&&n.length>0){this._previousStencilState=this._engine.getStencilBuffer();for(let r of n)if(r.shouldRender()&&(!r.camera||r.camera.cameraRigMode===Ne.RIG_MODE_NONE&&e===r.camera||r.camera.cameraRigMode!==Ne.RIG_MODE_NONE&&r.camera._rigCameras.indexOf(e)>-1)){this._renderEffects=!0,this._needStencil=this._needStencil||r.needStencil();let s=r._mainTexture;s._shouldRender()&&(this.scene.incrementRenderId(),s.render(!1,!1),t=!0)}this.scene.incrementRenderId()}return t}_setStencil(){this._needStencil&&this._engine.setStencilBuffer(!0)}_setStencilBack(){this._needStencil&&this._engine.setStencilBuffer(this._previousStencilState)}_draw(e){if(this._renderEffects){this._engine.setDepthBuffer(!1);let t=this.scene.effectLayers;for(let n=0;n<t.length;n++){let r=t[n];r.renderingGroupId===e&&r.shouldRender()&&r.render()}this._engine.setDepthBuffer(!0)}}_drawCamera(){this._renderEffects&&this._draw(-1)}_drawRenderingGroup(e){!this.scene._isInIntermediateRendering()&&this._renderEffects&&this._draw(e)}};ui._SceneComponentInitialization=i=>{let e=i._getComponent(Ge.NAME_EFFECTLAYER);e||(e=new qx(i),i._addComponent(e))};var Yx=(()=>{class i extends Pl{get ldrMerge(){return this._options.ldrMerge}set blurKernelSize(t){if(t===this._options.blurKernelSize)return;this._options.blurKernelSize=t;let n=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1.kernel=n,this._verticalBlurPostprocess1.kernel=n,this._horizontalBlurPostprocess2.kernel=n,this._verticalBlurPostprocess2.kernel=n}get blurKernelSize(){return this._options.blurKernelSize}set intensity(t){this._intensity=t}get intensity(){return this._intensity}constructor(t,n,r,s=!1){super(t,n,!1,s),this._intensity=1,this._includedOnlyMeshes=[],this._excludedMeshes=[],this._meshesUsingTheirOwnMaterials=[],this._renderPassId=0,this.neutralColor=new le(0,0,0,1),this._options=K({mainTextureRatio:.5,mainTextureFixedSize:0,mainTextureType:0,blurKernelSize:32,camera:null,renderingGroupId:-1,ldrMerge:!1,alphaBlendingMode:1},r),this._init(this._options),s&&this._createTextureAndPostProcesses()}getClassName(){return"GlowLayer"}_importShadersAsync(){return T(this,null,function*(){this._shaderLanguage===1?yield Promise.all([import("./chunk-LA7ELIX7.js"),import("./chunk-TTJLQDYV.js"),import("./chunk-GK3X5SFE.js")]):yield Promise.all([import("./chunk-NLCAKDMJ.js"),import("./chunk-EBYYQWWX.js"),import("./chunk-CZ4OIGAV.js")]),yield nT(i.prototype,this,"_importShadersAsync").call(this)})}getEffectName(){return i.EffectName}_createMergeEffect(){let t=`#define EMISSIVE 
`;return this._options.ldrMerge&&(t+=`#define LDR 
`),this._engine.createEffect("glowMapMerge",[S.PositionKind],["offset"],["textureSampler","textureSampler2"],t,void 0,void 0,void 0,void 0,this.shaderLanguage,this._shadersLoaded?void 0:()=>T(this,null,function*(){yield this._importShadersAsync(),this._shadersLoaded=!0}))}_createTextureAndPostProcesses(){let t=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1=new hc("GlowLayerHBP1",this._scene.getEngine(),new _e(1,0),t),this._verticalBlurPostprocess1=new hc("GlowLayerVBP1",this._scene.getEngine(),new _e(0,1),t),this._horizontalBlurPostprocess2=new hc("GlowLayerHBP2",this._scene.getEngine(),new _e(1,0),t),this._verticalBlurPostprocess2=new hc("GlowLayerVBP2",this._scene.getEngine(),new _e(0,1),t),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2]}_getEffectiveBlurKernelSize(){return this._options.blurKernelSize/2}isReady(t,n){let r=t.getMaterial(),s=t.getRenderingMesh();if(!r||!s)return!1;let o=r.emissiveTexture;return super._isSubMeshReady(t,n,o)}_canRenderMesh(t,n){return!0}_internalCompose(t){this.bindTexturesForCompose(t),t.setFloat("offset",this._intensity);let n=this._engine,r=n.getStencilBuffer();n.setStencilBuffer(!1),n.drawElementsType(Oe.TriangleFillMode,0,6),n.setStencilBuffer(r)}_setEmissiveTextureAndColor(t,n,r){let s=1;if(this.customEmissiveTextureSelector?this._emissiveTextureAndColor.texture=this.customEmissiveTextureSelector(t,n,r):r?(this._emissiveTextureAndColor.texture=r.emissiveTexture,this._emissiveTextureAndColor.texture&&(s=this._emissiveTextureAndColor.texture.level)):this._emissiveTextureAndColor.texture=null,this.customEmissiveColorSelector)this.customEmissiveColorSelector(t,n,r,this._emissiveTextureAndColor.color);else if(r.emissiveColor){let o=r.emissiveIntensity??1;s*=o,this._emissiveTextureAndColor.color.set(r.emissiveColor.r*s,r.emissiveColor.g*s,r.emissiveColor.b*s,r.alpha)}else this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)}_shouldRenderMesh(t){return this.hasMesh(t)}_addCustomEffectDefines(t){t.push("#define GLOW")}addExcludedMesh(t){this._excludedMeshes.indexOf(t.uniqueId)===-1&&this._excludedMeshes.push(t.uniqueId)}removeExcludedMesh(t){let n=this._excludedMeshes.indexOf(t.uniqueId);n!==-1&&this._excludedMeshes.splice(n,1)}addIncludedOnlyMesh(t){this._includedOnlyMeshes.indexOf(t.uniqueId)===-1&&this._includedOnlyMeshes.push(t.uniqueId)}removeIncludedOnlyMesh(t){let n=this._includedOnlyMeshes.indexOf(t.uniqueId);n!==-1&&this._includedOnlyMeshes.splice(n,1)}hasMesh(t){return super.hasMesh(t)?this._includedOnlyMeshes.length?this._includedOnlyMeshes.indexOf(t.uniqueId)!==-1:this._excludedMeshes.length?this._excludedMeshes.indexOf(t.uniqueId)===-1:!0:!1}_useMeshMaterial(t){return t.material?._supportGlowLayer?!0:this._meshesUsingTheirOwnMaterials.length==0?!1:this._meshesUsingTheirOwnMaterials.indexOf(t.uniqueId)>-1}referenceMeshToUseItsOwnMaterial(t){t.resetDrawCache(this._renderPassId),this._meshesUsingTheirOwnMaterials.push(t.uniqueId),t.onDisposeObservable.add(()=>{this._disposeMesh(t)})}unReferenceMeshFromUsingItsOwnMaterial(t,n){let r=this._meshesUsingTheirOwnMaterials.indexOf(t.uniqueId);for(;r>=0;)this._meshesUsingTheirOwnMaterials.splice(r,1),r=this._meshesUsingTheirOwnMaterials.indexOf(t.uniqueId);t.resetDrawCache(n)}_disposeMesh(t){this.removeIncludedOnlyMesh(t),this.removeExcludedMesh(t)}}return i.EffectName="GlowLayer",i.DefaultBlurKernelSize=32,i})();Pe.prototype.getGlowLayerByName=function(i){for(let e=0;e<this.effectLayers?.length;e++)if(this.effectLayers[e].name===i&&this.effectLayers[e].getEffectName()===Mi.EffectName)return this.effectLayers[e];return null};var Mi=class i extends ui{static get EffectName(){return Yx.EffectName}set blurKernelSize(e){this._thinEffectLayer.blurKernelSize=e}get blurKernelSize(){return this._thinEffectLayer.blurKernelSize}set intensity(e){this._thinEffectLayer.intensity=e}get intensity(){return this._thinEffectLayer.intensity}get customEmissiveColorSelector(){return this._thinEffectLayer.customEmissiveColorSelector}set customEmissiveColorSelector(e){this._thinEffectLayer.customEmissiveColorSelector=e}get customEmissiveTextureSelector(){return this._thinEffectLayer.customEmissiveTextureSelector}set customEmissiveTextureSelector(e){this._thinEffectLayer.customEmissiveTextureSelector=e}constructor(e,t,n){super(e,t,!1,new Yx(e,t,n)),this._options=K({mainTextureRatio:i.DefaultTextureRatio,blurKernelSize:32,mainTextureFixedSize:void 0,camera:null,mainTextureSamples:1,renderingGroupId:-1,ldrMerge:!1,alphaBlendingMode:1,mainTextureType:0,generateStencilBuffer:!1},n),this._init(this._options)}getEffectName(){return i.EffectName}_createMergeEffect(){return this._thinEffectLayer._createMergeEffect()}_createTextureAndPostProcesses(){this._thinEffectLayer._renderPassId=this._mainTexture.renderPassId;let e=this._mainTextureDesiredSize.width,t=this._mainTextureDesiredSize.height;e=this._engine.needPOTTextures?Kr(e,this._maxSize):e,t=this._engine.needPOTTextures?Kr(t,this._maxSize):t;let n=0;this._engine.getCaps().textureHalfFloatRender?n=2:n=0,this._blurTexture1=new Tn("GlowLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,n),this._blurTexture1.wrapU=te.CLAMP_ADDRESSMODE,this._blurTexture1.wrapV=te.CLAMP_ADDRESSMODE,this._blurTexture1.updateSamplingMode(te.BILINEAR_SAMPLINGMODE),this._blurTexture1.renderParticles=!1,this._blurTexture1.ignoreCameraViewport=!0;let r=Math.floor(e/2),s=Math.floor(t/2);this._blurTexture2=new Tn("GlowLayerBlurRTT2",{width:r,height:s},this._scene,!1,!0,n),this._blurTexture2.wrapU=te.CLAMP_ADDRESSMODE,this._blurTexture2.wrapV=te.CLAMP_ADDRESSMODE,this._blurTexture2.updateSamplingMode(te.BILINEAR_SAMPLINGMODE),this._blurTexture2.renderParticles=!1,this._blurTexture2.ignoreCameraViewport=!0,this._textures=[this._blurTexture1,this._blurTexture2],this._thinEffectLayer.bindTexturesForCompose=u=>{u.setTexture("textureSampler",this._blurTexture1),u.setTexture("textureSampler2",this._blurTexture2),u.setFloat("offset",this.intensity)},this._thinEffectLayer._createTextureAndPostProcesses();let o=this._thinEffectLayer._postProcesses[0];this._horizontalBlurPostprocess1=new bs("GlowLayerHBP1",o.direction,o.kernel,{samplingMode:te.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),width:e,height:t,textureType:n,effectWrapper:o}),this._horizontalBlurPostprocess1.width=e,this._horizontalBlurPostprocess1.height=t,this._horizontalBlurPostprocess1.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess1.onApplyObservable.add(u=>{u.setTexture("textureSampler",this._mainTexture)});let a=this._thinEffectLayer._postProcesses[1];this._verticalBlurPostprocess1=new bs("GlowLayerVBP1",a.direction,a.kernel,{samplingMode:te.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),width:e,height:t,textureType:n,effectWrapper:a});let l=this._thinEffectLayer._postProcesses[2];this._horizontalBlurPostprocess2=new bs("GlowLayerHBP2",l.direction,l.kernel,{samplingMode:te.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),width:r,height:s,textureType:n,effectWrapper:l}),this._horizontalBlurPostprocess2.width=r,this._horizontalBlurPostprocess2.height=s,this._horizontalBlurPostprocess2.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess2.onApplyObservable.add(u=>{u.setTexture("textureSampler",this._blurTexture1)});let c=this._thinEffectLayer._postProcesses[3];this._verticalBlurPostprocess2=new bs("GlowLayerVBP2",c.direction,c.kernel,{samplingMode:te.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),width:r,height:s,textureType:n,effectWrapper:c}),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._postProcesses1=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1],this._postProcesses2=[this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._mainTexture.samples=this._options.mainTextureSamples,this._mainTexture.onAfterUnbindObservable.add(()=>{let u=this._blurTexture1.renderTarget;if(u){this._scene.postProcessManager.directRender(this._postProcesses1,u,!0);let h=this._blurTexture2.renderTarget;h&&this._scene.postProcessManager.directRender(this._postProcesses2,h,!0),this._engine.unBindFramebuffer(h??u,!0)}}),this._postProcesses.map(u=>{u.autoClear=!1})}isReady(e,t){return this._thinEffectLayer.isReady(e,t)}needStencil(){return!1}_canRenderMesh(e,t){return this._thinEffectLayer._canRenderMesh(e,t)}_internalRender(e){this._thinEffectLayer._internalCompose(e)}_setEmissiveTextureAndColor(e,t,n){this._thinEffectLayer._setEmissiveTextureAndColor(e,t,n)}_shouldRenderMesh(e){return this._thinEffectLayer._shouldRenderMesh(e)}_addCustomEffectDefines(e){this._thinEffectLayer._addCustomEffectDefines(e)}addExcludedMesh(e){this._thinEffectLayer.addExcludedMesh(e)}removeExcludedMesh(e){this._thinEffectLayer.removeExcludedMesh(e)}addIncludedOnlyMesh(e){this._thinEffectLayer.addIncludedOnlyMesh(e)}removeIncludedOnlyMesh(e){this._thinEffectLayer.removeIncludedOnlyMesh(e)}hasMesh(e){return this._thinEffectLayer.hasMesh(e)}_useMeshMaterial(e){return this._thinEffectLayer._useMeshMaterial(e)}referenceMeshToUseItsOwnMaterial(e){this._thinEffectLayer.referenceMeshToUseItsOwnMaterial(e)}unReferenceMeshFromUsingItsOwnMaterial(e){this._thinEffectLayer.unReferenceMeshFromUsingItsOwnMaterial(e,this._mainTexture.renderPassId)}_disposeMesh(e){this._thinEffectLayer._disposeMesh(e)}getClassName(){return"GlowLayer"}serialize(){let e=Xe.Serialize(this);e.customType="BABYLON.GlowLayer";let t;e.includedMeshes=[];let n=this._thinEffectLayer._includedOnlyMeshes;if(n.length)for(t=0;t<n.length;t++){let s=this._scene.getMeshByUniqueId(n[t]);s&&e.includedMeshes.push(s.id)}e.excludedMeshes=[];let r=this._thinEffectLayer._excludedMeshes;if(r.length)for(t=0;t<r.length;t++){let s=this._scene.getMeshByUniqueId(r[t]);s&&e.excludedMeshes.push(s.id)}return e}static Parse(e,t,n){let r=Xe.Parse(()=>new i(e.name,t,e.options),e,t,n),s;for(s=0;s<e.excludedMeshes.length;s++){let o=t.getMeshById(e.excludedMeshes[s]);o&&r.addExcludedMesh(o)}for(s=0;s<e.includedMeshes.length;s++){let o=t.getMeshById(e.includedMeshes[s]);o&&r.addIncludedOnlyMesh(o)}return r}};Mi.DefaultBlurKernelSize=32;Mi.DefaultTextureRatio=.5;w([L()],Mi.prototype,"blurKernelSize",null);w([L()],Mi.prototype,"intensity",null);w([L("options")],Mi.prototype,"_options",void 0);ue("BABYLON.GlowLayer",Mi);function Gw(i){let e=i.pathArray,t=i.closeArray||!1,n=i.closePath||!1,r=i.invertUV||!1,s=Math.floor(e[0].length/2),o=i.offset||s;o=o>s?s:Math.floor(o);let a=i.sideOrientation===0?0:i.sideOrientation||X.DEFAULTSIDE,l=i.uvs,c=i.colors,u=[],h=[],d=[],f=[],p=[],g=[],_=[],y=[],C,E=[],I=[],v,x,b;if(e.length<2){let ge=[],We=[];for(x=0;x<e[0].length-o;x++)ge.push(e[0][x]),We.push(e[0][x+o]);e=[ge,We]}let D=0,M=n?1:0,R=t?1:0,W,ie;C=e[0].length;let ce,Q;for(v=0;v<e.length+R;v++){for(_[v]=0,p[v]=[0],W=v===e.length?e[0]:e[v],ie=W.length,C=C<ie?C:ie,b=0;b<ie;)u.push(W[b].x,W[b].y,W[b].z),b>0&&(ce=W[b].subtract(W[b-1]).length(),Q=ce+_[v],p[v].push(Q),_[v]=Q),b++;n&&(b--,u.push(W[0].x,W[0].y,W[0].z),ce=W[b].subtract(W[0]).length(),Q=ce+_[v],p[v].push(Q),_[v]=Q),E[v]=ie+M,I[v]=D,D+=ie+M}let de,oe,pe=null,ve=null;for(x=0;x<C+M;x++)for(y[x]=0,g[x]=[0],v=0;v<e.length-1+R;v++)de=e[v],oe=v===e.length-1?e[0]:e[v+1],x===C?(pe=de[0],ve=oe[0]):(pe=de[x],ve=oe[x]),ce=ve.subtract(pe).length(),Q=ce+y[x],g[x].push(Q),y[x]=Q;let $,j;if(l)for(v=0;v<l.length;v++)f.push(l[v].x,we?1-l[v].y:l[v].y);else for(v=0;v<e.length+R;v++)for(x=0;x<C+M;x++)$=_[v]!=0?p[v][x]/_[v]:0,j=y[x]!=0?g[x][v]/y[x]:0,r?f.push(j,$):f.push($,we?1-j:j);v=0;let O=0,k=E[v]-1,F=E[v+1]-1,q=k<F?k:F,be=I[1]-I[0],re=E.length-1;for(;O<=q&&v<re;)h.push(O,O+be,O+1),h.push(O+be+1,O+1,O+be),O+=1,O===q&&(v++,be=I[v+1]-I[v],k=E[v]-1,F=E[v+1]-1,O=I[v],q=k<F?k+O:F+O);if(X.ComputeNormals(u,h,d),n){let ge=0,We=0;for(v=0;v<e.length;v++){ge=I[v]*3,v+1<e.length?We=(I[v+1]-1)*3:We=d.length-3,d[ge]=(d[ge]+d[We])*.5,d[ge+1]=(d[ge+1]+d[We+1])*.5,d[ge+2]=(d[ge+2]+d[We+2])*.5;let Ce=Math.sqrt(d[ge]*d[ge]+d[ge+1]*d[ge+1]+d[ge+2]*d[ge+2]);d[ge]/=Ce,d[ge+1]/=Ce,d[ge+2]/=Ce,d[We]=d[ge],d[We+1]=d[ge+1],d[We+2]=d[ge+2]}}if(t){let ge=I[0]*3,We=I[e.length]*3;for(x=0;x<C+M;x++){d[ge]=(d[ge]+d[We])*.5,d[ge+1]=(d[ge+1]+d[We+1])*.5,d[ge+2]=(d[ge+2]+d[We+2])*.5;let Ce=Math.sqrt(d[ge]*d[ge]+d[ge+1]*d[ge+1]+d[ge+2]*d[ge+2]);d[ge]/=Ce,d[ge+1]/=Ce,d[ge+2]/=Ce,d[We]=d[ge],d[We+1]=d[ge+1],d[We+2]=d[ge+2],ge+=3,We+=3}}X._ComputeSides(a,u,h,d,f,i.frontUVs,i.backUVs);let Se=null;if(c){Se=new Float32Array(c.length*4);for(let ge=0;ge<c.length;ge++)Se[ge*4]=c[ge].r,Se[ge*4+1]=c[ge].g,Se[ge*4+2]=c[ge].b,Se[ge*4+3]=c[ge].a}let Qe=new X,zt=new Float32Array(u),bt=new Float32Array(d),Ht=new Float32Array(f);return Qe.indices=h,Qe.positions=zt,Qe.normals=bt,Qe.uvs=Ht,Se&&Qe.set(Se,S.ColorKind),n&&(Qe._idx=I),Qe}function cr(i,e,t=null){let n=e.pathArray,r=e.closeArray,s=e.closePath,o=A._GetDefaultSideOrientation(e.sideOrientation),a=e.instance,l=e.updatable;if(a){let c=U.Vector3[0].setAll(Number.MAX_VALUE),u=U.Vector3[1].setAll(-Number.MAX_VALUE),h=f=>{let p=n[0].length,g=a,_=0,y=g._originalBuilderSideOrientation===A.DOUBLESIDE?2:1;for(let C=1;C<=y;++C)for(let E=0;E<n.length;++E){let I=n[E],v=I.length;p=p<v?p:v;for(let x=0;x<p;++x){let b=I[x];f[_]=b.x,f[_+1]=b.y,f[_+2]=b.z,c.minimizeInPlaceFromFloats(b.x,b.y,b.z),u.maximizeInPlaceFromFloats(b.x,b.y,b.z),_+=3}if(g._creationDataStorage&&g._creationDataStorage.closePath){let x=I[0];f[_]=x.x,f[_+1]=x.y,f[_+2]=x.z,_+=3}}},d=a.getVerticesData(S.PositionKind);if(h(d),a.hasBoundingInfo?a.getBoundingInfo().reConstruct(c,u,a._worldMatrix):a.buildBoundingInfo(c,u,a._worldMatrix),a.updateVerticesData(S.PositionKind,d,!1,!1),e.colors){let f=a.getVerticesData(S.ColorKind);for(let p=0,g=0;p<e.colors.length;p++,g+=4){let _=e.colors[p];f[g]=_.r,f[g+1]=_.g,f[g+2]=_.b,f[g+3]=_.a}a.updateVerticesData(S.ColorKind,f,!1,!1)}if(e.uvs){let f=a.getVerticesData(S.UVKind);for(let p=0;p<e.uvs.length;p++)f[p*2]=e.uvs[p].x,f[p*2+1]=we?1-e.uvs[p].y:e.uvs[p].y;a.updateVerticesData(S.UVKind,f,!1,!1)}if(!a.areNormalsFrozen||a.isFacetDataEnabled){let f=a.getIndices(),p=a.getVerticesData(S.NormalKind),g=a.isFacetDataEnabled?a.getFacetDataParameters():null;if(X.ComputeNormals(d,f,p,g),a._creationDataStorage&&a._creationDataStorage.closePath){let _=0,y=0;for(let C=0;C<n.length;C++)_=a._creationDataStorage.idx[C]*3,C+1<n.length?y=(a._creationDataStorage.idx[C+1]-1)*3:y=p.length-3,p[_]=(p[_]+p[y])*.5,p[_+1]=(p[_+1]+p[y+1])*.5,p[_+2]=(p[_+2]+p[y+2])*.5,p[y]=p[_],p[y+1]=p[_+1],p[y+2]=p[_+2]}a.areNormalsFrozen||a.updateVerticesData(S.NormalKind,p,!1,!1)}return a}else{let c=new A(i,t);c._originalBuilderSideOrientation=o,c._creationDataStorage=new Al;let u=Gw(e);return s&&(c._creationDataStorage.idx=u._idx),c._creationDataStorage.closePath=s,c._creationDataStorage.closeArray=r,u.applyToMesh(c,l),c}}X.CreateRibbon=Gw;A.CreateRibbon=(i,e,t=!1,n,r,s,o=!1,a,l)=>cr(i,{pathArray:e,closeArray:t,closePath:n,offset:r,updatable:o,sideOrientation:a,instance:l},s);function Uw(i){let e=[],t=[],n=[],r=[],s=i.radius||.5,o=i.tessellation||64,a=i.arc&&(i.arc<=0||i.arc>1)?1:i.arc||1,l=i.sideOrientation===0?0:i.sideOrientation||X.DEFAULTSIDE;e.push(0,0,0),r.push(.5,.5);let c=Math.PI*2*a,u=a===1?c/o:c/(o-1),h=0;for(let p=0;p<o;p++){let g=Math.cos(h),_=Math.sin(h),y=(g+1)/2,C=(1-_)/2;e.push(s*g,s*_,0),r.push(y,we?1-C:C),h+=u}a===1&&(e.push(e[3],e[4],e[5]),r.push(r[2],we?1-r[3]:r[3]));let d=e.length/3;for(let p=1;p<d-1;p++)t.push(p+1,0,p);X.ComputeNormals(e,t,n),X._ComputeSides(l,e,t,n,r,i.frontUVs,i.backUVs);let f=new X;return f.indices=t,f.positions=e,f.normals=n,f.uvs=r,f}function Kx(i,e={},t=null){let n=new A(i,t);return e.sideOrientation=A._GetDefaultSideOrientation(e.sideOrientation),n._originalBuilderSideOrientation=e.sideOrientation,Uw(e).applyToMesh(n,e.updatable),n}X.CreateDisc=Uw;A.CreateDisc=(i,e,t,n=null,r,s)=>Kx(i,{radius:e,tessellation:t,sideOrientation:s,updatable:r},n);A._GroundMeshParser=(i,e)=>Ol.Parse(i,e);var Ol=class i extends A{constructor(e,t){super(e,t),this.generateOctree=!1}getClassName(){return"GroundMesh"}get subdivisions(){return Math.min(this._subdivisionsX,this._subdivisionsY)}get subdivisionsX(){return this._subdivisionsX}get subdivisionsY(){return this._subdivisionsY}optimize(e,t=32){this._subdivisionsX=e,this._subdivisionsY=e,this.subdivide(e);let n=this;n.createOrUpdateSubmeshesOctree&&n.createOrUpdateSubmeshesOctree(t)}getHeightAtCoordinates(e,t){let n=this.getWorldMatrix(),r=U.Matrix[5];n.invertToRef(r);let s=U.Vector3[8];if(m.TransformCoordinatesFromFloatsToRef(e,0,t,r,s),e=s.x,t=s.z,e<this._minX||e>=this._maxX||t<=this._minZ||t>this._maxZ)return this.position.y;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());let o=this._getFacetAt(e,t),a=-(o.x*e+o.z*t+o.w)/o.y;return m.TransformCoordinatesFromFloatsToRef(0,a,0,n,s),s.y}getNormalAtCoordinates(e,t){let n=new m(0,1,0);return this.getNormalAtCoordinatesToRef(e,t,n),n}getNormalAtCoordinatesToRef(e,t,n){let r=this.getWorldMatrix(),s=U.Matrix[5];r.invertToRef(s);let o=U.Vector3[8];if(m.TransformCoordinatesFromFloatsToRef(e,0,t,s,o),e=o.x,t=o.z,e<this._minX||e>this._maxX||t<this._minZ||t>this._maxZ)return this;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());let a=this._getFacetAt(e,t);return m.TransformNormalFromFloatsToRef(a.x,a.y,a.z,r,n),this}updateCoordinateHeights(){return(!this._heightQuads||this._heightQuads.length==0)&&this._initHeightQuads(),this._computeHeightQuads(),this}_getFacetAt(e,t){let n=Math.floor((e+this._maxX)*this._subdivisionsX/this._width),r=Math.floor(-(t+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),s=this._heightQuads[r*this._subdivisionsX+n],o;return t<s.slope.x*e+s.slope.y?o=s.facet1:o=s.facet2,o}_initHeightQuads(){let e=this._subdivisionsX,t=this._subdivisionsY;this._heightQuads=[];for(let n=0;n<t;n++)for(let r=0;r<e;r++){let s={slope:_e.Zero(),facet1:new ht(0,0,0,0),facet2:new ht(0,0,0,0)};this._heightQuads[n*e+r]=s}return this}_computeHeightQuads(){let e=this.getVerticesData(S.PositionKind);if(!e)return this;let t=U.Vector3[3],n=U.Vector3[2],r=U.Vector3[1],s=U.Vector3[0],o=U.Vector3[4],a=U.Vector3[5],l=U.Vector3[6],c=U.Vector3[7],u=U.Vector3[8],h=0,d=0,f=0,p=0,g=0,_=0,y=0,C=this._subdivisionsX,E=this._subdivisionsY;for(let I=0;I<E;I++)for(let v=0;v<C;v++){h=v*3,d=I*(C+1)*3,f=(I+1)*(C+1)*3,t.x=e[d+h],t.y=e[d+h+1],t.z=e[d+h+2],n.x=e[d+h+3],n.y=e[d+h+4],n.z=e[d+h+5],r.x=e[f+h],r.y=e[f+h+1],r.z=e[f+h+2],s.x=e[f+h+3],s.y=e[f+h+4],s.z=e[f+h+5],p=(s.z-t.z)/(s.x-t.x),g=t.z-p*t.x,n.subtractToRef(t,o),r.subtractToRef(t,a),s.subtractToRef(t,l),m.CrossToRef(l,a,c),m.CrossToRef(o,l,u),c.normalize(),u.normalize(),_=-(c.x*t.x+c.y*t.y+c.z*t.z),y=-(u.x*n.x+u.y*n.y+u.z*n.z);let x=this._heightQuads[I*C+v];x.slope.copyFromFloats(p,g),x.facet1.copyFromFloats(c.x,c.y,c.z,_),x.facet2.copyFromFloats(u.x,u.y,u.z,y)}return this}serialize(e){super.serialize(e),e.subdivisionsX=this._subdivisionsX,e.subdivisionsY=this._subdivisionsY,e.minX=this._minX,e.maxX=this._maxX,e.minZ=this._minZ,e.maxZ=this._maxZ,e.width=this._width,e.height=this._height}static Parse(e,t){let n=new i(e.name,t);return n._subdivisionsX=e.subdivisionsX||1,n._subdivisionsY=e.subdivisionsY||1,n._minX=e.minX,n._maxX=e.maxX,n._minZ=e.minZ,n._maxZ=e.maxZ,n._width=e.width,n._height=e.height,n}};function Xx(i){let e=[],t=[],n=[],r=[],s,o,a=i.width||i.size||1,l=i.height||i.size||1,c=(i.subdivisionsX||i.subdivisions||1)|0,u=(i.subdivisionsY||i.subdivisions||1)|0;for(s=0;s<=u;s++)for(o=0;o<=c;o++){let d=new m(o*a/c-a/2,0,(u-s)*l/u-l/2),f=new m(0,1,0);t.push(d.x,d.y,d.z),n.push(f.x,f.y,f.z),r.push(o/c,we?s/u:1-s/u)}for(s=0;s<u;s++)for(o=0;o<c;o++)e.push(o+1+(s+1)*(c+1)),e.push(o+1+s*(c+1)),e.push(o+s*(c+1)),e.push(o+(s+1)*(c+1)),e.push(o+1+(s+1)*(c+1)),e.push(o+s*(c+1));let h=new X;return h.indices=e,h.positions=t,h.normals=n,h.uvs=r,h}function zw(i){let e=i.xmin!==void 0&&i.xmin!==null?i.xmin:-1,t=i.zmin!==void 0&&i.zmin!==null?i.zmin:-1,n=i.xmax!==void 0&&i.xmax!==null?i.xmax:1,r=i.zmax!==void 0&&i.zmax!==null?i.zmax:1,s=i.subdivisions||{w:1,h:1},o=i.precision||{w:1,h:1},a=[],l=[],c=[],u=[],h,d,f,p;s.h=s.h<1?1:s.h,s.w=s.w<1?1:s.w,o.w=o.w<1?1:o.w,o.h=o.h<1?1:o.h;let g={w:(n-e)/s.w,h:(r-t)/s.h};function _(C,E,I,v){let x=l.length/3,b=o.w+1;for(h=0;h<o.h;h++)for(d=0;d<o.w;d++){let R=[x+d+h*b,x+(d+1)+h*b,x+(d+1)+(h+1)*b,x+d+(h+1)*b];a.push(R[1]),a.push(R[2]),a.push(R[3]),a.push(R[0]),a.push(R[1]),a.push(R[3])}let D=m.Zero(),M=new m(0,1,0);for(h=0;h<=o.h;h++)for(D.z=h*(v-E)/o.h+E,d=0;d<=o.w;d++)D.x=d*(I-C)/o.w+C,D.y=0,l.push(D.x,D.y,D.z),c.push(M.x,M.y,M.z),u.push(d/o.w,h/o.h)}for(f=0;f<s.h;f++)for(p=0;p<s.w;p++)_(e+p*g.w,t+f*g.h,e+(p+1)*g.w,t+(f+1)*g.h);let y=new X;return y.indices=a,y.positions=l,y.normals=c,y.uvs=u,y}function Hw(i){let e=[],t=[],n=[],r=[],s,o,a=i.colorFilter||new G(.3,.59,.11),l=i.alphaFilter||0,c=!1;if(i.minHeight>i.maxHeight){c=!0;let h=i.maxHeight;i.maxHeight=i.minHeight,i.minHeight=h}for(s=0;s<=i.subdivisions;s++)for(o=0;o<=i.subdivisions;o++){let h=new m(o*i.width/i.subdivisions-i.width/2,0,(i.subdivisions-s)*i.height/i.subdivisions-i.height/2),d=(h.x+i.width/2)/i.width*(i.bufferWidth-1)|0,f=(1-(h.z+i.height/2)/i.height)*(i.bufferHeight-1)|0,p=(d+f*i.bufferWidth)*4,g=i.buffer[p]/255,_=i.buffer[p+1]/255,y=i.buffer[p+2]/255,C=i.buffer[p+3]/255;c&&(g=1-g,_=1-_,y=1-y);let E=g*a.r+_*a.g+y*a.b;C>=l?h.y=i.minHeight+(i.maxHeight-i.minHeight)*E:h.y=i.minHeight-Pt,i.heightBuffer&&(i.heightBuffer[s*(i.subdivisions+1)+o]=h.y),t.push(h.x,h.y,h.z),n.push(0,0,0),r.push(o/i.subdivisions,1-s/i.subdivisions)}for(s=0;s<i.subdivisions;s++)for(o=0;o<i.subdivisions;o++){let h=o+1+(s+1)*(i.subdivisions+1),d=o+1+s*(i.subdivisions+1),f=o+s*(i.subdivisions+1),p=o+(s+1)*(i.subdivisions+1),g=t[h*3+1]>=i.minHeight,_=t[d*3+1]>=i.minHeight,y=t[f*3+1]>=i.minHeight;g&&_&&y&&(e.push(h),e.push(d),e.push(f)),t[p*3+1]>=i.minHeight&&g&&y&&(e.push(p),e.push(h),e.push(f))}X.ComputeNormals(t,e,n);let u=new X;return u.indices=e,u.positions=t,u.normals=n,u.uvs=r,u}function Yo(i,e={},t){let n=new Ol(i,t);return n._setReady(!1),n._subdivisionsX=e.subdivisionsX||e.subdivisions||1,n._subdivisionsY=e.subdivisionsY||e.subdivisions||1,n._width=e.width||1,n._height=e.height||1,n._maxX=n._width/2,n._maxZ=n._height/2,n._minX=-n._maxX,n._minZ=-n._maxZ,Xx(e).applyToMesh(n,e.updatable),n._setReady(!0),n}function Zx(i,e,t=null){let n=new A(i,t);return zw(e).applyToMesh(n,e.updatable),n}function Qx(i,e,t={},n=null){let r=t.width||10,s=t.height||10,o=t.subdivisions||1,a=t.minHeight||0,l=t.maxHeight||1,c=t.colorFilter||new G(.3,.59,.11),u=t.alphaFilter||0,h=t.updatable,d=t.onReady;n=n||Ie.LastCreatedScene;let f=new Ol(i,n);f._subdivisionsX=o,f._subdivisionsY=o,f._width=r,f._height=s,f._maxX=f._width/2,f._maxZ=f._height/2,f._minX=-f._maxX,f._minZ=-f._maxZ,f._setReady(!1);let p;t.passHeightBufferInCallback&&(p=new Float32Array((o+1)*(o+1)));let g=(_,y,C)=>{Hw({width:r,height:s,subdivisions:o,minHeight:a,maxHeight:l,colorFilter:c,buffer:_,bufferWidth:y,bufferHeight:C,alphaFilter:u,heightBuffer:p}).applyToMesh(f,h),d&&d(f,p),f._setReady(!0)};if(typeof e=="string"){let _=y=>{let C=y.width,E=y.height;if(n.isDisposed)return;let I=n?.getEngine().resizeImageBitmap(y,C,E);g(I,C,E)};z.LoadImage(e,_,t.onError?t.onError:()=>{},n.offlineProvider)}else g(e.data,e.width,e.height);return f}X.CreateGround=Xx;X.CreateTiledGround=zw;X.CreateGroundFromHeightMap=Hw;A.CreateGround=(i,e,t,n,r,s)=>Yo(i,{width:e,height:t,subdivisions:n,updatable:s},r);A.CreateTiledGround=(i,e,t,n,r,s,o,a,l)=>Zx(i,{xmin:e,zmin:t,xmax:n,zmax:r,subdivisions:s,precision:o,updatable:l},a);A.CreateGroundFromHeightMap=(i,e,t,n,r,s,o,a,l,c,u)=>Qx(i,e,{width:t,height:n,subdivisions:r,minHeight:s,maxHeight:o,updatable:l,onReady:c,alphaFilter:u},a);function $w(i){let t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],n=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],r=[],s=[],o=i.width||i.size||1,a=i.height||i.size||1,l=i.depth||i.size||1,c=i.wrap||!1,u=i.topBaseAt===void 0?1:i.topBaseAt,h=i.bottomBaseAt===void 0?0:i.bottomBaseAt;u=(u+4)%4,h=(h+4)%4;let d=[2,0,3,1],f=[2,0,1,3],p=d[u],g=f[h],_=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(c){t=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],_=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let b=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],D=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]],M=[17,18,19,16],R=[22,23,20,21];for(;p>0;)b.unshift(b.pop()),M.unshift(M.pop()),p--;for(;g>0;)D.unshift(D.pop()),R.unshift(R.pop()),g--;b=b.flat(),D=D.flat(),_=_.concat(b).concat(D),t.push(M[0],M[2],M[3],M[0],M[1],M[2]),t.push(R[0],R[2],R[3],R[0],R[1],R[2])}let y=[o/2,a/2,l/2];s=_.reduce((b,D,M)=>b.concat(D*y[M%3]),[]);let C=i.sideOrientation===0?0:i.sideOrientation||X.DEFAULTSIDE,E=i.faceUV||new Array(6),I=i.faceColors,v=[];for(let b=0;b<6;b++)E[b]===void 0&&(E[b]=new ht(0,0,1,1)),I&&I[b]===void 0&&(I[b]=new le(1,1,1,1));for(let b=0;b<6;b++)if(r.push(E[b].z,we?1-E[b].w:E[b].w),r.push(E[b].x,we?1-E[b].w:E[b].w),r.push(E[b].x,we?1-E[b].y:E[b].y),r.push(E[b].z,we?1-E[b].y:E[b].y),I)for(let D=0;D<4;D++)v.push(I[b].r,I[b].g,I[b].b,I[b].a);X._ComputeSides(C,s,t,n,r,i.frontUVs,i.backUVs);let x=new X;if(x.indices=t,x.positions=s,x.normals=n,x.uvs=r,I){let b=C===X.DOUBLESIDE?v.concat(v):v;x.colors=b}return x}function Ko(i,e={},t=null){let n=new A(i,t);return e.sideOrientation=A._GetDefaultSideOrientation(e.sideOrientation),n._originalBuilderSideOrientation=e.sideOrientation,$w(e).applyToMesh(n,e.updatable),n}X.CreateBox=$w;A.CreateBox=(i,e,t=null,n,r)=>Ko(i,{size:e,sideOrientation:r,updatable:n},t);function Nl(i){let e=i.pattern||A.NO_FLIP,t=i.tileWidth||i.tileSize||1,n=i.tileHeight||i.tileSize||1,r=i.alignHorizontal||0,s=i.alignVertical||0,o=i.width||i.size||1,a=Math.floor(o/t),l=o-a*t,c=i.height||i.size||1,u=Math.floor(c/n),h=c-u*n,d=t*a/2,f=n*u/2,p=0,g=0,_=0,y=0,C=0,E=0;if(l>0||h>0){switch(_=-d,y=-f,C=d,E=f,r){case A.CENTER:l/=2,_-=l,C+=l;break;case A.LEFT:C+=l,p=-l/2;break;case A.RIGHT:_-=l,p=l/2;break}switch(s){case A.CENTER:h/=2,y-=h,E+=h;break;case A.BOTTOM:E+=h,g=-h/2;break;case A.TOP:y-=h,g=h/2;break}}let I=[],v=[],x=[];x[0]=[0,0,1,0,1,1,0,1],x[1]=[0,0,1,0,1,1,0,1],(e===A.ROTATE_TILE||e===A.ROTATE_ROW)&&(x[1]=[1,1,0,1,0,0,1,0]),(e===A.FLIP_TILE||e===A.FLIP_ROW)&&(x[1]=[1,0,0,0,0,1,1,1]),(e===A.FLIP_N_ROTATE_TILE||e===A.FLIP_N_ROTATE_ROW)&&(x[1]=[0,1,1,1,1,0,0,0]);let b=[],D=[],M=[],R=0;for(let Q=0;Q<u;Q++)for(let de=0;de<a;de++)I.push(-d+de*t+p,-f+Q*n+g,0),I.push(-d+(de+1)*t+p,-f+Q*n+g,0),I.push(-d+(de+1)*t+p,-f+(Q+1)*n+g,0),I.push(-d+de*t+p,-f+(Q+1)*n+g,0),M.push(R,R+1,R+3,R+1,R+2,R+3),e===A.FLIP_TILE||e===A.ROTATE_TILE||e===A.FLIP_N_ROTATE_TILE?b=b.concat(x[(de%2+Q%2)%2]):e===A.FLIP_ROW||e===A.ROTATE_ROW||e===A.FLIP_N_ROTATE_ROW?b=b.concat(x[Q%2]):b=b.concat(x[0]),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),v.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1),R+=4;if(l>0||h>0){let Q=h>0&&(s===A.CENTER||s===A.TOP),de=h>0&&(s===A.CENTER||s===A.BOTTOM),oe=l>0&&(r===A.CENTER||r===A.RIGHT),pe=l>0&&(r===A.CENTER||r===A.LEFT),ve=[],$,j,O,k;if(Q&&oe&&(I.push(_+p,y+g,0),I.push(-d+p,y+g,0),I.push(-d+p,y+h+g,0),I.push(_+p,y+h+g,0),M.push(R,R+1,R+3,R+1,R+2,R+3),R+=4,$=1-l/t,j=1-h/n,O=1,k=1,ve=[$,j,O,j,O,k,$,k],e===A.ROTATE_ROW&&(ve=[1-$,1-j,1-O,1-j,1-O,1-k,1-$,1-k]),e===A.FLIP_ROW&&(ve=[1-$,j,1-O,j,1-O,k,1-$,k]),e===A.FLIP_N_ROTATE_ROW&&(ve=[$,1-j,O,1-j,O,1-k,$,1-k]),b=b.concat(ve),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),v.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),Q&&pe&&(I.push(d+p,y+g,0),I.push(C+p,y+g,0),I.push(C+p,y+h+g,0),I.push(d+p,y+h+g,0),M.push(R,R+1,R+3,R+1,R+2,R+3),R+=4,$=0,j=1-h/n,O=l/t,k=1,ve=[$,j,O,j,O,k,$,k],(e===A.ROTATE_ROW||e===A.ROTATE_TILE&&a%2===0)&&(ve=[1-$,1-j,1-O,1-j,1-O,1-k,1-$,1-k]),(e===A.FLIP_ROW||e===A.FLIP_TILE&&a%2===0)&&(ve=[1-$,j,1-O,j,1-O,k,1-$,k]),(e===A.FLIP_N_ROTATE_ROW||e===A.FLIP_N_ROTATE_TILE&&a%2===0)&&(ve=[$,1-j,O,1-j,O,1-k,$,1-k]),b=b.concat(ve),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),v.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),de&&oe&&(I.push(_+p,f+g,0),I.push(-d+p,f+g,0),I.push(-d+p,E+g,0),I.push(_+p,E+g,0),M.push(R,R+1,R+3,R+1,R+2,R+3),R+=4,$=1-l/t,j=0,O=1,k=h/n,ve=[$,j,O,j,O,k,$,k],(e===A.ROTATE_ROW&&u%2===1||e===A.ROTATE_TILE&&u%1===0)&&(ve=[1-$,1-j,1-O,1-j,1-O,1-k,1-$,1-k]),(e===A.FLIP_ROW&&u%2===1||e===A.FLIP_TILE&&u%2===0)&&(ve=[1-$,j,1-O,j,1-O,k,1-$,k]),(e===A.FLIP_N_ROTATE_ROW&&u%2===1||e===A.FLIP_N_ROTATE_TILE&&u%2===0)&&(ve=[$,1-j,O,1-j,O,1-k,$,1-k]),b=b.concat(ve),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),v.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),de&&pe&&(I.push(d+p,f+g,0),I.push(C+p,f+g,0),I.push(C+p,E+g,0),I.push(d+p,E+g,0),M.push(R,R+1,R+3,R+1,R+2,R+3),R+=4,$=0,j=0,O=l/t,k=h/n,ve=[$,j,O,j,O,k,$,k],(e===A.ROTATE_ROW&&u%2===1||e===A.ROTATE_TILE&&(u+a)%2===1)&&(ve=[1-$,1-j,1-O,1-j,1-O,1-k,1-$,1-k]),(e===A.FLIP_ROW&&u%2===1||e===A.FLIP_TILE&&(u+a)%2===1)&&(ve=[1-$,j,1-O,j,1-O,k,1-$,k]),(e===A.FLIP_N_ROTATE_ROW&&u%2===1||e===A.FLIP_N_ROTATE_TILE&&(u+a)%2===1)&&(ve=[$,1-j,O,1-j,O,1-k,$,1-k]),b=b.concat(ve),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),v.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),Q){let F=[];$=0,j=1-h/n,O=1,k=1,F[0]=[$,j,O,j,O,k,$,k],F[1]=[$,j,O,j,O,k,$,k],(e===A.ROTATE_TILE||e===A.ROTATE_ROW)&&(F[1]=[1-$,1-j,1-O,1-j,1-O,1-k,1-$,1-k]),(e===A.FLIP_TILE||e===A.FLIP_ROW)&&(F[1]=[1-$,j,1-O,j,1-O,k,1-$,k]),(e===A.FLIP_N_ROTATE_TILE||e===A.FLIP_N_ROTATE_ROW)&&(F[1]=[$,1-j,O,1-j,O,1-k,$,1-k]);for(let q=0;q<a;q++)I.push(-d+q*t+p,y+g,0),I.push(-d+(q+1)*t+p,y+g,0),I.push(-d+(q+1)*t+p,y+h+g,0),I.push(-d+q*t+p,y+h+g,0),M.push(R,R+1,R+3,R+1,R+2,R+3),R+=4,e===A.FLIP_TILE||e===A.ROTATE_TILE||e===A.FLIP_N_ROTATE_TILE?b=b.concat(F[(q+1)%2]):e===A.FLIP_ROW||e===A.ROTATE_ROW||e===A.FLIP_N_ROTATE_ROW?b=b.concat(F[1]):b=b.concat(F[0]),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),v.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(de){let F=[];$=0,j=0,O=1,k=h/n,F[0]=[$,j,O,j,O,k,$,k],F[1]=[$,j,O,j,O,k,$,k],(e===A.ROTATE_TILE||e===A.ROTATE_ROW)&&(F[1]=[1-$,1-j,1-O,1-j,1-O,1-k,1-$,1-k]),(e===A.FLIP_TILE||e===A.FLIP_ROW)&&(F[1]=[1-$,j,1-O,j,1-O,k,1-$,k]),(e===A.FLIP_N_ROTATE_TILE||e===A.FLIP_N_ROTATE_ROW)&&(F[1]=[$,1-j,O,1-j,O,1-k,$,1-k]);for(let q=0;q<a;q++)I.push(-d+q*t+p,E-h+g,0),I.push(-d+(q+1)*t+p,E-h+g,0),I.push(-d+(q+1)*t+p,E+g,0),I.push(-d+q*t+p,E+g,0),M.push(R,R+1,R+3,R+1,R+2,R+3),R+=4,e===A.FLIP_TILE||e===A.ROTATE_TILE||e===A.FLIP_N_ROTATE_TILE?b=b.concat(F[(q+u)%2]):e===A.FLIP_ROW||e===A.ROTATE_ROW||e===A.FLIP_N_ROTATE_ROW?b=b.concat(F[u%2]):b=b.concat(F[0]),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),v.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(oe){let F=[];$=1-l/t,j=0,O=1,k=1,F[0]=[$,j,O,j,O,k,$,k],F[1]=[$,j,O,j,O,k,$,k],(e===A.ROTATE_TILE||e===A.ROTATE_ROW)&&(F[1]=[1-$,1-j,1-O,1-j,1-O,1-k,1-$,1-k]),(e===A.FLIP_TILE||e===A.FLIP_ROW)&&(F[1]=[1-$,j,1-O,j,1-O,k,1-$,k]),(e===A.FLIP_N_ROTATE_TILE||e===A.FLIP_N_ROTATE_ROW)&&(F[1]=[$,1-j,O,1-j,O,1-k,$,1-k]);for(let q=0;q<u;q++)I.push(_+p,-f+q*n+g,0),I.push(_+l+p,-f+q*n+g,0),I.push(_+l+p,-f+(q+1)*n+g,0),I.push(_+p,-f+(q+1)*n+g,0),M.push(R,R+1,R+3,R+1,R+2,R+3),R+=4,e===A.FLIP_TILE||e===A.ROTATE_TILE||e===A.FLIP_N_ROTATE_TILE?b=b.concat(F[(q+1)%2]):e===A.FLIP_ROW||e===A.ROTATE_ROW||e===A.FLIP_N_ROTATE_ROW?b=b.concat(F[q%2]):b=b.concat(F[0]),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),v.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(pe){let F=[];$=0,j=0,O=l/n,k=1,F[0]=[$,j,O,j,O,k,$,k],F[1]=[$,j,O,j,O,k,$,k],(e===A.ROTATE_TILE||e===A.ROTATE_ROW)&&(F[1]=[1-$,1-j,1-O,1-j,1-O,1-k,1-$,1-k]),(e===A.FLIP_TILE||e===A.FLIP_ROW)&&(F[1]=[1-$,j,1-O,j,1-O,k,1-$,k]),(e===A.FLIP_N_ROTATE_TILE||e===A.FLIP_N_ROTATE_ROW)&&(F[1]=[$,1-j,O,1-j,O,1-k,$,1-k]);for(let q=0;q<u;q++)I.push(C-l+p,-f+q*n+g,0),I.push(C+p,-f+q*n+g,0),I.push(C+p,-f+(q+1)*n+g,0),I.push(C-l+p,-f+(q+1)*n+g,0),M.push(R,R+1,R+3,R+1,R+2,R+3),R+=4,e===A.FLIP_TILE||e===A.ROTATE_TILE||e===A.FLIP_N_ROTATE_TILE?b=b.concat(F[(q+a)%2]):e===A.FLIP_ROW||e===A.ROTATE_ROW||e===A.FLIP_N_ROTATE_ROW?b=b.concat(F[q%2]):b=b.concat(F[0]),D.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),v.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}}let W=i.sideOrientation===0?0:i.sideOrientation||X.DEFAULTSIDE;X._ComputeSides(W,I,M,v,b,i.frontUVs,i.backUVs);let ie=new X;ie.indices=M,ie.positions=I,ie.normals=v,ie.uvs=b;let ce=W===X.DOUBLESIDE?D.concat(D):D;return ie.colors=ce,ie}function Ww(i,e,t=null){let n=new A(i,t);return e.sideOrientation=A._GetDefaultSideOrientation(e.sideOrientation),n._originalBuilderSideOrientation=e.sideOrientation,Nl(e).applyToMesh(n,e.updatable),n}X.CreateTiledPlane=Nl;var xm=1,Jx=-1;function jw(i){let t=i.faceUV||new Array(6),n=i.faceColors,r=i.pattern||A.NO_FLIP,s=i.width||i.size||1,o=i.height||i.size||1,a=i.depth||i.size||1,l=i.tileWidth||i.tileSize||1,c=i.tileHeight||i.tileSize||1,u=i.alignHorizontal||0,h=i.alignVertical||0,d=i.sideOrientation===0?0:i.sideOrientation||X.DEFAULTSIDE;for(let Q=0;Q<6;Q++)t[Q]===void 0&&(t[Q]=new ht(0,0,1,1)),n&&n[Q]===void 0&&(n[Q]=new le(1,1,1,1));let f=s/2,p=o/2,g=a/2,_=[];for(let Q=0;Q<2;Q++)_[Q]=Nl({pattern:r,tileWidth:l,tileHeight:c,width:s,height:o,alignVertical:h,alignHorizontal:u,sideOrientation:d});for(let Q=2;Q<4;Q++)_[Q]=Nl({pattern:r,tileWidth:l,tileHeight:c,width:a,height:o,alignVertical:h,alignHorizontal:u,sideOrientation:d});let y=h;h===A.BOTTOM?y=A.TOP:h===A.TOP&&(y=A.BOTTOM);for(let Q=4;Q<6;Q++)_[Q]=Nl({pattern:r,tileWidth:l,tileHeight:c,width:s,height:a,alignVertical:y,alignHorizontal:u,sideOrientation:d});let C=[],E=[],I=[],v=[],x=[],b=[],D=[],M=[],R=0,W=0;for(let Q=0;Q<6;Q++){let de=_[Q].positions.length;b[Q]=[],D[Q]=[];for(let oe=0;oe<de/3;oe++)b[Q].push(new m(_[Q].positions[3*oe],_[Q].positions[3*oe+1],_[Q].positions[3*oe+2])),D[Q].push(new m(_[Q].normals[3*oe],_[Q].normals[3*oe+1],_[Q].normals[3*oe+2]));R=_[Q].uvs.length,M[Q]=[];for(let oe=0;oe<R;oe+=2)M[Q][oe]=t[Q].x+(t[Q].z-t[Q].x)*_[Q].uvs[oe],M[Q][oe+1]=t[Q].y+(t[Q].w-t[Q].y)*_[Q].uvs[oe+1],we&&(M[Q][oe+1]=1-M[Q][oe+1]);if(I=I.concat(M[Q]),v=v.concat(_[Q].indices.map(oe=>oe+W)),W+=b[Q].length,n){let oe=n[Q];for(let pe=0;pe<b[Q].length;pe++)x.push(oe.r,oe.g,oe.b,oe.a)}}let ie=[{m:V.RotationY(Math.PI),t:new m(0,0,g),op:xm},{m:V.Identity(),t:new m(0,0,g),op:Jx},{m:V.RotationY(-Math.PI/2),t:new m(f,0,0),op:xm},{m:V.RotationY(Math.PI/2),t:new m(f,0,0),op:Jx},{m:V.RotationX(Math.PI/2),t:new m(0,p,0),op:xm},{m:V.RotationX(-Math.PI/2),t:new m(0,p,0),op:Jx}];for(let Q=0;Q<6;Q++){let{m:de,t:oe,op:pe}=ie[Q];for(let ve of b[Q]){let $=m.TransformCoordinates(ve,de),j=pe===xm?$.add(oe):$.subtract(oe);C.push(j.x,j.y,j.z)}for(let ve of D[Q]){let $=m.TransformNormal(ve,de);E.push($.x,$.y,$.z)}}let ce=new X;if(ce.indices=v,ce.positions=C,ce.normals=E,ce.uvs=I,n){let Q=d===X.DOUBLESIDE?x.concat(x):x;ce.colors=Q}return ce}function qw(i,e,t=null){let n=new A(i,t);return e.sideOrientation=A._GetDefaultSideOrientation(e.sideOrientation),n._originalBuilderSideOrientation=e.sideOrientation,jw(e).applyToMesh(n,e.updatable),n}X.CreateTiledBox=jw;function Yw(i){let e=(i.segments||32)|0,t=i.diameterX||i.diameter||1,n=i.diameterY||i.diameter||1,r=i.diameterZ||i.diameter||1,s=i.arc&&(i.arc<=0||i.arc>1)?1:i.arc||1,o=i.slice&&i.slice<=0?1:i.slice||1,a=i.sideOrientation===0?0:i.sideOrientation||X.DEFAULTSIDE,l=!!i.dedupTopBottomIndices,c=new m(t/2,n/2,r/2),u=2+e,h=2*u,d=[],f=[],p=[],g=[];for(let y=0;y<=u;y++){let C=y/u,E=C*Math.PI*o;for(let I=0;I<=h;I++){let v=I/h,x=v*Math.PI*2*s,b=V.RotationZ(-E),D=V.RotationY(x),M=m.TransformCoordinates(m.Up(),b),R=m.TransformCoordinates(M,D),W=R.multiply(c),ie=R.divide(c).normalize();f.push(W.x,W.y,W.z),p.push(ie.x,ie.y,ie.z),g.push(v,we?1-C:C)}if(y>0){let I=f.length/3;for(let v=I-2*(h+1);v+h+2<I;v++)l?(y>1&&(d.push(v),d.push(v+1),d.push(v+h+1)),(y<u||o<1)&&(d.push(v+h+1),d.push(v+1),d.push(v+h+2))):(d.push(v),d.push(v+1),d.push(v+h+1),d.push(v+h+1),d.push(v+1),d.push(v+h+2))}}X._ComputeSides(a,f,d,p,g,i.frontUVs,i.backUVs);let _=new X;return _.indices=d,_.positions=f,_.normals=p,_.uvs=g,_}function js(i,e={},t=null){let n=new A(i,t);return e.sideOrientation=A._GetDefaultSideOrientation(e.sideOrientation),n._originalBuilderSideOrientation=e.sideOrientation,Yw(e).applyToMesh(n,e.updatable),n}X.CreateSphere=Yw;A.CreateSphere=(i,e,t,n,r,s)=>js(i,{segments:e,diameterX:t,diameterY:t,diameterZ:t,sideOrientation:s,updatable:r},n);function Kw(i){let e=i.height||2,t=i.diameterTop===0?0:i.diameterTop||i.diameter||1,n=i.diameterBottom===0?0:i.diameterBottom||i.diameter||1;t=t||1e-5,n=n||1e-5;let r=(i.tessellation||24)|0,s=(i.subdivisions||1)|0,o=!!i.hasRings,a=!!i.enclose,l=i.cap===0?0:i.cap||A.CAP_ALL,c=i.arc&&(i.arc<=0||i.arc>1)?1:i.arc||1,u=i.sideOrientation===0?0:i.sideOrientation||X.DEFAULTSIDE,h=i.faceUV||new Array(3),d=i.faceColors,f=c!==1&&a?2:0,p=o?s:1,g=2+(1+f)*p,_;for(_=0;_<g;_++)d&&d[_]===void 0&&(d[_]=new le(1,1,1,1));for(_=0;_<g;_++)h&&h[_]===void 0&&(h[_]=new ht(0,0,1,1));let y=[],C=[],E=[],I=[],v=[],x=Math.PI*2*c/r,b,D,M,R=(n-t)/2/e,W=m.Zero(),ie=m.Zero(),ce=m.Zero(),Q=m.Zero(),de=m.Zero(),oe=Vn.Y,pe,ve,$,j=1,O=1,k=0,F=0;for(pe=0;pe<=s;pe++)for(D=pe/s,M=(D*(t-n)+n)/2,j=o&&pe!==0&&pe!==s?2:1,$=0;$<j;$++){for(o&&(O+=$),a&&(O+=2*$),ve=0;ve<=r;ve++)b=ve*x,W.x=Math.cos(-b)*M,W.y=-e/2+D*e,W.z=Math.sin(-b)*M,t===0&&pe===s?(ie.x=E[E.length-(r+1)*3],ie.y=E[E.length-(r+1)*3+1],ie.z=E[E.length-(r+1)*3+2]):(ie.x=W.x,ie.z=W.z,ie.y=Math.sqrt(ie.x*ie.x+ie.z*ie.z)*R,ie.normalize()),ve===0&&(ce.copyFrom(W),Q.copyFrom(ie)),C.push(W.x,W.y,W.z),E.push(ie.x,ie.y,ie.z),o?F=k!==O?h[O].y:h[O].w:F=h[O].y+(h[O].w-h[O].y)*D,I.push(h[O].x+(h[O].z-h[O].x)*ve/r,we?1-F:F),d&&v.push(d[O].r,d[O].g,d[O].b,d[O].a);c!==1&&a&&(C.push(W.x,W.y,W.z),C.push(0,W.y,0),C.push(0,W.y,0),C.push(ce.x,ce.y,ce.z),m.CrossToRef(oe,ie,de),de.normalize(),E.push(de.x,de.y,de.z,de.x,de.y,de.z),m.CrossToRef(Q,oe,de),de.normalize(),E.push(de.x,de.y,de.z,de.x,de.y,de.z),o?F=k!==O?h[O+1].y:h[O+1].w:F=h[O+1].y+(h[O+1].w-h[O+1].y)*D,I.push(h[O+1].x,we?1-F:F),I.push(h[O+1].z,we?1-F:F),o?F=k!==O?h[O+2].y:h[O+2].w:F=h[O+2].y+(h[O+2].w-h[O+2].y)*D,I.push(h[O+2].x,we?1-F:F),I.push(h[O+2].z,we?1-F:F),d&&(v.push(d[O+1].r,d[O+1].g,d[O+1].b,d[O+1].a),v.push(d[O+1].r,d[O+1].g,d[O+1].b,d[O+1].a),v.push(d[O+2].r,d[O+2].g,d[O+2].b,d[O+2].a),v.push(d[O+2].r,d[O+2].g,d[O+2].b,d[O+2].a))),k!==O&&(k=O)}let q=c!==1&&a?r+4:r;for(pe=0,O=0;O<s;O++){let Se=0,Qe=0,zt=0,bt=0;for(ve=0;ve<r;ve++)Se=pe*(q+1)+ve,Qe=(pe+1)*(q+1)+ve,zt=pe*(q+1)+(ve+1),bt=(pe+1)*(q+1)+(ve+1),y.push(Se,Qe,zt),y.push(bt,zt,Qe);c!==1&&a&&(y.push(Se+2,Qe+2,zt+2),y.push(bt+2,zt+2,Qe+2),y.push(Se+4,Qe+4,zt+4),y.push(bt+4,zt+4,Qe+4)),pe=o?pe+2:pe+1}let be=Se=>{let Qe=Se?t/2:n/2;if(Qe===0)return;let zt,bt,Ht,ge=Se?h[g-1]:h[0],We=null;d&&(We=Se?d[g-1]:d[0]);let Ce=C.length/3,_n=Se?e/2:-e/2,Pi=new m(0,_n,0);C.push(Pi.x,Pi.y,Pi.z),E.push(0,Se?1:-1,0);let Xn=ge.y+(ge.w-ge.y)*.5;I.push(ge.x+(ge.z-ge.x)*.5,we?1-Xn:Xn),We&&v.push(We.r,We.g,We.b,We.a);let Ki=new _e(.5,.5);for(Ht=0;Ht<=r;Ht++){zt=Math.PI*2*Ht*c/r;let da=Math.cos(-zt),dr=Math.sin(-zt);bt=new m(da*Qe,_n,dr*Qe);let fa=new _e(da*Ki.x+.5,dr*Ki.y+.5);C.push(bt.x,bt.y,bt.z),E.push(0,Se?1:-1,0);let pa=ge.y+(ge.w-ge.y)*fa.y;I.push(ge.x+(ge.z-ge.x)*fa.x,we?1-pa:pa),We&&v.push(We.r,We.g,We.b,We.a)}for(Ht=0;Ht<r;Ht++)Se?(y.push(Ce),y.push(Ce+(Ht+2)),y.push(Ce+(Ht+1))):(y.push(Ce),y.push(Ce+(Ht+1)),y.push(Ce+(Ht+2)))};(l===A.CAP_START||l===A.CAP_ALL)&&be(!1),(l===A.CAP_END||l===A.CAP_ALL)&&be(!0),X._ComputeSides(u,C,y,E,I,i.frontUVs,i.backUVs);let re=new X;return re.indices=y,re.positions=C,re.normals=E,re.uvs=I,d&&(re.colors=v),re}function Xo(i,e={},t){let n=new A(i,t);return e.sideOrientation=A._GetDefaultSideOrientation(e.sideOrientation),n._originalBuilderSideOrientation=e.sideOrientation,Kw(e).applyToMesh(n,e.updatable),n}X.CreateCylinder=Kw;A.CreateCylinder=(i,e,t,n,r,s,o,a,l)=>((o===void 0||!(o instanceof Pe))&&(o!==void 0&&(l=a||A.DEFAULTSIDE,a=o),o=s,s=1),Xo(i,{height:e,diameterTop:t,diameterBottom:n,tessellation:r,subdivisions:s,sideOrientation:l,updatable:a},o));function Xw(i){let e=[],t=[],n=[],r=[],s=i.diameter||1,o=i.thickness||.5,a=(i.tessellation||16)|0,l=i.sideOrientation===0?0:i.sideOrientation||X.DEFAULTSIDE,c=a+1;for(let h=0;h<=a;h++){let d=h/a,f=h*Math.PI*2/a-Math.PI/2,p=V.Translation(s/2,0,0).multiply(V.RotationY(f));for(let g=0;g<=a;g++){let _=1-g/a,y=g*Math.PI*2/a+Math.PI,C=Math.cos(y),E=Math.sin(y),I=new m(C,E,0),v=I.scale(o/2),x=new _e(d,_);v=m.TransformCoordinates(v,p),I=m.TransformNormal(I,p),t.push(v.x,v.y,v.z),n.push(I.x,I.y,I.z),r.push(x.x,we?1-x.y:x.y);let b=(h+1)%c,D=(g+1)%c;e.push(h*c+g),e.push(h*c+D),e.push(b*c+g),e.push(h*c+D),e.push(b*c+D),e.push(b*c+g)}}X._ComputeSides(l,t,e,n,r,i.frontUVs,i.backUVs);let u=new X;return u.indices=e,u.positions=t,u.normals=n,u.uvs=r,u}function ur(i,e={},t){let n=new A(i,t);return e.sideOrientation=A._GetDefaultSideOrientation(e.sideOrientation),n._originalBuilderSideOrientation=e.sideOrientation,Xw(e).applyToMesh(n,e.updatable),n}X.CreateTorus=Xw;A.CreateTorus=(i,e,t,n,r,s,o)=>ur(i,{diameter:e,thickness:t,tessellation:n,sideOrientation:o,updatable:s},r);function Zw(i){let e=[],t=[],n=[],r=[],s=i.radius||2,o=i.tube||.5,a=i.radialSegments||32,l=i.tubularSegments||32,c=i.p||2,u=i.q||3,h=i.sideOrientation===0?0:i.sideOrientation||X.DEFAULTSIDE,d=_=>{let y=Math.cos(_),C=Math.sin(_),E=u/c*_,I=Math.cos(E),v=s*(2+I)*.5*y,x=s*(2+I)*C*.5,b=s*Math.sin(E)*.5;return new m(v,x,b)},f,p;for(f=0;f<=a;f++){let y=f%a/a*2*c*Math.PI,C=d(y),E=d(y+.01),I=E.subtract(C),v=E.add(C),x=m.Cross(I,v);for(v=m.Cross(x,I),x.normalize(),v.normalize(),p=0;p<l;p++){let D=p%l/l*2*Math.PI,M=-o*Math.cos(D),R=o*Math.sin(D);t.push(C.x+M*v.x+R*x.x),t.push(C.y+M*v.y+R*x.y),t.push(C.z+M*v.z+R*x.z),r.push(f/a),r.push(we?1-p/l:p/l)}}for(f=0;f<a;f++)for(p=0;p<l;p++){let _=(p+1)%l,y=f*l+p,C=(f+1)*l+p,E=(f+1)*l+_,I=f*l+_;e.push(I),e.push(C),e.push(y),e.push(I),e.push(E),e.push(C)}X.ComputeNormals(t,e,n),X._ComputeSides(h,t,e,n,r,i.frontUVs,i.backUVs);let g=new X;return g.indices=e,g.positions=t,g.normals=n,g.uvs=r,g}function eC(i,e={},t){let n=new A(i,t);return e.sideOrientation=A._GetDefaultSideOrientation(e.sideOrientation),n._originalBuilderSideOrientation=e.sideOrientation,Zw(e).applyToMesh(n,e.updatable),n}X.CreateTorusKnot=Zw;A.CreateTorusKnot=(i,e,t,n,r,s,o,a,l,c)=>eC(i,{radius:e,tube:t,radialSegments:n,tubularSegments:r,p:s,q:o,sideOrientation:c,updatable:l},a);A._LinesMeshParser=(i,e)=>Cm.Parse(i,e);var Cm=(()=>{class i extends A{_isShaderMaterial(t){return t?t.getClassName()==="ShaderMaterial":!1}constructor(t,n=null,r=null,s=null,o,a,l,c){super(t,n,r,s,o),this.useVertexColor=a,this.useVertexAlpha=l,this.color=new G(1,1,1),this.alpha=1,this._shaderLanguage=0,this._ownsMaterial=!1,s&&(this.color=s.color.clone(),this.alpha=s.alpha,this.useVertexColor=s.useVertexColor,this.useVertexAlpha=s.useVertexAlpha),this.intersectionThreshold=.1;let u=[],h={attributes:[S.PositionKind],uniforms:["world","viewProjection"],needAlphaBlending:!0,defines:u,useClipPlane:null,shaderLanguage:0};if(this.useVertexAlpha?h.defines.push("#define VERTEXALPHA"):h.needAlphaBlending=!1,this.useVertexColor?(h.defines.push("#define VERTEXCOLOR"),h.attributes.push(S.ColorKind)):(h.uniforms.push("color"),this._color4=new le),c)this.material=c;else{this.getScene().getEngine().isWebGPU&&!i.ForceGLSL&&(this._shaderLanguage=1),h.shaderLanguage=this._shaderLanguage,h.extraInitializationsAsync=()=>T(this,null,function*(){this._shaderLanguage===1?yield Promise.all([import("./chunk-IVS54B2A.js"),import("./chunk-M4ELAMMT.js")]):yield Promise.all([import("./chunk-VITFGXJE.js"),import("./chunk-A3CDPD47.js")])});let f=new Wi("colorShader",this.getScene(),"color",h,!1);f.doNotSerialize=!0,this._ownsMaterial=!0,this._setInternalMaterial(f)}}getClassName(){return"LinesMesh"}get material(){return this._internalAbstractMeshDataInfo._material}set material(t){let n=this.material;if(n===t)return;let r=n&&this._ownsMaterial;this._ownsMaterial=!1,this._setInternalMaterial(t),r&&n?.dispose()}_setInternalMaterial(t){this._setMaterial(t),this.material&&(this.material.fillMode=Oe.LineListDrawMode,this.material.disableLighting=!0)}get checkCollisions(){return!1}set checkCollisions(t){}_bind(t,n){if(!this._geometry)return this;let r=this.isUnIndexed?null:this._geometry.getIndexBuffer();if(!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(n,r):this._geometry._bind(n,r,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),!this.useVertexColor&&this._isShaderMaterial(this.material)){let{r:s,g:o,b:a}=this.color;this._color4.set(s,o,a,this.alpha),this.material.setColor4("color",this._color4)}return this}_draw(t,n,r){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;let s=this.getScene().getEngine();return this._unIndexed?s.drawArraysType(Oe.LineListDrawMode,t.verticesStart,t.verticesCount,r):s.drawElementsType(Oe.LineListDrawMode,t.indexStart,t.indexCount,r),this}dispose(t,n=!1,r){r||(this._ownsMaterial?this.material?.dispose(!1,!1,!0):n&&this.material?.dispose(!1,!1,!0)),super.dispose(t)}clone(t,n=null,r){if(n&&n._addToSceneRootNodes===void 0){let s=n;return s.source=this,new i(t,this.getScene(),s.parent,s.source,s.doNotCloneChildren)}return new i(t,this.getScene(),n,this,r)}createInstance(t){let n=new tC(t,this);if(this.instancedBuffers){n.instancedBuffers={};for(let r in this.instancedBuffers)n.instancedBuffers[r]=this.instancedBuffers[r]}return n}serialize(t){super.serialize(t),t.color=this.color.asArray(),t.alpha=this.alpha}static Parse(t,n){let r=new i(t.name,n);return r.color=G.FromArray(t.color),r.alpha=t.alpha,r}}return i.ForceGLSL=!1,i})(),tC=class extends us{constructor(e,t){super(e,t),this.intersectionThreshold=t.intersectionThreshold}getClassName(){return"InstancedLinesMesh"}};function Qw(i){let e=[],t=[],n=i.lines,r=i.colors,s=[],o=0;for(let l=0;l<n.length;l++){let c=n[l];for(let u=0;u<c.length;u++){let{x:h,y:d,z:f}=c[u];if(t.push(h,d,f),r){let p=r[l],{r:g,g:_,b:y,a:C}=p[u];s.push(g,_,y,C)}u>0&&(e.push(o-1),e.push(o)),o++}}let a=new X;return a.indices=e,a.positions=t,r&&(a.colors=s),a}function Jw(i){let e=i.dashSize||3,t=i.gapSize||1,n=i.dashNb||200,r=i.points,s=[],o=[],a=m.Zero(),l=0,c=0,u=0,h=0,d=0,f=0,p=0;for(p=0;p<r.length-1;p++)r[p+1].subtractToRef(r[p],a),l+=a.length();for(u=l/n,h=e*u/(e+t),p=0;p<r.length-1;p++){r[p+1].subtractToRef(r[p],a),c=Math.floor(a.length()/u),a.normalize();for(let _=0;_<c;_++)d=u*_,s.push(r[p].x+d*a.x,r[p].y+d*a.y,r[p].z+d*a.z),s.push(r[p].x+(d+h)*a.x,r[p].y+(d+h)*a.y,r[p].z+(d+h)*a.z),o.push(f,f+1),f+=2}let g=new X;return g.positions=s,g.indices=o,g}function nC(i,e,t=null){let n=e.instance,r=e.lines,s=e.colors;if(n){let c=n.getVerticesData(S.PositionKind),u,h;s&&(u=n.getVerticesData(S.ColorKind));let d=0,f=0;for(let p=0;p<r.length;p++){let g=r[p];for(let _=0;_<g.length;_++)c[d]=g[_].x,c[d+1]=g[_].y,c[d+2]=g[_].z,s&&u&&(h=s[p],u[f]=h[_].r,u[f+1]=h[_].g,u[f+2]=h[_].b,u[f+3]=h[_].a,f+=4),d+=3}return n.updateVerticesData(S.PositionKind,c,!1,!1),s&&u&&n.updateVerticesData(S.ColorKind,u,!1,!1),n.refreshBoundingInfo(),n}let o=!!s,a=new Cm(i,t,null,void 0,void 0,o,e.useVertexAlpha,e.material);return Qw(e).applyToMesh(a,e.updatable),a}function Vu(i,e,t=null){let n=e.colors?[e.colors]:null;return nC(i,{lines:[e.points],updatable:e.updatable,instance:e.instance,colors:n,useVertexAlpha:e.useVertexAlpha,material:e.material},t)}function iC(i,e,t=null){let n=e.points,r=e.instance,s=e.gapSize||1,o=e.dashSize||3;if(r){let c=u=>{let h=m.Zero(),d=u.length/6,f=0,p=0,g=0,_=0,y=0,C=0,E=0,I=0;for(E=0;E<n.length-1;E++)n[E+1].subtractToRef(n[E],h),f+=h.length();g=f/d;let v=r._creationDataStorage.dashSize,x=r._creationDataStorage.gapSize;for(_=v*g/(v+x),E=0;E<n.length-1;E++)for(n[E+1].subtractToRef(n[E],h),p=Math.floor(h.length()/g),h.normalize(),I=0;I<p&&C<u.length;)y=g*I,u[C]=n[E].x+y*h.x,u[C+1]=n[E].y+y*h.y,u[C+2]=n[E].z+y*h.z,u[C+3]=n[E].x+(y+_)*h.x,u[C+4]=n[E].y+(y+_)*h.y,u[C+5]=n[E].z+(y+_)*h.z,C+=6,I++;for(;C<u.length;)u[C]=n[E].x,u[C+1]=n[E].y,u[C+2]=n[E].z,C+=3};return(e.dashNb||e.dashSize||e.gapSize||e.useVertexAlpha||e.material)&&N.Warn("You have used an option other than points with the instance option. Please be aware that these other options will be ignored."),r.updateMeshPositions(c,!1),r}let a=new Cm(i,t,null,void 0,void 0,void 0,e.useVertexAlpha,e.material);return Jw(e).applyToMesh(a,e.updatable),a._creationDataStorage=new Al,a._creationDataStorage.dashSize=o,a._creationDataStorage.gapSize=s,a}X.CreateLineSystem=Qw;X.CreateDashedLines=Jw;A.CreateLines=(i,e,t=null,n=!1,r=null)=>Vu(i,{points:e,updatable:n,instance:r},t);A.CreateDashedLines=(i,e,t,n,r,s=null,o,a)=>iC(i,{points:e,dashSize:t,gapSize:n,dashNb:r,updatable:o,instance:a},s);var rC=class extends _e{constructor(e,t){super(e.x,e.y),this.index=t}},Gu=class{constructor(){this.elements=[]}add(e){let t=[];for(let n of e){let r=new rC(n,this.elements.length);t.push(r),this.elements.push(r)}return t}computeBounds(){let e=new _e(this.elements[0].x,this.elements[0].y),t=new _e(this.elements[0].x,this.elements[0].y);for(let n of this.elements)n.x<e.x?e.x=n.x:n.x>t.x&&(t.x=n.x),n.y<e.y?e.y=n.y:n.y>t.y&&(t.y=n.y);return{min:e,max:t,width:t.x-e.x,height:t.y-e.y}}};var Tm=class{_addToepoint(e){for(let t of e)this._epoints.push(t.x,t.y)}constructor(e,t,n,r=earcut){this._points=new Gu,this._outlinepoints=new Gu,this._holes=new Array,this._epoints=new Array,this._eholes=new Array,this.bjsEarcut=r,this._name=e,this._scene=n||Ie.LastCreatedScene;let s;t instanceof dh?s=t.getPoints():s=t,this._addToepoint(s),this._points.add(s),this._outlinepoints.add(s),typeof this.bjsEarcut>"u"&&N.Warn("Earcut was not found, the polygon will not be built.")}addHole(e){this._points.add(e);let t=new Gu;return t.add(e),this._holes.push(t),this._eholes.push(this._epoints.length/2),this._addToepoint(e),this}build(e=!1,t=0,n=2){let r=new A(this._name,this._scene),s=this.buildVertexData(t,n);return r.setVerticesData(S.PositionKind,s.positions,e),r.setVerticesData(S.NormalKind,s.normals,e),r.setVerticesData(S.UVKind,s.uvs,e),r.setIndices(s.indices),r}buildVertexData(e=0,t=2){let n=new X,r=[],s=[],o=[],a=this._points.computeBounds();for(let u of this._points.elements)r.push(0,1,0),s.push(u.x,0,u.y),o.push((u.x-a.min.x)/a.width,(u.y-a.min.y)/a.height);let l=[],c=this.bjsEarcut(this._epoints,this._eholes,2);for(let u=0;u<c.length;u++)l.push(c[u]);if(e>0){let u=s.length/3;for(let d of this._points.elements)r.push(0,-1,0),s.push(d.x,-e,d.y),o.push(1-(d.x-a.min.x)/a.width,1-(d.y-a.min.y)/a.height);let h=l.length;for(let d=0;d<h;d+=3){let f=l[d+0],p=l[d+1],g=l[d+2];l.push(g+u),l.push(p+u),l.push(f+u)}this._addSide(s,r,o,l,a,this._outlinepoints,e,!1,t);for(let d of this._holes)this._addSide(s,r,o,l,a,d,e,!0,t)}return n.indices=l,n.positions=s,n.normals=r,n.uvs=o,n}_addSide(e,t,n,r,s,o,a,l,c){let u=e.length/3,h=0;for(let d=0;d<o.elements.length;d++){let f=o.elements[d],p=o.elements[(d+1)%o.elements.length];e.push(f.x,0,f.y),e.push(f.x,-a,f.y),e.push(p.x,0,p.y),e.push(p.x,-a,p.y);let g=o.elements[(d+o.elements.length-1)%o.elements.length],_=o.elements[(d+2)%o.elements.length],y=new m(-(p.y-f.y),0,p.x-f.x),C=new m(-(f.y-g.y),0,f.x-g.x),E=new m(-(_.y-p.y),0,_.x-p.x);l||(y=y.scale(-1),C=C.scale(-1),E=E.scale(-1));let I=y.normalizeToNew(),v=C.normalizeToNew(),x=E.normalizeToNew(),b=m.Dot(v,I);b>c?b<Pt-1?v=new m(f.x,0,f.y).subtract(new m(p.x,0,p.y)).normalize():v=C.add(y).normalize():v=I;let D=m.Dot(E,y);D>c?D<Pt-1?x=new m(p.x,0,p.y).subtract(new m(f.x,0,f.y)).normalize():x=E.add(y).normalize():x=I,n.push(h/s.width,0),n.push(h/s.width,1),h+=y.length(),n.push(h/s.width,0),n.push(h/s.width,1),t.push(v.x,v.y,v.z),t.push(v.x,v.y,v.z),t.push(x.x,x.y,x.z),t.push(x.x,x.y,x.z),l?(r.push(u),r.push(u+2),r.push(u+1),r.push(u+1),r.push(u+2),r.push(u+3)):(r.push(u),r.push(u+1),r.push(u+2),r.push(u+1),r.push(u+3),r.push(u+2)),u+=4}}};function eM(i,e,t,n,r,s,o){let a=t||new Array(3),l=n,c=[],u=o||!1;for(let M=0;M<3;M++)a[M]===void 0&&(a[M]=new ht(0,0,1,1)),l&&l[M]===void 0&&(l[M]=new le(1,1,1,1));let h=i.getVerticesData(S.PositionKind),d=i.getVerticesData(S.NormalKind),f=i.getVerticesData(S.UVKind),p=i.getIndices(),g=h.length/9,_=0,y=0,C=0,E=0,I=0,v=[0];if(u)for(let M=g;M<h.length/3;M+=4)y=h[3*(M+2)]-h[3*M],C=h[3*(M+2)+2]-h[3*M+2],E=Math.sqrt(y*y+C*C),I+=E,v.push(I);let x=0,b=0;for(let M=0;M<d.length;M+=3)Math.abs(d[M+1])<.001&&(b=1),Math.abs(d[M+1]-1)<.001&&(b=0),Math.abs(d[M+1]+1)<.001&&(b=2),x=M/3,b===1?(_=x-g,_%4<1.5?u?f[2*x]=a[b].x+(a[b].z-a[b].x)*v[Math.floor(_/4)]/I:f[2*x]=a[b].x:u?f[2*x]=a[b].x+(a[b].z-a[b].x)*v[Math.floor(_/4)+1]/I:f[2*x]=a[b].z,_%2===0?f[2*x+1]=we?1-a[b].w:a[b].w:f[2*x+1]=we?1-a[b].y:a[b].y):(f[2*x]=(1-f[2*x])*a[b].x+f[2*x]*a[b].z,f[2*x+1]=(1-f[2*x+1])*a[b].y+f[2*x+1]*a[b].w,we&&(f[2*x+1]=1-f[2*x+1])),l&&c.push(l[b].r,l[b].g,l[b].b,l[b].a);X._ComputeSides(e,h,p,d,f,r,s);let D=new X;if(D.indices=p,D.positions=h,D.normals=d,D.uvs=f,l){let M=e===X.DOUBLESIDE?c.concat(c):c;D.colors=M}return D}function Sm(i,e,t=null,n=earcut){e.sideOrientation=A._GetDefaultSideOrientation(e.sideOrientation);let r=e.shape,s=e.holes||[],o=e.depth||0,a=e.smoothingThreshold||2,l=[],c=[];for(let p=0;p<r.length;p++)l[p]=new _e(r[p].x,r[p].z);l[0].equalsWithEpsilon(l[l.length-1],1e-8)&&l.pop();let h=new Tm(i,l,t||Ie.LastCreatedScene,n);for(let p=0;p<s.length;p++){c=[];for(let g=0;g<s[p].length;g++)c.push(new _e(s[p][g].x,s[p][g].z));h.addHole(c)}let d=h.build(!1,o,a);return d._originalBuilderSideOrientation=e.sideOrientation,eM(d,e.sideOrientation,e.faceUV,e.faceColors,e.frontUVs,e.backUVs,e.wrap).applyToMesh(d,e.updatable),d}function Uu(i,e,t=null,n=earcut){return Sm(i,e,t,n)}X.CreatePolygon=eM;A.CreatePolygon=(i,e,t,n,r,s,o=earcut)=>Sm(i,{shape:e,holes:n,updatable:r,sideOrientation:s},t,o);A.ExtrudePolygon=(i,e,t,n,r,s,o,a=earcut)=>Uu(i,{shape:e,holes:r,depth:t,updatable:s,sideOrientation:o},n,a);function sC(i,e,t=null){let n=e.path,r=e.shape,s=e.scale||1,o=e.rotation||0,a=e.cap===0?0:e.cap||A.NO_CAP,l=e.updatable,c=A._GetDefaultSideOrientation(e.sideOrientation),u=e.instance||null,h=e.invertUV||!1,d=e.closeShape||!1,f=e.closePath||!1,p=e.capFunction||null;return tM(i,r,n,s,o,null,null,f,d,a,!1,t,!!l,c,u,h,e.frontUVs||null,e.backUVs||null,e.firstNormal||null,!!e.adjustFrame,p)}function oC(i,e,t=null){let n=e.path,r=e.shape,s=e.scaleFunction||(()=>1),o=e.rotationFunction||(()=>0),a=e.closePath||e.ribbonCloseArray||!1,l=e.closeShape||e.ribbonClosePath||!1,c=e.cap===0?0:e.cap||A.NO_CAP,u=e.updatable,h=e.firstNormal||null,d=e.adjustFrame||!1,f=A._GetDefaultSideOrientation(e.sideOrientation),p=e.instance,g=e.invertUV||!1,_=e.capFunction||null;return tM(i,r,n,null,null,s,o,a,l,c,!0,t,!!u,f,p||null,g,e.frontUVs||null,e.backUVs||null,h,d,_||null)}function tM(i,e,t,n,r,s,o,a,l,c,u,h,d,f,p,g,_,y,C,E,I){let v=(R,W,ie,ce,Q,de,oe,pe,ve,$,j)=>{let O=ie.getTangents(),k=ie.getNormals(),F=ie.getBinormals(),q=ie.getDistances();if(j){for(let Ce=0;Ce<O.length;Ce++)if(O[Ce].x==0&&O[Ce].y==0&&O[Ce].z==0&&O[Ce].copyFrom(O[Ce-1]),k[Ce].x==0&&k[Ce].y==0&&k[Ce].z==0&&k[Ce].copyFrom(k[Ce-1]),F[Ce].x==0&&F[Ce].y==0&&F[Ce].z==0&&F[Ce].copyFrom(F[Ce-1]),Ce>0){let _n=O[Ce-1];m.Dot(_n,O[Ce])<0&&O[Ce].scaleInPlace(-1),_n=k[Ce-1],m.Dot(_n,k[Ce])<0&&k[Ce].scaleInPlace(-1),_n=F[Ce-1],m.Dot(_n,F[Ce])<0&&F[Ce].scaleInPlace(-1)}}let be=0,re=()=>Q!==null?Q:1,Qe=$&&pe?pe:()=>de!==null?de:0,zt=$&&oe?oe:re,bt=ve===A.NO_CAP||ve===A.CAP_END?0:2,Ht=U.Matrix[0];for(let Ce=0;Ce<W.length;Ce++){let _n=[],Pi=Qe(Ce,q[Ce]),Xn=zt(Ce,q[Ce]);V.RotationAxisToRef(O[Ce],be,Ht);for(let Ki=0;Ki<R.length;Ki++){let da=O[Ce].scale(R[Ki].z).add(k[Ce].scale(R[Ki].x)).add(F[Ce].scale(R[Ki].y)),dr=m.Zero();m.TransformCoordinatesToRef(da,Ht,dr),dr.scaleInPlace(Xn).addInPlace(W[Ce]),_n[Ki]=dr}ce[bt]=_n,be+=Pi,bt++}let We=I||(Ce=>{let _n=Array(),Pi=m.Zero(),Xn;for(Xn=0;Xn<Ce.length;Xn++)Pi.addInPlace(Ce[Xn]);for(Pi.scaleInPlace(1/Ce.length),Xn=0;Xn<Ce.length;Xn++)_n.push(Pi);return _n});switch(ve){case A.NO_CAP:break;case A.CAP_START:ce[0]=We(ce[2]),ce[1]=ce[2];break;case A.CAP_END:ce[bt]=ce[bt-1],ce[bt+1]=We(ce[bt-1]);break;case A.CAP_ALL:ce[0]=We(ce[2]),ce[1]=ce[2],ce[bt]=ce[bt-1],ce[bt+1]=We(ce[bt-1]);break;default:break}return ce},x,b;if(p){let R=p._creationDataStorage;return x=C?R.path3D.update(t,C):R.path3D.update(t),b=v(e,t,R.path3D,R.pathArray,n,r,s,o,R.cap,u,E),p=cr("",{pathArray:b,closeArray:!1,closePath:!1,offset:0,updatable:!1,sideOrientation:0,instance:p},h||void 0),p}x=C?new uc(t,C):new uc(t);let D=new Array;c=c<0||c>3?0:c,b=v(e,t,x,D,n,r,s,o,c,u,E);let M=cr(i,{pathArray:b,closeArray:a,closePath:l,updatable:d,sideOrientation:f,invertUV:g,frontUVs:_||void 0,backUVs:y||void 0},h);return M._creationDataStorage.pathArray=b,M._creationDataStorage.path3D=x,M._creationDataStorage.cap=c,M}A.ExtrudeShape=(i,e,t,n,r,s,o=null,a,l,c)=>{let u={shape:e,path:t,scale:n,rotation:r,cap:s===0?0:s||A.NO_CAP,sideOrientation:l,instance:c,updatable:a};return sC(i,u,o)};A.ExtrudeShapeCustom=(i,e,t,n,r,s,o,a,l,c,u,h)=>{let d={shape:e,path:t,scaleFunction:n,rotationFunction:r,ribbonCloseArray:s,ribbonClosePath:o,cap:a===0?0:a||A.NO_CAP,sideOrientation:u,instance:h,updatable:c};return oC(i,d,l)};function aC(i,e,t=null){let n=e.arc?e.arc<=0||e.arc>1?1:e.arc:1,r=e.closed===void 0?!0:e.closed,s=e.shape,o=e.radius||1,a=e.tessellation||64,l=e.clip||0,c=e.updatable,u=A._GetDefaultSideOrientation(e.sideOrientation),h=e.cap||A.NO_CAP,d=Math.PI*2,f=[],p=e.invertUV||!1,g=0,_=0,y=d/a*n,C,E;for(g=0;g<=a-l;g++){for(E=[],(h==A.CAP_START||h==A.CAP_ALL)&&(E.push(new m(0,s[0].y,0)),E.push(new m(Math.cos(g*y)*s[0].x*o,s[0].y,Math.sin(g*y)*s[0].x*o))),_=0;_<s.length;_++)C=new m(Math.cos(g*y)*s[_].x*o,s[_].y,Math.sin(g*y)*s[_].x*o),E.push(C);(h==A.CAP_END||h==A.CAP_ALL)&&(E.push(new m(Math.cos(g*y)*s[s.length-1].x*o,s[s.length-1].y,Math.sin(g*y)*s[s.length-1].x*o)),E.push(new m(0,s[s.length-1].y,0))),f.push(E)}return cr(i,{pathArray:f,closeArray:r,sideOrientation:u,updatable:c,invertUV:p,frontUVs:e.frontUVs,backUVs:e.backUVs},t)}A.CreateLathe=(i,e,t,n,r,s,o)=>aC(i,{shape:e,radius:t,tessellation:n,sideOrientation:o,updatable:s},r);function nM(i){let e=[],t=[],n=[],r=[],s=i.width!==void 0?i.width:i.size!==void 0?i.size:1,o=i.height!==void 0?i.height:i.size!==void 0?i.size:1,a=i.sideOrientation===0?0:i.sideOrientation||X.DEFAULTSIDE,l=s/2,c=o/2;t.push(-l,-c,0),n.push(0,0,-1),r.push(0,we?1:0),t.push(l,-c,0),n.push(0,0,-1),r.push(1,we?1:0),t.push(l,c,0),n.push(0,0,-1),r.push(1,we?0:1),t.push(-l,c,0),n.push(0,0,-1),r.push(0,we?0:1),e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),X._ComputeSides(a,t,e,n,r,i.frontUVs,i.backUVs);let u=new X;return u.indices=e,u.positions=t,u.normals=n,u.uvs=r,u}function zu(i,e={},t=null){let n=new A(i,t);return e.sideOrientation=A._GetDefaultSideOrientation(e.sideOrientation),n._originalBuilderSideOrientation=e.sideOrientation,nM(e).applyToMesh(n,e.updatable),e.sourcePlane&&(n.translate(e.sourcePlane.normal,-e.sourcePlane.d),n.setDirection(e.sourcePlane.normal.scale(-1))),n}X.CreatePlane=nM;A.CreatePlane=(i,e,t,n,r)=>zu(i,{size:e,width:e,height:e,sideOrientation:r,updatable:n},t);function lC(i,e,t=null){let n=e.path,r=e.instance,s=1;e.radius!==void 0?s=e.radius:r&&(s=r._creationDataStorage.radius);let o=e.tessellation||64,a=e.radiusFunction||null,l=e.cap||A.NO_CAP,c=e.invertUV||!1,u=e.updatable,h=A._GetDefaultSideOrientation(e.sideOrientation);e.arc=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1;let d=(y,C,E,I,v,x,b,D)=>{let M=C.getTangents(),R=C.getNormals(),W=C.getDistances(),ce=Math.PI*2/v*D,de=x||(()=>I),oe,pe,ve,$,j=U.Matrix[0],O=b===A.NO_CAP||b===A.CAP_END?0:2;for(let F=0;F<y.length;F++){pe=de(F,W[F]),oe=Array(),ve=R[F];for(let q=0;q<v;q++)V.RotationAxisToRef(M[F],ce*q,j),$=oe[q]?oe[q]:m.Zero(),m.TransformCoordinatesToRef(ve,j,$),$.scaleInPlace(pe).addInPlace(y[F]),oe[q]=$;E[O]=oe,O++}let k=(F,q)=>{let be=Array();for(let re=0;re<F;re++)be.push(y[q]);return be};switch(b){case A.NO_CAP:break;case A.CAP_START:E[0]=k(v,0),E[1]=E[2].slice(0);break;case A.CAP_END:E[O]=E[O-1].slice(0),E[O+1]=k(v,y.length-1);break;case A.CAP_ALL:E[0]=k(v,0),E[1]=E[2].slice(0),E[O]=E[O-1].slice(0),E[O+1]=k(v,y.length-1);break;default:break}return E},f,p;if(r){let y=r._creationDataStorage,C=e.arc||y.arc;return f=y.path3D.update(n),p=d(n,f,y.pathArray,s,y.tessellation,a,y.cap,C),r=cr("",{pathArray:p,instance:r}),y.path3D=f,y.pathArray=p,y.arc=C,y.radius=s,r}f=new uc(n);let g=new Array;l=l<0||l>3?0:l,p=d(n,f,g,s,o,a,l,e.arc);let _=cr(i,{pathArray:p,closePath:!0,closeArray:!1,updatable:u,sideOrientation:h,invertUV:c,frontUVs:e.frontUVs,backUVs:e.backUVs},t);return _._creationDataStorage.pathArray=p,_._creationDataStorage.path3D=f,_._creationDataStorage.tessellation=o,_._creationDataStorage.cap=l,_._creationDataStorage.arc=e.arc,_._creationDataStorage.radius=s,_}A.CreateTube=(i,e,t,n,r,s,o,a,l,c)=>lC(i,{path:e,radius:t,tessellation:n,radiusFunction:r,arc:1,cap:s,updatable:a,sideOrientation:l,instance:c},o);function iM(i){let e=[];e[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]},e[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]},e[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]},e[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]},e[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]},e[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]},e[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]},e[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]},e[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]},e[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]},e[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]},e[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]},e[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]},e[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]},e[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};let t=i.type&&(i.type<0||i.type>=e.length)?0:i.type||0,n=i.size,r=i.sizeX||n||1,s=i.sizeY||n||1,o=i.sizeZ||n||1,a=i.custom||e[t],l=a.face.length,c=i.faceUV||new Array(l),u=i.faceColors,h=i.flat===void 0?!0:i.flat,d=i.sideOrientation===0?0:i.sideOrientation||X.DEFAULTSIDE,f=[],p=[],g=[],_=[],y=[],C=0,E=0,I=[],v=0,x=0,b,D,M,R,W,ie;if(h)for(x=0;x<l;x++)u&&u[x]===void 0&&(u[x]=new le(1,1,1,1)),c&&c[x]===void 0&&(c[x]=new ht(0,0,1,1));if(h)for(x=0;x<l;x++){let Q=a.face[x].length;for(M=2*Math.PI/Q,R=.5*Math.tan(M/2),W=.5,v=0;v<Q;v++)f.push(a.vertex[a.face[x][v]][0]*r,a.vertex[a.face[x][v]][1]*s,a.vertex[a.face[x][v]][2]*o),I.push(C),C++,b=c[x].x+(c[x].z-c[x].x)*(.5+R),D=c[x].y+(c[x].w-c[x].y)*(W-.5),_.push(b,we?1-D:D),ie=R*Math.cos(M)-W*Math.sin(M),W=R*Math.sin(M)+W*Math.cos(M),R=ie,u&&y.push(u[x].r,u[x].g,u[x].b,u[x].a);for(v=0;v<Q-2;v++)p.push(I[0+E],I[v+2+E],I[v+1+E]);E+=Q}else{for(v=0;v<a.vertex.length;v++)f.push(a.vertex[v][0]*r,a.vertex[v][1]*s,a.vertex[v][2]*o),_.push(0,we?1:0);for(x=0;x<l;x++)for(v=0;v<a.face[x].length-2;v++)p.push(a.face[x][0],a.face[x][v+2],a.face[x][v+1])}X.ComputeNormals(f,p,g),X._ComputeSides(d,f,p,g,_,i.frontUVs,i.backUVs);let ce=new X;return ce.positions=f,ce.indices=p,ce.normals=g,ce.uvs=_,u&&h&&(ce.colors=y),ce}function Hu(i,e={},t=null){let n=new A(i,t);return e.sideOrientation=A._GetDefaultSideOrientation(e.sideOrientation),n._originalBuilderSideOrientation=e.sideOrientation,iM(e).applyToMesh(n,e.updatable),n}X.CreatePolyhedron=iM;A.CreatePolyhedron=(i,e,t)=>Hu(i,e,t);function rM(i){let e=i.sideOrientation||X.DEFAULTSIDE,t=i.radius||1,n=i.flat===void 0?!0:i.flat,r=(i.subdivisions||4)|0,s=i.radiusX||t,o=i.radiusY||t,a=i.radiusZ||t,l=(1+Math.sqrt(5))/2,c=[-1,l,-0,1,l,0,-1,-l,0,1,-l,0,0,-1,-l,0,1,-l,0,-1,l,0,1,l,l,0,1,l,0,-1,-l,0,1,-l,0,-1],u=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],h=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],d=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],f=138/1024,p=239/1024,g=60/1024,_=26/1024,y=-40/1024,C=20/1024,E=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],I=[],v=[],x=[],b=[],D=0,M=new Array(3),R=new Array(3),W;for(W=0;W<3;W++)M[W]=m.Zero(),R[W]=_e.Zero();for(let ce=0;ce<20;ce++){for(W=0;W<3;W++){let de=u[3*ce+W];M[W].copyFromFloats(c[3*h[de]],c[3*h[de]+1],c[3*h[de]+2]),M[W].normalize(),R[W].copyFromFloats(d[2*de]*f+g+E[ce]*y,d[2*de+1]*p+_+E[ce]*C)}let Q=(de,oe,pe,ve)=>{let $=m.Lerp(M[0],M[2],oe/r),j=m.Lerp(M[1],M[2],oe/r),O=r===oe?M[2]:m.Lerp($,j,de/(r-oe));O.normalize();let k;if(n){let re=m.Lerp(M[0],M[2],ve/r),Se=m.Lerp(M[1],M[2],ve/r);k=m.Lerp(re,Se,pe/(r-ve))}else k=new m(O.x,O.y,O.z);k.x/=s,k.y/=o,k.z/=a,k.normalize();let F=_e.Lerp(R[0],R[2],oe/r),q=_e.Lerp(R[1],R[2],oe/r),be=r===oe?R[2]:_e.Lerp(F,q,de/(r-oe));v.push(O.x*s,O.y*o,O.z*a),x.push(k.x,k.y,k.z),b.push(be.x,we?1-be.y:be.y),I.push(D),D++};for(let de=0;de<r;de++)for(let oe=0;oe+de<r;oe++)Q(oe,de,oe+1/3,de+1/3),Q(oe+1,de,oe+1/3,de+1/3),Q(oe,de+1,oe+1/3,de+1/3),oe+de+1<r&&(Q(oe+1,de,oe+2/3,de+2/3),Q(oe+1,de+1,oe+2/3,de+2/3),Q(oe,de+1,oe+2/3,de+2/3))}X._ComputeSides(e,v,I,x,b,i.frontUVs,i.backUVs);let ie=new X;return ie.indices=I,ie.positions=v,ie.normals=x,ie.uvs=b,ie}function Ll(i,e={},t=null){let n=new A(i,t);return e.sideOrientation=A._GetDefaultSideOrientation(e.sideOrientation),n._originalBuilderSideOrientation=e.sideOrientation,rM(e).applyToMesh(n,e.updatable),n}X.CreateIcoSphere=rM;A.CreateIcoSphere=(i,e,t)=>Ll(i,e,t);var zk=new m(1,0,0),Hk=new m(-1,0,0),$k=new m(0,1,0),Wk=new m(0,-1,0),jk=new m(0,0,1),qk=new m(0,0,-1),Im=class i{constructor(e=m.Zero(),t=m.Up(),n=_e.Zero(),r=0,s=0,o=null,a=null,l=null,c=null){this.position=e,this.normal=t,this.uv=n,this.vertexIdx=r,this.vertexIdxForBones=s,this.localPositionOverride=o,this.localNormalOverride=a,this.matrixIndicesOverride=l,this.matrixWeightsOverride=c}clone(){return new i(this.position.clone(),this.normal.clone(),this.uv.clone(),this.vertexIdx,this.vertexIdxForBones,this.localPositionOverride?.slice(),this.localNormalOverride?.slice(),this.matrixIndicesOverride?.slice(),this.matrixWeightsOverride?.slice())}};function cC(i,e,t){let n=!!e.skeleton,r=!!e.morphTargetManager?.numTargets,s=t.localMode||n,o=e.getIndices(),a=n||r?e.getPositionData(!0,!0):e.getVerticesData(S.PositionKind),l=n||r?e.getNormalsData(!0,!0):e.getVerticesData(S.NormalKind),c=s?n?e.getVerticesData(S.PositionKind):a:null,u=s?n?e.getVerticesData(S.NormalKind):l:null,h=e.getVerticesData(S.UVKind),d=n?e.getVerticesData(S.MatricesIndicesKind):null,f=n?e.getVerticesData(S.MatricesWeightsKind):null,p=n?e.getVerticesData(S.MatricesIndicesExtraKind):null,g=n?e.getVerticesData(S.MatricesWeightsExtraKind):null,_=t.position||m.Zero(),y=t.normal||m.Up(),C=t.size||m.One(),E=t.angle||0;if(!y){let pe=new m(0,0,1),ve=e.getScene().activeCamera,$=m.TransformCoordinates(pe,ve.getWorldMatrix());y=ve.globalPosition.subtract($)}let I=-Math.atan2(y.z,y.x)-Math.PI/2,v=Math.sqrt(y.x*y.x+y.z*y.z),x=Math.atan2(y.y,v),b=new X;b.indices=[],b.positions=[],b.normals=[],b.uvs=[],b.matricesIndices=n?[]:null,b.matricesWeights=n?[]:null,b.matricesIndicesExtra=p?[]:null,b.matricesWeightsExtra=g?[]:null;let D=0,M=(pe,ve)=>{let $=new Im;if(!o||!a||!l)return $;let j=o[pe];if($.vertexIdx=j*3,$.vertexIdxForBones=j*4,$.position=new m(a[j*3],a[j*3+1],a[j*3+2]),m.TransformCoordinatesToRef($.position,ve,$.position),$.normal=new m(l[j*3],l[j*3+1],l[j*3+2]),m.TransformNormalToRef($.normal,ve,$.normal),t.captureUVS&&h){let O=h[j*2+1];$.uv=new _e(h[j*2],we?1-O:O)}return $},R=[0,0,0,0],W=(pe,ve)=>{if(pe.length===0)return pe;let $=.5*Math.abs(m.Dot(C,ve)),j=(F,q,be,re)=>{for(let Se=0;Se<re;++Se)if(F[be+Se]===q)return be+Se;return-1},O=(F,q)=>{let be=m.GetClipFactor(F.position,q.position,ve,$),re=R,Se=R;if(d&&f){let lc=F.matrixIndicesOverride?0:F.vertexIdxForBones,fg=F.matrixIndicesOverride??d,JC=F.matrixWeightsOverride??f,pg=q.matrixIndicesOverride?0:q.vertexIdxForBones,eT=q.matrixIndicesOverride??d,tT=q.matrixWeightsOverride??f;re=[0,0,0,0],Se=[0,0,0,0];let eo=0;for(let Xi=0;Xi<4;++Xi)if(JC[lc+Xi]>0){let cc=j(eT,fg[lc+Xi],pg,4);re[eo]=fg[lc+Xi],Se[eo]=Kt(JC[lc+Xi],cc>=0?tT[cc]:0,be),eo++}for(let Xi=0;Xi<4&&eo<4;++Xi){let cc=eT[pg+Xi];j(fg,cc,lc,4)===-1&&(re[eo]=cc,Se[eo]=Kt(0,tT[pg+Xi],be),eo++)}let uh=Se[0]+Se[1]+Se[2]+Se[3];Se[0]/=uh,Se[1]/=uh,Se[2]/=uh,Se[3]/=uh}let Qe=F.localPositionOverride?F.localPositionOverride[0]:c?.[F.vertexIdx]??0,zt=F.localPositionOverride?F.localPositionOverride[1]:c?.[F.vertexIdx+1]??0,bt=F.localPositionOverride?F.localPositionOverride[2]:c?.[F.vertexIdx+2]??0,Ht=q.localPositionOverride?q.localPositionOverride[0]:c?.[q.vertexIdx]??0,ge=q.localPositionOverride?q.localPositionOverride[1]:c?.[q.vertexIdx+1]??0,We=q.localPositionOverride?q.localPositionOverride[2]:c?.[q.vertexIdx+2]??0,Ce=F.localNormalOverride?F.localNormalOverride[0]:u?.[F.vertexIdx]??0,_n=F.localNormalOverride?F.localNormalOverride[1]:u?.[F.vertexIdx+1]??0,Pi=F.localNormalOverride?F.localNormalOverride[2]:u?.[F.vertexIdx+2]??0,Xn=q.localNormalOverride?q.localNormalOverride[0]:u?.[q.vertexIdx]??0,Ki=q.localNormalOverride?q.localNormalOverride[1]:u?.[q.vertexIdx+1]??0,da=q.localNormalOverride?q.localNormalOverride[2]:u?.[q.vertexIdx+2]??0,dr=Ce+(Xn-Ce)*be,fa=_n+(Ki-_n)*be,pa=Pi+(da-Pi)*be,dg=Math.sqrt(dr*dr+fa*fa+pa*pa);return new Im(m.Lerp(F.position,q.position,be),m.Lerp(F.normal,q.normal,be).normalize(),_e.Lerp(F.uv,q.uv,be),-1,-1,c?[Qe+(Ht-Qe)*be,zt+(ge-zt)*be,bt+(We-bt)*be]:null,u?[dr/dg,fa/dg,pa/dg]:null,re,Se)},k=null;pe.length>3&&(k=[]);for(let F=0;F<pe.length;F+=3){let q=0,be=null,re=null,Se=null,Qe=null,zt=m.Dot(pe[F].position,ve)-$,bt=m.Dot(pe[F+1].position,ve)-$,Ht=m.Dot(pe[F+2].position,ve)-$,ge=zt>0,We=bt>0,Ce=Ht>0;switch(q=(ge?1:0)+(We?1:0)+(Ce?1:0),q){case 0:pe.length>3?(k.push(pe[F]),k.push(pe[F+1]),k.push(pe[F+2])):k=pe;break;case 1:if(k=k??new Array,ge&&(be=pe[F+1],re=pe[F+2],Se=O(pe[F],be),Qe=O(pe[F],re)),We){be=pe[F],re=pe[F+2],Se=O(pe[F+1],be),Qe=O(pe[F+1],re),k.push(Se),k.push(re.clone()),k.push(be.clone()),k.push(re.clone()),k.push(Se.clone()),k.push(Qe);break}Ce&&(be=pe[F],re=pe[F+1],Se=O(pe[F+2],be),Qe=O(pe[F+2],re)),be&&re&&Se&&Qe&&(k.push(be.clone()),k.push(re.clone()),k.push(Se),k.push(Qe),k.push(Se.clone()),k.push(re.clone()));break;case 2:k=k??new Array,ge||(be=pe[F].clone(),re=O(be,pe[F+1]),Se=O(be,pe[F+2]),k.push(be),k.push(re),k.push(Se)),We||(be=pe[F+1].clone(),re=O(be,pe[F+2]),Se=O(be,pe[F]),k.push(be),k.push(re),k.push(Se)),Ce||(be=pe[F+2].clone(),re=O(be,pe[F]),Se=O(be,pe[F+1]),k.push(be),k.push(re),k.push(Se));break;case 3:break}}return k},ie=e instanceof A?e:null,ce=ie?._thinInstanceDataStorage.matrixData,Q=ie?.thinInstanceCount||1,de=U.Matrix[0];de.copyFrom(V.IdentityReadOnly);for(let pe=0;pe<Q;++pe){if(ie?.hasThinInstances&&ce){let F=pe*16;de.setRowFromFloats(0,ce[F+0],ce[F+1],ce[F+2],ce[F+3]),de.setRowFromFloats(1,ce[F+4],ce[F+5],ce[F+6],ce[F+7]),de.setRowFromFloats(2,ce[F+8],ce[F+9],ce[F+10],ce[F+11]),de.setRowFromFloats(3,ce[F+12],ce[F+13],ce[F+14],ce[F+15])}let ve=V.RotationYawPitchRoll(I,x,E).multiply(V.Translation(_.x,_.y,_.z)),$=V.Invert(ve),j=e.getWorldMatrix(),O=de.multiply(j).multiply($),k=new Array(3);for(let F=0;F<o.length;F+=3){let q=k;if(q[0]=M(F,O),q[1]=M(F+1,O),q[2]=M(F+2,O),!(t.cullBackFaces&&-q[0].normal.z<=0&&-q[1].normal.z<=0&&-q[2].normal.z<=0)&&(q=W(q,zk),!!q&&(q=W(q,Hk),!!q&&(q=W(q,$k),!!q&&(q=W(q,Wk),!!q&&(q=W(q,jk),!!q&&(q=W(q,qk),!!q)))))))for(let be=0;be<q.length;be++){let re=q[be];if(b.indices.push(D),s?(re.localPositionOverride?(b.positions[D*3]=re.localPositionOverride[0],b.positions[D*3+1]=re.localPositionOverride[1],b.positions[D*3+2]=re.localPositionOverride[2]):c&&(b.positions[D*3]=c[re.vertexIdx],b.positions[D*3+1]=c[re.vertexIdx+1],b.positions[D*3+2]=c[re.vertexIdx+2]),re.localNormalOverride?(b.normals[D*3]=re.localNormalOverride[0],b.normals[D*3+1]=re.localNormalOverride[1],b.normals[D*3+2]=re.localNormalOverride[2]):u&&(b.normals[D*3]=u[re.vertexIdx],b.normals[D*3+1]=u[re.vertexIdx+1],b.normals[D*3+2]=u[re.vertexIdx+2])):(re.position.toArray(b.positions,D*3),re.normal.toArray(b.normals,D*3)),b.matricesIndices&&b.matricesWeights&&(re.matrixIndicesOverride?(b.matricesIndices[D*4]=re.matrixIndicesOverride[0],b.matricesIndices[D*4+1]=re.matrixIndicesOverride[1],b.matricesIndices[D*4+2]=re.matrixIndicesOverride[2],b.matricesIndices[D*4+3]=re.matrixIndicesOverride[3]):(d&&(b.matricesIndices[D*4]=d[re.vertexIdxForBones],b.matricesIndices[D*4+1]=d[re.vertexIdxForBones+1],b.matricesIndices[D*4+2]=d[re.vertexIdxForBones+2],b.matricesIndices[D*4+3]=d[re.vertexIdxForBones+3]),p&&b.matricesIndicesExtra&&(b.matricesIndicesExtra[D*4]=p[re.vertexIdxForBones],b.matricesIndicesExtra[D*4+1]=p[re.vertexIdxForBones+1],b.matricesIndicesExtra[D*4+2]=p[re.vertexIdxForBones+2],b.matricesIndicesExtra[D*4+3]=p[re.vertexIdxForBones+3])),re.matrixWeightsOverride?(b.matricesWeights[D*4]=re.matrixWeightsOverride[0],b.matricesWeights[D*4+1]=re.matrixWeightsOverride[1],b.matricesWeights[D*4+2]=re.matrixWeightsOverride[2],b.matricesWeights[D*4+3]=re.matrixWeightsOverride[3]):(f&&(b.matricesWeights[D*4]=f[re.vertexIdxForBones],b.matricesWeights[D*4+1]=f[re.vertexIdxForBones+1],b.matricesWeights[D*4+2]=f[re.vertexIdxForBones+2],b.matricesWeights[D*4+3]=f[re.vertexIdxForBones+3]),g&&b.matricesWeightsExtra&&(b.matricesWeightsExtra[D*4]=g[re.vertexIdxForBones],b.matricesWeightsExtra[D*4+1]=g[re.vertexIdxForBones+1],b.matricesWeightsExtra[D*4+2]=g[re.vertexIdxForBones+2],b.matricesWeightsExtra[D*4+3]=g[re.vertexIdxForBones+3]))),t.captureUVS)re.uv.toArray(b.uvs,D*2);else{b.uvs.push(.5+re.position.x/C.x);let Se=.5+re.position.y/C.y;b.uvs.push(we?1-Se:Se)}D++}}}b.indices.length===0&&(b.indices=null),b.positions.length===0&&(b.positions=null),b.normals.length===0&&(b.normals=null),b.uvs.length===0&&(b.uvs=null),b.matricesIndices?.length===0&&(b.matricesIndices=null),b.matricesWeights?.length===0&&(b.matricesWeights=null),b.matricesIndicesExtra?.length===0&&(b.matricesIndicesExtra=null),b.matricesWeightsExtra?.length===0&&(b.matricesWeightsExtra=null);let oe=new A(i,e.getScene());return b.applyToMesh(oe),s?(oe.skeleton=e.skeleton,oe.parent=e):(oe.position=_.clone(),oe.rotation=new m(x,I,E)),oe.computeWorldMatrix(!0),oe.refreshBoundingInfo(!0,!0),oe}A.CreateDecal=(i,e,t,n,r,s)=>cC(i,e,{position:t,normal:n,size:r,angle:s});function sM(i={subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){let e=Math.max(i.subdivisions?i.subdivisions:2,1)|0,t=Math.max(i.tessellation?i.tessellation:16,3)|0,n=Math.max(i.height?i.height:1,0),r=Math.max(i.radius?i.radius:.25,0),s=Math.max(i.capSubdivisions?i.capSubdivisions:6,1)|0,o=t,a=e,l=Math.max(i.radiusTop?i.radiusTop:r,0),c=Math.max(i.radiusBottom?i.radiusBottom:r,0),u=n-(l+c),h=0,d=2*Math.PI,f=Math.max(i.topCapSubdivisions?i.topCapSubdivisions:s,1),p=Math.max(i.bottomCapSubdivisions?i.bottomCapSubdivisions:s,1),g=Math.acos((c-l)/n),_=[],y=[],C=[],E=[],I=0,v=[],x=u*.5,b=Math.PI*.5,D,M,R=m.Zero(),W=m.Zero(),ie=Math.cos(g),ce=Math.sin(g),Q=new _e(l*ce,x+l*ie).subtract(new _e(c*ce,-x+c*ie)).length(),de=l*g+Q+c*(b-g),oe=0;for(M=0;M<=f;M++){let j=[],O=b-g*(M/f);oe+=l*g/f;let k=Math.cos(O),F=Math.sin(O),q=k*l;for(D=0;D<=o;D++){let be=D/o,re=be*d+h,Se=Math.sin(re),Qe=Math.cos(re);W.x=q*Se,W.y=x+F*l,W.z=q*Qe,y.push(W.x,W.y,W.z),R.set(k*Se,F,k*Qe),C.push(R.x,R.y,R.z),E.push(be,we?oe/de:1-oe/de),j.push(I),I++}v.push(j)}let pe=n-l-c+ie*l-ie*c,ve=ce*(c-l)/pe;for(M=1;M<=a;M++){let j=[];oe+=Q/a;let O=ce*(M*(c-l)/a+l);for(D=0;D<=o;D++){let k=D/o,F=k*d+h,q=Math.sin(F),be=Math.cos(F);W.x=O*q,W.y=x+ie*l-M*pe/a,W.z=O*be,y.push(W.x,W.y,W.z),R.set(q,ve,be).normalize(),C.push(R.x,R.y,R.z),E.push(k,we?oe/de:1-oe/de),j.push(I),I++}v.push(j)}for(M=1;M<=p;M++){let j=[],O=b-g-(Math.PI-g)*(M/p);oe+=c*g/p;let k=Math.cos(O),F=Math.sin(O),q=k*c;for(D=0;D<=o;D++){let be=D/o,re=be*d+h,Se=Math.sin(re),Qe=Math.cos(re);W.x=q*Se,W.y=-x+F*c,W.z=q*Qe,y.push(W.x,W.y,W.z),R.set(k*Se,F,k*Qe),C.push(R.x,R.y,R.z),E.push(be,we?oe/de:1-oe/de),j.push(I),I++}v.push(j)}for(D=0;D<o;D++)for(M=0;M<f+a+p;M++){let j=v[M][D],O=v[M+1][D],k=v[M+1][D+1],F=v[M][D+1];_.push(j),_.push(O),_.push(F),_.push(O),_.push(k),_.push(F)}if(_=_.reverse(),i.orientation&&!i.orientation.equals(m.Up())){let j=new V;i.orientation.clone().scale(Math.PI*.5).cross(m.Up()).toQuaternion().toRotationMatrix(j);let O=m.Zero();for(let k=0;k<y.length;k+=3)O.set(y[k],y[k+1],y[k+2]),m.TransformCoordinatesToRef(O.clone(),j,O),y[k]=O.x,y[k+1]=O.y,y[k+2]=O.z}let $=new X;return $.positions=y,$.normals=C,$.uvs=E,$.indices=_,$}function uC(i,e={orientation:m.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6,updatable:!1},t=null){let n=new A(i,t);return sM(e).applyToMesh(n,e.updatable),n}A.CreateCapsule=(i,e,t)=>uC(i,e,t);X.CreateCapsule=sM;var _t=class i{constructor(e=0,t=0){this.x=e,this.y=t,e!==Math.floor(e)&&(e=Math.floor(e),N.Warn("x is not an integer, floor(x) used")),t!==Math.floor(t)&&(t=Math.floor(t),N.Warn("y is not an integer, floor(y) used"))}clone(){return new i(this.x,this.y)}rotate60About(e){let t=this.x;return this.x=e.x+e.y-this.y,this.y=t+this.y-e.x,this}rotateNeg60About(e){let t=this.x;return this.x=t+this.y-e.y,this.y=e.x+e.y-t,this}rotate120(e,t){e!==Math.floor(e)&&(e=Math.floor(e),N.Warn("m not an integer only floor(m) used")),t!==Math.floor(t)&&(t=Math.floor(t),N.Warn("n not an integer only floor(n) used"));let n=this.x;return this.x=e-n-this.y,this.y=t+n,this}rotateNeg120(e,t){e!==Math.floor(e)&&(e=Math.floor(e),N.Warn("m is not an integer, floor(m) used")),t!==Math.floor(t)&&(t=Math.floor(t),N.Warn("n is not an integer,   floor(n) used"));let n=this.x;return this.x=this.y-t,this.y=e+t-n-this.y,this}toCartesianOrigin(e,t){let n=m.Zero();return n.x=e.x+2*this.x*t+this.y*t,n.y=e.y+Math.sqrt(3)*this.y*t,n}static Zero(){return new i(0,0)}};var Fl=class{constructor(){this.cartesian=[],this.vertices=[],this.max=[],this.min=[],this.closestTo=[],this.innerFacets=[],this.isoVecsABOB=[],this.isoVecsOBOA=[],this.isoVecsBAOA=[],this.vertexTypes=[],this.IDATA=new $u("icosahedron","Regular",[[0,wt,-1],[-wt,1,0],[-1,0,-wt],[1,0,-wt],[wt,1,0],[0,wt,1],[-1,0,wt],[-wt,-1,0],[0,-wt,-1],[wt,-1,0],[1,0,wt],[0,-wt,1]],[[0,2,1],[0,3,2],[0,4,3],[0,5,4],[0,1,5],[7,6,1],[8,7,2],[9,8,3],[10,9,4],[6,10,5],[2,7,1],[3,8,2],[4,9,3],[5,10,4],[1,6,5],[11,6,7],[11,7,8],[11,8,9],[11,9,10],[11,10,6]])}setIndices(){let e=12,t={},n=this.m,r=this.n,s=n,o=1,a=0;r!==0&&(s=_g(n,r)),o=n/s,a=r/s;let l,c,u,h,d,f=_t.Zero(),p=new _t(n,r),g=new _t(-r,n+r),_=_t.Zero(),y=_t.Zero(),C=_t.Zero(),E=[],I,v,x,b,D=[],M=this.vertByDist,R=(W,ie,ce,Q)=>{I=W+"|"+ce,v=ie+"|"+Q,I in t||v in t?I in t&&!(v in t)?t[v]=t[I]:v in t&&!(I in t)&&(t[I]=t[v]):(t[I]=e,t[v]=e,e++),M[ce][0]>2?D[t[I]]=[-M[ce][0],M[ce][1],t[I]]:D[t[I]]=[E[M[ce][0]],M[ce][1],t[I]]};this.IDATA.edgematch=[[1,"B"],[2,"B"],[3,"B"],[4,"B"],[0,"B"],[10,"O",14,"A"],[11,"O",10,"A"],[12,"O",11,"A"],[13,"O",12,"A"],[14,"O",13,"A"],[0,"O"],[1,"O"],[2,"O"],[3,"O"],[4,"O"],[19,"B",5,"A"],[15,"B",6,"A"],[16,"B",7,"A"],[17,"B",8,"A"],[18,"B",9,"A"]];for(let W=0;W<20;W++){if(E=this.IDATA.face[W],u=E[2],h=E[1],d=E[0],x=f.x+"|"+f.y,I=W+"|"+x,I in t||(t[I]=u,D[u]=[E[M[x][0]],M[x][1]]),x=p.x+"|"+p.y,I=W+"|"+x,I in t||(t[I]=h,D[h]=[E[M[x][0]],M[x][1]]),x=g.x+"|"+g.y,I=W+"|"+x,I in t||(t[I]=d,D[d]=[E[M[x][0]],M[x][1]]),l=this.IDATA.edgematch[W][0],c=this.IDATA.edgematch[W][1],c==="B")for(let ie=1;ie<s;ie++)y.x=n-ie*(o+a),y.y=r+ie*o,C.x=-ie*a,C.y=ie*(o+a),x=y.x+"|"+y.y,b=C.x+"|"+C.y,R(W,l,x,b);if(c==="O")for(let ie=1;ie<s;ie++)C.x=-ie*a,C.y=ie*(o+a),_.x=ie*o,_.y=ie*a,x=C.x+"|"+C.y,b=_.x+"|"+_.y,R(W,l,x,b);if(l=this.IDATA.edgematch[W][2],c=this.IDATA.edgematch[W][3],c&&c==="A")for(let ie=1;ie<s;ie++)_.x=ie*o,_.y=ie*a,y.x=n-(s-ie)*(o+a),y.y=r+(s-ie)*o,x=_.x+"|"+_.y,b=y.x+"|"+y.y,R(W,l,x,b);for(let ie=0;ie<this.vertices.length;ie++)x=this.vertices[ie].x+"|"+this.vertices[ie].y,I=W+"|"+x,I in t||(t[I]=e++,M[x][0]>2?D[t[I]]=[-M[x][0],M[x][1],t[I]]:D[t[I]]=[E[M[x][0]],M[x][1],t[I]])}this.closestTo=D,this.vecToidx=t}calcCoeffs(){let e=this.m,t=this.n,n=Math.sqrt(3)/3,r=e*e+t*t+e*t;this.coau=(e+t)/r,this.cobu=-t/r,this.coav=-n*(e-t)/r,this.cobv=n*(2*e+t)/r}createInnerFacets(){let e=this.m,t=this.n;for(let n=0;n<t+e+1;n++)for(let r=this.min[n];r<this.max[n]+1;r++)r<this.max[n]&&r<this.max[n+1]+1&&this.innerFacets.push(["|"+r+"|"+n,"|"+r+"|"+(n+1),"|"+(r+1)+"|"+n]),n>0&&r<this.max[n-1]&&r+1<this.max[n]+1&&this.innerFacets.push(["|"+r+"|"+n,"|"+(r+1)+"|"+n,"|"+(r+1)+"|"+(n-1)])}edgeVecsABOB(){let e=this.m,t=this.n,n=new _t(-t,e+t);for(let r=1;r<e+t;r++){let s=new _t(this.min[r],r),o=new _t(this.min[r-1],r-1),a=new _t(this.min[r+1],r+1),l=s.clone(),c=o.clone(),u=a.clone();l.rotate60About(n),c.rotate60About(n),u.rotate60About(n);let h=new _t(this.max[l.y],l.y),d=new _t(this.max[l.y-1],l.y-1),f=new _t(this.max[l.y-1]-1,l.y-1);(l.x!==h.x||l.y!==h.y)&&(l.x!==d.x?(this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,d,f]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,f,h])):l.y===u.y?(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([s,o,d]),this.vertexTypes.push([1,0,1]),this.isoVecsABOB.push([s,d,a])):(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([s,o,d]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,d,h])))}}mapABOBtoOBOA(){let e=new _t(0,0);for(let t=0;t<this.isoVecsABOB.length;t++){let n=[];for(let r=0;r<3;r++)e.x=this.isoVecsABOB[t][r].x,e.y=this.isoVecsABOB[t][r].y,this.vertexTypes[t][r]===0&&e.rotateNeg120(this.m,this.n),n.push(e.clone());this.isoVecsOBOA.push(n)}}mapABOBtoBAOA(){let e=new _t(0,0);for(let t=0;t<this.isoVecsABOB.length;t++){let n=[];for(let r=0;r<3;r++)e.x=this.isoVecsABOB[t][r].x,e.y=this.isoVecsABOB[t][r].y,this.vertexTypes[t][r]===1&&e.rotate120(this.m,this.n),n.push(e.clone());this.isoVecsBAOA.push(n)}}MapToFace(e,t){let n=this.IDATA.face[e],r=n[2],s=n[1],o=n[0],a=m.FromArray(this.IDATA.vertex[r]),l=m.FromArray(this.IDATA.vertex[s]),c=m.FromArray(this.IDATA.vertex[o]),u=l.subtract(a),h=c.subtract(a),d=u.scale(this.coau).add(h.scale(this.cobu)),f=u.scale(this.coav).add(h.scale(this.cobv)),p=[],g,_=U.Vector3[0];for(let y=0;y<this.cartesian.length;y++)_=d.scale(this.cartesian[y].x).add(f.scale(this.cartesian[y].y)).add(a),p[y]=[_.x,_.y,_.z],g=e+"|"+this.vertices[y].x+"|"+this.vertices[y].y,t.vertex[this.vecToidx[g]]=[_.x,_.y,_.z]}build(e,t){let n=[],r=_t.Zero(),s=new _t(e,t),o=new _t(-t,e+t);n.push(r,s,o);for(let v=t;v<e+1;v++)for(let x=0;x<e+1-v;x++)n.push(new _t(x,v));if(t>0){let v=_g(e,t),x=e/v,b=t/v;for(let M=1;M<v;M++)n.push(new _t(M*x,M*b)),n.push(new _t(-M*b,M*(x+b))),n.push(new _t(e-M*(x+b),t+M*x));let D=e/t;for(let M=1;M<t;M++)for(let R=0;R<M*D;R++)n.push(new _t(R,M)),n.push(new _t(R,M).rotate120(e,t)),n.push(new _t(R,M).rotateNeg120(e,t))}n.sort((v,x)=>v.x-x.x),n.sort((v,x)=>v.y-x.y);let a=new Array(e+t+1),l=new Array(e+t+1);for(let v=0;v<a.length;v++)a[v]=1/0,l[v]=-1/0;let c=0,u=0,h=n.length;for(let v=0;v<h;v++)u=n[v].x,c=n[v].y,a[c]=Math.min(u,a[c]),l[c]=Math.max(u,l[c]);let d=(v,x)=>{let b=v.clone();return x==="A"&&b.rotateNeg120(e,t),x==="B"&&b.rotate120(e,t),b.x<0?b.y:b.x+b.y},f=[],p=[],g=[],_=[],y={},C=[],E=-1,I=-1;for(let v=0;v<h;v++)f[v]=n[v].toCartesianOrigin(new _t(0,0),.5),p[v]=d(n[v],"O"),g[v]=d(n[v],"A"),_[v]=d(n[v],"B"),p[v]===g[v]&&g[v]===_[v]?(E=3,I=p[v]):p[v]===g[v]?(E=4,I=p[v]):g[v]===_[v]?(E=5,I=g[v]):_[v]===p[v]&&(E=6,I=p[v]),p[v]<g[v]&&p[v]<_[v]&&(E=2,I=p[v]),g[v]<p[v]&&g[v]<_[v]&&(E=1,I=g[v]),_[v]<g[v]&&_[v]<p[v]&&(E=0,I=_[v]),C.push([E,I,n[v].x,n[v].y]);C.sort((v,x)=>v[2]-x[2]),C.sort((v,x)=>v[3]-x[3]),C.sort((v,x)=>v[1]-x[1]),C.sort((v,x)=>v[0]-x[0]);for(let v=0;v<C.length;v++)y[C[v][2]+"|"+C[v][3]]=[C[v][0],C[v][1],v];return this.m=e,this.n=t,this.vertices=n,this.vertByDist=y,this.cartesian=f,this.min=a,this.max=l,this}},$u=class{constructor(e,t,n,r){this.name=e,this.category=t,this.vertex=n,this.face=r}},kl=class i extends $u{innerToData(e,t){for(let n=0;n<t.innerFacets.length;n++)this.face.push(t.innerFacets[n].map(r=>t.vecToidx[e+r]))}mapABOBtoDATA(e,t){let n=t.IDATA.edgematch[e][0];for(let r=0;r<t.isoVecsABOB.length;r++){let s=[];for(let o=0;o<3;o++)t.vertexTypes[r][o]===0?s.push(e+"|"+t.isoVecsABOB[r][o].x+"|"+t.isoVecsABOB[r][o].y):s.push(n+"|"+t.isoVecsABOB[r][o].x+"|"+t.isoVecsABOB[r][o].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}mapOBOAtoDATA(e,t){let n=t.IDATA.edgematch[e][0];for(let r=0;r<t.isoVecsOBOA.length;r++){let s=[];for(let o=0;o<3;o++)t.vertexTypes[r][o]===1?s.push(e+"|"+t.isoVecsOBOA[r][o].x+"|"+t.isoVecsOBOA[r][o].y):s.push(n+"|"+t.isoVecsOBOA[r][o].x+"|"+t.isoVecsOBOA[r][o].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}mapBAOAtoDATA(e,t){let n=t.IDATA.edgematch[e][2];for(let r=0;r<t.isoVecsBAOA.length;r++){let s=[];for(let o=0;o<3;o++)t.vertexTypes[r][o]===1?s.push(e+"|"+t.isoVecsBAOA[r][o].x+"|"+t.isoVecsBAOA[r][o].y):s.push(n+"|"+t.isoVecsBAOA[r][o].x+"|"+t.isoVecsBAOA[r][o].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}orderData(e){let t=[];for(let o=0;o<13;o++)t[o]=[];let n=e.closestTo;for(let o=0;o<n.length;o++)n[o][0]>-1?n[o][1]>0&&t[n[o][0]].push([o,n[o][1]]):t[12].push([o,n[o][0]]);let r=[];for(let o=0;o<12;o++)r[o]=o;let s=12;for(let o=0;o<12;o++){t[o].sort((a,l)=>a[1]-l[1]);for(let a=0;a<t[o].length;a++)r[t[o][a][0]]=s++}for(let o=0;o<t[12].length;o++)r[t[12][o][0]]=s++;for(let o=0;o<this.vertex.length;o++)this.vertex[o].push(r[o]);this.vertex.sort((o,a)=>o[3]-a[3]);for(let o=0;o<this.vertex.length;o++)this.vertex[o].pop();for(let o=0;o<this.face.length;o++)for(let a=0;a<this.face[o].length;a++)this.face[o][a]=r[this.face[o][a]];this.sharedNodes=t[12].length,this.poleNodes=this.vertex.length-this.sharedNodes}setOrder(e,t){let n=[],r=[],s=t.pop();r.push(s);let o=this.face[s].indexOf(e);o=(o+2)%3;let a=this.face[s][o];n.push(a);let l=0;for(;t.length>0;)s=t[l],this.face[s].indexOf(a)>-1?(o=(this.face[s].indexOf(a)+1)%3,a=this.face[s][o],n.push(a),r.push(s),t.splice(l,1),l=0):l++;return this.adjacentFaces.push(n),r}toGoldbergPolyhedronData(){let e=new $u("GeoDual","Goldberg",[],[]);e.name="GD dual";let t=this.vertex.length,n=new Array(t);for(let c=0;c<t;c++)n[c]=[];for(let c=0;c<this.face.length;c++)for(let u=0;u<3;u++)n[this.face[c][u]].push(c);let r=0,s=0,o=0,a=[],l=[];this.adjacentFaces=[];for(let c=0;c<n.length;c++){e.face[c]=this.setOrder(c,n[c].concat([]));for(let u of n[c]){r=0,s=0,o=0,a=this.face[u];for(let h=0;h<3;h++)l=this.vertex[a[h]],r+=l[0],s+=l[1],o+=l[2];e.vertex[u]=[r/3,s/3,o/3]}}return e}static BuildGeodesicData(e){let t=new i("Geodesic-m-n","Geodesic",[[0,wt,-1],[-wt,1,0],[-1,0,-wt],[1,0,-wt],[wt,1,0],[0,wt,1],[-1,0,wt],[-wt,-1,0],[0,-wt,-1],[wt,-1,0],[1,0,wt],[0,-wt,1]],[]);e.setIndices(),e.calcCoeffs(),e.createInnerFacets(),e.edgeVecsABOB(),e.mapABOBtoOBOA(),e.mapABOBtoBAOA();for(let r=0;r<e.IDATA.face.length;r++)e.MapToFace(r,t),t.innerToData(r,e),e.IDATA.edgematch[r][1]==="B"&&t.mapABOBtoDATA(r,e),e.IDATA.edgematch[r][1]==="O"&&t.mapOBOAtoDATA(r,e),e.IDATA.edgematch[r][3]==="A"&&t.mapBAOAtoDATA(r,e);t.orderData(e);let n=1;return t.vertex=t.vertex.map(function(r){let s=r[0],o=r[1],a=r[2],l=Math.sqrt(s*s+o*o+a*a);return r[0]*=n/l,r[1]*=n/l,r[2]*=n/l,r}),t}};function oM(i,e,t=null){let n=e.m||1;n!==Math.floor(n)&&(n=Math.floor(n),N.Warn("m not an integer only floor(m) used"));let r=e.n||0;if(r!==Math.floor(r)&&(r=Math.floor(r),N.Warn("n not an integer only floor(n) used")),r>n){let c=r;r=n,n=c,N.Warn("n > m therefore m and n swapped")}let s=new Fl;s.build(n,r);let a={custom:kl.BuildGeodesicData(s),size:e.size,sizeX:e.sizeX,sizeY:e.sizeY,sizeZ:e.sizeZ,faceUV:e.faceUV,faceColors:e.faceColors,flat:e.flat,updatable:e.updatable,sideOrientation:e.sideOrientation,frontUVs:e.frontUVs,backUVs:e.backUVs};return Hu(i,a,t)}A._GoldbergMeshParser=(i,e)=>Wu.Parse(i,e);var Wu=class i extends A{constructor(){super(...arguments),this.goldbergData={faceColors:[],faceCenters:[],faceZaxis:[],faceXaxis:[],faceYaxis:[],nbSharedFaces:0,nbUnsharedFaces:0,nbFaces:0,nbFacesAtPole:0,adjacentFaces:[]}}relatedGoldbergFace(e,t){return t===void 0?(e>this.goldbergData.nbUnsharedFaces-1&&(N.Warn("Maximum number of unshared faces used"),e=this.goldbergData.nbUnsharedFaces-1),this.goldbergData.nbUnsharedFaces+e):(e>11&&(N.Warn("Last pole used"),e=11),t>this.goldbergData.nbFacesAtPole-1&&(N.Warn("Maximum number of faces at a pole used"),t=this.goldbergData.nbFacesAtPole-1),12+e*this.goldbergData.nbFacesAtPole+t)}_changeGoldbergFaceColors(e){for(let n=0;n<e.length;n++){let r=e[n][0],s=e[n][1],o=e[n][2];for(let a=r;a<s+1;a++)this.goldbergData.faceColors[a]=o}let t=[];for(let n=0;n<12;n++)for(let r=0;r<5;r++)t.push(this.goldbergData.faceColors[n].r,this.goldbergData.faceColors[n].g,this.goldbergData.faceColors[n].b,this.goldbergData.faceColors[n].a);for(let n=12;n<this.goldbergData.faceColors.length;n++)for(let r=0;r<6;r++)t.push(this.goldbergData.faceColors[n].r,this.goldbergData.faceColors[n].g,this.goldbergData.faceColors[n].b,this.goldbergData.faceColors[n].a);return t}setGoldbergFaceColors(e){let t=this._changeGoldbergFaceColors(e);this.setVerticesData(S.ColorKind,t)}updateGoldbergFaceColors(e){let t=this._changeGoldbergFaceColors(e);this.updateVerticesData(S.ColorKind,t)}_changeGoldbergFaceUVs(e){let t=this.getVerticesData(S.UVKind);for(let n=0;n<e.length;n++){let r=e[n][0],s=e[n][1],o=e[n][2],a=e[n][3],l=e[n][4],c=[],u=[],h,d;for(let f=0;f<5;f++)h=o.x+a*Math.cos(l+f*Math.PI/2.5),d=o.y+a*Math.sin(l+f*Math.PI/2.5),h<0&&(h=0),h>1&&(h=1),c.push(h,d);for(let f=0;f<6;f++)h=o.x+a*Math.cos(l+f*Math.PI/3),d=o.y+a*Math.sin(l+f*Math.PI/3),h<0&&(h=0),h>1&&(h=1),u.push(h,d);for(let f=r;f<Math.min(12,s+1);f++)for(let p=0;p<5;p++)t[10*f+2*p]=c[2*p],t[10*f+2*p+1]=c[2*p+1];for(let f=Math.max(12,r);f<s+1;f++)for(let p=0;p<6;p++)t[12*f-24+2*p]=u[2*p],t[12*f-23+2*p]=u[2*p+1]}return t}setGoldbergFaceUVs(e){let t=this._changeGoldbergFaceUVs(e);this.setVerticesData(S.UVKind,t)}updateGoldbergFaceUVs(e){let t=this._changeGoldbergFaceUVs(e);this.updateVerticesData(S.UVKind,t)}placeOnGoldbergFaceAt(e,t,n){let r=m.RotationFromAxis(this.goldbergData.faceXaxis[t],this.goldbergData.faceYaxis[t],this.goldbergData.faceZaxis[t]);e.rotation=r,e.position=this.goldbergData.faceCenters[t].add(this.goldbergData.faceXaxis[t].scale(n.x)).add(this.goldbergData.faceYaxis[t].scale(n.y)).add(this.goldbergData.faceZaxis[t].scale(n.z))}serialize(e){super.serialize(e),e.type="GoldbergMesh";let t={};if(t.adjacentFaces=this.goldbergData.adjacentFaces,t.nbSharedFaces=this.goldbergData.nbSharedFaces,t.nbUnsharedFaces=this.goldbergData.nbUnsharedFaces,t.nbFaces=this.goldbergData.nbFaces,t.nbFacesAtPole=this.goldbergData.nbFacesAtPole,this.goldbergData.faceColors){t.faceColors=[];for(let n of this.goldbergData.faceColors)t.faceColors.push(n.asArray())}if(this.goldbergData.faceCenters){t.faceCenters=[];for(let n of this.goldbergData.faceCenters)t.faceCenters.push(n.asArray())}if(this.goldbergData.faceZaxis){t.faceZaxis=[];for(let n of this.goldbergData.faceZaxis)t.faceZaxis.push(n.asArray())}if(this.goldbergData.faceYaxis){t.faceYaxis=[];for(let n of this.goldbergData.faceYaxis)t.faceYaxis.push(n.asArray())}if(this.goldbergData.faceXaxis){t.faceXaxis=[];for(let n of this.goldbergData.faceXaxis)t.faceXaxis.push(n.asArray())}e.goldbergData=t}static Parse(e,t){let n=e.goldbergData;n.faceColors=n.faceColors.map(s=>le.FromArray(s)),n.faceCenters=n.faceCenters.map(s=>m.FromArray(s)),n.faceZaxis=n.faceZaxis.map(s=>m.FromArray(s)),n.faceXaxis=n.faceXaxis.map(s=>m.FromArray(s)),n.faceYaxis=n.faceYaxis.map(s=>m.FromArray(s));let r=new i(e.name,t);return r.goldbergData=n,r}};function Yk(i,e){let t=i.size,n=i.sizeX||t||1,r=i.sizeY||t||1,s=i.sizeZ||t||1,o=i.sideOrientation===0?0:i.sideOrientation||X.DEFAULTSIDE,a=[],l=[],c=[],u=[],h=1/0,d=-1/0,f=1/0,p=-1/0;for(let y=0;y<e.vertex.length;y++)h=Math.min(h,e.vertex[y][0]*n),d=Math.max(d,e.vertex[y][0]*n),f=Math.min(f,e.vertex[y][1]*r),p=Math.max(p,e.vertex[y][1]*r);let g=0;for(let y=0;y<e.face.length;y++){let C=e.face[y],E=m.FromArray(e.vertex[C[0]]),I=m.FromArray(e.vertex[C[2]]),v=m.FromArray(e.vertex[C[1]]),x=I.subtract(E),b=v.subtract(E),D=m.Cross(b,x).normalize();for(let M=0;M<C.length;M++){c.push(D.x,D.y,D.z);let R=e.vertex[C[M]];a.push(R[0]*n,R[1]*r,R[2]*s);let W=(R[1]*r-f)/(p-f);u.push((R[0]*n-h)/(d-h),we?1-W:W)}for(let M=0;M<C.length-2;M++)l.push(g,g+M+2,g+M+1);g+=C.length}X._ComputeSides(o,a,l,c,u);let _=new X;return _.positions=a,_.indices=l,_.normals=c,_.uvs=u,_}function aM(i,e,t=null){let n=e.size,r=e.sizeX||n||1,s=e.sizeY||n||1,o=e.sizeZ||n||1,a=e.m||1;a!==Math.floor(a)&&(a=Math.floor(a),N.Warn("m not an integer only floor(m) used"));let l=e.n||0;if(l!==Math.floor(l)&&(l=Math.floor(l),N.Warn("n not an integer only floor(n) used")),l>a){let p=l;l=a,a=p,N.Warn("n > m therefore m and n swapped")}let c=new Fl;c.build(a,l);let u=kl.BuildGeodesicData(c),h=u.toGoldbergPolyhedronData(),d=new Wu(i,t);e.sideOrientation=A._GetDefaultSideOrientation(e.sideOrientation),d._originalBuilderSideOrientation=e.sideOrientation,Yk(e,h).applyToMesh(d,e.updatable),d.goldbergData.nbSharedFaces=u.sharedNodes,d.goldbergData.nbUnsharedFaces=u.poleNodes,d.goldbergData.adjacentFaces=u.adjacentFaces,d.goldbergData.nbFaces=d.goldbergData.nbSharedFaces+d.goldbergData.nbUnsharedFaces,d.goldbergData.nbFacesAtPole=(d.goldbergData.nbUnsharedFaces-12)/12;for(let p=0;p<u.vertex.length;p++)d.goldbergData.faceCenters.push(m.FromArray(u.vertex[p])),d.goldbergData.faceCenters[p].x*=r,d.goldbergData.faceCenters[p].y*=s,d.goldbergData.faceCenters[p].z*=o,d.goldbergData.faceColors.push(new le(1,1,1,1));for(let p=0;p<h.face.length;p++){let g=h.face[p],_=m.FromArray(h.vertex[g[0]]),y=m.FromArray(h.vertex[g[2]]),C=m.FromArray(h.vertex[g[1]]),E=y.subtract(_),I=C.subtract(_),v=m.Cross(I,E).normalize(),x=m.Cross(I,v).normalize();d.goldbergData.faceXaxis.push(I.normalize()),d.goldbergData.faceYaxis.push(v),d.goldbergData.faceZaxis.push(x)}return d}var hC=class{constructor(e){this._paths=[],this._tempPaths=[],this._holes=[],this._resolution=e}moveTo(e,t){this._currentPath=new dh(e,t),this._tempPaths.push(this._currentPath)}lineTo(e,t){this._currentPath.addLineTo(e,t)}quadraticCurveTo(e,t,n,r){this._currentPath.addQuadraticCurveTo(e,t,n,r,this._resolution)}bezierCurveTo(e,t,n,r,s,o){this._currentPath.addBezierCurveTo(e,t,n,r,s,o,this._resolution)}extractHoles(){for(let e of this._tempPaths)e.area()>0?this._holes.push(e):this._paths.push(e);if(!this._paths.length&&this._holes.length){let e=this._holes;this._holes=this._paths,this._paths=e}this._tempPaths.length=0}get paths(){return this._paths}get holes(){return this._holes}};function Kk(i,e,t,n,r,s){let o=s.glyphs[i]||s.glyphs["?"];if(!o)return null;let a=new hC(r);if(o.o){let l=o.o.split(" ");for(let c=0,u=l.length;c<u;)switch(l[c++]){case"m":{let d=parseInt(l[c++])*e+t,f=parseInt(l[c++])*e+n;a.moveTo(d,f);break}case"l":{let d=parseInt(l[c++])*e+t,f=parseInt(l[c++])*e+n;a.lineTo(d,f);break}case"q":{let d=parseInt(l[c++])*e+t,f=parseInt(l[c++])*e+n,p=parseInt(l[c++])*e+t,g=parseInt(l[c++])*e+n;a.quadraticCurveTo(p,g,d,f);break}case"b":{let d=parseInt(l[c++])*e+t,f=parseInt(l[c++])*e+n,p=parseInt(l[c++])*e+t,g=parseInt(l[c++])*e+n,_=parseInt(l[c++])*e+t,y=parseInt(l[c++])*e+n;a.bezierCurveTo(p,g,_,y,d,f);break}}}return a.extractHoles(),{offsetX:o.ha*e,shapePath:a}}function Xk(i,e,t,n){let r=Array.from(i),s=e/n.resolution,o=(n.boundingBox.yMax-n.boundingBox.yMin+n.underlineThickness)*s,a=[],l=0,c=0;for(let u=0;u<r.length;u++){let h=r[u];if(h===`
`)l=0,c-=o;else{let d=Kk(h,s,l,c,t,n);d&&(l+=d.offsetX,a.push(d.shapePath))}}return a}function lM(i,e,t,n={size:50,resolution:8,depth:1},r=null,s=earcut){let o=Xk(e,n.size||50,n.resolution||8,t),a=[],l=0;for(let u of o){if(!u.paths.length)continue;let h=u.holes.slice();for(let d of u.paths){let f=[],p=[],g=d.getPoints();for(let C of g)p.push(new m(C.x,0,C.y));let _=h.slice();for(let C of _){let E=C.getPoints(),I=!1;for(let x of E)if(d.isPointInside(x)){I=!0;break}if(!I)continue;let v=[];for(let x of E)v.push(new m(x.x,0,x.y));f.push(v),h.splice(h.indexOf(C),1)}if(!f.length&&h.length)for(let C of h){let E=C.getPoints(),I=[];for(let v of E)I.push(new m(v.x,0,v.y));f.push(I)}let y=Uu(i,{shape:p,holes:f.length?f:void 0,depth:n.depth||1,faceUV:n.faceUV||n.perLetterFaceUV?.(l),faceColors:n.faceColors||n.perLetterFaceColors?.(l),sideOrientation:A._GetDefaultSideOrientation(n.sideOrientation||A.DOUBLESIDE)},r,s);a.push(y),l++}}let c=A.MergeMeshes(a,!0,!0);if(c){let u=c.getBoundingInfo().boundingBox;c.position.x+=-(u.minimumWorld.x+u.maximumWorld.x)/2,c.position.y+=-(u.minimumWorld.y+u.maximumWorld.y)/2,c.position.z+=-(u.minimumWorld.z+u.maximumWorld.z)/2+u.extendSize.z,c.name=i;let h=new ln("pivot",r);h.rotation.x=-Math.PI/2,c.parent=h,c.bakeCurrentTransformIntoVertices(),c.parent=null,h.dispose()}return c}var gn={CreateBox:Ko,CreateTiledBox:qw,CreateSphere:js,CreateDisc:Kx,CreateIcoSphere:Ll,CreateRibbon:cr,CreateCylinder:Xo,CreateTorus:ur,CreateTorusKnot:eC,CreateLineSystem:nC,CreateLines:Vu,CreateDashedLines:iC,ExtrudeShape:sC,ExtrudeShapeCustom:oC,CreateLathe:aC,CreateTiledPlane:Ww,CreatePlane:zu,CreateGround:Yo,CreateTiledGround:Zx,CreateGroundFromHeightMap:Qx,CreatePolygon:Sm,ExtrudePolygon:Uu,CreateTube:lC,CreatePolyhedron:Hu,CreateGeodesic:oM,CreateGoldberg:aM,CreateDecal:cC,CreateCapsule:uC,CreateText:lM};var cM=class i{_cache=new Map;_inFlightRequests=new Map;get(e){return this._cache.get(e)}getSize(){return this._cache.size}set(e,t){let n=Date.now();this._cache.set(e,{data:t,timestamp:n,lastAccessed:n})}delete(e){this._cache.delete(e)}has(e){return this._cache.has(e)}getInFlightRequest(e){return this._inFlightRequests.get(e)}setInFlightRequest(e,t){this._inFlightRequests.set(e,t)}deleteInFlightRequest(e){this._inFlightRequests.delete(e)}evictCache(e=1){Array.from(this._cache.entries()).sort((n,r)=>n[1].lastAccessed-r[1].lastAccessed).slice(0,e).forEach(([n])=>this._cache.delete(n))}static \u0275fac=function(t){return new(t||i)};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})};var Em=class{constructor(){this._zoomStopsAnimation=!1,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this.targetAlpha=null,this._isPointerDown=!1,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0}get name(){return"AutoRotation"}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set idleRotationSpeed(e){this._idleRotationSpeed=e}get idleRotationSpeed(){return this._idleRotationSpeed}set idleRotationWaitTime(e){this._idleRotationWaitTime=e}get idleRotationWaitTime(){return this._idleRotationWaitTime}set idleRotationSpinupTime(e){this._idleRotationSpinupTime=e}get idleRotationSpinupTime(){return this._idleRotationSpinupTime}get rotationInProgress(){return Math.abs(this._cameraRotationSpeed)>0}init(){}attach(e){this._attachedCamera=e;let t=this._attachedCamera.getScene();this._onPrePointerObservableObserver=t.onPrePointerObservable.add(n=>{if(n.type===Ae.POINTERDOWN){this._isPointerDown=!0;return}n.type===Ae.POINTERUP&&(this._isPointerDown=!1)}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{if(this._reachTargetAlpha())return;let n=Zi.Now,r=0;this._lastFrameTime!=null&&(r=n-this._lastFrameTime),this._lastFrameTime=n,this._applyUserInteraction();let s=n-this._lastInteractionTime-this._idleRotationWaitTime,o=Math.max(Math.min(s/this._idleRotationSpinupTime,1),0);this._cameraRotationSpeed=this._idleRotationSpeed*o,this._attachedCamera&&(this._attachedCamera.alpha-=this._cameraRotationSpeed*(r/1e3))})}detach(){if(!this._attachedCamera)return;let e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null,this._lastFrameTime=null}resetLastInteractionTime(e){this._lastInteractionTime=e??Zi.Now}_reachTargetAlpha(){return this._attachedCamera&&this.targetAlpha?Math.abs(this._attachedCamera.alpha-this.targetAlpha)<Pt:!1}_userIsZooming(){return this._attachedCamera?this._attachedCamera.inertialRadiusOffset!==0:!1}_shouldAnimationStopForInteraction(){if(!this._attachedCamera)return!1;let e=!1;return this._lastFrameRadius===this._attachedCamera.radius&&this._attachedCamera.inertialRadiusOffset!==0&&(e=!0),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?e:this._userIsZooming()}_applyUserInteraction(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=Zi.Now)}_userIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}};var Bl=class i{constructor(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=!1,this._radiusIsAnimating=!1,this._radiusBounceTransition=null,this._animatables=new Array}get name(){return"Bouncing"}get autoTransitionRange(){return this._autoTransitionRange}set autoTransitionRange(e){if(this._autoTransitionRange===e)return;this._autoTransitionRange=e;let t=this._attachedCamera;t&&(e?this._onMeshTargetChangedObserver=t.onMeshTargetChangedObservable.add(n=>{if(n&&(n.computeWorldMatrix(!0),n.getBoundingInfo)){let r=n.getBoundingInfo().diagonalLength;this.lowerRadiusTransitionRange=r*.05,this.upperRadiusTransitionRange=r*.05}}):this._onMeshTargetChangedObserver&&t.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver))}init(){}attach(e){this._attachedCamera=e,this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._attachedCamera&&(this._isRadiusAtLimit(this._attachedCamera.lowerRadiusLimit)&&this._applyBoundRadiusAnimation(this.lowerRadiusTransitionRange),this._isRadiusAtLimit(this._attachedCamera.upperRadiusLimit)&&this._applyBoundRadiusAnimation(this.upperRadiusTransitionRange))})}detach(){this._attachedCamera&&(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null)}_isRadiusAtLimit(e){return this._attachedCamera?this._attachedCamera.radius===e&&!this._radiusIsAnimating:!1}_applyBoundRadiusAnimation(e){if(!this._attachedCamera)return;this._radiusBounceTransition||(i.EasingFunction.setEasingMode(i.EasingMode),this._radiusBounceTransition=H.CreateAnimation("radius",H.ANIMATIONTYPE_FLOAT,60,i.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=!0;let t=H.TransitionTo("radius",this._attachedCamera.radius+e,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,()=>this._clearAnimationLocks());t&&this._animatables.push(t)}_clearAnimationLocks(){this._radiusIsAnimating=!1,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision)}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift()}};Bl.EasingFunction=new KT(.3);Bl.EasingMode=ni.EASINGMODE_EASEOUT;var qs=class i{constructor(){this.onTargetFramingAnimationEndObservable=new B,this._mode=i.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=!1,this._framingTime=1500,this.autoCorrectCameraLimitsAndSensibility=!0,this._isPointerDown=!1,this._lastInteractionTime=-1/0,this._animatables=new Array,this._betaIsAnimating=!1}get name(){return"Framing"}set mode(e){this._mode=e}get mode(){return this._mode}set radiusScale(e){this._radiusScale=e}get radiusScale(){return this._radiusScale}set positionScale(e){this._positionScale=e}get positionScale(){return this._positionScale}set defaultElevation(e){this._defaultElevation=e}get defaultElevation(){return this._defaultElevation}set elevationReturnTime(e){this._elevationReturnTime=e}get elevationReturnTime(){return this._elevationReturnTime}set elevationReturnWaitTime(e){this._elevationReturnWaitTime=e}get elevationReturnWaitTime(){return this._elevationReturnWaitTime}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set framingTime(e){this._framingTime=e}get framingTime(){return this._framingTime}init(){}attach(e){this._attachedCamera=e;let t=this._attachedCamera.getScene();i.EasingFunction.setEasingMode(i.EasingMode),this._onPrePointerObservableObserver=t.onPrePointerObservable.add(n=>{if(n.type===Ae.POINTERDOWN){this._isPointerDown=!0;return}n.type===Ae.POINTERUP&&(this._isPointerDown=!1)}),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add(n=>{n&&n.getBoundingInfo&&this.zoomOnMesh(n,void 0,()=>{this.onTargetFramingAnimationEndObservable.notifyObservers()})}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._applyUserInteraction(),this._maintainCameraAboveGround()})}detach(){if(!this._attachedCamera)return;let e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null}zoomOnMesh(e,t=!1,n=null){e.computeWorldMatrix(!0);let r=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(r.minimumWorld,r.maximumWorld,t,n)}zoomOnMeshHierarchy(e,t=!1,n=null){e.computeWorldMatrix(!0);let r=e.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(r.min,r.max,t,n)}zoomOnMeshesHierarchy(e,t=!1,n=null){let r=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let o=0;o<e.length;o++){let a=e[o].getHierarchyBoundingVectors(!0);m.CheckExtends(a.min,r,s),m.CheckExtends(a.max,r,s)}this.zoomOnBoundingInfo(r,s,t,n)}zoomOnBoundingInfo(e,t,n=!1,r=null){let s;if(!this._attachedCamera)return!1;let o=e.y,a=t.y,l=o+(a-o)*this._positionScale,c=t.subtract(e).scale(.5);if(!isFinite(l))return!1;if(n)s=new m(0,l,0);else{let d=e.add(c);s=new m(d.x,l,d.z)}this._vectorTransition||(this._vectorTransition=H.CreateAnimation("target",H.ANIMATIONTYPE_VECTOR3,60,i.EasingFunction)),this._betaIsAnimating=!0;let u=H.TransitionTo("target",s,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);u&&this._animatables.push(u);let h=0;if(this._mode===i.FitFrustumSidesMode){let d=this._calculateLowerRadiusFromModelBoundingSphere(e,t);this.autoCorrectCameraLimitsAndSensibility&&(this._attachedCamera.lowerRadiusLimit=c.length()+this._attachedCamera.minZ),h=d}else this._mode===i.IgnoreBoundsSizeMode&&(h=this._calculateLowerRadiusFromModelBoundingSphere(e,t),this.autoCorrectCameraLimitsAndSensibility&&this._attachedCamera.lowerRadiusLimit===null&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));if(this.autoCorrectCameraLimitsAndSensibility){let d=t.subtract(e).length();this._attachedCamera.panningSensibility=5e3/d,this._attachedCamera.wheelPrecision=100/h}return this._radiusTransition||(this._radiusTransition=H.CreateAnimation("radius",H.ANIMATIONTYPE_FLOAT,60,i.EasingFunction)),u=H.TransitionTo("radius",h,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,()=>{this.stopAllAnimations(),r&&r(),this._attachedCamera&&this._attachedCamera.useInputToRestoreState&&this._attachedCamera.storeState()}),u&&this._animatables.push(u),!0}_calculateLowerRadiusFromModelBoundingSphere(e,t){let n=this._attachedCamera;if(!n)return 0;let r=n._calculateLowerRadiusFromModelBoundingSphere(e,t,this._radiusScale);return n.lowerRadiusLimit&&this._mode===i.IgnoreBoundsSizeMode&&(r=r<n.lowerRadiusLimit?n.lowerRadiusLimit:r),n.upperRadiusLimit&&(r=r>n.upperRadiusLimit?n.upperRadiusLimit:r),r}_maintainCameraAboveGround(){if(this._elevationReturnTime<0)return;let e=Zi.Now-this._lastInteractionTime,t=Math.PI*.5-this._defaultElevation,n=Math.PI*.5;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>n&&e>=this._elevationReturnWaitTime){this._betaIsAnimating=!0,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=H.CreateAnimation("beta",H.ANIMATIONTYPE_FLOAT,60,i.EasingFunction));let r=H.TransitionTo("beta",t,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,()=>{this._clearAnimationLocks(),this.stopAllAnimations()});r&&this._animatables.push(r)}}_clearAnimationLocks(){this._betaIsAnimating=!1}_applyUserInteraction(){this.isUserIsMoving&&(this._lastInteractionTime=Zi.Now,this.stopAllAnimations(),this._clearAnimationLocks())}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift()}get isUserIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}};qs.EasingFunction=new XT;qs.EasingMode=ni.EASINGMODE_EASEINOUT;qs.IgnoreBoundsSizeMode=0;qs.FitFrustumSidesMode=1;var ju=class{constructor(){this._currentMousePointerIdDown=-1,this.buttons=[0,1,2]}attachControl(e){e=z.BackCompatCameraNoPreventDefault(arguments);let t=this.camera.getEngine(),n=t.getInputElement(),r=0,s=null;this._pointA=null,this._pointB=null,this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._pointerInput=a=>{let l=a.event,c=l.pointerType==="touch";if(a.type!==Ae.POINTERMOVE&&this.buttons.indexOf(l.button)===-1)return;let u=l.target;if(this._altKey=l.altKey,this._ctrlKey=l.ctrlKey,this._metaKey=l.metaKey,this._shiftKey=l.shiftKey,this._buttonsPressed=l.buttons,t.isPointerLock){let h=l.movementX,d=l.movementY;this.onTouch(null,h,d),this._pointA=null,this._pointB=null}else{if(a.type!==Ae.POINTERDOWN&&a.type!==Ae.POINTERDOUBLETAP&&c&&this._pointA?.pointerId!==l.pointerId&&this._pointB?.pointerId!==l.pointerId)return;if(a.type===Ae.POINTERDOWN&&(this._currentMousePointerIdDown===-1||c)){try{u?.setPointerCapture(l.pointerId)}catch{}if(this._pointA===null)this._pointA={x:l.clientX,y:l.clientY,pointerId:l.pointerId,type:l.pointerType,button:l.button};else if(this._pointB===null)this._pointB={x:l.clientX,y:l.clientY,pointerId:l.pointerId,type:l.pointerType,button:l.button};else return;this._currentMousePointerIdDown===-1&&!c&&(this._currentMousePointerIdDown=l.pointerId),this.onButtonDown(l),e||(l.preventDefault(),n&&n.focus())}else if(a.type===Ae.POINTERDOUBLETAP)this.onDoubleTap(l.pointerType);else if(a.type===Ae.POINTERUP&&(this._currentMousePointerIdDown===l.pointerId||c)){try{u?.releasePointerCapture(l.pointerId)}catch{}c||(this._pointB=null),t._badOS?this._pointA=this._pointB=null:this._pointB&&this._pointA&&this._pointA.pointerId==l.pointerId?(this._pointA=this._pointB,this._pointB=null):this._pointA&&this._pointB&&this._pointB.pointerId==l.pointerId?this._pointB=null:this._pointA=this._pointB=null,(r!==0||s)&&(this.onMultiTouch(this._pointA,this._pointB,r,0,s,null),r=0,s=null),this._currentMousePointerIdDown=-1,this.onButtonUp(l),e||l.preventDefault()}else if(a.type===Ae.POINTERMOVE){if(e||l.preventDefault(),this._pointA&&this._pointB===null){let h=l.clientX-this._pointA.x,d=l.clientY-this._pointA.y;this._pointA.x=l.clientX,this._pointA.y=l.clientY,this.onTouch(this._pointA,h,d)}else if(this._pointA&&this._pointB){let h=this._pointA.pointerId===l.pointerId?this._pointA:this._pointB;h.x=l.clientX,h.y=l.clientY;let d=this._pointA.x-this._pointB.x,f=this._pointA.y-this._pointB.y,p=d*d+f*f,g={x:(this._pointA.x+this._pointB.x)/2,y:(this._pointA.y+this._pointB.y)/2,pointerId:l.pointerId,type:a.type};this.onMultiTouch(this._pointA,this._pointB,r,p,s,g),s=g,r=p}}}},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Ae.POINTERDOWN|Ae.POINTERUP|Ae.POINTERMOVE|Ae.POINTERDOUBLETAP),this._onLostFocus=()=>{this._pointA=this._pointB=null,r=0,s=null,this.onLostFocus()},this._contextMenuBind=a=>this.onContextMenu(a),n&&n.addEventListener("contextmenu",this._contextMenuBind,!1);let o=this.camera.getScene().getEngine().getHostWindow();o&&z.RegisterTopRootEvents(o,[{name:"blur",handler:this._onLostFocus}])}detachControl(){if(this._onLostFocus){let e=this.camera.getScene().getEngine().getHostWindow();e&&z.UnregisterTopRootEvents(e,[{name:"blur",handler:this._onLostFocus}])}if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._contextMenuBind){let e=this.camera.getScene().getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this._onLostFocus=null}this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._currentMousePointerIdDown=-1}getClassName(){return"BaseCameraPointersInput"}getSimpleName(){return"pointers"}onDoubleTap(e){}onTouch(e,t,n){}onMultiTouch(e,t,n,r,s,o){}onContextMenu(e){e.preventDefault()}onButtonDown(e){}onButtonUp(e){}onLostFocus(){}};w([L()],ju.prototype,"buttons",void 0);var Zo=class extends ju{constructor(){super(...arguments),this.pinchZoom=!0,this.multiTouchPanning=!0,this.multiTouchPanAndZoom=!0,this._isPinching=!1,this._twoFingerActivityCount=0,this._shouldStartPinchZoom=!1}_computePinchZoom(e,t){}_computeMultiTouchPanning(e,t){}onMultiTouch(e,t,n,r,s,o){n===0&&s===null||r===0&&o===null||(this.multiTouchPanAndZoom?(this._computePinchZoom(n,r),this._computeMultiTouchPanning(s,o)):this.multiTouchPanning&&this.pinchZoom?(this._twoFingerActivityCount++,this._isPinching||this._shouldStartPinchZoom?(this._computePinchZoom(n,r),this._isPinching=!0):this._computeMultiTouchPanning(s,o)):this.multiTouchPanning?this._computeMultiTouchPanning(s,o):this.pinchZoom&&this._computePinchZoom(n,r))}onButtonUp(e){this._twoFingerActivityCount=0,this._isPinching=!1}onLostFocus(){this._twoFingerActivityCount=0,this._isPinching=!1}};w([L()],Zo.prototype,"pinchZoom",void 0);w([L()],Zo.prototype,"multiTouchPanning",void 0);w([L()],Zo.prototype,"multiTouchPanAndZoom",void 0);var Di=class i extends Zo{constructor(){super(...arguments),this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.useNaturalPinchZoom=!1,this.panningSensibility=1e3,this.pinchInwards=!0,this._isPanClick=!1}getClassName(){return"ArcRotateCameraPointersInput"}_computeMultiTouchPanning(e,t){if(this.panningSensibility!==0&&e&&t){let n=t.x-e.x,r=t.y-e.y;this.camera.inertialPanningX+=-n/this.panningSensibility,this.camera.inertialPanningY+=r/this.panningSensibility}}_computePinchZoom(e,t){let n=this.camera.radius||i.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=n*Math.sqrt(e)/Math.sqrt(t):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=(t-e)*.001*n*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(t-e)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}onTouch(e,t,n){this.panningSensibility!==0&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)?(this.camera.inertialPanningX+=-t/this.panningSensibility,this.camera.inertialPanningY+=n/this.panningSensibility):(this.camera.inertialAlphaOffset-=t/this.angularSensibilityX,this.camera.inertialBetaOffset-=n/this.angularSensibilityY)}onDoubleTap(){this.camera.useInputToRestoreState&&this.camera.restoreState()}onMultiTouch(e,t,n,r,s,o){this._shouldStartPinchZoom=this._twoFingerActivityCount<20&&Math.abs(Math.sqrt(r)-Math.sqrt(n))>this.camera.pinchToPanMaxDistance,super.onMultiTouch(e,t,n,r,s,o)}onButtonDown(e){this._isPanClick=e.button===this.camera._panningMouseButton,super.onButtonDown(e)}onButtonUp(e){super.onButtonUp(e)}onLostFocus(){this._isPanClick=!1,super.onLostFocus()}};Di.MinimumRadiusForPinch=.001;w([L()],Di.prototype,"buttons",void 0);w([L()],Di.prototype,"angularSensibilityX",void 0);w([L()],Di.prototype,"angularSensibilityY",void 0);w([L()],Di.prototype,"pinchPrecision",void 0);w([L()],Di.prototype,"pinchDeltaPercentage",void 0);w([L()],Di.prototype,"useNaturalPinchZoom",void 0);w([L()],Di.prototype,"panningSensibility",void 0);Lt.ArcRotateCameraPointersInput=Di;var hi=class{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0,this.angularSpeed=.01,this._keys=new Array}attachControl(e){e=z.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{let n=t.event;if(!n.metaKey){if(t.type===mh.KEYDOWN)this._ctrlPressed=n.ctrlKey,this._altPressed=n.altKey,(this.keysUp.indexOf(n.keyCode)!==-1||this.keysDown.indexOf(n.keyCode)!==-1||this.keysLeft.indexOf(n.keyCode)!==-1||this.keysRight.indexOf(n.keyCode)!==-1||this.keysReset.indexOf(n.keyCode)!==-1)&&(this._keys.indexOf(n.keyCode)===-1&&this._keys.push(n.keyCode),n.preventDefault&&(e||n.preventDefault()));else if(this.keysUp.indexOf(n.keyCode)!==-1||this.keysDown.indexOf(n.keyCode)!==-1||this.keysLeft.indexOf(n.keyCode)!==-1||this.keysRight.indexOf(n.keyCode)!==-1||this.keysReset.indexOf(n.keyCode)!==-1){let r=this._keys.indexOf(n.keyCode);r>=0&&this._keys.splice(r,1),n.preventDefault&&(e||n.preventDefault())}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){let e=this.camera;for(let t=0;t<this._keys.length;t++){let n=this._keys[t];this.keysLeft.indexOf(n)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX-=1/this.panningSensibility:e.inertialAlphaOffset-=this.angularSpeed:this.keysUp.indexOf(n)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset+=1/this.zoomingSensibility:e.inertialBetaOffset-=this.angularSpeed:this.keysRight.indexOf(n)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX+=1/this.panningSensibility:e.inertialAlphaOffset+=this.angularSpeed:this.keysDown.indexOf(n)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset-=1/this.zoomingSensibility:e.inertialBetaOffset+=this.angularSpeed:this.keysReset.indexOf(n)!==-1&&e.useInputToRestoreState&&e.restoreState()}}}getClassName(){return"ArcRotateCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}};w([L()],hi.prototype,"keysUp",void 0);w([L()],hi.prototype,"keysDown",void 0);w([L()],hi.prototype,"keysLeft",void 0);w([L()],hi.prototype,"keysRight",void 0);w([L()],hi.prototype,"keysReset",void 0);w([L()],hi.prototype,"panningSensibility",void 0);w([L()],hi.prototype,"zoomingSensibility",void 0);w([L()],hi.prototype,"useAltToZoom",void 0);w([L()],hi.prototype,"angularSpeed",void 0);Lt.ArcRotateCameraKeyboardMoveInput=hi;var Zk=40,Ys=class{constructor(){this.wheelPrecision=3,this.zoomToMouseLocation=!1,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this._viewOffset=new m(0,0,0),this._globalOffset=new m(0,0,0),this._inertialPanning=m.Zero()}_computeDeltaFromMouseWheelLegacyEvent(e,t){let n=0,r=e*.01*this.wheelDeltaPercentage*t;return e>0?n=r/(1+this.wheelDeltaPercentage):n=r*(1+this.wheelDeltaPercentage),n}attachControl(e){e=z.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Ae.POINTERWHEEL)return;let n=t.event,r=0,s=n.deltaMode===gh.DOM_DELTA_LINE?Zk:1,o=-(n.deltaY*s);if(this.customComputeDeltaFromMouseWheel)r=this.customComputeDeltaFromMouseWheel(o,this,n);else if(this.wheelDeltaPercentage){if(r=this._computeDeltaFromMouseWheelLegacyEvent(o,this.camera.radius),r>0){let a=this.camera.radius,l=this.camera.inertialRadiusOffset+r;for(let c=0;c<20&&!(a<=l||Math.abs(l*this.camera.inertia)<.001);c++)a-=l,l*=this.camera.inertia;a=Oi(a,0,Number.MAX_VALUE),r=this._computeDeltaFromMouseWheelLegacyEvent(o,a)}}else r=o/(this.wheelPrecision*40);r&&(this.zoomToMouseLocation?(this._hitPlane||this._updateHitPlane(),this._zoomToMouse(r)):this.camera.inertialRadiusOffset+=r),n.preventDefault&&(e||n.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Ae.POINTERWHEEL),this.zoomToMouseLocation&&this._inertialPanning.setAll(0)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}checkInputs(){if(!this.zoomToMouseLocation)return;let e=this.camera;0+e.inertialAlphaOffset+e.inertialBetaOffset+e.inertialRadiusOffset&&(this._updateHitPlane(),e.target.addInPlace(this._inertialPanning),this._inertialPanning.scaleInPlace(e.inertia),this._zeroIfClose(this._inertialPanning))}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}_updateHitPlane(){let e=this.camera,t=e.target.subtract(e.position);this._hitPlane=ya.FromPositionAndNormal(e.target,t)}_getPosition(){let e=this.camera,t=e.getScene(),n=t.createPickingRay(t.pointerX,t.pointerY,V.Identity(),e,!1);(e.targetScreenOffset.x!==0||e.targetScreenOffset.y!==0)&&(this._viewOffset.set(e.targetScreenOffset.x,e.targetScreenOffset.y,0),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),this._globalOffset=m.TransformNormal(this._viewOffset,e._cameraTransformMatrix),n.origin.addInPlace(this._globalOffset));let r=0;return this._hitPlane&&(r=n.intersectsPlane(this._hitPlane)??0),n.origin.addInPlace(n.direction.scaleInPlace(r))}_zoomToMouse(e){let t=this.camera,n=1-t.inertia;if(t.lowerRadiusLimit){let l=t.lowerRadiusLimit??0;t.radius-(t.inertialRadiusOffset+e)/n<l&&(e=(t.radius-l)*n-t.inertialRadiusOffset)}if(t.upperRadiusLimit){let l=t.upperRadiusLimit??0;t.radius-(t.inertialRadiusOffset+e)/n>l&&(e=(t.radius-l)*n-t.inertialRadiusOffset)}let s=e/n/t.radius,o=this._getPosition(),a=U.Vector3[6];o.subtractToRef(t.target,a),a.scaleInPlace(s),a.scaleInPlace(n),this._inertialPanning.addInPlace(a),t.inertialRadiusOffset+=e}_zeroIfClose(e){Math.abs(e.x)<Pt&&(e.x=0),Math.abs(e.y)<Pt&&(e.y=0),Math.abs(e.z)<Pt&&(e.z=0)}};w([L()],Ys.prototype,"wheelPrecision",void 0);w([L()],Ys.prototype,"zoomToMouseLocation",void 0);w([L()],Ys.prototype,"wheelDeltaPercentage",void 0);Lt.ArcRotateCameraMouseWheelInput=Ys;var Vl=class extends Ml{constructor(e){super(e)}addMouseWheel(){return this.add(new Ys),this}addPointers(){return this.add(new Di),this}addKeyboard(){return this.add(new hi),this}};kt.AddNodeConstructor("ArcRotateCamera",(i,e)=>()=>new Ze(i,0,0,1,m.Zero(),e));function Qk(i){let e=Math.PI/2;return i.x===0&&i.z===0||(e=Math.acos(i.x/Math.sqrt(Math.pow(i.x,2)+Math.pow(i.z,2)))),i.z<0&&(e=2*Math.PI-e),e}function Jk(i,e){return Math.acos(i/e)}function Ln(i,e){return isNaN(i)?e:i}var Ze=class i extends pn{get target(){return this._target}set target(e){this.setTarget(e)}get targetHost(){return this._targetHost}set targetHost(e){e&&this.setTarget(e)}getTarget(){return this.target}get position(){return this._position}set position(e){this.setPosition(e)}set upVector(e){this._upToYMatrix||(this._yToUpMatrix=new V,this._upToYMatrix=new V,this._upVector=m.Zero()),e.normalize(),this._upVector.copyFrom(e),this.setMatUp()}get upVector(){return this._upVector}setMatUp(){V.RotationAlignToRef(m.UpReadOnly,this._upVector,this._yToUpMatrix),V.RotationAlignToRef(this._upVector,m.UpReadOnly,this._upToYMatrix)}get angularSensibilityX(){let e=this.inputs.attached.pointers;return e?e.angularSensibilityX:0}set angularSensibilityX(e){let t=this.inputs.attached.pointers;t&&(t.angularSensibilityX=e)}get angularSensibilityY(){let e=this.inputs.attached.pointers;return e?e.angularSensibilityY:0}set angularSensibilityY(e){let t=this.inputs.attached.pointers;t&&(t.angularSensibilityY=e)}get pinchPrecision(){let e=this.inputs.attached.pointers;return e?e.pinchPrecision:0}set pinchPrecision(e){let t=this.inputs.attached.pointers;t&&(t.pinchPrecision=e)}get pinchDeltaPercentage(){let e=this.inputs.attached.pointers;return e?e.pinchDeltaPercentage:0}set pinchDeltaPercentage(e){let t=this.inputs.attached.pointers;t&&(t.pinchDeltaPercentage=e)}get useNaturalPinchZoom(){let e=this.inputs.attached.pointers;return e?e.useNaturalPinchZoom:!1}set useNaturalPinchZoom(e){let t=this.inputs.attached.pointers;t&&(t.useNaturalPinchZoom=e)}get panningSensibility(){let e=this.inputs.attached.pointers;return e?e.panningSensibility:0}set panningSensibility(e){let t=this.inputs.attached.pointers;t&&(t.panningSensibility=e)}get keysUp(){let e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){let t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){let e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){let t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){let e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){let t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){let e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){let t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get wheelPrecision(){let e=this.inputs.attached.mousewheel;return e?e.wheelPrecision:0}set wheelPrecision(e){let t=this.inputs.attached.mousewheel;t&&(t.wheelPrecision=e)}get zoomToMouseLocation(){let e=this.inputs.attached.mousewheel;return e?e.zoomToMouseLocation:!1}set zoomToMouseLocation(e){let t=this.inputs.attached.mousewheel;t&&(t.zoomToMouseLocation=e)}get wheelDeltaPercentage(){let e=this.inputs.attached.mousewheel;return e?e.wheelDeltaPercentage:0}set wheelDeltaPercentage(e){let t=this.inputs.attached.mousewheel;t&&(t.wheelDeltaPercentage=e)}get isInterpolating(){return this._isInterpolating}get bouncingBehavior(){return this._bouncingBehavior}get useBouncingBehavior(){return this._bouncingBehavior!=null}set useBouncingBehavior(e){e!==this.useBouncingBehavior&&(e?(this._bouncingBehavior=new Bl,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null))}get framingBehavior(){return this._framingBehavior}get useFramingBehavior(){return this._framingBehavior!=null}set useFramingBehavior(e){e!==this.useFramingBehavior&&(e?(this._framingBehavior=new qs,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null))}get autoRotationBehavior(){return this._autoRotationBehavior}get useAutoRotationBehavior(){return this._autoRotationBehavior!=null}set useAutoRotationBehavior(e){e!==this.useAutoRotationBehavior&&(e?(this._autoRotationBehavior=new Em,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null))}constructor(e,t,n,r,s,o,a=!0){super(e,m.Zero(),o,a),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI-.01,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.lowerTargetYLimit=-1/0,this.inertialPanningX=0,this.inertialPanningY=0,this.pinchToPanMaxDistance=20,this.panningDistanceLimit=null,this.panningOriginTarget=m.Zero(),this.panningInertia=.9,this.zoomOnFactor=1,this.targetScreenOffset=_e.Zero(),this.allowUpsideDown=!0,this.useInputToRestoreState=!0,this.restoreStateInterpolationFactor=0,this._currentInterpolationFactor=0,this._viewMatrix=new V,this.panningAxis=new m(1,1,0),this._transformedDirection=new m,this.mapPanning=!1,this._isInterpolating=!1,this.onMeshTargetChangedObservable=new B,this.checkCollisions=!1,this.collisionRadius=new m(.5,.5,.5),this._previousPosition=m.Zero(),this._collisionVelocity=m.Zero(),this._newPosition=m.Zero(),this._computationVector=m.Zero(),this._goalAlpha=NaN,this._goalBeta=NaN,this._goalRadius=NaN,this._goalTarget=new m(NaN,NaN,NaN),this._goalTargetScreenOffset=new _e(NaN,NaN),this._onCollisionPositionChange=(l,c,u=null)=>{u?(this.setPosition(c),this.onCollide&&this.onCollide(u)):this._previousPosition.copyFrom(this._position);let h=Math.cos(this.alpha),d=Math.sin(this.alpha),f=Math.cos(this.beta),p=Math.sin(this.beta);p===0&&(p=1e-4);let g=this._getTargetPosition();this._computationVector.copyFromFloats(this.radius*h*p,this.radius*f,this.radius*d*p),g.addToRef(this._computationVector,this._newPosition),this._position.copyFrom(this._newPosition);let _=this.upVector;this.allowUpsideDown&&this.beta<0&&(_=_.clone(),_=_.negate()),this._computeViewMatrix(this._position,g,_),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y),this._collisionTriggered=!1},this._target=m.Zero(),s&&this.setTarget(s),this.alpha=t,this.beta=n,this.radius=r,this.getViewMatrix(),this.inputs=new Vl(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_initCache(){super._initCache(),this._cache._target=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=_e.Zero()}_updateCache(e){e||super._updateCache(),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)}_getTargetPosition(){if(this._targetHost&&this._targetHost.getAbsolutePosition){let t=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?t.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(t)}let e=this._getLockedTargetPosition();return e||this._target}storeState(){return this._storedAlpha=this.alpha,this._storedBeta=this.beta,this._storedRadius=this.radius,this._storedTarget=this._getTargetPosition().clone(),this._storedTargetScreenOffset=this.targetScreenOffset.clone(),super.storeState()}_restoreStateValues(){return this.hasStateStored()&&this.restoreStateInterpolationFactor>Pt&&this.restoreStateInterpolationFactor<1?(this.interpolateTo(this._storedAlpha,this._storedBeta,this._storedRadius,this._storedTarget,this._storedTargetScreenOffset,this.restoreStateInterpolationFactor),!0):super._restoreStateValues()?(this.setTarget(this._storedTarget.clone()),this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.targetScreenOffset=this._storedTargetScreenOffset.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0):!1}stopInterpolation(){this._goalAlpha=NaN,this._goalBeta=NaN,this._goalRadius=NaN,this._goalTarget.set(NaN,NaN,NaN),this._goalTargetScreenOffset.set(NaN,NaN)}interpolateTo(e=this.alpha,t=this.beta,n=this.radius,r=this.target,s=this.targetScreenOffset,o){this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,o!=null?this._currentInterpolationFactor=o:this.restoreStateInterpolationFactor!==0?this._currentInterpolationFactor=this.restoreStateInterpolationFactor:this._currentInterpolationFactor=.1,this._goalAlpha=Ln(e,this._goalAlpha),this._goalBeta=Ln(t,this._goalBeta),this._goalRadius=Ln(n,this._goalRadius),this._goalTarget.set(Ln(r.x,this._goalTarget.x),Ln(r.y,this._goalTarget.y),Ln(r.z,this._goalTarget.z)),this._goalTargetScreenOffset.set(Ln(s.x,this._goalTargetScreenOffset.x),Ln(s.y,this._goalTargetScreenOffset.y)),this._goalAlpha=Oi(this._goalAlpha,this.lowerAlphaLimit??-1/0,this.upperAlphaLimit??1/0),this._goalBeta=Oi(this._goalBeta,this.lowerBetaLimit??-1/0,this.upperBetaLimit??1/0),this._goalRadius=Oi(this._goalRadius,this.lowerRadiusLimit??-1/0,this.upperRadiusLimit??1/0),this._goalTarget.y=Oi(this._goalTarget.y,this.lowerTargetYLimit??-1/0,1/0),this._isInterpolating=!0}_isSynchronizedViewMatrix(){return super._isSynchronizedViewMatrix()?this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset):!1}attachControl(e,t,n=!0,r=2){let s=arguments;t=z.BackCompatCameraNoPreventDefault(s),this._useCtrlForPanning=n,this._panningMouseButton=r,typeof s[0]=="boolean"&&(s.length>1&&(this._useCtrlForPanning=s[1]),s.length>2&&(this._panningMouseButton=s[2])),this.inputs.attachElement(t),this._reset=()=>{this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){if(this._collisionTriggered)return;this.inputs.checkInputs();let e=!1,t=this.speed*this._panningEpsilon,n=this.speed*this._rotationEpsilon;if(this.inertialAlphaOffset!==0||this.inertialBetaOffset!==0||this.inertialRadiusOffset!==0){e=!0;let r=this.invertRotation?-1:1,s=this._calculateHandednessMultiplier(),o=this.inertialAlphaOffset*s;this.beta<0&&(o*=-1),this.alpha+=o*r,this.beta+=this.inertialBetaOffset*r,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<n&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<n&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<n&&(this.inertialRadiusOffset=0)}if(this.inertialPanningX!==0||this.inertialPanningY!==0){e=!0;let r=new m(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);if(this._viewMatrix.invertToRef(this._cameraTransformMatrix),r.multiplyInPlace(this.panningAxis),m.TransformNormalToRef(r,this._cameraTransformMatrix,this._transformedDirection),this.mapPanning){let s=this.upVector,o=m.CrossToRef(this._transformedDirection,s,this._transformedDirection);m.CrossToRef(s,o,this._transformedDirection)}else this.panningAxis.y||(this._transformedDirection.y=0);if(!this._targetHost)if(this.panningDistanceLimit)this._transformedDirection.addInPlace(this._target),m.DistanceSquared(this._transformedDirection,this.panningOriginTarget)<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection);else{if(this.parent){let s=U.Matrix[0];this.parent.getWorldMatrix().getRotationMatrixToRef(s),s.transposeToRef(s),m.TransformCoordinatesToRef(this._transformedDirection,s,this._transformedDirection)}this._target.addInPlace(this._transformedDirection)}this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<t&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<t&&(this.inertialPanningY=0)}if(e)this.stopInterpolation();else if(this._isInterpolating){let r=!1,s=this._scene.getEngine().getDeltaTime()/1e3,o=1-Math.pow(2,-s/this._currentInterpolationFactor),a=Ln(this._goalRadius,this.radius);if(!isNaN(this._goalTarget.x)||!isNaN(this._goalTarget.y)||!isNaN(this._goalTarget.z)){let l=U.Vector3[0].set(Ln(this._goalTarget.x,this._target.x),Ln(this._goalTarget.y,this._target.y),Ln(this._goalTarget.z,this._target.z));m.LerpToRef(this.target,l,o,this._target),m.Distance(this.target,l)*10/a<Pt?(this._goalTarget.set(NaN,NaN,NaN),this.target.copyFrom(l),this.setTarget(this.target,!1,!0,!0)):r=!0}if(!isNaN(this._goalAlpha)||!isNaN(this._goalBeta)){let l=J.RotationAlphaBetaGammaToRef(Ln(this._goalAlpha,this.alpha),Ln(this._goalBeta,this.beta),0,U.Quaternion[0]),c=J.RotationAlphaBetaGammaToRef(this.alpha,this.beta,0,U.Quaternion[1]),u=J.SlerpToRef(c,l,o,U.Quaternion[2]);u.normalize();let h=u.toAlphaBetaGammaToRef(U.Vector3[0]);if(this.alpha=h.x,this.beta=h.y,u.isApprox(l,Pt/5)){this._goalAlpha=NaN,this._goalBeta=NaN;let d=l.toAlphaBetaGammaToRef(U.Vector3[0]);this.alpha=d.x,this.beta=d.y}else r=!0}if(isNaN(this._goalRadius)||(this.radius+=(a-this.radius)*o,Math.abs(a/this.radius-1)<Pt?(this._goalRadius=NaN,this.radius=a):r=!0),!isNaN(this._goalTargetScreenOffset.x)||!isNaN(this._goalTargetScreenOffset.y)){let l=U.Vector2[0].set(Ln(this._goalTargetScreenOffset.x,this.targetScreenOffset.x),Ln(this._goalTargetScreenOffset.y,this.targetScreenOffset.y));_e.LerpToRef(this.targetScreenOffset,l,o,this.targetScreenOffset),_e.Distance(this.targetScreenOffset,l)<Pt?(this._goalTargetScreenOffset.set(NaN,NaN),this.targetScreenOffset.copyFrom(l)):r=!0}this._isInterpolating=r}this._checkLimits(),super._checkInputs()}_checkLimits(){this.lowerBetaLimit===null||this.lowerBetaLimit===void 0?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),this.upperBetaLimit===null||this.upperBetaLimit===void 0?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),this.lowerAlphaLimit!==null&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),this.upperAlphaLimit!==null&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),this.lowerRadiusLimit!==null&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),this.upperRadiusLimit!==null&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0),this.target.y=Math.max(this.target.y,this.lowerTargetYLimit)}rebuildAnglesAndRadius(){this._position.subtractToRef(this._getTargetPosition(),this._computationVector),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&m.TransformCoordinatesToRef(this._computationVector,this._upToYMatrix,this._computationVector),this.radius=this._computationVector.length(),this.radius===0&&(this.radius=1e-4);let e=this.alpha;this.alpha=Qk(this._computationVector),this.beta=Jk(this._computationVector.y,this.radius);let t=Math.round((e-this.alpha)/(2*Math.PI));this.alpha+=t*2*Math.PI,this._checkLimits()}setPosition(e){this._position.equals(e)||(this._position.copyFrom(e),this.rebuildAnglesAndRadius())}setTarget(e,t=!1,n=!1,r=!1){if(r=this.overrideCloneAlphaBetaRadius??r,e.computeWorldMatrix)t&&e.getBoundingInfo?this._targetBoundingCenter=e.getBoundingInfo().boundingBox.centerWorld.clone():this._targetBoundingCenter=null,e.computeWorldMatrix(),this._targetHost=e,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else{let s=e,o=this._getTargetPosition();if(o&&!n&&o.equals(s))return;this._targetHost=null,this._target=s,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null)}r||this.rebuildAnglesAndRadius()}_getViewMatrix(){let e=Math.cos(this.alpha),t=Math.sin(this.alpha),n=Math.cos(this.beta),r=Math.sin(this.beta);r===0&&(r=1e-4),this.radius===0&&(this.radius=1e-4);let s=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*e*r,this.radius*n,this.radius*t*r),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&m.TransformCoordinatesToRef(this._computationVector,this._yToUpMatrix,this._computationVector),s.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions){let o=this.getScene().collisionCoordinator;this._collider||(this._collider=o.createCollider()),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this._position,this._collisionVelocity),this._collisionTriggered=!0,o.getNewPosition(this._position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this._position.copyFrom(this._newPosition);let o=this.upVector;this.allowUpsideDown&&r<0&&(o=o.negate()),this._computeViewMatrix(this._position,s,o),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y)}return this._currentTarget.copyFrom(s),this._viewMatrix}zoomOn(e,t=!1){e=e||this.getScene().meshes;let n=A.MinMax(e),r=this._calculateLowerRadiusFromModelBoundingSphere(n.min,n.max);if(r=Math.max(Math.min(r,this.upperRadiusLimit||Number.MAX_VALUE),this.lowerRadiusLimit||0),this.radius=r*this.zoomOnFactor,this.mode===Ne.ORTHOGRAPHIC_CAMERA){let s=this.getScene().getEngine().getAspectRatio(this),o=r*this.zoomOnFactor/2;this.orthoLeft=-o*s,this.orthoRight=o*s,this.orthoBottom=-o,this.orthoTop=o}this.focusOn({min:n.min,max:n.max,distance:r},t)}focusOn(e,t=!1){let n,r;if(e.min===void 0){let s=e||this.getScene().meshes;n=A.MinMax(s),r=m.Distance(n.min,n.max)}else{let s=e;n=s,r=s.distance}this._target=A.Center(n),t||(this.maxZ=r*2)}createRigCamera(e,t){let n=0;switch(this.cameraRigMode){case Ne.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ne.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ne.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ne.RIG_MODE_STEREOSCOPIC_INTERLACED:case Ne.RIG_MODE_VR:n=this._cameraRigParams.stereoHalfAngle*(t===0?1:-1);break;case Ne.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:n=this._cameraRigParams.stereoHalfAngle*(t===0?-1:1);break}let r=new i(e,this.alpha+n,this.beta,this.radius,this._target,this.getScene());return r._cameraRigParams={},r.isRigCamera=!0,r.rigParent=this,r.upVector=this.upVector,r.mode=this.mode,r.orthoLeft=this.orthoLeft,r.orthoRight=this.orthoRight,r.orthoBottom=this.orthoBottom,r.orthoTop=this.orthoTop,r}_updateRigCameras(){let e=this._rigCameras[0],t=this._rigCameras[1];switch(e.beta=t.beta=this.beta,this.cameraRigMode){case Ne.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ne.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ne.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ne.RIG_MODE_STEREOSCOPIC_INTERLACED:case Ne.RIG_MODE_VR:e.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case Ne.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle;break}super._updateRigCameras()}_calculateLowerRadiusFromModelBoundingSphere(e,t,n=1){let r=m.Distance(e,t),o=this.getScene().getEngine().getAspectRatio(this),a=Math.tan(this.fov/2),l=a*o,u=r*.5*n,h=u*Math.sqrt(1+1/(l*l)),d=u*Math.sqrt(1+1/(a*a));return Math.max(h,d)}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"ArcRotateCamera"}};w([L()],Ze.prototype,"alpha",void 0);w([L()],Ze.prototype,"beta",void 0);w([L()],Ze.prototype,"radius",void 0);w([L()],Ze.prototype,"overrideCloneAlphaBetaRadius",void 0);w([yn("target")],Ze.prototype,"_target",void 0);w([fh("targetHost")],Ze.prototype,"_targetHost",void 0);w([L()],Ze.prototype,"inertialAlphaOffset",void 0);w([L()],Ze.prototype,"inertialBetaOffset",void 0);w([L()],Ze.prototype,"inertialRadiusOffset",void 0);w([L()],Ze.prototype,"lowerAlphaLimit",void 0);w([L()],Ze.prototype,"upperAlphaLimit",void 0);w([L()],Ze.prototype,"lowerBetaLimit",void 0);w([L()],Ze.prototype,"upperBetaLimit",void 0);w([L()],Ze.prototype,"lowerRadiusLimit",void 0);w([L()],Ze.prototype,"upperRadiusLimit",void 0);w([L()],Ze.prototype,"lowerTargetYLimit",void 0);w([L()],Ze.prototype,"inertialPanningX",void 0);w([L()],Ze.prototype,"inertialPanningY",void 0);w([L()],Ze.prototype,"pinchToPanMaxDistance",void 0);w([L()],Ze.prototype,"panningDistanceLimit",void 0);w([yn()],Ze.prototype,"panningOriginTarget",void 0);w([L()],Ze.prototype,"panningInertia",void 0);w([L()],Ze.prototype,"zoomToMouseLocation",null);w([L()],Ze.prototype,"zoomOnFactor",void 0);w([uT()],Ze.prototype,"targetScreenOffset",void 0);w([L()],Ze.prototype,"allowUpsideDown",void 0);w([L()],Ze.prototype,"useInputToRestoreState",void 0);w([L()],Ze.prototype,"restoreStateInterpolationFactor",void 0);ue("BABYLON.ArcRotateCamera",Ze);Ws(Ge.NAME_SHADOWGENERATOR,(i,e)=>{if(i.shadowGenerators!==void 0&&i.shadowGenerators!==null)for(let t=0,n=i.shadowGenerators.length;t<n;t++){let r=i.shadowGenerators[t];r.className===Cg.CLASSNAME?Cg.Parse(r,e):bg.Parse(r,e)}});var dC=class{constructor(e){this.name=Ge.NAME_SHADOWGENERATOR,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(Ge.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)}rebuild(){}serialize(e){e.shadowGenerators=[];let t=this.scene.lights;for(let n of t){if(n.doNotSerialize)continue;let r=n.getShadowGenerators();if(r){let s=r.values();for(let o=s.next();o.done!==!0;o=s.next()){let a=o.value;a.doNotSerialize||e.shadowGenerators.push(a.serialize())}}}}addFromContainer(e){}removeFromContainer(e,t){}dispose(){}_gatherRenderTargets(e){let t=this.scene;if(this.scene.shadowsEnabled)for(let n=0;n<t.lights.length;n++){let r=t.lights[n],s=r.getShadowGenerators();if(r.isEnabled()&&r.shadowEnabled&&s){let o=s.values();for(let a=o.next();a.done!==!0;a=o.next()){let c=a.value.getShadowMap();t.textures.indexOf(c)!==-1&&e.push(c)}}}}};bg._SceneComponentInitialization=i=>{let e=i._getComponent(Ge.NAME_SHADOWGENERATOR);e||(e=new dC(i),i._addComponent(e))};var qu=class i extends Tn{set blurRatio(e){this._blurRatio!==e&&(this._blurRatio=e,this._preparePostProcesses())}get blurRatio(){return this._blurRatio}set adaptiveBlurKernel(e){this._adaptiveBlurKernel=e,this._autoComputeBlurKernel()}set blurKernel(e){this.blurKernelX=e,this.blurKernelY=e}set blurKernelX(e){this._blurKernelX!==e&&(this._blurKernelX=e,this._preparePostProcesses())}get blurKernelX(){return this._blurKernelX}set blurKernelY(e){this._blurKernelY!==e&&(this._blurKernelY=e,this._preparePostProcesses())}get blurKernelY(){return this._blurKernelY}_autoComputeBlurKernel(){let e=this.getScene().getEngine(),t=this.getRenderWidth()/e.getRenderWidth(),n=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*t,this.blurKernelY=this._adaptiveBlurKernel*n}resize(e){super.resize(e),this._adaptiveBlurKernel?this._autoComputeBlurKernel():this._preparePostProcesses()}_onRatioRescale(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()}_updateGammaSpace(){let e=this.getScene();e&&(this.gammaSpace=!e.imageProcessingConfiguration.isEnabled||!e.imageProcessingConfiguration.applyByPostProcess)}constructor(e,t,n,r,s=0,o=te.BILINEAR_SAMPLINGMODE,a=!0){if(super(e,t,n,r,!0,s,!1,o,a),this.mirrorPlane=new ya(0,1,0,1),this._transformMatrix=V.Zero(),this._mirrorMatrix=V.Zero(),this._adaptiveBlurKernel=0,this._blurKernelX=0,this._blurKernelY=0,this._blurRatio=1,n=this.getScene(),!n)return this;this.ignoreCameraViewport=!0,this._updateGammaSpace(),this._imageProcessingConfigChangeObserver=n.imageProcessingConfiguration.onUpdateParameters.add(()=>{this._updateGammaSpace()}),n.getEngine().supportsUniformBuffers&&(this._sceneUBO=n.createSceneUniformBuffer(`Scene for Mirror Texture (name "${e}")`));let c;this.onBeforeRenderObservable.add(()=>{this._sceneUBO&&(this._currentSceneUBO=n.getSceneUniformBuffer(),n.setSceneUniformBuffer(this._sceneUBO),n.getSceneUniformBuffer().unbindEffect()),V.ReflectionToRef(this.mirrorPlane,this._mirrorMatrix),this._mirrorMatrix.multiplyToRef(n.getViewMatrix(),this._transformMatrix),n.setTransformMatrix(this._transformMatrix,n.getProjectionMatrix()),c=n.clipPlane,n.clipPlane=this.mirrorPlane;let u=m.TransformCoordinates(n.activeCamera.globalPosition,this._mirrorMatrix);n._mirroredCameraPosition=u,n._forcedViewPosition=u}),this.onAfterRenderObservable.add(()=>{this._sceneUBO&&n.setSceneUniformBuffer(this._currentSceneUBO),n.updateTransformMatrix(),n._mirroredCameraPosition=null,n._forcedViewPosition=null,n.clipPlane=c})}_preparePostProcesses(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){let e=this.getScene().getEngine(),t=e.getCaps().textureFloatRender&&e.getCaps().textureFloatLinearFiltering?1:2;this._blurX=new bs("horizontal blur",new _e(1,0),this._blurKernelX,this._blurRatio,null,te.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurX.autoClear=!1,this._blurRatio===1&&this.samples<2&&this._texture?this._blurX.inputTexture=this._renderTarget:this._blurX.alwaysForcePOT=!0,this._blurY=new bs("vertical blur",new _e(0,1),this._blurKernelY,this._blurRatio,null,te.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=this._blurRatio!==1,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)}clone(){let e=this.getScene();if(!e)return this;let t=this.getSize(),n=new i(this.name,t.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return n.hasAlpha=this.hasAlpha,n.level=this.level,n.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(n.renderList=this.renderList.slice(0)),n}serialize(){if(!this.name)return null;let e=super.serialize();return e.mirrorPlane=this.mirrorPlane.asArray(),e}dispose(){super.dispose();let e=this.getScene();e&&e.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver),this._sceneUBO?.dispose()}};te._CreateMirror=(i,e,t,n)=>new qu(i,e,t,n);var fC=class extends Cs{},pC=class extends Ra(fC){constructor(){super(),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=!1,this.DIFFUSEHASALPHA=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONBLUR=!1,this.REFLECTIONFRESNEL=!1,this.REFLECTIONFALLOFF=!1,this.TEXTURELODSUPPORT=!1,this.PREMULTIPLYALPHA=!1,this.USERGBCOLOR=!1,this.USEHIGHLIGHTANDSHADOWCOLORS=!1,this.BACKMAT_SHADOWONLY=!1,this.NOISE=!1,this.REFLECTIONBGR=!1,this.PROJECTED_GROUND=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.EQUIRECTANGULAR_RELFECTION_FOV=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.UV1=!1,this.UV2=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.SHADOWFLOAT=!1,this.LOGARITHMICDEPTH=!1,this.NONUNIFORMSCALING=!1,this.ALPHATEST=!1,this.rebuild()}},mC=class extends Oa(_r){},ke=class i extends mC{get _perceptualColor(){return this.__perceptualColor}set _perceptualColor(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()}get primaryColorShadowLevel(){return this._primaryColorShadowLevel}set primaryColorShadowLevel(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}get primaryColorHighlightLevel(){return this._primaryColorHighlightLevel}set primaryColorHighlightLevel(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}set reflectionStandardFresnelWeight(e){let t=e;t<.5?(t=t*2,this.reflectionReflectance0=i.StandardReflectance0*t,this.reflectionReflectance90=i.StandardReflectance90*t):(t=t*2-1,this.reflectionReflectance0=i.StandardReflectance0+(1-i.StandardReflectance0)*t,this.reflectionReflectance90=i.StandardReflectance90+(1-i.StandardReflectance90)*t)}get fovMultiplier(){return this._fovMultiplier}set fovMultiplier(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))}constructor(e,t,n=!1){super(e,t,void 0,n),this.primaryColor=G.White(),this._primaryColorShadowLevel=0,this._primaryColorHighlightLevel=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this._shadowLights=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=m.Zero(),this.opacityFresnel=!0,this.reflectionFresnel=!1,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=!0,this.enableNoise=!1,this._fovMultiplier=1,this.useEquirectangularFOV=!1,this._maxSimultaneousLights=4,this.maxSimultaneousLights=4,this._shadowOnly=!1,this.shadowOnly=!1,this.switchToBGR=!1,this._enableGroundProjection=!1,this.enableGroundProjection=!1,this.projectedGroundRadius=1e3,this.projectedGroundHeight=10,this._renderTargets=new Ca(16),this._reflectionControls=ht.Zero(),this._white=G.White(),this._primaryShadowColor=G.Black(),this._primaryHighlightColor=G.Black(),this._shadersLoaded=!1,this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._renderTargets.push(this._diffuseTexture),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._renderTargets)}get hasRenderTargetTextures(){return!!(this._diffuseTexture&&this._diffuseTexture.isRenderTarget||this._reflectionTexture&&this._reflectionTexture.isRenderTarget)}needAlphaTesting(){return!0}needAlphaBlending(){return this.alpha<1||this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._shadowOnly}isReadyForSubMesh(e,t,n=!1){let r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===n)return!0;t.materialDefines||(t.materialDefines=new pC);let s=this.getScene(),o=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;let a=s.getEngine();if(Sh(s,e,o,!1,this._maxSimultaneousLights),o._needNormals=!0,Eh(s,o),o._areTexturesDirty){if(o._needUVs=!1,s.texturesEnabled){if(s.getEngine().getCaps().textureLOD&&(o.TEXTURELODSUPPORT=!0),this._diffuseTexture&&rt.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;pr(this._diffuseTexture,o,"DIFFUSE"),o.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,o.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,o.OPACITYFRESNEL=this._opacityFresnel}else o.DIFFUSE=!1,o.DIFFUSEDIRECTUV=0,o.DIFFUSEHASALPHA=!1,o.GAMMADIFFUSE=!1,o.OPACITYFRESNEL=!1;let l=this._reflectionTexture;if(Ih(s,l,o),l&&rt.ReflectionTextureEnabled){if(!l.isReadyOrNotBlocking())return!1;o.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,o.REFLECTIONBGR=this.switchToBGR,o.REFLECTIONBLUR=this._reflectionBlur>0,this.reflectionFresnel?(o.REFLECTIONFRESNEL=!0,o.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(o.REFLECTIONFRESNEL=!1,o.REFLECTIONFALLOFF=!1)}else o.REFLECTIONFRESNEL=!1,o.REFLECTIONFALLOFF=!1,o.REFLECTIONBLUR=!1}o.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,o.USERGBCOLOR=this._useRGBColor,o.NOISE=this._enableNoise}if(o._areLightsDirty&&(o.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(this._primaryColorShadowLevel!==0||this._primaryColorHighlightLevel!==0),o.BACKMAT_SHADOWONLY=this._shadowOnly),o._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(o)}if(o._areMiscDirty&&(o.REFLECTIONMAP_3D&&this._enableGroundProjection?(o.PROJECTED_GROUND=!0,o.REFLECTIONMAP_SKYBOX=!0):o.PROJECTED_GROUND=!1),Aa(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),o,void 0,void 0,void 0,this._isVertexOutputInvariant),wa(s,a,this,o,n,null,t.getRenderingMesh().hasThinInstances),Ma(e,o,!1,!0,!1)&&e&&!s.getEngine().getCaps().standardDerivatives&&!e.isVerticesDataPresent(S.NormalKind)&&(e.createNormals(!0),N.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name)),o.isDirty){o.markAsProcessed(),s.resetCachedMaterial();let l=new fr;o.FOG&&l.addFallback(0,"FOG"),o.POINTSIZE&&l.addFallback(1,"POINTSIZE"),o.MULTIVIEW&&l.addFallback(0,"MULTIVIEW"),Th(o,l,this._maxSimultaneousLights);let c=[S.PositionKind];o.NORMAL&&c.push(S.NormalKind),o.UV1&&c.push(S.UVKind),o.UV2&&c.push(S.UV2Kind),Ch(c,e,o,l),Ea(c,o);let u=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","mBones","vPrimaryColor","vPrimaryColorShadow","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix","projectedGroundInfos","logarithmicDepthConstant"];Zn(u);let h=["diffuseSampler"];wh(u,h,!1);let d=["Material","Scene"];gi&&(gi.PrepareUniforms(u,o),gi.PrepareSamplers(h,o)),Mh({uniformsNames:u,uniformBuffersNames:d,samplers:h,defines:o,maxSimultaneousLights:this._maxSimultaneousLights});let f=o.toString(),p=s.getEngine().createEffect("background",{attributes:c,uniformsNames:u,uniformBuffersNames:d,samplers:h,defines:f,fallbacks:l,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights},shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:()=>T(this,null,function*(){this.shaderLanguage===1?yield Promise.all([import("./chunk-4VFZ3SB3.js"),import("./chunk-SN5X4ZGR.js")]):yield Promise.all([import("./chunk-J3RURG6Q.js"),import("./chunk-INYQO2LO.js")]),this._shadersLoaded=!0})},a);t.setEffect(p,o,this._materialContext),this.buildUniformLayout()}return!t.effect||!t.effect.isReady()?!1:(o._renderId=s.getRenderId(),r._wasPreviouslyReady=!0,r._wasPreviouslyUsingInstances=n,this._checkScenePerformancePriority(),!0)}_computePrimaryColorFromPerceptualColor(){this.__perceptualColor&&(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor,this.getScene().getEngine().useExactSrgbConversions),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())}_computePrimaryColors(){this._primaryColorShadowLevel===0&&this._primaryColorHighlightLevel===0||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))}buildUniformLayout(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.addUniform("projectedGroundInfos",2),Dh(this._uniformBuffer,!0,!1,!1),this._uniformBuffer.create()}unbind(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),super.unbind()}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindForSubMesh(e,t,n){let r=this.getScene(),s=n.materialDefines;if(!s)return;let o=n.effect;if(!o)return;this._activeEffect=o,this.bindOnlyWorldMatrix(e),Ia(t,this._activeEffect);let a=this._mustRebind(r,o,n,t.visibility);if(a){this._uniformBuffer.bindToEffect(o,"Material"),this.bindViewProjection(o);let l=this._reflectionTexture;if((!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync||n._drawWrapper._forceRebindOnNextCall)&&(r.texturesEnabled&&(this._diffuseTexture&&rt.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),mr(this._diffuseTexture,this._uniformBuffer,"diffuse")),bh(r,s,this._uniformBuffer,G.White(),l,!1,!0,!1,!1,!1,!1,this._reflectionBlur)),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),s.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),s.REFLECTIONFRESNEL&&this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w),s.REFLECTIONFRESNEL&&s.REFLECTIONFALLOFF||s.OPACITYFRESNEL){let c=U.Vector3[0].copyFrom(this.sceneCenter).subtractInPlace(r.floatingOriginOffset);this._uniformBuffer.updateFloat3("vBackgroundCenter",c.x,c.y,c.z)}r.texturesEnabled&&(this._diffuseTexture&&rt.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),l&&rt.ReflectionTextureEnabled&&ET(r,s,this._uniformBuffer,l),s.PROJECTED_GROUND&&this._uniformBuffer.updateFloat2("projectedGroundInfos",this.projectedGroundRadius,this.projectedGroundHeight)),Qn(this._activeEffect,this,r),r.bindEyePosition(o)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(o,"Material"),this._needToBindSceneUbo=!0);(a||!this.isFrozen)&&(r.lightsEnabled&&xh(r,t,this._activeEffect,s,this._maxSimultaneousLights),this.bindView(o),Ni(r,t,this._activeEffect,!0),this._useLogarithmicDepth&&Jn(s,o,r),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect,n),this._uniformBuffer.update()}hasTexture(e){return!!(super.hasTexture(e)||this._reflectionTexture===e||this._diffuseTexture===e)}dispose(e=!1,t=!1){t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e)}clone(e){return Xe.Clone(()=>new i(e,this.getScene()),this)}serialize(){let e=super.serialize();return e.customType="BABYLON.BackgroundMaterial",e}getClassName(){return"BackgroundMaterial"}static Parse(e,t,n){return Xe.Parse(()=>new i(e.name,t),e,t,n)}};ke.StandardReflectance0=.05;ke.StandardReflectance90=.5;w([pi()],ke.prototype,"_primaryColor",void 0);w([Re("_markAllSubMeshesAsLightsDirty")],ke.prototype,"primaryColor",void 0);w([pi()],ke.prototype,"__perceptualColor",void 0);w([L()],ke.prototype,"_primaryColorShadowLevel",void 0);w([L()],ke.prototype,"_primaryColorHighlightLevel",void 0);w([Re("_markAllSubMeshesAsLightsDirty")],ke.prototype,"primaryColorHighlightLevel",null);w([Gn()],ke.prototype,"_reflectionTexture",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"reflectionTexture",void 0);w([L()],ke.prototype,"_reflectionBlur",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"reflectionBlur",void 0);w([Gn()],ke.prototype,"_diffuseTexture",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"diffuseTexture",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"shadowLights",void 0);w([L()],ke.prototype,"_shadowLevel",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"shadowLevel",void 0);w([yn()],ke.prototype,"_sceneCenter",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"sceneCenter",void 0);w([L()],ke.prototype,"_opacityFresnel",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"opacityFresnel",void 0);w([L()],ke.prototype,"_reflectionFresnel",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"reflectionFresnel",void 0);w([L()],ke.prototype,"_reflectionFalloffDistance",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"reflectionFalloffDistance",void 0);w([L()],ke.prototype,"_reflectionAmount",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"reflectionAmount",void 0);w([L()],ke.prototype,"_reflectionReflectance0",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"reflectionReflectance0",void 0);w([L()],ke.prototype,"_reflectionReflectance90",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"reflectionReflectance90",void 0);w([L()],ke.prototype,"_useRGBColor",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"useRGBColor",void 0);w([L()],ke.prototype,"_enableNoise",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"enableNoise",void 0);w([L()],ke.prototype,"_maxSimultaneousLights",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],ke.prototype,"maxSimultaneousLights",void 0);w([L()],ke.prototype,"_shadowOnly",void 0);w([Re("_markAllSubMeshesAsLightsDirty")],ke.prototype,"shadowOnly",void 0);w([L(),Re("_markAllSubMeshesAsMiscDirty")],ke.prototype,"enableGroundProjection",void 0);w([L()],ke.prototype,"projectedGroundRadius",void 0);w([L()],ke.prototype,"projectedGroundHeight",void 0);ue("BABYLON.BackgroundMaterial",ke);var gC=(()=>{class i{static _GetDefaultOptions(t){return{createGround:!0,groundSize:15,groundTexture:z.GetAssetUrl(this._GroundTextureCDNUrl),groundColor:new G(.2,.2,.3).toLinearSpace(t.getEngine().useExactSrgbConversions).scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:0,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:z.GetAssetUrl(this._SkyboxTextureCDNUrl),skyboxColor:new G(.2,.2,.3).toLinearSpace(t.getEngine().useExactSrgbConversions).scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:m.Zero(),setupImageProcessing:!0,environmentTexture:z.GetAssetUrl(this._EnvironmentTextureCDNUrl),cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}}get rootMesh(){return this._rootMesh}get skybox(){return this._skybox}get skyboxTexture(){return this._skyboxTexture}get skyboxMaterial(){return this._skyboxMaterial}get ground(){return this._ground}get groundTexture(){return this._groundTexture}get groundMirror(){return this._groundMirror}get groundMirrorRenderList(){return this._groundMirror?this._groundMirror.renderList:null}get groundMaterial(){return this._groundMaterial}constructor(t,n){this._errorHandler=(r,s)=>{this.onErrorObservable.notifyObservers({message:r,exception:s})},this._options=K(K({},i._GetDefaultOptions(n)),t),this._scene=n,this.onErrorObservable=new B,this._setupBackground(),this._setupImageProcessing()}updateOptions(t){let n=K(K({},this._options),t);this._ground&&!n.createGround&&(this._ground.dispose(),this._ground=null),this._groundMaterial&&!n.createGround&&(this._groundMaterial.dispose(),this._groundMaterial=null),this._groundTexture&&this._options.groundTexture!=n.groundTexture&&(this._groundTexture.dispose(),this._groundTexture=null),this._skybox&&!n.createSkybox&&(this._skybox.dispose(),this._skybox=null),this._skyboxMaterial&&!n.createSkybox&&(this._skyboxMaterial.dispose(),this._skyboxMaterial=null),this._skyboxTexture&&this._options.skyboxTexture!=n.skyboxTexture&&(this._skyboxTexture.dispose(),this._skyboxTexture=null),this._groundMirror&&!n.enableGroundMirror&&(this._groundMirror.dispose(),this._groundMirror=null),this._scene.environmentTexture&&this._options.environmentTexture!=n.environmentTexture&&this._scene.environmentTexture.dispose(),this._options=n,this._setupBackground(),this._setupImageProcessing()}setMainColor(t){this.groundMaterial&&(this.groundMaterial.primaryColor=t),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=t),this.groundMirror&&(this.groundMirror.clearColor=new le(t.r,t.g,t.b,1))}_setupImageProcessing(){this._options.setupImageProcessing&&(this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast,this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure,this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled,this._setupEnvironmentTexture())}_setupEnvironmentTexture(){if(this._scene.environmentTexture)return;if(this._options.environmentTexture instanceof xa){this._scene.environmentTexture=this._options.environmentTexture;return}let t=mn.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=t}_setupBackground(){this._rootMesh||(this._rootMesh=new A("BackgroundHelper",this._scene)),this._rootMesh.rotation.y=this._options.backgroundYRotation;let t=this._getSceneSize();this._options.createGround&&(this._setupGround(t),this._setupGroundMaterial(),this._setupGroundDiffuseTexture(),this._options.enableGroundMirror&&this._setupGroundMirrorTexture(t),this._setupMirrorInGroundMaterial()),this._options.createSkybox&&(this._setupSkybox(t),this._setupSkyboxMaterial(),this._setupSkyboxReflectionTexture()),this._rootMesh.position.x=t.rootPosition.x,this._rootMesh.position.z=t.rootPosition.z,this._rootMesh.position.y=t.rootPosition.y}_getSceneSize(){let t=this._options.groundSize,n=this._options.skyboxSize,r=this._options.rootPosition;if(!this._scene.meshes||this._scene.meshes.length===1)return{groundSize:t,skyboxSize:n,rootPosition:r};let s=this._scene.getWorldExtends(a=>a!==this._ground&&a!==this._rootMesh&&a!==this._skybox),o=s.max.subtract(s.min);if(this._options.sizeAuto){this._scene.activeCamera instanceof Ze&&this._scene.activeCamera.upperRadiusLimit&&(t=this._scene.activeCamera.upperRadiusLimit*2,n=t);let a=o.length();a>t&&(t=a*2,n=t),t*=1.1,n*=1.5,r=s.min.add(o.scale(.5)),r.y=s.min.y-this._options.groundYBias}return{groundSize:t,skyboxSize:n,rootPosition:r}}_setupGround(t){(!this._ground||this._ground.isDisposed())&&(this._ground=zu("BackgroundPlane",{size:t.groundSize},this._scene),this._ground.rotation.x=Math.PI/2,this._ground.isPickable=!1,this._ground.parent=this._rootMesh,this._ground.onDisposeObservable.add(()=>{this._ground=null})),this._ground.receiveShadows=this._options.enableGroundShadow}_setupGroundMaterial(){this._groundMaterial||(this._groundMaterial=new ke("BackgroundPlaneMaterial",this._scene)),this._groundMaterial.alpha=this._options.groundOpacity,this._groundMaterial.alphaMode=8,this._groundMaterial.shadowLevel=this._options.groundShadowLevel,this._groundMaterial.primaryColor=this._options.groundColor,this._groundMaterial.useRGBColor=!1,this._groundMaterial.enableNoise=!0,this._ground&&(this._ground.material=this._groundMaterial)}_setupGroundDiffuseTexture(){if(this._groundMaterial&&!this._groundTexture){if(this._options.groundTexture instanceof xa){this._groundMaterial.diffuseTexture=this._options.groundTexture;return}this._groundTexture=new te(this._options.groundTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._groundTexture.gammaSpace=!1,this._groundTexture.hasAlpha=!0,this._groundMaterial.diffuseTexture=this._groundTexture}}_setupGroundMirrorTexture(t){let n=te.CLAMP_ADDRESSMODE;if(!this._groundMirror&&(this._groundMirror=new qu("BackgroundPlaneMirrorTexture",{ratio:this._options.groundMirrorSizeRatio},this._scene,!1,this._options.groundMirrorTextureType,te.BILINEAR_SAMPLINGMODE,!0),this._groundMirror.mirrorPlane=new ya(0,-1,0,t.rootPosition.y),this._groundMirror.anisotropicFilteringLevel=1,this._groundMirror.wrapU=n,this._groundMirror.wrapV=n,this._groundMirror.renderList))for(let s=0;s<this._scene.meshes.length;s++){let o=this._scene.meshes[s];o!==this._ground&&o!==this._skybox&&o!==this._rootMesh&&this._groundMirror.renderList.push(o)}let r=this._options.groundColor.toGammaSpace(this._scene.getEngine().useExactSrgbConversions);this._groundMirror.clearColor=new le(r.r,r.g,r.b,1),this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel}_setupMirrorInGroundMaterial(){this._groundMaterial&&(this._groundMaterial.reflectionTexture=this._groundMirror,this._groundMaterial.reflectionFresnel=!0,this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount,this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight,this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance)}_setupSkybox(t){(!this._skybox||this._skybox.isDisposed())&&(this._skybox=Ko("BackgroundSkybox",{size:t.skyboxSize,sideOrientation:A.BACKSIDE},this._scene),this._skybox.isPickable=!1,this._skybox.onDisposeObservable.add(()=>{this._skybox=null})),this._skybox.parent=this._rootMesh}_setupSkyboxMaterial(){this._skybox&&(this._skyboxMaterial||(this._skyboxMaterial=new ke("BackgroundSkyboxMaterial",this._scene)),this._skyboxMaterial.useRGBColor=!1,this._skyboxMaterial.primaryColor=this._options.skyboxColor,this._skyboxMaterial.enableNoise=!0,this._skybox.material=this._skyboxMaterial)}_setupSkyboxReflectionTexture(){if(this._skyboxMaterial&&!this._skyboxTexture){if(this._options.skyboxTexture instanceof xa){this._skyboxMaterial.reflectionTexture=this._options.skyboxTexture;return}this._skyboxTexture=new mn(this._options.skyboxTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._skyboxTexture.coordinatesMode=te.SKYBOX_MODE,this._skyboxTexture.gammaSpace=!1,this._skyboxMaterial.reflectionTexture=this._skyboxTexture}}dispose(){this._groundMaterial&&this._groundMaterial.dispose(!0,!0),this._skyboxMaterial&&this._skyboxMaterial.dispose(!0,!0),this._rootMesh.dispose(!1)}}return i._GroundTextureCDNUrl="https://assets.babylonjs.com/core/environments/backgroundGround.png",i._SkyboxTextureCDNUrl="https://assets.babylonjs.com/core/environments/backgroundSkybox.dds",i._EnvironmentTextureCDNUrl="https://assets.babylonjs.com/core/environments/environmentSpecular.env",i})();Hs.prototype.addDeviceOrientation=function(i){return this._deviceOrientationInput||(this._deviceOrientationInput=new Am,i&&(this._deviceOrientationInput.smoothFactor=i),this.add(this._deviceOrientationInput)),this};var Am=class{static WaitForOrientationChangeAsync(e){return T(this,null,function*(){return yield new Promise((t,n)=>{let r=!1,s=()=>{window.removeEventListener("deviceorientation",s),r=!0,t()};e&&setTimeout(()=>{r||(window.removeEventListener("deviceorientation",s),n("WaitForOrientationChangeAsync timed out"))},e),typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(o=>{o=="granted"?window.addEventListener("deviceorientation",s):z.Warn("Permission not granted.")}).catch(o=>{z.Error(o)}):window.addEventListener("deviceorientation",s)})})}constructor(){this._screenOrientationAngle=0,this._screenQuaternion=new J,this._alpha=0,this._beta=0,this._gamma=0,this.smoothFactor=0,this._onDeviceOrientationChangedObservable=new B,this._orientationChanged=()=>{this._screenOrientationAngle=window.orientation!==void 0?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,this._screenOrientationAngle=-z.ToRadians(this._screenOrientationAngle/2),this._screenQuaternion.copyFromFloats(0,Math.sin(this._screenOrientationAngle),0,Math.cos(this._screenOrientationAngle))},this._deviceOrientation=e=>{this.smoothFactor?(this._alpha=e.alpha!==null?z.SmoothAngleChange(this._alpha,e.alpha,this.smoothFactor):0,this._beta=e.beta!==null?z.SmoothAngleChange(this._beta,e.beta,this.smoothFactor):0,this._gamma=e.gamma!==null?z.SmoothAngleChange(this._gamma,e.gamma,this.smoothFactor):0):(this._alpha=e.alpha!==null?e.alpha:0,this._beta=e.beta!==null?e.beta:0,this._gamma=e.gamma!==null?e.gamma:0),e.alpha!==null&&this._onDeviceOrientationChangedObservable.notifyObservers()},this._constantTransform=new J(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}get camera(){return this._camera}set camera(e){this._camera=e,this._camera!=null&&!this._camera.rotationQuaternion&&(this._camera.rotationQuaternion=new J),this._camera&&this._camera.onDisposeObservable.add(()=>{this._onDeviceOrientationChangedObservable.clear()})}attachControl(){let e=this.camera.getScene().getEngine().getHostWindow();if(e){let t=()=>{e.addEventListener("orientationchange",this._orientationChanged),e.addEventListener("deviceorientation",this._deviceOrientation),this._orientationChanged()};typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(n=>{n==="granted"?t():z.Warn("Permission not granted.")}).catch(n=>{z.Error(n)}):t()}}detachControl(){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0}checkInputs(){this._alpha&&this._camera.rotationQuaternion&&(J.RotationYawPitchRollToRef(z.ToRadians(this._alpha),z.ToRadians(this._beta),-z.ToRadians(this._gamma),this._camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTransform),this._camera.getScene().useRightHandedSystem?this._camera.rotationQuaternion.y*=-1:this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)}getClassName(){return"FreeCameraDeviceOrientationInput"}getSimpleName(){return"deviceOrientation"}};Lt.FreeCameraDeviceOrientationInput=Am;kt.AddNodeConstructor("DeviceOrientationCamera",(i,e)=>()=>new Qo(i,m.Zero(),e));var Qo=class extends Ot{constructor(e,t,n){super(e,t,n),this._tmpDragQuaternion=new J,this._disablePointerInputWhenUsingDeviceOrientation=!0,this._dragFactor=0,this._quaternionCache=new J,this.inputs.addDeviceOrientation(),this.inputs._deviceOrientationInput&&this.inputs._deviceOrientationInput._onDeviceOrientationChangedObservable.addOnce(()=>{this._disablePointerInputWhenUsingDeviceOrientation&&this.inputs._mouseInput&&(this.inputs._mouseInput._allowCameraRotation=!1,this.inputs._mouseInput.onPointerMovedObservable.add(r=>{this._dragFactor!=0&&(this._initialQuaternion||(this._initialQuaternion=new J),J.FromEulerAnglesToRef(0,r.offsetX*this._dragFactor,0,this._tmpDragQuaternion),this._initialQuaternion.multiplyToRef(this._tmpDragQuaternion,this._initialQuaternion))}))})}get disablePointerInputWhenUsingDeviceOrientation(){return this._disablePointerInputWhenUsingDeviceOrientation}set disablePointerInputWhenUsingDeviceOrientation(e){this._disablePointerInputWhenUsingDeviceOrientation=e}enableHorizontalDragging(e=1/300){this._dragFactor=e}getClassName(){return"DeviceOrientationCamera"}_checkInputs(){super._checkInputs(),this.rotationQuaternion&&(this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))}resetToCurrentRotation(e=Vn.Y){if(!this.rotationQuaternion)return;this._initialQuaternion||(this._initialQuaternion=new J),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion);let t=["x","y","z"];for(let n of t)e[n]?this._initialQuaternion[n]*=-1:this._initialQuaternion[n]=0;this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}};var Gl=class i{constructor(){this.compensateDistortion=!0,this.multiviewEnabled=!1}get aspectRatio(){return this.hResolution/(2*this.vResolution)}get aspectRatioFov(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))}get leftHMatrix(){let t=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return V.Translation(t,0,0)}get rightHMatrix(){let t=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return V.Translation(-t,0,0)}get leftPreViewMatrix(){return V.Translation(.5*this.interpupillaryDistance,0,0)}get rightPreViewMatrix(){return V.Translation(-.5*this.interpupillaryDistance,0,0)}static GetDefault(){let e=new i;return e.hResolution=1280,e.vResolution=800,e.hScreenSize=.149759993,e.vScreenSize=.0935999975,e.vScreenCenter=.0467999987,e.eyeToScreenDistance=.0410000011,e.lensSeparationDistance=.063500002,e.interpupillaryDistance=.064000003,e.distortionK=[1,.219999999,.239999995,0],e.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],e.postProcessScaleFactor=1.714605507808412,e.lensCenterOffset=.151976421,e}};var Yu=class extends Ta{getClassName(){return"VRDistortionCorrectionPostProcess"}constructor(e,t,n,r){super(e,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,r.postProcessScaleFactor,t,te.BILINEAR_SAMPLINGMODE),this._isRightEye=n,this._distortionFactors=r.distortionK,this._postProcessScaleFactor=r.postProcessScaleFactor,this._lensCenterOffset=r.lensCenterOffset,this.adaptScaleToCurrentViewport=!0,this.onSizeChangedObservable.add(()=>{this._scaleIn=new _e(2,2/this.aspectRatio),this._scaleFactor=new _e(.5*(1/this._postProcessScaleFactor),.5*(1/this._postProcessScaleFactor)*this.aspectRatio),this._lensCenter=new _e(this._isRightEye?.5-this._lensCenterOffset*.5:.5+this._lensCenterOffset*.5,.5)}),this.onApplyObservable.add(s=>{s.setFloat2("LensCenter",this._lensCenter.x,this._lensCenter.y),s.setFloat2("Scale",this._scaleFactor.x,this._scaleFactor.y),s.setFloat2("ScaleIn",this._scaleIn.x,this._scaleIn.y),s.setFloat4("HmdWarpParam",this._distortionFactors[0],this._distortionFactors[1],this._distortionFactors[2],this._distortionFactors[3])})}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(import("./chunk-FVXVXR73.js"))):t.push(import("./chunk-6WCIRO6M.js")),super._gatherImports(e,t)}};var uM="vrMultiviewToSingleviewPixelShader",eB=`precision mediump sampler2DArray;varying vec2 vUV;uniform sampler2DArray multiviewSampler;uniform int imageIndex;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{gl_FragColor=texture2D(multiviewSampler,vec3(vUV,imageIndex));}`;gt.ShadersStore[uM]||(gt.ShadersStore[uM]=eB);var Jo=class extends Tn{set samples(e){this._samples=e}get samples(){return this._samples}constructor(e,t=512){super("multiview rtt",t,e,!1,!0,0,!1,void 0,!1,!1,!0,void 0,!0),this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight()),this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,this.samples=this._getEngine().getCaps().maxSamples||this.samples,this._texture.samples=this._samples}_bindFrameBuffer(){this._renderTarget&&this.getScene().getEngine().bindMultiviewFramebuffer(this._renderTarget)}getViewCount(){return 2}};Sn.prototype.createMultiviewRenderTargetTexture=function(i,e,t,n){let r=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";let s=this._createHardwareRenderTargetWrapper(!1,!1,{width:i,height:e});s._framebuffer=r.createFramebuffer();let o=new _a(this,0,!0);return o.width=i,o.height=e,o.isMultiview=!0,t||(t=r.createTexture(),r.bindTexture(r.TEXTURE_2D_ARRAY,t),r.texStorage3D(r.TEXTURE_2D_ARRAY,1,r.RGBA8,i,e,2)),s._colorTextureArray=t,n||(n=r.createTexture(),r.bindTexture(r.TEXTURE_2D_ARRAY,n),r.texStorage3D(r.TEXTURE_2D_ARRAY,1,r.DEPTH24_STENCIL8,i,e,2)),s._depthStencilTextureArray=n,o.isReady=!0,s.setTextures(o),s._depthStencilTexture=o,s};Sn.prototype.bindMultiviewFramebuffer=function(i){let e=i,t=this._gl,n=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),e._colorTextureArray&&e._depthStencilTextureArray)this.getCaps().oculusMultiview?(n.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,e.samples,0,2),n.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,e.samples,0,2)):(n.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),n.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,0,2));else throw"Invalid multiview frame buffer"};Sn.prototype.bindSpaceWarpFramebuffer=function(i){let e=i,t=this._gl,n=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),e._colorTextureArray&&e._depthStencilTextureArray)n.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),n.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_ATTACHMENT,e._depthStencilTextureArray,0,0,2);else throw new Error("Invalid Space Warp framebuffer")};Ne.prototype._useMultiviewToSingleView=!1;Ne.prototype._multiviewTexture=null;Ne.prototype._resizeOrCreateMultiviewTexture=function(i,e){this._multiviewTexture?(this._multiviewTexture.getRenderWidth()!=i||this._multiviewTexture.getRenderHeight()!=e)&&(this._multiviewTexture.dispose(),this._multiviewTexture=new Jo(this.getScene(),{width:i,height:e})):this._multiviewTexture=new Jo(this.getScene(),{width:i,height:e})};function hM(i,e,t){let n=new xT(i,void 0,!0,e,void 0,t);return n.addUniform("viewProjection",16),n.addUniform("viewProjectionR",16),n.addUniform("view",16),n.addUniform("projection",16),n.addUniform("vEyePosition",4),n}var tB=Pe.prototype.createSceneUniformBuffer;Pe.prototype._transformMatrixR=V.Zero();Pe.prototype._multiviewSceneUbo=null;Pe.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=hM(this.getEngine(),"scene_multiview")};Pe.prototype.createSceneUniformBuffer=function(i,e){return this._multiviewSceneUbo?hM(this.getEngine(),i,e):tB.bind(this)(i,e)};Pe.prototype._updateMultiviewUbo=function(i,e){i&&e&&i.multiplyToRef(e,this._transformMatrixR),i&&e&&(i.multiplyToRef(e,U.Matrix[0]),oT.GetRightPlaneToRef(U.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))};Pe.prototype._renderMultiviewToSingleView=function(i){i._resizeOrCreateMultiviewTexture(i._rigPostProcess&&i._rigPostProcess&&i._rigPostProcess.width>0?i._rigPostProcess.width:this.getEngine().getRenderWidth(!0),i._rigPostProcess&&i._rigPostProcess&&i._rigPostProcess.height>0?i._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),i.outputRenderTarget=i._multiviewTexture,this._renderForCamera(i),i.outputRenderTarget=null;for(let e=0;e<i._rigCameras.length;e++){let t=this.getEngine();this._activeCamera=i._rigCameras[e],t.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}};var wm=class extends Ta{getClassName(){return"VRMultiviewToSingleviewPostProcess"}constructor(e,t,n){super(e,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],n,t,te.BILINEAR_SAMPLINGMODE);let r=t??this.getCamera();this.onSizeChangedObservable.add(()=>{}),this.onApplyObservable.add(s=>{r._scene.activeCamera&&r._scene.activeCamera.isLeftCamera?s.setInt("imageIndex",0):s.setInt("imageIndex",1),s.setTexture("multiviewSampler",r._multiviewTexture)})}};function dM(i,e){let t=e.vrCameraMetrics||Gl.GetDefault();i._rigCameras[0]._cameraRigParams.vrMetrics=t,i._rigCameras[0].viewport=new vs(0,0,.5,1),i._rigCameras[0]._cameraRigParams.vrWorkMatrix=new V,i._rigCameras[0]._cameraRigParams.vrHMatrix=t.leftHMatrix,i._rigCameras[0]._cameraRigParams.vrPreViewMatrix=t.leftPreViewMatrix,i._rigCameras[0].getProjectionMatrix=i._rigCameras[0]._getVRProjectionMatrix,i._rigCameras[1]._cameraRigParams.vrMetrics=t,i._rigCameras[1].viewport=new vs(.5,0,.5,1),i._rigCameras[1]._cameraRigParams.vrWorkMatrix=new V,i._rigCameras[1]._cameraRigParams.vrHMatrix=t.rightHMatrix,i._rigCameras[1]._cameraRigParams.vrPreViewMatrix=t.rightPreViewMatrix,i._rigCameras[1].getProjectionMatrix=i._rigCameras[1]._getVRProjectionMatrix,t.multiviewEnabled&&(i.getScene().getEngine().getCaps().multiview?(i._useMultiviewToSingleView=!0,i._rigPostProcess=new wm("VRMultiviewToSingleview",i,t.postProcessScaleFactor)):(N.Warn("Multiview is not supported, falling back to standard rendering"),t.multiviewEnabled=!1)),t.compensateDistortion&&(i._rigCameras[0]._rigPostProcess=new Yu("VR_Distort_Compensation_Left",i._rigCameras[0],!1,t),i._rigCameras[1]._rigPostProcess=new Yu("VR_Distort_Compensation_Right",i._rigCameras[1],!0,t))}kt.AddNodeConstructor("VRDeviceOrientationFreeCamera",(i,e)=>()=>new Ku(i,m.Zero(),e));var Ku=class extends Qo{constructor(e,t,n,r=!0,s=Gl.GetDefault()){super(e,t,n),this._setRigMode=o=>dM(this,o),s.compensateDistortion=r,this.setCameraRigMode(Ne.RIG_MODE_VR,{vrCameraMetrics:s})}getClassName(){return"VRDeviceOrientationFreeCamera"}};var Gt=(()=>{class i{get isConnected(){return this._isConnected}constructor(t,n,r,s=0,o=1,a=2,l=3){this.id=t,this.index=n,this.browserGamepad=r,this._leftStick={x:0,y:0},this._rightStick={x:0,y:0},this._isConnected=!0,this._invertLeftStickY=!1,this.type=i.GAMEPAD,this._leftStickAxisX=s,this._leftStickAxisY=o,this._rightStickAxisX=a,this._rightStickAxisY=l,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}onleftstickchanged(t){this._onleftstickchanged=t}onrightstickchanged(t){this._onrightstickchanged=t}get leftStick(){return this._leftStick}set leftStick(t){this._onleftstickchanged&&(this._leftStick.x!==t.x||this._leftStick.y!==t.y)&&this._onleftstickchanged(t),this._leftStick=t}get rightStick(){return this._rightStick}set rightStick(t){this._onrightstickchanged&&(this._rightStick.x!==t.x||this._rightStick.y!==t.y)&&this._onrightstickchanged(t),this._rightStick=t}update(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}dispose(){}}return i.GAMEPAD=0,i.GENERIC=1,i.XBOX=2,i.POSE_ENABLED=3,i.DUALSHOCK=4,i})(),Mm=class extends Gt{onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}constructor(e,t,n){super(e,t,n),this.onButtonDownObservable=new B,this.onButtonUpObservable=new B,this.type=Gt.GENERIC,this._buttons=new Array(n.buttons.length)}_setButtonValue(e,t,n){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(n),this.onButtonDownObservable.notifyObservers(n)),e===0&&(this._onbuttonup&&this._onbuttonup(n),this.onButtonUpObservable.notifyObservers(n))),e}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()}};var pM={internalPickerForMesh:void 0},pt=class i{constructor(e,t,n=Number.MAX_VALUE,r=Pt){this.origin=e,this.direction=t,this.length=n,this.epsilon=r}clone(){return new i(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,t,n=0){let r=i._TmpVector3[0].copyFromFloats(e.x-n,e.y-n,e.z-n),s=i._TmpVector3[1].copyFromFloats(t.x+n,t.y+n,t.z+n),o=0,a=Number.MAX_VALUE,l,c,u,h;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<r.x||this.origin.x>s.x)return!1}else if(l=1/this.direction.x,c=(r.x-this.origin.x)*l,u=(s.x-this.origin.x)*l,u===-1/0&&(u=1/0),c>u&&(h=c,c=u,u=h),o=Math.max(c,o),a=Math.min(u,a),o>a)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<r.y||this.origin.y>s.y)return!1}else if(l=1/this.direction.y,c=(r.y-this.origin.y)*l,u=(s.y-this.origin.y)*l,u===-1/0&&(u=1/0),c>u&&(h=c,c=u,u=h),o=Math.max(c,o),a=Math.min(u,a),o>a)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<r.z||this.origin.z>s.z)return!1}else if(l=1/this.direction.z,c=(r.z-this.origin.z)*l,u=(s.z-this.origin.z)*l,u===-1/0&&(u=1/0),c>u&&(h=c,c=u,u=h),o=Math.max(c,o),a=Math.min(u,a),o>a)return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){let n=e.center.x-this.origin.x,r=e.center.y-this.origin.y,s=e.center.z-this.origin.z,o=n*n+r*r+s*s,a=e.radius+t,l=a*a;if(o<=l)return!0;let c=n*this.direction.x+r*this.direction.y+s*this.direction.z;return c<0?!1:o-c*c<=l}intersectsTriangle(e,t,n){let r=i._TmpVector3[0],s=i._TmpVector3[1],o=i._TmpVector3[2],a=i._TmpVector3[3],l=i._TmpVector3[4];t.subtractToRef(e,r),n.subtractToRef(e,s),m.CrossToRef(this.direction,s,o);let c=m.Dot(r,o);if(c===0)return null;let u=1/c;this.origin.subtractToRef(e,a);let h=m.Dot(a,o)*u;if(h<-this.epsilon||h>1+this.epsilon)return null;m.CrossToRef(a,r,l);let d=m.Dot(this.direction,l)*u;if(d<-this.epsilon||h+d>1+this.epsilon)return null;let f=m.Dot(s,l)*u;return f>this.length||f<0?null:new VT(1-h-d,h,f)}intersectsPlane(e){let t,n=m.Dot(e.normal,this.direction);if(Math.abs(n)<999999997475243e-21)return null;{let r=m.Dot(e.normal,this.origin);return t=(-e.d-r)/n,t<0?t<-999999997475243e-21?null:0:t}}intersectsAxis(e,t=0){switch(e){case"y":{let n=(this.origin.y-t)/this.direction.y;return n>0?null:new m(this.origin.x+this.direction.x*-n,t,this.origin.z+this.direction.z*-n)}case"x":{let n=(this.origin.x-t)/this.direction.x;return n>0?null:new m(t,this.origin.y+this.direction.y*-n,this.origin.z+this.direction.z*-n)}case"z":{let n=(this.origin.z-t)/this.direction.z;return n>0?null:new m(this.origin.x+this.direction.x*-n,this.origin.y+this.direction.y*-n,t)}default:return null}}intersectsMesh(e,t,n,r=!1,s,o=!1){let a=U.Matrix[0];return e.getWorldMatrix().invertToRef(a),this._tmpRay?i.TransformToRef(this,a,this._tmpRay):this._tmpRay=i.Transform(this,a),e.intersects(this._tmpRay,t,n,r,s,o)}intersectsMeshes(e,t,n){n?n.length=0:n=[];for(let r=0;r<e.length;r++){let s=this.intersectsMesh(e[r],t);s.hit&&n.push(s)}return n.sort(this._comparePickingInfo),n}_comparePickingInfo(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}intersectionSegment(e,t,n){let r=this.origin,s=U.Vector3[0],o=U.Vector3[1],a=U.Vector3[2],l=U.Vector3[3];t.subtractToRef(e,s),this.direction.scaleToRef(i._Rayl,a),r.addToRef(a,o),e.subtractToRef(r,l);let c=m.Dot(s,s),u=m.Dot(s,a),h=m.Dot(a,a),d=m.Dot(s,l),f=m.Dot(a,l),p=c*h-u*u,g,_=p,y,C=p;p<i._Smallnum?(g=0,_=1,y=f,C=h):(g=u*f-h*d,y=c*f-u*d,g<0?(g=0,y=f,C=h):g>_&&(g=_,y=f+u,C=h)),y<0?(y=0,-d<0?g=0:-d>c?g=_:(g=-d,_=c)):y>C&&(y=C,-d+u<0?g=0:-d+u>c?g=_:(g=-d+u,_=c));let E=Math.abs(g)<i._Smallnum?0:g/_,I=Math.abs(y)<i._Smallnum?0:y/C,v=U.Vector3[4];a.scaleToRef(I,v);let x=U.Vector3[5];s.scaleToRef(E,x),x.addInPlace(l);let b=U.Vector3[6];return x.subtractToRef(v,b),I>0&&I<=this.length&&b.lengthSquared()<n*n?x.length():-1}update(e,t,n,r,s,o,a,l=!1){if(l){i._RayDistant||(i._RayDistant=i.Zero()),i._RayDistant.unprojectRayToRef(e,t,n,r,V.IdentityReadOnly,o,a);let c=U.Matrix[0];s.invertToRef(c),i.TransformToRef(i._RayDistant,c,this)}else this.unprojectRayToRef(e,t,n,r,s,o,a);return this}static Zero(){return new i(m.Zero(),m.Zero())}static CreateNew(e,t,n,r,s,o,a){return i.Zero().update(e,t,n,r,s,o,a)}static CreateNewFromTo(e,t,n=V.IdentityReadOnly){let r=new i(new m(0,0,0),new m(0,0,0));return i.CreateFromToToRef(e,t,r,n)}static CreateFromToToRef(e,t,n,r=V.IdentityReadOnly){n.origin.copyFrom(e);let s=t.subtractToRef(e,n.direction),o=Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z);return n.length=o,n.direction.normalize(),i.TransformToRef(n,r,n)}static Transform(e,t){let n=new i(new m(0,0,0),new m(0,0,0));return i.TransformToRef(e,t,n),n}static TransformToRef(e,t,n){m.TransformCoordinatesToRef(e.origin,t,n.origin),m.TransformNormalToRef(e.direction,t,n.direction),n.length=e.length,n.epsilon=e.epsilon;let r=n.direction,s=r.length();if(!(s===0||s===1)){let o=1/s;r.x*=o,r.y*=o,r.z*=o,n.length*=s}return n}unprojectRayToRef(e,t,n,r,s,o,a){let l=U.Matrix[0];s.multiplyToRef(o,l),l.multiplyToRef(a,l),l.invert();let c=Ie.LastCreatedEngine,u=U.Vector3[0];u.x=e/n*2-1,u.y=-(t/r*2-1),u.z=c?.useReverseDepthBuffer?1:c?.isNDCHalfZRange?0:-1;let h=U.Vector3[1].copyFromFloats(u.x,u.y,1-1e-8),d=U.Vector3[2],f=U.Vector3[3];m.TransformCoordinatesToRef(u,l,d),m.TransformCoordinatesToRef(h,l,f),this.origin.copyFrom(d),f.subtractToRef(d,this.direction),this.direction.normalize()}};pt._TmpVector3=hh(6,m.Zero);pt._RayDistant=pt.Zero();pt._Smallnum=1e-8;pt._Rayl=1e9;function Dm(i,e,t,n,r,s=!1){let o=pt.Zero();return Xu(i,e,t,n,o,r,s),o}function Xu(i,e,t,n,r,s,o=!1,a=!1){let l=i.getEngine();if(!s&&!(s=i.activeCamera))return i;let c=s.viewport,u=l.getRenderHeight(),{x:h,y:d,width:f,height:p}=c.toGlobal(l.getRenderWidth(),u),g=1/l.getHardwareScalingLevel();return e=e*g-h,t=t*g-(u-d-p),r.update(e,t,f,p,n||V.IdentityReadOnly,o?V.IdentityReadOnly:s.getViewMatrix(),s.getProjectionMatrix(),a),i}function mM(i,e,t,n){let r=pt.Zero();return _C(i,e,t,r,n),r}function _C(i,e,t,n,r){if(!In)return i;let s=i.getEngine();if(!r&&!(r=i.activeCamera))throw new Error("Active camera not set");let o=r.viewport,a=s.getRenderHeight(),{x:l,y:c,width:u,height:h}=o.toGlobal(s.getRenderWidth(),a),d=V.Identity(),f=1/s.getHardwareScalingLevel();return e=e*f-l,t=t*f-(a-c-h),n.update(e,t,u,h,d,d,r.getProjectionMatrix()),i}function gM(i,e,t,n,r,s,o,a){let l=e(n,t.enableDistantPicking),c=t.intersects(l,r,o,s,n,a);return!c||!c.hit||!r&&i!=null&&c.distance>=i.distance?null:c}function yC(i,e,t,n,r,s){let o=null,a=!!(i.activeCameras&&i.activeCameras.length>1&&i.cameraToUseForPointers!==i.activeCamera),l=i.cameraToUseForPointers||i.activeCamera,c=pM.internalPickerForMesh||gM;for(let u=0;u<i.meshes.length;u++){let h=i.meshes[u];if(t){if(!t(h,-1))continue}else if(!h.isEnabled()||!h.isVisible||!h.isPickable)continue;let d=a&&h.isWorldMatrixCameraDependent(),f=h.computeWorldMatrix(d,l);if(h.hasThinInstances&&h.thinInstanceEnablePicking){let p=c(o,e,h,f,!0,!0,s);if(p){if(r)return p;let g=U.Matrix[1],_=h.thinInstanceGetWorldMatrices();for(let y=0;y<_.length;y++){if(t&&!t(h,y))continue;_[y].multiplyToRef(f,g);let E=c(o,e,h,g,n,r,s,!0);if(E&&(o=E,o.thinInstanceIndex=y,n))return o}}}else{let p=c(o,e,h,f,n,r,s);if(p&&(o=p,n))return o}}return o||new In}function _M(i,e,t,n){if(!In)return null;let r=[],s=!!(i.activeCameras&&i.activeCameras.length>1&&i.cameraToUseForPointers!==i.activeCamera),o=i.cameraToUseForPointers||i.activeCamera,a=pM.internalPickerForMesh||gM;for(let l=0;l<i.meshes.length;l++){let c=i.meshes[l];if(t){if(!t(c,-1))continue}else if(!c.isEnabled()||!c.isVisible||!c.isPickable)continue;let u=s&&c.isWorldMatrixCameraDependent(),h=c.computeWorldMatrix(u,o);if(c.hasThinInstances&&c.thinInstanceEnablePicking){if(a(null,e,c,h,!0,!0,n)){let f=U.Matrix[1],p=c.thinInstanceGetWorldMatrices();for(let g=0;g<p.length;g++){if(t&&!t(c,g))continue;p[g].multiplyToRef(h,f);let y=a(null,e,c,f,!1,!1,n,!0);y&&(y.thinInstanceIndex=g,r.push(y))}}}else{let d=a(null,e,c,h,!1,!1,n);d&&r.push(d)}}return r}function yM(i,e,t,n,r,s){if(!In)return null;let o=yC(i,a=>(i._tempPickingRay||(i._tempPickingRay=pt.Zero()),Xu(i,e,t,a,i._tempPickingRay,s||null),i._tempPickingRay),n,r,!0);return o&&(o.ray=Dm(i,e,t,V.Identity(),s||null)),o}function vM(i,e,t,n,r,s,o,a=!1){let l=yC(i,(c,u)=>(i._tempPickingRay||(i._tempPickingRay=pt.Zero()),Xu(i,e,t,c,i._tempPickingRay,s||null,!1,u),i._tempPickingRay),n,r,!1,o);return l&&(l.ray=Dm(i,e,t,V.Identity(),s||null)),l}function bM(i,e,t,n,r){let s=yC(i,o=>(i._pickWithRayInverseMatrix||(i._pickWithRayInverseMatrix=V.Identity()),o.invertToRef(i._pickWithRayInverseMatrix),i._cachedRayForTransform||(i._cachedRayForTransform=pt.Zero()),pt.TransformToRef(e,i._pickWithRayInverseMatrix,i._cachedRayForTransform),i._cachedRayForTransform),t,n,!1,r);return s&&(s.ray=e),s}function xM(i,e,t,n,r,s){return _M(i,o=>Dm(i,e,t,o,r||null),n,s)}function CM(i,e,t,n){return _M(i,r=>(i._pickWithRayInverseMatrix||(i._pickWithRayInverseMatrix=V.Identity()),r.invertToRef(i._pickWithRayInverseMatrix),i._cachedRayForTransform||(i._cachedRayForTransform=pt.Zero()),pt.TransformToRef(e,i._pickWithRayInverseMatrix,i._cachedRayForTransform),i._cachedRayForTransform),t,n)}function fM(i,e,t=100,n,r){n||(n=i.getWorldMatrix()),e.length=t,r?e.origin.copyFrom(r):e.origin.copyFrom(i.position);let s=U.Vector3[2];s.set(0,0,i._scene.useRightHandedSystem?-1:1);let o=U.Vector3[3];return m.TransformNormalToRef(s,n,o),m.NormalizeToRef(o,e.direction),e}function TM(i,e){e&&(e.prototype.getForwardRay=function(t=100,n,r){return fM(this,new pt(m.Zero(),m.Zero(),t),t,n,r)},e.prototype.getForwardRayToRef=function(t,n=100,r,s){return fM(this,t,n,r,s)}),i&&(TT._IsPickingAvailable=!0,i.prototype.createPickingRay=function(t,n,r,s,o=!1){return Dm(this,t,n,r,s,o)})}TM(Pe,Ne);Pe.prototype.createPickingRayToRef=function(i,e,t,n,r,s=!1,o=!1){return Xu(this,i,e,t,n,r,s,o)};Pe.prototype.createPickingRayInCameraSpace=function(i,e,t){return mM(this,i,e,t)};Pe.prototype.createPickingRayInCameraSpaceToRef=function(i,e,t,n){return _C(this,i,e,t,n)};Pe.prototype.pickWithBoundingInfo=function(i,e,t,n,r){return yM(this,i,e,t,n,r)};Pe.prototype.pick=function(i,e,t,n,r,s,o=!1){return vM(this,i,e,t,n,r,s,o)};Pe.prototype.pickWithRay=function(i,e,t,n){return bM(this,i,e,t,n)};Pe.prototype.multiPick=function(i,e,t,n,r){return xM(this,i,e,t,n,r)};Pe.prototype.multiPickWithRay=function(i,e,t){return CM(this,i,e,t)};vg.prototype.createDynamicTexture=function(i,e,t,n){let r=new _a(this,4);return r.baseWidth=i,r.baseHeight=e,t&&(i=this.needPOTTextures?Kr(i,this._caps.maxTextureSize):i,e=this.needPOTTextures?Kr(e,this._caps.maxTextureSize):e),r.width=i,r.height=e,r.isReady=!1,r.generateMipMaps=t,r.samplingMode=n,this.updateTextureSamplingMode(n,r),this._internalTexturesCache.push(r),r};vg.prototype.updateDynamicTexture=function(i,e,t,n=!1,r,s=!1,o=!1){if(!i)return;let a=this._gl,l=a.TEXTURE_2D,c=this._bindTextureDirectly(l,i,!0,s);this._unpackFlipY(t===void 0?i.invertY:t),n&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);let u=this._getWebGLTextureType(i.type),h=this._getInternalFormat(r||i.format),d=this._getRGBABufferInternalSizedFormat(i.type,h);a.texImage2D(l,0,d,h,u,e),i.generateMipMaps&&a.generateMipmap(l),c||this._bindTextureDirectly(l,null),n&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),r&&(i.format=r),i._dynamicTextureSource=e,i._premulAlpha=n,i.invertY=t||!1,i.isReady=!0};var Vr=class i extends te{constructor(e,t,n,r=!1,s=3,o=5,a){let l=!n||n._isScene,c=l?n:n?.scene,u=l?!r:n;super(null,c,u,a,s,void 0,void 0,void 0,void 0,o),this.name=e,this.wrapU=te.CLAMP_ADDRESSMODE,this.wrapV=te.CLAMP_ADDRESSMODE,this._generateMipMaps=r;let h=this._getEngine();if(!h)return;if(t.getContext)this._canvas=t,this._ownCanvas=!1,this._texture=h.createDynamicTexture(this._canvas.width,this._canvas.height,r,s);else{this._canvas=h.createCanvas(1,1),this._ownCanvas=!0;let f=t;f.width||f.width===0?this._texture=h.createDynamicTexture(f.width,f.height,r,s):this._texture=h.createDynamicTexture(t,t,r,s)}let d=this.getSize();this._canvas.width!==d.width&&(this._canvas.width=d.width),this._canvas.height!==d.height&&(this._canvas.height=d.height),this._context=this._canvas.getContext("2d")}getClassName(){return"DynamicTexture"}get canRescale(){return!0}_recreate(e){this._canvas.width=e.width,this._canvas.height=e.height,this.releaseInternalTexture(),this._texture=this._getEngine().createDynamicTexture(e.width,e.height,this._generateMipMaps,this.samplingMode)}scale(e){let t=this.getSize();t.width*=e,t.height*=e,this._recreate(t)}scaleTo(e,t){let n=this.getSize();n.width=e,n.height=t,this._recreate(n)}getContext(){return this._context}clear(e){let t=this.getSize();e&&(this._context.fillStyle=e),this._context.clearRect(0,0,t.width,t.height)}update(e,t=!1,n=!1){this._texture&&this._getEngine().updateDynamicTexture(this._texture,this._canvas,e===void 0?!0:e,t,this._format||void 0,void 0,n)}drawText(e,t,n,r,s,o,a,l=!0){let c=this.getSize();if(o&&(this._context.fillStyle=o,this._context.fillRect(0,0,c.width,c.height)),this._context.font=r,t==null){let u=this._context.measureText(e);t=(c.width-u.width)/2}if(n==null){let u=parseInt(r.replace(/\D/g,""));n=c.height/2+u/3.65}this._context.fillStyle=s||"",this._context.fillText(e,t,n),l&&this.update(a)}dispose(){super.dispose(),this._ownCanvas&&this._canvas?.remove?.(),this._canvas=null,this._context=null}clone(){let e=this.getScene();if(!e)return this;let t=this.getSize(),n=new i(this.name,t,e,this._generateMipMaps);return n.hasAlpha=this.hasAlpha,n.level=this.level,n.wrapU=this.wrapU,n.wrapV=this.wrapV,n}serialize(){let e=this.getScene();e&&!e.isReady()&&N.Warn("The scene must be ready before serializing the dynamic texture");let t=super.serialize();return i._IsCanvasElement(this._canvas)&&(t.base64String=this._canvas.toDataURL()),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t}static _IsCanvasElement(e){return e.toDataURL!==void 0}_rebuild(){this.update()}};var Rm=class extends Gt{constructor(e,t,n,r=!1){super(e,t,n,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new B,this.onButtonUpObservable=new B,this.onPadDownObservable=new B,this.onPadUpObservable=new B,this._buttonA=0,this._buttonB=0,this._buttonX=0,this._buttonY=0,this._buttonBack=0,this._buttonStart=0,this._buttonLb=0,this._buttonRb=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this._isXboxOnePad=!1,this.type=Gt.XBOX,this._isXboxOnePad=r}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,n){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(n),this.onButtonDownObservable.notifyObservers(n)),e===0&&(this._onbuttonup&&this._onbuttonup(n),this.onButtonUpObservable.notifyObservers(n))),e}_setDpadValue(e,t,n){return e!==t&&(e===1&&(this._ondpaddown&&this._ondpaddown(n),this.onPadDownObservable.notifyObservers(n)),e===0&&(this._ondpadup&&this._ondpadup(n),this.onPadUpObservable.notifyObservers(n))),e}get buttonA(){return this._buttonA}set buttonA(e){this._buttonA=this._setButtonValue(e,this._buttonA,0)}get buttonB(){return this._buttonB}set buttonB(e){this._buttonB=this._setButtonValue(e,this._buttonB,1)}get buttonX(){return this._buttonX}set buttonX(e){this._buttonX=this._setButtonValue(e,this._buttonX,2)}get buttonY(){return this._buttonY}set buttonY(e){this._buttonY=this._setButtonValue(e,this._buttonY,3)}get buttonStart(){return this._buttonStart}set buttonStart(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,9)}get buttonBack(){return this._buttonBack}set buttonBack(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,8)}get buttonLB(){return this._buttonLb}set buttonLB(e){this._buttonLb=this._setButtonValue(e,this._buttonLb,4)}get buttonRB(){return this._buttonRb}set buttonRB(e){this._buttonRb=this._setButtonValue(e,this._buttonRb,5)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,10)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,11)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDpadValue(e,this._dPadUp,12)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDpadValue(e,this._dPadDown,13)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDpadValue(e,this._dPadLeft,14)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDpadValue(e,this._dPadRight,15)}update(){super.update(),this._isXboxOnePad?(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value):(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}};var Pm=class extends Gt{constructor(e,t,n){super(e.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),t,n,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new B,this.onButtonUpObservable=new B,this.onPadDownObservable=new B,this.onPadUpObservable=new B,this._buttonCross=0,this._buttonCircle=0,this._buttonSquare=0,this._buttonTriangle=0,this._buttonShare=0,this._buttonOptions=0,this._buttonL1=0,this._buttonR1=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this.type=Gt.DUALSHOCK}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,n){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(n),this.onButtonDownObservable.notifyObservers(n)),e===0&&(this._onbuttonup&&this._onbuttonup(n),this.onButtonUpObservable.notifyObservers(n))),e}_setDpadValue(e,t,n){return e!==t&&(e===1&&(this._ondpaddown&&this._ondpaddown(n),this.onPadDownObservable.notifyObservers(n)),e===0&&(this._ondpadup&&this._ondpadup(n),this.onPadUpObservable.notifyObservers(n))),e}get buttonCross(){return this._buttonCross}set buttonCross(e){this._buttonCross=this._setButtonValue(e,this._buttonCross,0)}get buttonCircle(){return this._buttonCircle}set buttonCircle(e){this._buttonCircle=this._setButtonValue(e,this._buttonCircle,1)}get buttonSquare(){return this._buttonSquare}set buttonSquare(e){this._buttonSquare=this._setButtonValue(e,this._buttonSquare,2)}get buttonTriangle(){return this._buttonTriangle}set buttonTriangle(e){this._buttonTriangle=this._setButtonValue(e,this._buttonTriangle,3)}get buttonOptions(){return this._buttonOptions}set buttonOptions(e){this._buttonOptions=this._setButtonValue(e,this._buttonOptions,9)}get buttonShare(){return this._buttonShare}set buttonShare(e){this._buttonShare=this._setButtonValue(e,this._buttonShare,8)}get buttonL1(){return this._buttonL1}set buttonL1(e){this._buttonL1=this._setButtonValue(e,this._buttonL1,4)}get buttonR1(){return this._buttonR1}set buttonR1(e){this._buttonR1=this._setButtonValue(e,this._buttonR1,5)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,10)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,11)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDpadValue(e,this._dPadUp,12)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDpadValue(e,this._dPadDown,13)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDpadValue(e,this._dPadLeft,14)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDpadValue(e,this._dPadRight,15)}update(){super.update(),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}};var Om=class{constructor(e){if(this._scene=e,this._babylonGamepads=[],this._oneGamepadConnected=!1,this._isMonitoring=!1,this.onGamepadDisconnectedObservable=new B,iT()?(this._gamepadEventSupported="GamepadEvent"in window,this._gamepadSupport=navigator&&navigator.getGamepads):this._gamepadEventSupported=!1,this.onGamepadConnectedObservable=new B(t=>{for(let n in this._babylonGamepads){let r=this._babylonGamepads[n];r&&r._isConnected&&this.onGamepadConnectedObservable.notifyObserver(t,r)}}),this._onGamepadConnectedEvent=t=>{let n=t.gamepad;if(n.index in this._babylonGamepads&&this._babylonGamepads[n.index].isConnected)return;let r;this._babylonGamepads[n.index]?(r=this._babylonGamepads[n.index],r.browserGamepad=n,r._isConnected=!0):r=this._addNewGamepad(n),this.onGamepadConnectedObservable.notifyObservers(r),this._startMonitoringGamepads()},this._onGamepadDisconnectedEvent=t=>{let n=t.gamepad;for(let r in this._babylonGamepads)if(this._babylonGamepads[r].index===n.index){let s=this._babylonGamepads[r];s._isConnected=!1,this.onGamepadDisconnectedObservable.notifyObservers(s),s.dispose&&s.dispose();break}},this._gamepadSupport)if(this._updateGamepadObjects(),this._babylonGamepads.length&&this._startMonitoringGamepads(),this._gamepadEventSupported){let t=this._scene?this._scene.getEngine().getHostWindow():window;t&&(t.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),t.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,!1))}else this._startMonitoringGamepads()}get gamepads(){return this._babylonGamepads}getGamepadByType(e=Gt.XBOX){for(let t of this._babylonGamepads)if(t&&t.type===e)return t;return null}dispose(){this._gamepadEventSupported&&(this._onGamepadConnectedEvent&&window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent),this._onGamepadDisconnectedEvent&&window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent),this._onGamepadConnectedEvent=null,this._onGamepadDisconnectedEvent=null);for(let e of this._babylonGamepads)e.dispose();this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this._oneGamepadConnected=!1,this._stopMonitoringGamepads(),this._babylonGamepads=[]}_addNewGamepad(e){this._oneGamepadConnected||(this._oneGamepadConnected=!0);let t,n=e.id.search("054c")!==-1&&e.id.search("0ce6")===-1,r=e.id.search("Xbox One")!==-1;return r||e.id.search("Xbox 360")!==-1||e.id.search("xinput")!==-1||e.id.search("045e")!==-1&&e.id.search("Surface Dock")===-1?t=new Rm(e.id,e.index,e,r):n?t=new Pm(e.id,e.index,e):t=new Mm(e.id,e.index,e),this._babylonGamepads[t.index]=t,t}_startMonitoringGamepads(){this._isMonitoring||(this._isMonitoring=!0,this._checkGamepadsStatus())}_stopMonitoringGamepads(){this._isMonitoring=!1}_checkGamepadsStatus(){this._updateGamepadObjects();for(let e in this._babylonGamepads){let t=this._babylonGamepads[e];if(!(!t||!t.isConnected))try{t.update()}catch{this._loggedErrors.indexOf(t.index)===-1&&(z.Warn(`Error updating gamepad ${t.id}`),this._loggedErrors.push(t.index))}}this._isMonitoring&&ne.QueueNewFrame(()=>{this._checkGamepadsStatus()})}_updateGamepadObjects(){let e=navigator.getGamepads?navigator.getGamepads():[];for(let t=0;t<e.length;t++){let n=e[t];if(n)if(this._babylonGamepads[n.index])this._babylonGamepads[t].browserGamepad=n,this._babylonGamepads[t].isConnected||(this._babylonGamepads[t]._isConnected=!0,this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[t]));else{let r=this._addNewGamepad(n);this.onGamepadConnectedObservable.notifyObservers(r)}}}};var ea=class{constructor(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this.deadzoneDelta=.1,this._yAxisScale=1,this._cameraTransform=V.Identity(),this._deltaTransform=m.Zero(),this._vector3=m.Zero(),this._vector2=_e.Zero()}get invertYAxis(){return this._yAxisScale!==1}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){let e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{t.type!==Gt.POSE_ENABLED&&(!this.gamepad||t.type===Gt.XBOX)&&(this.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{this.gamepad===t&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(Gt.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad&&this.gamepad.leftStick){let e=this.camera,t=this.gamepad.leftStick;this.gamepadMoveSensibility!==0&&(t.x=Math.abs(t.x)>this.deadzoneDelta?t.x/this.gamepadMoveSensibility:0,t.y=Math.abs(t.y)>this.deadzoneDelta?t.y/this.gamepadMoveSensibility:0);let n=this.gamepad.rightStick;n&&this.gamepadAngularSensibility!==0?(n.x=Math.abs(n.x)>this.deadzoneDelta?n.x/this.gamepadAngularSensibility:0,n.y=(Math.abs(n.y)>this.deadzoneDelta?n.y/this.gamepadAngularSensibility:0)*this._yAxisScale):n={x:0,y:0},e.rotationQuaternion?e.rotationQuaternion.toRotationMatrix(this._cameraTransform):V.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,this._cameraTransform);let r=e._computeLocalCameraSpeed()*50;this._vector3.copyFromFloats(t.x*r,0,-t.y*r),m.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform),e.cameraDirection.addInPlace(this._deltaTransform),this._vector2.copyFromFloats(n.y,n.x),e.cameraRotation.addInPlace(this._vector2)}}getClassName(){return"FreeCameraGamepadInput"}getSimpleName(){return"gamepad"}};w([L()],ea.prototype,"gamepadAngularSensibility",void 0);w([L()],ea.prototype,"gamepadMoveSensibility",void 0);Lt.FreeCameraGamepadInput=ea;var ta=class{constructor(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40,this._yAxisScale=1}get invertYAxis(){return this._yAxisScale!==1}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){let e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{t.type!==Gt.POSE_ENABLED&&(!this.gamepad||t.type===Gt.XBOX)&&(this.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{this.gamepad===t&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(Gt.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad){let e=this.camera,t=this.gamepad.rightStick;if(t){if(t.x!=0){let r=t.x/this.gamepadRotationSensibility;r!=0&&Math.abs(r)>.005&&(e.inertialAlphaOffset+=r)}if(t.y!=0){let r=t.y/this.gamepadRotationSensibility*this._yAxisScale;r!=0&&Math.abs(r)>.005&&(e.inertialBetaOffset+=r)}}let n=this.gamepad.leftStick;if(n&&n.y!=0){let r=n.y/this.gamepadMoveSensibility;r!=0&&Math.abs(r)>.005&&(this.camera.inertialRadiusOffset-=r)}}}getClassName(){return"ArcRotateCameraGamepadInput"}getSimpleName(){return"gamepad"}};w([L()],ta.prototype,"gamepadRotationSensibility",void 0);w([L()],ta.prototype,"gamepadMoveSensibility",void 0);Lt.ArcRotateCameraGamepadInput=ta;Object.defineProperty(Pe.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new Om(this);let i=this._getComponent(Ge.NAME_GAMEPAD);i||(i=new vC(this),this._addComponent(i))}return this._gamepadManager},enumerable:!0,configurable:!0});Hs.prototype.addGamepad=function(){return this.add(new ea),this};Vl.prototype.addGamepad=function(){return this.add(new ta),this};var vC=class{constructor(e){this.name=Ge.NAME_GAMEPAD,this.scene=e}register(){}rebuild(){}dispose(){let e=this.scene._gamepadManager;e&&(e.dispose(),this.scene._gamepadManager=null)}};var Ul=class{get isFixedFoveationSupported(){return this.layerType=="XRWebGLLayer"&&typeof this.layer.fixedFoveation=="number"}get fixedFoveation(){return this.isFixedFoveationSupported?this.layer.fixedFoveation:null}set fixedFoveation(e){if(this.isFixedFoveationSupported){let t=Math.max(0,Math.min(1,e||0));this.layer.fixedFoveation=t}}createRenderTargetTextureProvider(e){return this._rttWrapper=this._createRenderTargetTextureProvider(e),this._rttWrapper}dispose(){this._rttWrapper&&(this._rttWrapper.dispose(),this._rttWrapper=null)}constructor(e,t,n,r,s){this.getWidth=e,this.getHeight=t,this.layer=n,this.layerType=r,this._createRenderTargetTextureProvider=s,this._rttWrapper=null}};var zl=class{constructor(e,t){this._scene=e,this.layerWrapper=t,this._renderTargetTextures=new Array,this._engine=e.getEngine()}_createInternalTexture(e,t){let n=new _a(this._engine,0,!0);return n.width=e.width,n.height=e.height,n._hardwareTexture=new yT(t,this._engine._gl),n.isReady=!0,n}_createRenderTargetTexture(e,t,n,r,s,o){if(!this._engine)throw new Error("Engine is disposed");let a={width:e,height:t},l=o?new Jo(this._scene,a):new Tn("XR renderTargetTexture",a,this._scene),c=l.renderTarget;if(c._samples=l.samples,(n||!r)&&(c._framebuffer=n),r)if(o)c._colorTextureArray=r;else{let u=this._createInternalTexture(a,r);c.setTexture(u,0),l._texture=u}return s&&(o?c._depthStencilTextureArray=s:c._depthStencilTexture=this._createInternalTexture(a,s)),l.disableRescaling(),this._renderTargetTextures.push(l),l}_destroyRenderTargetTexture(e){this._renderTargetTextures.splice(this._renderTargetTextures.indexOf(e),1),e.dispose()}getFramebufferDimensions(){return this._framebufferDimensions}dispose(){for(let e of this._renderTargetTextures)e.dispose();this._renderTargetTextures.length=0}};var Hl=class extends Ul{constructor(e){super(()=>e.framebufferWidth,()=>e.framebufferHeight,e,"XRWebGLLayer",t=>new bC(t.scene,this)),this.layer=e}},bC=class extends zl{constructor(e,t){super(e,t),this.layerWrapper=t,this._layer=t.layer,this._framebufferDimensions={framebufferWidth:this._layer.framebufferWidth,framebufferHeight:this._layer.framebufferHeight}}trySetViewportForView(e,t){let n=this._layer.getViewport(t);if(!n)return!1;let r=this._framebufferDimensions.framebufferWidth,s=this._framebufferDimensions.framebufferHeight;return e.x=n.x/r,e.y=n.y/s,e.width=n.width/r,e.height=n.height/s,!0}getRenderTargetTextureForEye(e){let t=this._layer.framebufferWidth,n=this._layer.framebufferHeight,r=this._layer.framebuffer;return(!this._rtt||t!==this._framebufferDimensions.framebufferWidth||n!==this._framebufferDimensions.framebufferHeight||r!==this._framebuffer)&&(this._rtt=this._createRenderTargetTexture(t,n,r),this._framebufferDimensions.framebufferWidth=t,this._framebufferDimensions.framebufferHeight=n,this._framebuffer=r),this._rtt}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e.eye)}};var Zu=class i{static GetDefaults(e){let t=new i;return t.canvasOptions={antialias:!0,depth:!0,stencil:e?e.isStencilEnable:!0,alpha:!0,framebufferScaleFactor:1},t.newCanvasCssStyle="position:absolute; bottom:0px;right:0px;z-index:10;width:90%;height:100%;background-color: #000000;",t}},Nm=class{constructor(e,t=Zu.GetDefaults()){if(this._options=t,this._canvas=null,this._engine=null,this.xrLayer=null,this._xrLayerWrapper=null,this.onXRLayerInitObservable=new B,this._engine=e.scene.getEngine(),this._engine.onDisposeObservable.addOnce(()=>{this._engine=null}),t.canvasElement)this._setManagedOutputCanvas(t.canvasElement);else{let n=document.createElement("canvas");n.style.cssText=this._options.newCanvasCssStyle||"position:absolute; bottom:0px;right:0px;",this._setManagedOutputCanvas(n)}e.onXRSessionInit.add(()=>{this._addCanvas()}),e.onXRSessionEnded.add(()=>{this._removeCanvas()}),this._makeCanvasCompatible()}dispose(){this._removeCanvas(),this._setManagedOutputCanvas(null),this.onXRLayerInitObservable.clear()}_makeCanvasCompatible(){this._canvasCompatiblePromise=new Promise((e,t)=>{try{this.canvasContext&&this.canvasContext.makeXRCompatible?this.canvasContext.makeXRCompatible().then(()=>{e()},()=>{z.Warn("Error executing makeXRCompatible. This does not mean that the session will work incorrectly."),e()}):e()}catch(n){t(n)}})}initializeXRLayerAsync(e){return T(this,null,function*(){let t=()=>(this.xrLayer=new XRWebGLLayer(e,this.canvasContext,this._options.canvasOptions),this._xrLayerWrapper=new Hl(this.xrLayer),this.onXRLayerInitObservable.notifyObservers(this.xrLayer),this.xrLayer);return yield this._canvasCompatiblePromise.then(()=>{},()=>{}).then(()=>t())})}_addCanvas(){this._canvas&&this._engine&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.appendChild(this._canvas),this.xrLayer?this._setCanvasSize(!0):this.onXRLayerInitObservable.addOnce(()=>{this._setCanvasSize(!0)})}_removeCanvas(){this._canvas&&this._engine&&document.body.contains(this._canvas)&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.removeChild(this._canvas),this._setCanvasSize(!1)}_setCanvasSize(e=!0,t=this._xrLayerWrapper){!this._canvas||!this._engine||(e?t&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=t.getWidth()+"px",this._canvas.style.height=t.getHeight()+"px"):this._engine.setSize(t.getWidth(),t.getHeight())):this._originalCanvasSize&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=this._originalCanvasSize.width+"px",this._canvas.style.height=this._originalCanvasSize.height+"px"):this._engine.setSize(this._originalCanvasSize.width,this._originalCanvasSize.height)))}_setManagedOutputCanvas(e){this._removeCanvas(),e?(this._originalCanvasSize={width:e.offsetWidth,height:e.offsetHeight},this._canvas=e,this.canvasContext=this._canvas.getContext("webgl2"),this.canvasContext||(this.canvasContext=this._canvas.getContext("webgl"))):(this._canvas=null,this.canvasContext=null)}};var Lm=class extends Ul{constructor(e){super(()=>e.framebufferWidth,()=>e.framebufferHeight,e,"XRWebGLLayer",t=>new xC(t,this)),this.layer=e}},xC=class extends zl{constructor(e,t){super(e.scene,t),this.layerWrapper=t,this._nativeRTTProvider=navigator.xr.getNativeRenderTargetProvider(e.session,this._createRenderTargetTexture.bind(this),this._destroyRenderTargetTexture.bind(this)),this._nativeLayer=t.layer}trySetViewportForView(e){return e.x=0,e.y=0,e.width=1,e.height=1,!0}getRenderTargetTextureForEye(e){return this._nativeRTTProvider.getRenderTargetForEye(e)}getRenderTargetTextureForView(e){return this._nativeRTTProvider.getRenderTargetForEye(e.eye)}getFramebufferDimensions(){return{framebufferWidth:this._nativeLayer.framebufferWidth,framebufferHeight:this._nativeLayer.framebufferHeight}}},Fm=class{constructor(e){this._nativeRenderTarget=navigator.xr.getWebXRRenderTarget(e.scene.getEngine())}initializeXRLayerAsync(e){return T(this,null,function*(){return yield this._nativeRenderTarget.initializeXRLayerAsync(e),this.xrLayer=this._nativeRenderTarget.xrLayer,this.xrLayer})}dispose(){}};var $l=class i{get worldScalingFactor(){return this._worldScalingFactor}set worldScalingFactor(e){let t=this._worldScalingFactor;this._worldScalingFactor=e,this.onWorldScaleFactorChangedObservable.notifyObservers({previousScaleFactor:t,newScaleFactor:e})}constructor(e){this.scene=e,this.currentTimestamp=-1,this.defaultHeightCompensation=1.7,this.onXRFrameObservable=new B,this.onXRReferenceSpaceChanged=new B,this.onXRSessionEnded=new B,this.onXRSessionInit=new B,this.onXRReferenceSpaceInitialized=new B,this.onXRReady=new B,this.inXRFrameLoop=!1,this.inXRSession=!1,this._worldScalingFactor=1,this.onWorldScaleFactorChangedObservable=new B(void 0,!0),this._engine=e.getEngine(),this._onEngineDisposedObserver=this._engine.onDisposeObservable.addOnce(()=>{this._engine=null}),e.onDisposeObservable.addOnce(()=>{this.dispose()}),this.onXRSessionEnded.add(()=>{e.cameraToUseForPointers=null})}get referenceSpace(){return this._referenceSpace}set referenceSpace(e){this._referenceSpace=e,this.onXRReferenceSpaceChanged.notifyObservers(this._referenceSpace)}get sessionMode(){return this._sessionMode}dispose(){this.inXRSession&&this.exitXRAsync(),this.onXRReady.clear(),this.onXRFrameObservable.clear(),this.onXRSessionEnded.clear(),this.onXRReferenceSpaceChanged.clear(),this.onXRSessionInit.clear(),this.onWorldScaleFactorChangedObservable.clear(),this._engine?.onDisposeObservable.remove(this._onEngineDisposedObserver),this._engine=null}exitXRAsync(){return T(this,null,function*(){if(this.session&&this.inXRSession){this.inXRSession=!1;try{return yield this.session.end()}catch{N.Warn("Could not end XR session.")}}})}trySetViewportForView(e,t){return this._baseLayerRTTProvider?.trySetViewportForView(e,t)||!1}getRenderTargetTextureForEye(e){return this._baseLayerRTTProvider?.getRenderTargetTextureForEye(e)||null}getRenderTargetTextureForView(e){return this._baseLayerRTTProvider?.getRenderTargetTextureForView(e)||null}getWebXRRenderTarget(e){let t=this.scene.getEngine();return this._xrNavigator.xr.native?new Fm(this):(e=e||Zu.GetDefaults(t),e.canvasElement=e.canvasElement||t.getRenderingCanvas()||void 0,new Nm(this,e))}initializeAsync(){return T(this,null,function*(){if(this._xrNavigator=navigator,!this._xrNavigator.xr)throw new Error("WebXR not supported on this browser.")})}initializeSessionAsync(){return T(this,arguments,function*(e="immersive-vr",t={}){let n=yield this._xrNavigator.xr.requestSession(e,t);return this.session=n,this._sessionMode=e,this.inXRSession=!0,this.onXRSessionInit.notifyObservers(n),this.session.addEventListener("end",()=>{this.inXRSession=!1,this.onXRSessionEnded.notifyObservers(null),this._engine&&(this._engine.framebufferDimensionsObject=null,this._engine.restoreDefaultFramebuffer(),this._engine.customAnimationFrameRequester=null,this._engine._renderLoop()),this.isNative&&this._baseLayerRTTProvider?.dispose(),this._baseLayerRTTProvider=null,this._baseLayerWrapper=null},{once:!0}),this.session})}isSessionSupportedAsync(e){return T(this,null,function*(){return yield i.IsSessionSupportedAsync(e)})}resetReferenceSpace(){this.referenceSpace=this.baseReferenceSpace}runXRRenderLoop(){!this.inXRSession||!this._engine||(this._engine.customAnimationFrameRequester={requestAnimationFrame:e=>this.session.requestAnimationFrame(e),renderFunction:(e,t)=>{if(!(!this.inXRSession||!this._engine)&&(this.currentFrame=t,this.currentTimestamp=e,t)){this.inXRFrameLoop=!0;let n=this._baseLayerRTTProvider?.getFramebufferDimensions()||null;this._engine.framebufferDimensionsObject!==n&&(this._engine.framebufferDimensionsObject=n),this.onXRFrameObservable.notifyObservers(t),this._engine._renderLoop(),this._engine.framebufferDimensionsObject=null,this.inXRFrameLoop=!1}}},this._engine.framebufferDimensionsObject=this._baseLayerRTTProvider?.getFramebufferDimensions()||null,this.onXRFrameObservable.addOnce(()=>{this.onXRReady.notifyObservers(this)}),typeof window<"u"&&window.cancelAnimationFrame&&window.cancelAnimationFrame(this._engine._frameHandler),this._engine._renderLoop())}setReferenceSpaceTypeAsync(e="local-floor"){return T(this,null,function*(){let t;try{t=yield this.session.requestReferenceSpace(e)}catch(r){N.Error("XR.requestReferenceSpace failed for the following reason: "),N.Error(r),N.Log('Defaulting to universally-supported "viewer" reference space type.');try{let s=yield this.session.requestReferenceSpace("viewer"),o=new XRRigidTransform({x:0,y:-this.defaultHeightCompensation,z:0});return s.getOffsetReferenceSpace(o)}catch(s){throw N.Error(s),'XR initialization failed: required "viewer" reference space type not supported.'}}let n=yield this.session.requestReferenceSpace("viewer");return this.viewerReferenceSpace=n,this.referenceSpace=this.baseReferenceSpace=t,this.onXRReferenceSpaceInitialized.notifyObservers(t),this.referenceSpace})}updateRenderStateAsync(e){return T(this,null,function*(){return yield this.session.updateRenderState(e)})}_setBaseLayerWrapper(e){this.isNative&&this._baseLayerRTTProvider?.dispose(),this._baseLayerWrapper=e,this._baseLayerRTTProvider=this._baseLayerWrapper?.createRenderTargetTextureProvider(this)||null}_getBaseLayerWrapper(){return this._baseLayerWrapper}updateRenderState(e){e.baseLayer&&this._setBaseLayerWrapper(this.isNative?new Lm(e.baseLayer):new Hl(e.baseLayer)),this.session.updateRenderState(e)}static IsSessionSupportedAsync(e){return T(this,null,function*(){if(!navigator.xr)return!1;let t=navigator.xr.isSessionSupported||navigator.xr.supportsSession;if(t)try{let n=t.call(navigator.xr,e);return typeof n>"u"?!0:n}catch(n){return N.Warn(n),!1}else return!1})}get isNative(){return this._xrNavigator.xr.native??!1}get currentFrameRate(){return this.session?.frameRate}get supportedFrameRates(){return this.session?.supportedFrameRates}updateTargetFrameRate(e){return T(this,null,function*(){return yield this.session.updateTargetFrameRate(e)})}runInXRFrame(e,t=!0){this.inXRFrameLoop?e():(this.inXRSession||!t)&&this.onXRFrameObservable.addOnce(e)}get isFixedFoveationSupported(){return this._baseLayerWrapper?.isFixedFoveationSupported||!1}get fixedFoveation(){return this._baseLayerWrapper?.fixedFoveation||null}set fixedFoveation(e){let t=Math.max(0,Math.min(1,e||0));this._baseLayerWrapper&&(this._baseLayerWrapper.fixedFoveation=t)}get enabledFeatures(){return this.session?.enabledFeatures??null}};var nB=(()=>{class i{constructor(t,n=null){if(this.scene=t,this._pointerDownOnMeshAsked=!1,this._isActionableMesh=!1,this._teleportationRequestInitiated=!1,this._teleportationBackRequestInitiated=!1,this._rotationRightAsked=!1,this._rotationLeftAsked=!1,this._dpadPressed=!0,this._activePointer=!1,this._id=i._IdCounter++,n)this._gazeTracker=n.clone("gazeTracker");else{this._gazeTracker=ur("gazeTracker",{diameter:.0035,thickness:.0025,tessellation:20,updatable:!1},t),this._gazeTracker.bakeCurrentTransformIntoVertices(),this._gazeTracker.isPickable=!1,this._gazeTracker.isVisible=!1;let r=new Z("targetMat",t);r.specularColor=G.Black(),r.emissiveColor=new G(.7,.7,.7),r.backFaceCulling=!1,this._gazeTracker.material=r}}_getForwardRay(t){return new pt(m.Zero(),new m(0,0,t))}_selectionPointerDown(){this._pointerDownOnMeshAsked=!0,this._currentHit&&this.scene.simulatePointerDown(this._currentHit,{pointerId:this._id})}_selectionPointerUp(){this._currentHit&&this.scene.simulatePointerUp(this._currentHit,{pointerId:this._id}),this._pointerDownOnMeshAsked=!1}_activatePointer(){this._activePointer=!0}_deactivatePointer(){this._activePointer=!1}_updatePointerDistance(t=100){}dispose(){this._interactionsEnabled=!1,this._teleportationEnabled=!1,this._gazeTracker&&this._gazeTracker.dispose()}}return i._IdCounter=0,i})(),km=class extends nB{constructor(e,t){super(t),this._getCamera=e}_getForwardRay(e){let t=this._getCamera();return t?t.getForwardRay(e):new pt(m.Zero(),m.Forward())}};var SM=(()=>{class i{get onEnteringVR(){return this.onEnteringVRObservable}get onExitingVR(){return this.onExitingVRObservable}get teleportationTarget(){return this._teleportationTarget}set teleportationTarget(t){t&&(t.name="teleportationTarget",this._isDefaultTeleportationTarget=!1,this._teleportationTarget=t)}get gazeTrackerMesh(){return this._cameraGazer._gazeTracker}set gazeTrackerMesh(t){t&&(this._cameraGazer._gazeTracker&&this._cameraGazer._gazeTracker.dispose(),this._cameraGazer._gazeTracker=t,this._cameraGazer._gazeTracker.bakeCurrentTransformIntoVertices(),this._cameraGazer._gazeTracker.isPickable=!1,this._cameraGazer._gazeTracker.isVisible=!1,this._cameraGazer._gazeTracker.name="gazeTracker")}get displayGaze(){return this._displayGaze}set displayGaze(t){this._displayGaze=t,t||(this._cameraGazer._gazeTracker.isVisible=!1)}get displayLaserPointer(){return this._displayLaserPointer}set displayLaserPointer(t){this._displayLaserPointer=t}get deviceOrientationCamera(){return this._deviceOrientationCamera}get currentVRCamera(){return this._scene.activeCamera}get vrDeviceOrientationCamera(){return this._vrDeviceOrientationCamera}get vrButton(){return this._btnVR}get _teleportationRequestInitiated(){return this._cameraGazer._teleportationRequestInitiated}constructor(t,n={}){if(this.webVROptions=n,this._fullscreenVRpresenting=!1,this.enableGazeEvenWhenNoPointerLock=!1,this.exitVROnDoubleTap=!0,this.onEnteringVRObservable=new B,this.onAfterEnteringVRObservable=new B,this.onExitingVRObservable=new B,this._useCustomVRButton=!1,this._teleportActive=!1,this._floorMeshesCollection=[],this._teleportationMode=i.TELEPORTATIONMODE_CONSTANTTIME,this._teleportationTime=122,this._teleportationSpeed=20,this._rotationAllowed=!0,this._teleportBackwardsVector=new m(0,-1,-1),this._isDefaultTeleportationTarget=!0,this._teleportationFillColor="#444444",this._teleportationBorderColor="#FFFFFF",this._rotationAngle=0,this._haloCenter=new m(0,0,0),this._padSensibilityUp=.65,this._padSensibilityDown=.35,this._pickedLaserColor=new G(.2,.2,1),this._pickedGazeColor=new G(0,0,1),this.onNewMeshSelected=new B,this.onNewMeshPicked=new B,this.onBeforeCameraTeleport=new B,this.onAfterCameraTeleport=new B,this.onSelectedMeshUnselected=new B,this.teleportationEnabled=!0,this._teleportationInitialized=!1,this._interactionsEnabled=!1,this._displayGaze=!0,this._displayLaserPointer=!0,this.updateGazeTrackerScale=!0,this.updateGazeTrackerColor=!0,this.updateControllerLaserColor=!0,this.requestPointerLockOnFullScreen=!0,this.xrTestDone=!1,this._onResize=()=>{this._moveButtonToBottomRight()},this._onFullscreenChange=()=>{this._fullscreenVRpresenting=!!document.fullscreenElement,!this._fullscreenVRpresenting&&this._inputElement&&(this.exitVR(),!this._useCustomVRButton&&this._btnVR&&(this._btnVR.style.top=this._inputElement.offsetTop+this._inputElement.offsetHeight-70+"px",this._btnVR.style.left=this._inputElement.offsetLeft+this._inputElement.offsetWidth-100+"px",this._updateButtonVisibility()))},this._cachedAngularSensibility={angularSensibilityX:null,angularSensibilityY:null,angularSensibility:null},this._beforeRender=()=>{this._scene.getEngine().isPointerLock||this.enableGazeEvenWhenNoPointerLock||(this._cameraGazer._gazeTracker.isVisible=!1)},this._onNewGamepadConnected=s=>{s.type!==Gt.POSE_ENABLED&&(s.leftStick&&s.onleftstickchanged(o=>{this._teleportationInitialized&&this.teleportationEnabled&&(this._checkTeleportWithRay(o,this._cameraGazer),this._checkTeleportBackwards(o,this._cameraGazer))}),s.rightStick&&s.onrightstickchanged(o=>{this._teleportationInitialized&&this._checkRotate(o,this._cameraGazer)}),s.type===Gt.XBOX&&(s.onbuttondown(o=>{this._interactionsEnabled&&o===0&&this._cameraGazer._selectionPointerDown()}),s.onbuttonup(o=>{this._interactionsEnabled&&o===0&&this._cameraGazer._selectionPointerUp()})))},this._workingVector=m.Zero(),this._workingQuaternion=J.Identity(),this._workingMatrix=V.Identity(),N.Warn("WebVR is deprecated. Please avoid using this experience helper and use the WebXR experience helper instead"),this._scene=t,this._inputElement=t.getEngine().getInputElement(),!("getVRDisplays"in navigator)&&n.useXR===void 0&&(n.useXR=!0),n.createFallbackVRDeviceOrientationFreeCamera===void 0&&(n.createFallbackVRDeviceOrientationFreeCamera=!0),n.createDeviceOrientationCamera===void 0&&(n.createDeviceOrientationCamera=!0),n.laserToggle===void 0&&(n.laserToggle=!0),this._hasEnteredVR=!1,this._scene.activeCamera?this._position=this._scene.activeCamera.position.clone():this._position=new m(0,this._defaultHeight,0),n.createDeviceOrientationCamera||!this._scene.activeCamera){if(this._deviceOrientationCamera=new Qo("deviceOrientationVRHelper",this._position.clone(),t),this._scene.activeCamera&&(this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ,this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ,this._scene.activeCamera instanceof pn&&this._scene.activeCamera.rotation)){let s=this._scene.activeCamera;s.rotationQuaternion?this._deviceOrientationCamera.rotationQuaternion?.copyFrom(s.rotationQuaternion):this._deviceOrientationCamera.rotationQuaternion?.copyFrom(J.RotationYawPitchRoll(s.rotation.y,s.rotation.x,s.rotation.z)),this._deviceOrientationCamera.rotation=s.rotation.clone()}this._scene.activeCamera=this._deviceOrientationCamera,this._inputElement&&this._scene.activeCamera.attachControl()}else this._existingCamera=this._scene.activeCamera;this.webVROptions.useXR&&navigator.xr?$l.IsSessionSupportedAsync("immersive-vr").then(s=>{s?(N.Log("Using WebXR. It is recommended to use the WebXRDefaultExperience directly"),t.createDefaultXRExperienceAsync({floorMeshes:n.floorMeshes||[]}).then(o=>{this.xr=o,this.xrTestDone=!0,this._cameraGazer=new km(()=>this.xr.baseExperience.camera,t),this.xr.baseExperience.onStateChangedObservable.add(a=>{switch(a){case 0:this.onEnteringVRObservable.notifyObservers(this),this._interactionsEnabled||this.xr.pointerSelection.detach(),this.xr.pointerSelection.displayLaserPointer=this._displayLaserPointer;break;case 1:this.onExitingVRObservable.notifyObservers(this),this._scene.getEngine().resize();break;case 2:this._hasEnteredVR=!0;break;case 3:this._hasEnteredVR=!1;break}})})):this._completeVRInit(t,n)}):this._completeVRInit(t,n)}_completeVRInit(t,n){if(this.xrTestDone=!0,n.createFallbackVRDeviceOrientationFreeCamera&&(this._vrDeviceOrientationCamera=new Ku("VRDeviceOrientationVRHelper",this._position,this._scene,!0,n.vrDeviceOrientationCameraMetrics),this._vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._cameraGazer=new km(()=>this.currentVRCamera,t),!this._useCustomVRButton){this._btnVR=document.createElement("BUTTON"),this._btnVR.className="babylonVRicon",this._btnVR.id="babylonVRiconbtn",this._btnVR.title="Click to switch to VR";let o=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A":"https://cdn.babylonjs.com/Assets/vrButton.png")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";o+=".babylonVRicon.vrdisplaypresenting { display: none; }";let a=document.createElement("style");a.appendChild(document.createTextNode(o)),document.getElementsByTagName("head")[0].appendChild(a),this._moveButtonToBottomRight()}this._btnVR&&this._btnVR.addEventListener("click",()=>{this.isInVRMode||this.enterVR()});let r=this._scene.getEngine().getHostWindow();r&&(r.addEventListener("resize",this._onResize),document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),n.createFallbackVRDeviceOrientationFreeCamera&&this._displayVRButton(),this._onKeyDown=s=>{s.keyCode===27&&this.isInVRMode&&this.exitVR()},document.addEventListener("keydown",this._onKeyDown),this._scene.onPrePointerObservable.add(()=>{this._hasEnteredVR&&this.exitVROnDoubleTap&&(this.exitVR(),this._fullscreenVRpresenting&&this._scene.getEngine().exitFullscreen())},Ae.POINTERDOUBLETAP,!1),t.onDisposeObservable.add(()=>{this.dispose()}),this._updateButtonVisibility(),this._circleEase=new YT,this._circleEase.setEasingMode(ni.EASINGMODE_EASEINOUT),this._teleportationEasing=this._circleEase,t.onPointerObservable.add(s=>{this._interactionsEnabled&&t.activeCamera===this.vrDeviceOrientationCamera&&s.event.pointerType==="mouse"&&(s.type===Ae.POINTERDOWN?this._cameraGazer._selectionPointerDown():s.type===Ae.POINTERUP&&this._cameraGazer._selectionPointerUp())}),this.webVROptions.floorMeshes&&this.enableTeleportation({floorMeshes:this.webVROptions.floorMeshes}))}get isInVRMode(){return this.xr&&this.webVROptions.useXR&&this.xr.baseExperience.state===2||this._fullscreenVRpresenting}_moveButtonToBottomRight(){if(this._inputElement&&!this._useCustomVRButton&&this._btnVR){let t=this._inputElement.getBoundingClientRect();this._btnVR.style.top=t.top+t.height-70+"px",this._btnVR.style.left=t.left+t.width-100+"px"}}_displayVRButton(){!this._useCustomVRButton&&!this._btnVRDisplayed&&this._btnVR&&(document.body.appendChild(this._btnVR),this._btnVRDisplayed=!0)}_updateButtonVisibility(){!this._btnVR||this._useCustomVRButton||(this._btnVR.className="babylonVRicon",this.isInVRMode&&(this._btnVR.className+=" vrdisplaypresenting"))}enterVR(){if(this.xr){this.xr.baseExperience.enterXRAsync("immersive-vr","local-floor",this.xr.renderTarget);return}if(this.onEnteringVRObservable)try{this.onEnteringVRObservable.notifyObservers(this)}catch(t){N.Warn("Error in your custom logic onEnteringVR: "+t)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone(),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.rotation=J.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles(),this.vrDeviceOrientationCamera.angularSensibility=2e3),this._existingCamera=this._scene.activeCamera,this._existingCamera.angularSensibilityX&&(this._cachedAngularSensibility.angularSensibilityX=this._existingCamera.angularSensibilityX,this._existingCamera.angularSensibilityX=Number.MAX_VALUE),this._existingCamera.angularSensibilityY&&(this._cachedAngularSensibility.angularSensibilityY=this._existingCamera.angularSensibilityY,this._existingCamera.angularSensibilityY=Number.MAX_VALUE),this._existingCamera.angularSensibility&&(this._cachedAngularSensibility.angularSensibility=this._existingCamera.angularSensibility,this._existingCamera.angularSensibility=Number.MAX_VALUE)),this._vrDeviceOrientationCamera&&(this._vrDeviceOrientationCamera.position=this._position,this._scene.activeCamera&&(this._vrDeviceOrientationCamera.minZ=this._scene.activeCamera.minZ),this._scene.activeCamera=this._vrDeviceOrientationCamera,this._scene.getEngine().enterFullscreen(this.requestPointerLockOnFullScreen),this._updateButtonVisibility(),this._vrDeviceOrientationCamera.onViewMatrixChangedObservable.addOnce(()=>{this.onAfterEnteringVRObservable.notifyObservers({success:!0})})),this._scene.activeCamera&&this._inputElement&&this._scene.activeCamera.attachControl(),this._interactionsEnabled&&this._scene.registerBeforeRender(this._beforeRender),this._hasEnteredVR=!0}exitVR(){if(this.xr){this.xr.baseExperience.exitXRAsync();return}if(this._hasEnteredVR){if(this.onExitingVRObservable)try{this.onExitingVRObservable.notifyObservers(this)}catch(t){N.Warn("Error in your custom logic onExitingVR: "+t)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone()),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._deviceOrientationCamera?(this._deviceOrientationCamera.position=this._position,this._scene.activeCamera=this._deviceOrientationCamera,this._cachedAngularSensibility.angularSensibilityX&&(this._deviceOrientationCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._deviceOrientationCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._deviceOrientationCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)):this._existingCamera&&(this._existingCamera.position=this._position,this._scene.activeCamera=this._existingCamera,this._inputElement&&this._scene.activeCamera.attachControl(),this._cachedAngularSensibility.angularSensibilityX&&(this._existingCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._existingCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._existingCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)),this._updateButtonVisibility(),this._interactionsEnabled&&(this._scene.unregisterBeforeRender(this._beforeRender),this._cameraGazer._gazeTracker.isVisible=!1),this._scene.getEngine().resize(),this._hasEnteredVR=!1}}get position(){return this._position}set position(t){this._position=t,this._scene.activeCamera&&(this._scene.activeCamera.position=t)}enableInteractions(){if(!this._interactionsEnabled){if(this.xr){this.xr.baseExperience.state===2&&this.xr.pointerSelection.attach();return}this.raySelectionPredicate=t=>t.isVisible&&(t.isPickable||t.name===this._floorMeshName),this.meshSelectionPredicate=()=>!0,this._raySelectionPredicate=t=>this._isTeleportationFloor(t)||t.name.indexOf("gazeTracker")===-1&&t.name.indexOf("teleportationTarget")===-1&&t.name.indexOf("torusTeleportation")===-1?this.raySelectionPredicate(t):!1,this._interactionsEnabled=!0}}_isTeleportationFloor(t){for(let n=0;n<this._floorMeshesCollection.length;n++)if(this._floorMeshesCollection[n].id===t.id)return!0;return!!(this._floorMeshName&&t.name===this._floorMeshName)}addFloorMesh(t){this._floorMeshesCollection&&(this._floorMeshesCollection.indexOf(t)>-1||this._floorMeshesCollection.push(t))}removeFloorMesh(t){if(!this._floorMeshesCollection)return;let n=this._floorMeshesCollection.indexOf(t);n!==-1&&this._floorMeshesCollection.splice(n,1)}enableTeleportation(t={}){if(!this._teleportationInitialized){if(this.enableInteractions(),this.webVROptions.useXR&&(t.floorMeshes||t.floorMeshName)){let r=t.floorMeshes||[];if(!r.length){let s=this._scene.getMeshByName(t.floorMeshName);s&&r.push(s)}if(this.xr){for(let s of r)this.xr.teleportation.addFloorMesh(s);this.xr.teleportation.attached||this.xr.teleportation.attach();return}else if(!this.xrTestDone){let s=()=>{this.xrTestDone&&(this._scene.unregisterBeforeRender(s),this.xr?this.xr.teleportation.attached||this.xr.teleportation.attach():this.enableTeleportation(t))};this._scene.registerBeforeRender(s);return}}t.floorMeshName&&(this._floorMeshName=t.floorMeshName),t.floorMeshes&&(this._floorMeshesCollection=t.floorMeshes),t.teleportationMode&&(this._teleportationMode=t.teleportationMode),t.teleportationTime&&t.teleportationTime>0&&(this._teleportationTime=t.teleportationTime),t.teleportationSpeed&&t.teleportationSpeed>0&&(this._teleportationSpeed=t.teleportationSpeed),t.easingFunction!==void 0&&(this._teleportationEasing=t.easingFunction);let n=new gi;n.vignetteColor=new le(0,0,0,0),n.vignetteEnabled=!0,this._teleportationInitialized=!0,this._isDefaultTeleportationTarget&&this._createTeleportationCircles()}}_checkTeleportWithRay(t,n){this._teleportationRequestInitiated&&!n._teleportationRequestInitiated||(n._teleportationRequestInitiated?Math.sqrt(t.y*t.y+t.x*t.x)<this._padSensibilityDown&&(this._teleportActive&&this.teleportCamera(this._haloCenter),n._teleportationRequestInitiated=!1):t.y<-this._padSensibilityUp&&n._dpadPressed&&(n._activatePointer(),n._teleportationRequestInitiated=!0))}_checkRotate(t,n){n._teleportationRequestInitiated||(n._rotationLeftAsked?t.x>-this._padSensibilityDown&&(n._rotationLeftAsked=!1):t.x<-this._padSensibilityUp&&n._dpadPressed&&(n._rotationLeftAsked=!0,this._rotationAllowed&&this._rotateCamera(!1)),n._rotationRightAsked?t.x<this._padSensibilityDown&&(n._rotationRightAsked=!1):t.x>this._padSensibilityUp&&n._dpadPressed&&(n._rotationRightAsked=!0,this._rotationAllowed&&this._rotateCamera(!0)))}_checkTeleportBackwards(t,n){if(!n._teleportationRequestInitiated)if(t.y>this._padSensibilityUp&&n._dpadPressed){if(!n._teleportationBackRequestInitiated){if(!this.currentVRCamera)return;let r=J.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix()),s=this.currentVRCamera.position;r.toEulerAnglesToRef(this._workingVector),this._workingVector.z=0,this._workingVector.x=0,J.RotationYawPitchRollToRef(this._workingVector.y,this._workingVector.x,this._workingVector.z,this._workingQuaternion),this._workingQuaternion.toRotationMatrix(this._workingMatrix),m.TransformCoordinatesToRef(this._teleportBackwardsVector,this._workingMatrix,this._workingVector);let o=new pt(s,this._workingVector),a=this._scene.pickWithRay(o,this._raySelectionPredicate);a&&a.pickedPoint&&a.pickedMesh&&this._isTeleportationFloor(a.pickedMesh)&&a.distance<5&&this.teleportCamera(a.pickedPoint),n._teleportationBackRequestInitiated=!0}}else n._teleportationBackRequestInitiated=!1}_createTeleportationCircles(){this._teleportationTarget=Yo("teleportationTarget",{width:2,height:2,subdivisions:2},this._scene),this._teleportationTarget.isPickable=!1;let t=512,n=new Vr("DynamicTexture",t,this._scene,!0);n.hasAlpha=!0;let r=n.getContext(),s=t/2,o=t/2,a=200;r.beginPath(),r.arc(s,o,a,0,2*Math.PI,!1),r.fillStyle=this._teleportationFillColor,r.fill(),r.lineWidth=10,r.strokeStyle=this._teleportationBorderColor,r.stroke(),r.closePath(),n.update();let l=new Z("TextPlaneMaterial",this._scene);l.diffuseTexture=n,this._teleportationTarget.material=l;let c=ur("torusTeleportation",{diameter:.75,thickness:.1,tessellation:25,updatable:!1},this._scene);c.isPickable=!1,c.parent=this._teleportationTarget;let u=new H("animationInnerCircle","position.y",30,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CYCLE),h=[];h.push({frame:0,value:0}),h.push({frame:30,value:.4}),h.push({frame:60,value:0}),u.setKeys(h);let d=new kh;d.setEasingMode(ni.EASINGMODE_EASEINOUT),u.setEasingFunction(d),c.animations=[],c.animations.push(u),this._scene.beginAnimation(c,0,60,!0),this._hideTeleportationTarget()}_hideTeleportationTarget(){this._teleportActive=!1,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!1,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!1))}_rotateCamera(t){if(!(this.currentVRCamera instanceof Ot))return;t?this._rotationAngle++:this._rotationAngle--,this.currentVRCamera.animations=[];let n=J.FromRotationMatrix(V.RotationY(Math.PI/4*this._rotationAngle)),r=new H("animationRotation","rotationQuaternion",90,H.ANIMATIONTYPE_QUATERNION,H.ANIMATIONLOOPMODE_CONSTANT),s=[];s.push({frame:0,value:this.currentVRCamera.rotationQuaternion}),s.push({frame:6,value:n}),r.setKeys(s),r.setEasingFunction(this._circleEase),this.currentVRCamera.animations.push(r),this._postProcessMove.animations=[];let o=new H("animationPP","vignetteWeight",90,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CONSTANT),a=[];a.push({frame:0,value:0}),a.push({frame:3,value:4}),a.push({frame:6,value:0}),o.setKeys(a),o.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(o);let l=new H("animationPP2","vignetteStretch",90,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CONSTANT),c=[];c.push({frame:0,value:0}),c.push({frame:3,value:10}),c.push({frame:6,value:0}),l.setKeys(c),l.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(l),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._postProcessMove.samples=4,this._scene.beginAnimation(this.currentVRCamera,0,6,!1,1)}teleportCamera(t){if(!(this.currentVRCamera instanceof Ot))return;this._workingVector.copyFrom(t),this.isInVRMode||(this._workingVector.y+=this._defaultHeight),this.onBeforeCameraTeleport.notifyObservers(this._workingVector);let n=90,r,s;if(this._teleportationMode==i.TELEPORTATIONMODE_CONSTANTSPEED){s=n;let f=m.Distance(this.currentVRCamera.position,this._workingVector);r=this._teleportationSpeed/f}else s=Math.round(this._teleportationTime*n/1e3),r=1;this.currentVRCamera.animations=[];let o=new H("animationCameraTeleportation","position",n,H.ANIMATIONTYPE_VECTOR3,H.ANIMATIONLOOPMODE_CONSTANT),a=[{frame:0,value:this.currentVRCamera.position},{frame:s,value:this._workingVector}];o.setKeys(a),o.setEasingFunction(this._teleportationEasing),this.currentVRCamera.animations.push(o),this._postProcessMove.animations=[];let l=Math.round(s/2),c=new H("animationPP","vignetteWeight",n,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CONSTANT),u=[];u.push({frame:0,value:0}),u.push({frame:l,value:8}),u.push({frame:s,value:0}),c.setKeys(u),this._postProcessMove.animations.push(c);let h=new H("animationPP2","vignetteStretch",n,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CONSTANT),d=[];d.push({frame:0,value:0}),d.push({frame:l,value:10}),d.push({frame:s,value:0}),h.setKeys(d),this._postProcessMove.animations.push(h),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._scene.beginAnimation(this.currentVRCamera,0,s,!1,r,()=>{this.onAfterCameraTeleport.notifyObservers(this._workingVector)}),this._hideTeleportationTarget()}setLaserColor(t,n=this._pickedLaserColor){this._pickedLaserColor=n}setLaserLightingState(t=!0){}setGazeColor(t,n=this._pickedGazeColor){this._pickedGazeColor=n}changeLaserColor(t){this.updateControllerLaserColor}changeGazeColor(t){this.updateGazeTrackerColor&&this._cameraGazer._gazeTracker.material&&(this._cameraGazer._gazeTracker.material.emissiveColor=t)}dispose(){this.isInVRMode&&this.exitVR(),this._postProcessMove&&this._postProcessMove.dispose(),this._vrDeviceOrientationCamera&&this._vrDeviceOrientationCamera.dispose(),!this._useCustomVRButton&&this._btnVR&&this._btnVR.parentNode&&document.body.removeChild(this._btnVR),this._deviceOrientationCamera&&this._scene.activeCamera!=this._deviceOrientationCamera&&this._deviceOrientationCamera.dispose(),this._cameraGazer&&this._cameraGazer.dispose(),this._teleportationTarget&&this._teleportationTarget.dispose(),this.xr&&this.xr.dispose(),this._floorMeshesCollection.length=0,document.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),window.removeEventListener("resize",this._onResize),document.removeEventListener("fullscreenchange",this._onFullscreenChange),this._scene.gamepadManager.onGamepadConnectedObservable.removeCallback(this._onNewGamepadConnected),this._scene.unregisterBeforeRender(this._beforeRender)}getClassName(){return"VRExperienceHelper"}}return i.TELEPORTATIONMODE_CONSTANTTIME=0,i.TELEPORTATIONMODE_CONSTANTSPEED=1,i})();var Qu=class i extends Ot{constructor(e,t,n){super(e,m.Zero(),t),this._xrSessionManager=n,this._firstFrame=!1,this._referenceQuaternion=J.Identity(),this._referencedPosition=new m,this._trackingState=0,this.onXRCameraInitializedObservable=new B,this.onBeforeCameraTeleport=new B,this.onAfterCameraTeleport=new B,this.onTrackingStateChanged=new B,this.compensateOnFirstFrame=!0,this.minZ=.1,this.rotationQuaternion=new J,this.cameraRigMode=Ne.RIG_MODE_CUSTOM,this.updateUpVectorFromRotation=!0,this._updateNumberOfRigCameras(1),this.freezeProjectionMatrix(),this._deferOnly=!0,this._xrSessionManager.onXRSessionInit.add(()=>{this._referencedPosition.copyFromFloats(0,0,0),this._referenceQuaternion.copyFromFloats(0,0,0,1),this._firstFrame=this.compensateOnFirstFrame,this._xrSessionManager.onWorldScaleFactorChangedObservable.add(()=>{this._xrSessionManager.currentFrame&&this._updateDepthNearFar()})}),this._xrSessionManager.onXRFrameObservable.add(()=>{this._firstFrame&&this._updateFromXRSession(),this.onXRCameraInitializedObservable.hasObservers()&&(this.onXRCameraInitializedObservable.notifyObservers(this),this.onXRCameraInitializedObservable.clear()),this._deferredUpdated&&(this.position.copyFrom(this._deferredPositionUpdate),this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate)),this._updateReferenceSpace(),this._updateFromXRSession()},void 0,!0)}get trackingState(){return this._trackingState}_setTrackingState(e){this._trackingState!==e&&(this._trackingState=e,this.onTrackingStateChanged.notifyObservers(e))}get realWorldHeight(){let e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.baseReferenceSpace);return e&&e.transform?e.transform.position.y*this._xrSessionManager.worldScalingFactor:0}_updateForDualEyeDebugging(){this._updateNumberOfRigCameras(2),this.rigCameras[0].viewport=new vs(0,0,.5,1),this.rigCameras[0].outputRenderTarget=null,this.rigCameras[1].viewport=new vs(.5,0,.5,1),this.rigCameras[1].outputRenderTarget=null}setTransformationFromNonVRCamera(e=this.getScene().activeCamera,t=!0){if(!e||e===this)return;e.computeWorldMatrix().decompose(void 0,this.rotationQuaternion,this.position),this.position.y=0,J.FromEulerAnglesToRef(0,this.rotationQuaternion.toEulerAngles().y,0,this.rotationQuaternion),this._firstFrame=!0,t&&this._xrSessionManager.resetReferenceSpace()}getClassName(){return"WebXRCamera"}setTarget(e){let t=U.Vector3[1];e.subtractToRef(this.position,t),t.y=0,t.normalize();let n=Math.atan2(t.x,t.z)+(this._scene.useRightHandedSystem?Math.PI:0);this.rotationQuaternion.toEulerAnglesToRef(t),J.FromEulerAnglesToRef(t.x,n,t.z,this.rotationQuaternion)}dispose(){super.dispose(),this._lastXRViewerPose=void 0,this.onTrackingStateChanged.clear()}_updateDepthNearFar(){let e=(this.maxZ||1e4)*this._xrSessionManager.worldScalingFactor,t={depthFar:e,depthNear:this.minZ};this._xrSessionManager.updateRenderState(t),this._cache.minZ=this.minZ,this._cache.maxZ=e}_updateFromXRSession(){let e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.referenceSpace);if(this._lastXRViewerPose=e||void 0,!e){this._setTrackingState(0);return}let t=e.emulatedPosition?1:2;if(this._setTrackingState(t),(this.minZ!==this._cache.minZ||this.maxZ!==this._cache.maxZ)&&this._updateDepthNearFar(),e.transform){let n=e.transform.orientation;if(e.transform.orientation.x===void 0)return;let r=e.transform.position;this._referencedPosition.set(r.x,r.y,r.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),this._referenceQuaternion.set(n.x,n.y,n.z,n.w),this._scene.useRightHandedSystem||(this._referencedPosition.z*=-1,this._referenceQuaternion.z*=-1,this._referenceQuaternion.w*=-1),this._firstFrame?(this._firstFrame=!1,this.position.y+=this._referencedPosition.y,this._referenceQuaternion.copyFromFloats(0,0,0,1)):(this.rotationQuaternion.copyFrom(this._referenceQuaternion),this.position.copyFrom(this._referencedPosition))}this.rigCameras.length!==e.views.length&&this._updateNumberOfRigCameras(e.views.length);for(let n=0;n<e.views.length;n++){let r=e.views[n],s=this.rigCameras[n];!s.isLeftCamera&&!s.isRightCamera&&(r.eye==="right"?s._isRightCamera=!0:r.eye==="left"&&(s._isLeftCamera=!0));let o=this.getScene().customRenderTargets;for(let h=0;h<o.length;h++){let d=o[h];s.customRenderTargets.indexOf(d)===-1&&s.customRenderTargets.push(d)}let a=r.transform.position,l=r.transform.orientation;s.parent=this.parent,s.position.set(a.x,a.y,a.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),s.rotationQuaternion?.set(l.x,l.y,l.z,l.w),!this._scene.useRightHandedSystem&&s.rotationQuaternion&&(s.position.z*=-1,s.rotationQuaternion.z*=-1,s.rotationQuaternion.w*=-1),V.FromFloat32ArrayToRefScaled(r.projectionMatrix,0,1,s._projectionMatrix),this._scene.useRightHandedSystem||s._projectionMatrix.toggleProjectionMatrixHandInPlace();let c=Math.atan2(1,r.projectionMatrix[5])*2;s.fov=c,n===0&&(this.fov=c,this._projectionMatrix.copyFrom(s._projectionMatrix));let u=this._xrSessionManager.getRenderTargetTextureForView(r);this._renderingMultiview=u?._texture?.isMultiview||!1,this._renderingMultiview?n==0&&(this._xrSessionManager.trySetViewportForView(this.viewport,r),this.outputRenderTarget=u):(this._xrSessionManager.trySetViewportForView(s.viewport,r),s.outputRenderTarget=u||this._xrSessionManager.getRenderTargetTextureForView(r)),s.layerMask=this.layerMask}}_updateNumberOfRigCameras(e=1){for(;this.rigCameras.length<e;){let t=new pn("XR-RigCamera: "+this.rigCameras.length,m.Zero(),this.getScene());t.minZ=.1,t.rotationQuaternion=new J,t.updateUpVectorFromRotation=!0,t.isRigCamera=!0,t.rigParent=this,t.freezeProjectionMatrix(),this.rigCameras.push(t)}for(;this.rigCameras.length>e;){let t=this.rigCameras.pop();t&&t.dispose()}}_updateReferenceSpace(){if(!this.position.equals(this._referencedPosition)||!this.rotationQuaternion.equals(this._referenceQuaternion)){let e=U.Matrix[0],t=U.Matrix[1],n=U.Matrix[2];V.ComposeToRef(i._ScaleReadOnly,this._referenceQuaternion,this._referencedPosition,e),V.ComposeToRef(i._ScaleReadOnly,this.rotationQuaternion,this.position,t),e.invert().multiplyToRef(t,n),n.invert(),this._scene.useRightHandedSystem||n.toggleModelMatrixHandInPlace(),n.decompose(void 0,this._referenceQuaternion,this._referencedPosition);let r=new XRRigidTransform({x:this._referencedPosition.x/this._xrSessionManager.worldScalingFactor,y:this._referencedPosition.y/this._xrSessionManager.worldScalingFactor,z:this._referencedPosition.z/this._xrSessionManager.worldScalingFactor,w:1},{x:this._referenceQuaternion.x,y:this._referenceQuaternion.y,z:this._referenceQuaternion.z,w:this._referenceQuaternion.w});this._xrSessionManager.referenceSpace=this._xrSessionManager.referenceSpace.getOffsetReferenceSpace(r)}}};Qu._ScaleReadOnly=m.One();var di=(()=>{class i{}return i.ANCHOR_SYSTEM="xr-anchor-system",i.BACKGROUND_REMOVER="xr-background-remover",i.HIT_TEST="xr-hit-test",i.MESH_DETECTION="xr-mesh-detection",i.PHYSICS_CONTROLLERS="xr-physics-controller",i.PLANE_DETECTION="xr-plane-detection",i.POINTER_SELECTION="xr-controller-pointer-selection",i.TELEPORTATION="xr-controller-teleportation",i.FEATURE_POINTS="xr-feature-points",i.HAND_TRACKING="xr-hand-tracking",i.IMAGE_TRACKING="xr-image-tracking",i.NEAR_INTERACTION="xr-near-interaction",i.DOM_OVERLAY="xr-dom-overlay",i.MOVEMENT="xr-controller-movement",i.LIGHT_ESTIMATION="xr-light-estimation",i.EYE_TRACKING="xr-eye-tracking",i.WALKING_LOCOMOTION="xr-walking-locomotion",i.LAYERS="xr-layers",i.DEPTH_SENSING="xr-depth-sensing",i.SPACE_WARP="xr-space-warp",i.RAW_CAMERA_ACCESS="xr-raw-camera-access",i})(),fi=class i{constructor(e){this._xrSessionManager=e,this._features={},this._xrSessionManager.onXRSessionInit.add(()=>{let t=this.getEnabledFeatures();for(let n of t){let r=this._features[n];r.enabled&&!r.featureImplementation.attached&&!r.featureImplementation.disableAutoAttach&&this.attachFeature(n)}}),this._xrSessionManager.onXRSessionEnded.add(()=>{let t=this.getEnabledFeatures();for(let n of t){let r=this._features[n];r.enabled&&r.featureImplementation.attached&&this.detachFeature(n)}})}static AddWebXRFeature(e,t,n=1,r=!1){this._AvailableFeatures[e]=this._AvailableFeatures[e]||{latest:n},n>this._AvailableFeatures[e].latest&&(this._AvailableFeatures[e].latest=n),r&&(this._AvailableFeatures[e].stable=n),this._AvailableFeatures[e][n]=t}static ConstructFeature(e,t=1,n,r){let s=this._AvailableFeatures[e][t];if(!s)throw new Error("feature not found");return s(n,r)}static GetAvailableFeatures(){return Object.keys(this._AvailableFeatures)}static GetAvailableVersions(e){return Object.keys(this._AvailableFeatures[e])}static GetLatestVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].latest||-1}static GetStableVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].stable||-1}attachFeature(e){let t=this._features[e];t&&t.enabled&&!t.featureImplementation.attached&&(t.featureImplementation.attach()||z.Warn(`Feature ${e} failed to attach`))}detachFeature(e){let t=this._features[e];t&&t.featureImplementation.attached&&(t.featureImplementation.detach()||z.Warn(`Feature ${e} failed to detach`))}disableFeature(e){let t=typeof e=="string"?e:e.Name,n=this._features[t];return n&&n.enabled?(n.enabled=!1,this.detachFeature(t),n.featureImplementation.dispose(),delete this._features[t],!0):!1}dispose(){let e=this.getEnabledFeatures();for(let t of e)this.disableFeature(t)}enableFeature(e,t="latest",n={},r=!0,s=!0){let o=typeof e=="string"?e:e.Name,a=0;if(typeof t=="string"){if(!t)throw new Error(`Error in provided version - ${o} (${t})`);if(t==="stable"?a=i.GetStableVersionOfFeature(o):t==="latest"?a=i.GetLatestVersionOfFeature(o):a=+t,a===-1||isNaN(a))throw new Error(`feature not found - ${o} (${t})`)}else a=t;let l=i._ConflictingFeatures[o];if(l!==void 0&&this.getEnabledFeatures().indexOf(l)!==-1)throw new Error(`Feature ${o} cannot be enabled while ${l} is enabled.`);let c=this._features[o],u=i.ConstructFeature(o,a,this._xrSessionManager,n);if(!u)throw new Error(`feature not found - ${o}`);c&&this.disableFeature(o);let h=u();if(h.dependsOn&&!h.dependsOn.every(f=>!!this._features[f]))throw new Error(`Dependant features missing. Make sure the following features are enabled - ${h.dependsOn.join(", ")}`);if(h.isCompatible())return this._features[o]={featureImplementation:h,enabled:!0,version:a,required:s},r?this._xrSessionManager.session&&!this._features[o].featureImplementation.attached&&this.attachFeature(o):this._features[o].featureImplementation.disableAutoAttach=!0,this._features[o].featureImplementation;if(s)throw new Error("required feature not compatible");return z.Warn(`Feature ${o} not compatible with the current environment/browser and was not enabled.`),h}getEnabledFeature(e){return this._features[e]&&this._features[e].featureImplementation}getEnabledFeatures(){return Object.keys(this._features)}_extendXRSessionInitObject(e){return T(this,null,function*(){let t=this.getEnabledFeatures();for(let n of t){let r=this._features[n],s=r.featureImplementation.xrNativeFeatureName;if(s&&(r.required?(e.requiredFeatures=e.requiredFeatures||[],e.requiredFeatures.indexOf(s)===-1&&e.requiredFeatures.push(s)):(e.optionalFeatures=e.optionalFeatures||[],e.optionalFeatures.indexOf(s)===-1&&e.optionalFeatures.push(s))),r.featureImplementation.getXRSessionInitExtension){let o=yield r.featureImplementation.getXRSessionInitExtension();e=K(K({},e),o)}}return e})}};fi._AvailableFeatures={};fi._ConflictingFeatures={[di.TELEPORTATION]:di.MOVEMENT,[di.MOVEMENT]:di.TELEPORTATION};kt.AddNodeConstructor("TouchCamera",(i,e)=>()=>new Ju(i,m.Zero(),e));var Ju=class extends Ot{get touchAngularSensibility(){let e=this.inputs.attached.touch;return e?e.touchAngularSensibility:0}set touchAngularSensibility(e){let t=this.inputs.attached.touch;t&&(t.touchAngularSensibility=e)}get touchMoveSensibility(){let e=this.inputs.attached.touch;return e?e.touchMoveSensibility:0}set touchMoveSensibility(e){let t=this.inputs.attached.touch;t&&(t.touchMoveSensibility=e)}constructor(e,t,n){super(e,t,n),this.inputs.addTouch(),this._setupInputs()}getClassName(){return"TouchCamera"}_setupInputs(){let e=this.inputs.attached.touch,t=this.inputs.attached.mouse;t?t.touchEnabled=!e:e.allowMouse=!t}};kt.AddNodeConstructor("FreeCamera",(i,e)=>()=>new Wl(i,m.Zero(),e));var Wl=class extends Ju{get gamepadAngularSensibility(){let e=this.inputs.attached.gamepad;return e?e.gamepadAngularSensibility:0}set gamepadAngularSensibility(e){let t=this.inputs.attached.gamepad;t&&(t.gamepadAngularSensibility=e)}get gamepadMoveSensibility(){let e=this.inputs.attached.gamepad;return e?e.gamepadMoveSensibility:0}set gamepadMoveSensibility(e){let t=this.inputs.attached.gamepad;t&&(t.gamepadMoveSensibility=e)}constructor(e,t,n){super(e,t,n),this.inputs.addGamepad()}getClassName(){return"UniversalCamera"}};Ne._CreateDefaultParsedCamera=(i,e)=>new Wl(i,m.Zero(),e);var Bm=class i{constructor(e){this._scene=e,this._nonVRCamera=null,this._attachedToElement=!1,this._spectatorCamera=null,this._originalSceneAutoClear=!0,this._supported=!1,this._spectatorMode=!1,this._lastTimestamp=0,this.onInitialXRPoseSetObservable=new B,this.onStateChangedObservable=new B,this.state=3,this.sessionManager=new $l(e),this.camera=new Qu("webxr",e,this.sessionManager),this.featuresManager=new fi(this.sessionManager),e.onDisposeObservable.addOnce(()=>{this.dispose()})}static CreateAsync(e){return T(this,null,function*(){let t=new i(e);return yield t.sessionManager.initializeAsync().then(()=>(t._supported=!0,t)).catch(n=>{throw t._setState(3),t.dispose(),n})})}dispose(){this.exitXRAsync(),this.camera.dispose(),this.onStateChangedObservable.clear(),this.onInitialXRPoseSetObservable.clear(),this.sessionManager.dispose(),this._spectatorCamera?.dispose(),this._nonVRCamera&&(this._scene.activeCamera=this._nonVRCamera)}enterXRAsync(s,o){return T(this,arguments,function*(e,t,n=this.sessionManager.getWebXRRenderTarget(),r={}){if(!this._supported)throw"WebXR not supported in this browser or environment";this._setState(0),t!=="viewer"&&t!=="local"&&(r.optionalFeatures=r.optionalFeatures||[],r.optionalFeatures.push(t)),r=yield this.featuresManager._extendXRSessionInitObject(r),e==="immersive-ar"&&t!=="unbounded"&&N.Warn("We recommend using 'unbounded' reference space type when using 'immersive-ar' session mode");try{yield this.sessionManager.initializeSessionAsync(e,r),yield this.sessionManager.setReferenceSpaceTypeAsync(t);let a={depthFar:this.camera.maxZ||1e4,depthNear:this.camera.minZ};if(!this.featuresManager.getEnabledFeature(di.LAYERS)){let l=yield n.initializeXRLayerAsync(this.sessionManager.session);a.baseLayer=l}return this.sessionManager.updateRenderState(a),this.sessionManager.runXRRenderLoop(),this._originalSceneAutoClear=this._scene.autoClear,this._nonVRCamera=this._scene.activeCamera,this._attachedToElement=!!this._nonVRCamera?.inputs?.attachedToElement,this._nonVRCamera?.detachControl(),this._scene.activeCamera=this.camera,e!=="immersive-ar"?this._nonXRToXRCamera():(this._scene.autoClear=!1,this.camera.compensateOnFirstFrame=!1,this.camera.position.set(0,0,0),this.camera.rotationQuaternion.set(0,0,0,1),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)),ne.audioEngine?._resumeAudioContextOnStateChange(),this.sessionManager.onXRSessionEnded.addOnce(()=>{this.state!==1&&this._setState(1);for(let l of this.camera.rigCameras)l.outputRenderTarget=null;this._scene.autoClear=this._originalSceneAutoClear,this._scene.activeCamera=this._nonVRCamera,this._attachedToElement&&this._nonVRCamera&&this._nonVRCamera.attachControl(!!this._nonVRCamera.inputs.noPreventDefault),e!=="immersive-ar"&&this.camera.compensateOnFirstFrame&&(this._nonVRCamera.setPosition?this._nonVRCamera.setPosition(this.camera.position):this._nonVRCamera.position.copyFrom(this.camera.position)),this._setState(3)}),this.sessionManager.onXRFrameObservable.addOnce(()=>{this._setState(2)}),this.sessionManager}catch(a){throw N.Log(a),N.Log(a.message),this._setState(3),a}})}exitXRAsync(){return T(this,null,function*(){if(this.state===2)return this._setState(1),yield this.sessionManager.exitXRAsync()})}enableSpectatorMode(e){this._spectatorMode||(this._spectatorMode=!0,this._switchSpectatorMode(e))}disableSpecatatorMode(){this._spectatorMode&&(this._spectatorMode=!1,this._switchSpectatorMode())}_switchSpectatorMode(e){let n=1/(e?.fps?e.fps:1e3)*1e3,r=e?.preferredCameraIndex?e?.preferredCameraIndex:0,s=()=>{this._spectatorCamera&&this.sessionManager.currentTimestamp-this._lastTimestamp>=n&&(this._lastTimestamp=this.sessionManager.currentTimestamp,this._spectatorCamera.position.copyFrom(this.camera.rigCameras[r].globalPosition),this._spectatorCamera.rotationQuaternion?.copyFrom(this.camera.rigCameras[r].absoluteRotation))};if(this._spectatorMode){if(r>=this.camera.rigCameras.length)throw new Error("the preferred camera index is beyond the length of rig camera array.");let o=()=>{this.state===2?(this._spectatorCamera=new Wl("webxr-spectator",m.Zero(),this._scene),this._spectatorCamera.rotationQuaternion=new J,this._scene.activeCameras=[this.camera,this._spectatorCamera],this.sessionManager.onXRFrameObservable.add(s),this._scene.onAfterRenderCameraObservable.add(a=>{a===this.camera&&(this._scene.getEngine().framebufferDimensionsObject=null)})):this.state===1&&(this.sessionManager.onXRFrameObservable.removeCallback(s),this._scene.activeCameras=null)};this.onStateChangedObservable.add(o),o()}else this.sessionManager.onXRFrameObservable.removeCallback(s),this._scene.activeCameras=[this.camera]}_nonXRToXRCamera(){this.camera.setTransformationFromNonVRCamera(this._nonVRCamera),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)}_setState(e){this.state!==e&&(this.state=e,this.onStateChangedObservable.notifyObservers(this.state))}};var Ks=(()=>{class i{constructor(t,n,r=-1,s=[]){this.id=t,this.type=n,this._buttonIndex=r,this._axesIndices=s,this._axes={x:0,y:0},this._changes={},this._currentValue=0,this._hasChanges=!1,this._pressed=!1,this._touched=!1,this.onAxisValueChangedObservable=new B,this.onButtonStateChangedObservable=new B}get axes(){return this._axes}get changes(){return this._changes}get hasChanges(){return this._hasChanges}get pressed(){return this._pressed}get touched(){return this._touched}get value(){return this._currentValue}dispose(){this.onAxisValueChangedObservable.clear(),this.onButtonStateChangedObservable.clear()}isAxes(){return this._axesIndices.length!==0}isButton(){return this._buttonIndex!==-1}update(t){let n=!1,r=!1;if(this._hasChanges=!1,this._changes={},this.isButton()){let s=t.buttons[this._buttonIndex];if(!s)return;this._currentValue!==s.value&&(this.changes.value={current:s.value,previous:this._currentValue},n=!0,this._currentValue=s.value),this._touched!==s.touched&&(this.changes.touched={current:s.touched,previous:this._touched},n=!0,this._touched=s.touched),this._pressed!==s.pressed&&(this.changes.pressed={current:s.pressed,previous:this._pressed},n=!0,this._pressed=s.pressed)}this.isAxes()&&(this._axes.x!==t.axes[this._axesIndices[0]]&&(this.changes.axes={current:{x:t.axes[this._axesIndices[0]],y:this._axes.y},previous:{x:this._axes.x,y:this._axes.y}},this._axes.x=t.axes[this._axesIndices[0]],r=!0),this._axes.y!==t.axes[this._axesIndices[1]]&&(this.changes.axes?this.changes.axes.current.y=t.axes[this._axesIndices[1]]:this.changes.axes={current:{x:this._axes.x,y:t.axes[this._axesIndices[1]]},previous:{x:this._axes.x,y:this._axes.y}},this._axes.y=t.axes[this._axesIndices[1]],r=!0)),n&&(this._hasChanges=!0,this.onButtonStateChangedObservable.notifyObservers(this)),r&&(this._hasChanges=!0,this.onAxisValueChangedObservable.notifyObservers(this._axes))}}return i.BUTTON_TYPE="button",i.SQUEEZE_TYPE="squeeze",i.THUMBSTICK_TYPE="thumbstick",i.TOUCHPAD_TYPE="touchpad",i.TRIGGER_TYPE="trigger",i})();var jl=class{constructor(e,t,n,r,s=!1,o){if(this.scene=e,this.layout=t,this.gamepadObject=n,this.handedness=r,this._doNotLoadControllerMesh=s,this._controllerCache=o,this._initComponent=a=>{if(!a)return;let l=this.layout.components[a],c=l.type,u=l.gamepadIndices.button,h=[];l.gamepadIndices.xAxis!==void 0&&l.gamepadIndices.yAxis!==void 0&&h.push(l.gamepadIndices.xAxis,l.gamepadIndices.yAxis),this.components[a]=new Ks(a,c,u,h)},this._modelReady=!1,this.components={},this.disableAnimation=!1,this.onModelLoadedObservable=new B,t.components){let a=Object.keys(t.components);for(let l of a)this._initComponent(l)}}dispose(){let e=this.getComponentIds();for(let t of e)this.getComponent(t).dispose();if(this.rootMesh){let t=this.rootMesh.getChildren(void 0,!0);for(let n of t)n.setEnabled(!1);this.rootMesh.dispose(!!this._controllerCache,!this._controllerCache)}this.onModelLoadedObservable.clear()}getAllComponentsOfType(e){return this.getComponentIds().map(t=>this.components[t]).filter(t=>t.type===e)}getComponent(e){return this.components[e]}getComponentIds(){return Object.keys(this.components)}getComponentOfType(e){return this.getAllComponentsOfType(e)[0]||null}getMainComponent(){return this.getComponent(this.layout.selectComponentId)}loadModel(){return T(this,null,function*(){let e=!this._getModelLoadingConstraints(),t=this._getGenericFilenameAndPath();return e?N.Warn("Falling back to generic models"):t=this._getFilenameAndPath(),yield new Promise((n,r)=>{let s=o=>{e?this._getGenericParentMesh(o):this._setRootMesh(o),this._processLoadedModel(o),this._modelReady=!0,this.onModelLoadedObservable.notifyObservers(this),n(!0)};if(this._controllerCache){let o=this._controllerCache.filter(a=>a.filename===t.filename&&a.path===t.path);if(o[0]){for(let a of o[0].meshes)a.setEnabled(!0);s(o[0].meshes);return}}Bo.ImportMesh("",t.path,t.filename,this.scene,o=>{this._controllerCache&&this._controllerCache.push(ct(K({},t),{meshes:o})),s(o)},null,(o,a)=>{N.Log(a),N.Warn(`Failed to retrieve controller model of type ${this.profileId} from the remote server: ${t.path}${t.filename}`),r(a)})})})}updateFromXRFrame(e){for(let t of this.getComponentIds())this.getComponent(t).update(this.gamepadObject);this.updateModel(e)}get handness(){return this.handedness}pulse(e,t,n=0){return T(this,null,function*(){return this.gamepadObject.hapticActuators&&this.gamepadObject.hapticActuators[n]?yield this.gamepadObject.hapticActuators[n].pulse(e,t):!1})}_getChildByName(e,t){return e.getChildren(n=>n.name===t,!1)[0]}_getImmediateChildByName(e,t){return e.getChildren(n=>n.name==t,!0)[0]}_lerpTransform(e,t,n){if(!e.minMesh||!e.maxMesh||!e.valueMesh||!e.minMesh.rotationQuaternion||!e.maxMesh.rotationQuaternion||!e.valueMesh.rotationQuaternion)return;let r=n?t*.5+.5:t;J.SlerpToRef(e.minMesh.rotationQuaternion,e.maxMesh.rotationQuaternion,r,e.valueMesh.rotationQuaternion),m.LerpToRef(e.minMesh.position,e.maxMesh.position,r,e.valueMesh.position)}updateModel(e){this._modelReady&&this._updateModel(e)}_getGenericFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getGenericParentMesh(e){this.rootMesh=new A(this.profileId+" "+this.handedness,this.scene);for(let t of e)t.parent||(t.isPickable=!1,t.setParent(this.rootMesh));this.rootMesh.rotationQuaternion=J.FromEulerAngles(0,Math.PI,0)}};var CC=(()=>{class i extends jl{constructor(t,n,r){super(t,iB[r],n,r),this.profileId=i.ProfileId}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(t){}_setRootMesh(t){this.rootMesh=new A(this.profileId+" "+this.handedness,this.scene);for(let n of t)n.isPickable=!1,n.parent||n.setParent(this.rootMesh);this.rootMesh.rotationQuaternion=J.FromEulerAngles(0,Math.PI,0)}_updateModel(){}}return i.ProfileId="generic-trigger",i})(),iB={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-none",assetPath:"none.glb"}};var Vm=class extends jl{constructor(e,t,n,r,s){super(e,n.layouts[t.handedness||"none"],t.gamepad,t.handedness,void 0,s),this._repositoryUrl=r,this.controllerCache=s,this._buttonMeshMapping={},this._touchDots={},this.profileId=n.profileId}dispose(){if(super.dispose(),!this.controllerCache){let e=Object.keys(this._touchDots);for(let t of e)this._touchDots[t].dispose()}}_getFilenameAndPath(){return{filename:this.layout.assetPath,path:`${this._repositoryUrl}/profiles/${this.profileId}/`}}_getModelLoadingConstraints(){let e=Bo.IsPluginForExtensionAvailable(".glb");return e||N.Warn("glTF / glb loader was not registered, using generic controller instead"),e}_processLoadedModel(e){let t=this.getComponentIds();for(let n of t){let r=this.layout.components[n];this._buttonMeshMapping[n]={mainMesh:this._getChildByName(this.rootMesh,r.rootNodeName),states:{}};let s=Object.keys(r.visualResponses);for(let o of s){let a=r.visualResponses[o];if(a.valueNodeProperty==="transform")this._buttonMeshMapping[n].states[o]={valueMesh:this._getChildByName(this.rootMesh,a.valueNodeName),minMesh:this._getChildByName(this.rootMesh,a.minNodeName),maxMesh:this._getChildByName(this.rootMesh,a.maxNodeName)};else{let l=r.type===Ks.TOUCHPAD_TYPE&&r.touchPointNodeName?r.touchPointNodeName:a.valueNodeName;if(this._buttonMeshMapping[n].states[o]={valueMesh:this._getChildByName(this.rootMesh,l)},r.type===Ks.TOUCHPAD_TYPE&&!this._touchDots[o]){let c=js(o+"dot",{diameter:.0015,segments:8},this.scene);c.material=new Z(o+"mat",this.scene),c.material.diffuseColor=G.Red(),c.parent=this._buttonMeshMapping[n].states[o].valueMesh||null,c.isVisible=!1,this._touchDots[o]=c}}}}}_setRootMesh(e){this.rootMesh=new A(this.profileId+"-"+this.handedness,this.scene),this.rootMesh.isPickable=!1;let t;for(let n=0;n<e.length;n++){let r=e[n];r.isPickable=!1,r.parent||(t=r)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||this.rootMesh.rotate(Vn.Y,Math.PI,1)}_updateModel(e){if(this.disableAnimation)return;let t=this.getComponentIds();for(let n of t){let r=this.getComponent(n);if(!r.hasChanges)continue;let s=this._buttonMeshMapping[n],o=this.layout.components[n],a=Object.keys(o.visualResponses);for(let l of a){let c=o.visualResponses[l],u=r.value;if(c.componentProperty==="xAxis"?u=r.axes.x:c.componentProperty==="yAxis"&&(u=r.axes.y),c.valueNodeProperty==="transform")this._lerpTransform(s.states[l],u,c.componentProperty!=="button");else{let h=s.states[l].valueMesh;h&&(h.isVisible=r.touched||r.pressed),this._touchDots[l]&&(this._touchDots[l].isVisible=r.touched||r.pressed)}}}}};var TC=[],ji=(()=>{class i{static ClearProfilesCache(){this._ProfilesList=null,this._ProfileLoadingPromises={}}static DefaultFallbacks(){this.RegisterFallbacksForProfileId("google-daydream",["generic-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive-focus",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("magicleap-one",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("windows-mixed-reality",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("microsoft-mixed-reality",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-go",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("oculus-touch-v2",["oculus-touch","generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-touch",["generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-gearvr",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-odyssey",["generic-touchpad"]),this.RegisterFallbacksForProfileId("valve-index",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("generic-hand-select",["generic-trigger"]),this.RegisterFallbacksForProfileId("oculus-hand",["generic-trigger"])}static FindFallbackWithProfileId(t){let n=this._Fallbacks[t]||[];return n.unshift(t),n}static GetMotionControllerWithXRInput(t,n,r){return T(this,null,function*(){let s=[];if(r&&s.push(r),s.push(...t.profiles||[]),s.length&&!s[0]&&s.pop(),t.gamepad&&t.gamepad.id)switch(t.gamepad.id){case(t.gamepad.id.match(/oculus touch/gi)?t.gamepad.id:void 0):s.push("oculus-touch-v2");break}let o=s.indexOf("windows-mixed-reality");if(o!==-1&&s.splice(o,0,"microsoft-mixed-reality"),s.length||s.push("generic-trigger"),this.UseOnlineRepository){let a=this.PrioritizeOnlineRepository?this._LoadProfileFromRepositoryAsync:this._LoadProfilesFromAvailableControllersAsync,l=this.PrioritizeOnlineRepository?this._LoadProfilesFromAvailableControllersAsync:this._LoadProfileFromRepositoryAsync;return a.call(this,s,t,n).catch(()=>l.call(this,s,t,n))}else return yield this._LoadProfilesFromAvailableControllersAsync(s,t,n)})}static RegisterController(t,n){this._AvailableControllers[t]=n}static RegisterFallbacksForProfileId(t,n){this._Fallbacks[t]?this._Fallbacks[t].push(...n):this._Fallbacks[t]=n}static UpdateProfilesList(){return T(this,null,function*(){let t=yield z.LoadFileAsync(this.BaseRepositoryUrl+"/profiles/profilesList.json",!1);return this._ProfilesList=JSON.parse(t),yield this._ProfilesList})}static ClearControllerCache(){for(let t of TC)for(let n of t.meshes)n.dispose(!1,!0);TC.length=0}static _LoadProfileFromRepositoryAsync(t,n,r){return T(this,null,function*(){return yield Promise.resolve().then(()=>T(this,null,function*(){return this._ProfilesList?yield this._ProfilesList:yield this.UpdateProfilesList()})).then(s=>{for(let o=0;o<t.length;++o)if(t[o]&&s[t[o]])return t[o];throw new Error(`neither controller ${t[0]} nor all fallbacks were found in the repository,`)}).then(s=>T(this,null,function*(){return this._ProfileLoadingPromises[s]||(this._ProfileLoadingPromises[s]=z.LoadFileAsync(`${this.BaseRepositoryUrl}/profiles/${s}/profile.json`,!1).then(o=>JSON.parse(o))),yield this._ProfileLoadingPromises[s]})).then(s=>new Vm(r,n,s,this.BaseRepositoryUrl,this.DisableControllerCache?void 0:TC))})}static _LoadProfilesFromAvailableControllersAsync(t,n,r){return T(this,null,function*(){for(let s=0;s<t.length;++s){if(!t[s])continue;let o=this.FindFallbackWithProfileId(t[s]);for(let a=0;a<o.length;++a){let l=this._AvailableControllers[o[a]];if(l)return l(n,r)}}throw new Error("no controller requested was found in the available controllers list")})}}return i._AvailableControllers={},i._Fallbacks={},i._ProfileLoadingPromises={},i.BaseRepositoryUrl="https://immersive-web.github.io/webxr-input-profiles/packages/viewer/dist",i.PrioritizeOnlineRepository=!0,i.UseOnlineRepository=!0,i.DisableControllerCache=!0,i})();ji.RegisterController(CC.ProfileId,(i,e)=>new CC(e,i.gamepad,i.handedness));ji.DefaultFallbacks();var rB=0,Gm=class{constructor(e,t,n={}){this._scene=e,this.inputSource=t,this._options=n,this._tmpVector=new m,this._disposed=!1,this.onDisposeObservable=new B,this.onMeshLoadedObservable=new B,this.onMotionControllerInitObservable=new B,this._uniqueId=`controller-${rB++}-${t.targetRayMode}-${t.handedness}`,this.pointer=new A(`${this._uniqueId}-pointer`,e),this.pointer.rotationQuaternion=new J,this.inputSource.gripSpace&&(this.grip=new A(`${this._uniqueId}-grip`,this._scene),this.grip.rotationQuaternion=new J),this._tmpVector.set(0,0,this._scene.useRightHandedSystem?-1:1),this.inputSource.gamepad&&this.inputSource.targetRayMode==="tracked-pointer"&&ji.GetMotionControllerWithXRInput(t,e,this._options.forceControllerProfile).then(r=>{this.motionController=r,this.onMotionControllerInitObservable.notifyObservers(r),!this._options.doNotLoadControllerMesh&&!this.motionController._doNotLoadControllerMesh&&this.motionController.loadModel().then(s=>{if(s&&this.motionController&&this.motionController.rootMesh){if(this._options.renderingGroupId){this.motionController.rootMesh.renderingGroupId=this._options.renderingGroupId;let o=this.motionController.rootMesh.getChildMeshes(!1);for(let a of o)a.renderingGroupId=this._options.renderingGroupId}this.onMeshLoadedObservable.notifyObservers(this.motionController.rootMesh),this.motionController.rootMesh.parent=this.grip||this.pointer,this.motionController.disableAnimation=!!this._options.disableMotionControllerAnimation}this._disposed&&this.motionController?.dispose()})},()=>{z.Warn("Could not find a matching motion controller for the registered input source")})}get uniqueId(){return this._uniqueId}dispose(){this.grip&&this.grip.dispose(!0),this.motionController&&this.motionController.dispose(),this.pointer.dispose(!0),this.onMotionControllerInitObservable.clear(),this.onMeshLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._disposed=!0}getWorldPointerRayToRef(e,t=!1){let n=t&&this.grip?this.grip:this.pointer;m.TransformNormalToRef(this._tmpVector,n.getWorldMatrix(),e.direction),e.direction.normalize(),e.origin.copyFrom(n.absolutePosition),e.length=1e3}updateFromXRFrame(e,t,n,r){let s=e.getPose(this.inputSource.targetRaySpace,t);if(this._lastXRPose=s,s){let o=s.transform.position;this.pointer.position.set(o.x,o.y,o.z).scaleInPlace(r.worldScalingFactor);let a=s.transform.orientation;this.pointer.rotationQuaternion.set(a.x,a.y,a.z,a.w),this._scene.useRightHandedSystem||(this.pointer.position.z*=-1,this.pointer.rotationQuaternion.z*=-1,this.pointer.rotationQuaternion.w*=-1),this.pointer.parent=n.parent,this.pointer.scaling.setAll(r.worldScalingFactor)}if(this.inputSource.gripSpace&&this.grip){let o=e.getPose(this.inputSource.gripSpace,t);if(o){let a=o.transform.position,l=o.transform.orientation;this.grip.position.set(a.x,a.y,a.z).scaleInPlace(r.worldScalingFactor),this.grip.rotationQuaternion.set(l.x,l.y,l.z,l.w),this._scene.useRightHandedSystem||(this.grip.position.z*=-1,this.grip.rotationQuaternion.z*=-1,this.grip.rotationQuaternion.w*=-1)}this.grip.parent=n.parent,this.grip.scaling.setAll(r.worldScalingFactor)}this.motionController&&this.motionController.updateFromXRFrame(e)}};var Um=class{constructor(e,t,n={}){if(this.xrSessionManager=e,this.xrCamera=t,this._options=n,this.controllers=[],this.onControllerAddedObservable=new B,this.onControllerRemovedObservable=new B,this._onInputSourcesChange=r=>{this._addAndRemoveControllers(r.added,r.removed)},this._sessionEndedObserver=this.xrSessionManager.onXRSessionEnded.add(()=>{this._addAndRemoveControllers([],this.controllers.map(r=>r.inputSource))}),this._sessionInitObserver=this.xrSessionManager.onXRSessionInit.add(r=>{r.addEventListener("inputsourceschange",this._onInputSourcesChange)}),this._frameObserver=this.xrSessionManager.onXRFrameObservable.add(r=>{for(let s of this.controllers)s.updateFromXRFrame(r,this.xrSessionManager.referenceSpace,this.xrCamera,this.xrSessionManager)}),this._options.customControllersRepositoryURL&&(ji.BaseRepositoryUrl=this._options.customControllersRepositoryURL),ji.UseOnlineRepository=!this._options.disableOnlineControllerRepository,ji.UseOnlineRepository)try{ji.UpdateProfilesList().catch(()=>{ji.UseOnlineRepository=!1})}catch{ji.UseOnlineRepository=!1}}_addAndRemoveControllers(e,t){let n=this.controllers.map(o=>o.inputSource);for(let o of e)if(n.indexOf(o)===-1){let a=new Gm(this.xrSessionManager.scene,o,ct(K({},this._options.controllerOptions||{}),{forceControllerProfile:this._options.forceInputProfile,doNotLoadControllerMesh:this._options.doNotLoadControllerMeshes,disableMotionControllerAnimation:this._options.disableControllerAnimation}));this.controllers.push(a),this.onControllerAddedObservable.notifyObservers(a)}let r=[],s=[];for(let o of this.controllers)t.indexOf(o.inputSource)===-1?r.push(o):s.push(o);this.controllers=r;for(let o of s)this.onControllerRemovedObservable.notifyObservers(o),o.dispose()}dispose(){for(let e of this.controllers)e.dispose();this.xrSessionManager.onXRFrameObservable.remove(this._frameObserver),this.xrSessionManager.onXRSessionInit.remove(this._sessionInitObserver),this.xrSessionManager.onXRSessionEnded.remove(this._sessionEndedObserver),this.onControllerAddedObservable.clear(),this.onControllerRemovedObservable.clear(),ji.ClearControllerCache()}};var Gr=class{get xrNativeFeatureName(){return this._xrNativeFeatureName}set xrNativeFeatureName(e){!this._xrSessionManager.isNative&&e&&this._xrSessionManager.inXRSession&&this._xrSessionManager.enabledFeatures?.indexOf(e)===-1&&N.Warn(`The feature ${e} needs to be enabled before starting the XR session. Note - It is still possible it is not supported.`),this._xrNativeFeatureName=e}constructor(e){this._xrSessionManager=e,this._attached=!1,this._removeOnDetach=[],this.isDisposed=!1,this.disableAutoAttach=!1,this._xrNativeFeatureName="",this.onFeatureAttachObservable=new B,this.onFeatureDetachObservable=new B}get attached(){return this._attached}attach(e){if(this.isDisposed)return!1;if(e)this.attached&&this.detach();else if(this.attached)return!1;if(!this._xrSessionManager.enabledFeatures)N.Warn("session.enabledFeatures is not available on this device. It is possible that this feature is not supported.");else if(!this._xrSessionManager.isNative&&this.xrNativeFeatureName&&this._xrSessionManager.enabledFeatures.indexOf(this.xrNativeFeatureName)===-1)return!1;return this._attached=!0,this._addNewAttachObserver(this._xrSessionManager.onXRFrameObservable,t=>this._onXRFrame(t)),this.onFeatureAttachObservable.notifyObservers(this),!0}detach(){if(!this._attached)return this.disableAutoAttach=!0,!1;this._attached=!1;for(let e of this._removeOnDetach)e.observable.remove(e.observer);return this.onFeatureDetachObservable.notifyObservers(this),!0}dispose(){this.detach(),this.isDisposed=!0,this.onFeatureAttachObservable.clear(),this.onFeatureDetachObservable.clear()}isCompatible(){return!0}_addNewAttachObserver(e,t,n){this._removeOnDetach.push({observable:e,observer:e.add(t,void 0,n)})}};var Ur=(()=>{class i{getRenderCamera(t){if(this._renderCamera)return this._renderCamera;{let n;return this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?n=this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:n=this.originalScene.activeCamera,t&&n&&n.isRigCamera?n.rigParent:n}}setRenderCamera(t){this._renderCamera=t}_getSharedGizmoLight(){return this._sharedGizmoLight||(this._sharedGizmoLight=new Pn("shared gizmo light",new m(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=G.Gray()),this._sharedGizmoLight}static get DefaultUtilityLayer(){return i._DefaultUtilityLayer==null?i._CreateDefaultUtilityLayerFromScene(Ie.LastCreatedScene):i._DefaultUtilityLayer}static _CreateDefaultUtilityLayerFromScene(t){return i._DefaultUtilityLayer=new i(t),i._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{i._DefaultUtilityLayer=null}),i._DefaultUtilityLayer}static get DefaultKeepDepthUtilityLayer(){return i._DefaultKeepDepthUtilityLayer==null&&(i._DefaultKeepDepthUtilityLayer=new i(Ie.LastCreatedScene),i._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,i._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{i._DefaultKeepDepthUtilityLayer=null})),i._DefaultKeepDepthUtilityLayer}constructor(t,n=!0,r=!1){this.originalScene=t,this.handleEvents=n,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new B,this.utilityLayerScene=new Pe(t.getEngine(),{virtual:!0,useFloatingOrigin:t.floatingOriginMode}),this.utilityLayerScene.useRightHandedSystem=t.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),n&&(this._originalPointerObserver=t.onPrePointerObservable.add(s=>{if(!this.utilityLayerScene.activeCamera||!this.pickingEnabled||!this.processAllEvents&&s.type!==Ae.POINTERMOVE&&s.type!==Ae.POINTERUP&&s.type!==Ae.POINTERDOWN&&s.type!==Ae.POINTERDOUBLETAP)return;this.utilityLayerScene.pointerX=t.pointerX,this.utilityLayerScene.pointerY=t.pointerY;let o=s.event;if(t.isPointerCaptured(o.pointerId)){this._pointerCaptures[o.pointerId]=!1;return}let a=c=>{let u=null;if(s.nearInteractionPickingInfo)s.nearInteractionPickingInfo.pickedMesh.getScene()==c?u=s.nearInteractionPickingInfo:u=new In;else if(c!==this.utilityLayerScene&&s.originalPickingInfo)u=s.originalPickingInfo;else{let h=null;this._renderCamera&&(h=c._activeCamera,c._activeCamera=this._renderCamera,s.ray=null),u=s.ray?c.pickWithRay(s.ray):c.pick(t.pointerX,t.pointerY),h&&(c._activeCamera=h)}return u},l=a(this.utilityLayerScene);if(!s.ray&&l&&(s.ray=l.ray),s.originalPickingInfo?.aimTransform&&l&&(l.aimTransform=s.originalPickingInfo.aimTransform,l.gripTransform=s.originalPickingInfo.gripTransform),this.utilityLayerScene.onPrePointerObservable.notifyObservers(s),this.onlyCheckPointerDownEvents&&s.type!=Ae.POINTERDOWN){s.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new ph(s.type,s.event,l),s.type),s.type===Ae.POINTERUP&&this._pointerCaptures[o.pointerId]&&(this._pointerCaptures[o.pointerId]=!1);return}if(this.utilityLayerScene.autoClearDepthAndStencil||this.pickUtilitySceneFirst)l&&l.hit&&(s.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new ph(s.type,s.event,l),s.type),s.skipOnPointerObservable=!0);else{let c=a(t),u=s.event;c&&l&&(l.distance===0&&c.pickedMesh?this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(c.pickedMesh)?(this._notifyObservers(s,c,u),s.skipOnPointerObservable=!0):s.type===Ae.POINTERDOWN?(this._pointerCaptures[u.pointerId]=!0,this._notifyObservers(s,c,u)):(s.type===Ae.POINTERMOVE||s.type===Ae.POINTERUP)&&(this._lastPointerEvents[u.pointerId]&&(this.onPointerOutObservable.notifyObservers(u.pointerId),delete this._lastPointerEvents[u.pointerId]),this._notifyObservers(s,c,u)):!this._pointerCaptures[u.pointerId]&&(l.distance<c.distance||c.distance===0)?(this._notifyObservers(s,l,u),s.skipOnPointerObservable||(s.skipOnPointerObservable=l.distance>0)):!this._pointerCaptures[u.pointerId]&&l.distance>=c.distance&&(this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(c.pickedMesh)?(this._notifyObservers(s,c,u),s.skipOnPointerObservable=!0):((s.type===Ae.POINTERMOVE||s.type===Ae.POINTERUP)&&this._lastPointerEvents[u.pointerId]&&(this.onPointerOutObservable.notifyObservers(u.pointerId),delete this._lastPointerEvents[u.pointerId]),this._notifyObservers(s,l,u))),s.type===Ae.POINTERUP&&this._pointerCaptures[u.pointerId]&&(this._pointerCaptures[u.pointerId]=!1))}}),this._originalPointerObserver&&t.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,r||(this._afterRenderObserver=this.originalScene.onAfterRenderCameraObservable.add(s=>{this.shouldRender&&s==this.getRenderCamera()&&this.render()})),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add(()=>{this.dispose()}),this._updateCamera()}_notifyObservers(t,n,r){t.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new ph(t.type,t.event,n),t.type),this._lastPointerEvents[r.pointerId]=!0)}render(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){let t=this.utilityLayerScene.activeCamera.getScene(),n=this.utilityLayerScene.activeCamera;n._scene=this.utilityLayerScene,n.leftCamera&&(n.leftCamera._scene=this.utilityLayerScene),n.rightCamera&&(n.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),n._scene=t,n.leftCamera&&(n.leftCamera._scene=t),n.rightCamera&&(n.rightCamera._scene=t)}}dispose(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()}_updateCamera(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()}}return i._DefaultUtilityLayer=null,i._DefaultKeepDepthUtilityLayer=null,i})();var zr=class i extends Gr{constructor(e,t){super(e),this._options=t,this._attachController=n=>{if(this._controllers[n.uniqueId])return;let{laserPointer:r,selectionMesh:s}=this._generateNewMeshPair(this._options.forceGripIfAvailable&&n.grip?n.grip:n.pointer);switch(this._controllers[n.uniqueId]={xrController:n,laserPointer:r,selectionMesh:s,meshUnderPointer:null,pick:null,tmpRay:new pt(new m,new m),disabledByNearInteraction:!1,id:i._IdCounter++},this._attachedController?!this._options.enablePointerSelectionOnAllControllers&&this._options.preferredHandedness&&n.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=n.uniqueId):this._options.enablePointerSelectionOnAllControllers||(this._attachedController=n.uniqueId),n.inputSource.targetRayMode){case"tracked-pointer":return this._attachTrackedPointerRayMode(n);case"gaze":return this._attachGazeMode(n);case"screen":case"transient-pointer":return this._attachScreenRayMode(n)}},this._controllers={},this._tmpVectorForPickCompare=new m,this.disablePointerLighting=!0,this.disableSelectionMeshLighting=!0,this.displayLaserPointer=!0,this.displaySelectionMesh=!0,this.laserPointerPickedColor=new G(.9,.9,.9),this.laserPointerDefaultColor=new G(.7,.7,.7),this.selectionMeshDefaultColor=new G(.8,.8,.8),this.selectionMeshPickedColor=new G(.3,.3,1),this._identityMatrix=V.Identity(),this._screenCoordinatesRef=m.Zero(),this._viewportRef=new vs(0,0,0,0),this._scene=this._xrSessionManager.scene,this._options.lookAndPickMode===void 0&&(this._scene.getEngine()._badDesktopOS||this._scene.getEngine()._badOS)&&(this._options.lookAndPickMode=!0),this._options.lookAndPickMode&&(this._options.enablePointerSelectionOnAllControllers=!0,this.displayLaserPointer=!1)}attach(){if(!super.attach())return!1;for(let e of this._options.xrInput.controllers)this._attachController(e);if(this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController,!0),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)},!0),this._scene.constantlyUpdateMeshUnderPointer=!0,this._options.gazeCamera){let e=this._options.gazeCamera,{laserPointer:t,selectionMesh:n}=this._generateNewMeshPair(e);this._controllers.camera={webXRCamera:e,laserPointer:t,selectionMesh:n,meshUnderPointer:null,pick:null,tmpRay:new pt(new m,new m),disabledByNearInteraction:!1,id:i._IdCounter++},this._attachGazeMode()}return!0}detach(){if(!super.detach())return!1;let e=Object.keys(this._controllers);for(let t of e)this._detachController(t);return!0}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){let t=Object.keys(this._controllers);for(let n=0;n<t.length;++n)if(this._controllers[t[n]].id===e)return this._controllers[t[n]].xrController||null;return null}_getPointerSelectionDisabledByPointerId(e){let t=Object.keys(this._controllers);for(let n=0;n<t.length;++n)if(this._controllers[t[n]].id===e)return this._controllers[t[n]].disabledByNearInteraction;return!0}_setPointerSelectionDisabledByPointerId(e,t){let n=Object.keys(this._controllers);for(let r=0;r<n.length;++r)if(this._controllers[n[r]].id===e){this._controllers[n[r]].disabledByNearInteraction=t;return}}_onXRFrame(e){let t=Object.keys(this._controllers);for(let n of t){let r=this._controllers[n];if(this._options.lookAndPickMode&&r.xrController?.inputSource.targetRayMode!=="transient-pointer")continue;if(!this._options.enablePointerSelectionOnAllControllers&&n!==this._attachedController||r.disabledByNearInteraction){r.selectionMesh.isVisible=!1,r.laserPointer.isVisible=!1,r.pick=null;continue}r.laserPointer.isVisible=this.displayLaserPointer;let s;if(r.xrController)s=this._options.forceGripIfAvailable&&r.xrController.grip?r.xrController.grip.position:r.xrController.pointer.position,r.xrController.getWorldPointerRayToRef(r.tmpRay,this._options.forceGripIfAvailable);else if(r.webXRCamera)s=r.webXRCamera.position,r.webXRCamera.getForwardRayToRef(r.tmpRay);else continue;if(this._options.maxPointerDistance&&(r.tmpRay.length=this._options.maxPointerDistance),!this._options.disableScenePointerVectorUpdate&&s){let c=this._xrSessionManager.scene,u=this._options.xrInput.xrCamera;u&&(u.viewport.toGlobalToRef(c.getEngine().getRenderWidth()/u.rigCameras.length,c.getEngine().getRenderHeight(),this._viewportRef),m.ProjectToRef(s,this._identityMatrix,u.getTransformationMatrix(),this._viewportRef,this._screenCoordinatesRef),typeof this._screenCoordinatesRef.x=="number"&&typeof this._screenCoordinatesRef.y=="number"&&!isNaN(this._screenCoordinatesRef.x)&&!isNaN(this._screenCoordinatesRef.y)&&this._screenCoordinatesRef.x!==1/0&&this._screenCoordinatesRef.y!==1/0&&(c.pointerX=this._screenCoordinatesRef.x,c.pointerY=this._screenCoordinatesRef.y,r.screenCoordinates={x:this._screenCoordinatesRef.x,y:this._screenCoordinatesRef.y}))}let o=null;this._utilityLayerScene&&(o=this._utilityLayerScene.pickWithRay(r.tmpRay,this._utilityLayerScene.pointerMovePredicate||this.raySelectionPredicate));let a=this._scene.pickWithRay(r.tmpRay,this._scene.pointerMovePredicate||this.raySelectionPredicate);!o||!o.hit?r.pick=a:!a||!a.hit||o.distance<a.distance?r.pick=o:r.pick=a,r.pick&&r.xrController&&(r.pick.aimTransform=r.xrController.pointer,r.pick.gripTransform=r.xrController.grip||null,r.pick.originMesh=r.xrController.pointer,r.tmpRay.length=r.pick.distance);let l=r.pick;if(l&&l.pickedPoint&&l.hit){this._updatePointerDistance(r.laserPointer,l.distance),r.selectionMesh.position.copyFrom(l.pickedPoint),r.selectionMesh.scaling.x=Math.sqrt(l.distance),r.selectionMesh.scaling.y=Math.sqrt(l.distance),r.selectionMesh.scaling.z=Math.sqrt(l.distance);let c=this._convertNormalToDirectionOfRay(l.getNormal(!0),r.tmpRay),u=.001;if(r.selectionMesh.position.copyFrom(l.pickedPoint),c){let h=m.Cross(Vn.Y,c),d=m.Cross(c,h);m.RotationFromAxisToRef(d,c,h,r.selectionMesh.rotation),r.selectionMesh.position.addInPlace(c.scale(u))}r.selectionMesh.isVisible=this.displaySelectionMesh,r.meshUnderPointer=l.pickedMesh}else r.selectionMesh.isVisible=!1,this._updatePointerDistance(r.laserPointer,1),r.meshUnderPointer=null}}get _utilityLayerScene(){return this._options.customUtilityLayerScene||Ur.DefaultUtilityLayer.utilityLayerScene}_attachGazeMode(e){let t=this._controllers[e&&e.uniqueId||"camera"],n=this._options.timeToSelect||3e3,r=this._options.useUtilityLayer?this._utilityLayerScene:this._scene,s=new In,o=ur("selection",{diameter:.0035*15,thickness:.0025*6,tessellation:20},r);o.isVisible=!1,o.isPickable=!1,o.parent=t.selectionMesh;let a=0,l=!1,c={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{if(t.pick){if(this._augmentPointerInit(c,t.id,t.screenCoordinates),t.laserPointer.material.alpha=0,o.isVisible=!1,t.pick.hit)if(this._pickingMoved(s,t.pick))l&&(this._options.disablePointerUpOnTouchOut||this._scene.simulatePointerUp(t.pick,c)),l=!1,a=0;else if(a>n/10&&(o.isVisible=!0),a+=this._scene.getEngine().getDeltaTime(),a>=n)this._scene.simulatePointerDown(t.pick,c),l=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,c),o.isVisible=!1;else{let u=1-a/n;o.scaling.set(u,u,u)}else l=!1,a=0;this._scene.simulatePointerMove(t.pick,c),s=t.pick}}),this._options.renderingGroupId!==void 0&&(o.renderingGroupId=this._options.renderingGroupId),e&&e.onDisposeObservable.addOnce(()=>{t.pick&&!this._options.disablePointerUpOnTouchOut&&l&&(this._scene.simulatePointerUp(t.pick,c),t.finalPointerUpTriggered=!0),o.dispose()})}_attachScreenRayMode(e){let t=this._controllers[e.uniqueId],n=!1,r={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{this._augmentPointerInit(r,t.id,t.screenCoordinates),!(!t.pick||this._options.disablePointerUpOnTouchOut&&n)&&(n?this._scene.simulatePointerMove(t.pick,r):(this._scene.simulatePointerDown(t.pick,r),t.pointerDownTriggered=!0,n=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,r)))}),e.onDisposeObservable.addOnce(()=>{this._augmentPointerInit(r,t.id,t.screenCoordinates),this._xrSessionManager.runInXRFrame(()=>{t.pick&&!t.finalPointerUpTriggered&&n&&!this._options.disablePointerUpOnTouchOut&&(this._scene.simulatePointerUp(t.pick,r),t.finalPointerUpTriggered=!0)})})}_attachTrackedPointerRayMode(e){let t=this._controllers[e.uniqueId];if(this._options.forceGazeMode)return this._attachGazeMode(e);let n={pointerId:t.id,pointerType:"xr"};if(t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{t.laserPointer.material.disableLighting=this.disablePointerLighting,t.selectionMesh.material.disableLighting=this.disableSelectionMeshLighting,t.pick&&(this._augmentPointerInit(n,t.id,t.screenCoordinates),this._scene.simulatePointerMove(t.pick,n))}),e.inputSource.gamepad){let r=s=>{this._options.overrideButtonId&&(t.selectionComponent=s.getComponent(this._options.overrideButtonId)),t.selectionComponent||(t.selectionComponent=s.getMainComponent()),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add(o=>{if(o.changes.pressed){let a=o.changes.pressed.current;if(t.pick)(this._options.enablePointerSelectionOnAllControllers||e.uniqueId===this._attachedController)&&(this._augmentPointerInit(n,t.id,t.screenCoordinates),a?(this._scene.simulatePointerDown(t.pick,n),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor):(this._scene.simulatePointerUp(t.pick,n),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor));else if(a&&!this._options.enablePointerSelectionOnAllControllers&&!this._options.disableSwitchOnClick){let l=this._controllers[this._attachedController];l&&l.pointerDownTriggered&&!l.finalPointerUpTriggered&&(this._augmentPointerInit(n,l.id,l.screenCoordinates),this._scene.simulatePointerUp(new In,{pointerId:l.id,pointerType:"xr"}),l.finalPointerUpTriggered=!0),this._attachedController=e.uniqueId}}})};e.motionController?r(e.motionController):e.onMotionControllerInitObservable.add(r)}else{let r=o=>{this._xrSessionManager.onXRFrameObservable.addOnce(()=>{this._augmentPointerInit(n,t.id,t.screenCoordinates),t.xrController&&o.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerDown(t.pick,n),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor)})},s=o=>{this._xrSessionManager.onXRFrameObservable.addOnce(()=>{this._augmentPointerInit(n,t.id,t.screenCoordinates),t.xrController&&o.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerUp(t.pick,n),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)})};t.eventListeners={selectend:s,selectstart:r},this._xrSessionManager.session.addEventListener("selectstart",r),this._xrSessionManager.session.addEventListener("selectend",s)}}_convertNormalToDirectionOfRay(e,t){return e&&Math.acos(m.Dot(e,t.direction))<Math.PI/2&&e.scaleInPlace(-1),e}_detachController(e){let t=this._controllers[e];if(t){if(t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners){let n=Object.keys(t.eventListeners);for(let r of n){let s=t.eventListeners&&t.eventListeners[r];s&&this._xrSessionManager.session.removeEventListener(r,s)}}if(!t.finalPointerUpTriggered&&t.pointerDownTriggered){let n={pointerId:t.id,pointerType:"xr"};this._xrSessionManager.runInXRFrame(()=>{this._augmentPointerInit(n,t.id,t.screenCoordinates),this._scene.simulatePointerUp(t.pick||new In,n),t.finalPointerUpTriggered=!0})}this._xrSessionManager.scene.onBeforeRenderObservable.addOnce(()=>{try{if(t.selectionMesh.dispose(),t.laserPointer.dispose(),delete this._controllers[e],this._attachedController===e){let n=Object.keys(this._controllers);n.length?this._attachedController=n[0]:this._attachedController=""}}catch{z.Warn("controller already detached.")}})}}_generateNewMeshPair(e){let t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Ur.DefaultUtilityLayer.utilityLayerScene:this._scene,n=this._options.customLasterPointerMeshGenerator?this._options.customLasterPointerMeshGenerator():Xo("laserPointer",{height:1,diameterTop:2e-4,diameterBottom:.004,tessellation:20,subdivisions:1},t);n.parent=e;let r=new Z("laserPointerMat",t);r.emissiveColor=this.laserPointerDefaultColor,r.alpha=.7,n.material=r,n.rotation.x=Math.PI/2,this._updatePointerDistance(n,1),n.isPickable=!1,n.isVisible=!1;let s=this._options.customSelectionMeshGenerator?this._options.customSelectionMeshGenerator():ur("gazeTracker",{diameter:.0035*3,thickness:.0025*3,tessellation:20},t);s.bakeCurrentTransformIntoVertices(),s.isPickable=!1,s.isVisible=!1;let o=new Z("targetMat",t);return o.specularColor=G.Black(),o.emissiveColor=this.selectionMeshDefaultColor,o.backFaceCulling=!1,s.material=o,this._options.renderingGroupId!==void 0&&(n.renderingGroupId=this._options.renderingGroupId,s.renderingGroupId=this._options.renderingGroupId),{laserPointer:n,selectionMesh:s}}_pickingMoved(e,t){if(!e.hit||!t.hit||!e.pickedMesh||!e.pickedPoint||!t.pickedMesh||!t.pickedPoint||e.pickedMesh!==t.pickedMesh)return!0;e.pickedPoint?.subtractToRef(t.pickedPoint,this._tmpVectorForPickCompare),this._tmpVectorForPickCompare.set(Math.abs(this._tmpVectorForPickCompare.x),Math.abs(this._tmpVectorForPickCompare.y),Math.abs(this._tmpVectorForPickCompare.z));let n=(this._options.gazeModePointerMovedFactor||1)*.01*t.distance;return this._tmpVectorForPickCompare.length()>n}_updatePointerDistance(e,t=100){e.scaling.y=t,this._scene.useRightHandedSystem&&(t*=-1),e.position.z=t/2+.05}_augmentPointerInit(e,t,n){e.pointerId=t,e.pointerType="xr",n&&(e.screenX=n.x,e.screenY=n.y)}get lasterPointerDefaultColor(){return this.laserPointerDefaultColor}};zr._IdCounter=200;zr.Name=di.POINTER_SELECTION;zr.Version=1;fi.AddWebXRFeature(zr.Name,(i,e)=>()=>new zr(i,e),zr.Version,!0);var P=(function(i){return i[i.Float=1]="Float",i[i.Int=2]="Int",i[i.Vector2=4]="Vector2",i[i.Vector3=8]="Vector3",i[i.Vector4=16]="Vector4",i[i.Color3=32]="Color3",i[i.Color4=64]="Color4",i[i.Matrix=128]="Matrix",i[i.Object=256]="Object",i[i.AutoDetect=1024]="AutoDetect",i[i.BasedOnInput=2048]="BasedOnInput",i[i.All=4095]="All",i})(P||{});var Y=(function(i){return i[i.Vertex=1]="Vertex",i[i.Fragment=2]="Fragment",i[i.Neutral=4]="Neutral",i[i.VertexAndFragment=3]="VertexAndFragment",i})(Y||{});var eh=class{constructor(){this.supportUniformBuffers=!1,this.attributes=[],this.uniforms=[],this.constants=[],this.samplers=[],this.functions={},this.extensions={},this.prePassOutput={},this.counters={},this._terminalBlocks=new Set,this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._injectAtTop="",this._customEntryHeader="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}get shaderLanguage(){return this.sharedData.nodeMaterial.shaderLanguage}get fSuffix(){return this.shaderLanguage===1?"f":""}getProcessedShaderAsync(e){return T(this,null,function*(){if(!this._builtCompilationString)return N.Error("getProcessedShaderAsync: Shader not built yet."),"";let t=this.sharedData.nodeMaterial.getScene().getEngine(),n={defines:e.split(`
`),indexParameters:void 0,isFragment:this.target===Y.Fragment,shouldUseHighPrecisionShader:t._shouldUseHighPrecisionShader,processor:t._getShaderProcessor(this.shaderLanguage),supportsUniformBuffers:t.supportsUniformBuffers,shadersRepository:gt.GetShadersRepository(this.shaderLanguage),includesShadersStore:gt.GetIncludesShadersStore(this.shaderLanguage),version:(t.version*100).toString(),platformName:t.shaderPlatformName,processingContext:null,isNDCHalfZRange:t.isNDCHalfZRange,useReverseDepthBuffer:t.useReverseDepthBuffer};return!t.isWebGPU&&t.version>1&&(n.processor=new _T),yield new Promise(r=>{sT(this._builtCompilationString,n,(s,o)=>{r(s)},t)})})}finalize(e){let t=e.sharedData.emitComments,n=this.target===Y.Fragment,r=`
${t?`//Entry point
`:""}`;this._customEntryHeader?r+=this._customEntryHeader:this.shaderLanguage===1?n?r+=`@fragment
fn main(input: FragmentInputs) -> FragmentOutputs {
${this.sharedData.varyingInitializationsFragment}`:r+=`@vertex
fn main(input: VertexInputs) -> FragmentInputs{
`:r+=`void main(void) {
`,this.compilationString=r+this.compilationString,this._constantDeclaration&&(this.compilationString=`
${t?`//Constants
`:""}${this._constantDeclaration}
${this.compilationString}`);let s="";for(let o in this.functions)s+=this.functions[o]+`
`;if(this.compilationString=`
${s}
${this.compilationString}`,!n&&this._varyingTransfer&&(this.compilationString=`${this.compilationString}
${this._varyingTransfer}`),this._injectAtEnd&&(this.compilationString=`${this.compilationString}
${this._injectAtEnd}`),this.compilationString=`${this.compilationString}
}`,this.sharedData.varyingDeclaration&&(this.compilationString=`
${t?`//Varyings
`:""}${n?this.sharedData.varyingDeclarationFragment:this.sharedData.varyingDeclaration}
${this.compilationString}`),this._samplerDeclaration&&(this.compilationString=`
${t?`//Samplers
`:""}${this._samplerDeclaration}
${this.compilationString}`),this._uniformDeclaration&&(this.compilationString=`
${t?`//Uniforms
`:""}${this._uniformDeclaration}
${this.compilationString}`),this._attributeDeclaration&&!n&&(this.compilationString=`
${t?`//Attributes
`:""}${this._attributeDeclaration}
${this.compilationString}`),this.shaderLanguage!==1){this.compilationString=`precision highp float;
`+this.compilationString,this.compilationString=`#if defined(WEBGL2) || defined(WEBGPU)
precision highp sampler2DArray;
#endif
`+this.compilationString,n&&(this.compilationString=`#if defined(PREPASS)\r
#extension GL_EXT_draw_buffers : require\r
layout(location = 0) out highp vec4 glFragData[SCENE_MRT_COUNT];\r
highp vec4 gl_FragColor;\r
#endif\r
`+this.compilationString);for(let o in this.extensions){let a=this.extensions[o];this.compilationString=`
${a}
${this.compilationString}`}}this._injectAtTop&&(this.compilationString=`${this._injectAtTop}
${this.compilationString}`),this._builtCompilationString=this.compilationString}get _repeatableContentAnchor(){return`###___ANCHOR${this._repeatableContentAnchorIndex++}___###`}_getFreeVariableName(e){return e=this.sharedData.formatConfig.formatVariablename(e),this.sharedData.variableNames[e]===void 0?(this.sharedData.variableNames[e]=0,e==="output"||e==="texture"?e+this.sharedData.variableNames[e]:e):(this.sharedData.variableNames[e]++,e+this.sharedData.variableNames[e])}_getFreeDefineName(e){return this.sharedData.defineNames[e]===void 0?this.sharedData.defineNames[e]=0:this.sharedData.defineNames[e]++,e+this.sharedData.defineNames[e]}_excludeVariableName(e){this.sharedData.variableNames[e]=0}_emit2DSampler(e,t="",n=!1,r,s,o){if(this.samplers.indexOf(e)<0||n){if(t&&(this._samplerDeclaration+=`#if ${t}
`),this.shaderLanguage===1){let a=s?"u":"f";this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;
`,this._samplerDeclaration+=`var ${e}: texture_2d<${a}32>;
`}else{let a=s?"u":"",l=o??"";this._samplerDeclaration+=`uniform ${l} ${a}sampler2D ${e}; ${r||""}
`}t&&(this._samplerDeclaration+=`#endif
`),n||this.samplers.push(e)}}_emitCubeSampler(e,t="",n=!1){(this.samplers.indexOf(e)<0||n)&&(t&&(this._samplerDeclaration+=`#if ${t}
`),this.shaderLanguage===1?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;
`,this._samplerDeclaration+=`var ${e}: texture_cube<f32>;
`):this._samplerDeclaration+=`uniform samplerCube ${e};
`,t&&(this._samplerDeclaration+=`#endif
`),n||this.samplers.push(e))}_emit2DArraySampler(e){this.samplers.indexOf(e)<0&&(this.shaderLanguage===1?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;
`,this._samplerDeclaration+=`var ${e}: texture_2d_array<f32>;
`):this._samplerDeclaration+=`uniform sampler2DArray ${e};
`,this.samplers.push(e))}_getGLType(e){switch(e){case P.Float:return"float";case P.Int:return"int";case P.Vector2:return"vec2";case P.Color3:case P.Vector3:return"vec3";case P.Color4:case P.Vector4:return"vec4";case P.Matrix:return"mat4"}return""}_getShaderType(e){let t=this.shaderLanguage===1;switch(e){case P.Float:return t?"f32":"float";case P.Int:return t?"i32":"int";case P.Vector2:return t?"vec2f":"vec2";case P.Color3:case P.Vector3:return t?"vec3f":"vec3";case P.Color4:case P.Vector4:return t?"vec4f":"vec4";case P.Matrix:return t?"mat4x4f":"mat4"}return""}_emitExtension(e,t,n=""){this.extensions[e]||(n&&(t=`#if ${n}
${t}
#endif`),this.extensions[e]=t)}_emitFunction(e,t,n){this.functions[e]||(this.sharedData.emitComments&&(t=n+`
`+t),this.functions[e]=t)}_emitCodeFromInclude(e,t,n){let r=gt.GetIncludesShadersStore(this.shaderLanguage);if(n&&n.repeatKey)return`#include<${e}>${n.substitutionVars?"("+n.substitutionVars+")":""}[0..${n.repeatKey}]
`;let s=r[e]+`
`;if(this.sharedData.emitComments&&(s=t+`
`+s),!n)return s;if(n.replaceStrings)for(let o=0;o<n.replaceStrings.length;o++){let a=n.replaceStrings[o];s=s.replace(a.search,a.replace)}return s}_emitFunctionFromInclude(e,t,n,r=""){let s=e+r;if(this.functions[s])return;let o=gt.GetIncludesShadersStore(this.shaderLanguage);if(!n||!n.removeAttributes&&!n.removeUniforms&&!n.removeVaryings&&!n.removeIfDef&&!n.replaceStrings){n&&n.repeatKey?this.functions[s]=`#include<${e}>${n.substitutionVars?"("+n.substitutionVars+")":""}[0..${n.repeatKey}]
`:this.functions[s]=`#include<${e}>${n?.substitutionVars?"("+n?.substitutionVars+")":""}
`,this.sharedData.emitComments&&(this.functions[s]=t+`
`+this.functions[s]);return}if(this.functions[s]=o[e],this.sharedData.emitComments&&(this.functions[s]=t+`
`+this.functions[s]),n.removeIfDef&&(this.functions[s]=this.functions[s].replace(/^\s*?#ifdef.+$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#endif.*$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#else.*$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#elif.*$/gm,"")),n.removeAttributes&&(this.functions[s]=this.functions[s].replace(/\s*?attribute .+?;/g,`
`)),n.removeUniforms&&(this.functions[s]=this.functions[s].replace(/\s*?uniform .*?;/g,`
`)),n.removeVaryings&&(this.functions[s]=this.functions[s].replace(/\s*?(varying|in) .+?;/g,`
`)),n.replaceStrings)for(let a=0;a<n.replaceStrings.length;a++){let l=n.replaceStrings[a];this.functions[s]=this.functions[s].replace(l.search,l.replace)}}_registerTempVariable(e){return this.sharedData.temps.indexOf(e)!==-1?!1:(this.sharedData.temps.push(e),!0)}_emitDefineStart(e,t=!1){let n="";return e&&(e.startsWith("defined(")?n=`#if ${e}
`:n=`${t?"#ifndef":"#ifdef"} ${e}
`),n}_emitDefineEnd(e){return e?`#endif
`:""}_emitVaryingFromString(e,t,n="",r=!1){if(this.sharedData.varyings.indexOf(e)!==-1)return!1;this.sharedData.varyings.push(e);let s=this._getShaderType(t),o=(a=!1)=>{let l=this._emitDefineStart(n,r);if(this.shaderLanguage===1)switch(s){case"i32":case"f32":case"vec2f":case"vec3f":case"vec4f":l+=`varying ${e}: ${s};
`,a&&(l+=`var<private> ${e}: ${s};
`,this.sharedData.varyingInitializationsFragment+=this._emitDefineStart(n,r)+`${e} = fragmentInputs.${e};
`+this._emitDefineEnd(n));break;case"mat4x4f":l+=`varying ${e}_r0: vec4f;
`,l+=`varying ${e}_r1: vec4f;
`,l+=`varying ${e}_r2: vec4f;
`,l+=`varying ${e}_r3: vec4f;
`,a&&(l+=`var<private> ${e}: mat4x4f;
`,this.sharedData.varyingInitializationsFragment+=this._emitDefineStart(n,r)+`${e} = mat4x4f(fragmentInputs.${e}_r0, fragmentInputs.${e}_r1, fragmentInputs.${e}_r2, fragmentInputs.${e}_r3);
`+this._emitDefineEnd(n));break;default:l+=`varying ${e}: ${s};
`;break}else l+=`varying ${s} ${e};
`;return l+=this._emitDefineEnd(n),l};if(this.shaderLanguage===1)this.sharedData.varyingDeclaration+=o(!1),this.sharedData.varyingDeclarationFragment+=o(!0);else{let a=o();this.sharedData.varyingDeclaration+=a,this.sharedData.varyingDeclarationFragment+=a}return!0}_getVaryingName(e){return this.shaderLanguage===1?(this.target!==Y.Fragment?"vertexOutputs.":"fragmentInputs.")+e:e}_emitUniformFromString(e,t,n="",r=!1){if(this.uniforms.indexOf(e)!==-1)return;this.uniforms.push(e),n&&(n.startsWith("defined(")?this._uniformDeclaration+=`#if ${n}
`:this._uniformDeclaration+=`${r?"#ifndef":"#ifdef"} ${n}
`),this.sharedData.formatConfig.getUniformAnnotation&&(this._uniformDeclaration+=this.sharedData.formatConfig.getUniformAnnotation(e));let s=this._getShaderType(t);this.shaderLanguage===1?this._uniformDeclaration+=`uniform ${e}: ${s};
`:this._uniformDeclaration+=`uniform ${s} ${e};
`,n&&(this._uniformDeclaration+=`#endif
`)}_generateTernary(e,t,n){return this.shaderLanguage===1?`select(${t}, ${e}, ${n})`:`(${n}) ? ${e} : ${t}`}_emitFloat(e){return e.toString()===e.toFixed(0)?`${e}.0`:e.toString()}_declareOutput(e,t){return this._declareLocalVar(e.associatedVariableName,e.type,t)}_declareLocalVar(e,t,n,r){return this.shaderLanguage===1?`${n?"const":"var"+(r?"<private>":"")} ${e}: ${this._getShaderType(t)}`:`${n?"const ":""}${this._getShaderType(t)} ${e}`}_samplerCubeFunc(){return this.shaderLanguage===1?"textureSample":"textureCube"}_samplerFunc(){return this.shaderLanguage===1?"textureSample":"texture2D"}_samplerLODFunc(){return this.shaderLanguage===1?"textureSampleLevel":"texture2DLodEXT"}_toLinearSpace(e){return this.shaderLanguage===1?e.type===P.Color3||e.type===P.Vector3?`toLinearSpaceVec3(${e.associatedVariableName})`:`toLinearSpace(${e.associatedVariableName})`:`toLinearSpace(${e.associatedVariableName})`}_generateTextureSample(e,t){return this.shaderLanguage===1?`${this._samplerFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerFunc()}(${t}, ${e})`}_generateTextureSampleLOD(e,t,n){return this.shaderLanguage===1?`${this._samplerLODFunc()}(${t},${t+"Sampler"}, ${e}, ${n})`:`${this._samplerLODFunc()}(${t}, ${e}, ${n})`}_generateTextureSampleCube(e,t){return this.shaderLanguage===1?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerCubeFunc()}(${t}, ${e})`}_generateTextureSampleCubeLOD(e,t,n){return this.shaderLanguage===1?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e}, ${n})`:`${this._samplerCubeFunc()}(${t}, ${e}, ${n})`}_convertVariableDeclarationToWGSL(e,t,n){return n.replace(new RegExp(`(${e})\\s+(\\w+)`,"g"),`var $2: ${t}`)}_convertVariableConstructorsToWGSL(e,t,n){return n.replace(new RegExp(`(${e})\\(`,"g"),` ${t}(`)}_convertOutParametersToWGSL(e){return e.replace(new RegExp("out\\s+var\\s+(\\w+)\\s*:\\s*(\\w+)","g"),"$1: ptr<function, $2>")}_convertTernaryOperandsToWGSL(e){return e.replace(new RegExp("\\[(.*?)\\?(.*?):(.*)\\]","g"),(t,n,r,s)=>`select(${s}, ${r}, ${n})`)}_convertModOperatorsToWGSL(e){return e.replace(new RegExp("mod\\((.+?),\\s*(.+?)\\)","g"),(t,n,r)=>`((${n})%(${r}))`)}_convertConstToWGSL(e){return e.replace(new RegExp("const var","g"),"const")}_convertInnerFunctionsToWGSL(e){return e.replace(new RegExp("inversesqrt","g"),"inverseSqrt")}_convertFunctionsToWGSL(e){let t=/var\s+(\w+)\s*:\s*(\w+)\((.*)\)/g,n;for(;(n=t.exec(e))!==null;){let r=n[1],s=n[2],a=n[3].replace(/var\s/g,"");e=e.replace(n[0],`fn ${r}(${a}) -> ${s}`)}return e}_babylonSLtoWGSL(e){return e=this._convertVariableDeclarationToWGSL("void","voidnull",e),e=this._convertVariableDeclarationToWGSL("bool","bool",e),e=this._convertVariableDeclarationToWGSL("int","i32",e),e=this._convertVariableDeclarationToWGSL("uint","u32",e),e=this._convertVariableDeclarationToWGSL("float","f32",e),e=this._convertVariableDeclarationToWGSL("vec2","vec2f",e),e=this._convertVariableDeclarationToWGSL("vec3","vec3f",e),e=this._convertVariableDeclarationToWGSL("vec4","vec4f",e),e=this._convertVariableDeclarationToWGSL("mat2","mat2x2f",e),e=this._convertVariableDeclarationToWGSL("mat3","mat3x3f",e),e=this._convertVariableDeclarationToWGSL("mat4","mat4x4f",e),e=this._convertVariableConstructorsToWGSL("float","f32",e),e=this._convertVariableConstructorsToWGSL("vec2","vec2f",e),e=this._convertVariableConstructorsToWGSL("vec3","vec3f",e),e=this._convertVariableConstructorsToWGSL("vec4","vec4f",e),e=this._convertVariableConstructorsToWGSL("mat2","mat2x2f",e),e=this._convertVariableConstructorsToWGSL("mat3","mat3x3f",e),e=this._convertVariableConstructorsToWGSL("mat4","mat4x4f",e),e=this._convertTernaryOperandsToWGSL(e),e=this._convertModOperatorsToWGSL(e),e=this._convertConstToWGSL(e),e=this._convertInnerFunctionsToWGSL(e),e=this._convertOutParametersToWGSL(e),e=e.replace(/\[\*\]/g,"*"),e=this._convertFunctionsToWGSL(e),e=e.replace(/\s->\svoidnull/g,""),e=e.replace(/dFdx/g,"dpdx"),e=e.replace(/dFdy/g,"dpdy"),e}_convertTernaryOperandsToGLSL(e){return e.replace(new RegExp("\\[(.+?)\\?(.+?):(.+)\\]","g"),(t,n,r,s)=>`${n} ? ${r} : ${s}`)}_babylonSLtoGLSL(e){return e=e.replace(/\[\*\]/g,""),e=this._convertTernaryOperandsToGLSL(e),e}};var zm=class{constructor(){this.temps=[],this.varyings=[],this.varyingDeclaration="",this.varyingDeclarationFragment="",this.varyingInitializationsFragment="",this.inputBlocks=[],this.textureBlocks=[],this.bindableBlocks=[],this.forcedBindableBlocks=[],this.blocksWithFallbacks=[],this.blocksWithDefines=[],this.repeatableContentBlocks=[],this.dynamicUniformBlocks=[],this.blockingBlocks=[],this.animatedInputs=[],this.formatConfig={getUniformAnnotation:null,formatVariablename:e=>e.replace(/[^a-zA-Z_]+/g,"")},this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array,customErrors:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}raiseBuildError(e){this.checks.customErrors.indexOf(e)!==-1&&this.checks.customErrors.push(e)}emitErrors(){let e="";!this.checks.emitVertex&&!this.allowEmptyVertexProgram&&(e+=`NodeMaterial does not have a vertex output. You need to at least add a block that generates a position value.
`),this.checks.emitFragment||(e+=`NodeMaterial does not have a fragment output. You need to at least add a block that generates a color value.
`);for(let t of this.checks.notConnectedNonOptionalInputs)e+=`input ${t.name} from block ${t.ownerBlock.name}[${t.ownerBlock.getClassName()}] is not connected and is not optional.
`;for(let t of this.checks.customErrors)e+=t+`
`;return e?(e=`Node material build failed: 
`+e,N.Error(e),this.nodeMaterial.onBuildErrorObservable.notifyObservers(e),!1):!0}};var th=class i{static AreEquivalentTypes(e,t){switch(e){case P.Vector3:{if(t===P.Color3)return!0;break}case P.Vector4:{if(t===P.Color4)return!0;break}case P.Color3:{if(t===P.Vector3)return!0;break}case P.Color4:{if(t===P.Vector4)return!0;break}}return!1}get isInactive(){return this._isInactive}get _connectedPoint(){return this._connectedPointBackingField}set _connectedPoint(e){this._connectedPointBackingField!==e&&(this._connectedPointTypeChangedObserver?.remove(),this._updateTypeDependentState(()=>this._connectedPointBackingField=e),this._connectedPointBackingField&&(this._connectedPointTypeChangedObserver=this._connectedPointBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get _typeConnectionSource(){return this._typeConnectionSourceBackingField}set _typeConnectionSource(e){this._typeConnectionSourceBackingField!==e&&(this._typeConnectionSourceTypeChangedObserver?.remove(),this._updateTypeDependentState(()=>this._typeConnectionSourceBackingField=e),this._typeConnectionSourceBackingField&&(this._typeConnectionSourceTypeChangedObserver=this._typeConnectionSourceBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get _defaultConnectionPointType(){return this._defaultConnectionPointTypeBackingField}set _defaultConnectionPointType(e){this._updateTypeDependentState(()=>this._defaultConnectionPointTypeBackingField=e)}get _linkedConnectionSource(){return this._linkedConnectionSourceBackingField}set _linkedConnectionSource(e){this._linkedConnectionSourceBackingField!==e&&(this._linkedConnectionSourceTypeChangedObserver?.remove(),this._updateTypeDependentState(()=>this._linkedConnectionSourceBackingField=e),this._isMainLinkSource=!1,this._linkedConnectionSourceBackingField&&(this._linkedConnectionSourceTypeChangedObserver=this._linkedConnectionSourceBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get direction(){return this._direction}get declarationVariableName(){return this._ownerBlock.isInput?this._ownerBlock.declarationVariableName:(!this._enforceAssociatedVariableName||!this._associatedVariableName)&&this._connectedPoint?this._connectedPoint.declarationVariableName:this._associatedVariableName}get associatedVariableName(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:(!this._enforceAssociatedVariableName||!this._associatedVariableName)&&this._connectedPoint?this._connectedPoint.associatedVariableName:this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get innerType(){return this._linkedConnectionSource&&!this._isMainLinkSource&&this._linkedConnectionSource.isConnected?this.type:this._type}get type(){if(this._type===P.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource){if(this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.connectedPoint._redirectedSource&&this._linkedConnectionSource.connectedPoint._redirectedSource.isConnected?this._linkedConnectionSource.connectedPoint._redirectedSource.type:this._linkedConnectionSource.type;if(this._linkedConnectionSource._defaultConnectionPointType)return this._linkedConnectionSource._defaultConnectionPointType}if(this._defaultConnectionPointType)return this._defaultConnectionPointType}if(this._type===P.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._updateTypeDependentState(()=>this._type=e)}get target(){return!this._prioritizeVertex||!this._ownerBlock?this._target:this._target!==Y.VertexAndFragment?this._target:this._ownerBlock.target===Y.Fragment?Y.Fragment:Y.Vertex}set target(e){this._target=e}get isConnected(){return this.connectedPoint!==null||this.hasEndpoints}get isConnectedToInputBlock(){return this.connectedPoint!==null&&this.connectedPoint.ownerBlock.isInput}get connectInputBlock(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return this._endpoints.length===0?[]:this._endpoints.map(e=>e.ownerBlock)}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get isDirectlyConnectedToVertexOutput(){if(!this.hasEndpoints)return!1;for(let e of this._endpoints)if(e.ownerBlock.target===Y.Vertex||(e.ownerBlock.target===Y.Neutral||e.ownerBlock.target===Y.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isDirectlyConnectedToVertexOutput))return!0;return!1}get isConnectedInVertexShader(){if(this.target===Y.Vertex)return!0;if(!this.hasEndpoints)return!1;for(let e of this._endpoints)if(e.ownerBlock.target===Y.Vertex||e.target===Y.Vertex||(e.ownerBlock.target===Y.Neutral||e.ownerBlock.target===Y.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isConnectedInVertexShader))return!0;return!1}get isConnectedInFragmentShader(){if(this.target===Y.Fragment)return!0;if(!this.hasEndpoints)return!1;for(let e of this._endpoints)if(e.ownerBlock.target===Y.Fragment||(e.ownerBlock.target===Y.Neutral||e.ownerBlock.target===Y.VertexAndFragment)&&e.ownerBlock.isConnectedInFragmentShader())return!0;return!1}createCustomInputBlock(){return null}constructor(e,t,n){this._isInactive=!1,this._preventBubbleUp=!1,this._connectedPointBackingField=null,this._endpoints=new Array,this._redirectedSource=null,this._typeConnectionSourceBackingField=null,this._defaultConnectionPointTypeBackingField=null,this._isMainLinkSource=!1,this._linkedConnectionSourceBackingField=null,this._acceptedConnectionPointType=null,this._type=P.Float,this._enforceAssociatedVariableName=!1,this._forPostBuild=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new B,this.onDisconnectionObservable=new B,this.onTypeChangedObservable=new B,this._isTypeChangeObservableNotifying=!1,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=Y.VertexAndFragment,this._ownerBlock=t,this.name=e,this._direction=n}getClassName(){return"NodeMaterialConnectionPoint"}canConnectTo(e){return this.checkCompatibilityState(e)===0}checkCompatibilityState(e){let t=this._ownerBlock,n=e.ownerBlock;if(t.target===Y.Fragment){if(n.target===Y.Vertex)return 2;for(let o of n.outputs)if(o.ownerBlock.target!=Y.Neutral&&o.isConnectedInVertexShader)return 2}if(this.type!==e.type&&e.innerType!==P.AutoDetect)return i.AreEquivalentTypes(this.type,e.type)||e.acceptedConnectionPointTypes&&e.acceptedConnectionPointTypes.indexOf(this.type)!==-1||e._acceptedConnectionPointType&&i.AreEquivalentTypes(e._acceptedConnectionPointType.type,this.type)?0:1;if(e.excludedConnectionPointTypes&&e.excludedConnectionPointTypes.indexOf(this.type)!==-1)return 1;let r=n,s=t;return this.direction===0&&(r=t,s=n),r.isAnAncestorOf(s)?3:0}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw`Cannot connect these two connectors. source: "${this.ownerBlock.name}".${this.name}, target: "${e.ownerBlock.name}".${e.name}`;return this._endpoints.push(e),e._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){let t=this._endpoints.indexOf(e);return t===-1?this:(this._endpoints.splice(t,1),e._connectedPoint=null,this._enforceAssociatedVariableName=!1,e._enforceAssociatedVariableName=!1,this.onDisconnectionObservable.notifyObservers(e),e.onDisconnectionObservable.notifyObservers(this),this)}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<P.All;)e&t||this.excludedConnectionPointTypes.push(t),t=t<<1}serialize(e=!0){let t={};return t.name=this.name,this.displayName&&(t.displayName=this.displayName),e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear(),this.onDisconnectionObservable.clear(),this.onTypeChangedObservable.clear(),this._connectedPoint=null,this._typeConnectionSource=null,this._linkedConnectionSource=null}_updateTypeDependentState(e){let t=this.type;e(),this.type!==t&&this._notifyTypeChanged()}_notifyTypeChanged(){this._isTypeChangeObservableNotifying||(this._isTypeChangeObservableNotifying=!0,this.onTypeChangedObservable.notifyObservers(this.type),this._isTypeChangeObservableNotifying=!1)}};var mt=class{get _isFinalOutputAndActive(){return this._isFinalOutput}get _hasPrecedence(){return!1}get name(){return this._name}get codeIsReady(){return this._codeIsReady}set name(e){this.validateBlockName(e)&&(this._name=e)}get isUnique(){return this._isUnique}get isFinalMerger(){return this._isFinalMerger}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get isLoop(){return this._isLoop}get buildId(){return this._buildId}set buildId(e){this._buildId=e}get target(){return this._target}set target(e){(this._target&e)===0&&(this._target=e)}get inputs(){return this._inputs}get outputs(){return this._outputs}getInputByName(e){let t=this._inputs.filter(n=>n.name===e);return t.length?t[0]:null}getOutputByName(e){let t=this._outputs.filter(n=>n.name===e);return t.length?t[0]:null}constructor(e,t=Y.Vertex,n=!1,r=!1){switch(this._isFinalMerger=!1,this._isInput=!1,this._isLoop=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._name="",this._isUnique=!1,this._codeIsReady=!0,this._isFinalOutput=!1,this.onCodeIsReadyObservable=new B,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=t,this._originalTargetIsNeutral=t===Y.Neutral,this._isFinalMerger=n,this._isFinalOutput=r,this.getClassName()){case"InputBlock":this._isInput=!0;break;case"NodeMaterialTeleportOutBlock":this._isTeleportOut=!0;break;case"NodeMaterialTeleportInBlock":this._isTeleportIn=!0;break;case"LoopBlock":this._isLoop=!0;break}this._name=e,this.uniqueId=_h.UniqueId}_setInitialTarget(e){this._target=e,this._originalTargetIsNeutral=e===Y.Neutral}initialize(e){}bind(e,t,n,r){}_writeVariable(e){return e.connectedPoint?`${e.associatedVariableName}`:"0."}_writeFloat(e){let t=e.toString();return t.indexOf(".")===-1&&(t+=".0"),`${t}`}getClassName(){return"NodeMaterialBlock"}isConnectedInFragmentShader(){return this.outputs.some(e=>e.isConnectedInFragmentShader)}registerInput(e,t,n=!1,r,s){return s=s??new th(e,this,0),s.type=t,s.isOptional=n,r&&(s.target=r),this._inputs.push(s),this}registerOutput(e,t,n,r){return r=r??new th(e,this,1),r.type=t,n&&(r.target=n),this._outputs.push(r),this}getFirstAvailableInput(e=null){for(let t of this._inputs)if(!t.connectedPoint&&(!e||e.type===t.type||t.type===P.AutoDetect||t.acceptedConnectionPointTypes.indexOf(e.type)!==-1))return t;return null}getFirstAvailableOutput(e=null){for(let t of this._outputs)if(!e||!e.target||e.target===Y.Neutral||(e.target&t.target)!==0)return t;return null}getSiblingOutput(e){let t=this._outputs.indexOf(e);return t===-1||t>=this._outputs.length?null:this._outputs[t+1]}isAnAncestorOf(e){for(let t of this._outputs)if(t.hasEndpoints){for(let n of t.endpoints)if(n.ownerBlock===e||n.ownerBlock.isAnAncestorOf(e))return!0}return!1}connectTo(e,t){if(this._outputs.length===0)return;let n=t&&t.output?this.getOutputByName(t.output):this.getFirstAvailableOutput(e),r=!0;for(;r;){let s=t&&t.input?e.getInputByName(t.input):e.getFirstAvailableInput(n);if(n&&s&&n.canConnectTo(s))n.connectTo(s),r=!1;else if(n)n=this.getSiblingOutput(n);else throw"Unable to find a compatible match"}return this}_buildBlock(e){}_postBuildBlock(e){}updateUniformsAndSamples(e,t,n,r){}provideFallbacks(e,t){}initializeDefines(e){}prepareDefines(e,t,n,r=!1,s){}autoConfigure(e,t=()=>!0){}replaceRepeatableContent(e,t,n){}get willBeGeneratedIntoVertexShaderFromFragmentShader(){return this.isInput||this.isFinalMerger||this._outputs.some(e=>e.isDirectlyConnectedToVertexOutput)||this.target===Y.Vertex?!1:!!((this.target===Y.VertexAndFragment||this.target===Y.Neutral)&&this._outputs.some(e=>e.isConnectedInVertexShader))}isReady(e,t,n,r=!1){return!0}_linkConnectionTypes(e,t,n=!1){n?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:(this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[e]._isMainLinkSource=!0),this._inputs[t]._linkedConnectionSource=this._inputs[e]}_processBuild(e,t,n,r){e.build(t,r);let s=t._vertexState!=null,o=e._buildTarget===Y.Vertex&&e.target!==Y.VertexAndFragment;if(!(e.isTeleportOut&&e.entryPoint?.isConnectedToUniform)&&s&&((e.target&e._buildTarget)===0||(e.target&n.target)===0||this.target!==Y.VertexAndFragment&&o)&&(!e.isInput&&t.target!==e._buildTarget||e.isInput&&e.isAttribute&&!e._noContextSwitch)){let a=n.connectedPoint;if(t._vertexState._emitVaryingFromString("v_"+a.declarationVariableName,a.type)){let c=t.shaderLanguage===1?"vertexOutputs.":"";t.shaderLanguage===1&&a.type===P.Matrix?(t._vertexState.compilationString+=`${c}${"v_"+a.declarationVariableName}_r0 = ${a.associatedVariableName}[0];
`,t._vertexState.compilationString+=`${c}${"v_"+a.declarationVariableName}_r1 = ${a.associatedVariableName}[1];
`,t._vertexState.compilationString+=`${c}${"v_"+a.declarationVariableName}_r2 = ${a.associatedVariableName}[2];
`,t._vertexState.compilationString+=`${c}${"v_"+a.declarationVariableName}_r3 = ${a.associatedVariableName}[3];
`):t._vertexState.compilationString+=`${c}${"v_"+a.declarationVariableName} = ${a.associatedVariableName};
`}let l=t.shaderLanguage===1&&a.type!==P.Matrix?"fragmentInputs.":"";n.associatedVariableName=l+"v_"+a.declarationVariableName,n._enforceAssociatedVariableName=!0}}validateBlockName(e){let t=["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","postprocess_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"];for(let n of t)if(e===n)return!1;return!0}_customBuildStep(e,t){}build(e,t){if(this._buildId===e.sharedData.buildId)return!0;if(!this.isInput)for(let n of this._outputs)n.associatedVariableName||(n.associatedVariableName=e._getFreeVariableName(n.name));for(let n of this._inputs){if(!n.connectedPoint){n.isOptional||e.sharedData.checks.notConnectedNonOptionalInputs.push(n);continue}if(this.target!==Y.Neutral&&((n.target&this.target)===0||(n.target&e.target)===0))continue;let r=n.connectedPoint.ownerBlock;r&&r!==this&&this._processBuild(r,e,n,t)}if(this._customBuildStep(e,t),this._buildId===e.sharedData.buildId)return!0;if(e.sharedData.verbose&&N.Log(`${e.target===Y.Vertex?"Vertex shader":"Fragment shader"}: Building ${this.name} [${this.getClassName()}]`),this.isFinalMerger)switch(e.target){case Y.Vertex:e.sharedData.checks.emitVertex=!0;break;case Y.Fragment:e.sharedData.checks.emitFragment=!0;break}!this.isInput&&e.sharedData.emitComments&&(e.compilationString+=`
//${this.name}
`),this._buildBlock(e),this._buildId=e.sharedData.buildId,this._buildTarget=e.target;for(let n of this._outputs)if(!n._forPostBuild&&(n.target&e.target)!==0)for(let r of n.endpoints){let s=r.ownerBlock;s&&((s.target&e.target)!==0&&t.indexOf(s)!==-1||e._terminalBlocks.has(s))&&this._processBuild(s,e,r,t)}this._postBuildBlock(e);for(let n of this._outputs)if(n._forPostBuild&&(n.target&e.target)!==0)for(let r of n.endpoints){let s=r.ownerBlock;s&&(s.target&e.target)!==0&&t.indexOf(s)!==-1&&this._processBuild(s,e,r,t)}return!1}_inputRename(e){return e}_outputRename(e){return e}_dumpPropertiesCode(){let e=this._codeVariableName;return`${e}.visibleInInspector = ${this.visibleInInspector};
${e}.visibleOnFrame = ${this.visibleOnFrame};
${e}.target = ${this.target};
`}_dumpCode(e,t){t.push(this);let n=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=n||`${this.getClassName()}_${this.uniqueId}`,e.indexOf(this._codeVariableName)!==-1){let s=0;do s++,this._codeVariableName=n+s;while(e.indexOf(this._codeVariableName)!==-1)}e.push(this._codeVariableName);let r=`
// ${this.getClassName()}
`;this.comments&&(r+=`// ${this.comments}
`),r+=`var ${this._codeVariableName} = new BABYLON.${this.getClassName()}("${this.name}");
`,r+=this._dumpPropertiesCode();for(let s of this.inputs){if(!s.isConnected)continue;let a=s.connectedPoint.ownerBlock;t.indexOf(a)===-1&&(r+=a._dumpCode(e,t))}for(let s of this.outputs)if(s.hasEndpoints)for(let o of s.endpoints){let a=o.ownerBlock;a&&t.indexOf(a)===-1&&(r+=a._dumpCode(e,t))}return r}_dumpCodeForOutputConnections(e){let t="";if(e.indexOf(this)!==-1)return t;e.push(this);for(let n of this.inputs){if(!n.isConnected)continue;let r=n.connectedPoint,s=r.ownerBlock;t+=s._dumpCodeForOutputConnections(e),t+=`${s._codeVariableName}.${s._outputRename(r.name)}.connectTo(${this._codeVariableName}.${this._inputRename(n.name)});
`}return t}clone(e,t=""){let n=this.serialize(),r=Ct(n.customType);if(r){let s=new r;return s._deserialize(n,e,t),s}return null}serialize(){let e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.comments=this.comments,e.visibleInInspector=this.visibleInInspector,e.visibleOnFrame=this.visibleOnFrame,e.target=this.target,e.inputs=[],e.outputs=[];for(let t of this.inputs)e.inputs.push(t.serialize());for(let t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e,t,n,r){this.name=e.name,this.comments=e.comments,this.visibleInInspector=!!e.visibleInInspector,this.visibleOnFrame=!!e.visibleOnFrame,this._target=e.target??this.target,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){let t=e.inputs,n=e.outputs;if(t)for(let r=0;r<t.length;r++){let s=t[r];s.displayName&&(this.inputs[r].displayName=s.displayName),s.isExposedOnFrame&&(this.inputs[r].isExposedOnFrame=s.isExposedOnFrame,this.inputs[r].exposedPortPosition=s.exposedPortPosition)}if(n)for(let r=0;r<n.length;r++){let s=n[r];s.displayName&&(this.outputs[r].displayName=s.displayName),s.isExposedOnFrame&&(this.outputs[r].isExposedOnFrame=s.isExposedOnFrame,this.outputs[r].exposedPortPosition=s.exposedPortPosition)}}dispose(){this.onCodeIsReadyObservable.clear();for(let e of this.inputs)e.dispose();for(let e of this.outputs)e.dispose()}};function Hr(i,e=0,t="PROPERTIES",n){return(r,s)=>{let o=r._propStore;o||(o=[],r._propStore=o),o.push({propertyName:s,displayName:i,type:e,groupName:t,options:n??{},className:r.getClassName()})}}var gs=(function(i){return i[i.NoColorSpace=0]="NoColorSpace",i[i.Gamma=1]="Gamma",i[i.Linear=2]="Linear",i})(gs||{}),qi=class extends mt{constructor(e){super(e,Y.Fragment,!0,!0),this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.useLogarithmicDepth=!1,this.registerInput("rgba",P.Color4,!0),this.registerInput("rgb",P.Color3,!0),this.registerInput("a",P.Float,!0),this.registerInput("glow",P.Color3,!0),this.rgb.acceptedConnectionPointTypes.push(P.Vector3),this.rgb.acceptedConnectionPointTypes.push(P.Float),this.additionalColor.acceptedConnectionPointTypes.push(P.Vector3),this.additionalColor.acceptedConnectionPointTypes.push(P.Float)}get colorSpace(){return this.convertToGammaSpace?gs.Gamma:this.convertToLinearSpace?gs.Linear:gs.NoColorSpace}set colorSpace(e){this.convertToGammaSpace=e===gs.Gamma,this.convertToLinearSpace=e===gs.Linear}getClassName(){return"FragmentOutputBlock"}initialize(e){e._excludeVariableName("logarithmicDepthConstant"),e._excludeVariableName("vFragmentDepth")}get rgba(){return this._inputs[0]}get rgb(){return this._inputs[1]}get a(){return this._inputs[2]}get additionalColor(){return this._inputs[3]}get glow(){return this._inputs[3]}_getOutputString(e){return e.shaderLanguage===1?"fragmentOutputsColor":"gl_FragColor"}prepareDefines(e,t){e.setValue(this._linearDefineName,this.convertToLinearSpace,!0),e.setValue(this._gammaDefineName,this.convertToGammaSpace,!0),e.setValue(this._additionalColorDefineName,this.additionalColor.connectedPoint&&t._useAdditionalColor,!0)}bind(e,t,n){(this.useLogarithmicDepth||t.useLogarithmicDepth)&&n&&Jn(void 0,e,n.getScene())}_buildBlock(e){super._buildBlock(e);let t=this.rgba,n=this.rgb,r=this.a,s=this.additionalColor,o=e.shaderLanguage===1;e.sharedData.hints.needAlphaBlending=t.isConnected||r.isConnected,e.sharedData.blocksWithDefines.push(this),(this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth)&&(e._emitUniformFromString("logarithmicDepthConstant",P.Float),e._emitVaryingFromString("vFragmentDepth",P.Float),e.sharedData.bindableBlocks.push(this)),s.connectedPoint&&(e._excludeVariableName("useAdditionalColor"),e._emitUniformFromString("useAdditionalColor",P.Float),this._additionalColorDefineName=e._getFreeDefineName("USEADDITIONALCOLOR")),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA");let a=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",a);let l=this._getOutputString(e);e.shaderLanguage===1&&(e.compilationString+=`var ${l} : vec4<f32>;\r
`);let c=e._getShaderType(P.Vector4);if(s.connectedPoint){let u="1.0";r.connectedPoint&&(u=r.associatedVariableName),e.compilationString+=`#ifdef ${this._additionalColorDefineName}
`,s.connectedPoint.type===P.Float?e.compilationString+=`${l}  = ${c}(${s.associatedVariableName}, ${s.associatedVariableName}, ${s.associatedVariableName}, ${u});
`:e.compilationString+=`${l}  = ${c}(${s.associatedVariableName}, ${u});
`,e.compilationString+=`#else
`}if(t.connectedPoint)r.isConnected?e.compilationString+=`${l} = ${c}(${t.associatedVariableName}.rgb, ${r.associatedVariableName});
`:e.compilationString+=`${l}  = ${t.associatedVariableName};
`;else if(n.connectedPoint){let u="1.0";r.connectedPoint&&(u=r.associatedVariableName),n.connectedPoint.type===P.Float?e.compilationString+=`${l}  = ${c}(${n.associatedVariableName}, ${n.associatedVariableName}, ${n.associatedVariableName}, ${u});
`:e.compilationString+=`${l}  = ${c}(${n.associatedVariableName}, ${u});
`}else e.sharedData.checks.notConnectedNonOptionalInputs.push(t);if(s.connectedPoint&&(e.compilationString+=`#endif
`),e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${l}  = toLinearSpace(${l});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${l}  = toGammaSpace(${l});
`,e.compilationString+=`#endif
`,e.shaderLanguage===1&&(e.compilationString+=`#if !defined(PREPASS)\r
`,e.compilationString+=`fragmentOutputs.color = ${l};\r
`,e.compilationString+=`#endif\r
`),this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth){let u=o?"input.vFragmentDepth":"vFragmentDepth",h=o?"uniforms.":"",d=o?"fragmentOutputs.fragDepth":"gl_FragDepthEXT";e.compilationString+=`${d} = log2(${u}) * ${h}logarithmicDepthConstant * 0.5;
`}return e.compilationString+=`#if defined(PREPASS)\r
`,e.compilationString+=`${o?"fragmentOutputs.fragData0":"gl_FragData[0]"} = ${l};\r
`,e.compilationString+=`#endif\r
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};
`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};
`,e+=`${this._codeVariableName}.useLogarithmicDepth = ${this.useLogarithmicDepth};
`,e}serialize(){let e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.useLogarithmicDepth=this.useLogarithmicDepth,e}_deserialize(e,t,n){super._deserialize(e,t,n),this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.useLogarithmicDepth=e.useLogarithmicDepth??!1}};w([Hr("Use logarithmic depth",0,"PROPERTIES",{embedded:!0})],qi.prototype,"useLogarithmicDepth",void 0);w([Hr("Color space",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"No color space",value:gs.NoColorSpace},{label:"Gamma",value:gs.Gamma},{label:"Linear",value:gs.Linear}]})],qi.prototype,"colorSpace",null);ue("BABYLON.FragmentOutputBlock",qi);var rn=(function(i){return i[i.Material=0]="Material",i[i.PostProcess=1]="PostProcess",i[i.Particle=2]="Particle",i[i.ProceduralTexture=3]="ProceduralTexture",i[i.GaussianSplatting=4]="GaussianSplatting",i[i.SFE=5]="SFE",i})(rn||{});var nt=(function(i){return i[i.World=1]="World",i[i.View=2]="View",i[i.Projection=3]="Projection",i[i.ViewProjection=4]="ViewProjection",i[i.WorldView=5]="WorldView",i[i.WorldViewProjection=6]="WorldViewProjection",i[i.CameraPosition=7]="CameraPosition",i[i.FogColor=8]="FogColor",i[i.DeltaTime=9]="DeltaTime",i[i.CameraParameters=10]="CameraParameters",i[i.MaterialAlpha=11]="MaterialAlpha",i[i.ProjectionInverse=12]="ProjectionInverse",i})(nt||{});var $r=(function(i){return i[i.None=0]="None",i[i.Time=1]="Time",i[i.RealTime=2]="RealTime",i[i.MouseInfo=3]="MouseInfo",i})($r||{});var sB={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW",postprocess_uv:"vUV"},SC={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0,postprocess_uv:!0},IM={particle_texturemask:!0},EM={normal:"NORMAL",tangent:"TANGENT",uv:"UV1",uv2:"UV2",uv3:"UV3",uv4:"UV4",uv5:"UV5",uv6:"UV6",uv7:"UV7",uv8:"UV8"},Ut=class extends mt{get type(){if(this._type===P.AutoDetect){if(this.isUniform&&this.value!=null){if(!isNaN(this.value))return this._type=P.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=P.Vector2,this._type;case"Vector3":return this._type=P.Vector3,this._type;case"Vector4":return this._type=P.Vector4,this._type;case"Color3":return this._type=P.Color3,this._type;case"Color4":return this._type=P.Color4,this._type;case"Matrix":return this._type=P.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"splatIndex":return this._type=P.Float,this._type;case"position":case"normal":case"particle_positionw":case"splatPosition":return this._type=P.Vector3,this._type;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":case"splatScale":case"postprocess_uv":return this._type=P.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"matricesIndicesExtra":case"matricesWeightsExtra":case"world0":case"world1":case"world2":case"world3":case"tangent":return this._type=P.Vector4,this._type;case"color":case"instanceColor":case"particle_color":case"particle_texturemask":case"splatColor":return this._type=P.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case nt.World:case nt.WorldView:case nt.WorldViewProjection:case nt.View:case nt.ViewProjection:case nt.Projection:case nt.ProjectionInverse:return this._type=P.Matrix,this._type;case nt.CameraPosition:return this._type=P.Vector3,this._type;case nt.FogColor:return this._type=P.Color3,this._type;case nt.DeltaTime:case nt.MaterialAlpha:return this._type=P.Float,this._type;case nt.CameraParameters:return this._type=P.Vector4,this._type}}return this._type}constructor(e,t=Y.Vertex,n=P.AutoDetect){super(e,t,!1),this._mode=3,this._animationType=$r.None,this._prefix="",this.min=0,this.max=0,this.isBoolean=!1,this.matrixMode=0,this._systemValue=null,this.isConstant=!1,this.groupInInspector="",this.onValueChangedObservable=new B,this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._type=n,this.setDefaultValue(),this.registerOutput("output",n)}validateBlockName(e){return this.isAttribute?!0:super.validateBlockName(e)}get output(){return this._outputs[0]}setAsAttribute(e){return this._mode=1,e&&(this.name=e),this}setAsSystemValue(e){return this.systemValue=e,this}get value(){return this._storedValue}set value(e){this.type===P.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=0,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e,this._mode=0}get declarationVariableName(){return this._associatedVariableName}get associatedVariableName(){return this._prefix+this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get animationType(){return this._animationType}set animationType(e){this._animationType=e}get isUndefined(){return this._mode===3}get isUniform(){return this._mode===0}set isUniform(e){this._mode=e?0:3,this.associatedVariableName=""}get isAttribute(){return this._mode===1}set isAttribute(e){this._mode=e?1:3,this.associatedVariableName=""}get isVarying(){return this._mode===2}set isVarying(e){this._mode=e?2:3,this.associatedVariableName=""}get isSystemValue(){return this._systemValue!=null}get systemValue(){return this._systemValue}set systemValue(e){this._mode=0,this.associatedVariableName="",this._systemValue=e}getClassName(){return"InputBlock"}animate(e){switch(this._animationType){case $r.Time:{this.type===P.Float&&(this.value+=e.getAnimationRatio()*.01);break}case $r.RealTime:{this.type===P.Float&&(this.value=(Zi.Now-e.getEngine().startTime)/1e3);break}case $r.MouseInfo:{if(this.type===P.Vector4){let t=e._inputManager._originMouseEvent;if(t){let n=t.offsetX,r=t.offsetY,s=(t.buttons&1)!=0?1:0,o=(t.buttons&2)!=0?1:0;this.value=new ht(n,r,s,o)}else this.value=new ht(0,0,0,0)}break}}}_emitDefine(e,t=!1){return`${t?"#ifndef":"#ifdef"} ${e}
`}initialize(){this.associatedVariableName=""}setDefaultValue(){switch(this.type){case P.Float:this.value=0;break;case P.Vector2:this.value=_e.Zero();break;case P.Vector3:this.value=m.Zero();break;case P.Vector4:this.value=ht.Zero();break;case P.Color3:this.value=G.White();break;case P.Color4:this.value=new le(1,1,1,1);break;case P.Matrix:this.value=V.Identity();break}}_emitConstant(e){switch(this.type){case P.Float:return`${e._emitFloat(this.value)}`;case P.Vector2:return`vec2(${this.value.x}, ${this.value.y})`;case P.Vector3:return`vec3(${this.value.x}, ${this.value.y}, ${this.value.z})`;case P.Vector4:return`vec4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;case P.Color3:return it.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&it.Color3[0].toGammaSpaceToRef(it.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&it.Color3[0].toLinearSpaceToRef(it.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec3(${it.Color3[0].r}, ${it.Color3[0].g}, ${it.Color3[0].b})`;case P.Color4:return it.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&it.Color4[0].toGammaSpaceToRef(it.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&it.Color4[0].toLinearSpaceToRef(it.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec4(${it.Color4[0].r}, ${it.Color4[0].g}, ${it.Color4[0].b}, ${it.Color4[0].a})`}return""}get _noContextSwitch(){return SC[this.name]}_emit(e){if(this.isUniform){if(this._associatedVariableName||(this._associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(e.constants.indexOf(this.associatedVariableName)!==-1)return;e.constants.push(this.associatedVariableName),e._constantDeclaration+=e._declareOutput(this.output,!0)+` = ${this._emitConstant(e)};
`;return}if(e.uniforms.indexOf(this.associatedVariableName)!==-1)return;e._emitUniformFromString(this._associatedVariableName,this.type),e.shaderLanguage===1&&(this._prefix="uniforms.");let t=e.sharedData.hints;if(this._systemValue!==null&&this._systemValue!==void 0)switch(this._systemValue){case nt.WorldView:t.needWorldViewMatrix=!0;break;case nt.WorldViewProjection:t.needWorldViewProjectionMatrix=!0;break}else this._animationType!==$r.None&&e.sharedData.animatedInputs.push(this);return}if(this.isAttribute){if(this.associatedVariableName=sB[this.name]??this.name,this.target===Y.Vertex&&e._vertexState){SC[this.name]?IM[this.name]?(e._emitUniformFromString(this.declarationVariableName,this.type),e.shaderLanguage===1&&(this._prefix="vertexInputs.")):e._emitVaryingFromString(this.declarationVariableName,this.type):this._emit(e._vertexState);return}let t=e.attributes.indexOf(this.declarationVariableName)!==-1;if(t||e.attributes.push(this.declarationVariableName),SC[this.name])IM[this.name]?(t||e._emitUniformFromString(this.declarationVariableName,this.type),e.shaderLanguage===1&&(this._prefix="uniforms.")):(t||e._emitVaryingFromString(this.declarationVariableName,this.type),e.shaderLanguage===1&&(this._prefix="fragmentInputs."));else if(e.shaderLanguage===1){if(!t){let n=EM[this.name];n?(e._attributeDeclaration+=this._emitDefine(n),e._attributeDeclaration+=`attribute ${this.declarationVariableName}: ${e._getShaderType(this.type)};
`,e._attributeDeclaration+=`#else
`,e._attributeDeclaration+=`var<private> ${this.declarationVariableName}: ${e._getShaderType(this.type)} = ${e._getShaderType(this.type)}(0.);
`,e._attributeDeclaration+=`#endif
`):e._attributeDeclaration+=`attribute ${this.declarationVariableName}: ${e._getShaderType(this.type)};
`}this._prefix="vertexInputs."}else if(!t){let n=EM[this.name];n?(e._attributeDeclaration+=this._emitDefine(n),e._attributeDeclaration+=`attribute ${e._getShaderType(this.type)} ${this.declarationVariableName};
`,e._attributeDeclaration+=`#else
`,e._attributeDeclaration+=`${e._getShaderType(this.type)} ${this.declarationVariableName} = ${e._getShaderType(this.type)}(0.);
`,e._attributeDeclaration+=`#endif
`):e._attributeDeclaration+=`attribute ${e._getShaderType(this.type)} ${this.declarationVariableName};
`}}}_transmitWorld(e,t,n,r){if(!this._systemValue)return;let s=this._associatedVariableName;switch(this._systemValue){case nt.World:e.setMatrix(s,t);break;case nt.WorldView:e.setMatrix(s,n);break;case nt.WorldViewProjection:e.setMatrix(s,r);break}}_transmit(e,t,n){if(this.isAttribute)return;let r=this._associatedVariableName;if(this._systemValue){switch(this._systemValue){case nt.World:case nt.WorldView:case nt.WorldViewProjection:return;case nt.View:e.setMatrix(r,t.getViewMatrix());break;case nt.Projection:e.setMatrix(r,t.getProjectionMatrix());break;case nt.ProjectionInverse:{t.getProjectionMatrix().invertToRef(U.Matrix[0]),e.setMatrix(r,U.Matrix[0]);break}case nt.ViewProjection:e.setMatrix(r,t.getTransformMatrix());break;case nt.CameraPosition:t.bindEyePosition(e,r,!0);break;case nt.FogColor:e.setColor3(r,t.fogColor);break;case nt.DeltaTime:e.setFloat(r,t.deltaTime/1e3);break;case nt.CameraParameters:t.activeCamera&&e.setFloat4(r,t.getEngine().hasOriginBottomLeft?-1:1,t.activeCamera.minZ,t.activeCamera.maxZ,1/t.activeCamera.maxZ);break;case nt.MaterialAlpha:e.setFloat(r,n.alpha);break}return}let s=this._valueCallback?this._valueCallback():this._storedValue;if(s!==null)switch(this.type){case P.Float:e.setFloat(r,s);break;case P.Int:e.setInt(r,s);break;case P.Color3:it.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&it.Color3[0].toGammaSpaceToRef(it.Color3[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&it.Color3[0].toLinearSpaceToRef(it.Color3[0],t.getEngine().useExactSrgbConversions),e.setColor3(r,it.Color3[0]);break;case P.Color4:it.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&it.Color4[0].toGammaSpaceToRef(it.Color4[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&it.Color4[0].toLinearSpaceToRef(it.Color4[0],t.getEngine().useExactSrgbConversions),e.setDirectColor4(r,it.Color4[0]);break;case P.Vector2:e.setVector2(r,s);break;case P.Vector3:e.setVector3(r,s);break;case P.Vector4:e.setVector4(r,s);break;case P.Matrix:e.setMatrix(r,s);break}}_buildBlock(e){super._buildBlock(e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)}_dumpPropertiesCode(){let e=this._codeVariableName;if(this.isAttribute)return super._dumpPropertiesCode()+`${e}.setAsAttribute("${this.name}");
`;if(this.isSystemValue)return super._dumpPropertiesCode()+`${e}.setAsSystemValue(BABYLON.NodeMaterialSystemValues.${nt[this._systemValue]});
`;if(this.isUniform){let t=[],n="";switch(this.type){case P.Float:n=`${this.value}`;break;case P.Vector2:n=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case P.Vector3:n=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case P.Vector4:n=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break;case P.Color3:n=`new BABYLON.Color3(${this.value.r}, ${this.value.g}, ${this.value.b})`,this.convertToGammaSpace&&(n+=".toGammaSpace()"),this.convertToLinearSpace&&(n+=".toLinearSpace()");break;case P.Color4:n=`new BABYLON.Color4(${this.value.r}, ${this.value.g}, ${this.value.b}, ${this.value.a})`,this.convertToGammaSpace&&(n+=".toGammaSpace()"),this.convertToLinearSpace&&(n+=".toLinearSpace()");break;case P.Matrix:n=`BABYLON.Matrix.FromArray([${this.value.m.join(", ")}])`;break}return t.push(`${e}.value = ${n}`),this.type===P.Float&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`,`${e}.isBoolean = ${this.isBoolean}`,`${e}.matrixMode = ${this.matrixMode}`,`${e}.animationType = BABYLON.AnimatedInputBlockTypes.${$r[this.animationType]}`),t.push(`${e}.isConstant = ${this.isConstant}`),t.push(""),super._dumpPropertiesCode()+t.join(`;
`)}return super._dumpPropertiesCode()}dispose(){this.onValueChangedObservable.clear(),super.dispose()}serialize(){let e=super.serialize();return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this._storedValue!=null&&this._mode===0&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e,t,n){if(this._mode=e.mode,super._deserialize(e,t,n),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.name==="tangent"&&e.mode===1&&e.type===P.Vector3&&(this._type=P.Vector4),!!e.valueType)if(e.valueType==="number")this._storedValue=e.value;else{let r=Ct(e.valueType);r&&(this._storedValue=r.FromArray(e.value))}}};ue("BABYLON.InputBlock",Ut);var nh=class extends mt{get associatedVariableName(){return this._varName}constructor(e){super(e,Y.Fragment),this.registerOutput("xy",P.Vector2,Y.Fragment),this.registerOutput("x",P.Float,Y.Fragment),this.registerOutput("y",P.Float,Y.Fragment)}getClassName(){return"ScreenSizeBlock"}get xy(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}bind(e){let t=this._scene.getEngine();e.setFloat2(this._varName,t.getRenderWidth(),t.getRenderHeight())}writeOutputs(e,t){let n="";for(let r of this._outputs)r.hasEndpoints&&(n+=`${e._declareOutput(r)} = ${t}.${r.name};
`);return n}_buildBlock(e){if(super._buildBlock(e),this._scene=e.sharedData.scene,e.target===Y.Vertex)return e.sharedData.raiseBuildError("ScreenSizeBlock must only be used in a fragment shader"),this;e.sharedData.bindableBlocks.push(this),this._varName=e._getFreeVariableName("screenSize"),e._emitUniformFromString(this._varName,P.Vector2);let t=e.shaderLanguage===1?"uniforms.":"";return e.compilationString+=this.writeOutputs(e,t+this._varName),this}};ue("BABYLON.ScreenSizeBlock",nh);var Hm="USE_SFE_FRAMEWORK",IC=class extends qi{constructor(e){super(e)}getClassName(){return"SmartFilterFragmentOutputBlock"}initialize(e){super.initialize(e),e.sharedData.nodeMaterial.mode!==rn.SFE&&e.sharedData.raiseBuildError("SmartFilterFragmentOutputBlock should not be used outside of SFE mode."),e.sharedData.nodeMaterial.shaderLanguage!==0&&e.sharedData.raiseBuildError("WebGPU is not supported in SmartFilters mode."),e.sharedData.formatConfig.getUniformAnnotation||(e.sharedData.formatConfig.getUniformAnnotation=t=>{for(let n of e.sharedData.nodeMaterial.attachedBlocks){if(n instanceof Ut&&n.isUniform&&n.associatedVariableName===t)return this._generateInputBlockAnnotation(n);if(n instanceof nh&&n.associatedVariableName===t)return this._generateScreenSizeBlockAnnotation()}return""}),e.sharedData.formatConfig.formatVariablename=t=>{let n=t;return n.length>1&&n[1]==="_"&&(n=n.substring(2)),n.replace(/[^a-zA-Z]+/g,"")}}_generateInputBlockAnnotation(e){let t=e.valueCallback?e.valueCallback():e.value;return`// { "default": ${JSON.stringify(t)} }
`}_generateScreenSizeBlockAnnotation(){return`// { "autoBind": "outputResolution" }
`}_getMainUvName(e){let t=e.sharedData.nodeMaterial.getInputBlockByPredicate(n=>n.isAttribute&&n.name==="postprocess_uv");return!t||!t.isAnAncestorOf(this)?"":t.associatedVariableName}_getOutputString(){return"outColor"}_buildBlock(e){super._buildBlock(e);let t=this._getOutputString();return e._customEntryHeader+=`#ifdef ${Hm}
`,e._customEntryHeader+=`vec4 nmeMain(vec2 ${this._getMainUvName(e)}) { // main
`,e._customEntryHeader+=`#else
`,e._customEntryHeader+=`void main(void) {
`,e._customEntryHeader+=`#endif
`,e._customEntryHeader+=`vec4 ${t} = vec4(0.0);
`,e.compilationString+=`
#ifndef ${Hm}
`,e.compilationString+=`gl_FragColor = ${t};
`,e.compilationString+=`#else
`,e.compilationString+=`return ${t};
`,e.compilationString+=`#endif
`,this}};ue("BABYLON.SmartFilterFragmentOutputBlock",IC);var na=class extends mt{get transformAsDirection(){return this.complementW===0}set transformAsDirection(e){this.complementW=e?0:1}constructor(e){super(e,Y.Neutral),this.complementW=1,this.complementZ=0,this.target=Y.Vertex,this.registerInput("vector",P.AutoDetect),this.registerInput("transform",P.Matrix),this.registerOutput("output",P.Vector4),this.registerOutput("xyz",P.Vector3),this._inputs[0].onConnectionObservable.add(t=>{if(t.ownerBlock.isInput){let n=t.ownerBlock;(n.name==="normal"||n.name==="tangent")&&(this.complementW=0)}})}getClassName(){return"TransformBlock"}get vector(){return this._inputs[0]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}get transform(){return this._inputs[1]}_buildBlock(e){super._buildBlock(e);let t=this.vector,n=this.transform,r=e._getShaderType(P.Vector4),s=e._getShaderType(P.Vector3);if(t.connectedPoint){if(this.complementW===0||this.transformAsDirection){let o=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",o),e.sharedData.blocksWithDefines.push(this);let a=e._getFreeVariableName(`${n.associatedVariableName}_NUS`);switch(e.shaderLanguage===1?e.compilationString+=`var ${a}: mat3x3f = mat3x3f(${n.associatedVariableName}[0].xyz, ${n.associatedVariableName}[1].xyz, ${n.associatedVariableName}[2].xyz);
`:e.compilationString+=`mat3 ${a} = mat3(${n.associatedVariableName});
`,e.compilationString+=`#ifdef NONUNIFORMSCALING
`,e.compilationString+=`${a} = transposeMat3(inverseMat3(${a}));
`,e.compilationString+=`#endif
`,t.connectedPoint.type){case P.Vector2:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${a} * ${s}(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}), ${this._writeFloat(this.complementW)});
`;break;case P.Vector3:case P.Color3:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${a} * ${t.associatedVariableName}, ${this._writeFloat(this.complementW)});
`;break;default:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${a} * ${t.associatedVariableName}.xyz, ${this._writeFloat(this.complementW)});
`;break}}else{let o=n.associatedVariableName;switch(t.connectedPoint.type){case P.Vector2:e.compilationString+=e._declareOutput(this.output)+` = ${o} * ${r}(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}, ${this._writeFloat(this.complementW)});
`;break;case P.Vector3:case P.Color3:e.compilationString+=e._declareOutput(this.output)+` = ${o} * ${r}(${t.associatedVariableName}, ${this._writeFloat(this.complementW)});
`;break;default:e.compilationString+=e._declareOutput(this.output)+` = ${o} * ${t.associatedVariableName};
`;break}}this.xyz.hasEndpoints&&(e.compilationString+=e._declareOutput(this.xyz)+` = ${this.output.associatedVariableName}.xyz;
`)}return this}prepareDefines(e,t,n){n&&n.nonUniformScaling&&e.setValue("NONUNIFORMSCALING",!0)}serialize(){let e=super.serialize();return e.complementZ=this.complementZ,e.complementW=this.complementW,e}_deserialize(e,t,n){super._deserialize(e,t,n),this.complementZ=e.complementZ!==void 0?e.complementZ:0,this.complementW=e.complementW!==void 0?e.complementW:1}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.complementZ = ${this.complementZ};
`;return e+=`${this._codeVariableName}.complementW = ${this.complementW};
`,e}};w([Hr("Transform as direction",0,void 0,{embedded:!0})],na.prototype,"transformAsDirection",null);ue("BABYLON.TransformBlock",na);var ia=class extends mt{constructor(e){super(e,Y.Vertex,!0),this.registerInput("vector",P.Vector4)}getClassName(){return"VertexOutputBlock"}get vector(){return this._inputs[0]}_isLogarithmicDepthEnabled(e,t){if(t)return!0;for(let n of e)if(n.useLogarithmicDepth)return!0;return!1}_buildBlock(e){super._buildBlock(e);let t=this.vector,n=e.shaderLanguage===1;if(e.shaderLanguage===1?e.compilationString+=`vertexOutputs.position = ${t.associatedVariableName};
`:e.compilationString+=`gl_Position = ${t.associatedVariableName};
`,this._isLogarithmicDepthEnabled(e.sharedData.fragmentOutputNodes,e.sharedData.nodeMaterial.useLogarithmicDepth)){e._emitUniformFromString("logarithmicDepthConstant",P.Float),e._emitVaryingFromString("vFragmentDepth",P.Float);let r=n?"vertexOutputs.vFragmentDepth":"vFragmentDepth",s=n?"uniforms.":"",o=n?"vertexOutputs.position":"gl_Position";e.compilationString+=`${r} = 1.0 + ${o}.w;
`,e.compilationString+=`${o}.z = log2(max(0.000001, ${r})) * ${s}logarithmicDepthConstant;
`}return this}};ue("BABYLON.VertexOutputBlock",ia);var ih=class extends mt{get samplerName(){return this._samplerName}get texture(){return this._texture}set texture(e){this._texture=e}constructor(e){super(e,Y.VertexAndFragment),this._samplerName="textureSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",P.AutoDetect,!1,Y.VertexAndFragment),this.registerOutput("rgba",P.Color4,Y.Neutral),this.registerOutput("rgb",P.Color3,Y.Neutral),this.registerOutput("r",P.Float,Y.Neutral),this.registerOutput("g",P.Float,Y.Neutral),this.registerOutput("b",P.Float,Y.Neutral),this.registerOutput("a",P.Float,Y.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(P.Vector2|P.Vector3|P.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"CurrentScreenBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName(this.samplerName)}get target(){return this.uv.isConnected?this.uv.sourceBlock.isInput?Y.VertexAndFragment:Y.Fragment:Y.VertexAndFragment}prepareDefines(e){e.setValue(this._linearDefineName,this.convertToGammaSpace,!0),e.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_getMainUvName(e){return"vMain"+this.uv.associatedVariableName}_injectVertexCode(e){let t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,P.Vector2)),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;
`,!!this._outputs.some(n=>n.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(let n of this._outputs)n.hasEndpoints&&this._writeOutput(e,n,n.name,!0)}}_writeTextureRead(e,t=!1){let n=this.uv;if(t){if(e.target===Y.Fragment)return;let s=e.shaderLanguage===0?`texture2D(${this.samplerName},`:`textureSampleLevel(${this.samplerName}, ${this.samplerName+"Sampler"},`,o=e.shaderLanguage===0?"":", 0";e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,P.Vector4)} = ${s} ${n.associatedVariableName}${o});
`;return}let r=e.shaderLanguage===0?`texture2D(${this.samplerName},`:`textureSample(${this.samplerName}, ${this.samplerName+"Sampler"},`;if(this.uv.ownerBlock.target===Y.Fragment){e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,P.Vector4)} = ${r} ${n.associatedVariableName});
`;return}e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,P.Vector4)} = ${r} ${this._mainUVName});
`}_writeOutput(e,t,n,r=!1){if(r){if(e.target===Y.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${n};
`;return}if(this.uv.ownerBlock.target===Y.Fragment){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${n};
`;return}e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${n};
`,e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`}_emitUvAndSampler(e){e._emitVaryingFromString(this._mainUVName,P.Vector2),e._emit2DSampler(this.samplerName)}_buildBlock(e){if(super._buildBlock(e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),this._mainUVName=this._getMainUvName(e),this._emitUvAndSampler(e),e.target!==Y.Fragment){this._injectVertexCode(e);return}if(!this._outputs.some(n=>n.isConnectedInFragmentShader))return;this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");let t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._writeTextureRead(e);for(let n of this._outputs)n.hasEndpoints&&this._writeOutput(e,n,n.name);return this}serialize(){let e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,n){super._deserialize(e,t,n),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(n=e.texture.url.indexOf("data:")===0?"":n,this.texture=te.Parse(e.texture,t,n))}};ue("BABYLON.CurrentScreenBlock",ih);var rh=class extends mt{constructor(e){super(e,Y.Fragment),this._samplerName="diffuseSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",P.AutoDetect,!1,Y.VertexAndFragment),this.registerOutput("rgba",P.Color4,Y.Neutral),this.registerOutput("rgb",P.Color3,Y.Neutral),this.registerOutput("r",P.Float,Y.Neutral),this.registerOutput("g",P.Float,Y.Neutral),this.registerOutput("b",P.Float,Y.Neutral),this.registerOutput("a",P.Float,Y.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(P.Vector2|P.Vector3|P.Vector4)}getClassName(){return"ParticleTextureBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("diffuseSampler")}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){let n=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="particle_uv"&&t(r));n||(n=new Ut("uv"),n.setAsAttribute("particle_uv")),n.output.connectTo(this.uv)}}prepareDefines(e){e.setValue(this._linearDefineName,this.convertToGammaSpace,!0),e.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_writeOutput(e,t,n){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${n};
`,e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`}_buildBlock(e){if(super._buildBlock(e),e.target===Y.Vertex)return;this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");let t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,P.Vector4)} = ${e._generateTextureSample(this.uv.associatedVariableName,this._samplerName)};
`;for(let n of this._outputs)n.hasEndpoints&&this._writeOutput(e,n,n.name);return this}serialize(){let e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,n){super._deserialize(e,t,n),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(n=e.texture.url.indexOf("data:")===0?"":n,this.texture=te.Parse(e.texture,t,n))}};ue("BABYLON.ParticleTextureBlock",rh);var sh=class extends mt{constructor(e){super(e,Y.Fragment),this._isUnique=!0,this.registerInput("color",P.Color4,!1,Y.Fragment),this.registerOutput("rampColor",P.Color4,Y.Fragment)}getClassName(){return"ParticleRampGradientBlock"}get color(){return this._inputs[0]}get rampColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor")}_buildBlock(e){if(super._buildBlock(e),e.target===Y.Vertex)return;e._emit2DSampler("rampSampler","RAMPGRADIENT"),e._emitVaryingFromString("remapRanges",P.Vector4,"RAMPGRADIENT");let t=e.shaderLanguage===0?"":"fragmentInputs.";return e.compilationString+=`
            #ifdef RAMPGRADIENT
                ${e._declareLocalVar("baseColor",P.Vector4)} = ${this.color.associatedVariableName};
                ${e._declareLocalVar("alpha",P.Float)} = ${this.color.associatedVariableName}.a;

                ${e._declareLocalVar("remappedColorIndex",P.Float)} = clamp((alpha - ${t}remapRanges.x) / ${t}remapRanges.y, 0.0, 1.0);

                ${e._declareLocalVar("rampColor",P.Vector4)} = ${e._generateTextureSample("vec2(1.0 - remappedColorIndex, 0.)","rampSampler")};

                // Remapped alpha
                ${e._declareOutput(this.rampColor)} = vec4${e.fSuffix}(baseColor.rgb * rampColor.rgb, clamp((alpha * rampColor.a - ${t}remapRanges.z) / ${t}remapRanges.w, 0.0, 1.0));
            #else
                ${e._declareOutput(this.rampColor)} = ${this.color.associatedVariableName};
            #endif
        `,this}};ue("BABYLON.ParticleRampGradientBlock",sh);var oh=class extends mt{constructor(e){super(e,Y.Fragment),this._isUnique=!0,this.registerInput("color",P.Color4,!1,Y.Fragment),this.registerInput("alphaTexture",P.Float,!1,Y.Fragment),this.registerInput("alphaColor",P.Float,!1,Y.Fragment),this.registerOutput("blendColor",P.Color4,Y.Fragment)}getClassName(){return"ParticleBlendMultiplyBlock"}get color(){return this._inputs[0]}get alphaTexture(){return this._inputs[1]}get alphaColor(){return this._inputs[2]}get blendColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("sourceAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==Y.Vertex)return e.compilationString+=`
            #ifdef BLENDMULTIPLYMODE
                ${e._declareOutput(this.blendColor)};
                ${e._declareLocalVar("sourceAlpha",P.Float)}  = ${this.alphaColor.associatedVariableName} * ${this.alphaTexture.associatedVariableName};
                ${this.blendColor.associatedVariableName} = vec4${e.fSuffix}(${this.color.associatedVariableName}.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha), ${this.color.associatedVariableName}.a);
            #else
                ${e._declareOutput(this.blendColor)} = ${this.color.associatedVariableName};
            #endif
        `,this}};ue("BABYLON.ParticleBlendMultiplyBlock",oh);var ra=class extends mt{constructor(e){super(e,Y.Neutral),this.xSwizzle="x",this.ySwizzle="y",this.zSwizzle="z",this.wSwizzle="w",this.registerInput("xyzw ",P.Vector4,!0),this.registerInput("xyz ",P.Vector3,!0),this.registerInput("xy ",P.Vector2,!0),this.registerInput("zw ",P.Vector2,!0),this.registerInput("x",P.Float,!0),this.registerInput("y",P.Float,!0),this.registerInput("z",P.Float,!0),this.registerInput("w",P.Float,!0),this.registerOutput("xyzw",P.Vector4),this.registerOutput("xyz",P.Vector3),this.registerOutput("xy",P.Vector2),this.registerOutput("zw",P.Vector2)}getClassName(){return"VectorMergerBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get x(){return this._inputs[4]}get y(){return this._inputs[5]}get z(){return this._inputs[6]}get w(){return this._inputs[7]}get xyzw(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xy(){return this.xyOut}get xyz(){return this.xyzOut}_inputRename(e){return e==="xyzw "?"xyzwIn":e==="xyz "?"xyzIn":e==="xy "?"xyIn":e==="zw "?"zwIn":e}_buildSwizzle(e){return"."+(this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle).substring(0,e)}_buildBlock(e){super._buildBlock(e);let t=this.x,n=this.y,r=this.z,s=this.w,o=this.xyIn,a=this.zwIn,l=this.xyzIn,c=this.xyzwIn,u=this._outputs[0],h=this._outputs[1],d=this._outputs[2],f=this._outputs[3],p=e._getShaderType(P.Vector4),g=e._getShaderType(P.Vector3),_=e._getShaderType(P.Vector2);return c.isConnected?(u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${c.associatedVariableName}${this._buildSwizzle(4)};
`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${c.associatedVariableName}${this._buildSwizzle(3)};
`),d.hasEndpoints&&(e.compilationString+=e._declareOutput(d)+` = ${c.associatedVariableName}${this._buildSwizzle(2)};
`)):l.isConnected?(u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${p}(${l.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};
`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${l.associatedVariableName}${this._buildSwizzle(3)};
`),d.hasEndpoints&&(e.compilationString+=e._declareOutput(d)+` = ${l.associatedVariableName}${this._buildSwizzle(2)};
`)):o.isConnected?(u.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(u)+` = ${p}(${o.associatedVariableName}, ${a.associatedVariableName})${this._buildSwizzle(4)};
`:e.compilationString+=e._declareOutput(u)+` = ${p}(${o.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};
`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${g}(${o.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};
`),d.hasEndpoints&&(e.compilationString+=e._declareOutput(d)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};
`),f.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(f)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};
`:e.compilationString+=e._declareOutput(f)+` = ${_}(${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(2)};
`)):(u.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(u)+` = ${p}(${t.isConnected?this._writeVariable(t):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"}, ${a.associatedVariableName})${this._buildSwizzle(4)};
`:e.compilationString+=e._declareOutput(u)+` = ${p}(${t.isConnected?this._writeVariable(t):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};
`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${g}(${t.isConnected?this._writeVariable(t):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};
`),d.hasEndpoints&&(e.compilationString+=e._declareOutput(d)+` = ${_}(${t.isConnected?this._writeVariable(t):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(2)};
`),f.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(f)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};
`:e.compilationString+=e._declareOutput(f)+` = ${_}(${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(2)};
`)),this}serialize(){let e=super.serialize();return e.xSwizzle=this.xSwizzle,e.ySwizzle=this.ySwizzle,e.zSwizzle=this.zSwizzle,e.wSwizzle=this.wSwizzle,e}_deserialize(e,t,n){super._deserialize(e,t,n),this.xSwizzle=e.xSwizzle??"x",this.ySwizzle=e.ySwizzle??"y",this.zSwizzle=e.zSwizzle??"z",this.wSwizzle=e.wSwizzle??"w"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.xSwizzle = "${this.xSwizzle}";
`,e+=`${this._codeVariableName}.ySwizzle = "${this.ySwizzle}";
`,e+=`${this._codeVariableName}.zSwizzle = "${this.zSwizzle}";
`,e+=`${this._codeVariableName}.wSwizzle = "${this.wSwizzle}";
`,e}};ue("BABYLON.VectorMergerBlock",ra);var sa=class extends mt{constructor(e){super(e,Y.Neutral),this.sourceRange=new _e(-1,1),this.targetRange=new _e(0,1),this.registerInput("input",P.AutoDetect),this.registerInput("sourceMin",P.Float,!0),this.registerInput("sourceMax",P.Float,!0),this.registerInput("targetMin",P.Float,!0),this.registerInput("targetMax",P.Float,!0),this.registerOutput("output",P.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"RemapBlock"}get input(){return this._inputs[0]}get sourceMin(){return this._inputs[1]}get sourceMax(){return this._inputs[2]}get targetMin(){return this._inputs[3]}get targetMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],n=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),r=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),s=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),o=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=e._declareOutput(t)+` = ${s} + (${this._inputs[0].associatedVariableName} - ${n}) * (${o} - ${s}) / (${r} - ${n});
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.sourceRange = new BABYLON.Vector2(${this.sourceRange.x}, ${this.sourceRange.y});
`;return e+=`${this._codeVariableName}.targetRange = new BABYLON.Vector2(${this.targetRange.x}, ${this.targetRange.y});
`,e}serialize(){let e=super.serialize();return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e}_deserialize(e,t,n){super._deserialize(e,t,n),this.sourceRange=_e.FromArray(e.sourceRange),this.targetRange=_e.FromArray(e.targetRange)}};w([Hr("From",3)],sa.prototype,"sourceRange",void 0);w([Hr("To",3)],sa.prototype,"targetRange",void 0);ue("BABYLON.RemapBlock",sa);var $m=class extends mt{constructor(e){super(e,Y.Neutral),this.registerInput("left",P.AutoDetect),this.registerInput("right",P.AutoDetect),this.registerOutput("output",P.BasedOnInput),this.output._typeConnectionSource=this.left,this._linkConnectionTypes(0,1,!0),this.left.acceptedConnectionPointTypes.push(P.Float),this.right.acceptedConnectionPointTypes.push(P.Float),this._connectionObservers=[this.left.onTypeChangedObservable.add(()=>this._updateInputOutputTypes()),this.right.onTypeChangedObservable.add(()=>this._updateInputOutputTypes())]}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_updateInputOutputTypes(){if(this.output._typeConnectionSource=this.left,this.left.isConnected&&this.right.isConnected?(this.left.type===P.Int||this.left.type===P.Float&&this.right.type!==P.Int)&&(this.output._typeConnectionSource=this.right):this.left.isConnected!==this.right.isConnected&&(this.output._typeConnectionSource=this.left.isConnected?this.left:this.right),this.left.isConnected||this.right.isConnected)for(let[e,t]of[[this.left,this.right],[this.right,this.left]])e.acceptedConnectionPointTypes=[P.Int,P.Float],t.isConnected&&(e.acceptedConnectionPointTypes.push(t.type),(t.type===P.Int||t.type===P.Float)&&e.acceptedConnectionPointTypes.push(P.Vector2,P.Vector3,P.Vector4,P.Color3,P.Color4,P.Matrix))}dispose(){super.dispose();for(let e of this._connectionObservers)e.remove();this._connectionObservers.length=0}};var ql=class extends $m{constructor(e){super(e)}getClassName(){return"MultiplyBlock"}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} * ${this.right.associatedVariableName};
`,this}};ue("BABYLON.MultiplyBlock",ql);var Yn=(()=>{class i{get targetStopDuration(){return this._targetStopDuration}set targetStopDuration(t){this._targetStopDuration!==t&&(this._targetStopDuration=t)}get isNodeGenerated(){return!1}get noiseTexture(){return this._noiseTexture}set noiseTexture(t){this._noiseTexture!==t&&(this._noiseTexture=t,this._reset())}get _isAnimationSheetEnabled(){return this._animationSheetEnabled}set _isAnimationSheetEnabled(t){this._animationSheetEnabled!==t&&(this._animationSheetEnabled=t)}get isAnimationSheetEnabled(){return this._isAnimationSheetEnabled}set isAnimationSheetEnabled(t){this._isAnimationSheetEnabled!=t&&(this._isAnimationSheetEnabled=t,this._reset())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(t){this._useLogarithmicDepth=t&&this.getScene().getEngine().getCaps().fragmentDepthSupported}getScene(){return this._scene}_hasTargetStopDurationDependantGradient(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0}_setEngineBasedOnBlendMode(t){switch(t){case i.BLENDMODE_MULTIPLYADD:return;case i.BLENDMODE_ADD:t=1;break;case i.BLENDMODE_ONEONE:t=6;break;case i.BLENDMODE_STANDARD:t=2;break;case i.BLENDMODE_MULTIPLY:t=4;break;case i.BLENDMODE_SUBTRACT:t=3;break;default:break}this._engine.setAlphaMode(t)}getDragGradients(){return this._dragGradients}getLimitVelocityGradients(){return this._limitVelocityGradients}getColorGradients(){return this._colorGradients}getSizeGradients(){return this._sizeGradients}getColorRemapGradients(){return this._colorRemapGradients}getAlphaRemapGradients(){return this._alphaRemapGradients}getLifeTimeGradients(){return this._lifeTimeGradients}getAngularSpeedGradients(){return this._angularSpeedGradients}getVelocityGradients(){return this._velocityGradients}getStartSizeGradients(){return this._startSizeGradients}getEmitRateGradients(){return this._emitRateGradients}get direction1(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:m.Zero()}set direction1(t){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=t)}get direction2(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:m.Zero()}set direction2(t){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=t)}get minEmitBox(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:m.Zero()}set minEmitBox(t){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=t)}get maxEmitBox(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:m.Zero()}set maxEmitBox(t){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=t)}get billboardMode(){return this._billboardMode}set billboardMode(t){this._billboardMode!==t&&(this._billboardMode=t,this._reset())}get isBillboardBased(){return this._isBillboardBased}set isBillboardBased(t){this._isBillboardBased!==t&&(this._isBillboardBased=t,this._reset())}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(t){this._attachImageProcessingConfiguration(t)}_attachImageProcessingConfiguration(t){t!==this._imageProcessingConfiguration&&(!t&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=t)}_reset(){}_removeGradientAndTexture(t,n,r){if(!n)return this;let s=0;for(let o of n){if(o.gradient===t){n.splice(s,1);break}s++}return r&&r.dispose(),this}constructor(t){this.animations=[],this.renderingGroupId=0,this.emitter=m.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this._targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this.applyFog=!1,this._wasDispatched=!1,this._rootUrl="",this.noiseStrength=new m(10,10,10),this.onAnimationEnd=null,this.blendMode=i.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new _e(0,0),this._animationSheetEnabled=!1,this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new m(0,0,0),this._useLogarithmicDepth=!1,this.gravity=m.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new le(1,1,1,1),this.color2=new le(1,1,1,1),this.colorDead=new le(0,0,0,1),this.textureMask=new le(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new UT,this.id=t,this.name=t}createPointEmitter(t,n){throw new Error("Method not implemented.")}createHemisphericEmitter(t=1,n=1){throw new Error("Method not implemented.")}createSphereEmitter(t=1,n=1){throw new Error("Method not implemented.")}createDirectedSphereEmitter(t=1,n=new m(0,1,0),r=new m(0,1,0)){throw new Error("Method not implemented.")}createCylinderEmitter(t=1,n=1,r=1,s=0){throw new Error("Method not implemented.")}createDirectedCylinderEmitter(t=1,n=1,r=1,s=new m(0,1,0),o=new m(0,1,0)){throw new Error("Method not implemented.")}createConeEmitter(t=1,n=Math.PI/4){throw new Error("Method not implemented.")}createDirectedConeEmitter(t=1,n=Math.PI/4,r=new m(0,1,0),s=new m(0,1,0)){throw new Error("Method not implemented.")}createBoxEmitter(t,n,r,s){throw new Error("Method not implemented.")}}return i.BLENDMODE_ONEONE=0,i.BLENDMODE_STANDARD=1,i.BLENDMODE_ADD=2,i.BLENDMODE_MULTIPLY=3,i.BLENDMODE_MULTIPLYADD=4,i.BLENDMODE_SUBTRACT=-1,i})();ue("BABYLON.BaseParticleSystem",Yn);var ah=class extends mt{constructor(e){super(e,Y.Neutral),this.registerInput("rgba",P.Color4,!0),this.registerInput("rgb ",P.Color3,!0),this.registerOutput("rgb",P.Color3),this.registerOutput("r",P.Float),this.registerOutput("g",P.Float),this.registerOutput("b",P.Float),this.registerOutput("a",P.Float),this.inputsAreExclusive=!0}getClassName(){return"ColorSplitterBlock"}get rgba(){return this._inputs[0]}get rgbIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get r(){return this._outputs[1]}get g(){return this._outputs[2]}get b(){return this._outputs[3]}get a(){return this._outputs[4]}_inputRename(e){return e==="rgb "?"rgbIn":e}_outputRename(e){return e==="rgb"?"rgbOut":e}_buildBlock(e){super._buildBlock(e);let t=this.rgba.isConnected?this.rgba:this.rgbIn;if(!t.isConnected)return;let n=this._outputs[0],r=this._outputs[1],s=this._outputs[2],o=this._outputs[3],a=this._outputs[4];return n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${t.associatedVariableName}.rgb;
`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName}.r;
`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = ${t.associatedVariableName}.g;
`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${t.associatedVariableName}.b;
`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${t.associatedVariableName}.a;
`),this}};ue("BABYLON.ColorSplitterBlock",ah);var Wm=class{constructor(e){this.name=Ge.NAME_PROCEDURALTEXTURE,this.scene=e}register(){this.scene._beforeClearStage.registerStep(Ge.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)}rebuild(){}dispose(){}_beforeClear(){if(this.scene.proceduralTexturesEnabled){z.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(let e=0;e<this.scene.proceduralTextures.length;e++){let t=this.scene.proceduralTextures[e];t._shouldRender()&&t.render()}z.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}}};var Wr=class i extends te{get shaderLanguage(){return this._shaderLanguage}constructor(e,t,n,r,s=null,o=!0,a=!1,l=0){super(null,r,!o),this.isEnabled=!0,this.autoClear=!0,this.onGeneratedObservable=new B,this.onBeforeGenerationObservable=new B,this.nodeMaterialSource=null,this.defines="",this._textures={},this._currentRefreshId=-1,this._frameId=-1,this._refreshRate=1,this._vertexBuffers={},this._uniforms=new Array,this._samplers=new Array,this._floats={},this._ints={},this._floatsArrays={},this._colors3={},this._colors4={},this._vectors2={},this._vectors3={},this._vectors4={},this._matrices={},this._fallbackTextureUsed=!1,this._cachedDefines=null,this._contentUpdateId=-1,this._rtWrapper=null,s!==null&&!(s instanceof te)?(this._options=s,this._fallbackTexture=s.fallbackTexture??null):(this._options={},this._fallbackTexture=s),this._shaderLanguage=this._options.shaderLanguage??0,r=this.getScene()||Ie.LastCreatedScene;let c=r._getComponent(Ge.NAME_PROCEDURALTEXTURE);c||(c=new Wm(r),r._addComponent(c)),r.proceduralTextures.push(this),this._fullEngine=r.getEngine(),this.name=e,this.isRenderTarget=!0,this._size=t,this._textureType=l,this._generateMipMaps=o,this._drawWrapper=new mi(this._fullEngine),this.setFragment(n);let u=this._createRtWrapper(a,t,o,l);this._texture=u.texture;let h=[];h.push(1,1),h.push(-1,1),h.push(-1,-1),h.push(1,-1),this._vertexBuffers[S.PositionKind]=new S(this._fullEngine,h,S.PositionKind,!1,!1,2),this._createIndexBuffer()}_createRtWrapper(e,t,n,r){return e?(this._rtWrapper=this._fullEngine.createRenderTargetCubeTexture(t,K({generateMipMaps:n,generateDepthBuffer:!1,generateStencilBuffer:!1,type:r},this._options)),this.setFloat("face",0)):(this._rtWrapper=this._fullEngine.createRenderTargetTexture(t,K({generateMipMaps:n,generateDepthBuffer:!1,generateStencilBuffer:!1,type:r},this._options)),this._rtWrapper.is3D&&(this.setFloat("layer",0),this.setInt("layerNum",0))),this._rtWrapper}getEffect(){return this._drawWrapper.effect}_setEffect(e){this._drawWrapper.effect=e}getContent(){return this._contentData&&this._frameId===this._contentUpdateId?this._contentData:(this._contentData?this._contentData.then(e=>{this._contentData=this.readPixels(0,0,e),this._contentUpdateId=this._frameId}):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId),this._contentData)}_createIndexBuffer(){let e=this._fullEngine,t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){let e=this._vertexBuffers[S.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===Tn.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=Tn.REFRESHRATE_RENDER_ONCE)}reset(){this._drawWrapper.effect?.dispose(),this._drawWrapper.effect=null,this._cachedDefines=null}_getDefines(){return this.defines}executeWhenReady(e){if(this.isReady()){e(this);return}let t=this.getEffect();t&&t.executeWhenCompiled(()=>{e(this)})}isReady(){let e=this._fullEngine;if(this.nodeMaterialSource)return this._drawWrapper.effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;if(!this._texture)return!1;let t=this._getDefines();if(this._drawWrapper.effect&&t===this._cachedDefines&&this._drawWrapper.effect.isReady())return!0;let n={vertex:"procedural",fragmentElement:this._fragment.fragmentElement,fragmentSource:this._fragment.fragmentSource,fragment:typeof this._fragment=="string"?this._fragment:void 0};return this._cachedDefines!==t&&(this._cachedDefines=t,this._drawWrapper.effect=e.createEffect(n,[S.PositionKind],this._uniforms,this._samplers,t,void 0,void 0,()=>{this._rtWrapper?.dispose(),this._rtWrapper=this._texture=null,this._fallbackTexture&&(this._texture=this._fallbackTexture._texture,this._texture&&this._texture.incrementReferences()),this._fallbackTextureUsed=!0},void 0,this._shaderLanguage,()=>T(this,null,function*(){this._options.extraInitializationsAsync?this.shaderLanguage===1?yield Promise.all([import("./chunk-SKLIFPAC.js"),this._options.extraInitializationsAsync()]):yield Promise.all([import("./chunk-MCV5RKKF.js"),this._options.extraInitializationsAsync()]):this.shaderLanguage===1?yield import("./chunk-SKLIFPAC.js"):yield import("./chunk-MCV5RKKF.js")}))),this._drawWrapper.effect.isReady()}resetRefreshCounter(){this._currentRefreshId=-1}setFragment(e){this._fragment=e}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}_shouldRender(){return!this.isEnabled||!this.isReady()||!this._texture?(this._texture&&(this._texture.isReady=!1),!1):this._fallbackTextureUsed?!1:this._currentRefreshId===-1?(this._currentRefreshId=1,this._frameId++,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this._size}resize(e,t){if(this._fallbackTextureUsed||!this._rtWrapper||!this._texture)return;let n=this._texture.isCube;this._rtWrapper.dispose();let r=this._createRtWrapper(n,e,t,this._textureType);this._texture=r.texture,this._size=e,this._generateMipMaps=t}_checkUniform(e){this._uniforms.indexOf(e)===-1&&this._uniforms.push(e)}setTexture(e,t){return this._samplers.indexOf(e)===-1&&this._samplers.push(e),this._textures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}render(e){let t=this.getScene();if(!t)return;let n=this._fullEngine;if(n.enableEffect(this._drawWrapper),this.onBeforeGenerationObservable.notifyObservers(this),n.setState(!1),!this.nodeMaterialSource){for(let s in this._textures)this._drawWrapper.effect.setTexture(s,this._textures[s]);for(let s in this._ints)this._drawWrapper.effect.setInt(s,this._ints[s]);for(let s in this._floats)this._drawWrapper.effect.setFloat(s,this._floats[s]);for(let s in this._floatsArrays)this._drawWrapper.effect.setArray(s,this._floatsArrays[s]);for(let s in this._colors3)this._drawWrapper.effect.setColor3(s,this._colors3[s]);for(let s in this._colors4){let o=this._colors4[s];this._drawWrapper.effect.setFloat4(s,o.r,o.g,o.b,o.a)}for(let s in this._vectors2)this._drawWrapper.effect.setVector2(s,this._vectors2[s]);for(let s in this._vectors3)this._drawWrapper.effect.setVector3(s,this._vectors3[s]);for(let s in this._vectors4)this._drawWrapper.effect.setVector4(s,this._vectors4[s]);for(let s in this._matrices)this._drawWrapper.effect.setMatrix(s,this._matrices[s])}if(!this._texture||!this._rtWrapper)return;n._debugPushGroup?.(`procedural texture generation for ${this.name}`,1);let r=n.currentViewport;if(this.isCube)for(let s=0;s<6;s++)n.bindFramebuffer(this._rtWrapper,s,void 0,void 0,!0),n.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._drawWrapper.effect.setFloat("face",s),this.autoClear&&n.clear(t.clearColor,!0,!1,!1),n.drawElementsType(Oe.TriangleFillMode,0,6),n.unBindFramebuffer(this._rtWrapper,!0);else{let s=1;this._rtWrapper.is3D?s=this._rtWrapper.depth:this._rtWrapper.is2DArray&&(s=this._rtWrapper.layers);for(let o=0;o<s;o++){if(n.bindFramebuffer(this._rtWrapper,0,void 0,void 0,!0,0,o),n.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._rtWrapper.is3D||this._rtWrapper.is2DArray){this._drawWrapper.effect?.setFloat("layer",s!==1?o/(s-1):0),this._drawWrapper.effect?.setInt("layerNum",o);for(let a in this._textures)this._drawWrapper.effect.setTexture(a,this._textures[a])}this.autoClear&&n.clear(t.clearColor,!0,!1,!1),n.drawElementsType(Oe.TriangleFillMode,0,6),n.unBindFramebuffer(this._rtWrapper,!this._generateMipMaps)}}r&&n.setViewport(r),this.isCube&&n.generateMipMapsForCubemap(this._texture,!0),n._debugPopGroup?.(1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}clone(){let e=this.getSize(),t=new i(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t}dispose(){let e=this.getScene();if(!e)return;let t=e.proceduralTextures.indexOf(this);t>=0&&e.proceduralTextures.splice(t,1);let n=this._vertexBuffers[S.PositionKind];n&&(n.dispose(),this._vertexBuffers[S.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),super.dispose()}};w([L()],Wr.prototype,"isEnabled",void 0);w([L()],Wr.prototype,"autoClear",void 0);w([L()],Wr.prototype,"_generateMipMaps",void 0);w([L()],Wr.prototype,"_size",void 0);w([L()],Wr.prototype,"refreshRate",null);ue("BABYLON.ProceduralTexture",Wr);var He=(function(i){return i[i.Cos=0]="Cos",i[i.Sin=1]="Sin",i[i.Abs=2]="Abs",i[i.Exp=3]="Exp",i[i.Exp2=4]="Exp2",i[i.Round=5]="Round",i[i.Floor=6]="Floor",i[i.Ceiling=7]="Ceiling",i[i.Sqrt=8]="Sqrt",i[i.Log=9]="Log",i[i.Tan=10]="Tan",i[i.ArcTan=11]="ArcTan",i[i.ArcCos=12]="ArcCos",i[i.ArcSin=13]="ArcSin",i[i.Fract=14]="Fract",i[i.Sign=15]="Sign",i[i.Radians=16]="Radians",i[i.Degrees=17]="Degrees",i[i.Set=18]="Set",i})(He||{}),Yl=class extends mt{constructor(e){super(e,Y.Neutral),this.operation=He.Cos,this.registerInput("input",P.AutoDetect),this.registerOutput("output",P.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"TrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],n="";switch(this.operation){case He.Cos:{n="cos";break}case He.Sin:{n="sin";break}case He.Abs:{n="abs";break}case He.Exp:{n="exp";break}case He.Exp2:{n="exp2";break}case He.Round:{n="round";break}case He.Floor:{n="floor";break}case He.Ceiling:{n="ceil";break}case He.Sqrt:{n="sqrt";break}case He.Log:{n="log";break}case He.Tan:{n="tan";break}case He.ArcTan:{n="atan";break}case He.ArcCos:{n="acos";break}case He.ArcSin:{n="asin";break}case He.Fract:{n="fract";break}case He.Sign:{n="sign";break}case He.Radians:{n="radians";break}case He.Degrees:{n="degrees";break}case He.Set:{n="";break}}return e.compilationString+=e._declareOutput(t)+` = ${n}(${this.input.associatedVariableName});
`,this}serialize(){let e=super.serialize();return e.operation=this.operation,e}_deserialize(e,t,n){super._deserialize(e,t,n),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.TrigonometryBlockOperations.${He[this.operation]};
`}};w([Hr("Operation",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Cos",value:He.Cos},{label:"Sin",value:He.Sin},{label:"Abs",value:He.Abs},{label:"Exp",value:He.Exp},{label:"Exp2",value:He.Exp2},{label:"Round",value:He.Round},{label:"Floor",value:He.Floor},{label:"Ceiling",value:He.Ceiling},{label:"Sqrt",value:He.Sqrt},{label:"Log",value:He.Log},{label:"Tan",value:He.Tan},{label:"ArcTan",value:He.ArcTan},{label:"ArcCos",value:He.ArcCos},{label:"ArcSin",value:He.ArcSin},{label:"Fract",value:He.Fract},{label:"Sign",value:He.Sign},{label:"Radians",value:He.Radians},{label:"Degrees",value:He.Degrees},{label:"Set",value:He.Set}]})],Yl.prototype,"operation",void 0);ue("BABYLON.TrigonometryBlock",Yl);var EC={effect:null,subMesh:null},AC=class extends Nh(Cs){},oa=class extends Ra(AC){constructor(){super(),this.NORMAL=!1,this.TANGENT=!1,this.VERTEXCOLOR_NME=!1,this.PREPASS=!1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_POSITION=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.MORPHTARGETS_UV2=!1,this.MORPHTARGETS_COLOR=!1,this.MORPHTARGETTEXTURE_HASPOSITIONS=!1,this.MORPHTARGETTEXTURE_HASNORMALS=!1,this.MORPHTARGETTEXTURE_HASTANGENTS=!1,this.MORPHTARGETTEXTURE_HASUVS=!1,this.MORPHTARGETTEXTURE_HASUV2S=!1,this.MORPHTARGETTEXTURE_HASCOLORS=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.BUMPDIRECTUV=0,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.AREALIGHTSUPPORTED=!0,this.AREALIGHTNOROUGHTNESS=!0,this.rebuild()}setValue(e,t,n=!1){this[e]===void 0&&this._keys.push(e),n&&this[e]!==t&&this.markAsUnprocessed(),this[e]=t}},wC=class extends Oa(_r){},qt=class i extends wC{static _BlockIsTextureBlock(e){return e.getClassName()==="TextureBlock"||e.getClassName()==="ReflectionTextureBaseBlock"||e.getClassName()==="ReflectionTextureBlock"||e.getClassName()==="ReflectionBlock"||e.getClassName()==="RefractionBlock"||e.getClassName()==="CurrentScreenBlock"||e.getClassName()==="SmartFilterTextureBlock"||e.getClassName()==="ParticleTextureBlock"||e.getClassName()==="ImageSourceBlock"||e.getClassName()==="TriPlanarBlock"||e.getClassName()==="BiPlanarBlock"||e.getClassName()==="PrePassTextureBlock"}get buildIsInProgress(){return this._buildIsInProgress}set _glowModeEnabled(e){this._useAdditionalColor=e}_getGlobalNodeMaterialEditor(){if(typeof NODEEDITOR<"u")return NODEEDITOR;if(typeof BABYLON<"u"&&typeof BABYLON.NodeEditor<"u")return BABYLON}get shaderLanguage(){return this._options?.shaderLanguage||i.DefaultShaderLanguage}set shaderLanguage(e){this._options.shaderLanguage=e}get options(){return this._options}set options(e){this._options=e}get mode(){return this._mode}set mode(e){this._mode=e}get buildId(){return this._buildId}set buildId(e){this._buildId=e}constructor(e,t,n={}){if(super(e,t||Ie.LastCreatedScene),this._buildId=i._BuildIdGenerator++,this._buildWasSuccessful=!1,this._cachedWorldViewMatrix=new V,this._cachedWorldViewProjectionMatrix=new V,this._optimizers=new Array,this._animationFrame=-1,this._buildIsInProgress=!1,this.BJSNODEMATERIALEDITOR=this._getGlobalNodeMaterialEditor(),this._useAdditionalColor=!1,this.editorData=null,this.ignoreAlpha=!1,this.maxSimultaneousLights=4,this.onBuildObservable=new B,this.onBuildErrorObservable=new B,this._vertexOutputNodes=new Array,this._fragmentOutputNodes=new Array,this.attachedBlocks=[],this._mode=rn.Material,this.forceAlphaBlending=!1,!i.UseNativeShaderLanguageOfEngine&&n&&n.shaderLanguage===1&&!this.getScene().getEngine().isWebGPU)throw new Error("WebGPU shader language is only supported with WebGPU engine");this._options=K({emitComments:!1,shaderLanguage:i.DefaultShaderLanguage},n),i.UseNativeShaderLanguageOfEngine&&(this._options.shaderLanguage=this.getScene().getEngine().isWebGPU?1:0),this._attachImageProcessingConfiguration(null)}getClassName(){return"NodeMaterial"}getBlockByName(e){let t=null;for(let n of this.attachedBlocks)if(n.name===e)if(!t)t=n;else return z.Warn("More than one block was found with the name `"+e+"`"),t;return t}getBlockByPredicate(e){for(let t of this.attachedBlocks)if(e(t))return t;return null}getInputBlockByPredicate(e){for(let t of this.attachedBlocks)if(t.isInput&&e(t))return t;return null}getInputBlocks(){let e=[];for(let t of this.attachedBlocks)t.isInput&&e.push(t);return e}registerOptimizer(e){if(!(this._optimizers.indexOf(e)>-1))return this._optimizers.push(e),this}unregisterOptimizer(e){let t=this._optimizers.indexOf(e);if(t!==-1)return this._optimizers.splice(t,1),this}addOutputNode(e){if(e.target===null)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return(e.target&Y.Vertex)!==0&&this._addVertexOutputNode(e),(e.target&Y.Fragment)!==0&&this._addFragmentOutputNode(e),this}removeOutputNode(e){return e.target===null?this:((e.target&Y.Vertex)!==0&&this._removeVertexOutputNode(e),(e.target&Y.Fragment)!==0&&this._removeFragmentOutputNode(e),this)}_addVertexOutputNode(e){if(this._vertexOutputNodes.indexOf(e)===-1)return e.target=Y.Vertex,this._vertexOutputNodes.push(e),this}_removeVertexOutputNode(e){let t=this._vertexOutputNodes.indexOf(e);if(t!==-1)return this._vertexOutputNodes.splice(t,1),this}_addFragmentOutputNode(e){if(this._fragmentOutputNodes.indexOf(e)===-1)return e.target=Y.Fragment,this._fragmentOutputNodes.push(e),this}_removeFragmentOutputNode(e){let t=this._fragmentOutputNodes.indexOf(e);if(t!==-1)return this._fragmentOutputNodes.splice(t,1),this}get _supportGlowLayer(){return this._fragmentOutputNodes.length===0?!1:!!this._fragmentOutputNodes.some(e=>e.additionalColor&&e.additionalColor.isConnected)}needAlphaBlending(){return this.ignoreAlpha?!1:this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending}needAlphaTesting(){return this._sharedData&&this._sharedData.hints.needAlphaTesting}_processInitializeOnLink(e,t,n,r=!0){(e.target===Y.VertexAndFragment||t.target===Y.Fragment&&e.target===Y.Vertex&&e._preparationId!==this._buildId)&&n.push(e),this._initializeBlock(e,t,n,r)}_attachBlock(e){if(this.attachedBlocks.indexOf(e)===-1){if(e.isUnique){let t=e.getClassName();for(let n of this.attachedBlocks)if(n.getClassName()===t){this._sharedData.raiseBuildError(`Cannot have multiple blocks of type ${t} in the same NodeMaterial`);return}}this.attachedBlocks.push(e)}}_initializeBlock(e,t,n,r=!0){e.initialize(t),r&&e.autoConfigure(this),e._preparationId=this._buildId,this._attachBlock(e);for(let s of e.inputs){s.associatedVariableName="";let o=s.connectedPoint;if(o&&!o._preventBubbleUp){let a=o.ownerBlock;a!==e&&this._processInitializeOnLink(a,t,n,r)}}if(e.isLoop){let s=e;if(s.loopID.hasEndpoints)for(let o of s.loopID.endpoints){let a=o.ownerBlock;a.outputs.length===0&&(t._terminalBlocks.add(a),this._processInitializeOnLink(a,t,n,r))}}else if(e.isTeleportOut){let s=e;s.entryPoint&&this._processInitializeOnLink(s.entryPoint,t,n,r)}for(let s of e.outputs)s.associatedVariableName=""}_resetDualBlocks(e,t){e.target===Y.VertexAndFragment&&(e.buildId=t);for(let n of e.inputs){let r=n.connectedPoint;if(r&&!r._preventBubbleUp){let s=r.ownerBlock;s!==e&&this._resetDualBlocks(s,t)}}if(e.isTeleportOut){let n=e;n.entryPoint&&this._resetDualBlocks(n.entryPoint,t)}else if(e.isLoop){let n=e;if(n.loopID.hasEndpoints)for(let r of n.loopID.endpoints){let s=r.ownerBlock;s.outputs.length===0&&this._resetDualBlocks(s,t)}}}removeBlock(e){let t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e.isFinalMerger&&this.removeOutputNode(e)}build(e=!1,t=!0,n=!1){if(this._buildIsInProgress){N.Warn("Build is already in progress, You can use NodeMaterial.onBuildObservable to determine when the build is completed.");return}this._buildIsInProgress=!0,!this._vertexCompilationState&&!n&&(n=!0),this._buildWasSuccessful=!1;let r=this.getScene().getEngine(),s=this._mode===rn.Particle||this._mode===rn.SFE;if(this._vertexOutputNodes.length===0&&!s){this.onBuildErrorObservable.notifyObservers("You must define at least one vertexOutputNode"),this._buildIsInProgress=!1;return}if(this._fragmentOutputNodes.length===0){this.onBuildErrorObservable.notifyObservers("You must define at least one fragmentOutputNode"),this._buildIsInProgress=!1;return}this._vertexCompilationState=new eh,this._vertexCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._vertexCompilationState.target=Y.Vertex,this._fragmentCompilationState=new eh,this._fragmentCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._fragmentCompilationState.target=Y.Fragment;let o=this._fragmentOutputNodes.filter(h=>h._isFinalOutputAndActive).length>1,a=this._fragmentOutputNodes;o&&(a=this._fragmentOutputNodes.filter(h=>!h._isFinalOutputAndActive),a.push(this._fragmentOutputNodes.filter(h=>h._isFinalOutputAndActive&&h._hasPrecedence)[0])),this._sharedData=new zm,this._sharedData.nodeMaterial=this,this._sharedData.fragmentOutputNodes=a,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=s;let l=[],c=[];for(let h of this._vertexOutputNodes)l.push(h),this._initializeBlock(h,this._vertexCompilationState,c,n);for(let h of a)c.push(h),this._initializeBlock(h,this._fragmentCompilationState,l,n);let u=0;for(let h of this.attachedBlocks)h.codeIsReady||(u++,h.onCodeIsReadyObservable.addOnce(()=>{u--,u===0&&this._finishBuildProcess(e,t,l,c)}));u===0&&this._finishBuildProcess(e,t,l,c)}_finishBuildProcess(e=!1,t=!0,n,r){this.optimize();for(let l of n)l.build(this._vertexCompilationState,n);this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(let l of r)this._resetDualBlocks(l,this._buildId-1);for(let l of r)l.build(this._fragmentCompilationState,r);this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),t&&(this._buildId=i._BuildIdGenerator++),e&&(N.Log("Vertex shader:"),N.Log(this._vertexCompilationState.compilationString),N.Log("Fragment shader:"),N.Log(this._fragmentCompilationState.compilationString));let s=this._sharedData.emitErrors();this._buildIsInProgress=!1,s&&(this._buildWasSuccessful=!0,this.onBuildObservable.notifyObservers(this));let o=this.getScene().meshes;for(let l of o)if(l.subMeshes)for(let c of l.subMeshes){if(c.getMaterial()!==this||!c.materialDefines)continue;let u=c.materialDefines;u.markAllAsDirty(),u.reset()}this.prePassTextureInputs.length&&this.getScene().enablePrePassRenderer();let a=this.getScene().prePassRenderer;a&&a.markAsDirty()}optimize(){for(let e of this._optimizers)e.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}_prepareDefinesForAttributes(e,t){let n=t.NORMAL,r=t.TANGENT,s=t.VERTEXCOLOR_NME;t.NORMAL=e.isVerticesDataPresent(S.NormalKind),t.TANGENT=e.isVerticesDataPresent(S.TangentKind);let o=e.useVertexColors&&e.isVerticesDataPresent(S.ColorKind);t.VERTEXCOLOR_NME=o;let a=!1;for(let c=1;c<=6;++c){let u=t["UV"+c];t["UV"+c]=e.isVerticesDataPresent(`uv${c===1?"":c}`),a=a||t["UV"+c]!==u}let l=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;Ah(this.getScene(),t,!l),Pa.PrepareDefines(this.getScene().getEngine().currentRenderPassId,e,t),(n!==t.NORMAL||r!==t.TANGENT||s!==t.VERTEXCOLOR_NME||a)&&t.markAsAttributesDirty()}get isPrePassCapable(){return!0}get prePassTextureOutputs(){let e=this.getBlockByPredicate(n=>n.getClassName()==="PrePassOutputBlock"),t=[4];return!e||this.prePassTextureInputs.length||(e.viewDepth.isConnected&&t.push(5),e.screenDepth.isConnected&&t.push(10),e.viewNormal.isConnected&&t.push(6),e.worldNormal.isConnected&&t.push(8),e.worldPosition.isConnected&&t.push(1),e.localPosition.isConnected&&t.push(9),e.reflectivity.isConnected&&t.push(3),e.velocity.isConnected&&t.push(2),e.velocityLinear.isConnected&&t.push(11)),t}get prePassTextureInputs(){let e=this.getAllTextureBlocks().filter(n=>n.getClassName()==="PrePassTextureBlock"),t=[];for(let n of e)n.position.isConnected&&!t.includes(1)&&t.push(1),n.localPosition.isConnected&&!t.includes(9)&&t.push(9),n.depth.isConnected&&!t.includes(5)&&t.push(5),n.screenDepth.isConnected&&!t.includes(10)&&t.push(10),n.normal.isConnected&&!t.includes(6)&&t.push(6),n.worldNormal.isConnected&&!t.includes(8)&&t.push(8);return t}setPrePassRenderer(e){let t=this.prePassTextureInputs.concat(this.prePassTextureOutputs);if(e&&t.length>1){let n=e.getEffectConfiguration("nodeMaterial");n||(n=e.addEffectConfiguration({enabled:!0,needsImageProcessing:!1,name:"nodeMaterial",texturesRequired:[]}));for(let r of t)n.texturesRequired.includes(r)||n.texturesRequired.push(r);n.enabled=!0}return t.length>1}createPostProcess(e,t=1,n=1,r,s,o=0,a=5){return this.mode!==rn.PostProcess&&this.mode!==rn.SFE?(N.Log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,t,n,r,s,o,a)}createEffectForPostProcess(e){this._createEffectForPostProcess(e)}_createEffectForPostProcess(e,t,n=1,r=1,s,o,a=0,l=5){let c=this.name+this._buildId,u=new oa,h=this._buildId;this._processDefines(u);let d=this._sharedData.checks.emitVertex?this._vertexCompilationState._builtCompilationString:void 0;return Ft.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,d,this.shaderLanguage),e?e.updateEffect(u.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,c,c):e=new Ta(this.name+"PostProcess",c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n,t,r,s,o,u.toString(),a,d?c:"postprocess",{maxSimultaneousLights:this.maxSimultaneousLights},!1,l,this.shaderLanguage),e.nodeMaterialSource=this,e.onApplyObservable.add(f=>{h!==this._buildId&&(delete Ft.ShadersStore[c+"VertexShader"],delete Ft.ShadersStore[c+"PixelShader"],c=this.name+this._buildId,u.markAllAsDirty(),h=this._buildId),this._processDefines(u)&&(Ft.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),mg.SetImmediate(()=>e.updateEffect(u.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,c,c))),this._checkInternals(f)}),e}createProceduralTexture(e,t){if(this.mode!==rn.ProceduralTexture)return N.Log("Incompatible material mode"),null;let n=this.name+this._buildId,r=new Wr(n,e,null,t),s=new oa,o=this._processDefines(s);Ft.RegisterShader(n,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage);let a=this.getScene().getEngine().createEffect({vertexElement:n,fragmentElement:n},[S.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,s.toString(),o?.fallbacks,void 0,void 0,void 0,this.shaderLanguage);r.nodeMaterialSource=this,r._setEffect(a);let l=this._buildId,c=()=>{l!==this._buildId&&(delete Ft.ShadersStore[n+"VertexShader"],delete Ft.ShadersStore[n+"PixelShader"],n=this.name+this._buildId,s.markAllAsDirty(),l=this._buildId);let u=this._processDefines(s);u&&(Ft.RegisterShader(n,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage),mg.SetImmediate(()=>{a=this.getScene().getEngine().createEffect({vertexElement:n,fragmentElement:n},[S.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,s.toString(),u?.fallbacks,void 0),r._setEffect(a)})),this._checkInternals(a)};return r.onBeforeGenerationObservable.add(()=>{c()}),this.onBuildObservable.add(()=>{c()}),r}_createEffectForParticles(e,t,n,r,s,o,a=""){let l=this.name+this._buildId+"_"+t;o||(o=new oa);let c=this._buildId,u=[],h=a;if(!s){let d=this._processDefines(o);Ft.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,void 0,this.shaderLanguage),e.fillDefines(u,t,!1),h=u.join(`
`),s=this.getScene().getEngine().createEffectForParticles(l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,o.toString()+`
`+h,d?.fallbacks,n,r,e,this.shaderLanguage),e.setCustomEffect(s,t)}s.onBindObservable.add(d=>{c!==this._buildId&&(delete Ft.ShadersStore[l+"PixelShader"],l=this.name+this._buildId+"_"+t,o.markAllAsDirty(),c=this._buildId),u.length=0,e.fillDefines(u,t,!1);let f=u.join(`
`);f!==h&&(o.markAllAsDirty(),h=f);let p=this._processDefines(o);if(p){Ft.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,void 0,this.shaderLanguage),d=this.getScene().getEngine().createEffectForParticles(l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,o.toString()+`
`+h,p?.fallbacks,n,r,e),e.setCustomEffect(d,t),this._createEffectForParticles(e,t,n,r,d,o,a);return}this._checkInternals(d)})}_checkInternals(e){if(this._sharedData.animatedInputs){let t=this.getScene(),n=t.getFrameId();if(this._animationFrame!==n){for(let r of this._sharedData.animatedInputs)r.animate(t);this._animationFrame=n}}for(let t of this._sharedData.bindableBlocks)t.bind(e,this);for(let t of this._sharedData.inputBlocks)t._transmit(e,this.getScene(),this)}createEffectForParticles(e,t,n){if(this.mode!==rn.Particle){N.Log("Incompatible material mode");return}this._createEffectForParticles(e,Yn.BLENDMODE_ONEONE,t,n),this._createEffectForParticles(e,Yn.BLENDMODE_MULTIPLY,t,n)}createAsShadowDepthWrapper(e){if(this.mode!==rn.Material){N.Log("Incompatible material mode");return}e.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene())}_processDefines(e,t,n=!1,r){let s=null,o=this.getScene();MT(o,e)&&e.markAsMiscDirty();for(let a of this._sharedData.blocksWithDefines)a.initializeDefines(e);for(let a of this._sharedData.blocksWithDefines)a.prepareDefines(e,this,t,n,r);if(e.isDirty){let a=e._areLightsDisposed;e.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString;for(let d of this._sharedData.repeatableContentBlocks)d.replaceRepeatableContent(this._vertexCompilationState,e,t);let l=[];for(let d of this._sharedData.dynamicUniformBlocks)d.updateUniformsAndSamples(this._vertexCompilationState,this,e,l);let c=this._vertexCompilationState.uniforms;for(let d of this._fragmentCompilationState.uniforms)c.indexOf(d)===-1&&c.push(d);let u=this._vertexCompilationState.samplers;for(let d of this._fragmentCompilationState.samplers)u.indexOf(d)===-1&&u.push(d);let h=new fr;for(let d of this._sharedData.blocksWithFallbacks)d.provideFallbacks(h,t);s={lightDisposed:a,uniformBuffers:l,mergedUniforms:c,mergedSamplers:u,fallbacks:h}}return s}isReadyForSubMesh(e,t,n=!1){if(!this._buildWasSuccessful)return!1;let r=this.getScene();if(this._sharedData.animatedInputs){let c=r.getFrameId();if(this._animationFrame!==c){for(let u of this._sharedData.animatedInputs)u.animate(r);this._animationFrame=c}}let s=t._drawWrapper;if(s.effect&&this.isFrozen&&s._wasPreviouslyReady&&s._wasPreviouslyUsingInstances===n)return!0;(!t.materialDefines||typeof t.materialDefines=="string")&&(t.materialDefines=new oa);let o=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;let a=r.getEngine();if(this._prepareDefinesForAttributes(e,o),this._sharedData.blockingBlocks.some(c=>!c.isReady(e,this,o,n)))return!1;let l=this._processDefines(o,e,n,t);if(l){let c=t.effect,u=o.toString(),h=a.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:l.mergedUniforms,uniformBuffersNames:l.uniformBuffers,samplers:l.mergedSamplers,defines:u,fallbacks:l.fallbacks,onCompiled:this.onCompiled,onError:this.onError,multiTarget:o.PREPASS,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:o.NUM_MORPH_INFLUENCERS},shaderLanguage:this.shaderLanguage},a);if(h)if(this._onEffectCreatedObservable&&(EC.effect=h,EC.subMesh=t,this._onEffectCreatedObservable.notifyObservers(EC)),this.allowShaderHotSwapping&&c&&!h.isReady()){if(h=c,o.markAsUnprocessed(),l.lightDisposed)return o._areLightsDisposed=!0,!1}else r.resetCachedMaterial(),t.setEffect(h,o,this._materialContext)}if(o.AREALIGHTUSED){for(let c=0;c<e.lightSources.length;c++)if(!e.lightSources[c]._isReady())return!1}return!t.effect||!t.effect.isReady()?!1:(o._renderId=r.getRenderId(),s._wasPreviouslyReady=!0,s._wasPreviouslyUsingInstances=n,this._checkScenePerformancePriority(),!0)}get compiledShaders(){return this._buildWasSuccessful||this.build(),`// Vertex shader
${this._vertexCompilationState.compilationString}

// Fragment shader
${this._fragmentCompilationState.compilationString}`}_getProcessedFragmentAsync(){return T(this,null,function*(){this._buildWasSuccessful||this.build();let e=new oa;this._processDefines(e);let t=e.toString();return this.mode===rn.SFE&&(t+=`#define ${Hm}
`),yield this._fragmentCompilationState.getProcessedShaderAsync(t)})}bindOnlyWorldMatrix(e){let t=this.getScene();if(!this._activeEffect)return;let n=this._sharedData.hints;n.needWorldViewMatrix&&e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),n.needWorldViewProjectionMatrix&&e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(let r of this._sharedData.inputBlocks)r._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}bindForSubMesh(e,t,n){let r=this.getScene(),s=n.effect;if(!s)return;this._activeEffect=s,this.bindOnlyWorldMatrix(e);let o=this._mustRebind(r,s,n,t.visibility),a=this._sharedData;if(o){for(let l of a.bindableBlocks)l.bind(s,this,t,n);for(let l of a.forcedBindableBlocks)l.bind(s,this,t,n);for(let l of a.inputBlocks)l._transmit(s,r,this)}else if(!this.isFrozen)for(let l of a.forcedBindableBlocks)l.bind(s,this,t,n);this._afterBind(t,this._activeEffect,n)}getActiveTextures(){let e=super.getActiveTextures();return this._sharedData&&e.push(...this._sharedData.textureBlocks.filter(t=>t.texture).map(t=>t.texture)),e}getTextureBlocks(){return this._sharedData?this._sharedData.textureBlocks:[]}getAllTextureBlocks(){let e=[];for(let t of this.attachedBlocks)i._BlockIsTextureBlock(t)&&e.push(t);return e}hasTexture(e){if(super.hasTexture(e))return!0;if(!this._sharedData)return!1;for(let t of this._sharedData.textureBlocks)if(t.texture===e)return!0;return!1}dispose(e,t,n){if(t)for(let r of this.getTextureBlocks().filter(s=>s.texture).map(s=>s.texture))r.dispose();for(let r of this.attachedBlocks)r.dispose();this.attachedBlocks.length=0,this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this.onBuildErrorObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),super.dispose(e,t,n)}_createNodeEditor(e){let t=K({nodeMaterial:this},e);this.BJSNODEMATERIALEDITOR.NodeEditor.Show(t)}edit(e){return T(this,null,function*(){return yield new Promise(t=>{if(this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),typeof this.BJSNODEMATERIALEDITOR>"u"){let n=e&&e.editorURL?e.editorURL:i.EditorURL;z.LoadBabylonScript(n,()=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this._createNodeEditor(e?.nodeEditorConfig),t()})}else this._createNodeEditor(e?.nodeEditorConfig),t()})})}clear(){this._vertexOutputNodes.length=0,this._fragmentOutputNodes.length=0,this.attachedBlocks.length=0,this._buildIsInProgress=!1}setToDefault(){this.clear(),this.editorData=null;let e=new Ut("Position");e.setAsAttribute("position");let t=new Ut("World");t.setAsSystemValue(nt.World);let n=new na("WorldPos");e.connectTo(n),t.connectTo(n);let r=new Ut("ViewProjection");r.setAsSystemValue(nt.ViewProjection);let s=new na("WorldPos * ViewProjectionTransform");n.connectTo(s),r.connectTo(s);let o=new ia("VertexOutput");s.connectTo(o);let a=new Ut("color");a.value=new le(.8,.8,.8,1);let l=new qi("FragmentOutput");a.connectTo(l),this.addOutputNode(o),this.addOutputNode(l),this._mode=rn.Material}setToDefaultPostProcess(){this.clear(),this.editorData=null;let e=new Ut("Position");e.setAsAttribute("position2d");let t=new Ut("Constant1");t.isConstant=!0,t.value=1;let n=new ra("Position3D");e.connectTo(n),t.connectTo(n,{input:"w"});let r=new ia("VertexOutput");n.connectTo(r);let s=new Ut("Scale");s.visibleInInspector=!0,s.value=new _e(1,1);let o=new sa("uv0");e.connectTo(o);let a=new ql("UV scale");o.connectTo(a),s.connectTo(a);let l=new ih("CurrentScreen");a.connectTo(l);let c=z.GetAssetUrl("https://assets.babylonjs.com/core/nme/currentScreenPostProcess.png");l.texture=new te(c,this.getScene());let u=new qi("FragmentOutput");l.connectTo(u,{output:"rgba"}),this.addOutputNode(r),this.addOutputNode(u),this._mode=rn.PostProcess}setToDefaultProceduralTexture(){this.clear(),this.editorData=null;let e=new Ut("Position");e.setAsAttribute("position2d");let t=new Ut("Constant1");t.isConstant=!0,t.value=1;let n=new ra("Position3D");e.connectTo(n),t.connectTo(n,{input:"w"});let r=new ia("VertexOutput");n.connectTo(r);let s=new Ut("Time");s.value=0,s.min=0,s.max=0,s.isBoolean=!1,s.matrixMode=0,s.animationType=$r.Time,s.isConstant=!1;let o=new Ut("Color3");o.value=new G(1,1,1),o.isConstant=!1;let a=new qi("FragmentOutput"),l=new ra("VectorMerger");l.visibleInInspector=!1;let c=new Yl("Cos");c.operation=He.Cos,e.connectTo(l),s.output.connectTo(c.input),c.output.connectTo(l.z),l.xyzOut.connectTo(a.rgb),this.addOutputNode(r),this.addOutputNode(a),this._mode=rn.ProceduralTexture}setToDefaultParticle(){this.clear(),this.editorData=null;let e=new Ut("uv");e.setAsAttribute("particle_uv");let t=new rh("ParticleTexture");e.connectTo(t);let n=new Ut("Color");n.setAsAttribute("particle_color");let r=new ql("Texture * Color");t.connectTo(r),n.connectTo(r);let s=new sh("ParticleRampGradient");r.connectTo(s);let o=new ah("ColorSplitter");n.connectTo(o);let a=new oh("ParticleBlendMultiply");s.connectTo(a),t.connectTo(a,{output:"a"}),o.connectTo(a,{output:"a"});let l=new qi("FragmentOutput");a.connectTo(l),this.addOutputNode(l),this._mode=rn.Particle}loadAsync(e,t=""){return T(this,null,function*(){return yield i.ParseFromFileAsync("",e,this.getScene(),t,!0,this)})}_gatherBlocks(e,t){if(t.indexOf(e)===-1){t.push(e);for(let n of e.inputs){let r=n.connectedPoint;if(r){let s=r.ownerBlock;s!==e&&this._gatherBlocks(s,t)}}if(e.isTeleportOut){let n=e;n.entryPoint&&this._gatherBlocks(n.entryPoint,t)}}}generateCode(){let e=[],t=[],n=["const","var","let"];for(let o of this._vertexOutputNodes)this._gatherBlocks(o,t);let r=[];for(let o of this._fragmentOutputNodes)this._gatherBlocks(o,r);let s=`var nodeMaterial = new BABYLON.NodeMaterial("${this.name||"node material"}");
`;s+=`nodeMaterial.mode = BABYLON.NodeMaterialModes.${rn[this.mode]};
`;for(let o of t)o.isInput&&e.indexOf(o)===-1&&(s+=o._dumpCode(n,e));for(let o of r)o.isInput&&e.indexOf(o)===-1&&(s+=o._dumpCode(n,e));e=[],s+=`
// Connections
`;for(let o of this._vertexOutputNodes)s+=o._dumpCodeForOutputConnections(e);for(let o of this._fragmentOutputNodes)s+=o._dumpCodeForOutputConnections(e);s+=`
// Output nodes
`;for(let o of this._vertexOutputNodes)s+=`nodeMaterial.addOutputNode(${o._codeVariableName});
`;for(let o of this._fragmentOutputNodes)s+=`nodeMaterial.addOutputNode(${o._codeVariableName});
`;return s+=`nodeMaterial.build();
`,s}serialize(e){let t=e?{}:Xe.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let n=[];if(e)n=e;else{t.customType="BABYLON.NodeMaterial",t.outputNodes=[];for(let r of this._vertexOutputNodes)this._gatherBlocks(r,n),t.outputNodes.push(r.uniqueId);for(let r of this._fragmentOutputNodes)this._gatherBlocks(r,n),t.outputNodes.indexOf(r.uniqueId)===-1&&t.outputNodes.push(r.uniqueId)}t.blocks=[];for(let r of n)t.blocks.push(r.serialize());if(!e)for(let r of this.attachedBlocks)n.indexOf(r)===-1&&t.blocks.push(r.serialize());return t.uniqueId=this.uniqueId,t}_restoreConnections(e,t,n){for(let r of e.outputs)for(let s of t.blocks){let o=n[s.id];if(o){for(let a of s.inputs)if(n[a.targetBlockId]===e&&a.targetConnectionName===r.name){let l=o.getInputByName(a.inputName);if(!l||l.isConnected)continue;r.connectTo(l,!0),this._restoreConnections(o,t,n);continue}}}}parseSerializedObject(e,t="",n=!1,r){n||this.clear();let s={};for(let o of e.blocks){let a=Ct(o.customType);if(a){let l=new a;l._deserialize(o,this.getScene(),t,r),s[o.id]=l,this.attachedBlocks.push(l)}}for(let o of this.attachedBlocks)if(o.isTeleportOut){let a=o,l=a._tempEntryPointUniqueId;l&&s[l].attachToEndpoint(a)}for(let o=0;o<e.blocks.length;o++){let a=e.blocks[o],l=s[a.id];l&&(l.inputs.length&&!n||this._restoreConnections(l,e,s))}if(e.outputNodes)for(let o of e.outputNodes)this.addOutputNode(s[o]);if(e.locations||e.editorData&&e.editorData.locations){let o=e.locations||e.editorData.locations;for(let l of o)s[l.blockId]&&(l.blockId=s[l.blockId].uniqueId);n&&this.editorData&&this.editorData.locations&&o.concat(this.editorData.locations),e.locations?this.editorData={locations:o}:(this.editorData=e.editorData,this.editorData.locations=o);let a={};for(let l in s)a[l]=s[l].uniqueId;this.editorData.map=a}Oe.ParseAlphaMode(e,this),n||(this._mode=e.mode??rn.Material)}loadFromSerialization(e,t="",n=!1){Xe.ParseProperties(e,this,this.getScene(),t),this.parseSerializedObject(e,t,n)}clone(e,t=!1){let n=this.serialize(),r=Xe.Clone(()=>new i(e,this.getScene(),this.options),this);return r.id=e,r.name=e,r.parseSerializedObject(n),r._buildId=this._buildId,r.build(!1,!t),r}whenTexturesReadyAsync(){let e=[],t=this.getActiveTextures();for(let n of t){let r=n.getInternalTexture();r&&!r.isReady&&e.push(new Promise((s,o)=>{r.onLoadedObservable.addOnce(()=>{s()}),r.onErrorObservable.addOnce(a=>{o(a)})}))}return Promise.all(e)}static Parse(e,t,n="",r=0){let s=Xe.Parse(()=>new i(e.name,t,{shaderLanguage:r}),e,t,n);return s.parseSerializedObject(e,n),s.build(),s}static ParseFromFileAsync(e,t,n,r="",s=!1,o,a,l){return T(this,null,function*(){let c=o??new i(e,n,l),u=yield n._loadFileAsync(t),h=JSON.parse(u);return c.parseSerializedObject(h,r,void 0,a),s||c.build(),c})}static ParseFromSnippetAsync(e,t=Ie.LastCreatedScene,n="",r,s=!1,o=!1,a,l){return e==="_BLANK"?Promise.resolve(i.CreateDefault("blank",t)):new Promise((c,u)=>{let h=new to;h.addEventListener("readystatechange",()=>{if(h.readyState==4)if(h.status==200){let d=JSON.parse(JSON.parse(h.responseText).jsonPayload),f=JSON.parse(d.nodeMaterial);r||(r=Xe.Parse(()=>new i(e,t,l),f,t,n),r.uniqueId=t.getUniqueId()),r.parseSerializedObject(f,void 0,void 0,a),r.snippetId=e,r.sideOrientation=null;try{s||r.build()}catch(p){u(p)}o?r.whenTexturesReadyAsync().then(()=>{c(r)}).catch(p=>{u(p)}):c(r)}else u("Unable to load the snippet "+e)}),h.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),h.send()})}static CreateDefault(e,t){let n=new i(e,t);return n.setToDefault(),n.build(),n}};qt._BuildIdGenerator=0;qt.EditorURL=`${z._DefaultCdnUrl}/v${ne.Version}/nodeEditor/babylon.nodeEditor.js`;qt.SnippetUrl="https://snippet.babylonjs.com";qt.IgnoreTexturesAtLoadTime=!1;qt.AllowSerializationOfRenderTargetTextures=!1;qt.DefaultShaderLanguage=0;qt.UseNativeShaderLanguageOfEngine=!1;w([L()],qt.prototype,"ignoreAlpha",void 0);w([L()],qt.prototype,"maxSimultaneousLights",void 0);w([L("mode")],qt.prototype,"_mode",void 0);w([L("comment")],qt.prototype,"comment",void 0);w([L()],qt.prototype,"forceAlphaBlending",void 0);ue("BABYLON.NodeMaterial",qt);ei.prototype._projectOnTrianglesToRef=function(i,e,t,n,r,s){let o=U.Vector3[0],a=U.Vector3[1],l=1/0;for(let c=this.indexStart;c<this.indexStart+this.indexCount-(3-n);c+=n){let u=t[c],h=t[c+1],d=t[c+2];if(r&&d===4294967295){c+=2;continue}let f=e[u],p=e[h],g=e[d];if(!f||!p||!g)continue;let _=m.ProjectOnTriangleToRef(i,f,p,g,a);_<l&&(o.copyFrom(a),l=_)}return s.copyFrom(o),l};ei.prototype._projectOnUnIndexedTrianglesToRef=function(i,e,t,n){let r=U.Vector3[0],s=U.Vector3[1],o=1/0;for(let a=this.verticesStart;a<this.verticesStart+this.verticesCount;a+=3){let l=e[a],c=e[a+1],u=e[a+2],h=m.ProjectOnTriangleToRef(i,l,c,u,s);h<o&&(r.copyFrom(s),o=h)}return n.copyFrom(r),o};ei.prototype.projectToRef=function(i,e,t,n){let r=this.getMaterial();if(!r)return-1;let s=3,o=!1;switch(r.fillMode){case 3:case 5:case 6:case 8:return-1;case 7:s=1,o=!0;break;default:break}return r.fillMode===4?-1:!t.length&&this._mesh._unIndexed?this._projectOnUnIndexedTrianglesToRef(i,e,t,n):this._projectOnTrianglesToRef(i,e,t,s,o,n)};var Ri=(function(i){return i[i.DEHYDRATED=0]="DEHYDRATED",i[i.HOVER=1]="HOVER",i[i.TOUCH=2]="TOUCH",i})(Ri||{});var Kl=[new m,new m,new m,new m],jr=class i extends Gr{constructor(e,t){super(e),this._options=t,this._tmpRay=new pt(new m,new m),this._attachController=n=>{if(this._controllers[n.uniqueId])return;let{touchCollisionMesh:r,touchCollisionMeshFunction:s,hydrateCollisionMeshFunction:o}=this._generateNewTouchPointMesh(),a=this._generateVisualCue();switch(this._controllers[n.uniqueId]={xrController:n,meshUnderPointer:null,nearInteractionTargetMesh:null,pick:null,stalePick:null,touchCollisionMesh:r,touchCollisionMeshFunction:s,hydrateCollisionMeshFunction:o,currentAnimationState:Ri.DEHYDRATED,grabRay:new pt(new m,new m),hoverInteraction:!1,nearInteraction:!1,grabInteraction:!1,downTriggered:!1,id:i._IdCounter++,pickedPointVisualCue:a},this._controllers[n.uniqueId]._worldScaleObserver=this._controllers[n.uniqueId]._worldScaleObserver||this._xrSessionManager.onWorldScaleFactorChangedObservable.add(l=>{if(l.newScaleFactor!==l.previousScaleFactor){this._controllers[n.uniqueId].touchCollisionMesh.dispose(),this._controllers[n.uniqueId].pickedPointVisualCue.dispose();let{touchCollisionMesh:c,touchCollisionMeshFunction:u,hydrateCollisionMeshFunction:h}=this._generateNewTouchPointMesh();this._controllers[n.uniqueId].touchCollisionMesh=c,this._controllers[n.uniqueId].touchCollisionMeshFunction=u,this._controllers[n.uniqueId].hydrateCollisionMeshFunction=h,this._controllers[n.uniqueId].pickedPointVisualCue=this._generateVisualCue()}}),this._attachedController?!this._options.enableNearInteractionOnAllControllers&&this._options.preferredHandedness&&n.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=n.uniqueId):this._options.enableNearInteractionOnAllControllers||(this._attachedController=n.uniqueId),n.inputSource.targetRayMode){case"tracked-pointer":return this._attachNearInteractionMode(n);case"gaze":return null;case"screen":return null}},this._controllers={},this._farInteractionFeature=null,this.selectionMeshDefaultColor=new G(.8,.8,.8),this.selectionMeshPickedColor=new G(.3,.3,1),this.alwaysHideSelectionMesh=!1,this._hoverRadius=.1,this._pickRadius=.02,this._controllerPickRadius=.03,this._nearGrabLengthScale=5,this._scene=this._xrSessionManager.scene,this._options.nearInteractionControllerMode===void 0&&(this._options.nearInteractionControllerMode=2),this._options.farInteractionFeature&&(this._farInteractionFeature=this._options.farInteractionFeature)}attach(){if(!super.attach())return!1;for(let e of this._options.xrInput.controllers)this._attachController(e);return this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),this._scene.constantlyUpdateMeshUnderPointer=!0,!0}detach(){if(!super.detach())return!1;let e=Object.keys(this._controllers);for(let t of e)this._detachController(t);return!0}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){let t=Object.keys(this._controllers);for(let n=0;n<t.length;++n)if(this._controllers[t[n]].id===e)return this._controllers[t[n]].xrController||null;return null}setFarInteractionFeature(e){this._farInteractionFeature=e}_nearPickPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearPickable}_nearGrabPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearGrabbable}_nearInteractionPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&(e.isNearPickable||e.isNearGrabbable)}_controllerAvailablePredicate(e,t){let n=e;for(;n;){if(n.reservedDataStore&&n.reservedDataStore.nearInteraction&&n.reservedDataStore.nearInteraction.excludedControllerId===t)return!1;n=n.parent}return!0}_handleTransitionAnimation(e,t){if(!(e.currentAnimationState===t||this._options.nearInteractionControllerMode!==2||e.xrController?.inputSource.hand)){if(t>e.currentAnimationState)switch(e.currentAnimationState){case Ri.DEHYDRATED:if(e.hydrateCollisionMeshFunction(!0),t===Ri.HOVER)break;case Ri.HOVER:if(e.touchCollisionMeshFunction(!0),t===Ri.TOUCH)break}else switch(e.currentAnimationState){case Ri.TOUCH:if(e.touchCollisionMeshFunction(!1),t===Ri.HOVER)break;case Ri.HOVER:if(e.hydrateCollisionMeshFunction(!1),t===Ri.DEHYDRATED)break}e.currentAnimationState=t}}_processTouchPoint(e,t,n){let r=this._controllers[e];r.grabRay.origin.copyFrom(t),n.toEulerAnglesToRef(U.Vector3[0]),r.grabRay.direction.copyFrom(U.Vector3[0]),this._options.nearInteractionControllerMode===2&&!r.xrController?.inputSource.hand&&(r.xrController.getWorldPointerRayToRef(this._tmpRay),r.grabRay.origin.addInPlace(this._tmpRay.direction.scale(.05))),r.grabRay.length=this._nearGrabLengthScale*this._hoverRadius*this._xrSessionManager.worldScalingFactor,r.touchCollisionMesh.position.copyFrom(r.grabRay.origin).scaleInPlace(this._xrSessionManager.worldScalingFactor)}_onXRFrame(e){let t=Object.keys(this._controllers);for(let n of t){let r=this._controllers[n],s=r.xrController?.inputSource.hand;if(!this._options.enableNearInteractionOnAllControllers&&n!==this._attachedController||!r.xrController||!s&&(!this._options.nearInteractionControllerMode||!r.xrController.inputSource.gamepad)){r.pick=null;return}if(r.hoverInteraction=!1,r.nearInteraction=!1,r.xrController){if(s){let c=s.get("index-finger-tip");if(c){let u=e.getJointPose(c,this._xrSessionManager.referenceSpace);if(u&&u.transform){let h=this._scene.useRightHandedSystem?1:-1;U.Vector3[0].set(u.transform.position.x,u.transform.position.y,u.transform.position.z*h),U.Quaternion[0].set(u.transform.orientation.x,u.transform.orientation.y,u.transform.orientation.z*h,u.transform.orientation.w*h),this._processTouchPoint(n,U.Vector3[0],U.Quaternion[0])}}}else if(r.xrController.inputSource.gamepad&&this._options.nearInteractionControllerMode!==0){let c=r.xrController.pointer;r.xrController.grip&&this._options.nearInteractionControllerMode===1&&(c=r.xrController.grip),this._processTouchPoint(n,c.position,c.rotationQuaternion)}}else return;let o=(c,u)=>{let h=null;return!u||!u.hit?h=c:!c||!c.hit||u.distance<c.distance?h=u:h=c,h},a=c=>{let u=new In,h=!1,d=c&&c.pickedPoint&&c.hit;return c?.pickedPoint&&(h=c.pickedPoint.x===0&&c.pickedPoint.y===0&&c.pickedPoint.z===0),d&&!h&&(u=c),u};if(!r.grabInteraction){let c=null,u=null;this._options.useUtilityLayer&&this._utilityLayerScene&&(u=this._pickWithSphere(r,this._hoverRadius*this._xrSessionManager.worldScalingFactor,this._utilityLayerScene,f=>this._nearInteractionPredicate(f)));let h=this._pickWithSphere(r,this._hoverRadius*this._xrSessionManager.worldScalingFactor,this._scene,f=>this._nearInteractionPredicate(f)),d=o(h,u);if(d&&d.hit&&(c=a(d),c.hit&&(r.hoverInteraction=!0)),r.hoverInteraction){let f=null,p=(s?this._pickRadius:this._controllerPickRadius)*this._xrSessionManager.worldScalingFactor;this._options.useUtilityLayer&&this._utilityLayerScene&&(f=this._pickWithSphere(r,p,this._utilityLayerScene,C=>this._nearPickPredicate(C)));let g=this._pickWithSphere(r,p,this._scene,C=>this._nearPickPredicate(C)),_=o(g,f),y=a(_);y.hit&&(c=y,r.nearInteraction=!0)}r.stalePick=r.pick,r.pick=c,r.pick&&r.pick.pickedPoint&&r.pick.hit?(r.meshUnderPointer=r.pick.pickedMesh,r.pickedPointVisualCue.position.copyFrom(r.pick.pickedPoint),r.pickedPointVisualCue.isVisible=!this.alwaysHideSelectionMesh,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(r.id,!0)):(r.meshUnderPointer=null,r.pickedPointVisualCue.isVisible=!1,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(r.id,!1))}let l=Ri.DEHYDRATED;r.grabInteraction||r.nearInteraction?l=Ri.TOUCH:r.hoverInteraction&&(l=Ri.HOVER),this._handleTransitionAnimation(r,l)}}get _utilityLayerScene(){return this._options.customUtilityLayerScene||Ur.DefaultUtilityLayer.utilityLayerScene}_generateVisualCue(){let e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Ur.DefaultUtilityLayer.utilityLayerScene:this._scene,t=js("nearInteraction",{diameter:.0035*3*this._xrSessionManager.worldScalingFactor},e);t.bakeCurrentTransformIntoVertices(),t.isPickable=!1,t.isVisible=!1,t.rotationQuaternion=J.Identity();let n=new Z("targetMat",e);return n.specularColor=G.Black(),n.emissiveColor=this.selectionMeshDefaultColor,n.backFaceCulling=!1,t.material=n,t}_isControllerReadyForNearInteraction(e){return this._farInteractionFeature?this._farInteractionFeature._getPointerSelectionDisabledByPointerId(e):!0}_attachNearInteractionMode(e){let t=this._controllers[e.uniqueId],n={pointerId:t.id,pointerType:"xr-near"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{!this._options.enableNearInteractionOnAllControllers&&e.uniqueId!==this._attachedController||!t.xrController||!t.xrController.inputSource.hand&&(!this._options.nearInteractionControllerMode||!t.xrController.inputSource.gamepad)||(t.pick&&(t.pick.ray=t.grabRay),t.pick&&this._isControllerReadyForNearInteraction(t.id)&&this._scene.simulatePointerMove(t.pick,n),t.nearInteraction&&t.pick&&t.pick.hit?t.nearInteractionTargetMesh||(this._scene.simulatePointerDown(t.pick,n),t.nearInteractionTargetMesh=t.meshUnderPointer,t.downTriggered=!0):t.nearInteractionTargetMesh&&t.stalePick&&(this._scene.simulatePointerUp(t.stalePick,n),t.downTriggered=!1,t.nearInteractionTargetMesh=null))});let r=s=>{this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController&&this._isControllerReadyForNearInteraction(t.id)?(t.pick&&(t.pick.ray=t.grabRay),s&&t.pick&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)?(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,n),t.downTriggered=!0):!s&&t.pick&&t.grabInteraction&&(this._scene.simulatePointerUp(t.pick,n),t.downTriggered=!1,t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!this.alwaysHideSelectionMesh)):s&&!this._options.enableNearInteractionOnAllControllers&&!this._options.disableSwitchOnClick&&(this._attachedController=e.uniqueId)};if(e.inputSource.gamepad){let s=o=>{t.squeezeComponent=o.getComponent("grasp"),t.squeezeComponent?t.onSqueezeButtonChangedObserver=t.squeezeComponent.onButtonStateChangedObservable.add(a=>{if(a.changes.pressed){let l=a.changes.pressed.current;r(l)}}):(t.selectionComponent=o.getMainComponent(),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add(a=>{if(a.changes.pressed){let l=a.changes.pressed.current;r(l)}}))};e.motionController?s(e.motionController):e.onMotionControllerInitObservable.add(s)}else{let s=a=>{t.xrController&&a.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)&&(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,n),t.downTriggered=!0)},o=a=>{t.xrController&&a.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&(this._scene.simulatePointerUp(t.pick,n),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!this.alwaysHideSelectionMesh,t.downTriggered=!1)};t.eventListeners={selectend:o,selectstart:s},this._xrSessionManager.session.addEventListener("selectstart",s),this._xrSessionManager.session.addEventListener("selectend",o)}}_detachController(e){let t=this._controllers[e];if(t){if(t.squeezeComponent&&t.onSqueezeButtonChangedObserver&&t.squeezeComponent.onButtonStateChangedObservable.remove(t.onSqueezeButtonChangedObserver),t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners){let n=Object.keys(t.eventListeners);for(let r of n){let s=t.eventListeners&&t.eventListeners[r];s&&this._xrSessionManager.session.removeEventListener(r,s)}}if(t.touchCollisionMesh.dispose(),t.pickedPointVisualCue.dispose(),this._xrSessionManager.runInXRFrame(()=>{if(!t.downTriggered)return;let n={pointerId:t.id,pointerType:"xr-near"};this._scene.simulatePointerUp(new In,n)}),t._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(t._worldScaleObserver),delete this._controllers[e],this._attachedController===e){let n=Object.keys(this._controllers);n.length?this._attachedController=n[0]:this._attachedController=""}}}_generateNewTouchPointMesh(){let e=this._xrSessionManager.worldScalingFactor,t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Ur.DefaultUtilityLayer.utilityLayerScene:this._scene,n=js("PickSphere",{diameter:1*e},t);if(n.isVisible=!1,this._options.motionControllerOrbMaterial)n.material=this._options.motionControllerOrbMaterial;else{let D;this._options.motionControllerTouchMaterialSnippetUrl?D=qt.ParseFromFileAsync("motionControllerTouchMaterial",this._options.motionControllerTouchMaterialSnippetUrl,t):D=qt.ParseFromSnippetAsync("8RUNKL#3",t),D.then(M=>{n.material=M}).catch(M=>{N.Warn(`Error creating touch material in WebXRNearInteraction: ${M}`)})}let r=new mc;r.setEasingMode(ni.EASINGMODE_EASEINOUT);let s=new m(this._controllerPickRadius,this._controllerPickRadius,this._controllerPickRadius).scaleInPlace(e),o=this._controllerPickRadius*(4/3),a=new m(o,o,o).scaleInPlace(e),l=this._controllerPickRadius*(7/6),c=new m(l,l,l).scaleInPlace(e),u=this._controllerPickRadius*(4/5),h=new m(u,u,u).scaleInPlace(e),d=this._controllerPickRadius*(3/2),f=new m(d,d,d).scaleInPlace(e),p=[{frame:0,value:s},{frame:10,value:f},{frame:18,value:a}],g=[{frame:0,value:a},{frame:10,value:h},{frame:18,value:s}],_=[{frame:0,value:m.ZeroReadOnly},{frame:12,value:c},{frame:15,value:s}],y=[{frame:0,value:s},{frame:10,value:m.ZeroReadOnly},{frame:15,value:m.ZeroReadOnly}],C=new H("touch","scaling",60,H.ANIMATIONTYPE_VECTOR3,H.ANIMATIONLOOPMODE_CONSTANT),E=new H("release","scaling",60,H.ANIMATIONTYPE_VECTOR3,H.ANIMATIONLOOPMODE_CONSTANT),I=new H("hydrate","scaling",60,H.ANIMATIONTYPE_VECTOR3,H.ANIMATIONLOOPMODE_CONSTANT),v=new H("dehydrate","scaling",60,H.ANIMATIONTYPE_VECTOR3,H.ANIMATIONLOOPMODE_CONSTANT);return C.setEasingFunction(r),E.setEasingFunction(r),I.setEasingFunction(r),v.setEasingFunction(r),C.setKeys(p),E.setKeys(g),I.setKeys(_),v.setKeys(y),{touchCollisionMesh:n,touchCollisionMeshFunction:D=>{let M=D?C:E;t.beginDirectAnimation(n,[M],0,18,!1,1)},hydrateCollisionMeshFunction:D=>{let M=D?I:v;D&&(n.isVisible=!0),t.beginDirectAnimation(n,[M],0,15,!1,1,()=>{D||(n.isVisible=!1)})}}}_pickWithSphere(e,t,n,r){let s=new In;if(s.distance=1/0,e.touchCollisionMesh&&e.xrController){let o=e.touchCollisionMesh.position,a=xg.CreateFromCenterAndRadius(o,t);for(let l=0;l<n.meshes.length;l++){let c=n.meshes[l];if(!r(c)||!this._controllerAvailablePredicate(c,e.xrController.uniqueId))continue;let u=i.PickMeshWithSphere(c,a);u&&u.hit&&u.distance<s.distance&&(s.hit=u.hit,s.pickedMesh=c,s.pickedPoint=u.pickedPoint,s.aimTransform=e.xrController.pointer,s.gripTransform=e.xrController.grip||null,s.originMesh=e.touchCollisionMesh,s.distance=u.distance,s.bu=u.bu,s.bv=u.bv,s.faceId=u.faceId,s.subMeshId=u.subMeshId)}}return s}static PickMeshWithSphere(e,t,n=!1){let r=e.subMeshes,s=new In,o=e.getBoundingInfo();if(!e._generatePointsArray()||!e.subMeshes||!o||!n&&!xg.Intersects(o.boundingSphere,t))return s;let a=Kl[0],l=Kl[1];Kl[2].setAll(0),Kl[3].setAll(0);let c=new pt(Kl[2],Kl[3],1),u=1/0,h,d,f,p,g=U.Vector3[2],_=U.Matrix[0];_.copyFrom(e.getWorldMatrix()),_.invert(),m.TransformCoordinatesToRef(t.center,_,g);for(let y=0;y<r.length;y++)r[y].projectToRef(g,e._positions,e.getIndices(),l),m.TransformCoordinatesToRef(l,e.getWorldMatrix(),l),h=m.Distance(l,t.center),f=m.DistanceSquared(l,e.getAbsolutePosition()),d=m.DistanceSquared(t.center,e.getAbsolutePosition()),d!==-1&&f!==-1&&f>d&&(h=0,l.copyFrom(t.center)),h!==-1&&h<u&&(u=h,pt.CreateFromToToRef(t.center,l,c),c.length=u*2,p=c.intersectsMesh(e),a.copyFrom(l));return u<t.radius&&(s.hit=!0,s.distance=u,s.pickedMesh=e,s.pickedPoint=a.clone(),p&&p.bu!==null&&p.bv!==null&&(s.faceId=p.faceId,s.subMeshId=p.subMeshId,s.bu=p.bu,s.bv=p.bv)),s}};jr._IdCounter=200;jr.Name=di.NEAR_INTERACTION;jr.Version=1;fi.AddWebXRFeature(jr.Name,(i,e)=>()=>new jr(i,e),jr.Version,!0);var MC=class{constructor(e,t,n){this.element=e,this.sessionMode=t,this.referenceSpaceType=n}update(e){}};var jm=class i{constructor(e,t){if(this._scene=e,this.options=t,this._activeButton=null,this._buttons=[],this.activeButtonChangedObservable=new B,this._onSessionGranted=r=>{this._helper&&this._enterXRWithButtonIndexAsync(0)},this.overlay=document.createElement("div"),this.overlay.classList.add("xr-button-overlay"),!t.ignoreSessionGrantedEvent&&navigator.xr&&navigator.xr.addEventListener("sessiongranted",this._onSessionGranted),typeof window<"u"&&window.location&&window.location.protocol==="http:"&&window.location.hostname!=="localhost")throw z.Warn("WebXR can only be served over HTTPS"),new Error("WebXR can only be served over HTTPS");if(t.customButtons)this._buttons=t.customButtons;else{this.overlay.style.cssText="z-index:11;position: absolute; right: 20px;bottom: 50px;";let r=t.sessionMode||"immersive-vr",s=t.referenceSpaceType||"local-floor",a=".babylonVRicon { color: #868686; border-color: #868686; border-style: solid; margin-left: 10px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(typeof SVGSVGElement>"u"?"https://cdn.babylonjs.com/Assets/vrButton.png":"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";a+='.babylonVRicon.vrdisplaypresenting { background-image: none;} .vrdisplaypresenting::after { content: "EXIT"} .xr-error::after { content: "ERROR"}';let l=document.createElement("style");l.appendChild(document.createTextNode(a)),document.getElementsByTagName("head")[0].appendChild(l);let c=document.createElement("button");c.className="babylonVRicon",c.title=`${r} - ${s}`,this._buttons.push(new MC(c,r,s)),this._buttons[this._buttons.length-1].update=function(u){this.element.style.display=u===null||u===this?"":"none",c.className="babylonVRicon"+(u===this?" vrdisplaypresenting":"")},this._updateButtons(null)}let n=e.getEngine().getInputElement();n&&n.parentNode&&(n.parentNode.appendChild(this.overlay),e.onDisposeObservable.addOnce(()=>{this.dispose()}))}setHelperAsync(e,t){return T(this,null,function*(){this._helper=e,this._renderTarget=t;let n=this._buttons.map(s=>T(this,null,function*(){return yield e.sessionManager.isSessionSupportedAsync(s.sessionMode)}));e.onStateChangedObservable.add(s=>{s==3&&this._updateButtons(null)});let r=yield Promise.all(n);for(let s=0;s<r.length;s++)r[s]?(this.overlay.appendChild(this._buttons[s].element),this._buttons[s].element.onclick=this._enterXRWithButtonIndexAsync.bind(this,s)):z.Warn(`Session mode "${this._buttons[s].sessionMode}" not supported in browser`)})}static CreateAsync(e,t,n){return T(this,null,function*(){let r=new i(e,n);return yield r.setHelperAsync(t,n.renderTarget||void 0),r})}_enterXRWithButtonIndexAsync(e=0){return T(this,null,function*(){if(this._helper.state==2)yield this._helper.exitXRAsync(),this._updateButtons(null);else if(this._helper.state==3)try{yield this._helper.enterXRAsync(this._buttons[e].sessionMode,this._buttons[e].referenceSpaceType,this._renderTarget,{optionalFeatures:this.options.optionalFeatures,requiredFeatures:this.options.requiredFeatures}),this._updateButtons(this._buttons[e])}catch(t){this._updateButtons(null);let n=this._buttons[e].element,r=n.title;n.title="Error entering XR session : "+r,n.classList.add("xr-error"),this.options.onError&&this.options.onError(t)}})}dispose(){let e=this._scene.getEngine().getInputElement();e&&e.parentNode&&e.parentNode.contains(this.overlay)&&e.parentNode.removeChild(this.overlay),this.activeButtonChangedObservable.clear(),navigator.xr.removeEventListener("sessiongranted",this._onSessionGranted)}_updateButtons(e){this._activeButton=e;for(let t of this._buttons)t.update(this._activeButton);this.activeButtonChangedObservable.notifyObservers(this._activeButton)}};var Fn=class{constructor(e,t){this.type=e,this.jointData=t,t.nativeParams=t.nativeParams||{}}get physicsJoint(){return this._physicsJoint}set physicsJoint(e){this._physicsJoint=e}set physicsPlugin(e){this._physicsPlugin=e}executeNativeFunction(e){e(this._physicsPlugin.world,this._physicsJoint)}};Fn.DistanceJoint=0;Fn.HingeJoint=1;Fn.BallAndSocketJoint=2;Fn.WheelJoint=3;Fn.SliderJoint=4;Fn.PrismaticJoint=5;Fn.UniversalJoint=6;Fn.Hinge2Joint=Fn.WheelJoint;Fn.PointToPointJoint=8;Fn.SpringJoint=9;Fn.LockJoint=10;A._PhysicsImpostorParser=function(i,e,t){return new Rt(e,t.physicsImpostor,{mass:t.physicsMass,friction:t.physicsFriction,restitution:t.physicsRestitution},i)};var Rt=class i{get isDisposed(){return this._isDisposed}get mass(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0}set mass(e){this.setMass(e)}get friction(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0}set friction(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,e)}get restitution(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0}set restitution(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,e)}get pressure(){if(!this._physicsEngine)return 0;let e=this._physicsEngine.getPhysicsPlugin();return e.setBodyPressure?e.getBodyPressure(this):0}set pressure(e){if(!this._physicsEngine)return;let t=this._physicsEngine.getPhysicsPlugin();t.setBodyPressure&&t.setBodyPressure(this,e)}get stiffness(){if(!this._physicsEngine)return 0;let e=this._physicsEngine.getPhysicsPlugin();return e.getBodyStiffness?e.getBodyStiffness(this):0}set stiffness(e){if(!this._physicsEngine)return;let t=this._physicsEngine.getPhysicsPlugin();t.setBodyStiffness&&t.setBodyStiffness(this,e)}get velocityIterations(){if(!this._physicsEngine)return 0;let e=this._physicsEngine.getPhysicsPlugin();return e.getBodyVelocityIterations?e.getBodyVelocityIterations(this):0}set velocityIterations(e){if(!this._physicsEngine)return;let t=this._physicsEngine.getPhysicsPlugin();t.setBodyVelocityIterations&&t.setBodyVelocityIterations(this,e)}get positionIterations(){if(!this._physicsEngine)return 0;let e=this._physicsEngine.getPhysicsPlugin();return e.getBodyPositionIterations?e.getBodyPositionIterations(this):0}set positionIterations(e){if(!this._physicsEngine)return;let t=this._physicsEngine.getPhysicsPlugin();t.setBodyPositionIterations&&t.setBodyPositionIterations(this,e)}constructor(e,t,n={mass:0},r){if(this.object=e,this.type=t,this._options=n,this._scene=r,this._pluginData={},this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=new Array,this._onAfterPhysicsStepCallbacks=new Array,this._onPhysicsCollideCallbacks=[],this._deltaPosition=m.Zero(),this._isDisposed=!1,this.soft=!1,this.segments=0,this._tmpQuat=new J,this._tmpQuat2=new J,this.beforeStep=()=>{if(this._physicsEngine){this.object.translate(this._deltaPosition,-1),this._deltaRotationConjugated&&this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotationConjugated,this.object.rotationQuaternion),this.object.computeWorldMatrix(!1),this.object.parent&&this.object.rotationQuaternion?(this.getParentsRotation(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this._tmpQuat)):this._tmpQuat.copyFrom(this.object.rotationQuaternion||new J),this._options.disableBidirectionalTransformation||this.object.rotationQuaternion&&this._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(this,this.object.getAbsolutePosition(),this._tmpQuat);for(let s of this._onBeforePhysicsStepCallbacks)s(this)}},this.afterStep=()=>{if(this._physicsEngine){for(let s of this._onAfterPhysicsStepCallbacks)s(this);this._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(this),this.object.parent&&this.object.rotationQuaternion&&(this.getParentsRotation(),this._tmpQuat.conjugateInPlace(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this.object.rotationQuaternion)),this.object.setAbsolutePosition(this.object.position),this._deltaRotation?(this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotation,this.object.rotationQuaternion),this._deltaPosition.applyRotationQuaternionToRef(this._deltaRotation,i._TmpVecs[0]),this.object.translate(i._TmpVecs[0],1)):this.object.translate(this._deltaPosition,1),this.object.computeWorldMatrix(!0)}},this.onCollideEvent=null,this.onCollide=s=>{if(!this._onPhysicsCollideCallbacks.length&&!this.onCollideEvent||!this._physicsEngine)return;let o=this._physicsEngine.getImpostorWithPhysicsBody(s.body);if(o){this.onCollideEvent&&this.onCollideEvent(this,o);let a=this._onPhysicsCollideCallbacks.filter(l=>l.otherImpostors.indexOf(o)!==-1);for(let l of a)l.callback(this,o,s.point,s.distance,s.impulse,s.normal)}},!this.object){N.Error("No object was provided. A physics object is obligatory");return}this.object.parent&&n.mass!==0&&N.Warn("A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),this._scene&&(this.type>100&&(this.soft=!0),this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=J.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new J),this._options.mass=n.mass===void 0?0:n.mass,this._options.friction=n.friction===void 0?.2:n.friction,this._options.restitution=n.restitution===void 0?.2:n.restitution,this.soft&&(this._options.mass=this._options.mass>0?this._options.mass:1,this._options.pressure=n.pressure===void 0?200:n.pressure,this._options.stiffness=n.stiffness===void 0?1:n.stiffness,this._options.velocityIterations=n.velocityIterations===void 0?20:n.velocityIterations,this._options.positionIterations=n.positionIterations===void 0?20:n.positionIterations,this._options.fixedPoints=n.fixedPoints===void 0?0:n.fixedPoints,this._options.margin=n.margin===void 0?0:n.margin,this._options.damping=n.damping===void 0?0:n.damping,this._options.path=n.path===void 0?null:n.path,this._options.shape=n.shape===void 0?null:n.shape),this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&N.Warn("You must affect impostors to children before affecting impostor to parent.")):N.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))}_init(){this._physicsEngine&&(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),!this._isDisposed&&(!this.parent||this._options.ignoreParent)&&this._physicsEngine.addImpostor(this))}_getPhysicsParent(){return this.object.parent instanceof _i?this.object.parent.physicsImpostor:null}isBodyInitRequired(){return this._bodyUpdateRequired||!this._physicsBody&&(!this._parent||!!this._options.ignoreParent)}setScalingUpdated(){this.forceUpdate()}forceUpdate(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()}get physicsBody(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody}get parent(){return!this._options.ignoreParent&&this._parent?this._parent:null}set parent(e){this._parent=e}set physicsBody(e){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=e,this.resetUpdateFlags()}resetUpdateFlags(){this._bodyUpdateRequired=!1}getObjectExtents(){if(this.object.getBoundingInfo){let e=this.object.rotationQuaternion,t=this.object.scaling.clone();this.object.rotationQuaternion=i.IDENTITY_QUATERNION;let n=this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);n&&n.decompose(t,void 0,void 0);let s=this.object.getBoundingInfo().boundingBox.extendSize.scale(2).multiplyInPlace(t);return s.x=Math.abs(s.x),s.y=Math.abs(s.y),s.z=Math.abs(s.z),this.object.rotationQuaternion=e,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),s}else return i.DEFAULT_OBJECT_SIZE}getObjectCenter(){return this.object.getBoundingInfo?this.object.getBoundingInfo().boundingBox.centerWorld:this.object.position}getParam(e){return this._options[e]}setParam(e,t){this._options[e]=t,this._bodyUpdateRequired=!0}setMass(e){this.getParam("mass")!==e&&this.setParam("mass",e),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,e)}getLinearVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):m.Zero()}setLinearVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,e)}getAngularVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):m.Zero()}setAngularVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,e)}executeNativeFunction(e){this._physicsEngine&&e(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)}registerBeforePhysicsStep(e){this._onBeforePhysicsStepCallbacks.push(e)}unregisterBeforePhysicsStep(e){let t=this._onBeforePhysicsStepCallbacks.indexOf(e);t>-1?this._onBeforePhysicsStepCallbacks.splice(t,1):N.Warn("Function to remove was not found")}registerAfterPhysicsStep(e){this._onAfterPhysicsStepCallbacks.push(e)}unregisterAfterPhysicsStep(e){let t=this._onAfterPhysicsStepCallbacks.indexOf(e);t>-1?this._onAfterPhysicsStepCallbacks.splice(t,1):N.Warn("Function to remove was not found")}registerOnPhysicsCollide(e,t){let n=e instanceof Array?e:[e];this._onPhysicsCollideCallbacks.push({callback:t,otherImpostors:n})}unregisterOnPhysicsCollide(e,t){let n=e instanceof Array?e:[e],r=-1;this._onPhysicsCollideCallbacks.some((o,a)=>{if(o.callback===t&&o.otherImpostors.length===n.length){let l=o.otherImpostors.every(c=>n.indexOf(c)>-1);return l&&(r=a),l}return!1})?this._onPhysicsCollideCallbacks.splice(r,1):N.Warn("Function to remove was not found")}getParentsRotation(){let e=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);e;)e.rotationQuaternion?this._tmpQuat2.copyFrom(e.rotationQuaternion):J.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),e=e.parent;return this._tmpQuat}applyForce(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,e,t),this}applyImpulse(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,e,t),this}createJoint(e,t,n){let r=new Fn(t,n);return this.addJoint(e,r),this}addJoint(e,t){return this._joints.push({otherImpostor:e,joint:t}),this._physicsEngine&&this._physicsEngine.addJoint(this,e,t),this}addAnchor(e,t,n,r,s){if(!this._physicsEngine)return this;let o=this._physicsEngine.getPhysicsPlugin();return o.appendAnchor?(this._physicsEngine&&o.appendAnchor(this,e,t,n,r,s),this):this}addHook(e,t,n,r){if(!this._physicsEngine)return this;let s=this._physicsEngine.getPhysicsPlugin();return s.appendAnchor?(this._physicsEngine&&s.appendHook(this,e,t,n,r),this):this}sleep(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this}wakeUp(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this}clone(e){return e?new i(e,this.type,this._options,this._scene):null}dispose(){if(this._physicsEngine){for(let e of this._joints)this._physicsEngine&&this._physicsEngine.removeJoint(this,e.otherImpostor,e.joint);this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0}}setDeltaPosition(e){this._deltaPosition.copyFrom(e)}setDeltaRotation(e){this._deltaRotation||(this._deltaRotation=new J),this._deltaRotation.copyFrom(e),this._deltaRotationConjugated=this._deltaRotation.conjugate()}getBoxSizeToRef(e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,e),this}getRadius(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0}syncBoneWithImpostor(e,t,n,r,s){let o=i._TmpVecs[0],a=this.object;if(a.rotationQuaternion)if(s){let l=i._TmpQuat;a.rotationQuaternion.multiplyToRef(s,l),e.setRotationQuaternion(l,1,t)}else e.setRotationQuaternion(a.rotationQuaternion,1,t);o.x=0,o.y=0,o.z=0,n&&(o.x=n.x,o.y=n.y,o.z=n.z,e.getDirectionToRef(o,t,o),r==null&&(r=n.length()),o.x*=r,o.y*=r,o.z*=r),e.getParent()?(o.addInPlace(a.getAbsolutePosition()),e.setAbsolutePosition(o,t)):(t.setAbsolutePosition(a.getAbsolutePosition()),t.position.x-=o.x,t.position.y-=o.y,t.position.z-=o.z)}syncImpostorWithBone(e,t,n,r,s,o){let a=this.object;if(a.rotationQuaternion)if(s){let u=i._TmpQuat;e.getRotationQuaternionToRef(1,t,u),u.multiplyToRef(s,a.rotationQuaternion)}else e.getRotationQuaternionToRef(1,t,a.rotationQuaternion);let l=i._TmpVecs[0],c=i._TmpVecs[1];o||(o=i._TmpVecs[2],o.x=0,o.y=1,o.z=0),e.getDirectionToRef(o,t,c),e.getAbsolutePositionToRef(t,l),r==null&&n&&(r=n.length()),r!=null&&(l.x+=c.x*r,l.y+=c.y*r,l.z+=c.z*r),a.setAbsolutePosition(l)}};Rt.DEFAULT_OBJECT_SIZE=new m(1,1,1);Rt.IDENTITY_QUATERNION=J.Identity();Rt._TmpVecs=hh(3,m.Zero);Rt._TmpQuat=J.Identity();Rt.NoImpostor=0;Rt.SphereImpostor=1;Rt.BoxImpostor=2;Rt.PlaneImpostor=3;Rt.MeshImpostor=4;Rt.CapsuleImpostor=6;Rt.CylinderImpostor=7;Rt.ParticleImpostor=8;Rt.HeightmapImpostor=9;Rt.ConvexHullImpostor=10;Rt.CustomImpostor=100;Rt.RopeImpostor=101;Rt.ClothImpostor=102;Rt.SoftbodyImpostor=103;var Yi=["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"],oB={wrist:["wrist"],thumb:["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],index:["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],middle:["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],ring:["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],little:["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]},DC=class{get handMesh(){return this._handMesh}getHandPartMeshes(e){return oB[e].map(t=>this._jointMeshes[Yi.indexOf(t)])}getJointMesh(e){return this._jointMeshes[Yi.indexOf(e)]}constructor(e,t,n,r,s=!1,o=!1,a=1){this.xrController=e,this._jointMeshes=t,this._handMesh=n,this.rigMapping=r,this._leftHandedMeshes=s,this._jointsInvisible=o,this._jointScaleFactor=a,this.onHandMeshSetObservable=new B,this._jointTransforms=new Array(Yi.length),this._jointTransformMatrices=new Float32Array(Yi.length*16),this._tempJointMatrix=new V,this._jointRadii=new Float32Array(Yi.length),this._handMeshRoot=null,this._scene=t[0].getScene();for(let l=0;l<this._jointTransforms.length;l++)this._jointTransforms[l]=new ln(Yi[l],this._scene),this._jointTransforms[l].rotationQuaternion=new J,t[l].rotationQuaternion?t[l].rotationQuaternion=new J:t[l].rotationQuaternion?.set(0,0,0,1);n&&this.setHandMesh(n,r),this.xrController.motionController&&this.xrController.motionController.rootMesh&&this.xrController.motionController.rootMesh.dispose(!1,!0),this.xrController.onMotionControllerInitObservable.add(l=>{l._doNotLoadControllerMesh=!0})}setHandMesh(e,t,n){for(this._handMesh=e,this._handMeshRoot=this._handMesh;this._handMeshRoot.parent;)this._handMeshRoot=this._handMeshRoot.parent;e.alwaysSelectAsActiveMesh=!0;let r=e.getChildMeshes();for(let s of r)s.alwaysSelectAsActiveMesh=!0;if(this._handMesh.skeleton){let s=this._handMesh.skeleton;for(let o=0;o<Yi.length;o++){let a=Yi[o],l=s.getBoneIndexByName(t?t[a]:a);l!==-1&&s.bones[l].linkTransformNode(this._jointTransforms[o])}}this.onHandMeshSetObservable.notifyObservers(this)}updateFromXRFrame(e,t,n){let r=this.xrController.inputSource.hand;if(!r)return;let s=r,o=Yi.map(l=>s[l]||r.get(l)),a=!1;if(e.fillPoses&&e.fillJointRadii)a=e.fillPoses(o,t,this._jointTransformMatrices)&&e.fillJointRadii(o,this._jointRadii);else if(e.getJointPose){a=!0;for(let l=0;l<o.length;l++){let c=e.getJointPose(o[l],t);if(c)this._jointTransformMatrices.set(c.transform.matrix,l*16),this._jointRadii[l]=c.radius||.008;else{a=!1;break}}}if(a){for(let l=0;l<Yi.length;l++){let c=this._jointTransforms[l];V.FromArrayToRef(this._jointTransformMatrices,l*16,this._tempJointMatrix),this._tempJointMatrix.decompose(void 0,c.rotationQuaternion,c.position);let u=this._jointRadii[l]*this._jointScaleFactor,h=this._jointMeshes[l];h.isVisible=!this._handMesh&&!this._jointsInvisible,h.position.copyFrom(c.position),h.rotationQuaternion.copyFrom(c.rotationQuaternion),h.scaling.setAll(u),h.parent=n.parent,this._scene.useRightHandedSystem||(h.position.z*=-1,h.rotationQuaternion.z*=-1,h.rotationQuaternion.w*=-1,this._leftHandedMeshes&&this._handMesh&&(c.position.z*=-1,c.rotationQuaternion.z*=-1,c.rotationQuaternion.w*=-1))}this._handMesh&&(this._handMesh.isVisible=!0,this._handMeshRoot&&(this._handMeshRoot.parent=n.parent)),this.xrController.pointer.parent=n.parent}}dispose(e=!1){this._handMesh&&(e?(this._handMesh.skeleton?.dispose(),this._handMesh.dispose(!1,!0)):this._handMesh.isVisible=!1);for(let t of this._jointTransforms)t.dispose();this._jointTransforms.length=0,this.onHandMeshSetObservable.clear()}},kn=class i extends Gr{static _GenerateTrackedJointMeshes(e,t=Ll("jointParent",i._ICOSPHERE_PARAMS)){let n={};return["left","right"].map(r=>{let s=[];t.isVisible=!!e.jointMeshes?.keepOriginalVisible;for(let o=0;o<Yi.length;++o){let a=t.createInstance(`${r}-handJoint-${o}`);if(e.jointMeshes?.onHandJointMeshGenerated){let l=e.jointMeshes.onHandJointMeshGenerated(a,o,r);l&&l!==a&&(a.dispose(),a=l)}if(a.isPickable=!1,e.jointMeshes?.enablePhysics){let l=e.jointMeshes?.physicsProps||{};a.scaling.setAll(.02);let c=l.impostorType!==void 0?l.impostorType:Rt.SphereImpostor;a.physicsImpostor=new Rt(a,c,K({mass:0},l))}a.rotationQuaternion=new J,a.isVisible=!1,s.push(a)}n[r]=s}),{left:n.left,right:n.right}}static _GenerateDefaultHandMeshesAsync(e,t,n){return T(this,null,function*(){return yield new Promise(r=>T(null,null,function*(){let s={};i._RightHandGLB?.meshes[1]?.isDisposed()&&(i._RightHandGLB=null),i._LeftHandGLB?.meshes[1]?.isDisposed()&&(i._LeftHandGLB=null);let o=!!(i._RightHandGLB&&i._LeftHandGLB),a=z.GetAssetUrl(i.DEFAULT_HAND_MODEL_BASE_URL),l=yield Promise.all([i._RightHandGLB||Bo.ImportMeshAsync("",a,i.DEFAULT_HAND_MODEL_RIGHT_FILENAME,e),i._LeftHandGLB||Bo.ImportMeshAsync("",a,i.DEFAULT_HAND_MODEL_LEFT_FILENAME,e)]);i._RightHandGLB=l[0],i._LeftHandGLB=l[1];let c=z.GetAssetUrl(i.DEFAULT_HAND_MODEL_SHADER_URL),u=yield qt.ParseFromFileAsync("handShader",c,e,void 0,!0);u.needDepthPrePass=!0,u.transparencyMode=Oe.MATERIAL_ALPHABLEND,u.alphaMode=2,u.build(!1);let h=K({base:G.FromInts(116,63,203),fresnel:G.FromInts(149,102,229),fingerColor:G.FromInts(177,130,255),tipFresnel:G.FromInts(220,200,255)},n?.handMeshes?.customColors),d={base:u.getBlockByName("baseColor"),fresnel:u.getBlockByName("fresnelColor"),fingerColor:u.getBlockByName("fingerColor"),tipFresnel:u.getBlockByName("tipFresnelColor")};d.base.value=h.base,d.fresnel.value=h.fresnel,d.fingerColor.value=h.fingerColor,d.tipFresnel.value=h.tipFresnel;let f=t._getBaseLayerWrapper()?.isMultiview,p=["left","right"];for(let g of p){let _=g=="left"?i._LeftHandGLB:i._RightHandGLB;if(!_)throw new Error("Could not load hand model");let y=_.meshes[1];y._internalAbstractMeshDataInfo._computeBonesUsingShaders=!0,!f&&!n?.handMeshes?.disableHandShader&&(y.material=u.clone(`${g}HandShaderClone`,!0)),y.isVisible=!1,s[g]=y,!o&&!e.useRightHandedSystem&&_.meshes[1].rotate(Vn.Y,Math.PI)}u.dispose(),r({left:s.left,right:s.right})}))})}static _GenerateDefaultHandMeshRigMapping(e){let t=e=="right"?"R":"L";return{wrist:`wrist_${t}`,"thumb-metacarpal":`thumb_metacarpal_${t}`,"thumb-phalanx-proximal":`thumb_proxPhalanx_${t}`,"thumb-phalanx-distal":`thumb_distPhalanx_${t}`,"thumb-tip":`thumb_tip_${t}`,"index-finger-metacarpal":`index_metacarpal_${t}`,"index-finger-phalanx-proximal":`index_proxPhalanx_${t}`,"index-finger-phalanx-intermediate":`index_intPhalanx_${t}`,"index-finger-phalanx-distal":`index_distPhalanx_${t}`,"index-finger-tip":`index_tip_${t}`,"middle-finger-metacarpal":`middle_metacarpal_${t}`,"middle-finger-phalanx-proximal":`middle_proxPhalanx_${t}`,"middle-finger-phalanx-intermediate":`middle_intPhalanx_${t}`,"middle-finger-phalanx-distal":`middle_distPhalanx_${t}`,"middle-finger-tip":`middle_tip_${t}`,"ring-finger-metacarpal":`ring_metacarpal_${t}`,"ring-finger-phalanx-proximal":`ring_proxPhalanx_${t}`,"ring-finger-phalanx-intermediate":`ring_intPhalanx_${t}`,"ring-finger-phalanx-distal":`ring_distPhalanx_${t}`,"ring-finger-tip":`ring_tip_${t}`,"pinky-finger-metacarpal":`little_metacarpal_${t}`,"pinky-finger-phalanx-proximal":`little_proxPhalanx_${t}`,"pinky-finger-phalanx-intermediate":`little_intPhalanx_${t}`,"pinky-finger-phalanx-distal":`little_distPhalanx_${t}`,"pinky-finger-tip":`little_tip_${t}`}}isCompatible(){return typeof XRHand<"u"}getHandByControllerId(e){return this._attachedHands[e]}getHandByHandedness(e){return e=="none"?null:this._trackingHands[e]}constructor(e,t){super(e),this.options=t,this._attachedHands={},this._trackingHands={left:null,right:null},this._handResources={jointMeshes:null,handMeshes:null,rigMappings:null},this._worldScaleObserver=null,this.onHandAddedObservable=new B,this.onHandRemovedObservable=new B,this._attachHand=s=>{if(!s.inputSource.hand||s.inputSource.handedness=="none"||!this._handResources.jointMeshes)return;let o=s.inputSource.handedness,a=new DC(s,this._handResources.jointMeshes[o],this._handResources.handMeshes&&this._handResources.handMeshes[o],this._handResources.rigMappings&&this._handResources.rigMappings[o],this.options.handMeshes?.meshesUseLeftHandedCoordinates,this.options.jointMeshes?.invisible,this.options.jointMeshes?.scaleFactor);this._attachedHands[s.uniqueId]=a,this._trackingHands[o]=a,this.onHandAddedObservable.notifyObservers(a)},this._detachHand=s=>{this._detachHandById(s.uniqueId)},this.xrNativeFeatureName="hand-tracking";let r=t.jointMeshes;if(r&&(typeof r.disableDefaultHandMesh<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.disableDefaultMeshes=r.disableDefaultHandMesh),typeof r.handMeshes<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.customMeshes=r.handMeshes),typeof r.leftHandedSystemMeshes<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.meshesUseLeftHandedCoordinates=r.leftHandedSystemMeshes),typeof r.rigMapping<"u")){t.handMeshes=t.handMeshes||{};let s={},o={},a=[[r.rigMapping.left,s],[r.rigMapping.right,o]];for(let l of a){let c=l[0],u=l[1];for(let h=0;h<c.length;h++){let d=c[h];u[Yi[h]]=d}}t.handMeshes.customRigMappings={left:s,right:o}}}attach(){if(!super.attach())return!1;this._handResources.jointMeshes||(this._originalMesh=this._originalMesh||this.options.jointMeshes?.sourceMesh||Ll("jointParent",i._ICOSPHERE_PARAMS),this._originalMesh.isVisible=!1,this._handResources.jointMeshes=i._GenerateTrackedJointMeshes(this.options,this._originalMesh)),this._handResources.handMeshes=this.options.handMeshes?.customMeshes||null,this._handResources.rigMappings=this.options.handMeshes?.customRigMappings||null,!this.options.handMeshes?.customMeshes&&!this.options.handMeshes?.disableDefaultMeshes&&(i._GenerateDefaultHandMeshesAsync(Ie.LastCreatedScene,this._xrSessionManager,this.options).then(e=>{this._handResources.handMeshes=e,this._handResources.rigMappings={left:i._GenerateDefaultHandMeshRigMapping("left"),right:i._GenerateDefaultHandMeshRigMapping("right")},this._trackingHands.left?.setHandMesh(this._handResources.handMeshes.left,this._handResources.rigMappings.left,this._xrSessionManager),this._trackingHands.right?.setHandMesh(this._handResources.handMeshes.right,this._handResources.rigMappings.right,this._xrSessionManager),this._handResources.handMeshes.left.scaling.setAll(this._xrSessionManager.worldScalingFactor),this._handResources.handMeshes.right.scaling.setAll(this._xrSessionManager.worldScalingFactor)}),this._worldScaleObserver=this._xrSessionManager.onWorldScaleFactorChangedObservable.add(e=>{this._handResources.handMeshes&&(this._handResources.handMeshes.left.scaling.scaleInPlace(e.newScaleFactor/e.previousScaleFactor),this._handResources.handMeshes.right.scaling.scaleInPlace(e.newScaleFactor/e.previousScaleFactor))}));for(let e of this.options.xrInput.controllers)this._attachHand(e);return this._addNewAttachObserver(this.options.xrInput.onControllerAddedObservable,this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerRemovedObservable,this._detachHand),!0}_onXRFrame(e){this._trackingHands.left?.updateFromXRFrame(e,this._xrSessionManager.referenceSpace,this.options.xrInput.xrCamera),this._trackingHands.right?.updateFromXRFrame(e,this._xrSessionManager.referenceSpace,this.options.xrInput.xrCamera)}_detachHandById(e,t){let n=this.getHandByControllerId(e);if(n){let r=n.xrController.inputSource.handedness=="left"?"left":"right";this._trackingHands[r]?.xrController.uniqueId===e&&(this._trackingHands[r]=null),this.onHandRemovedObservable.notifyObservers(n),n.dispose(t),delete this._attachedHands[e]}}detach(){if(!super.detach())return!1;let e=Object.keys(this._attachedHands);for(let t of e)this._detachHandById(t,this.options.handMeshes?.disposeOnSessionEnd);if(this.options.handMeshes?.disposeOnSessionEnd){if(this._handResources.jointMeshes){for(let t of this._handResources.jointMeshes.left)t.dispose();for(let t of this._handResources.jointMeshes.right)t.dispose();this._handResources.jointMeshes=null}if(this._handResources.handMeshes&&(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),this._handResources.handMeshes=null),i._RightHandGLB)for(let t of i._RightHandGLB.meshes)t.dispose();if(i._LeftHandGLB)for(let t of i._LeftHandGLB.meshes)t.dispose();i._RightHandGLB=null,i._LeftHandGLB=null,this._originalMesh?.dispose(),this._originalMesh=void 0}return this._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(this._worldScaleObserver),!0}dispose(){if(super.dispose(),this.onHandAddedObservable.clear(),this.onHandRemovedObservable.clear(),this._handResources.handMeshes&&!this.options.handMeshes?.customMeshes){if(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),i._RightHandGLB)for(let e of i._RightHandGLB.meshes)e.dispose();if(i._LeftHandGLB)for(let e of i._LeftHandGLB.meshes)e.dispose();i._RightHandGLB=null,i._LeftHandGLB=null}if(this._handResources.jointMeshes){for(let e of this._handResources.jointMeshes.left)e.dispose();for(let e of this._handResources.jointMeshes.right)e.dispose()}}};kn.Name=di.HAND_TRACKING;kn.Version=1;kn.DEFAULT_HAND_MODEL_BASE_URL="https://assets.babylonjs.com/core/HandMeshes/";kn.DEFAULT_HAND_MODEL_RIGHT_FILENAME="r_hand_rhs.glb";kn.DEFAULT_HAND_MODEL_LEFT_FILENAME="l_hand_rhs.glb";kn.DEFAULT_HAND_MODEL_SHADER_URL="https://assets.babylonjs.com/core/HandMeshes/handsShader.json";kn._ICOSPHERE_PARAMS={radius:.5,flat:!1,subdivisions:2};kn._RightHandGLB=null;kn._LeftHandGLB=null;fi.AddWebXRFeature(kn.Name,(i,e)=>()=>new kn(i,e),kn.Version,!1);var _s=class extends Gr{get rotationEnabled(){return this._rotationEnabled}set rotationEnabled(e){if(this._rotationEnabled=e,this._options.teleportationTargetMesh){let t=this._options.teleportationTargetMesh.getChildMeshes(!1,n=>n.name==="rotationCone");t[0]&&t[0].setEnabled(e)}}get teleportationTargetMesh(){return this._options.teleportationTargetMesh||null}constructor(e,t){super(e),this._options=t,this._controllers={},this._snappedToPoint=!1,this._cachedColor4White=new le(1,1,1,1),this._tmpRay=new pt(new m,new m),this._tmpVector=new m,this._tmpQuaternion=new J,this._worldScaleObserver=null,this.skipNextTeleportation=!1,this.backwardsMovementEnabled=!0,this.backwardsTeleportationDistance=.7,this.parabolicCheckRadius=5,this.parabolicRayEnabled=!0,this.straightRayEnabled=!0,this.rotationAngle=Math.PI/8,this.onTargetMeshPositionUpdatedObservable=new B,this.teleportationEnabled=!0,this._rotationEnabled=!0,this.onBeforeCameraTeleportRotation=new B,this.onAfterCameraTeleportRotation=new B,this._attachController=n=>{if(this._controllers[n.uniqueId]||this._options.forceHandedness&&n.inputSource.handedness!==this._options.forceHandedness)return;this._controllers[n.uniqueId]={xrController:n,teleportationState:{forward:!1,backwards:!1,rotating:!1,currentRotation:0,baseRotation:0,blocked:!1,initialHit:!1,mainComponentUsed:!1}};let r=this._controllers[n.uniqueId];if(r.xrController.inputSource.targetRayMode==="tracked-pointer"&&r.xrController.inputSource.gamepad){let s=()=>{if(n.motionController){let o=n.motionController.getComponentOfType(Ks.THUMBSTICK_TYPE)||n.motionController.getComponentOfType(Ks.TOUCHPAD_TYPE);if(!o||this._options.useMainComponentOnly){let a=n.motionController.getMainComponent();if(!a)return;r.teleportationState.mainComponentUsed=!0,r.teleportationComponent=a,r.onButtonChangedObserver=a.onButtonStateChangedObservable.add(()=>{if(!this.teleportationEnabled)return;let l=()=>{r.teleportationState.forward=!0,r.teleportationState.initialHit=!1,this._currentTeleportationControllerId=r.xrController.uniqueId,r.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,r.teleportationState.currentRotation=0;let c=this._options.timeToTeleport||3e3;pc({timeout:c,contextObservable:this._xrSessionManager.onXRFrameObservable,breakCondition:()=>!a.pressed,onEnded:()=>{this._currentTeleportationControllerId===r.xrController.uniqueId&&r.teleportationState.forward&&this._teleportForward(n.uniqueId)}})};a.changes.pressed&&(a.changes.pressed.current?this._options.timeToTeleportStart?pc({timeout:this._options.timeToTeleportStart,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{a.pressed&&l()}}):l():(r.teleportationState.forward=!1,this._currentTeleportationControllerId=""))})}else r.teleportationComponent=o,r.onAxisChangedObserver=o.onAxisValueChangedObservable.add(a=>{if(a.y<=.7&&r.teleportationState.backwards&&(r.teleportationState.backwards=!1),a.y>.7&&!r.teleportationState.forward&&this.backwardsMovementEnabled&&!this.snapPointsOnly&&!r.teleportationState.backwards){r.teleportationState.backwards=!0,this._tmpQuaternion.copyFrom(this._options.xrInput.xrCamera.rotationQuaternion),this._tmpQuaternion.toEulerAnglesToRef(this._tmpVector),this._tmpVector.x=0,this._tmpVector.z=0,J.FromEulerVectorToRef(this._tmpVector,this._tmpQuaternion),this._tmpVector.set(0,0,this.backwardsTeleportationDistance*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),this._tmpVector.rotateByQuaternionToRef(this._tmpQuaternion,this._tmpVector),this._tmpVector.addInPlace(this._options.xrInput.xrCamera.position),this._tmpRay.origin.copyFrom(this._tmpVector),this._tmpRay.length=this._options.xrInput.xrCamera.realWorldHeight+.1,this._tmpRay.direction.set(0,-1,0);let l=this._xrSessionManager.scene.pickWithRay(this._tmpRay,c=>this._floorMeshes.indexOf(c)!==-1);l&&l.pickedPoint&&(this._options.xrInput.xrCamera.position.x=l.pickedPoint.x,this._options.xrInput.xrCamera.position.z=l.pickedPoint.z)}if(a.y<-.7&&!this._currentTeleportationControllerId&&!r.teleportationState.rotating&&this.teleportationEnabled&&(r.teleportationState.forward=!0,this._currentTeleportationControllerId=r.xrController.uniqueId,r.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y),a.x){if(r.teleportationState.forward)this._currentTeleportationControllerId===r.xrController.uniqueId&&(this.rotationEnabled?setTimeout(()=>{r.teleportationState.currentRotation=Math.atan2(a.x,a.y*(this._xrSessionManager.scene.useRightHandedSystem?1:-1))}):r.teleportationState.currentRotation=0);else if(!r.teleportationState.rotating&&Math.abs(a.x)>.7){r.teleportationState.rotating=!0;let l=this.rotationAngle*(a.x>0?1:-1)*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);this.onBeforeCameraTeleportRotation.notifyObservers(l),J.FromEulerAngles(0,l,0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this.onAfterCameraTeleportRotation.notifyObservers(this._options.xrInput.xrCamera.rotationQuaternion)}}else r.teleportationState.rotating=!1;a.x===0&&a.y===0&&(r.teleportationState.blocked&&(r.teleportationState.blocked=!1,this._setTargetMeshVisibility(!1)),r.teleportationState.forward&&this._teleportForward(n.uniqueId))})}};n.motionController?s():n.onMotionControllerInitObservable.addOnce(()=>{s()})}else{r.teleportationState.mainComponentUsed=!0;let s=!1,o=()=>{this._currentTeleportationControllerId=r.xrController.uniqueId,r.teleportationState.forward=!0,r.teleportationState.initialHit=!1,r.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,r.teleportationState.currentRotation=0;let a=this._options.timeToTeleport||3e3;pc({timeout:a,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===r.xrController.uniqueId&&r.teleportationState.forward&&this._teleportForward(n.uniqueId)}})};this._xrSessionManager.scene.onPointerObservable.add(a=>{a.type===Ae.POINTERDOWN?(s=!1,this._options.timeToTeleportStart?pc({timeout:this._options.timeToTeleportStart,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===r.xrController.uniqueId&&o()},breakCondition:()=>s?(s=!1,!0):!1}):o()):a.type===Ae.POINTERUP&&(s=!0,r.teleportationState.forward=!1,this._currentTeleportationControllerId="")})}},this._colorArray=Array(24).fill(this._cachedColor4White),this._options.teleportationTargetMesh||this._createDefaultTargetMesh(),this._floorMeshes=this._options.floorMeshes||[],this._snapToPositions=this._options.snapPositions||[],this._blockedRayColor=this._options.blockedRayColor||new le(1,0,0,.75),this._setTargetMeshVisibility(!1),this.onBeforeCameraTeleport=t.xrInput.xrCamera.onBeforeCameraTeleport,this.onAfterCameraTeleport=t.xrInput.xrCamera.onAfterCameraTeleport,this.parabolicCheckRadius*=this._xrSessionManager.worldScalingFactor,this._worldScaleObserver=e.onWorldScaleFactorChangedObservable.add(n=>{this.parabolicCheckRadius=this.parabolicCheckRadius/n.previousScaleFactor*n.newScaleFactor,this._options.teleportationTargetMesh?.scaling.scaleInPlace(n.newScaleFactor/n.previousScaleFactor)})}get snapPointsOnly(){return!!this._options.snapPointsOnly}set snapPointsOnly(e){this._options.snapPointsOnly=e}addFloorMesh(e){this._floorMeshes.push(e)}addBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[],this._options.pickBlockerMeshes.push(e)}addSnapPoint(e){this._snapToPositions.push(e)}attach(){if(!super.attach())return!1;this._currentTeleportationControllerId="";for(let e of this._options.xrInput.controllers)this._attachController(e);return this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),!0}detach(){if(!super.detach())return!1;let e=Object.keys(this._controllers);for(let t of e)this._detachController(t);return this._setTargetMeshVisibility(!1),this._currentTeleportationControllerId="",this._controllers={},!0}dispose(){super.dispose(),this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.dispose(!1,!0),this._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(this._worldScaleObserver),this.onTargetMeshPositionUpdatedObservable.clear(),this.onTargetMeshPositionUpdatedObservable.clear(),this.onBeforeCameraTeleportRotation.clear(),this.onAfterCameraTeleportRotation.clear(),this.onBeforeCameraTeleport.clear(),this.onAfterCameraTeleport.clear()}removeFloorMesh(e){let t=this._floorMeshes.indexOf(e);t!==-1&&this._floorMeshes.splice(t,1)}removeBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[];let t=this._options.pickBlockerMeshes.indexOf(e);t!==-1&&this._options.pickBlockerMeshes.splice(t,1)}removeFloorMeshByName(e){let t=this._xrSessionManager.scene.getMeshByName(e);t&&this.removeFloorMesh(t)}removeSnapPoint(e){let t=this._snapToPositions.indexOf(e);if(t===-1){for(let n=0;n<this._snapToPositions.length;++n)if(this._snapToPositions[n].equals(e)){t=n;break}}return t!==-1?(this._snapToPositions.splice(t,1),!0):!1}setSelectionFeature(e){this._selectionFeature=e}_onXRFrame(e){let t=this._xrSessionManager.currentFrame,n=this._xrSessionManager.scene;if(!this.attach||!t)return;let r=this._options.teleportationTargetMesh;if(this._currentTeleportationControllerId){if(!r)return;r.rotationQuaternion=r.rotationQuaternion||new J;let s=this._controllers[this._currentTeleportationControllerId];if(s&&s.teleportationState.forward){J.RotationYawPitchRollToRef(s.teleportationState.currentRotation+s.teleportationState.baseRotation,0,0,r.rotationQuaternion);let o=!1,a=s.xrController.inputSource.targetRayMode!=="transient-pointer";if(s.xrController.getWorldPointerRayToRef(this._tmpRay),this.straightRayEnabled){let l=n.pickWithRay(this._tmpRay,u=>{if(this._options.blockerMeshesPredicate&&this._options.blockerMeshesPredicate(u)||this._options.blockAllPickableMeshes&&u.isPickable||this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(u)!==-1)return!0;let h=this._floorMeshes.indexOf(u);return h===-1?!1:this._floorMeshes[h].absolutePosition.y<this._options.xrInput.xrCamera.globalPosition.y}),c=l&&l.pickedMesh&&this._floorMeshes.indexOf(l.pickedMesh)!==-1;if(l&&l.pickedMesh&&!c){if(s.teleportationState.mainComponentUsed&&!s.teleportationState.initialHit){s.teleportationState.forward=!1;return}s.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1,!1,a),this._showParabolicPath(l);return}else l&&l.pickedPoint&&(s.teleportationState.initialHit=!0,s.teleportationState.blocked=!1,o=!0,this._setTargetMeshPosition(l),this._setTargetMeshVisibility(!0,!1,a),this._showParabolicPath(l))}if(this.parabolicRayEnabled&&!o){let l=s.xrController.pointer.rotationQuaternion.toEulerAngles().x,c=1+(Math.PI/2-Math.abs(l)),u=this.parabolicCheckRadius*c;this._tmpRay.origin.addToRef(this._tmpRay.direction.scale(u*2),this._tmpVector),this._tmpVector.y=this._tmpRay.origin.y,this._tmpRay.origin.addInPlace(this._tmpRay.direction.scale(u)),this._tmpVector.subtractToRef(this._tmpRay.origin,this._tmpRay.direction),this._tmpRay.direction.normalize();let h=n.pickWithRay(this._tmpRay,f=>this._options.blockerMeshesPredicate&&this._options.blockerMeshesPredicate(f)||this._options.blockAllPickableMeshes&&f.isPickable||this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(f)!==-1?!0:this._floorMeshes.indexOf(f)!==-1),d=h&&h.pickedMesh&&this._floorMeshes.indexOf(h.pickedMesh)!==-1;if(h&&h.pickedMesh&&!d){if(s.teleportationState.mainComponentUsed&&!s.teleportationState.initialHit){s.teleportationState.forward=!1;return}s.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1,!1,a),this._showParabolicPath(h);return}else h&&h.pickedPoint&&(s.teleportationState.initialHit=!0,s.teleportationState.blocked=!1,o=!0,this._setTargetMeshPosition(h),this._setTargetMeshVisibility(!0,!1,a),this._showParabolicPath(h))}this._setTargetMeshVisibility(o,!1,a)}else this._setTargetMeshVisibility(!1,!1,!0)}else this._disposeBezierCurve(),this._setTargetMeshVisibility(!1,!1,!0)}_createDefaultTargetMesh(){this._options.defaultTargetMeshOptions=this._options.defaultTargetMeshOptions||{};let e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Ur.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,t=Yo("teleportationTarget",{width:2,height:2,subdivisions:2},e);if(t.isPickable=!1,this._options.defaultTargetMeshOptions.teleportationCircleMaterial)t.material=this._options.defaultTargetMeshOptions.teleportationCircleMaterial;else{let o=new Vr("teleportationPlaneDynamicTexture",512,e,!0);o.hasAlpha=!0;let a=o.getContext(),l=512/2,c=512/2,u=200;a.beginPath(),a.arc(l,c,u,0,2*Math.PI,!1),a.fillStyle=this._options.defaultTargetMeshOptions.teleportationFillColor||"#444444",a.fill(),a.lineWidth=10,a.strokeStyle=this._options.defaultTargetMeshOptions.teleportationBorderColor||"#FFFFFF",a.stroke(),a.closePath(),o.update();let h=new Z("teleportationPlaneMaterial",e);h.diffuseTexture=o,t.material=h}let n=ur("torusTeleportation",{diameter:.75,thickness:.1,tessellation:20},e);if(n.isPickable=!1,n.parent=t,!this._options.defaultTargetMeshOptions.disableAnimation){let s=new H("animationInnerCircle","position.y",30,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CYCLE),o=[];o.push({frame:0,value:0}),o.push({frame:30,value:.4}),o.push({frame:60,value:0}),s.setKeys(o);let a=new kh;a.setEasingMode(ni.EASINGMODE_EASEINOUT),s.setEasingFunction(a),n.animations=[],n.animations.push(s),e.beginAnimation(n,0,60,!0)}let r=Xo("rotationCone",{diameterTop:0,tessellation:4},e);if(r.isPickable=!1,r.scaling.set(.5,.12,.2),r.rotate(Vn.X,Math.PI/2),r.position.z=.6,r.parent=n,this._options.defaultTargetMeshOptions.torusArrowMaterial)n.material=this._options.defaultTargetMeshOptions.torusArrowMaterial,r.material=this._options.defaultTargetMeshOptions.torusArrowMaterial;else{let s=new Z("torusConsMat",e);s.disableLighting=!!this._options.defaultTargetMeshOptions.disableLighting,s.disableLighting?s.emissiveColor=new G(.3,.3,1):s.diffuseColor=new G(.3,.3,1),s.alpha=.9,n.material=s,r.material=s,this._teleportationRingMaterial=s}this._options.renderingGroupId!==void 0&&(t.renderingGroupId=this._options.renderingGroupId,n.renderingGroupId=this._options.renderingGroupId,r.renderingGroupId=this._options.renderingGroupId),this._options.teleportationTargetMesh=t,this._options.teleportationTargetMesh.scaling.setAll(this._xrSessionManager.worldScalingFactor),this._setTargetMeshVisibility(!1)}_detachController(e){let t=this._controllers[e];t&&(t.teleportationComponent&&(t.onAxisChangedObserver&&t.teleportationComponent.onAxisValueChangedObservable.remove(t.onAxisChangedObserver),t.onButtonChangedObserver&&t.teleportationComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver)),delete this._controllers[e])}_findClosestSnapPointWithRadius(e,t=this._options.snapToPositionRadius||.8){let n=null,r=Number.MAX_VALUE;if(this._snapToPositions.length){let s=t*t;for(let o of this._snapToPositions){let a=m.DistanceSquared(o,e);a<=s&&a<r&&(r=a,n=o)}}return n}_setTargetMeshPosition(e){let t=e.pickedPoint;if(!this._options.teleportationTargetMesh||!t)return;let n=this._findClosestSnapPointWithRadius(t);this._snappedToPoint=!!n,this.snapPointsOnly&&!this._snappedToPoint&&this._teleportationRingMaterial?this._teleportationRingMaterial.diffuseColor.set(1,.3,.3):this.snapPointsOnly&&this._snappedToPoint&&this._teleportationRingMaterial&&this._teleportationRingMaterial.diffuseColor.set(.3,.3,1),this._options.teleportationTargetMesh.position.copyFrom(n||t),this._options.teleportationTargetMesh.position.y+=.01,this.onTargetMeshPositionUpdatedObservable.notifyObservers(e)}_setTargetMeshVisibility(e,t,n){if(!this._options.teleportationTargetMesh||this._options.teleportationTargetMesh.isVisible===e&&!t)return;this._options.teleportationTargetMesh.isVisible=e;let r=this._options.teleportationTargetMesh.getChildren(void 0,!1);for(let s of r)s.isVisible=e;e?this._selectionFeature&&n&&this._selectionFeature.detach():(this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null),this._selectionFeature&&n&&this._selectionFeature.attach())}_disposeBezierCurve(){this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null)}_showParabolicPath(e){if(!e.pickedPoint||!this._currentTeleportationControllerId)return;let t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||Ur.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,n=this._controllers[this._currentTeleportationControllerId],r=aT.CreateQuadraticBezier(n.xrController.pointer.absolutePosition,e.ray.origin,e.pickedPoint,25),s=n.teleportationState.blocked?this._blockedRayColor:void 0,o=this._colorArray.fill(s||this._cachedColor4White),a=r.getPoints();a.shift(),a.shift(),this._options.generateRayPathMesh?this._quadraticBezierCurve=this._options.generateRayPathMesh(r.getPoints(),e):this._quadraticBezierCurve=Vu("teleportation path line",{points:a,instance:this._quadraticBezierCurve,updatable:!0,colors:o},t),this._quadraticBezierCurve.isPickable=!1,this._options.renderingGroupId!==void 0&&(this._quadraticBezierCurve.renderingGroupId=this._options.renderingGroupId)}_teleportForward(e){let t=this._controllers[e];if(!(!t||!t.teleportationState.forward||!this.teleportationEnabled)&&(t.teleportationState.forward=!1,this._currentTeleportationControllerId="",!(this.snapPointsOnly&&!this._snappedToPoint))){if(this.skipNextTeleportation){this.skipNextTeleportation=!1;return}if(this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.isVisible){let n=this._options.xrInput.xrCamera.realWorldHeight;this.onBeforeCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position),this._options.xrInput.xrCamera.position.copyFrom(this._options.teleportationTargetMesh.position),this._options.xrInput.xrCamera.position.y+=n,J.FromEulerAngles(0,t.teleportationState.currentRotation-(this._xrSessionManager.scene.useRightHandedSystem?Math.PI:0),0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this.onAfterCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position)}}}};_s.Name=di.TELEPORTATION;_s.Version=1;fi.AddWebXRFeature(_s.Name,(i,e)=>()=>new _s(i,e),_s.Version,!0);var qm=class i{constructor(){}static CreateAsync(n){return T(this,arguments,function*(e,t={}){let r=new i;if(e.onDisposeObservable.addOnce(()=>{r.dispose()}),!t.disableDefaultUI){let s=K({renderTarget:r.renderTarget},t.uiOptions||{});t.optionalFeatures&&(typeof t.optionalFeatures=="boolean"?s.optionalFeatures=["hit-test","anchors","plane-detection","hand-tracking"]:s.optionalFeatures=t.optionalFeatures),r.enterExitUI=new jm(e,s)}try{let s=yield Bm.CreateAsync(e);if(r.baseExperience=s,t.ignoreNativeCameraTransformation&&(r.baseExperience.camera.compensateOnFirstFrame=!1),r.input=new Um(s.sessionManager,s.camera,K({controllerOptions:{renderingGroupId:t.renderingGroupId}},t.inputOptions||{})),!t.disablePointerSelection){let o=ct(K({},t.pointerSelectionOptions),{xrInput:r.input,renderingGroupId:t.renderingGroupId});r.pointerSelection=r.baseExperience.featuresManager.enableFeature(zr.Name,t.useStablePlugins?"stable":"latest",o),t.disableTeleportation||(r.teleportation=r.baseExperience.featuresManager.enableFeature(_s.Name,t.useStablePlugins?"stable":"latest",K({floorMeshes:t.floorMeshes,xrInput:r.input,renderingGroupId:t.renderingGroupId},t.teleportationOptions)),r.teleportation.setSelectionFeature(r.pointerSelection))}return t.disableNearInteraction||(r.nearInteraction=r.baseExperience.featuresManager.enableFeature(jr.Name,t.useStablePlugins?"stable":"latest",K({xrInput:r.input,farInteractionFeature:r.pointerSelection,renderingGroupId:t.renderingGroupId,useUtilityLayer:!0,enableNearInteractionOnAllControllers:!0},t.nearInteractionOptions))),t.disableHandTracking||r.baseExperience.featuresManager.enableFeature(kn.Name,t.useStablePlugins?"stable":"latest",K({xrInput:r.input},t.handSupportOptions),void 0,!1),r.renderTarget=r.baseExperience.sessionManager.getWebXRRenderTarget(t.outputCanvasOptions),t.disableDefaultUI||(yield r.enterExitUI.setHelperAsync(r.baseExperience,r.renderTarget)),r}catch(s){return N.Error("Error initializing XR"),N.Error(s),r}})}dispose(){this.baseExperience&&this.baseExperience.dispose(),this.input&&this.input.dispose(),this.enterExitUI&&this.enterExitUI.dispose(),this.renderTarget&&this.renderTarget.dispose()}};Pe.prototype.createDefaultLight=function(i=!1){if(i&&this.lights)for(let e=0;e<this.lights.length;e++)this.lights[e].dispose();this.lights.length===0&&new Pn("default light",m.Up(),this)};Pe.prototype.createDefaultCamera=function(i=!1,e=!1,t=!1){if(e&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){let n=this.getWorldExtends(l=>l.isVisible&&l.isEnabled()),r=n.max.subtract(n.min),s=n.min.add(r.scale(.5)),o,a=r.length()*1.5;if(isFinite(a)||(a=1,s.copyFromFloats(0,0,0)),i){let l=new Ze("default camera",-(Math.PI/2),Math.PI/2,a,s,this);l.lowerRadiusLimit=a*.01,l.wheelPrecision=100/a,o=l}else{let l=new Ot("default camera",new m(s.x,s.y,-a),this);l.setTarget(s),o=l}o.minZ=a*.01,o.maxZ=a*1e3,o.speed=a*.2,this.activeCamera=o,t&&o.attachControl()}};Pe.prototype.createDefaultCameraOrLight=function(i=!1,e=!1,t=!1){this.createDefaultLight(e),this.createDefaultCamera(i,e,t)};Pe.prototype.createDefaultSkybox=function(i,e=!1,t=1e3,n=0,r=!0){if(!i)return N.Warn("Can not create default skybox without environment texture."),null;r&&i&&(this.environmentTexture=i);let s=Ko("hdrSkyBox",{size:t},this);if(e){let o=new Na("skyBox",this);o.backFaceCulling=!1,o.reflectionTexture=i.clone(),o.reflectionTexture&&(o.reflectionTexture.coordinatesMode=te.SKYBOX_MODE),o.microSurface=1-n,o.disableLighting=!0,o.twoSidedLighting=!0,s.material=o}else{let o=new Z("skyBox",this);o.backFaceCulling=!1,o.reflectionTexture=i.clone(),o.reflectionTexture&&(o.reflectionTexture.coordinatesMode=te.SKYBOX_MODE),o.disableLighting=!0,s.material=o}return s.isPickable=!1,s.infiniteDistance=!0,s.ignoreCameraMaxZ=!0,s};Pe.prototype.createDefaultEnvironment=function(i){return gC?new gC(i,this):null};Pe.prototype.createDefaultVRExperience=function(i={}){return new SM(this,i)};Pe.prototype.createDefaultXRExperienceAsync=function(){return T(this,arguments,function*(i={}){return yield qm.CreateAsync(this,i)})};function AM(i){let e=document.querySelectorAll(`link[href="${i}"]`);if(e.length>1)for(let t=1;t<e.length;t++)e[t].remove()}function wM(){let i=navigator.userAgent,e;"userAgentData"in navigator&&navigator.userAgentData?e=navigator.userAgentData.platform:e=navigator.platform;let t=e==="MacIntel"&&navigator.maxTouchPoints>1;return/android/i.test(i)||/iphone|ipod/i.test(i)||/ipad/i.test(i)?!0:t}var Kn={INITIAL_ALPHA:Math.PI/2,INITIAL_BETA:15*Math.PI/32,INITIAL_RADIUS:3,WHEEL_PRECISION:200,ANGULAR_SENSITIVITY:3e3,FRAMING_TIME:0,ELEVATION_RETURN_TIME:3e3,ELEVATION_WAIT_TIME:9e3,RADIUS_ADJUSTMENT:1.5,RADIUS_LOWER_LIMIT_RATIO:.5,RADIUS_UPPER_LIMIT_RATIO:2},RC={POINT_LIGHT_INTENSITY:.2,HEMISPHERIC_LIGHT_INTENSITY:.2},Xl=class i{constructor(e){this.ngZone=e}engine=null;scene=null;camera=null;canvas=null;framingBehavior=null;envTexture="assets/textures/environmentSpecular.env";glowLayer=null;parentBox=null;meshToZoom=null;sceneHelper=null;pointLightBottom=null;hemisphericLightLeft=null;hemisphericLightRight=null;cameraInitialAlpha=null;cameraInitialBeta=null;cameraInitialRadius=null;keydownListener;isInspectorLoaded=!1;get currentGlowLayer(){return this.glowLayer}initScene(e,t,n){this.createEngine(e),this.createScene(),this.createPrincipalCamera(n),t.createEnvironmentTexture&&this.createDefaultEnvironment(),t.createLights&&this.createDefaultLights(),t.allowCamControls&&this.allowCamControls(!0),t.createGlowLayer&&this.scene&&(this.glowLayer=new Mi("glow",this.scene),this.glowLayer.intensity=.8),this.showDebugLayer()}createEngine(e){this.ngZone.runOutsideAngular(()=>{this.engine=new Sn(e,!0,{adaptToDeviceRatio:!0,preserveDrawingBuffer:!0,stencil:!0,disableWebGL2Support:!1})}),this.canvas=e}createScene(){this.scene=new Pe(this.engine,{preserveDrawingBuffer:!0})}allowCamControls(e){!this.scene||!this.camera||(this.scene.activeCamera=this.camera,e?this.camera.attachControl(this.canvas,!0):this.camera.detachControl())}createPrincipalCamera(e){this.scene&&(this.camera=new Ze("mainCamera",Kn.INITIAL_ALPHA,Kn.INITIAL_BETA,Kn.INITIAL_RADIUS,m.Zero(),this.scene),this.scene.setActiveCameraById(this.camera.id),this.configureCameraSettings(e))}configureCameraSettings(e){this.camera&&(this.camera.wheelPrecision=Kn.WHEEL_PRECISION,this.camera.angularSensibilityX=Kn.ANGULAR_SENSITIVITY,this.camera.angularSensibilityY=Kn.ANGULAR_SENSITIVITY,this.camera.minZ=0,this.camera.useFramingBehavior=!0,this.camera.framingBehavior&&(this.framingBehavior=this.camera.framingBehavior,this.configureFramingBehavior(e.autoElevation)),e.removeKeyBoardInputs&&this.camera.inputs.removeByType("ArcRotateCameraKeyboardMoveInput"),e.disablePanning&&(this.camera._useCtrlForPanning=!1,this.camera.panningSensibility=0))}configureFramingBehavior(e){this.framingBehavior&&(e?(this.framingBehavior.elevationReturnTime=-1,this.framingBehavior.autoCorrectCameraLimitsAndSensibility=!1):(this.framingBehavior.elevationReturnTime=Kn.ELEVATION_RETURN_TIME,this.framingBehavior.elevationReturnWaitTime=Kn.ELEVATION_WAIT_TIME))}rendererLoopCallback=()=>{this.engine?.resize(),this.scene?.render()};onResize=()=>{this.engine&&this.engine.resize()};startAnimation(){this.engine&&this.ngZone.runOutsideAngular(()=>{this.engine.runRenderLoop(this.rendererLoopCallback),window.addEventListener("resize",this.onResize)})}stopAnimation(){this.engine&&(this.engine.stopRenderLoop(this.rendererLoopCallback),window.removeEventListener("resize",this.onResize))}loadModel(e,t){return T(this,null,function*(){if(!this.scene)throw new Error("Scene not initialized.");try{return yield lw(e,this.scene,{name:this.extractFileName(e),pluginExtension:".glb",onProgress:t})}catch(n){throw new Error(`Failed to load model from "${e}": ${n}`)}})}extractFileName(e){return e.split("/").pop()||""}setCameraInitialTarget(e=!1,t=!0,n=!1,r,s=!0,o=!0){if(!r?.meshes)return;let a=this.createParentBoundingBox(r.meshes,n);return o&&(this.parentBox=a),t&&this.setRadius(e,s),a}createParentBoundingBox(e,t){let n=this.calculateCombinedBoundingInfo(e),r=this.createBoundingBoxMesh(n),s=e[0];return s.setBoundingInfo(n),s.computeWorldMatrix(!0),s.setParent(r),s.isPickable=!0,t&&r.position.set(0,0,0),r.normalizeToUnitCube(!0),r.computeWorldMatrix(!0),r.refreshBoundingInfo(!0,!0),r.isPickable=!0,r}calculateCombinedBoundingInfo(e){let t=null,n=null;e[0].scaling.scaleInPlace(1);let r=e[0].getChildMeshes();for(let s of r){s.refreshBoundingInfo(!0,!0),s.computeWorldMatrix(!0);let o=s.getBoundingInfo().boundingBox;t=t?m.Minimize(t,o.minimumWorld):o.minimumWorld.clone(),n=n?m.Maximize(n,o.maximumWorld):o.maximumWorld.clone()}return new Xr(t,n)}createBoundingBoxMesh(e){let t=e.boundingBox.maximumWorld.subtract(e.boundingBox.minimumWorld),n=e.boundingBox.centerWorld,r=gn.CreateBox("parentBox"+Math.random(),{size:1},this.scene);return r.scaling.copyFrom(t),r.position.copyFrom(n),r.visibility=.4,r.isVisible=!1,r}setRadius(e,t=!0,n=!0){if(!this.parentBox||!this.framingBehavior)return;let r=this.createZoomMesh();this.frameCamera(r,e),t?this.meshToZoom=r:r.dispose(!1,!0),this.finalizeCameraSetup(e,n)}createZoomMesh(){let e=this.parentBox.clone("clone"+Math.random());return e.getChildren().forEach(t=>{t.setParent(null),t.dispose(),this.scene?.removeMesh(t)}),this.scaleMesh(e,Kn.RADIUS_ADJUSTMENT),e}frameCamera(e,t){this.framingBehavior&&(this.framingBehavior.framingTime=Kn.FRAMING_TIME,this.framingBehavior.zoomOnMesh(e,!1,()=>{t||this.framingBehavior?.detach()}))}finalizeCameraSetup(e,t){this.camera&&(e||(this.camera.useFramingBehavior=!0,this.camera.framingBehavior&&(this.framingBehavior=this.camera.framingBehavior),this.camera._useCtrlForPanning=!1,this.camera.panningSensibility=0,this.camera.wheelPrecision=Kn.WHEEL_PRECISION,this.camera.angularSensibilityX=Kn.ANGULAR_SENSITIVITY,this.camera.angularSensibilityY=Kn.ANGULAR_SENSITIVITY),t&&this.setCameraRadiusLimits(),this.saveCameraInitialPosition())}setCameraRadiusLimits(){if(!this.camera)return;let e=this.camera.radius;this.camera.lowerRadiusLimit=e*Kn.RADIUS_LOWER_LIMIT_RATIO,this.camera.upperRadiusLimit=e*Kn.RADIUS_UPPER_LIMIT_RATIO}saveCameraInitialPosition(){!this.camera||this.cameraInitialAlpha!==null||(this.cameraInitialAlpha=this.camera.alpha,this.cameraInitialBeta=this.camera.beta,this.cameraInitialRadius=this.camera.radius)}scaleMesh(e,t=1){let n=1/t;e.scaling.set(e.scaling.x*n,e.scaling.y*n,e.scaling.z*n),e.refreshBoundingInfo(!0,!0),e.computeWorldMatrix()}createDefaultEnvironment(){if(!this.scene)return;this.scene.clearColor=new le(0,0,0,0);let e={createGround:!1,createSkybox:!1,environmentTexture:this.envTexture};try{this.sceneHelper=this.scene.createDefaultEnvironment(e),this.sceneHelper&&this.sceneHelper.setMainColor(new G(.4,.4,.4))}catch(t){console.warn("Environment creation failed, likely network issue loading texture:",t)}}createDefaultLights(){if(!this.scene)return;let e=new G(1,1,1);this.pointLightBottom=this.createPointLight("pointLight",new m(0,-.8,0),e,RC.POINT_LIGHT_INTENSITY),this.hemisphericLightLeft=this.createHemisphericLight("hemisphericLightLeft",new m(-1,0,0),e,RC.HEMISPHERIC_LIGHT_INTENSITY),this.hemisphericLightRight=this.createHemisphericLight("hemisphericLightRight",new m(1,0,0),e,RC.HEMISPHERIC_LIGHT_INTENSITY)}createPointLight(e,t,n,r){let s=new Ii(e,t,this.scene);return s.diffuse=n,s.specular=n,s.intensity=r,s}createHemisphericLight(e,t,n,r){let s=new Pn(e,t,this.scene);return s.diffuse=n,s.specular=n,s.intensity=r,s}get currentScene(){return this.scene}get currentCamera(){return this.camera}showDebugLayer(){this.keydownListener=e=>{this.isInputFieldFocused(e)||e.key.toLowerCase()==="i"&&this.toggleDebugLayer().catch(console.error)},window.addEventListener("keydown",this.keydownListener)}isInputFieldFocused(e){let t=e.target;return t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.isContentEditable}toggleDebugLayer(){return T(this,null,function*(){if(this.scene){if(this.scene.debugLayer?.isVisible()){this.scene.debugLayer.hide();return}if(!this.isInspectorLoaded)try{yield Promise.all([import("./chunk-Y4XU4BRH.js"),import("./chunk-XFQWRXTV.js"),import("./chunk-JB2BMOGJ.js"),import("./chunk-YSIKWAYB.js")]),this.isInspectorLoaded=!0}catch(e){console.error("Failed to load Babylon Inspector:",e);return}yield this.scene.debugLayer.show({enablePopup:!0,enableClose:!0,embedMode:!0}),AM("https://use.typekit.net/cta4xsb.css")}})}dispose(){this.stopAnimation(),this.keydownListener&&window.removeEventListener("keydown",this.keydownListener),this.scene?.dispose(),this.engine?.dispose(),this.scene=null,this.engine=null,this.camera=null}ngOnDestroy(){this.dispose()}static \u0275fac=function(t){return new(t||i)(je(Et))};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})};var $e={NEON_COLOR:new G(.1,1,.1),ROTATION_SPEED_Y:.001,ROTATION_SPEED_Z:5e-4,STROKE_WIDTH:.08,TUBE_TESSELLATION:6,SPHERE_SEGMENTS:6,ARC_SEGMENTS:24,DEFAULT_GLYPH_COUNT:50,DEFAULT_RADIUS:20,RADIUS_VARIATION:4,MIN_RING_COUNT:1,MAX_RING_COUNT:3,BASE_RING_RADIUS:.8,RING_SPACING:.5,DOT_SCALE:.4,CONNECTOR_DOT_SCALE:.3,CONNECTOR_BASE_RADIUS:.6,MIN_LINE_LENGTH:2,MAX_LINE_LENGTH:4,MIN_GLYPH_SCALE:.2,MAX_GLYPH_SCALE:.8,ENABLE_INSTANCING:!0},Ym=class i{shieldRoot=null;neonMaterial=null;scene=null;isAnimating=!1;baseDotMesh=null;baseRingMeshes=new Map;baseFullRingMesh=null;constructor(){}createShieldSystem(e,t=$e.DEFAULT_GLYPH_COUNT,n=$e.DEFAULT_RADIUS){return this.scene=e,this.createNeonMaterial(e),this.createBaseMeshes(e),this.shieldRoot=this.generateSpaceHUD(t,n,e),this.shieldRoot}startAnimation(){!this.scene||!this.shieldRoot||this.isAnimating||(this.isAnimating=!0,this.scene.registerBeforeRender(()=>{this.shieldRoot&&this.isAnimating&&(this.shieldRoot.rotation.y+=$e.ROTATION_SPEED_Y)}))}stopAnimation(){this.isAnimating=!1}dispose(){this.stopAnimation(),this.shieldRoot&&(this.shieldRoot.dispose(),this.shieldRoot=null),this.baseRingMeshes.forEach(e=>e.dispose()),this.baseRingMeshes.clear(),this.baseDotMesh&&(this.baseDotMesh.dispose(),this.baseDotMesh=null),this.baseFullRingMesh&&(this.baseFullRingMesh.dispose(),this.baseFullRingMesh=null),this.neonMaterial&&(this.neonMaterial.dispose(),this.neonMaterial=null),this.scene=null}updateRadius(e){if(!this.scene||!this.shieldRoot)return;let t=this.shieldRoot.getChildren().length;this.dispose(),this.createShieldSystem(this.scene,t,e),this.startAnimation()}createNeonMaterial(e){this.neonMaterial=new Z("neonMat",e),this.neonMaterial.emissiveColor=$e.NEON_COLOR,this.neonMaterial.diffuseColor=new G(0,0,0),this.neonMaterial.specularColor=new G(0,0,0),this.neonMaterial.alpha=1}createBaseMeshes(e){this.baseDotMesh=gn.CreateSphere("baseDot",{diameter:1,segments:$e.SPHERE_SEGMENTS},e),this.baseDotMesh.isVisible=!1,this.neonMaterial&&(this.baseDotMesh.material=this.neonMaterial),this.baseFullRingMesh=this.createBaseRingMesh($e.CONNECTOR_BASE_RADIUS,e),[$e.BASE_RING_RADIUS,$e.BASE_RING_RADIUS+$e.RING_SPACING,$e.BASE_RING_RADIUS+$e.RING_SPACING*2].forEach(n=>{let r=this.createBaseRingMesh(n,e);this.baseRingMeshes.set(n,r)})}createBaseRingMesh(e,t){let n=this.createArcPoints(e,0,Math.PI*2,$e.ARC_SEGMENTS),r=gn.CreateTube(`baseRing_${e}`,{path:n,radius:$e.STROKE_WIDTH/2,tessellation:$e.TUBE_TESSELLATION,cap:A.CAP_ALL,updatable:!1},t);return r.isVisible=!1,this.neonMaterial&&(r.material=this.neonMaterial),r}createArcPoints(e,t,n,r){let s=[];for(let o=0;o<=r;o++){let a=t+o/r*(n-t);s.push(new m(Math.cos(a)*e,Math.sin(a)*e,0))}return s}createStrokeMesh(e,t,n){let r=gn.CreateTube("stroke",{path:e,radius:t/2,tessellation:$e.TUBE_TESSELLATION,cap:A.CAP_ALL,updatable:!1},n);return this.neonMaterial&&(r.material=this.neonMaterial),r}createDot(e,t){if(!this.baseDotMesh||!$e.ENABLE_INSTANCING)return this.createOriginalDot(e,t);let n=this.baseDotMesh.createInstance("dotInstance");return n.scaling=new m(e,e,.1),n}createOriginalDot(e,t){let n=gn.CreateSphere("dot",{diameter:1,segments:$e.SPHERE_SEGMENTS},t);return n.scaling=new m(e,e,.1),this.neonMaterial&&(n.material=this.neonMaterial),n}createConcentricGlyph(e){let t=new ln("glyphConcentric",e);if(Math.random()>.2){let r=this.createDot($e.DOT_SCALE,e);r.parent=t}let n=Math.floor(Math.random()*$e.MAX_RING_COUNT)+$e.MIN_RING_COUNT;for(let r=0;r<n;r++){let s=$e.BASE_RING_RADIUS+r*$e.RING_SPACING,o=this.baseRingMeshes.get(s);if(o&&$e.ENABLE_INSTANCING)if(Math.random()>.4){let l=this.createRingWithGap(s,e);l.parent=t,l.rotation.z=Math.random()*Math.PI*2}else{let l=o.createInstance("ringInstance");l.parent=t,l.rotation.z=Math.random()*Math.PI*2}else{let a=0,l=Math.PI*2;if(Math.random()>.4){a=Math.random()*Math.PI*2;let h=Math.random()*1.5+.5;l=a+Math.PI*2-h}let c=this.createArcPoints(s,a,l,$e.ARC_SEGMENTS),u=this.createStrokeMesh(c,$e.STROKE_WIDTH,e);u.parent=t,u.rotation.z=Math.random()*Math.PI*2}}return t}createRingWithGap(e,t){let n=Math.random()*Math.PI*2,r=Math.random()*1.5+.5,s=n+Math.PI*2-r,o=this.createArcPoints(e,n,s,$e.ARC_SEGMENTS);return this.createStrokeMesh(o,$e.STROKE_WIDTH,t)}createConnectorGlyph(e){let t=new ln("glyphConnector",e);if(this.baseFullRingMesh&&$e.ENABLE_INSTANCING){let a=this.baseFullRingMesh.createInstance("connectorRingInstance");a.parent=t}else{let a=this.createArcPoints($e.CONNECTOR_BASE_RADIUS,0,Math.PI*2,$e.ARC_SEGMENTS),l=this.createStrokeMesh(a,$e.STROKE_WIDTH,e);l.parent=t}let n=$e.MIN_LINE_LENGTH+Math.random()*($e.MAX_LINE_LENGTH-$e.MIN_LINE_LENGTH),r=[new m($e.CONNECTOR_BASE_RADIUS,0,0),new m($e.CONNECTOR_BASE_RADIUS+n,0,0)],s=this.createStrokeMesh(r,$e.STROKE_WIDTH,e);s.parent=t;let o=this.createDot($e.CONNECTOR_DOT_SCALE,e);return o.position.x=$e.CONNECTOR_BASE_RADIUS+n,o.parent=t,t.rotation.z=Math.random()*Math.PI*2,t}generateSpaceHUD(e,t,n){let r=new ln("shieldRoot",n);for(let s=0;s<e;s++){let a=Math.random()>.3?this.createConcentricGlyph(n):this.createConnectorGlyph(n);a.parent=r;let l=Math.acos(2*Math.random()-1),c=Math.random()*2*Math.PI,u=t+Math.random()*$e.RADIUS_VARIATION,h=u*Math.sin(l)*Math.cos(c),d=u*Math.sin(l)*Math.sin(c),f=u*Math.cos(l);a.position=new m(h,d,f),a.lookAt(m.Zero()),a.rotation.x-=Math.PI/2;let p=$e.MIN_GLYPH_SCALE+Math.random()*($e.MAX_GLYPH_SCALE-$e.MIN_GLYPH_SCALE);a.scaling=new m(p,p,p)}return r}get shieldRootNode(){return this.shieldRoot}get isShieldAnimating(){return this.isAnimating}static \u0275fac=function(t){return new(t||i)};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})};var Zl=class{constructor(e,t,n){this.gradient=e,this.color1=t,this.color2=n}getColorToRef(e){if(!this.color2){e.copyFrom(this.color1);return}le.LerpToRef(this.color1,this.color2,Math.random(),e)}},Km=class{constructor(e,t){this.gradient=e,this.color=t}},Ql=class{constructor(e,t,n){this.gradient=e,this.factor1=t,this.factor2=n}getFactor(){return this.factor2===void 0||this.factor2===this.factor1?this.factor1:this.factor1+(this.factor2-this.factor1)*Math.random()}},sn=class{static GetCurrentGradient(e,t,n){if(t[0].gradient>e){n(t[0],t[0],1);return}for(let s=0;s<t.length-1;s++){let o=t[s],a=t[s+1];if(e>=o.gradient&&e<=a.gradient){let l=(e-o.gradient)/(a.gradient-o.gradient);n(o,a,l);return}}let r=t.length-1;n(t[r],t[r],1)}};var MM=(()=>{class i{constructor(t){this.particleSystem=t,this.position=m.Zero(),this.direction=m.Zero(),this.color=new le(0,0,0,0),this.colorStep=new le(0,0,0,0),this.initialColor=new le(0,0,0,0),this.colorDead=new le(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.scale=new _e(1,1),this.angle=0,this.angularSpeed=0,this.cellIndex=0,this._attachedSubEmitters=null,this._currentColor1=new le(0,0,0,0),this._currentColor2=new le(0,0,0,0),this._currentSize1=0,this._currentSize2=0,this._currentAngularSpeed1=0,this._currentAngularSpeed2=0,this._currentVelocity1=0,this._currentVelocity2=0,this._scaledDirection=m.Zero(),this._currentLimitVelocity1=0,this._currentLimitVelocity2=0,this._currentDrag1=0,this._currentDrag2=0,this.id=i._Count++,this.particleSystem.isAnimationSheetEnabled&&this._updateCellInfoFromSystem()}_updateCellInfoFromSystem(){this.cellIndex=this.particleSystem.startSpriteCellID}updateCellIndex(){let t=this.age,n=this.particleSystem.spriteCellChangeSpeed;this.particleSystem.spriteRandomStartCell&&(this._randomCellOffset===void 0&&(this._randomCellOffset=Math.random()*this.lifeTime),n===0?(n=1,t=this._randomCellOffset):t+=this._randomCellOffset);let r=this._initialEndSpriteCellId-this._initialStartSpriteCellId+1,s;this._initialSpriteCellLoop?s=Oi(t*n%this.lifeTime/this.lifeTime):s=Oi(t*n/this.lifeTime),this.cellIndex=this._initialStartSpriteCellId+s*r|0}_inheritParticleInfoToSubEmitter(t){if(t.particleSystem.emitter.position){let n=t.particleSystem.emitter;if(n.position.copyFrom(this.position),t.inheritDirection){let r=U.Vector3[0];this.direction.normalizeToRef(r),n.setDirection(r,0,Math.PI/2)}}else t.particleSystem.emitter.copyFrom(this.position);this.direction.scaleToRef(t.inheritedVelocityAmount/2,U.Vector3[0]),t.particleSystem._inheritedVelocityOffset.copyFrom(U.Vector3[0])}_inheritParticleInfoToSubEmitters(){if(this._attachedSubEmitters&&this._attachedSubEmitters.length>0)for(let t of this._attachedSubEmitters)this._inheritParticleInfoToSubEmitter(t)}_reset(){this.age=0,this.id=i._Count++,this._currentColorGradient=null,this._currentSizeGradient=null,this._currentAngularSpeedGradient=null,this._currentVelocityGradient=null,this._currentLimitVelocityGradient=null,this._currentDragGradient=null,this.cellIndex=this.particleSystem.startSpriteCellID,this._randomCellOffset=void 0}copyTo(t){t.position.copyFrom(this.position),this._initialDirection?t._initialDirection?t._initialDirection.copyFrom(this._initialDirection):t._initialDirection=this._initialDirection.clone():t._initialDirection=null,t.direction.copyFrom(this.direction),this._localPosition&&(t._localPosition?t._localPosition.copyFrom(this._localPosition):t._localPosition=this._localPosition.clone()),t.color.copyFrom(this.color),t.colorStep.copyFrom(this.colorStep),t.initialColor.copyFrom(this.initialColor),t.colorDead.copyFrom(this.colorDead),t.lifeTime=this.lifeTime,t.age=this.age,t._randomCellOffset=this._randomCellOffset,t.size=this.size,t.scale.copyFrom(this.scale),t.angle=this.angle,t.angularSpeed=this.angularSpeed,t.particleSystem=this.particleSystem,t.cellIndex=this.cellIndex,t.id=this.id,t._attachedSubEmitters=this._attachedSubEmitters,this._currentColorGradient&&(t._currentColorGradient=this._currentColorGradient,t._currentColor1.copyFrom(this._currentColor1),t._currentColor2.copyFrom(this._currentColor2)),this._currentSizeGradient&&(t._currentSizeGradient=this._currentSizeGradient,t._currentSize1=this._currentSize1,t._currentSize2=this._currentSize2),this._currentAngularSpeedGradient&&(t._currentAngularSpeedGradient=this._currentAngularSpeedGradient,t._currentAngularSpeed1=this._currentAngularSpeed1,t._currentAngularSpeed2=this._currentAngularSpeed2),this._currentVelocityGradient&&(t._currentVelocityGradient=this._currentVelocityGradient,t._currentVelocity1=this._currentVelocity1,t._currentVelocity2=this._currentVelocity2),this._currentLimitVelocityGradient&&(t._currentLimitVelocityGradient=this._currentLimitVelocityGradient,t._currentLimitVelocity1=this._currentLimitVelocity1,t._currentLimitVelocity2=this._currentLimitVelocity2),this._currentDragGradient&&(t._currentDragGradient=this._currentDragGradient,t._currentDrag1=this._currentDrag1,t._currentDrag2=this._currentDrag2),this.particleSystem.isAnimationSheetEnabled&&(t._initialStartSpriteCellId=this._initialStartSpriteCellId,t._initialEndSpriteCellId=this._initialEndSpriteCellId,t._initialSpriteCellLoop=this._initialSpriteCellLoop),this.particleSystem.useRampGradients&&(t.remapData&&this.remapData?t.remapData.copyFrom(this.remapData):t.remapData=new ht(0,0,0,0)),this._randomNoiseCoordinates1&&(t._randomNoiseCoordinates1?(t._randomNoiseCoordinates1.copyFrom(this._randomNoiseCoordinates1),t._randomNoiseCoordinates2.copyFrom(this._randomNoiseCoordinates2)):(t._randomNoiseCoordinates1=this._randomNoiseCoordinates1.clone(),t._randomNoiseCoordinates2=this._randomNoiseCoordinates2.clone()))}}return i._Count=0,i})();var hr=class i{constructor(){this.direction1=new m(0,1,0),this.direction2=new m(0,1,0),this.minEmitBox=new m(-.5,-.5,-.5),this.maxEmitBox=new m(.5,.5,.5)}startDirectionFunction(e,t,n,r){let s=Ee(this.direction1.x,this.direction2.x),o=Ee(this.direction1.y,this.direction2.y),a=Ee(this.direction1.z,this.direction2.z);if(r){t.x=s,t.y=o,t.z=a;return}m.TransformNormalFromFloatsToRef(s,o,a,e,t)}startPositionFunction(e,t,n,r){let s=Ee(this.minEmitBox.x,this.maxEmitBox.x),o=Ee(this.minEmitBox.y,this.maxEmitBox.y),a=Ee(this.minEmitBox.z,this.maxEmitBox.z);if(r){t.x=s,t.y=o,t.z=a;return}m.TransformCoordinatesFromFloatsToRef(s,o,a,e,t)}clone(){let e=new i;return xt.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2),e.setVector3("minEmitBox",this.minEmitBox),e.setVector3("maxEmitBox",this.maxEmitBox)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3),e.addUniform("minEmitBox",3),e.addUniform("maxEmitBox",3)}getEffectDefines(){return"#define BOXEMITTER"}getClassName(){return"BoxParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.minEmitBox=this.minEmitBox.asArray(),e.maxEmitBox=this.maxEmitBox.asArray(),e}parse(e){m.FromArrayToRef(e.direction1,0,this.direction1),m.FromArrayToRef(e.direction2,0,this.direction2),m.FromArrayToRef(e.minEmitBox,0,this.minEmitBox),m.FromArrayToRef(e.maxEmitBox,0,this.maxEmitBox)}};function PC(i,e){let t=Ee(0,1);le.LerpToRef(e.color1,e.color2,t,i.color)}function DM(i,e){e.colorDead.subtractToRef(i.color,e._colorDiff),e._colorDiff.scaleToRef(1/i.lifeTime,i.colorStep)}function RM(i,e){i._currentColorGradient=e._colorGradients[0],i._currentColorGradient.getColorToRef(i.color),i._currentColor1.copyFrom(i.color),e._colorGradients.length>1?e._colorGradients[1].getColorToRef(i._currentColor2):i._currentColor2.copyFrom(i.color)}function PM(i,e){let t=e._colorGradients;sn.GetCurrentGradient(e._ratio,t,(n,r,s)=>{n!==i._currentColorGradient&&(i._currentColor1.copyFrom(i._currentColor2),r.getColorToRef(i._currentColor2),i._currentColorGradient=n),le.LerpToRef(i._currentColor1,i._currentColor2,s,i.color),i.color.a<0&&(i.color.a=0)})}function OC(i,e){i.colorStep.scaleToRef(e._scaledUpdateSpeed,e._scaledColorStep),i.color.addInPlace(e._scaledColorStep),i.color.a<0&&(i.color.a=0)}function OM(i,e){sn.GetCurrentGradient(e._ratio,e._angularSpeedGradients,(t,n,r)=>{t!==i._currentAngularSpeedGradient&&(i._currentAngularSpeed1=i._currentAngularSpeed2,i._currentAngularSpeed2=n.getFactor(),i._currentAngularSpeedGradient=t),i.angularSpeed=Kt(i._currentAngularSpeed1,i._currentAngularSpeed2,r)})}function NM(i,e){i.angle+=i.angularSpeed*e._scaledUpdateSpeed}function NC(i,e){e.particleEmitterType.startDirectionFunction(e._emitterWorldMatrix,i.direction,i,e.isLocal,e._emitterInverseWorldMatrix)}function LM(i,e){e.startDirectionFunction(e._emitterWorldMatrix,i.direction,i,e.isLocal)}function FM(i,e){i._currentVelocityGradient=e._velocityGradients[0],i._currentVelocity1=i._currentVelocityGradient.getFactor(),e._velocityGradients.length>1?i._currentVelocity2=e._velocityGradients[1].getFactor():i._currentVelocity2=i._currentVelocity1}function kM(i,e){i._currentLimitVelocityGradient=e._limitVelocityGradients[0],i._currentLimitVelocity1=i._currentLimitVelocityGradient.getFactor(),e._limitVelocityGradients.length>1?i._currentLimitVelocity2=e._limitVelocityGradients[1].getFactor():i._currentLimitVelocity2=i._currentLimitVelocity1}function BM(i,e){sn.GetCurrentGradient(e._ratio,e._velocityGradients,(t,n,r)=>{t!==i._currentVelocityGradient&&(i._currentVelocity1=i._currentVelocity2,i._currentVelocity2=n.getFactor(),i._currentVelocityGradient=t),i._directionScale*=Kt(i._currentVelocity1,i._currentVelocity2,r)})}function VM(i,e){sn.GetCurrentGradient(e._ratio,e._limitVelocityGradients,(t,n,r)=>{t!==i._currentLimitVelocityGradient&&(i._currentLimitVelocity1=i._currentLimitVelocity2,i._currentLimitVelocity2=n.getFactor(),i._currentLimitVelocityGradient=t);let s=Kt(i._currentLimitVelocity1,i._currentLimitVelocity2,r);i.direction.length()>s&&i.direction.scaleInPlace(e.limitVelocityDamping)})}function GM(i){i.direction.scaleToRef(i._directionScale,i._scaledDirection)}function LC(i,e){e.particleEmitterType.startPositionFunction(e._emitterWorldMatrix,i.position,i,e.isLocal)}function UM(i,e){e.startPositionFunction(e._emitterWorldMatrix,i.position,i,e.isLocal)}function zM(i,e){i._localPosition?i._localPosition.copyFrom(i.position):i._localPosition=i.position.clone(),m.TransformCoordinatesToRef(i._localPosition,e._emitterWorldMatrix,i.position)}function HM(i,e){e.isLocal&&i._localPosition?(i._localPosition.addInPlace(i._scaledDirection),m.TransformCoordinatesToRef(i._localPosition,e._emitterWorldMatrix,i.position)):i.position.addInPlace(i._scaledDirection)}function $M(i,e){i._currentDragGradient=e._dragGradients[0],i._currentDrag1=i._currentDragGradient.getFactor(),e._dragGradients.length>1?i._currentDrag2=e._dragGradients[1].getFactor():i._currentDrag2=i._currentDrag1}function WM(i,e){sn.GetCurrentGradient(e._ratio,e._dragGradients,(t,n,r)=>{t!==i._currentDragGradient&&(i._currentDrag1=i._currentDrag2,i._currentDrag2=n.getFactor(),i._currentDragGradient=t);let s=Kt(i._currentDrag1,i._currentDrag2,r);i._scaledDirection.scaleInPlace(1-s)})}function jM(i,e){i._randomNoiseCoordinates1?(i._randomNoiseCoordinates1.copyFromFloats(Math.random(),Math.random(),Math.random()),i._randomNoiseCoordinates2.copyFromFloats(Math.random(),Math.random(),Math.random())):(i._randomNoiseCoordinates1=new m(Math.random(),Math.random(),Math.random()),i._randomNoiseCoordinates2=new m(Math.random(),Math.random(),Math.random()))}function qM(i,e){let t=e._noiseTextureData,n=e._noiseTextureSize;if(t&&n&&i._randomNoiseCoordinates1){let r=e._fetchR(i._randomNoiseCoordinates1.x,i._randomNoiseCoordinates1.y,n.width,n.height,t),s=e._fetchR(i._randomNoiseCoordinates1.z,i._randomNoiseCoordinates2.x,n.width,n.height,t),o=e._fetchR(i._randomNoiseCoordinates2.y,i._randomNoiseCoordinates2.z,n.width,n.height,t),a=U.Vector3[0],l=U.Vector3[1];a.copyFromFloats((2*r-1)*e.noiseStrength.x,(2*s-1)*e.noiseStrength.y,(2*o-1)*e.noiseStrength.z),a.scaleToRef(e._tempScaledUpdateSpeed,l),i.direction.addInPlace(l)}}function YM(i,e){e.gravity.scaleToRef(e._tempScaledUpdateSpeed,e._scaledGravity),i.direction.addInPlace(e._scaledGravity)}function FC(i,e){i.size=Ee(e.minSize,e.maxSize),i.scale.copyFromFloats(Ee(e.minScaleX,e.maxScaleX),Ee(e.minScaleY,e.maxScaleY))}function KM(i,e){i._currentSizeGradient=e._sizeGradients[0],i._currentSize1=i._currentSizeGradient.getFactor(),i.size=i._currentSize1,e._sizeGradients.length>1?i._currentSize2=e._sizeGradients[1].getFactor():i._currentSize2=i._currentSize1,i.scale.copyFromFloats(Ee(e.minScaleX,e.maxScaleX),Ee(e.minScaleY,e.maxScaleY))}function XM(i,e){let t=e._actualFrame/e.targetStopDuration;sn.GetCurrentGradient(t,e._startSizeGradients,(n,r,s)=>{n!==e._currentStartSizeGradient&&(e._currentStartSize1=e._currentStartSize2,e._currentStartSize2=r.getFactor(),e._currentStartSizeGradient=n);let o=Kt(e._currentStartSize1,e._currentStartSize2,s);i.scale.scaleInPlace(o)})}function ZM(i,e){sn.GetCurrentGradient(e._ratio,e._sizeGradients,(t,n,r)=>{t!==i._currentSizeGradient&&(i._currentSize1=i._currentSize2,i._currentSize2=n.getFactor(),i._currentSizeGradient=t),i.size=Kt(i._currentSize1,i._currentSize2,r)})}function QM(i,e){i.remapData=new ht(0,1,0,1)}function JM(i,e){e._colorRemapGradients&&e._colorRemapGradients.length>0&&sn.GetCurrentGradient(e._ratio,e._colorRemapGradients,(t,n,r)=>{let s=Kt(t.factor1,n.factor1,r),o=Kt(t.factor2,n.factor2,r);i.remapData.x=s,i.remapData.y=o-s}),e._alphaRemapGradients&&e._alphaRemapGradients.length>0&&sn.GetCurrentGradient(e._ratio,e._alphaRemapGradients,(t,n,r)=>{let s=Kt(t.factor1,n.factor1,r),o=Kt(t.factor2,n.factor2,r);i.remapData.z=s,i.remapData.w=o-s})}function eD(i,e){let t=Oi(e._actualFrame/e.targetStopDuration);sn.GetCurrentGradient(t,e._lifeTimeGradients,(n,r)=>{let s=n,o=r,a=s.getFactor(),l=o.getFactor(),c=(t-s.gradient)/(o.gradient-s.gradient);i.lifeTime=Kt(a,l,c)}),e._emitPower=Ee(e.minEmitPower,e.maxEmitPower)}function kC(i,e){i.lifeTime=Ee(e.minLifeTime,e.maxLifeTime),e._emitPower=Ee(e.minEmitPower,e.maxEmitPower)}function tD(i,e){e._emitPower===0?(i._initialDirection?i._initialDirection.copyFrom(i.direction):i._initialDirection=i.direction.clone(),i.direction.set(0,0,0)):(i._initialDirection=null,i.direction.scaleInPlace(e._emitPower)),i.direction.addInPlace(e._inheritedVelocityOffset)}function BC(i,e){i.angularSpeed=Ee(e.minAngularSpeed,e.maxAngularSpeed),i.angle=Ee(e.minInitialRotation,e.maxInitialRotation)}function nD(i,e){i._currentAngularSpeedGradient=e._angularSpeedGradients[0],i.angularSpeed=i._currentAngularSpeedGradient.getFactor(),i._currentAngularSpeed1=i.angularSpeed,e._angularSpeedGradients.length>1?i._currentAngularSpeed2=e._angularSpeedGradients[1].getFactor():i._currentAngularSpeed2=i._currentAngularSpeed1,i.angle=Ee(e.minInitialRotation,e.maxInitialRotation)}function iD(i,e){i._initialStartSpriteCellId=e.startSpriteCellID,i._initialEndSpriteCellId=e.endSpriteCellID,i._initialSpriteCellLoop=e.spriteCellLoop}function Jl(i,e){i.previousItem=e.previousItem,i.nextItem=e,e.previousItem&&(e.previousItem.nextItem=i),e.previousItem=i}function Mt(i,e){i.previousItem=e,i.nextItem=e.nextItem,e.nextItem&&(e.nextItem.previousItem=i),e.nextItem=i}function on(i){i.previousItem&&(i.previousItem.nextItem=i.nextItem),i.nextItem&&(i.nextItem.previousItem=i.previousItem)}var rD=(()=>{class i extends Yn{get startDirectionFunction(){return this._startDirectionFunction}set startDirectionFunction(t){this._startDirectionFunction!==t&&(this._startDirectionFunction=t,t?this._directionProcessing.process=LM:this._directionProcessing.process=NC)}get startPositionFunction(){return this._startPositionFunction}set startPositionFunction(t){this._startPositionFunction!==t&&(this._startPositionFunction=t,t?this._positionCreation.process=UM:this._positionCreation.process=LC)}set onDispose(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)}get isDisposed(){return this._isDisposed}get useRampGradients(){return this._useRampGradients}set useRampGradients(t){this._useRampGradients!==t&&(this._useRampGradients=t,this._resetEffect(),t?(this._rampCreation={process:QM,previousItem:null,nextItem:null},Mt(this._rampCreation,this._colorDeadCreation),this._remapGradientProcessing={process:JM,previousItem:null,nextItem:null},Mt(this._remapGradientProcessing,this._gravityProcessing)):(on(this._rampCreation),on(this._remapGradientProcessing)))}get isLocal(){return this._isLocal}set isLocal(t){this._isLocal!==t&&(this._isLocal=t,t?(this._isLocalCreation={process:zM,previousItem:null,nextItem:null},Mt(this._isLocalCreation,this._positionCreation)):on(this._isLocalCreation))}get particles(){return this._particles}get shaderLanguage(){return this._shaderLanguage}get _isAnimationSheetEnabled(){return this._animationSheetEnabled}set _isAnimationSheetEnabled(t){this._animationSheetEnabled!==t&&(this._animationSheetEnabled=t,t?(this._sheetCreation={process:iD,previousItem:null,nextItem:null},Mt(this._sheetCreation,this._colorDeadCreation)):on(this._sheetCreation),this._reset())}getActiveCount(){return this._particles.length}getClassName(){return"ParticleSystem"}isStopping(){return this._stopped&&this.isAlive()}getCustomEffect(t=0){return this._customWrappers[t]?.effect??this._customWrappers[0].effect}_getCustomDrawWrapper(t=0){return this._customWrappers[t]??this._customWrappers[0]}setCustomEffect(t,n=0){this._customWrappers[n]=new mi(this._engine),this._customWrappers[n].effect=t,this._customWrappers[n].drawContext&&(this._customWrappers[n].drawContext.useInstancing=this._useInstancing)}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new B),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"particles"}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get noiseTexture(){return this._noiseTexture}set noiseTexture(t){if(this.noiseTexture!==t){if(this._noiseTexture=t,!t){on(this._noiseCreation),on(this._noiseProcessing);return}this._noiseCreation={process:jM,previousItem:null,nextItem:null},Mt(this._noiseCreation,this._colorDeadCreation),this._noiseProcessing={process:qM,previousItem:null,nextItem:null},Mt(this._noiseProcessing,this._positionProcessing)}}constructor(t,n,r,s=null,o=!1,a=.01,l=!1){super(t),this._emitterInverseWorldMatrix=V.Identity(),this._startDirectionFunction=null,this._startPositionFunction=null,this._inheritedVelocityOffset=new m,this.onDisposeObservable=new B,this.onStoppedObservable=new B,this.onStartedObservable=new B,this._noiseTextureSize=null,this._noiseTextureData=null,this._particles=new Array,this._stockParticles=new Array,this._newPartsExcess=0,this._vertexBuffers={},this._scaledColorStep=new le(0,0,0,0),this._colorDiff=new le(0,0,0,0),this._scaledGravity=m.Zero(),this._currentRenderId=-1,this._useInstancing=!1,this._isDisposed=!1,this._started=!1,this._stopped=!1,this._actualFrame=0,this._currentEmitRate1=0,this._currentEmitRate2=0,this._currentStartSize1=0,this._currentStartSize2=0,this.updateInAnimate=!0,this._rawTextureWidth=256,this._useRampGradients=!1,this._updateQueueStart=null,this._startSizeCreation=null,this._createQueueStart=null,this._isLocal=!1,this.isGPU=!1,this._shaderLanguage=0,this._onBeforeDrawParticlesObservable=null,this._emitFromParticle=c=>{},this.recycleParticle=c=>{let u=this._particles.pop();u!==c&&u.copyTo(c),this._stockParticles.push(u)},this._createParticle=()=>{let c;return this._stockParticles.length!==0?(c=this._stockParticles.pop(),c._reset()):c=new MM(this),this._prepareParticle(c),c},this.paused=!1,this._shadersLoaded=!1,this._capacity=n,this._epsilon=a,!r||r.getClassName()==="Scene"?(this._scene=r||Ie.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)):(this._engine=r,this.defaultProjectionMatrix=V.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)),this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._initShaderSourceAsync(),this._lifeTimeCreation={process:kC,previousItem:null,nextItem:null},this._positionCreation={process:LC,previousItem:null,nextItem:null},Mt(this._positionCreation,this._lifeTimeCreation),this._directionCreation={process:NC,previousItem:null,nextItem:null},Mt(this._directionCreation,this._positionCreation),this._emitPowerCreation={process:tD,previousItem:null,nextItem:null},Mt(this._emitPowerCreation,this._directionCreation),this._sizeCreation={process:FC,previousItem:null,nextItem:null},Mt(this._sizeCreation,this._emitPowerCreation),this._angleCreation={process:BC,previousItem:null,nextItem:null},Mt(this._angleCreation,this._sizeCreation),this._colorCreation={process:PC,previousItem:null,nextItem:null},Mt(this._colorCreation,this._angleCreation),this._colorDeadCreation={process:DM,previousItem:null,nextItem:null},Mt(this._colorDeadCreation,this._colorCreation),this._createQueueStart=this._lifeTimeCreation,l||(this._colorProcessing={process:OC,previousItem:null,nextItem:null},this._angularSpeedProcessing={process:NM,previousItem:null,nextItem:null},Mt(this._angularSpeedProcessing,this._colorProcessing),this._directionProcessing={process:GM,previousItem:null,nextItem:null},Mt(this._directionProcessing,this._angularSpeedProcessing),this._positionProcessing={process:HM,previousItem:null,nextItem:null},Mt(this._positionProcessing,this._directionProcessing),this._gravityProcessing={process:YM,previousItem:null,nextItem:null},Mt(this._gravityProcessing,this._positionProcessing),this._updateQueueStart=this._colorProcessing),this._isAnimationSheetEnabled=o,this._attachImageProcessingConfiguration(null),this._customWrappers={0:new mi(this._engine)},this._customWrappers[0].effect=s,this._drawWrappers=[],this._useInstancing=this._engine.getCaps().instancedArrays,this._createIndexBuffer(),this._createVertexBuffers(),this.particleEmitterType=new hr,this.updateFunction=c=>{this.noiseTexture&&(this._noiseTextureSize=this.noiseTexture.getSize(),this.noiseTexture.getContent()?.then(h=>{this._noiseTextureData=h}));let u=c===this._particles;for(let h=0;h<c.length;h++){let d=c[h];this._tempScaledUpdateSpeed=this._scaledUpdateSpeed;let f=d.age;if(d.age+=this._tempScaledUpdateSpeed,d.age>d.lifeTime){let g=d.age-f,_=d.lifeTime-f;this._tempScaledUpdateSpeed=_*this._tempScaledUpdateSpeed/g,d.age=d.lifeTime}this._ratio=d.age/d.lifeTime,d._directionScale=this._tempScaledUpdateSpeed;let p=this._updateQueueStart;for(;p;)p.process(d,this),p=p.nextItem;if(this._isAnimationSheetEnabled&&!l&&d.updateCellIndex(),d._inheritParticleInfoToSubEmitters(),d.age>=d.lifeTime){if(this._emitFromParticle(d),d._attachedSubEmitters){for(let g of d._attachedSubEmitters)g.particleSystem.disposeOnStop=!0,g.particleSystem.stop();d._attachedSubEmitters=null}this.recycleParticle(d),u&&h--;continue}}}}serialize(t){throw new Error("Method not implemented.")}clone(t,n,r=!1){throw new Error("Method not implemented.")}_addFactorGradient(t,n,r,s){let o=new Ql(n,r,s);t.push(o),t.sort((a,l)=>a.gradient<l.gradient?-1:a.gradient>l.gradient?1:0)}_removeFactorGradient(t,n){if(!t)return;let r=0;for(let s of t){if(s.gradient===n){t.splice(r,1);break}r++}}_syncLifeTimeCreation(){if(this.targetStopDuration&&this._lifeTimeGradients&&this._lifeTimeGradients.length>0){this._lifeTimeCreation.process=eD;return}this._lifeTimeCreation.process=kC}_syncStartSizeCreation(){if(this._startSizeGradients&&this._startSizeGradients[0]&&this.targetStopDuration){this._startSizeCreation||(this._startSizeCreation={process:XM,previousItem:null,nextItem:null},Mt(this._startSizeCreation,this._sizeCreation));return}this._startSizeCreation&&(on(this._startSizeCreation),this._startSizeCreation=null)}get targetStopDuration(){return this._targetStopDuration}set targetStopDuration(t){this.targetStopDuration!==t&&(this._targetStopDuration=t,this._syncLifeTimeCreation(),this._syncStartSizeCreation())}addLifeTimeGradient(t,n,r){return this._lifeTimeGradients||(this._lifeTimeGradients=[]),this._addFactorGradient(this._lifeTimeGradients,t,n,r),this._syncLifeTimeCreation(),this}removeLifeTimeGradient(t){return this._removeFactorGradient(this._lifeTimeGradients,t),this._syncLifeTimeCreation(),this}addSizeGradient(t,n,r){return this._sizeGradients||(this._sizeGradients=[]),this._sizeGradients.length===0&&(this._sizeCreation.process=KM,this._sizeGradientProcessing={process:ZM,previousItem:null,nextItem:null},Jl(this._sizeGradientProcessing,this._gravityProcessing)),this._addFactorGradient(this._sizeGradients,t,n,r),this}removeSizeGradient(t){return this._removeFactorGradient(this._sizeGradients,t),this._sizeGradients?.length===0&&(on(this._sizeGradientProcessing),this._sizeCreation.process=FC),this}addColorRemapGradient(t,n,r){return this._colorRemapGradients||(this._colorRemapGradients=[]),this._addFactorGradient(this._colorRemapGradients,t,n,r),this}removeColorRemapGradient(t){return this._removeFactorGradient(this._colorRemapGradients,t),this}addAlphaRemapGradient(t,n,r){return this._alphaRemapGradients||(this._alphaRemapGradients=[]),this._addFactorGradient(this._alphaRemapGradients,t,n,r),this}removeAlphaRemapGradient(t){return this._removeFactorGradient(this._alphaRemapGradients,t),this}addAngularSpeedGradient(t,n,r){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._angularSpeedGradients.length===0&&(this._angleCreation.process=nD,this._angularSpeedGradientProcessing={process:OM,previousItem:null,nextItem:null},Jl(this._angularSpeedGradientProcessing,this._angularSpeedProcessing)),this._addFactorGradient(this._angularSpeedGradients,t,n,r),this}removeAngularSpeedGradient(t){return this._removeFactorGradient(this._angularSpeedGradients,t),this._angularSpeedGradients?.length===0&&(this._angleCreation.process=BC,on(this._angularSpeedGradientProcessing)),this}addVelocityGradient(t,n,r){return this._velocityGradients||(this._velocityGradients=[]),this._velocityGradients.length===0&&(this._velocityCreation={process:FM,previousItem:null,nextItem:null},Mt(this._velocityCreation,this._angleCreation),this._velocityGradientProcessing={process:BM,previousItem:null,nextItem:null},Jl(this._velocityGradientProcessing,this._directionProcessing)),this._addFactorGradient(this._velocityGradients,t,n,r),this}removeVelocityGradient(t){return this._removeFactorGradient(this._velocityGradients,t),this._velocityGradients?.length===0&&(on(this._velocityCreation),on(this._velocityGradientProcessing)),this}addLimitVelocityGradient(t,n,r){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._limitVelocityGradients.length===0&&(this._limitVelocityCreation={process:kM,previousItem:null,nextItem:null},Mt(this._limitVelocityCreation,this._angleCreation),this._limitVelocityGradientProcessing={process:VM,previousItem:null,nextItem:null},Mt(this._limitVelocityGradientProcessing,this._directionProcessing)),this._addFactorGradient(this._limitVelocityGradients,t,n,r),this}removeLimitVelocityGradient(t){return this._removeFactorGradient(this._limitVelocityGradients,t),this._limitVelocityGradients?.length===0&&(on(this._limitVelocityCreation),on(this._limitVelocityGradientProcessing)),this}addDragGradient(t,n,r){return this._dragGradients||(this._dragGradients=[]),this._dragGradients.length===0&&(this._dragCreation={process:$M,previousItem:null,nextItem:null},Jl(this._dragCreation,this._colorDeadCreation),this._dragGradientProcessing={process:WM,previousItem:null,nextItem:null},Jl(this._dragGradientProcessing,this._positionProcessing)),this._addFactorGradient(this._dragGradients,t,n,r),this}removeDragGradient(t){return this._removeFactorGradient(this._dragGradients,t),this._dragGradients?.length===0&&(on(this._dragCreation),on(this._dragGradientProcessing)),this}addEmitRateGradient(t,n,r){return this._emitRateGradients||(this._emitRateGradients=[]),this._addFactorGradient(this._emitRateGradients,t,n,r),this}removeEmitRateGradient(t){return this._removeFactorGradient(this._emitRateGradients,t),this}addStartSizeGradient(t,n,r){return this._startSizeGradients||(this._startSizeGradients=[]),this._addFactorGradient(this._startSizeGradients,t,n,r),this._syncStartSizeCreation(),this}removeStartSizeGradient(t){return this._removeFactorGradient(this._startSizeGradients,t),this._syncStartSizeCreation(),this}_createRampGradientTexture(){if(!this._rampGradients||!this._rampGradients.length||this._rampGradientsTexture||!this._scene)return;let t=new Uint8Array(this._rawTextureWidth*4),n=it.Color3[0];for(let r=0;r<this._rawTextureWidth;r++){let s=r/this._rawTextureWidth;sn.GetCurrentGradient(s,this._rampGradients,(o,a,l)=>{G.LerpToRef(o.color,a.color,l,n),t[r*4]=n.r*255,t[r*4+1]=n.g*255,t[r*4+2]=n.b*255,t[r*4+3]=255})}this._rampGradientsTexture=jn.CreateRGBATexture(t,this._rawTextureWidth,1,this._scene,!1,!1,1)}getRampGradients(){return this._rampGradients}forceRefreshGradients(){this._syncRampGradientTexture()}_syncRampGradientTexture(){this._rampGradients&&(this._rampGradients.sort((t,n)=>t.gradient<n.gradient?-1:t.gradient>n.gradient?1:0),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._createRampGradientTexture())}addRampGradient(t,n){this._rampGradients||(this._rampGradients=[]);let r=new Km(t,n);return this._rampGradients.push(r),this._syncRampGradientTexture(),this}removeRampGradient(t){return this._removeGradientAndTexture(t,this._rampGradients,this._rampGradientsTexture),this._rampGradientsTexture=null,this._rampGradients&&this._rampGradients.length>0&&this._createRampGradientTexture(),this}addColorGradient(t,n,r){this._colorGradients||(this._colorGradients=[]),this._colorGradients.length===0&&(this._colorCreation.process=RM,this._colorProcessing.process=PM);let s=new Zl(t,n,r);return this._colorGradients.push(s),this._colorGradients.sort((o,a)=>o.gradient<a.gradient?-1:o.gradient>a.gradient?1:0),this}removeColorGradient(t){if(!this._colorGradients)return this;let n=0;for(let r of this._colorGradients){if(r.gradient===t){this._colorGradients.splice(n,1);break}n++}return this._colorGradients.length===0&&(this._colorCreation.process=PC,this._colorProcessing.process=OC),this}resetDrawCache(){if(this._drawWrappers){for(let t of this._drawWrappers)if(t)for(let n of t)n?.dispose();this._drawWrappers=[]}}_fetchR(t,n,r,s,o){t=Math.abs(t)*.5+.5,n=Math.abs(n)*.5+.5;let a=t*r%r|0,l=n*s%s|0,c=(a+l*r)*4;return o[c]/255}_reset(){this._resetEffect()}_resetEffect(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this._createVertexBuffers()}_createVertexBuffers(){this._vertexBufferSize=this._useInstancing?10:12,this._isAnimationSheetEnabled&&(this._vertexBufferSize+=1),(!this._isBillboardBased||this.billboardMode===8||this.billboardMode===9)&&(this._vertexBufferSize+=3),this._useRampGradients&&(this._vertexBufferSize+=4);let t=this._engine,n=this._vertexBufferSize*(this._useInstancing?1:4);this._vertexData=new Float32Array(this._capacity*n),this._vertexBuffer=new Cn(t,this._vertexData,!0,n);let r=0,s=this._vertexBuffer.createVertexBuffer(S.PositionKind,r,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[S.PositionKind]=s,r+=3;let o=this._vertexBuffer.createVertexBuffer(S.ColorKind,r,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[S.ColorKind]=o,r+=4;let a=this._vertexBuffer.createVertexBuffer("angle",r,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.angle=a,r+=1;let l=this._vertexBuffer.createVertexBuffer("size",r,2,this._vertexBufferSize,this._useInstancing);if(this._vertexBuffers.size=l,r+=2,this._isAnimationSheetEnabled){let u=this._vertexBuffer.createVertexBuffer("cellIndex",r,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.cellIndex=u,r+=1}if(!this._isBillboardBased||this.billboardMode===8||this.billboardMode===9){let u=this._vertexBuffer.createVertexBuffer("direction",r,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.direction=u,r+=3}if(this._useRampGradients){let u=this._vertexBuffer.createVertexBuffer("remapData",r,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.remapData=u,r+=4}let c;if(this._useInstancing){let u=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new Cn(t,u,!1,2),c=this._spriteBuffer.createVertexBuffer("offset",0,2)}else c=this._vertexBuffer.createVertexBuffer("offset",r,2,this._vertexBufferSize,this._useInstancing),r+=2;this._vertexBuffers.offset=c,this.resetDrawCache()}_createIndexBuffer(){if(this._useInstancing){this._linesIndexBufferUseInstancing=this._engine.createIndexBuffer(new Uint32Array([0,1,1,3,3,2,2,0,0,3]));return}let t=[],n=[],r=0;for(let s=0;s<this._capacity;s++)t.push(r),t.push(r+1),t.push(r+2),t.push(r),t.push(r+2),t.push(r+3),n.push(r,r+1,r+1,r+2,r+2,r+3,r+3,r,r,r+3),r+=4;this._indexBuffer=this._engine.createIndexBuffer(t),this._linesIndexBuffer=this._engine.createIndexBuffer(n)}getCapacity(){return this._capacity}isAlive(){return this._alive}isStarted(){return this._started}_preStart(){}start(t=this.startDelay){if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(t){this.startDelay=t,setTimeout(()=>{this.start(0)},t);return}if(this._started=!0,this._stopped=!1,this._actualFrame=0,this._preStart(),this._emitRateGradients&&(this._emitRateGradients.length>0&&(this._currentEmitRateGradient=this._emitRateGradients[0],this._currentEmitRate1=this._currentEmitRateGradient.getFactor(),this._currentEmitRate2=this._currentEmitRate1),this._emitRateGradients.length>1&&(this._currentEmitRate2=this._emitRateGradients[1].getFactor())),this._startSizeGradients&&(this._startSizeGradients.length>0&&(this._currentStartSizeGradient=this._startSizeGradients[0],this._currentStartSize1=this._currentStartSizeGradient.getFactor(),this._currentStartSize2=this._currentStartSize1),this._startSizeGradients.length>1&&(this._currentStartSize2=this._startSizeGradients[1].getFactor())),this.preWarmCycles){this.emitter?.getClassName().indexOf("Mesh")!==-1&&this.emitter.computeWorldMatrix(!0);let n=this.noiseTexture;if(n&&n.onGeneratedObservable)n.onGeneratedObservable.addOnce(()=>{setTimeout(()=>{for(let r=0;r<this.preWarmCycles;r++)this.animate(!0),n.render()})});else for(let r=0;r<this.preWarmCycles;r++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop),this.onStartedObservable.notifyObservers(this)}stop(t=!0){this._stopped||(this.onStoppedObservable.notifyObservers(this),this._stopped=!0,this._postStop(t))}_postStop(t){}reset(){this._stockParticles.length=0,this._particles.length=0}_appendParticleVertex(t,n,r,s){let o=t*this._vertexBufferSize,a=U.Vector3[0].copyFrom(this._scene?.floatingOriginOffset||m.ZeroReadOnly);if(this._vertexData[o++]=n.position.x+this.worldOffset.x-a.x,this._vertexData[o++]=n.position.y+this.worldOffset.y-a.y,this._vertexData[o++]=n.position.z+this.worldOffset.z-a.z,this._vertexData[o++]=n.color.r,this._vertexData[o++]=n.color.g,this._vertexData[o++]=n.color.b,this._vertexData[o++]=n.color.a,this._vertexData[o++]=n.angle,this._vertexData[o++]=n.scale.x*n.size,this._vertexData[o++]=n.scale.y*n.size,this._isAnimationSheetEnabled&&(this._vertexData[o++]=n.cellIndex),this._isBillboardBased)(this.billboardMode===8||this.billboardMode===9)&&(this._vertexData[o++]=n.direction.x,this._vertexData[o++]=n.direction.y,this._vertexData[o++]=n.direction.z);else if(n._initialDirection){let l=n._initialDirection;this.isLocal&&(m.TransformNormalToRef(l,this._emitterWorldMatrix,U.Vector3[0]),l=U.Vector3[0]),l.x===0&&l.z===0&&(l.x=.001),this._vertexData[o++]=l.x,this._vertexData[o++]=l.y,this._vertexData[o++]=l.z}else{let l=n.direction;this.isLocal&&(m.TransformNormalToRef(l,this._emitterWorldMatrix,U.Vector3[0]),l=U.Vector3[0]),l.x===0&&l.z===0&&(l.x=.001),this._vertexData[o++]=l.x,this._vertexData[o++]=l.y,this._vertexData[o++]=l.z}this._useRampGradients&&n.remapData&&(this._vertexData[o++]=n.remapData.x,this._vertexData[o++]=n.remapData.y,this._vertexData[o++]=n.remapData.z,this._vertexData[o++]=n.remapData.w),this._useInstancing||(this._isAnimationSheetEnabled&&(r===0?r=this._epsilon:r===1&&(r=1-this._epsilon),s===0?s=this._epsilon:s===1&&(s=1-this._epsilon)),this._vertexData[o++]=r,this._vertexData[o++]=s)}_prepareParticle(t){}_createNewOnes(t){let n;for(let r=0;r<t&&this._particles.length!==this._capacity;r++){n=this._createParticle(),this._particles.push(n);let s=this._createQueueStart;for(;s;)s.process(n,this),s=s.nextItem;n._inheritParticleInfoToSubEmitters()}}_update(t){if(this._alive=this._particles.length>0,this.emitter.position){let n=this.emitter;this._emitterWorldMatrix=n.getWorldMatrix()}else{let n=this.emitter;this._emitterWorldMatrix=V.Translation(n.x,n.y,n.z)}this._emitterWorldMatrix.invertToRef(this._emitterInverseWorldMatrix),this.updateFunction(this._particles),this._createNewOnes(t)}static _GetAttributeNamesOrOptions(t=!1,n=!1,r=!1){let s=[S.PositionKind,S.ColorKind,"angle","offset","size"];return t&&s.push("cellIndex"),n||s.push("direction"),r&&s.push("remapData"),s}static _GetEffectCreationOptions(t=!1,n=!1,r=!1){let s=["invView","view","projection","textureMask","translationPivot","eyePosition"];return Zn(s),t&&s.push("particlesInfos"),n&&s.push("logarithmicDepthConstant"),r&&(s.push("vFogInfos"),s.push("vFogColor")),s}fillDefines(t,n,r=!0){if(this._scene&&(xs(this,this._scene,t),this.applyFog&&this._scene.fogEnabled&&this._scene.fogMode!==0&&t.push("#define FOG")),this._isAnimationSheetEnabled&&t.push("#define ANIMATESHEET"),this.useLogarithmicDepth&&t.push("#define LOGARITHMICDEPTH"),n===Yn.BLENDMODE_MULTIPLY&&t.push("#define BLENDMULTIPLYMODE"),this._useRampGradients&&t.push("#define RAMPGRADIENT"),this._isBillboardBased)switch(t.push("#define BILLBOARD"),this.billboardMode){case 2:t.push("#define BILLBOARDY");break;case 8:case 9:t.push("#define BILLBOARDSTRETCHED"),this.billboardMode===9&&t.push("#define BILLBOARDSTRETCHED_LOCAL");break;case 7:t.push("#define BILLBOARDMODE_ALL");break;default:break}r&&this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),t.push(this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(t,n,r){n.push(...i._GetAttributeNamesOrOptions(this._isAnimationSheetEnabled,this._isBillboardBased&&this.billboardMode!==8&&this.billboardMode!==9,this._useRampGradients)),t.push(...i._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth,this.applyFog)),r.push("diffuseSampler","rampSampler"),this._imageProcessingConfiguration&&(vT(t,this._imageProcessingConfigurationDefines),bT(r,this._imageProcessingConfigurationDefines))}_getWrapper(t){let n=this._getCustomDrawWrapper(t);if(n?.effect)return n;let r=[];this.fillDefines(r,t);let s=this._engine._features.supportRenderPasses?this._engine.currentRenderPassId:0,o=this._drawWrappers[s];o||(o=this._drawWrappers[s]=[]);let a=o[t];a||(a=new mi(this._engine),a.drawContext&&(a.drawContext.useInstancing=this._useInstancing),o[t]=a);let l=r.join(`
`);if(a.defines!==l){let c=[],u=[],h=[];this.fillUniformsAttributesAndSamplerNames(u,c,h),a.setEffect(this._engine.createEffect("particles",c,u,h,l,void 0,void 0,void 0,void 0,this._shaderLanguage),l)}return a}animate(t=!1){if(!this._started||this.paused)return;if(!t&&this._scene){if(!this.isReady()||this._currentRenderId===this._scene.getFrameId())return;this._currentRenderId=this._scene.getFrameId()}this._scaledUpdateSpeed=this.updateSpeed*(t?this.preWarmStepOffset:this._scene?.getAnimationRatio()||1);let n;if(this.manualEmitCount>-1)n=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0;else{let r=this._calculateEmitRate();n=r*this._scaledUpdateSpeed>>0,this._newPartsExcess+=r*this._scaledUpdateSpeed-n}if(this._newPartsExcess>1&&(n+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?n=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(n),this._stopped&&(this._alive||(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene&&this._scene._toBeDisposed.push(this))),!t){let r=0;for(let s=0;s<this._particles.length;s++){let o=this._particles[s];this._appendParticleVertices(r,o),r+=this._useInstancing?1:4}this._vertexBuffer&&this._vertexBuffer.updateDirectly(this._vertexData,0,this._particles.length)}this.manualEmitCount===0&&this.disposeOnStop&&this.stop()}_calculateEmitRate(){let t=this.emitRate;if(this._emitRateGradients&&this._emitRateGradients.length>0&&this.targetStopDuration){let n=this._actualFrame/this.targetStopDuration;sn.GetCurrentGradient(n,this._emitRateGradients,(r,s,o)=>{r!==this._currentEmitRateGradient&&(this._currentEmitRate1=this._currentEmitRate2,this._currentEmitRate2=s.getFactor(),this._currentEmitRateGradient=r),t=Kt(this._currentEmitRate1,this._currentEmitRate2,o)})}return t}_appendParticleVertices(t,n){this._appendParticleVertex(t++,n,0,0),this._useInstancing||(this._appendParticleVertex(t++,n,1,0),this._appendParticleVertex(t++,n,1,1),this._appendParticleVertex(t++,n,0,1))}rebuild(){this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._createIndexBuffer(),this._spriteBuffer?._rebuild(),this._createVertexBuffers(),this.resetDrawCache()}_initShaderSourceAsync(){return T(this,null,function*(){this._engine.isWebGPU&&!i.ForceGLSL?(this._shaderLanguage=1,yield Promise.all([import("./chunk-IRJJMJ7E.js"),import("./chunk-TN4WSPHR.js")])):yield Promise.all([import("./chunk-ZPCNA4FK.js"),import("./chunk-IGYEKXW5.js")]),this._shadersLoaded=!0})}isReady(){if(!this._shadersLoaded||!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==Yn.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper(Yn.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper(Yn.BLENDMODE_ADD).effect.isReady())return!1;return!0}_render(t){let n=this._getWrapper(t),r=n.effect,s=this._engine;s.enableEffect(n);let o=this.defaultViewMatrix??this._scene.getViewMatrix();if(r.setTexture("diffuseSampler",this.particleTexture),r.setMatrix("view",o),r.setMatrix("projection",this.defaultProjectionMatrix??this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){let l=this.particleTexture.getBaseSize();r.setFloat3("particlesInfos",this.spriteCellWidth/l.width,this.spriteCellHeight/l.height,this.spriteCellWidth/l.width)}if(r.setVector2("translationPivot",this.translationPivot),r.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._isBillboardBased&&this._scene){let l=this._scene.activeCamera;r.setVector3("eyePosition",l.globalPosition)}this._rampGradientsTexture&&((!this._rampGradients||!this._rampGradients.length)&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),r.setTexture("rampSampler",this._rampGradientsTexture));let a=r.defines;return this._scene&&(Qn(r,this,this._scene),this.applyFog&&Ni(this._scene,void 0,r)),a.indexOf("#define BILLBOARDMODE_ALL")>=0&&(o.invertToRef(U.Matrix[0]),r.setMatrix("invView",U.Matrix[0])),this._vertexArrayObject!==void 0?this._scene?.forceWireframe?s.bindBuffers(this._vertexBuffers,this._linesIndexBufferUseInstancing,r):(this._vertexArrayObject||(this._vertexArrayObject=this._engine.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,r)),this._engine.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):this._indexBuffer?s.bindBuffers(this._vertexBuffers,this._scene?.forceWireframe?this._linesIndexBuffer:this._indexBuffer,r):s.bindBuffers(this._vertexBuffers,this._scene?.forceWireframe?this._linesIndexBufferUseInstancing:null,r),this.useLogarithmicDepth&&this._scene&&Jn(a,r,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(r),this._setEngineBasedOnBlendMode(t),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(r),this._useInstancing?this._scene?.forceWireframe?s.drawElementsType(6,0,10,this._particles.length):s.drawArraysType(7,0,4,this._particles.length):this._scene?.forceWireframe?s.drawElementsType(1,0,this._particles.length*10):s.drawElementsType(0,0,this._particles.length*6),this._particles.length}render(){if(!this.isReady()||!this._particles.length)return 0;let t=this._engine;t.setState&&(t.setState(!1),this.forceDepthWrite&&t.setDepthWrite(!0));let n=0;return this.blendMode===Yn.BLENDMODE_MULTIPLYADD?n=this._render(Yn.BLENDMODE_MULTIPLY)+this._render(Yn.BLENDMODE_ADD):n=this._render(this.blendMode),this._engine.unbindInstanceAttributes(),this._engine.setAlphaMode(0),n}_onDispose(t=!1,n=!1){}dispose(t=!0,n=!1,r=!1){if(this.resetDrawCache(),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._linesIndexBuffer&&(this._engine._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null),this._linesIndexBufferUseInstancing&&(this._engine._releaseBuffer(this._linesIndexBufferUseInstancing),this._linesIndexBufferUseInstancing=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),t&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),t&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._onDispose(n,r),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.clear(),this._scene){let s=this._scene.particleSystems.indexOf(this);s>-1&&this._scene.particleSystems.splice(s,1),this._scene._activeParticleSystems.dispose()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onStoppedObservable.clear(),this.onStartedObservable.clear(),this.reset(),this._isDisposed=!0}}return i.ForceGLSL=!1,i})();var aa=class i{constructor(e){if(this.particleSystem=e,this.type=1,this.inheritDirection=!1,this.inheritedVelocityAmount=0,!e.emitter||!e.emitter.dispose){let t=Ct("BABYLON.AbstractMesh");e.emitter=new t("SubemitterSystemEmitter",e.getScene()),e._disposeEmitterOnDispose=!0}}clone(){let e=this.particleSystem.emitter;if(!e)e=new m;else if(e instanceof m)e=e.clone();else if(e.getClassName().indexOf("Mesh")!==-1){let n=Ct("BABYLON.Mesh");e=new n("",e.getScene()),e.isVisible=!1}let t=new i(this.particleSystem.clone(this.particleSystem.name,e));return t.particleSystem.name+="Clone",t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem._disposeEmitterOnDispose=!0,t.particleSystem.disposeOnStop=!0,t}serialize(e=!1){let t={};return t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem=this.particleSystem.serialize(e),t}static _ParseParticleSystem(e,t,n,r=!1){throw Bn("ParseParticle")}static Parse(e,t,n){let r=e.particleSystem,s=new i(i._ParseParticleSystem(r,t,n,!0));return s.type=e.type,s.inheritDirection=e.inheritDirection,s.inheritedVelocityAmount=e.inheritedVelocityAmount,s.particleSystem._isSubEmitter=!0,s}dispose(){this.particleSystem.dispose()}};var ec=class i{get mesh(){return this._mesh}set mesh(e){this._mesh!==e&&(this._mesh=e,e?(this._indices=e.getIndices(),this._positions=e.getVerticesData(S.PositionKind),this._normals=e.getVerticesData(S.NormalKind)):(this._indices=null,this._positions=null,this._normals=null))}constructor(e=null){this._indices=null,this._positions=null,this._normals=null,this._storedNormal=m.Zero(),this._mesh=null,this.direction1=new m(0,1,0),this.direction2=new m(0,1,0),this.useMeshNormalsForDirection=!0,this.mesh=e}startDirectionFunction(e,t,n,r){if(this.useMeshNormalsForDirection&&this._normals){m.TransformNormalToRef(this._storedNormal,e,t);return}let s=Ee(this.direction1.x,this.direction2.x),o=Ee(this.direction1.y,this.direction2.y),a=Ee(this.direction1.z,this.direction2.z);if(r){t.copyFromFloats(s,o,a);return}m.TransformNormalFromFloatsToRef(s,o,a,e,t)}startPositionFunction(e,t,n,r){if(!this._indices||!this._positions)return;let s=3*(Math.random()*(this._indices.length/3)|0),o=Math.random(),a=Math.random()*(1-o),l=1-o-a,c=this._indices[s],u=this._indices[s+1],h=this._indices[s+2],d=U.Vector3[0],f=U.Vector3[1],p=U.Vector3[2],g=U.Vector3[3];m.FromArrayToRef(this._positions,c*3,d),m.FromArrayToRef(this._positions,u*3,f),m.FromArrayToRef(this._positions,h*3,p),g.x=o*d.x+a*f.x+l*p.x,g.y=o*d.y+a*f.y+l*p.y,g.z=o*d.z+a*f.z+l*p.z,r?t.copyFromFloats(g.x,g.y,g.z):m.TransformCoordinatesFromFloatsToRef(g.x,g.y,g.z,e,t),this.useMeshNormalsForDirection&&this._normals&&(m.FromArrayToRef(this._normals,c*3,d),m.FromArrayToRef(this._normals,u*3,f),m.FromArrayToRef(this._normals,h*3,p),this._storedNormal.x=o*d.x+a*f.x+l*p.x,this._storedNormal.y=o*d.y+a*f.y+l*p.y,this._storedNormal.z=o*d.z+a*f.z+l*p.z)}clone(){let e=new i(this.mesh);return xt.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return""}getClassName(){return"MeshParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.meshId=this.mesh?.id,e.useMeshNormalsForDirection=this.useMeshNormalsForDirection,e}parse(e,t){m.FromArrayToRef(e.direction1,0,this.direction1),m.FromArrayToRef(e.direction2,0,this.direction2),e.meshId&&t&&(this.mesh=t.getLastMeshById(e.meshId)),this.useMeshNormalsForDirection=e.useMeshNormalsForDirection}};var tc=()=>{},Xs=class i{constructor(){this.particlePositionGenerator=tc,this.particleDestinationGenerator=tc,this.particleDirectionGenerator=tc}startDirectionFunction(e,t,n,r){let s=U.Vector3[0];if(this.particleDirectionGenerator&&this.particleDirectionGenerator!==tc)this.particleDirectionGenerator(-1,n,s);else if(this.particleDestinationGenerator&&this.particleDestinationGenerator!==tc){this.particleDestinationGenerator(-1,n,s);let o=U.Vector3[1];s.subtractToRef(n.position,o),o.scaleToRef(1/n.lifeTime,s)}else s.set(0,0,0);if(r){t.copyFrom(s);return}m.TransformNormalToRef(s,e,t)}startPositionFunction(e,t,n,r){let s=U.Vector3[0];if(this.particlePositionGenerator&&this.particlePositionGenerator!==tc?this.particlePositionGenerator(-1,n,s):s.set(0,0,0),r){t.copyFrom(s);return}m.TransformCoordinatesToRef(s,e,t)}clone(){let e=new i;return xt.DeepCopy(this,e),e}applyToShader(e){}buildUniformLayout(e){}getEffectDefines(){return"#define CUSTOMEMITTER"}getClassName(){return"CustomParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.particlePositionGenerator=this.particlePositionGenerator,e.particleDestinationGenerator=this.particleDestinationGenerator,e}parse(e){e.particlePositionGenerator&&(this.particlePositionGenerator=e.particlePositionGenerator),e.particleDestinationGenerator&&(this.particleDestinationGenerator=e.particleDestinationGenerator)}};var nc=class i{constructor(){this.direction1=new m(0,1,0),this.direction2=new m(0,1,0)}startDirectionFunction(e,t,n,r){let s=Ee(this.direction1.x,this.direction2.x),o=Ee(this.direction1.y,this.direction2.y),a=Ee(this.direction1.z,this.direction2.z);if(r){t.copyFromFloats(s,o,a);return}m.TransformNormalFromFloatsToRef(s,o,a,e,t)}startPositionFunction(e,t,n,r){if(r){t.copyFromFloats(0,0,0);return}m.TransformCoordinatesFromFloatsToRef(0,0,0,e,t)}clone(){let e=new i;return xt.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define POINTEMITTER"}getClassName(){return"PointParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){m.FromArrayToRef(e.direction1,0,this.direction1),m.FromArrayToRef(e.direction2,0,this.direction2)}};var ic=class i{constructor(e=1,t=1,n=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=n}startDirectionFunction(e,t,n,r){let s=n.position.subtract(e.getTranslation()).normalize(),o=Ee(0,this.directionRandomizer),a=Ee(0,this.directionRandomizer),l=Ee(0,this.directionRandomizer);if(s.x+=o,s.y+=a,s.z+=l,s.normalize(),r){t.copyFrom(s);return}m.TransformNormalFromFloatsToRef(s.x,s.y,s.z,e,t)}startPositionFunction(e,t,n,r){let s=this.radius-Ee(0,this.radius*this.radiusRange),o=Ee(0,1),a=Ee(0,2*Math.PI),l=Math.acos(2*o-1),c=s*Math.cos(a)*Math.sin(l),u=s*Math.cos(l),h=s*Math.sin(a)*Math.sin(l);if(r){t.copyFromFloats(c,Math.abs(u),h);return}m.TransformCoordinatesFromFloatsToRef(c,Math.abs(u),h,e,t)}clone(){let e=new i(this.radius,this.directionRandomizer);return xt.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define HEMISPHERICEMITTER"}getClassName(){return"HemisphericParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}};var la=class i{constructor(e=1,t=1,n=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=n}startDirectionFunction(e,t,n,r){let s=n.position.subtract(e.getTranslation()).normalize(),o=Ee(0,this.directionRandomizer),a=Ee(0,this.directionRandomizer),l=Ee(0,this.directionRandomizer);if(s.x+=o,s.y+=a,s.z+=l,s.normalize(),r){t.copyFrom(s);return}m.TransformNormalFromFloatsToRef(s.x,s.y,s.z,e,t)}startPositionFunction(e,t,n,r){let s=this.radius-Ee(0,this.radius*this.radiusRange),o=Ee(0,1),a=Ee(0,2*Math.PI),l=Math.acos(2*o-1),c=s*Math.cos(a)*Math.sin(l),u=s*Math.cos(l),h=s*Math.sin(a)*Math.sin(l);if(r){t.copyFromFloats(c,u,h);return}m.TransformCoordinatesFromFloatsToRef(c,u,h,e,t)}clone(){let e=new i(this.radius,this.directionRandomizer);return xt.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define SPHEREEMITTER"}getClassName(){return"SphereParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}},rc=class i extends la{constructor(e=1,t=new m(0,1,0),n=new m(0,1,0)){super(e),this.direction1=t,this.direction2=n}startDirectionFunction(e,t,n,r){let s=Ee(this.direction1.x,this.direction2.x),o=Ee(this.direction1.y,this.direction2.y),a=Ee(this.direction1.z,this.direction2.z);if(r){t.copyFromFloats(s,o,a);return}m.TransformNormalFromFloatsToRef(s,o,a,e,t)}clone(){let e=new i(this.radius,this.direction1,this.direction2);return xt.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define SPHEREEMITTER
#define DIRECTEDSPHEREEMITTER`}getClassName(){return"SphereDirectedParticleEmitter"}serialize(){let e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}};var ca=class i{constructor(e=1,t=1,n=1,r=0){this.radius=e,this.height=t,this.radiusRange=n,this.directionRandomizer=r,this._tempVector=m.Zero()}startDirectionFunction(e,t,n,r,s){n.position.subtractToRef(e.getTranslation(),this._tempVector),this._tempVector.normalize(),m.TransformNormalToRef(this._tempVector,s,this._tempVector);let o=Ee(-this.directionRandomizer/2,this.directionRandomizer/2),a=Math.atan2(this._tempVector.x,this._tempVector.z);if(a+=Ee(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this._tempVector.y=o,this._tempVector.x=Math.sin(a),this._tempVector.z=Math.cos(a),this._tempVector.normalize(),r){t.copyFrom(this._tempVector);return}m.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,e,t)}startPositionFunction(e,t,n,r){let s=Ee(-this.height/2,this.height/2),o=Ee(0,2*Math.PI),a=Ee((1-this.radiusRange)*(1-this.radiusRange),1),l=Math.sqrt(a)*this.radius,c=l*Math.cos(o),u=l*Math.sin(o);if(r){t.copyFromFloats(c,s,u);return}m.TransformCoordinatesFromFloatsToRef(c,s,u,e,t)}clone(){let e=new i(this.radius,this.directionRandomizer);return xt.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define CYLINDEREMITTER"}getClassName(){return"CylinderParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.radius=this.radius,e.height=this.height,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.height=e.height,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}},sc=class i extends ca{constructor(e=1,t=1,n=1,r=new m(0,1,0),s=new m(0,1,0)){super(e,t,n),this.direction1=r,this.direction2=s}startDirectionFunction(e,t,n,r){let s=Ee(this.direction1.x,this.direction2.x),o=Ee(this.direction1.y,this.direction2.y),a=Ee(this.direction1.z,this.direction2.z);if(r){t.copyFromFloats(s,o,a);return}m.TransformNormalFromFloatsToRef(s,o,a,e,t)}clone(){let e=new i(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return xt.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define CYLINDEREMITTER
#define DIRECTEDCYLINDEREMITTER`}getClassName(){return"CylinderDirectedParticleEmitter"}serialize(){let e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),m.FromArrayToRef(e.direction1,0,this.direction1),m.FromArrayToRef(e.direction2,0,this.direction2)}};var ua=class i{get radius(){return this._radius}set radius(e){this._radius=e,this._buildHeight()}get angle(){return this._angle}set angle(e){this._angle=e,this._buildHeight()}_buildHeight(){this._angle!==0?this._height=this._radius/Math.tan(this._angle/2):this._height=1}constructor(e=1,t=Math.PI,n=0){this.directionRandomizer=n,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=t,this.radius=e}startDirectionFunction(e,t,n,r){let s=n.position.subtract(e.getTranslation()).normalize(),o=Ee(0,this.directionRandomizer),a=Ee(0,this.directionRandomizer),l=Ee(0,this.directionRandomizer);if(s.x+=o,s.y+=a,s.z+=l,s.normalize(),r){t.copyFrom(s);return}m.TransformNormalFromFloatsToRef(s.x,s.y,s.z,e,t)}startPositionFunction(e,t,n,r){let s=Ee(0,Math.PI*2),o;this.emitFromSpawnPointOnly?o=1e-4:(o=Ee(0,this.heightRange),o=1-o*o);let a=this._radius-Ee(0,this._radius*this.radiusRange);a=a*o;let l=a*Math.sin(s),c=a*Math.cos(s),u=o*this._height;if(r){t.x=l,t.y=u,t.z=c;return}m.TransformCoordinatesFromFloatsToRef(l,u,c,e,t)}clone(){let e=new i(this._radius,this._angle,this.directionRandomizer);return xt.DeepCopy(this,e),e}applyToShader(e){e.setFloat2("radius",this._radius,this.radiusRange),e.setFloat("coneAngle",this._angle),e.setFloat2("height",this._height,this.heightRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",2),e.addUniform("coneAngle",1),e.addUniform("height",2),e.addUniform("directionRandomizer",1)}getEffectDefines(){let e="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(e+=`
#define CONEEMITTERSPAWNPOINT`),e}getClassName(){return"ConeParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.radius=this._radius,e.angle=this._angle,e.directionRandomizer=this.directionRandomizer,e.radiusRange=this.radiusRange,e.heightRange=this.heightRange,e.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,e}parse(e){this.radius=e.radius,this.angle=e.angle,this.directionRandomizer=e.directionRandomizer,this.radiusRange=e.radiusRange!==void 0?e.radiusRange:1,this.heightRange=e.radiusRange!==void 0?e.heightRange:1,this.emitFromSpawnPointOnly=e.emitFromSpawnPointOnly!==void 0?e.emitFromSpawnPointOnly:!1}},oc=class i extends ua{constructor(e=1,t=Math.PI,n=new m(0,1,0),r=new m(0,1,0)){super(e,t),this.direction1=n,this.direction2=r}startDirectionFunction(e,t,n,r){let s=Ee(this.direction1.x,this.direction2.x),o=Ee(this.direction1.y,this.direction2.y),a=Ee(this.direction1.z,this.direction2.z);if(r){t.copyFromFloats(s,o,a);return}m.TransformNormalFromFloatsToRef(s,o,a,e,t)}clone(){let e=new i(this.radius,this.angle,this.direction1,this.direction2);return xt.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define CONEEMITTER
#define DIRECTEDCONEEMITTER`}getClassName(){return"ConeDirectedParticleEmitter"}serialize(){let e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}};function Xm(i,e){let t=new nc;return t.direction1=i,t.direction2=e,t}function Zm(i=1,e=1){return new ic(i,e)}function Qm(i=1,e=1){return new la(i,e)}function Jm(i=1,e=new m(0,1,0),t=new m(0,1,0)){return new rc(i,e,t)}function eg(i=1,e=1,t=1,n=0){return new ca(i,e,t,n)}function tg(i=1,e=1,t=1,n=new m(0,1,0),r=new m(0,1,0)){return new sc(i,e,t,n,r)}function ng(i=1,e=Math.PI/4){return new ua(i,e)}function ig(i=1,e=Math.PI/4,t=new m(0,1,0),n=new m(0,1,0)){return new oc(i,e,t,n)}var VC=m.Zero(),sD=m.Zero(),oD=m.Zero(),rg=class{constructor(){this.strength=0,this.position=m.Zero()}_processParticle(e,t){this.position.subtractToRef(e.position,VC);let n=VC.lengthSquared()+1;VC.normalize().scaleToRef(this.strength/n,sD),sD.scaleToRef(t._tempScaledUpdateSpeed,oD),e.direction.addInPlace(oD)}serialize(){return{position:this.position.asArray(),strength:this.strength}}};var vt=(()=>{class i extends rD{constructor(){super(...arguments),this._disposeEmitterOnDispose=!1,this.doNotSerialize=!1,this.canStart=()=>!0,this._flowMap=null,this._flowMapUpdate=null,this._source=null,this._blockReference=0,this.flowMapStrength=1,this._attractors=[],this._attractorUpdate=null,this.metadata=null,this._emitFromParticle=t=>{if(!this._subEmitters||this._subEmitters.length===0)return;let n=Math.floor(Math.random()*this._subEmitters.length);for(let r of this._subEmitters[n])if(r.type===1){let s=r.clone();t._inheritParticleInfoToSubEmitter(s),s.particleSystem._rootParticleSystem=this,this.activeSubSystems.push(s.particleSystem),s.particleSystem.start()}}}createPointEmitter(t,n){let r=Xm(t,n);return this.particleEmitterType=r,r}get source(){return this._source}get isNodeGenerated(){return this._source!==null}get flowMap(){return this._flowMap}set flowMap(t){this._flowMap!==t&&(this._flowMap=t,this._flowMapUpdate&&(on(this._flowMapUpdate),this._flowMapUpdate=null),t&&(this._flowMapUpdate={process:n=>{let r=this.getScene()?.getTransformMatrix();this._flowMap._processParticle(n,this.flowMapStrength*this._tempScaledUpdateSpeed,r)},previousItem:null,nextItem:null},Mt(this._flowMapUpdate,this._directionProcessing)))}get attractors(){return this._attractors.slice(0)}addAttractor(t){this._attractors.push(t),this._attractors.length===1&&(this._attractorUpdate={process:n=>{for(let r of this._attractors)r._processParticle(n,this)},previousItem:null,nextItem:null},Mt(this._attractorUpdate,this._directionProcessing))}removeAttractor(t){let n=this._attractors.indexOf(t);n!==-1&&this._attractors.splice(n,1),this._attractors.length===0&&on(this._attractorUpdate)}start(t=this.startDelay){this.canStart()&&super.start(t)}createHemisphericEmitter(t=1,n=1){let r=Zm(t,n);return this.particleEmitterType=r,r}createSphereEmitter(t=1,n=1){let r=Qm(t,n);return this.particleEmitterType=r,r}createDirectedSphereEmitter(t=1,n=new m(0,1,0),r=new m(0,1,0)){let s=Jm(t,n,r);return this.particleEmitterType=s,s}createCylinderEmitter(t=1,n=1,r=1,s=0){let o=eg(t,n,r,s);return this.particleEmitterType=o,o}createDirectedCylinderEmitter(t=1,n=1,r=1,s=new m(0,1,0),o=new m(0,1,0)){let a=tg(t,n,r,s,o);return this.particleEmitterType=a,a}createConeEmitter(t=1,n=Math.PI/4){let r=ng(t,n);return this.particleEmitterType=r,r}createDirectedConeEmitter(t=1,n=Math.PI/4,r=new m(0,1,0),s=new m(0,1,0)){let o=ig(t,n,r,s);return this.particleEmitterType=o,o}createBoxEmitter(t,n,r,s){let o=new hr;return this.particleEmitterType=o,this.direction1=t,this.direction2=n,this.minEmitBox=r,this.maxEmitBox=s,o}_prepareSubEmitterInternalArray(){if(this._subEmitters=new Array,this.subEmitters)for(let t of this.subEmitters)t instanceof i?this._subEmitters.push([new aa(t)]):t instanceof aa?this._subEmitters.push([t]):t instanceof Array&&this._subEmitters.push(t)}_stopSubEmitters(){if(this.activeSubSystems){for(let t of this.activeSubSystems)t.stop(!0);this.activeSubSystems=[]}}_removeFromRoot(){if(!this._rootParticleSystem)return;let t=this._rootParticleSystem.activeSubSystems.indexOf(this);t!==-1&&this._rootParticleSystem.activeSubSystems.splice(t,1),this._rootParticleSystem=null}_preStart(){this._prepareSubEmitterInternalArray(),this._subEmitters&&this._subEmitters.length!=0&&(this.activeSubSystems=[])}_postStop(t){t&&this._stopSubEmitters()}_prepareParticle(t){if(this._subEmitters&&this._subEmitters.length>0){let n=this._subEmitters[Math.floor(Math.random()*this._subEmitters.length)];t._attachedSubEmitters=[];for(let r of n)if(r.type===0){let s=r.clone();t._attachedSubEmitters.push(s),s.particleSystem.start()}}}_onDispose(t=!1,n=!1){if(this._removeFromRoot(),this.subEmitters&&!this._subEmitters&&this._prepareSubEmitterInternalArray(),t&&this.particles){for(let r of this.particles)if(r._attachedSubEmitters)for(let s=r._attachedSubEmitters.length-1;s>=0;s-=1)r._attachedSubEmitters[s].dispose()}if(n&&this.activeSubSystems)for(let r=this.activeSubSystems.length-1;r>=0;r-=1)this.activeSubSystems[r].dispose();if(this._subEmitters&&this._subEmitters.length){for(let r=0;r<this._subEmitters.length;r++)for(let s of this._subEmitters[r])s.dispose();this._subEmitters=[],this.subEmitters=[]}this._disposeEmitterOnDispose&&this.emitter&&this.emitter.dispose&&this.emitter.dispose(!0)}static _Parse(t,n,r,s){let o;r instanceof ne?o=null:o=r;let a=Ct("BABYLON.Texture");if(a&&o&&(t.texture?n.particleTexture=a.Parse(t.texture,o,s):t.textureName&&(n.particleTexture=new a(s+t.textureName,o,!1,t.invertY!==void 0?t.invertY:!0),n.particleTexture.name=t.textureName)),!t.emitterId&&t.emitterId!==0&&t.emitter===void 0?n.emitter=m.Zero():t.emitterId&&o?n.emitter=o.getLastMeshById(t.emitterId):n.emitter=m.FromArray(t.emitter),n.isLocal=!!t.isLocal,t.renderingGroupId!==void 0&&(n.renderingGroupId=t.renderingGroupId),t.isBillboardBased!==void 0&&(n.isBillboardBased=t.isBillboardBased),t.billboardMode!==void 0&&(n.billboardMode=t.billboardMode),t.useLogarithmicDepth!==void 0&&(n.useLogarithmicDepth=t.useLogarithmicDepth),t.animations){for(let c=0;c<t.animations.length;c++){let u=t.animations[c],h=Ct("BABYLON.Animation");h&&n.animations.push(h.Parse(u))}n.beginAnimationOnStart=t.beginAnimationOnStart,n.beginAnimationFrom=t.beginAnimationFrom,n.beginAnimationTo=t.beginAnimationTo,n.beginAnimationLoop=t.beginAnimationLoop}if(t.autoAnimate&&o&&o.beginAnimation(n,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),n.startDelay=t.startDelay|0,n.minAngularSpeed=t.minAngularSpeed,n.maxAngularSpeed=t.maxAngularSpeed,n.minSize=t.minSize,n.maxSize=t.maxSize,t.minScaleX&&(n.minScaleX=t.minScaleX,n.maxScaleX=t.maxScaleX,n.minScaleY=t.minScaleY,n.maxScaleY=t.maxScaleY),t.preWarmCycles!==void 0&&(n.preWarmCycles=t.preWarmCycles,n.preWarmStepOffset=t.preWarmStepOffset),t.minInitialRotation!==void 0&&(n.minInitialRotation=t.minInitialRotation,n.maxInitialRotation=t.maxInitialRotation),n.minLifeTime=t.minLifeTime,n.maxLifeTime=t.maxLifeTime,n.minEmitPower=t.minEmitPower,n.maxEmitPower=t.maxEmitPower,n.emitRate=t.emitRate,n.gravity=m.FromArray(t.gravity),t.noiseStrength&&(n.noiseStrength=m.FromArray(t.noiseStrength)),n.color1=le.FromArray(t.color1),n.color2=le.FromArray(t.color2),n.colorDead=le.FromArray(t.colorDead),n.updateSpeed=t.updateSpeed,n.targetStopDuration=t.targetStopDuration,n.blendMode=t.blendMode,t.colorGradients)for(let c of t.colorGradients)n.addColorGradient(c.gradient,le.FromArray(c.color1),c.color2?le.FromArray(c.color2):void 0);if(t.rampGradients){for(let c of t.rampGradients)n.addRampGradient(c.gradient,G.FromArray(c.color));n.useRampGradients=t.useRampGradients}if(t.colorRemapGradients)for(let c of t.colorRemapGradients)n.addColorRemapGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.alphaRemapGradients)for(let c of t.alphaRemapGradients)n.addAlphaRemapGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.sizeGradients)for(let c of t.sizeGradients)n.addSizeGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.angularSpeedGradients)for(let c of t.angularSpeedGradients)n.addAngularSpeedGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.velocityGradients)for(let c of t.velocityGradients)n.addVelocityGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.dragGradients)for(let c of t.dragGradients)n.addDragGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.emitRateGradients)for(let c of t.emitRateGradients)n.addEmitRateGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.startSizeGradients)for(let c of t.startSizeGradients)n.addStartSizeGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.lifeTimeGradients)for(let c of t.lifeTimeGradients)n.addLifeTimeGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.limitVelocityGradients){for(let c of t.limitVelocityGradients)n.addLimitVelocityGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);n.limitVelocityDamping=t.limitVelocityDamping}if(t.noiseTexture&&o){let c=Ct("BABYLON.ProceduralTexture");n.noiseTexture=c.Parse(t.noiseTexture,o,s)}let l;if(t.particleEmitterType){switch(t.particleEmitterType.type){case"SphereParticleEmitter":l=new la;break;case"SphereDirectedParticleEmitter":l=new rc;break;case"ConeEmitter":case"ConeParticleEmitter":l=new ua;break;case"ConeDirectedParticleEmitter":l=new oc;break;case"CylinderParticleEmitter":l=new ca;break;case"CylinderDirectedParticleEmitter":l=new sc;break;case"HemisphericParticleEmitter":l=new ic;break;case"PointParticleEmitter":l=new nc;break;case"MeshParticleEmitter":l=new ec;break;case"CustomParticleEmitter":l=new Xs;break;case"BoxEmitter":case"BoxParticleEmitter":default:l=new hr;break}l.parse(t.particleEmitterType,o)}else l=new hr,l.parse(t,o);n.particleEmitterType=l,n.startSpriteCellID=t.startSpriteCellID,n.endSpriteCellID=t.endSpriteCellID,n.spriteCellLoop=t.spriteCellLoop??!0,n.spriteCellWidth=t.spriteCellWidth,n.spriteCellHeight=t.spriteCellHeight,n.spriteCellChangeSpeed=t.spriteCellChangeSpeed,n.spriteRandomStartCell=t.spriteRandomStartCell,n.disposeOnStop=t.disposeOnStop??!1,n.manualEmitCount=t.manualEmitCount??-1}static Parse(t,n,r,s=!1,o){let a=t.name,l=null,c=null,u,h;if(n instanceof ne?u=n:(h=n,u=h.getEngine()),t.customShader&&u.createEffectForParticles){c=t.customShader;let f=c.shaderOptions.defines.length>0?c.shaderOptions.defines.join(`
`):"";l=u.createEffectForParticles(c.shaderPath.fragmentElement,c.shaderOptions.uniforms,c.shaderOptions.samplers,f)}let d=new i(a,o||t.capacity,n,l,t.isAnimationSheetEnabled);if(d.customShader=c,d._rootUrl=r,t.id&&(d.id=t.id),t.subEmitters){d.subEmitters=[];for(let f of t.subEmitters){let p=[];for(let g of f)p.push(aa.Parse(g,n,r));d.subEmitters.push(p)}}if(t.attractors)for(let f of t.attractors){let p=new rg;p.position=m.FromArray(f.position),p.strength=f.strength,d.addAttractor(p)}return i._Parse(t,d,n,r),t.textureMask&&(d.textureMask=le.FromArray(t.textureMask)),t.worldOffset&&(d.worldOffset=m.FromArray(t.worldOffset)),t.preventAutoStart&&(d.preventAutoStart=t.preventAutoStart),t.metadata&&(d.metadata=t.metadata),!s&&!d.preventAutoStart&&d.start(),d}serialize(t=!1){let n={};if(i._Serialize(n,this,t),n.textureMask=this.textureMask.asArray(),n.customShader=this.customShader,n.preventAutoStart=this.preventAutoStart,n.worldOffset=this.worldOffset.asArray(),this.metadata&&(n.metadata=this.metadata),this.subEmitters){n.subEmitters=[],this._subEmitters||this._prepareSubEmitterInternalArray();for(let r of this._subEmitters){let s=[];for(let o of r)o.particleSystem.doNotSerialize||s.push(o.serialize(t));n.subEmitters.push(s)}}if(this._attractors&&this._attractors.length){n.attractors=[];for(let r of this._attractors)n.attractors.push(r.serialize())}return n}static _Serialize(t,n,r){if(t.name=n.name,t.id=n.id,t.capacity=n.getCapacity(),t.disposeOnStop=n.disposeOnStop,t.manualEmitCount=n.manualEmitCount,n.emitter.position){let y=n.emitter;t.emitterId=y.id}else{let y=n.emitter;t.emitter=y.asArray()}n.particleEmitterType&&(t.particleEmitterType=n.particleEmitterType.serialize()),n.particleTexture&&(r?t.texture=n.particleTexture.serialize():(t.textureName=n.particleTexture.name,t.invertY=!!n.particleTexture._invertY)),t.isLocal=n.isLocal,Xe.AppendSerializedAnimations(n,t),t.beginAnimationOnStart=n.beginAnimationOnStart,t.beginAnimationFrom=n.beginAnimationFrom,t.beginAnimationTo=n.beginAnimationTo,t.beginAnimationLoop=n.beginAnimationLoop,t.startDelay=n.startDelay,t.renderingGroupId=n.renderingGroupId,t.isBillboardBased=n.isBillboardBased,t.billboardMode=n.billboardMode,t.minAngularSpeed=n.minAngularSpeed,t.maxAngularSpeed=n.maxAngularSpeed,t.minSize=n.minSize,t.maxSize=n.maxSize,t.minScaleX=n.minScaleX,t.maxScaleX=n.maxScaleX,t.minScaleY=n.minScaleY,t.maxScaleY=n.maxScaleY,t.minEmitPower=n.minEmitPower,t.maxEmitPower=n.maxEmitPower,t.minLifeTime=n.minLifeTime,t.maxLifeTime=n.maxLifeTime,t.emitRate=n.emitRate,t.gravity=n.gravity.asArray(),t.noiseStrength=n.noiseStrength.asArray(),t.color1=n.color1.asArray(),t.color2=n.color2.asArray(),t.colorDead=n.colorDead.asArray(),t.updateSpeed=n.updateSpeed,t.targetStopDuration=n.targetStopDuration,t.blendMode=n.blendMode,t.preWarmCycles=n.preWarmCycles,t.preWarmStepOffset=n.preWarmStepOffset,t.minInitialRotation=n.minInitialRotation,t.maxInitialRotation=n.maxInitialRotation,t.startSpriteCellID=n.startSpriteCellID,t.spriteCellLoop=n.spriteCellLoop,t.endSpriteCellID=n.endSpriteCellID,t.spriteCellChangeSpeed=n.spriteCellChangeSpeed,t.spriteCellWidth=n.spriteCellWidth,t.spriteCellHeight=n.spriteCellHeight,t.spriteRandomStartCell=n.spriteRandomStartCell,t.isAnimationSheetEnabled=n.isAnimationSheetEnabled,t.useLogarithmicDepth=n.useLogarithmicDepth;let s=n.getColorGradients();if(s){t.colorGradients=[];for(let y of s){let C={gradient:y.gradient,color1:y.color1.asArray()};y.color2?C.color2=y.color2.asArray():C.color2=y.color1.asArray(),t.colorGradients.push(C)}}let o=n.getRampGradients();if(o){t.rampGradients=[];for(let y of o){let C={gradient:y.gradient,color:y.color.asArray()};t.rampGradients.push(C)}t.useRampGradients=n.useRampGradients}let a=n.getColorRemapGradients();if(a){t.colorRemapGradients=[];for(let y of a){let C={gradient:y.gradient,factor1:y.factor1};y.factor2!==void 0?C.factor2=y.factor2:C.factor2=y.factor1,t.colorRemapGradients.push(C)}}let l=n.getAlphaRemapGradients();if(l){t.alphaRemapGradients=[];for(let y of l){let C={gradient:y.gradient,factor1:y.factor1};y.factor2!==void 0?C.factor2=y.factor2:C.factor2=y.factor1,t.alphaRemapGradients.push(C)}}let c=n.getSizeGradients();if(c){t.sizeGradients=[];for(let y of c){let C={gradient:y.gradient,factor1:y.factor1};y.factor2!==void 0?C.factor2=y.factor2:C.factor2=y.factor1,t.sizeGradients.push(C)}}let u=n.getAngularSpeedGradients();if(u){t.angularSpeedGradients=[];for(let y of u){let C={gradient:y.gradient,factor1:y.factor1};y.factor2!==void 0?C.factor2=y.factor2:C.factor2=y.factor1,t.angularSpeedGradients.push(C)}}let h=n.getVelocityGradients();if(h){t.velocityGradients=[];for(let y of h){let C={gradient:y.gradient,factor1:y.factor1};y.factor2!==void 0?C.factor2=y.factor2:C.factor2=y.factor1,t.velocityGradients.push(C)}}let d=n.getDragGradients();if(d){t.dragGradients=[];for(let y of d){let C={gradient:y.gradient,factor1:y.factor1};y.factor2!==void 0?C.factor2=y.factor2:C.factor2=y.factor1,t.dragGradients.push(C)}}let f=n.getEmitRateGradients();if(f){t.emitRateGradients=[];for(let y of f){let C={gradient:y.gradient,factor1:y.factor1};y.factor2!==void 0?C.factor2=y.factor2:C.factor2=y.factor1,t.emitRateGradients.push(C)}}let p=n.getStartSizeGradients();if(p){t.startSizeGradients=[];for(let y of p){let C={gradient:y.gradient,factor1:y.factor1};y.factor2!==void 0?C.factor2=y.factor2:C.factor2=y.factor1,t.startSizeGradients.push(C)}}let g=n.getLifeTimeGradients();if(g){t.lifeTimeGradients=[];for(let y of g){let C={gradient:y.gradient,factor1:y.factor1};y.factor2!==void 0?C.factor2=y.factor2:C.factor2=y.factor1,t.lifeTimeGradients.push(C)}}let _=n.getLimitVelocityGradients();if(_){t.limitVelocityGradients=[];for(let y of _){let C={gradient:y.gradient,factor1:y.factor1};y.factor2!==void 0?C.factor2=y.factor2:C.factor2=y.factor1,t.limitVelocityGradients.push(C)}t.limitVelocityDamping=n.limitVelocityDamping}n.noiseTexture&&(t.noiseTexture=n.noiseTexture.serialize())}clone(t,n,r=!1){let s=K({},this._customWrappers),o=null,a=this._engine;if(a.createEffectForParticles&&this.customShader!=null){o=this.customShader;let u=o.shaderOptions.defines.length>0?o.shaderOptions.defines.join(`
`):"",h=a.createEffectForParticles(o.shaderPath.fragmentElement,o.shaderOptions.uniforms,o.shaderOptions.samplers,u);s[0]?s[0].effect=h:this.setCustomEffect(h,0)}let l=this.serialize(r),c=i.Parse(l,this._scene||this._engine,this._rootUrl);return c.name=t,c.customShader=o,c._customWrappers=s,n===void 0&&(n=this.emitter),this.noiseTexture&&(c.noiseTexture=this.noiseTexture.clone()),c.emitter=n,this.preventAutoStart||c.start(),c}}return i.BILLBOARDMODE_Y=2,i.BILLBOARDMODE_ALL=7,i.BILLBOARDMODE_STRETCHED=8,i.BILLBOARDMODE_STRETCHED_LOCAL=9,i})();aa._ParseParticleSystem=vt.Parse;Sn.prototype.createTransformFeedback=function(){let i=this._gl.createTransformFeedback();if(!i)throw new Error("Unable to create Transform Feedback");return i};Sn.prototype.deleteTransformFeedback=function(i){this._gl.deleteTransformFeedback(i)};Sn.prototype.bindTransformFeedback=function(i){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,i)};Sn.prototype.beginTransformFeedback=function(i=!0){this._gl.beginTransformFeedback(i?this._gl.POINTS:this._gl.TRIANGLES)};Sn.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()};Sn.prototype.setTranformFeedbackVaryings=function(i,e){this._gl.transformFeedbackVaryings(i,e,this._gl.INTERLEAVED_ATTRIBS)};Sn.prototype.bindTransformFeedbackBuffer=function(i){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,i?i.underlyingResource:null)};Sn.prototype.readTransformFeedbackBuffer=function(i){this._gl.getBufferSubData(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,i)};var aD="clipPlaneFragmentDeclaration2",aB=`#ifdef CLIPPLANE
in float fClipDistance;
#endif
#ifdef CLIPPLANE2
in float fClipDistance2;
#endif
#ifdef CLIPPLANE3
in float fClipDistance3;
#endif
#ifdef CLIPPLANE4
in float fClipDistance4;
#endif
#ifdef CLIPPLANE5
in float fClipDistance5;
#endif
#ifdef CLIPPLANE6
in float fClipDistance6;
#endif
`;gt.IncludesShadersStore[aD]||(gt.IncludesShadersStore[aD]=aB);var lD="gpuRenderParticlesPixelShader",lB=`precision highp float;
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform sampler2D diffuseSampler;varying vec2 vUV;varying vec4 vColor;
#include<clipPlaneFragmentDeclaration2> 
#include<imageProcessingDeclaration>
#include<logDepthDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#include<fogFragmentDeclaration>
void main() {
#include<clipPlaneFragment> 
vec4 textureColor=texture2D(diffuseSampler,vUV);gl_FragColor=textureColor*vColor;
#ifdef BLENDMULTIPLYMODE
float alpha=vColor.a*textureColor.a;gl_FragColor.rgb=gl_FragColor.rgb*alpha+vec3(1.0)*(1.0-alpha);
#endif 
#include<logDepthFragment>
#include<fogFragment>(color,gl_FragColor)
#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);
#else
#ifdef IMAGEPROCESSING
gl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);gl_FragColor=applyImageProcessing(gl_FragColor);
#endif
#endif
}
`;gt.ShadersStore[lD]||(gt.ShadersStore[lD]=lB);var cD="clipPlaneVertexDeclaration2",cB=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;out float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;out float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;out float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;out float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;out float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;out float fClipDistance6;
#endif
`;gt.IncludesShadersStore[cD]||(gt.IncludesShadersStore[cD]=cB);var uD="gpuRenderParticlesVertexShader",uB=`precision highp float;uniform mat4 view;uniform mat4 projection;uniform vec2 translationPivot;uniform vec3 worldOffset;
#ifdef LOCAL
uniform mat4 emitterWM;
#endif
attribute vec3 position;attribute float age;attribute float life;attribute vec3 size;
#ifndef BILLBOARD
attribute vec3 initialDirection;
#endif
#ifdef BILLBOARDSTRETCHED
attribute vec3 direction;
#endif
attribute float angle;
#ifdef ANIMATESHEET
attribute float cellIndex;
#endif
attribute vec2 offset;attribute vec2 uv;varying vec2 vUV;varying vec4 vColor;varying vec3 vPositionW;
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform mat4 invView;
#endif
#include<clipPlaneVertexDeclaration2>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#ifdef COLORGRADIENTS
uniform sampler2D colorGradientSampler;
#else
uniform vec4 colorDead;attribute vec4 color;
#endif
#ifdef ANIMATESHEET
uniform vec3 sheetInfos;
#endif
#ifdef BILLBOARD
uniform vec3 eyePosition;
#endif
vec3 rotate(vec3 yaxis,vec3 rotatedCorner) {vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));vec3 zaxis=normalize(cross(yaxis,xaxis));vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;
#ifdef LOCAL
return ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;
#else
return (position+worldOffset)+alignedCorner;
#endif
}
#ifdef BILLBOARDSTRETCHED
vec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {vec3 normalizedToCamera=normalize(toCamera);vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;
#ifdef LOCAL
return ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;
#else
return (position+worldOffset)+alignedCorner;
#endif
}
#endif
void main() {
#ifdef ANIMATESHEET
float rowOffset=floor(cellIndex/sheetInfos.z);float columnOffset=cellIndex-rowOffset*sheetInfos.z;vec2 uvScale=sheetInfos.xy;vec2 uvOffset=vec2(uv.x ,1.0-uv.y);vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;
#else
vUV=uv;
#endif
float ratio=min(1.0,age/life);
#ifdef COLORGRADIENTS
vColor=texture2D(colorGradientSampler,vec2(ratio,0));
#else
vColor=color*vec4(1.0-ratio)+colorDead*vec4(ratio);
#endif
vec2 cornerPos=(offset-translationPivot)*size.yz*size.x;
#ifdef BILLBOARD
vec4 rotatedCorner;rotatedCorner.w=0.;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=(position+worldOffset)-eyePosition;yaxis.y=0.;vPositionW=rotate(normalize(yaxis),rotatedCorner.xyz);vec4 viewPosition=(view*vec4(vPositionW,1.0));
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 toCamera=(position+worldOffset)-eyePosition;vPositionW=rotateAlign(toCamera,rotatedCorner.xyz);vec4 viewPosition=(view*vec4(vPositionW,1.0));
#else
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;
#ifdef LOCAL
vec4 viewPosition=view*vec4(((emitterWM*vec4(position,1.0)).xyz+worldOffset),1.0)+rotatedCorner;
#else
vec4 viewPosition=view*vec4((position+worldOffset),1.0)+rotatedCorner;
#endif
vPositionW=(invView*viewPosition).xyz;
#endif
#else
vec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=0.;rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.xz+=translationPivot;vec3 yaxis=normalize(initialDirection);vPositionW=rotate(yaxis,rotatedCorner);vec4 viewPosition=view*vec4(vPositionW,1.0);
#endif
gl_Position=projection*viewPosition;
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6) || defined(FOG)
vec4 worldPos=vec4(vPositionW,1.0);
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
}`;gt.ShadersStore[uD]||(gt.ShadersStore[uD]=uB);var sg=class i extends Yn{static get IsSupported(){if(!Ie.LastCreatedEngine)return!1;let e=Ie.LastCreatedEngine.getCaps();return e.supportTransformFeedbacks||e.supportComputeShaders}_createIndexBuffer(){this._linesIndexBufferUseInstancing=this._engine.createIndexBuffer(new Uint32Array([0,1,1,3,3,2,2,0,0,3]),void 0,"GPUParticleSystemLinesIndexBuffer")}getCapacity(){return this._capacity}get maxActiveParticleCount(){return this._maxActiveParticleCount}set maxActiveParticleCount(e){this._maxActiveParticleCount=Math.min(e,this._capacity)}get activeParticleCount(){return this.maxActiveParticleCount}set activeParticleCount(e){this.maxActiveParticleCount=e}createPointEmitter(e,t){let n=Xm(e,t);return this.particleEmitterType=n,n}createHemisphericEmitter(e=1,t=1){let n=Zm(e,t);return this.particleEmitterType=n,n}createSphereEmitter(e=1,t=1){let n=Qm(e,t);return this.particleEmitterType=n,n}createDirectedSphereEmitter(e=1,t=new m(0,1,0),n=new m(0,1,0)){let r=Jm(e,t,n);return this.particleEmitterType=r,r}createCylinderEmitter(e=1,t=1,n=1,r=0){let s=eg(e,t,n,r);return this.particleEmitterType=s,s}createDirectedCylinderEmitter(e=1,t=1,n=1,r=new m(0,1,0),s=new m(0,1,0)){let o=tg(e,t,n,r,s);return this.particleEmitterType=o,o}createConeEmitter(e=1,t=Math.PI/4){let n=ng(e,t);return this.particleEmitterType=n,n}createDirectedConeEmitter(e=1,t=Math.PI/4,n=new m(0,1,0),r=new m(0,1,0)){let s=ig(e,t,n,r);return this.particleEmitterType=s,s}createBoxEmitter(e,t,n,r){let s=new hr;return this.particleEmitterType=s,this.direction1=e,this.direction2=t,this.minEmitBox=n,this.maxEmitBox=r,s}get flowMap(){return this._flowMap}set flowMap(e){this._flowMap!==e&&(this._flowMap=e)}isReady(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||this._flowMap&&!this._flowMap.isReady()||!this.particleTexture||!this.particleTexture.isReady()||this._rebuildingAfterContextLost)return!1;if(this.blendMode!==vt.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper(vt.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper(vt.BLENDMODE_ADD).effect.isReady())return!1;return this._platform.isUpdateBufferCreated()?this._platform.isUpdateBufferReady():(this._recreateUpdateEffect(),!1)}isStarted(){return this._started}isStopped(){return this._stopped}isStopping(){return!1}getActiveCount(){return this._currentActiveCount}start(e=this.startDelay){if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e){setTimeout(()=>{this.start(0)},e);return}this._started=!0,this._stopped=!1,this._actualFrame=0,this._preWarmDone=!1,this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)}stop(){this._stopped||(this.onStoppedObservable.notifyObservers(this),this._stopped=!0)}reset(){this._releaseBuffers(),this._platform.releaseVertexBuffers(),this._currentActiveCount=0,this._targetIndex=0}getClassName(){return"GPUParticleSystem"}getCustomEffect(e=0){return this._customWrappers[e]?.effect??this._customWrappers[0].effect}_getCustomDrawWrapper(e=0){return this._customWrappers[e]??this._customWrappers[0]}setCustomEffect(e,t=0){this._customWrappers[t]=new mi(this._engine),this._customWrappers[t].effect=e}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new B),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"gpuRenderParticles"}get vertexBuffers(){return this._renderVertexBuffers[this._targetIndex^1]}get indexBuffer(){return null}_removeGradientAndTexture(e,t,n){return super._removeGradientAndTexture(e,t,n),this._releaseBuffers(),this}addColorGradient(e,t){this._colorGradients||(this._colorGradients=[]);let n=new Zl(e,t);return this._colorGradients.push(n),this._refreshColorGradient(!0),this._releaseBuffers(),this}_refreshColorGradient(e=!1){this._colorGradients&&(e&&this._colorGradients.sort((t,n)=>t.gradient<n.gradient?-1:t.gradient>n.gradient?1:0),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null))}forceRefreshGradients(){this._refreshColorGradient(),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture"),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture"),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture"),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture"),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture"),this.reset()}removeColorGradient(e){return this._removeGradientAndTexture(e,this._colorGradients,this._colorGradientsTexture),this._colorGradientsTexture=null,this}resetDrawCache(){for(let e in this._drawWrappers)this._drawWrappers[e].drawContext?.reset()}_addFactorGradient(e,t,n){let r=new Ql(t,n);e.push(r),this._releaseBuffers()}addSizeGradient(e,t){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture",!0),this._releaseBuffers(),this}removeSizeGradient(e){return this._removeGradientAndTexture(e,this._sizeGradients,this._sizeGradientsTexture),this._sizeGradientsTexture=null,this}_refreshFactorGradient(e,t,n=!1){if(!e)return;n&&e.sort((s,o)=>s.gradient<o.gradient?-1:s.gradient>o.gradient?1:0);let r=this;r[t]&&(r[t].dispose(),r[t]=null)}addAngularSpeedGradient(e,t){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture",!0),this._releaseBuffers(),this}removeAngularSpeedGradient(e){return this._removeGradientAndTexture(e,this._angularSpeedGradients,this._angularSpeedGradientsTexture),this._angularSpeedGradientsTexture=null,this}addVelocityGradient(e,t){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture",!0),this._releaseBuffers(),this}removeVelocityGradient(e){return this._removeGradientAndTexture(e,this._velocityGradients,this._velocityGradientsTexture),this._velocityGradientsTexture=null,this}addLimitVelocityGradient(e,t){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture",!0),this._releaseBuffers(),this}removeLimitVelocityGradient(e){return this._removeGradientAndTexture(e,this._limitVelocityGradients,this._limitVelocityGradientsTexture),this._limitVelocityGradientsTexture=null,this}addDragGradient(e,t){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture",!0),this._releaseBuffers(),this}removeDragGradient(e){return this._removeGradientAndTexture(e,this._dragGradients,this._dragGradientsTexture),this._dragGradientsTexture=null,this}addEmitRateGradient(){return this}removeEmitRateGradient(){return this}addStartSizeGradient(){return this}removeStartSizeGradient(){return this}addColorRemapGradient(){return this}removeColorRemapGradient(){return this}addAlphaRemapGradient(){return this}removeAlphaRemapGradient(){return this}addRampGradient(){return this}removeRampGradient(){return this}getRampGradients(){return null}get useRampGradients(){return!1}set useRampGradients(e){}addLifeTimeGradient(){return this}removeLifeTimeGradient(){return this}constructor(e,t,n,r=null,s=!1){if(super(e),this.layerMask=268435455,this._accumulatedCount=0,this._renderVertexBuffers=[],this._targetIndex=0,this._currentRenderId=-1,this._currentRenderingCameraUniqueId=-1,this._started=!1,this._stopped=!1,this._timeDelta=0,this.updateInAnimate=!1,this._actualFrame=0,this._rawTextureWidth=256,this._rebuildingAfterContextLost=!1,this.doNotSerialize=!1,this.onDisposeObservable=new B,this.onStoppedObservable=new B,this.onStartedObservable=new B,this.forceDepthWrite=!1,this._preWarmDone=!1,this.isLocal=!1,this.isGPU=!0,this.metadata=null,this._flowMap=null,this.flowMapStrength=1,this._onBeforeDrawParticlesObservable=null,!n||n.getClassName()==="Scene"?(this._scene=n||Ie.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)):(this._engine=n,this.defaultProjectionMatrix=V.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)),this._engine.getCaps().supportComputeShaders){if(!Ct("BABYLON.ComputeShaderParticleSystem"))throw new Error("The ComputeShaderParticleSystem class is not available! Make sure you have imported it.");this._platform=new(Ct("BABYLON.ComputeShaderParticleSystem"))(this,this._engine)}else{if(!Ct("BABYLON.WebGL2ParticleSystem"))throw new Error("The WebGL2ParticleSystem class is not available! Make sure you have imported it.");this._platform=new(Ct("BABYLON.WebGL2ParticleSystem"))(this,this._engine)}this._customWrappers={0:new mi(this._engine)},this._customWrappers[0].effect=r,this._drawWrappers={0:new mi(this._engine)},this._drawWrappers[0].drawContext&&(this._drawWrappers[0].drawContext.useInstancing=!0),this._createIndexBuffer(),this._attachImageProcessingConfiguration(null),t=t??{},t.randomTextureSize||delete t.randomTextureSize;let o=K({capacity:5e4,randomTextureSize:this._engine.getCaps().maxTextureSize},t),a=t;isFinite(a)&&(o.capacity=a),this._capacity=o.capacity,this._maxActiveParticleCount=o.capacity,this._currentActiveCount=0,this._isAnimationSheetEnabled=s,this.particleEmitterType=new hr;let l=Math.min(this._engine.getCaps().maxTextureSize,o.randomTextureSize),c=[];for(let u=0;u<l;++u)c.push(Math.random()),c.push(Math.random()),c.push(Math.random()),c.push(Math.random());this._randomTexture=new jn(new Float32Array(c),l,1,5,n,!1,!1,1,1),this._randomTexture.name="GPUParticleSystem_random1",this._randomTexture.wrapU=1,this._randomTexture.wrapV=1,c=[];for(let u=0;u<l;++u)c.push(Math.random()),c.push(Math.random()),c.push(Math.random()),c.push(Math.random());this._randomTexture2=new jn(new Float32Array(c),l,1,5,n,!1,!1,1,1),this._randomTexture2.name="GPUParticleSystem_random2",this._randomTexture2.wrapU=1,this._randomTexture2.wrapV=1,this._randomTextureSize=l}_reset(){this._releaseBuffers()}_createVertexBuffers(e,t,n){let r={};r.position=t.createVertexBuffer("position",0,3,this._attributesStrideSize,!0);let s=3;r.age=t.createVertexBuffer("age",s,1,this._attributesStrideSize,!0),s+=1,r.size=t.createVertexBuffer("size",s,3,this._attributesStrideSize,!0),s+=3,r.life=t.createVertexBuffer("life",s,1,this._attributesStrideSize,!0),s+=1,s+=4,this.billboardMode===vt.BILLBOARDMODE_STRETCHED&&(r.direction=t.createVertexBuffer("direction",s,3,this._attributesStrideSize,!0)),s+=3,this._platform.alignDataInBuffer&&(s+=1),this.particleEmitterType instanceof Xs&&(s+=3,this._platform.alignDataInBuffer&&(s+=1)),this._colorGradientsTexture||(r.color=t.createVertexBuffer("color",s,4,this._attributesStrideSize,!0),s+=4),this._isBillboardBased||(r.initialDirection=t.createVertexBuffer("initialDirection",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1)),this.noiseTexture&&(r.noiseCoordinates1=t.createVertexBuffer("noiseCoordinates1",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1),r.noiseCoordinates2=t.createVertexBuffer("noiseCoordinates2",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1)),r.angle=t.createVertexBuffer("angle",s,1,this._attributesStrideSize,!0),this._angularSpeedGradientsTexture?s++:s+=2,this._isAnimationSheetEnabled&&(r.cellIndex=t.createVertexBuffer("cellIndex",s,1,this._attributesStrideSize,!0),s+=1,this.spriteRandomStartCell&&(r.cellStartOffset=t.createVertexBuffer("cellStartOffset",s,1,this._attributesStrideSize,!0),s+=1)),r.offset=n.createVertexBuffer("offset",0,2),r.uv=n.createVertexBuffer("uv",2,2),this._renderVertexBuffers.push(r),this._platform.createVertexBuffers(e,r),this.resetDrawCache()}_initialize(e=!1){if(this._buffer0&&!e)return;let t=this._engine,n=[];this._attributesStrideSize=21,this._targetIndex=0,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1),this.particleEmitterType instanceof Xs&&(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this.isBillboardBased||(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this._colorGradientsTexture&&(this._attributesStrideSize-=4),this._angularSpeedGradientsTexture&&(this._attributesStrideSize-=1),this._isAnimationSheetEnabled&&(this._attributesStrideSize+=1,this.spriteRandomStartCell&&(this._attributesStrideSize+=1)),this.noiseTexture&&(this._attributesStrideSize+=6,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=2)),this._platform.alignDataInBuffer&&(this._attributesStrideSize+=3-(this._attributesStrideSize+3&3));let r=this.particleEmitterType instanceof Xs,s=U.Vector3[0],o=0;for(let u=0;u<this._capacity;u++)if(n.push(0),n.push(0),n.push(0),n.push(0),n.push(0),n.push(0),n.push(0),n.push(0),n.push(Math.random()),n.push(Math.random()),n.push(Math.random()),n.push(Math.random()),r?(this.particleEmitterType.particleDestinationGenerator(u,null,s),n.push(s.x),n.push(s.y),n.push(s.z)):(n.push(0),n.push(0),n.push(0)),this._platform.alignDataInBuffer&&n.push(0),o+=16,r&&(this.particleEmitterType.particlePositionGenerator(u,null,s),n.push(s.x),n.push(s.y),n.push(s.z),this._platform.alignDataInBuffer&&n.push(0),o+=4),this._colorGradientsTexture||(n.push(0),n.push(0),n.push(0),n.push(0),o+=4),this.isBillboardBased||(n.push(0),n.push(0),n.push(0),this._platform.alignDataInBuffer&&n.push(0),o+=4),this.noiseTexture&&(n.push(Math.random()),n.push(Math.random()),n.push(Math.random()),this._platform.alignDataInBuffer&&n.push(0),n.push(Math.random()),n.push(Math.random()),n.push(Math.random()),this._platform.alignDataInBuffer&&n.push(0),o+=8),n.push(0),o+=1,this._angularSpeedGradientsTexture||(n.push(0),o+=1),this._isAnimationSheetEnabled&&(n.push(0),o+=1,this.spriteRandomStartCell&&(n.push(0),o+=1)),this._platform.alignDataInBuffer){let h=3-(o+3&3);for(o+=h;h-- >0;)n.push(0)}let a=new Float32Array([.5,.5,1,1,-.5,.5,0,1,.5,-.5,1,0,-.5,-.5,0,0]),l=this._platform.createParticleBuffer(n),c=this._platform.createParticleBuffer(n);this._buffer0=new Cn(t,l,!1,this._attributesStrideSize),this._buffer1=new Cn(t,c,!1,this._attributesStrideSize),this._spriteBuffer=new Cn(t,a,!1,4),this._renderVertexBuffers=[],this._createVertexBuffers(this._buffer0,this._buffer1,this._spriteBuffer),this._createVertexBuffers(this._buffer1,this._buffer0,this._spriteBuffer),this._sourceBuffer=this._buffer0,this._targetBuffer=this._buffer1}_recreateUpdateEffect(){this._createColorGradientTexture(),this._createSizeGradientTexture(),this._createAngularSpeedGradientTexture(),this._createVelocityGradientTexture(),this._createLimitVelocityGradientTexture(),this._createDragGradientTexture();let e=this.particleEmitterType?this.particleEmitterType.getEffectDefines():"";return this._isBillboardBased&&(e+=`
#define BILLBOARD`),this._colorGradientsTexture&&(e+=`
#define COLORGRADIENTS`),this._sizeGradientsTexture&&(e+=`
#define SIZEGRADIENTS`),this._angularSpeedGradientsTexture&&(e+=`
#define ANGULARSPEEDGRADIENTS`),this._velocityGradientsTexture&&(e+=`
#define VELOCITYGRADIENTS`),this._limitVelocityGradientsTexture&&(e+=`
#define LIMITVELOCITYGRADIENTS`),this._dragGradientsTexture&&(e+=`
#define DRAGGRADIENTS`),this._flowMap&&(e+=`
#define FLOWMAP`),this.isAnimationSheetEnabled&&(e+=`
#define ANIMATESHEET`,this.spriteRandomStartCell&&(e+=`
#define ANIMATESHEETRANDOMSTART`)),this.noiseTexture&&(e+=`
#define NOISE`),this.isLocal&&(e+=`
#define LOCAL`),this._platform.isUpdateBufferCreated()&&this._cachedUpdateDefines===e?this._platform.isUpdateBufferReady():(this._cachedUpdateDefines=e,this._updateBuffer=this._platform.createUpdateBuffer(e),this._platform.isUpdateBufferReady())}_getWrapper(e){let t=this._getCustomDrawWrapper(e);if(t?.effect)return t;let n=[];this.fillDefines(n,e);let r=this._drawWrappers[e];r||(r=new mi(this._engine),r.drawContext&&(r.drawContext.useInstancing=!0),this._drawWrappers[e]=r);let s=n.join(`
`);if(r.defines!==s){let o=[],a=[],l=[];this.fillUniformsAttributesAndSamplerNames(a,o,l),r.setEffect(this._engine.createEffect("gpuRenderParticles",o,a,l,s),s)}return r}static _GetAttributeNamesOrOptions(e=!1,t=!1,n=!1,r=!1){let s=[S.PositionKind,"age","life","size","angle"];return e||s.push(S.ColorKind),t&&s.push("cellIndex"),n||s.push("initialDirection"),r&&s.push("direction"),s.push("offset",S.UVKind),s}static _GetEffectCreationOptions(e=!1,t=!1,n=!1){let r=["emitterWM","worldOffset","view","projection","colorDead","invView","translationPivot","eyePosition"];return Zn(r),e&&r.push("sheetInfos"),t&&r.push("logarithmicDepthConstant"),n&&(r.push("vFogInfos"),r.push("vFogColor")),r}fillDefines(e,t=0,n=!0){if(this._scene&&(xs(this,this._scene,e),this.applyFog&&this._scene.fogEnabled&&this._scene.fogMode!==Pe.FOGMODE_NONE&&e.push("#define FOG")),t===vt.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this.isLocal&&e.push("#define LOCAL"),this.useLogarithmicDepth&&e.push("#define LOGARITHMICDEPTH"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case vt.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case vt.BILLBOARDMODE_STRETCHED:e.push("#define BILLBOARDSTRETCHED");break;case vt.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL");break;default:break}this._colorGradientsTexture&&e.push("#define COLORGRADIENTS"),this.isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),n&&this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(""+this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(e,t,n){t.push(...i._GetAttributeNamesOrOptions(!!this._colorGradientsTexture,this._isAnimationSheetEnabled,this._isBillboardBased,this._isBillboardBased&&this.billboardMode===vt.BILLBOARDMODE_STRETCHED)),e.push(...i._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth,this.applyFog)),n.push("diffuseSampler","colorGradientSampler"),this._imageProcessingConfiguration&&(gi.PrepareUniforms(e,this._imageProcessingConfigurationDefines),gi.PrepareSamplers(n,this._imageProcessingConfigurationDefines))}animate(e=!1){this._timeDelta=this.updateSpeed*(e?this.preWarmStepOffset:this._scene?.getAnimationRatio()||1),this._actualFrame+=this._timeDelta,this._stopped||this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop(),this.updateInAnimate&&this._update()}_createFactorGradientTexture(e,t){let n=this[t];if(!e||!e.length||n)return;let r=new Float32Array(this._rawTextureWidth);for(let s=0;s<this._rawTextureWidth;s++){let o=s/this._rawTextureWidth;sn.GetCurrentGradient(o,e,(a,l,c)=>{r[s]=Kt(a.factor1,l.factor1,c)})}this[t]=jn.CreateRTexture(r,this._rawTextureWidth,1,this._scene||this._engine,!1,!1,1),this[t].name=t.substring(1)}_createSizeGradientTexture(){this._createFactorGradientTexture(this._sizeGradients,"_sizeGradientsTexture")}_createAngularSpeedGradientTexture(){this._createFactorGradientTexture(this._angularSpeedGradients,"_angularSpeedGradientsTexture")}_createVelocityGradientTexture(){this._createFactorGradientTexture(this._velocityGradients,"_velocityGradientsTexture")}_createLimitVelocityGradientTexture(){this._createFactorGradientTexture(this._limitVelocityGradients,"_limitVelocityGradientsTexture")}_createDragGradientTexture(){this._createFactorGradientTexture(this._dragGradients,"_dragGradientsTexture")}_createColorGradientTexture(){if(!this._colorGradients||!this._colorGradients.length||this._colorGradientsTexture)return;let e=new Uint8Array(this._rawTextureWidth*4),t=it.Color4[0];for(let n=0;n<this._rawTextureWidth;n++){let r=n/this._rawTextureWidth;sn.GetCurrentGradient(r,this._colorGradients,(s,o,a)=>{le.LerpToRef(s.color1,o.color1,a,t),e[n*4]=t.r*255,e[n*4+1]=t.g*255,e[n*4+2]=t.b*255,e[n*4+3]=t.a*255})}this._colorGradientsTexture=jn.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1),this._colorGradientsTexture.name="colorGradients"}_render(e,t){let n=this._getWrapper(e),r=n.effect;this._engine.enableEffect(n);let s=this._scene?.getViewMatrix()||V.IdentityReadOnly;r.setMatrix("view",s),r.setMatrix("projection",this.defaultProjectionMatrix??this._scene.getProjectionMatrix()),r.setTexture("diffuseSampler",this.particleTexture),r.setVector2("translationPivot",this.translationPivot);let o=this.worldOffset.subtractToRef(this._scene?.floatingOriginOffset||m.ZeroReadOnly,U.Vector3[0]);if(r.setVector3("worldOffset",o),this.isLocal&&r.setMatrix("emitterWM",t),this._colorGradientsTexture?r.setTexture("colorGradientSampler",this._colorGradientsTexture):r.setDirectColor4("colorDead",this.colorDead),this._isAnimationSheetEnabled&&this.particleTexture){let l=this.particleTexture.getBaseSize();r.setFloat3("sheetInfos",this.spriteCellWidth/l.width,this.spriteCellHeight/l.height,l.width/this.spriteCellWidth)}if(this._isBillboardBased&&this._scene){let l=this._scene.activeCamera;r.setVector3("eyePosition",l.globalPosition)}let a=r.defines;if(this._scene&&(Qn(r,this,this._scene),this.applyFog&&Ni(this._scene,void 0,r)),a.indexOf("#define BILLBOARDMODE_ALL")>=0){let l=s.clone();l.invert(),r.setMatrix("invView",l)}return this.useLogarithmicDepth&&this._scene&&Jn(a,r,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(r),this._setEngineBasedOnBlendMode(e),this._platform.bindDrawBuffers(this._targetIndex,r,this._scene?.forceWireframe?this._linesIndexBufferUseInstancing:null),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(r),this._scene?.forceWireframe?this._engine.drawElementsType(6,0,10,this._currentActiveCount):this._engine.drawArraysType(7,0,4,this._currentActiveCount),this._engine.setAlphaMode(0),this._scene?.forceWireframe&&this._engine.unbindInstanceAttributes(),this._currentActiveCount}_update(e){if(!this.emitter||!this._targetBuffer||!this._recreateUpdateEffect()||this._rebuildingAfterContextLost)return;if(!e)if(this.emitter.position)e=this.emitter.getWorldMatrix();else{let s=this.emitter;e=U.Matrix[0],V.TranslationToRef(s.x,s.y,s.z,e)}let t=this._engine,n=t.getDepthWrite();if(t.setDepthWrite(!1),this._platform.preUpdateParticleBuffer(),this._updateBuffer.setFloat("currentCount",this._currentActiveCount),this._updateBuffer.setFloat("timeDelta",this._timeDelta),this._updateBuffer.setFloat("stopFactor",this._stopped?0:1),this._updateBuffer.setInt("randomTextureSize",this._randomTextureSize),this._updateBuffer.setFloat2("lifeTime",this.minLifeTime,this.maxLifeTime),this._updateBuffer.setFloat2("emitPower",this.minEmitPower,this.maxEmitPower),this._colorGradientsTexture||(this._updateBuffer.setDirectColor4("color1",this.color1),this._updateBuffer.setDirectColor4("color2",this.color2)),this._updateBuffer.setFloat2("sizeRange",this.minSize,this.maxSize),this._updateBuffer.setFloat4("scaleRange",this.minScaleX,this.maxScaleX,this.minScaleY,this.maxScaleY),this._updateBuffer.setFloat4("angleRange",this.minAngularSpeed,this.maxAngularSpeed,this.minInitialRotation,this.maxInitialRotation),this._updateBuffer.setVector3("gravity",this.gravity),this._limitVelocityGradientsTexture&&this._updateBuffer.setFloat("limitVelocityDamping",this.limitVelocityDamping),this.particleEmitterType&&this.particleEmitterType.applyToShader(this._updateBuffer),this._isAnimationSheetEnabled&&this._updateBuffer.setFloat4("cellInfos",this.startSpriteCellID,this.endSpriteCellID,this.spriteCellChangeSpeed,this.spriteCellLoop?1:0),this.noiseTexture&&this._updateBuffer.setVector3("noiseStrength",this.noiseStrength),this._flowMap){let s=this.getScene();this._updateBuffer.setFloat("flowMapStrength",this.flowMapStrength),this._updateBuffer.setMatrix("flowMapProjection",s.getTransformMatrix())}this.isLocal||this._updateBuffer.setMatrix("emitterWM",e),this._platform.updateParticleBuffer(this._targetIndex,this._targetBuffer,this._currentActiveCount),this._targetIndex++,this._targetIndex===2&&(this._targetIndex=0);let r=this._sourceBuffer;this._sourceBuffer=this._targetBuffer,this._targetBuffer=r,t.setDepthWrite(n)}render(e=!1,t=!1){if(!this._started||!this.isReady())return 0;if(!e&&this._scene){if(!this._preWarmDone&&this.preWarmCycles){for(let o=0;o<this.preWarmCycles;o++)this.animate(!0),this.render(!0,!0);this._preWarmDone=!0}if(this._currentRenderId===this._scene.getRenderId()&&(!this._scene.activeCamera||this._scene.activeCamera&&this._currentRenderingCameraUniqueId===this._scene.activeCamera.uniqueId))return 0;this._currentRenderId=this._scene.getRenderId(),this._scene.activeCamera&&(this._currentRenderingCameraUniqueId=this._scene.activeCamera.uniqueId)}if(this._initialize(),this.manualEmitCount>-1?(this._accumulatedCount+=this.manualEmitCount,this.manualEmitCount=0):this._accumulatedCount+=this.emitRate*this._timeDelta,this._accumulatedCount>=1){let o=this._accumulatedCount|0;this._accumulatedCount-=o,this._currentActiveCount+=o}if(this._currentActiveCount=Math.min(this._maxActiveParticleCount,this._currentActiveCount),!this._currentActiveCount)return 0;let n;if(this.emitter.position)n=this.emitter.getWorldMatrix();else{let o=this.emitter;n=U.Matrix[0],V.TranslationToRef(o.x,o.y,o.z,n)}let r=this._engine;this.updateInAnimate||this._update(n);let s=0;return!e&&!t&&(r.setState(!1),this.forceDepthWrite&&r.setDepthWrite(!0),this.blendMode===vt.BLENDMODE_MULTIPLYADD?s=this._render(vt.BLENDMODE_MULTIPLY,n)+this._render(vt.BLENDMODE_ADD,n):s=this._render(this.blendMode,n),this._engine.setAlphaMode(0)),s}rebuild(){let e=()=>{!this._recreateUpdateEffect()||!this._platform.isUpdateBufferReady()?setTimeout(e,10):(this._initialize(!0),this._rebuildingAfterContextLost=!1)};this._createIndexBuffer(),this._cachedUpdateDefines="",this._platform.contextLost(),this._rebuildingAfterContextLost=!0,e()}_releaseBuffers(){this._buffer0&&(this._buffer0.dispose(),this._buffer0=null),this._buffer1&&(this._buffer1.dispose(),this._buffer1=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._platform.releaseBuffers()}dispose(e=!0){for(let t in this._drawWrappers)this._drawWrappers[t].dispose();if(this._drawWrappers={},this._scene){let t=this._scene.particleSystems.indexOf(this);t>-1&&this._scene.particleSystems.splice(t,1)}this._releaseBuffers(),this._platform.releaseVertexBuffers();for(let t=0;t<this._renderVertexBuffers.length;++t){let n=this._renderVertexBuffers[t];for(let r in n)n[r].dispose()}this._renderVertexBuffers=[],this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null),this._sizeGradientsTexture&&(this._sizeGradientsTexture.dispose(),this._sizeGradientsTexture=null),this._angularSpeedGradientsTexture&&(this._angularSpeedGradientsTexture.dispose(),this._angularSpeedGradientsTexture=null),this._velocityGradientsTexture&&(this._velocityGradientsTexture.dispose(),this._velocityGradientsTexture=null),this._limitVelocityGradientsTexture&&(this._limitVelocityGradientsTexture.dispose(),this._limitVelocityGradientsTexture=null),this._dragGradientsTexture&&(this._dragGradientsTexture.dispose(),this._dragGradientsTexture=null),this._randomTexture&&(this._randomTexture.dispose(),this._randomTexture=null),this._randomTexture2&&(this._randomTexture2.dispose(),this._randomTexture2=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this.onStoppedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}clone(e,t,n=!1){let r=K({},this._customWrappers),s=null,o=this._engine;if(o.createEffectForParticles&&this.customShader!=null){s=this.customShader;let c=s.shaderOptions.defines.length>0?s.shaderOptions.defines.join(`
`):"";r[0]=o.createEffectForParticles(s.shaderPath.fragmentElement,s.shaderOptions.uniforms,s.shaderOptions.samplers,c,void 0,void 0,void 0,this)}let a=this.serialize(n),l=i.Parse(a,this._scene||this._engine,this._rootUrl);return l.name=e,l.customShader=s,l._customWrappers=r,t===void 0&&(t=this.emitter),this.noiseTexture&&(l.noiseTexture=this.noiseTexture.clone()),l.emitter=t,l}serialize(e=!1){let t={};return vt._Serialize(t,this,e),t.activeParticleCount=this.activeParticleCount,t.randomTextureSize=this._randomTextureSize,t.customShader=this.customShader,t.preventAutoStart=this.preventAutoStart,t.worldOffset=this.worldOffset.asArray(),this.metadata&&(t.metadata=this.metadata),t}static Parse(e,t,n,r=!1,s){let o=e.name,a,l;t instanceof ne?a=t:(l=t,a=l.getEngine());let c=new i(o,{capacity:s||e.capacity,randomTextureSize:e.randomTextureSize},t,null,e.isAnimationSheetEnabled);if(c._rootUrl=n,e.customShader&&a.createEffectForParticles){let u=e.customShader,h=u.shaderOptions.defines.length>0?u.shaderOptions.defines.join(`
`):"",d=a.createEffectForParticles(u.shaderPath.fragmentElement,u.shaderOptions.uniforms,u.shaderOptions.samplers,h,void 0,void 0,void 0,c);c.setCustomEffect(d,0),c.customShader=u}return e.id&&(c.id=e.id),e.activeParticleCount&&(c.activeParticleCount=e.activeParticleCount),vt._Parse(e,c,t,n),e.worldOffset&&(c.worldOffset=m.FromArray(e.worldOffset)),e.preventAutoStart&&(c.preventAutoStart=e.preventAutoStart),e.metadata&&(c.metadata=e.metadata),!r&&!c.preventAutoStart&&c.start(),c}};Ws(Ge.NAME_PARTICLESYSTEM,(i,e,t,n)=>{let r=Ow(Ge.NAME_PARTICLESYSTEM);if(r&&i.particleSystems!==void 0&&i.particleSystems!==null)for(let s=0,o=i.particleSystems.length;s<o;s++){let a=i.particleSystems[s];t.particleSystems.push(r(a,e,n))}});Pw(Ge.NAME_PARTICLESYSTEM,(i,e,t)=>i.activeParticleCount?sg.Parse(i,e,t):vt.Parse(i,e,t));ne.prototype.createEffectForParticles=function(i,e=[],t=[],n="",r,s,o,a,l=0,c){let u=[],h=[],d=[];return a?a.fillUniformsAttributesAndSamplerNames(h,u,d):(u=vt._GetAttributeNamesOrOptions(),h=vt._GetEffectCreationOptions()),n.indexOf(" BILLBOARD")===-1&&(n+=`
#define BILLBOARD
`),a?.isAnimationSheetEnabled&&n.indexOf(" ANIMATESHEET")===-1&&(n+=`
#define ANIMATESHEET
`),t.indexOf("diffuseSampler")===-1&&t.push("diffuseSampler"),this.createEffect({vertex:c??a?.vertexShaderName??"particles",fragmentElement:i},u,h.concat(e),d.concat(t),n,r,s,o,void 0,l,()=>T(this,null,function*(){l===0?yield import("./chunk-ZPCNA4FK.js"):yield import("./chunk-IRJJMJ7E.js")}))};A.prototype.getEmittedParticleSystems=function(){let i=[];for(let e=0;e<this.getScene().particleSystems.length;e++){let t=this.getScene().particleSystems[e];t.emitter===this&&i.push(t)}return i};A.prototype.getHierarchyEmittedParticleSystems=function(){let i=[],e=this.getDescendants();e.push(this);for(let t=0;t<this.getScene().particleSystems.length;t++){let n=this.getScene().particleSystems[t],r=n.emitter;r.position&&e.indexOf(r)!==-1&&i.push(n)}return i};var Yt={FOG_DENSITY:.008,FOG_COLOR:new G(.01,.02,.01),TEXTURE_SIZE:64,STARS_COUNT:2e3,STARS_MIN_SIZE:.2,STARS_MAX_SIZE:.8,STARS_COLOR_1:new le(.5,1,.5,1),STARS_COLOR_2:new le(.2,.8,.2,1),STARS_EMIT_BOX_MIN:new m(-100,-100,-100),STARS_EMIT_BOX_MAX:new m(100,100,100),NEBULA_COUNT:200,NEBULA_MIN_SIZE:40,NEBULA_MAX_SIZE:80,NEBULA_COLOR_1:new le(.1,.4,.1,.05),NEBULA_COLOR_2:new le(0,.2,0,.02),NEBULA_EMIT_BOX_MIN:new m(-80,-80,-80),NEBULA_EMIT_BOX_MAX:new m(80,80,80),PARTICLE_LIFETIME:10800,ENABLE_TEXTURE_REUSE:!0},og=class i{starsSystem=null;nebulaSystem=null;particleTexture=null;scene=null;constructor(){}createNebulaBackground(e,t=!0,n,r){this.scene=e,t&&this.setupFog(e),(!this.particleTexture||!Yt.ENABLE_TEXTURE_REUSE)&&(this.particleTexture=this.createParticleTexture(e)),this.createStarsSystem(e,n),this.createNebulaSystem(e,r)}startSystems(){this.starsSystem&&this.starsSystem.start(),this.nebulaSystem&&this.nebulaSystem.start()}stopSystems(){this.starsSystem&&this.starsSystem.stop(),this.nebulaSystem&&this.nebulaSystem.stop()}dispose(){this.stopSystems(),this.starsSystem&&(this.starsSystem.dispose(),this.starsSystem=null),this.nebulaSystem&&(this.nebulaSystem.dispose(),this.nebulaSystem=null),this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),this.scene=null}setupFog(e){e.fogMode=Pe.FOGMODE_EXP,e.fogDensity=Yt.FOG_DENSITY,e.fogColor=Yt.FOG_COLOR}createParticleTexture(e){let t=new Vr("nebulaParticleTexture",Yt.TEXTURE_SIZE,e,!0),n=t.getContext(),r=t.getSize(),s=r.width/2,o=n.createRadialGradient(s,s,0,s,s,s);return o.addColorStop(0,"rgba(255, 255, 255, 1)"),o.addColorStop(.5,"rgba(255, 255, 255, 0.5)"),o.addColorStop(1,"rgba(255, 255, 255, 0)"),n.fillStyle=o,n.fillRect(0,0,r.width,r.height),t.update(),t}createStarsSystem(e,t){let n=t??Yt.STARS_COUNT;this.starsSystem=new vt("stars",n,e),this.starsSystem.particleTexture=this.particleTexture,this.starsSystem.emitter=m.Zero(),this.starsSystem.minEmitBox=Yt.STARS_EMIT_BOX_MIN,this.starsSystem.maxEmitBox=Yt.STARS_EMIT_BOX_MAX,this.starsSystem.color1=Yt.STARS_COLOR_1,this.starsSystem.color2=Yt.STARS_COLOR_2,this.starsSystem.colorDead=new le(0,0,0,0),this.starsSystem.minSize=Yt.STARS_MIN_SIZE,this.starsSystem.maxSize=Yt.STARS_MAX_SIZE,this.starsSystem.minLifeTime=Yt.PARTICLE_LIFETIME*60*this.starsSystem.updateSpeed,this.starsSystem.maxLifeTime=this.starsSystem.minLifeTime,this.starsSystem.emitRate=0,this.starsSystem.manualEmitCount=n,this.starsSystem.blendMode=vt.BLENDMODE_ADD}createNebulaSystem(e,t){let n=t??Yt.NEBULA_COUNT;this.nebulaSystem=new vt("nebula",n,e),this.nebulaSystem.particleTexture=this.particleTexture,this.nebulaSystem.emitter=m.Zero(),this.nebulaSystem.minEmitBox=Yt.NEBULA_EMIT_BOX_MIN,this.nebulaSystem.maxEmitBox=Yt.NEBULA_EMIT_BOX_MAX,this.nebulaSystem.color1=Yt.NEBULA_COLOR_1,this.nebulaSystem.color2=Yt.NEBULA_COLOR_2,this.nebulaSystem.colorDead=new le(0,0,0,0),this.nebulaSystem.minSize=Yt.NEBULA_MIN_SIZE,this.nebulaSystem.maxSize=Yt.NEBULA_MAX_SIZE,this.nebulaSystem.minLifeTime=Yt.PARTICLE_LIFETIME*60*this.nebulaSystem.updateSpeed,this.nebulaSystem.maxLifeTime=this.nebulaSystem.minLifeTime,this.nebulaSystem.emitRate=0,this.nebulaSystem.manualEmitCount=n,this.nebulaSystem.blendMode=vt.BLENDMODE_ADD,this.nebulaSystem.minInitialRotation=0,this.nebulaSystem.maxInitialRotation=Math.PI*2}get starsParticleSystem(){return this.starsSystem}get nebulaParticleSystem(){return this.nebulaSystem}static \u0275fac=function(t){return new(t||i)};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})};var Zs=class i{_show$=new Dt(!1);show$=this._show$.asObservable();_message$=new Dt("Engaging Mechanism");message$=this._message$.asObservable();_image$=new Dt("assets/icons/map-icon.png");image$=this._image$.asObservable();_showButton$=new Dt(!1);showButton$=this._showButton$.asObservable();buttonText="LAUNCH";isTransparent=!1;autoHide=!0;_textVisible$=new Dt(!0);textVisible$=this._textVisible$.asObservable();_messageRequest$=new Xt;_isExiting$=new Dt(!1);isExiting$=this._isExiting$.asObservable();constructor(){this._messageRequest$.pipe(lo(e=>(this._textVisible$.next(!1),Je(e).pipe(fd(300),un(t=>{this._message$.next(t),this._textVisible$.next(!0)}),fd(500))))).subscribe()}forceClose(){this._isExiting$.next(!0),setTimeout(()=>{this.show=!1,this._isExiting$.next(!1)},500)}updateMessage(e){this._messageRequest$.next(e)}get show(){return this._show$.value}set show(e){this._show$.next(e),e?this.toggleScroll(!0):this.toggleScroll(!1)}hide(){this.autoHide?this.show=!1:(this._showButton$.next(!0),this.updateMessage("!COORDINATES LOCKED!"))}toggleScroll(e){e?document.body.classList.add("no-scroll"):document.body.classList.remove("no-scroll")}updateImage(e){this._image$.next(e)}static \u0275fac=function(t){return new(t||i)};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})};var dD="puzzle-state",qr=class i{_isUnlocked=oi(this.loadFromStorage().isUnlocked);_isLoading=oi(!0);isUnlocked=this._isUnlocked.asReadonly();isLoading=this._isLoading.asReadonly();loadFromStorage(){try{let e=sessionStorage.getItem(dD);if(e)return JSON.parse(e)}catch(e){console.warn("Failed to load puzzle state from sessionStorage",e)}return{isUnlocked:!1}}saveToStorage(){try{let e={isUnlocked:this._isUnlocked()};sessionStorage.setItem(dD,JSON.stringify(e))}catch(e){console.warn("Failed to save puzzle state to sessionStorage",e)}}unlockPuzzle(){this._isUnlocked.set(!0),this.saveToStorage()}lockPuzzle(){this._isUnlocked.set(!1),this.saveToStorage()}setLoading(e){this._isLoading.set(e)}reset(){this._isUnlocked.set(!1),this._isLoading.set(!0),this.saveToStorage()}static \u0275fac=function(t){return new(t||i)};static \u0275prov=Me({token:i,factory:i.\u0275fac,providedIn:"root"})};var hB=["renderCanvas"];function dB(i,e){i&1&&(To(),Te(0,"svg",14),en(1,"path",15),xe())}function fB(i,e){i&1&&(To(),Te(0,"svg",14),en(1,"path",16),xe())}function pB(i,e){i&1&&(To(),Te(0,"svg",14),en(1,"path",17),xe())}function mB(i,e){if(i&1&&(Te(0,"span",13),hn(1,dB,2,0,":svg:svg",14),hn(2,fB,2,0,":svg:svg",14),hn(3,pB,2,0,":svg:svg",14),xe()),i&2){let t=e.$implicit,n=e.$index,r=wn(2);Pr("completed",n<r.puzzleStep())("active",n===r.puzzleStep()),De(),dn(t==="right"?1:-1),De(),dn(t==="down"?2:-1),De(),dn(t==="left"?3:-1)}}function gB(i,e){i&1&&Ye(0," SWIPE RIGHT ")}function _B(i,e){i&1&&Ye(0," SWIPE DOWN ")}function yB(i,e){i&1&&Ye(0," SWIPE LEFT ")}function vB(i,e){if(i&1&&(Te(0,"div",3)(1,"div",4),Ye(2,"UNLOCK MAP"),xe(),Te(3,"div",5),xi(4,mB,4,7,"span",6,Dr),xe()(),Te(6,"div",7)(7,"div",8),To(),Te(8,"svg",9),en(9,"path",10),xe(),kd(),en(10,"div",11),xe(),Te(11,"div",12),hn(12,gB,1,0)(13,_B,1,0)(14,yB,1,0),xe()()),i&2){let t,n=wn();De(4),Ci(n.SEQUENCE_DISPLAY),De(3),Pr("anim-right",n.puzzleStep()===0)("anim-down",n.puzzleStep()===1)("anim-left",n.puzzleStep()===2),De(5),dn((t=n.puzzleStep())===0?12:t===1?13:t===2?14:-1)}}var lh={SEQUENCE:["right","down","left"],SEQUENCE_DISPLAY:["right","down","left"],SWIPE_THRESHOLD:50,FLOATING_SPEED:2.5,FLOATING_AMPLITUDE:.015},ys={INNER_SPHERE:{ALBEDO_COLOR:new G(0,0,0),METALLIC:.1,ROUGHNESS:.9},GLOW_LAYER:{MAIN_TEXTURE_RATIO:.5,BLUR_KERNEL_SIZE:32,INTENSITY:2},FEEDBACK_COLORS:{CORRECT:new G(0,1,0),WRONG:new G(1,0,0),UNLOCKED:G.FromHexString("#00ffff")}},Yr={PULSE_DURATION:36,PULSE_FPS:30,CAMERA_DELAY:200,VIBRATE_DELAY:50,VIBRATE_ERROR_DELAY:150},Qs={ROTATION_FPS:30,ROTATION_FRAMES:15,RESET_FRAMES:15,SHAKE_DURATION:500,SHAKE_FREQUENCY:50,SHAKE_INTENSITY:.005},ag=class i{constructor(e,t,n,r,s){this.babylonService=e;this.splashService=t;this.ngZone=n;this.router=r;this.puzzleStore=s}canvasRef;puzzleStep=oi(0);SEQUENCE_DISPLAY=lh.SEQUENCE_DISPLAY;isAnimating=!1;isVibrating=!1;startX=0;startY=0;loadedOuterMap=null;loadedInnerMap=null;mapSphere=null;glowLayer=null;floatingObserver=null;pointerObserver=null;SEQUENCE=lh.SEQUENCE;SWIPE_THRESHOLD=lh.SWIPE_THRESHOLD;ngOnInit(){this.splashService.show=!0,this.puzzleStore.setLoading(!0)}ngAfterViewInit(){this.ngZone.runOutsideAngular(()=>{setTimeout(()=>{this.initBabylonScene().catch(console.error)},0)})}initBabylonScene(){return T(this,null,function*(){this.initializeScene();try{yield this.loadInnerSphere(),yield this.loadOuterMapModel(),this.setupInteraction(),this.finalizeSceneSetup()}catch(e){console.error("Failed to initialize treasure map:",e),this.splashService.updateMessage("Error Loading Map Data"),setTimeout(()=>this.splashService.hide(),2e3)}})}initializeScene(){let e=this.canvasRef.nativeElement;this.babylonService.initScene(e,{createEnvironmentTexture:!0,createLights:!1,allowCamControls:!1,createGlowLayer:!1},{removeKeyBoardInputs:!1,autoElevation:!1,disablePanning:!1})}loadInnerSphere(){return T(this,null,function*(){if(this.loadedInnerMap=yield this.babylonService.loadModel("assets/models/inner_sphere.glb"),this.loadedInnerMap.addAllToScene(),this.mapSphere=this.loadedInnerMap.meshes[1],this.mapSphere&&this.babylonService.currentScene){let e=new Na("blackSphere",this.babylonService.currentScene);e.albedoColor=ys.INNER_SPHERE.ALBEDO_COLOR,e.metallic=ys.INNER_SPHERE.METALLIC,e.roughness=ys.INNER_SPHERE.ROUGHNESS,e.emissiveColor=new G(0,0,0),this.mapSphere.material=e,this.glowLayer=new Mi("glow",this.babylonService.currentScene,{mainTextureRatio:ys.GLOW_LAYER.MAIN_TEXTURE_RATIO,blurKernelSize:ys.GLOW_LAYER.BLUR_KERNEL_SIZE}),this.glowLayer.intensity=ys.GLOW_LAYER.INTENSITY}this.babylonService.setCameraInitialTarget(!1,!1,!0,this.loadedInnerMap,!1,!1),this.babylonService.scaleMesh(this.loadedInnerMap.meshes[0],1.03)})}loadOuterMapModel(){return T(this,null,function*(){this.loadedOuterMap=yield this.babylonService.loadModel("assets/models/treasure_map.glb"),this.loadedOuterMap.addAllToScene(),this.babylonService.setCameraInitialTarget(!1,!0,!0,this.loadedOuterMap,!0,!0),this.startFloatingEffect()})}finalizeSceneSetup(){this.ngZone.run(()=>{this.puzzleStore.setLoading(!1),setTimeout(()=>{this.splashService.hide()},500)}),this.babylonService.startAnimation()}startFloatingEffect(){if(!this.babylonService.currentScene||!this.babylonService.parentBox||!this.loadedInnerMap)return;let e=new A("coreGroup",this.babylonService.currentScene);this.babylonService.parentBox.parent=e,this.loadedInnerMap.meshes[0].parent=e;let t=this.babylonService.currentScene,n=0,r=lh.FLOATING_SPEED,s=lh.FLOATING_AMPLITUDE,o=e.position.y;this.floatingObserver=t.onBeforeRenderObservable.add(()=>{!this.isAnimating&&e&&(n+=.016*r,e.position.y=o+Math.sin(n)*s)})}setupInteraction(){this.babylonService.currentScene&&this.attachPointerObserver()}attachPointerObserver(){!this.babylonService.currentScene||this.pointerObserver||(this.pointerObserver=this.babylonService.currentScene.onPointerObservable.add(e=>{let t=e.type;if(t===Ae.POINTERDOWN)this.startX=e.event.clientX,this.startY=e.event.clientY;else if(t===Ae.POINTERUP&&this.startX!==0){let n=e.event.clientX-this.startX,r=e.event.clientY-this.startY,s=this.detectSwipeDirection(n,r);s&&this.handleSwipe(s),this.startX=0,this.startY=0}}))}detachPointerObserver(){this.pointerObserver&&this.babylonService.currentScene&&(this.babylonService.currentScene.onPointerObservable.remove(this.pointerObserver),this.pointerObserver=null,this.startX=0,this.startY=0)}detectSwipeDirection(e,t){let n=Math.abs(e),r=Math.abs(t);return n<this.SWIPE_THRESHOLD&&r<this.SWIPE_THRESHOLD?null:n>r?e>0?"right":"left":t>0?"down":"up"}handleSwipe(e){this.isAnimating||this.puzzleStore.isUnlocked()||(this.isAnimating=!0,this.detachPointerObserver(),this.ngZone.run(()=>{let t=this.SEQUENCE[this.puzzleStep()];e===t?(this.puzzleStep.set(this.puzzleStep()+1),this.onCorrectSwipe(),this.puzzleStep()>=this.SEQUENCE.length&&this.unlockPuzzle().catch(console.error)):(this.puzzleStep.set(0),this.onWrongSwipe())}))}onCorrectSwipe(){if("vibrate"in navigator&&!this.isVibrating&&(this.isVibrating=!0,navigator.vibrate(100),setTimeout(()=>this.isVibrating=!1,Yr.VIBRATE_DELAY)),!this.mapSphere?.material||!this.babylonService.currentScene){this.resetAfterAnimation();return}let e=this.mapSphere.material,t=this.babylonService.currentScene,n=new H("greenPulse","emissiveIntensity",Yr.PULSE_FPS,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CONSTANT);n.setKeys([{frame:0,value:0},{frame:9,value:2},{frame:18,value:0},{frame:27,value:2},{frame:Yr.PULSE_DURATION,value:0}]),n.setEasingFunction(new mc),e.emissiveColor=ys.FEEDBACK_COLORS.CORRECT,e.emissiveIntensity=0;let r=t.beginDirectAnimation(e,[n],0,Yr.PULSE_DURATION,!1);setTimeout(()=>{let s=this.SEQUENCE[this.puzzleStep()-1];this.rotateCameraByDirection(s)},Yr.CAMERA_DELAY),r.onAnimationEndObservable.addOnce(()=>{e.emissiveColor=new G(0,0,0),e.emissiveIntensity=1,this.resetAfterAnimation()})}onWrongSwipe(){if("vibrate"in navigator&&!this.isVibrating&&(this.isVibrating=!0,navigator.vibrate([50,100,50]),setTimeout(()=>this.isVibrating=!1,Yr.VIBRATE_ERROR_DELAY)),this.shakeParentBox(),!this.mapSphere?.material||!this.babylonService.currentScene){setTimeout(()=>{this.resetCameraToInitialPosition(),this.resetAfterAnimation()},200);return}let e=this.mapSphere.material,t=this.babylonService.currentScene,n=new H("redPulse","emissiveIntensity",Yr.PULSE_FPS,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CONSTANT);n.setKeys([{frame:0,value:0},{frame:9,value:2},{frame:18,value:0},{frame:27,value:2},{frame:Yr.PULSE_DURATION,value:0}]),n.setEasingFunction(new mc),e.emissiveColor=ys.FEEDBACK_COLORS.WRONG,e.emissiveIntensity=0;let r=t.beginDirectAnimation(e,[n],0,Yr.PULSE_DURATION,!1);setTimeout(()=>this.resetCameraToInitialPosition(),Yr.CAMERA_DELAY),r.onAnimationEndObservable.addOnce(()=>{e.emissiveColor=new G(0,0,0),e.emissiveIntensity=1,this.resetAfterAnimation()})}resetAfterAnimation(){this.isAnimating=!1,this.isVibrating=!1,this.puzzleStore.isUnlocked()||this.attachPointerObserver()}unlockPuzzle(){return T(this,null,function*(){if(this.puzzleStore.unlockPuzzle(),"vibrate"in navigator&&navigator.vibrate([100,50,100,50,200]),this.detachPointerObserver(),this.floatingObserver&&this.babylonService.currentScene&&(this.babylonService.currentScene.onBeforeRenderObservable.remove(this.floatingObserver),this.floatingObserver=null),this.mapSphere&&this.mapSphere.material){let t=this.mapSphere.material;t.emissiveColor=ys.FEEDBACK_COLORS.UNLOCKED,t.emissiveIntensity=2}let e=null;if(this.babylonService.parentBox&&this.babylonService.currentScene){let t=new H("celebrateRotation","rotation.y",30,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CYCLE);t.setKeys([{frame:0,value:this.babylonService.parentBox.rotation.y},{frame:60,value:this.babylonService.parentBox.rotation.y+Math.PI*2}]),this.babylonService.parentBox.animations=[t],e=this.babylonService.currentScene.beginAnimation(this.babylonService.parentBox,0,60,!0)}this.createFlashTransition(()=>{e&&e.stop(),this.cleanupResources(),this.transitionToGridRoom()}).then(()=>{})})}cleanupResources(){this.mapSphere&&(this.mapSphere.dispose(),this.mapSphere=null),this.glowLayer&&(this.glowLayer.dispose(),this.glowLayer=null),this.loadedOuterMap&&(this.loadedOuterMap.dispose(),this.loadedOuterMap=null),this.loadedInnerMap&&(this.loadedInnerMap.dispose(),this.loadedInnerMap=null),this.floatingObserver&&this.babylonService.currentScene&&(this.babylonService.currentScene.onBeforeRenderObservable.remove(this.floatingObserver),this.floatingObserver=null),this.detachPointerObserver()}transitionToGridRoom(){this.ngZone.run(()=>{this.router.navigate(["/holographic-room"]).catch(console.error)})}shakeParentBox(){let e=this.babylonService.parentBox,t=this.babylonService.currentScene;if(!e||!t)return;let n=e.position.clone(),r=Date.now(),s=t.onBeforeRenderObservable.add(()=>{let o=Date.now()-r;o>=Qs.SHAKE_DURATION?this.resetShake(s,n):this.applyShakeOffset(o,n)})}resetShake(e,t){let n=this.babylonService.parentBox,r=this.babylonService.currentScene;!n||!r||(n.position.copyFrom(t),r.onBeforeRenderObservable.remove(e))}applyShakeOffset(e,t){let n=this.babylonService.parentBox;if(!n)return;let r=e/Qs.SHAKE_DURATION,s=Qs.SHAKE_INTENSITY*(1-r),o=e/1e3,a=Qs.SHAKE_FREQUENCY*Math.PI*2;n.position.x=t.x+Math.sin(o*a)*s,n.position.y=t.y+Math.cos(o*a)*s*.7,n.position.z=t.z+Math.sin(o*a+Math.PI/3)*s*.5}createFlashTransition(e,t=G.FromHexString("#020205")){let n=this.babylonService.currentScene;return n?new Promise(r=>{if(!n)return r();let s=gn.CreatePlane("transitionFlash",{size:500},n),o=n.activeCamera;o&&(s.parent=o,s.position=new m(0,0,5),s.renderingGroupId=3);let a=new Z("transitionFlashMaterial",n);a.emissiveColor=t,a.disableLighting=!0,a.backFaceCulling=!1,a.alpha=0,s.material=a,s.isVisible=!0;let l=0,c=2500,u=0,h=1500,d=1700,f=2500,p=!1,g=n.onBeforeRenderObservable.add(()=>{if(l+=n.getEngine().getDeltaTime(),l>=d&&!p&&(p=!0,e()),l<u)a.alpha=0;else if(l<h){let _=(l-u)/(h-u);a.alpha=_*_}else if(l<f){let _=(l-h)/(f-h);a.alpha=1-_*_*_}else a.alpha=0;l>=c&&(g&&n?.onBeforeRenderObservable.remove(g),s.dispose(),a.dispose(),r())})}):Promise.resolve()}rotateCameraByDirection(e){let t=this.babylonService.currentCamera,n=this.babylonService.currentScene;if(!t||!n)return;let r=Math.PI/2,{property:s,currentValue:o,targetValue:a}=this.calculateRotationTarget(e,r,t.alpha,t.beta);this.animateCameraProperty(s,o,a)}calculateRotationTarget(e,t,n,r){switch(e){case"right":return{property:"alpha",currentValue:n,targetValue:n-t};case"left":return{property:"alpha",currentValue:n,targetValue:n+t};case"up":return{property:"beta",currentValue:r,targetValue:Math.max(.1,r+t)};case"down":return{property:"beta",currentValue:r,targetValue:Math.min(Math.PI-.1,r-t)};default:return{property:"alpha",currentValue:0,targetValue:0}}}animateCameraProperty(e,t,n){let r=this.babylonService.currentCamera;r&&H.CreateAndStartAnimation(`cameraRotation_${e}`,r,e,Qs.ROTATION_FPS,Qs.ROTATION_FRAMES,t,n,H.ANIMATIONLOOPMODE_CONSTANT)}resetCameraToInitialPosition(){!this.babylonService.currentCamera||!this.hasInitialCameraPosition()||(this.animateCameraReset("alpha",this.babylonService.cameraInitialAlpha),this.animateCameraReset("beta",this.babylonService.cameraInitialBeta),this.animateCameraReset("radius",this.babylonService.cameraInitialRadius))}hasInitialCameraPosition(){return this.babylonService.cameraInitialAlpha!==null&&this.babylonService.cameraInitialBeta!==null&&this.babylonService.cameraInitialRadius!==null}animateCameraReset(e,t){let n=this.babylonService.currentCamera;if(!n)return;let r=n[e];H.CreateAndStartAnimation(`resetCamera_${e}`,n,e,Qs.ROTATION_FPS,Qs.RESET_FRAMES,r,t,H.ANIMATIONLOOPMODE_CONSTANT)}cleanup(){this.cleanupResources(),this.babylonService.dispose()}ngOnDestroy(){this.cleanup()}static \u0275fac=function(t){return new(t||i)(Wt(Xl),Wt(Zs),Wt(Et),Wt(Lr),Wt(qr))};static \u0275cmp=sr({type:i,selectors:[["app-map-puzzle"]],viewQuery:function(t,n){if(t&1&&tu(hB,7),t&2){let r;nu(r=iu())&&(n.canvasRef=r.first)}},decls:4,vars:1,consts:[["renderCanvas",""],[1,"closed-map-container"],[1,"render-canvas"],[1,"puzzle-hints"],[1,"hint-title"],[1,"sequence-display"],[1,"sequence-step",3,"completed","active"],[1,"swipe-guide-overlay"],[1,"hand-container"],["viewBox","0 0 24 24","fill","none","xmlns","http://www.w3.org/2000/svg",1,"hand-icon"],["d","M12 2C12.5523 2 13 2.44772 13 3V13C13 13.5523 13.4477 14 14 14C14.5523 14 15 13.5523 15 13V5C15 4.44772 15.4477 4 16 4C16.5523 4 17 4.44772 17 5V13C17 13.5523 17.4477 14 18 14C18.5523 14 19 13.5523 19 13V7C19 6.44772 19.4477 6 20 6C20.5523 6 21 6.44772 21 7V15.5C21 19.0899 18.0899 22 14.5 22H9.5C5.91015 22 3 19.0899 3 15.5V11C3 10.4477 3.44772 10 4 10C4.5523 10 5 10.4477 5 11V16C5 16.5523 5.44772 17 6 17C6.5523 17 7 16.5523 7 16V3C7 2.44772 7.44772 2 8 2C8.5523 2 9 2.44772 9 3V11C9 11.5523 9.44772 12 10 12C10.5523 12 11 11.5523 11 11V3C11 2.44772 11.4477 2 12 2Z","fill","currentColor"],[1,"touch-point"],[1,"guide-text"],[1,"sequence-step"],["viewBox","0 0 24 24",1,"step-icon"],["fill","currentColor","d","M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"],["fill","currentColor","d","M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8z"],["fill","currentColor","d","M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"]],template:function(t,n){t&1&&(Te(0,"div",1),en(1,"canvas",2,0),hn(3,vB,15,7),xe()),t&2&&(De(3),dn(!n.puzzleStore.isUnlocked()&&!n.puzzleStore.isLoading()?3:-1))},dependencies:[ml],styles:[".closed-map-container[_ngcontent-%COMP%]{position:relative;width:100%;height:100vh;background-color:var(--bg-space);overflow:hidden}.render-canvas[_ngcontent-%COMP%]{width:100%;height:100%;display:block;outline:none;cursor:grab}.render-canvas[_ngcontent-%COMP%]:active{cursor:grabbing}.puzzle-hints[_ngcontent-%COMP%]{position:absolute;top:1rem;left:50%;transform:translate(-50%);background:#020205d9;padding:1rem 1.5rem;border-radius:12px;border:2px solid var(--color-gold);box-shadow:0 0 20px #c7883580;z-index:100;pointer-events:none}.hint-title[_ngcontent-%COMP%]{color:var(--color-gold);font-size:2rem;text-transform:uppercase;margin-bottom:.5rem;text-align:center}.sequence-display[_ngcontent-%COMP%]{display:flex;gap:.5rem;justify-content:center}.sequence-step[_ngcontent-%COMP%]{padding:.5rem;background:#c7883526;border:1px solid var(--color-gold);border-radius:6px;color:var(--color-gold);font-size:1.8rem;font-weight:600;transition:all .3s ease;opacity:.5;min-width:3.5rem;min-height:3.5rem;display:flex;align-items:center;justify-content:center;will-change:color;transform:translateZ(0)}.step-icon[_ngcontent-%COMP%]{width:2rem;height:2rem;display:block}.sequence-step.active[_ngcontent-%COMP%]{opacity:1;background:#c788354d;box-shadow:0 0 15px #c7883599;animation:_ngcontent-%COMP%_pulse 1.5s ease-in-out infinite}.sequence-step.completed[_ngcontent-%COMP%]{opacity:1;background:#0f03;border-color:#0f0;color:#0f0}.swipe-guide-overlay[_ngcontent-%COMP%]{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:flex;flex-direction:column;align-items:center;gap:1.5rem;pointer-events:none;z-index:90;opacity:.8}.guide-text[_ngcontent-%COMP%]{color:#fff;font-family:TreasurePlanet,sans-serif;font-size:1.5rem;letter-spacing:2px;text-shadow:0 0 10px rgba(199,136,53,.8);animation:_ngcontent-%COMP%_textFade 2s infinite}.hand-container[_ngcontent-%COMP%]{position:relative;width:2rem;height:2rem}.hand-icon[_ngcontent-%COMP%]{width:100%;height:100%;color:#fff;filter:drop-shadow(0 0 5px var(--color-neon));position:relative;z-index:2}.touch-point[_ngcontent-%COMP%]{position:absolute;top:0;left:50%;width:20px;height:20px;background:var(--color-neon);border-radius:50%;transform:translate(-50%);opacity:0;box-shadow:0 0 15px var(--color-neon);z-index:1}.hand-container.anim-right[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_swipeRight 2s infinite ease-in-out}.hand-container.anim-right[_ngcontent-%COMP%]   .touch-point[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_touchPressRight 2s infinite ease-in-out}.hand-container.anim-down[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_swipeDown 2s infinite ease-in-out}.hand-container.anim-down[_ngcontent-%COMP%]   .touch-point[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_touchPressDown 2s infinite ease-in-out}.hand-container.anim-left[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_swipeLeft 2s infinite ease-in-out}.hand-container.anim-left[_ngcontent-%COMP%]   .touch-point[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_touchPressLeft 2s infinite ease-in-out}@keyframes _ngcontent-%COMP%_swipeRight{0%{transform:translate(-3rem) rotate(-10deg);opacity:0}20%{transform:translate(-3rem) rotate(-10deg);opacity:1}60%{transform:translate(3rem) rotate(0);opacity:1}80%{transform:translate(3rem) rotate(0);opacity:0}to{transform:translate(3rem) rotate(0);opacity:0}}@keyframes _ngcontent-%COMP%_swipeDown{0%{transform:translateY(-1.5rem);opacity:0}20%{transform:translateY(-1.5rem);opacity:1}60%{transform:translateY(1.5rem);opacity:1}80%{transform:translateY(1.5rem);opacity:0}to{transform:translateY(1.5rem);opacity:0}}@keyframes _ngcontent-%COMP%_swipeLeft{0%{transform:translate(3rem) rotate(10deg);opacity:0}20%{transform:translate(3rem) rotate(10deg);opacity:1}60%{transform:translate(-3rem) rotate(0);opacity:1}80%{transform:translate(-3rem) rotate(0);opacity:0}to{transform:translate(-3rem) rotate(0);opacity:0}}@keyframes _ngcontent-%COMP%_touchPressRight{0%,15%{opacity:0;transform:translate(-50%) scale(.5)}20%{opacity:.8;transform:translate(-50%) scale(1)}60%{opacity:.8;transform:translate(-50%) scale(1)}70%,to{opacity:0;transform:translate(-50%) scale(.5)}}@keyframes _ngcontent-%COMP%_touchPressDown{0%,15%{opacity:0;transform:translate(-50%) scale(.5)}20%{opacity:.8;transform:translate(-50%) scale(1)}60%{opacity:.8;transform:translate(-50%) scale(1)}70%,to{opacity:0;transform:translate(-50%) scale(.5)}}@keyframes _ngcontent-%COMP%_touchPressLeft{0%,15%{opacity:0;transform:translate(-50%) scale(.5)}20%{opacity:.8;transform:translate(-50%) scale(1)}60%{opacity:.8;transform:translate(-50%) scale(1)}70%,to{opacity:0;transform:translate(-50%) scale(.5)}}@keyframes _ngcontent-%COMP%_textFade{0%,to{opacity:.1}50%{opacity:1}}@keyframes _ngcontent-%COMP%_pulse{0%,to{transform:scale(1);box-shadow:0 0 15px #c7883599}50%{transform:scale(1.05);box-shadow:0 0 25px #c78835e6}}@media(max-width:768px){.puzzle-hints[_ngcontent-%COMP%]{top:10px;padding:15px 20px}.sequence-display[_ngcontent-%COMP%]{gap:10px}.sequence-step[_ngcontent-%COMP%]{padding:6px 12px;font-size:.75rem}.swipe-guide-overlay[_ngcontent-%COMP%]{top:60%}}"]})};var pD=[{id:"about",title:"DAVID ALVARADO",label:"KNOW ME",type:"about",position:[0,2,0],content:{avatar:"assets/images/david_tp.jpg",role:"SWE Front-End Tech Lead",location:"Ecuador",bio:["I blend technical precision with artistic creativity. With over 5 years of experience, I specialize in designing and implementing high-performance architectures using modern FrontEnd and BackEnd technologies and frameworks, carefully selecting the architecture to match each project's specific requirements. My attention to detail ensures that every pixel and every line of code serves a purpose.","Beyond the screen, I am a passionate singer and content creator. On my YouTube channel, I translate and perform songs, applying the same dedication to musical nuances as I do to software quality.","I value autonomy and trust. I'm a responsible leader who fosters good communication and a positive environment, believing that great software is built by happy, self-managed teams."],socials:{youtube:"https://www.youtube.com/@D4veCovers",linkedin:"https://linkedin.com/in/david-alvarado-dev/",email:"frealvaradoc@gmail.com"},softSkills:["Detail Oriented","Good Communication","Autonomous","Team Player"]}},{id:"experience",title:"CAREER LOG",label:"CAREER",type:"experience",position:[-4,0,2],content:[{company:"StickerStoke S.A.S",role:"Front-End Tech Lead",period:"2021 - 2025",desc:"Led the technological vision for a real-time visual customization platform.",highlights:["Architected a patent-pending 3D vector editor using Babylon.js & Angular.","Optimized rendering performance, reducing load times by 40%.","Managed AWS/Docker pipelines for CI/CD efficiency.","Mentored the frontend team, establishing SOLID principles."]},{company:"GoData Ecuador",role:"Tech Lead",period:"2020 - 2021",desc:"Directed banking operations digitalization.",highlights:["Led a squad of 4 developers using Agile/Scrum methodologies.","Modernized legacy banking interfaces improving UX for internal staff.","Orchestrated Java Spring Boot backend integration."]},{company:"Freelance Developer",role:"Full Stack Developer",period:"2019 - 2020",desc:"Delivered custom web solutions and digital transformations.",highlights:["Designed SEO-optimized websites increasing client visibility.","Built custom WordPress plugins for automated workflows.","Developed full-stack apps for warehouse management using Angular/Node."]}]},{id:"projects",title:"INNOVATION HUB",label:"PROJECTS",type:"projects",position:[0,-3,3],content:[{name:"3DCAL",category:"Core Product",description:"A complex e-commerce ecosystem featuring a real-time 3D vehicle configurator. Migrated from WordPress to a custom Angular/NestJS architecture.",stack:["Angular","Babylon.js","NestJS"],link:"https://3dcal.com/"},{name:"Custom WP Plugins",category:"Development Tools",description:"Built a real-time Shipping Cost Calculator for Ecuadorian couriers and an Auto-Image Optimizer API integration to preserve quality while reducing file size.",stack:["PHP","WordPress API","REST"]},{name:"AMPDC",category:"Volunteer Work",description:"Maintained the site, updated sections/color palettes, and integrated payments. Implemented analytics (Clarify, GA, FB Pixel), published articles, and collaborated on a custom appointment scheduling plugin.",stack:["WordPress","Analytics","Plugins"],link:"https://psicologiaydesarrollocomunitario.com/"},{name:"PBYA",category:"Web Solutions",description:"Solved critical hosting migration issues, diagnosed and repaired code errors with deep refactoring, and developed a new custom module for the industrial sector.",stack:["Headless WP","Gatsby","React"],link:"https://pbya.com/"}]},{id:"skills",title:"TECH ARSENAL",label:"SKILLS",type:"skills",position:[4,0,2],content:{core:[{name:"Angular & TS",level:98},{name:"Babylon.js / Three.js 3D",level:90},{name:"Vue.js",level:80},{name:"React / Astro",level:85}],backend:["Node.js","NestJS","PostgreSQL","PHP / WordPress","Electron.js"],devops:["Docker","AWS (ECS/S3)","Azure","Git Flow","CI/CD"]}}];var yt=(()=>{class i{constructor(t,n){this.triggerOptions=t,this.onBeforeExecuteObservable=new B,t.parameter?(this.trigger=t.trigger,this._triggerParameter=t.parameter):t.trigger?this.trigger=t.trigger:this.trigger=t,this._nextActiveAction=this,this._condition=n}_prepare(){}getTriggerParameter(){return this._triggerParameter}setTriggerParameter(t){this._triggerParameter=t}_evaluateConditionForCurrentFrame(){let t=this._condition;if(!t)return!0;let n=this._actionManager.getScene().getRenderId();return t._evaluationId!==n&&(t._evaluationId=n,t._currentResult=t.isValid()),t._currentResult}_executeCurrent(t){this._evaluateConditionForCurrentFrame()&&(this.onBeforeExecuteObservable.notifyObservers(this),this._nextActiveAction.execute(t),this.skipToNextActiveAction())}execute(t){}skipToNextActiveAction(){this._nextActiveAction._child?(this._nextActiveAction._child._actionManager||(this._nextActiveAction._child._actionManager=this._actionManager),this._nextActiveAction=this._nextActiveAction._child):this._nextActiveAction=this}then(t){return this._child=t,t._actionManager=this._actionManager,t._prepare(),t}_getProperty(t){return this._actionManager._getProperty(t)}_getEffectiveTarget(t,n){return this._actionManager._getEffectiveTarget(t,n)}serialize(t){return null}_serialize(t,n){let r={type:1,children:[],name:t.name,properties:t.properties||[]};if(this._child&&this._child.serialize(r),this._condition){let s=this._condition.serialize();return s.children.push(r),n&&n.children.push(s),s}return n&&n.children.push(r),r}}return i._SerializeValueAsString=e=>typeof e=="number"?e.toString():typeof e=="boolean"?e?"true":"false":e instanceof _e?e.x+", "+e.y:e instanceof m?e.x+", "+e.y+", "+e.z:e instanceof G?e.r+", "+e.g+", "+e.b:e instanceof le?e.r+", "+e.g+", "+e.b+", "+e.a:e,i._GetTargetProperty=e=>({name:"target",targetType:e._isMesh?"MeshProperties":e._isLight?"LightProperties":e._isCamera?"CameraProperties":e._isMaterial?"MaterialProperties":"SceneProperties",value:e._isScene?"Scene":e.name}),i})();ue("BABYLON.Action",yt);var Js=class{constructor(e){this._actionManager=e}isValid(){return!0}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(){}_serialize(e){return{type:2,children:[],name:e.name,properties:e.properties}}},HC=(()=>{class i extends Js{static get IsEqual(){return i._IsEqual}static get IsDifferent(){return i._IsDifferent}static get IsGreater(){return i._IsGreater}static get IsLesser(){return i._IsLesser}constructor(t,n,r,s,o=i.IsEqual){super(t),this.propertyPath=r,this.value=s,this.operator=o,this._target=n,this._effectiveTarget=this._getEffectiveTarget(n,this.propertyPath),this._property=this._getProperty(this.propertyPath)}isValid(){switch(this.operator){case i.IsGreater:return this._effectiveTarget[this._property]>this.value;case i.IsLesser:return this._effectiveTarget[this._property]<this.value;case i.IsEqual:case i.IsDifferent:{let t;return this.value.equals?t=this.value.equals(this._effectiveTarget[this._property]):t=this.value===this._effectiveTarget[this._property],this.operator===i.IsEqual?t:!t}}return!1}serialize(){return this._serialize({name:"ValueCondition",properties:[yt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:yt._SerializeValueAsString(this.value)},{name:"operator",value:i.GetOperatorName(this.operator)}]})}static GetOperatorName(t){switch(t){case i._IsEqual:return"IsEqual";case i._IsDifferent:return"IsDifferent";case i._IsGreater:return"IsGreater";case i._IsLesser:return"IsLesser";default:return""}}}return i._IsEqual=0,i._IsDifferent=1,i._IsGreater=2,i._IsLesser=3,i})(),UC=class extends Js{constructor(e,t){super(e),this.predicate=t}isValid(){return this.predicate()}},zC=class extends Js{constructor(e,t,n){super(e),this.value=n,this._target=t}isValid(){return this._target.state===this.value}serialize(){return this._serialize({name:"StateCondition",properties:[yt._GetTargetProperty(this._target),{name:"value",value:this.value}]})}};ue("BABYLON.ValueCondition",HC);ue("BABYLON.PredicateCondition",UC);ue("BABYLON.StateCondition",zC);var $C=class extends yt{constructor(e,t,n,r){super(e,r),this.propertyPath=n,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]}serialize(e){return super._serialize({name:"SwitchBooleanAction",properties:[yt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath}]},e)}},WC=class extends yt{constructor(e,t,n,r){super(e,r),this.value=n,this._target=t}execute(){this._target.state=this.value}serialize(e){return super._serialize({name:"SetStateAction",properties:[yt._GetTargetProperty(this._target),{name:"value",value:this.value}]},e)}},jC=class extends yt{constructor(e,t,n,r,s){super(e,s),this.propertyPath=n,this.value=r,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"SetValueAction",properties:[yt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:yt._SerializeValueAsString(this.value)}]},e)}},qC=class extends yt{constructor(e,t,n,r,s){super(e,s),this.propertyPath=n,this.value=r,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath),typeof this._effectiveTarget[this._property]!="number"&&N.Warn("Warning: IncrementValueAction can only be used with number values")}execute(){this._effectiveTarget[this._property]+=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"IncrementValueAction",properties:[yt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:yt._SerializeValueAsString(this.value)}]},e)}},YC=class extends yt{constructor(e,t,n,r,s,o){super(e,o),this.from=n,this.to=r,this.loop=s,this._target=t}_prepare(){}execute(){this._actionManager.getScene().beginAnimation(this._target,this.from,this.to,this.loop)}serialize(e){return super._serialize({name:"PlayAnimationAction",properties:[yt._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:yt._SerializeValueAsString(this.loop)||!1}]},e)}},KC=class extends yt{constructor(e,t,n){super(e,n),this._target=t}_prepare(){}execute(){this._actionManager.getScene().stopAnimation(this._target)}serialize(e){return super._serialize({name:"StopAnimationAction",properties:[yt._GetTargetProperty(this._target)]},e)}},ch=class extends yt{constructor(e=0,t){super(e,t)}execute(){}serialize(e){return super._serialize({name:"DoNothingAction",properties:[]},e)}},XC=class extends yt{constructor(e,t,n,r=!0){super(e,n),this.children=t,this.enableChildrenConditions=r}_prepare(){for(let e=0;e<this.children.length;e++)this.children[e]._actionManager=this._actionManager,this.children[e]._prepare()}execute(e){for(let t of this.children)(!this.enableChildrenConditions||t._evaluateConditionForCurrentFrame())&&t.execute(e)}serialize(e){let t=super._serialize({name:"CombineAction",properties:[],combine:[]},e);for(let n=0;n<this.children.length;n++)t.combine.push(this.children[n].serialize(null));return t}},ha=class extends yt{constructor(e,t,n){super(e,n),this.func=t}execute(e){this.func(e)}},lg=class extends yt{constructor(e,t,n,r){super(e,r),this._target=t,this._parent=n}_prepare(){}execute(){if(this._target.parent===this._parent)return;let e=this._parent.getWorldMatrix().clone();e.invert(),this._target.position=m.TransformCoordinates(this._target.position,e),this._target.parent=this._parent}serialize(e){return super._serialize({name:"SetParentAction",properties:[yt._GetTargetProperty(this._target),yt._GetTargetProperty(this._parent)]},e)}};ue("BABYLON.SetParentAction",lg);ue("BABYLON.ExecuteCodeAction",ha);ue("BABYLON.DoNothingAction",ch);ue("BABYLON.StopAnimationAction",KC);ue("BABYLON.PlayAnimationAction",YC);ue("BABYLON.IncrementValueAction",qC);ue("BABYLON.SetValueAction",jC);ue("BABYLON.SetStateAction",WC);ue("BABYLON.SetParentAction",lg);ue("BABYLON.SwitchBooleanAction",$C);ue("BABYLON.CombineAction",XC);var ac=(()=>{class i extends CT{constructor(t){super(),t=t||Ie.LastCreatedScene,t&&(this._scene=t,t.actionManagers.push(this))}dispose(){let t=this._scene.actionManagers.indexOf(this);for(let r=0;r<this.actions.length;r++){let s=this.actions[r];i.Triggers[s.trigger]--,i.Triggers[s.trigger]===0&&delete i.Triggers[s.trigger]}this.actions.length=0,t>-1&&this._scene.actionManagers.splice(t,1);let n=this._scene.meshes.filter(r=>r.actionManager===this);for(let r of n)r.actionManager=null}getScene(){return this._scene}hasSpecificTriggers(t){for(let n=0;n<this.actions.length;n++){let r=this.actions[n];if(t.indexOf(r.trigger)>-1)return!0}return!1}hasSpecificTriggers2(t,n){for(let r=0;r<this.actions.length;r++){let s=this.actions[r];if(t==s.trigger||n==s.trigger)return!0}return!1}hasSpecificTrigger(t,n){for(let r=0;r<this.actions.length;r++){let s=this.actions[r];if(s.trigger===t)if(n){if(n(s.getTriggerParameter()))return!0}else return!0}return!1}get hasPointerTriggers(){for(let t=0;t<this.actions.length;t++){let n=this.actions[t];if(n.trigger>=i.OnPickTrigger&&n.trigger<=i.OnPointerOutTrigger&&n._evaluateConditionForCurrentFrame())return!0}return!1}get hasPickTriggers(){for(let t=0;t<this.actions.length;t++){let n=this.actions[t];if(n.trigger>=i.OnPickTrigger&&n.trigger<=i.OnPickUpTrigger&&n._evaluateConditionForCurrentFrame())return!0}return!1}registerAction(t){return t.trigger===i.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(N.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(t),this.getScene()._registeredActions++,i.Triggers[t.trigger]?i.Triggers[t.trigger]++:i.Triggers[t.trigger]=1,t._actionManager=this,t._prepare(),t)}unregisterAction(t){let n=this.actions.indexOf(t);return n!==-1?(this.actions.splice(n,1),i.Triggers[t.trigger]-=1,i.Triggers[t.trigger]===0&&delete i.Triggers[t.trigger],t._actionManager=null,this.getScene()._registeredActions--,!0):!1}processTrigger(t,n){for(let r=0;r<this.actions.length;r++){let s=this.actions[r];if(s.trigger===t){if(n&&(t===i.OnKeyUpTrigger||t===i.OnKeyDownTrigger)){let o=s.getTriggerParameter();if(typeof o=="function"){if(!o(n))continue}else if(o&&o!==n.sourceEvent.keyCode){if(!o.toLowerCase)continue;let a=o.toLowerCase();if(a!==n.sourceEvent.key){let l=n.sourceEvent.charCode?n.sourceEvent.charCode:n.sourceEvent.keyCode;if(String.fromCharCode(l).toLowerCase()!==a)continue}}}s._executeCurrent(n)}}}_getEffectiveTarget(t,n){let r=n.split(".");for(let s=0;s<r.length-1;s++)t=t[r[s]];return t}_getProperty(t){let n=t.split(".");return n[n.length-1]}serialize(t){let n={children:[],name:t,type:3,properties:[]};for(let r=0;r<this.actions.length;r++){let s={type:0,children:[],name:i.GetTriggerName(this.actions[r].trigger),properties:[]},o=this.actions[r].triggerOptions;if(o&&typeof o!="number")if(o.parameter instanceof Node)s.properties.push(yt._GetTargetProperty(o.parameter));else if(typeof o.parameter=="object"){let a={};xt.DeepCopy(o.parameter,a,["mesh"]),o.parameter&&o.parameter.mesh&&(a._meshId=o.parameter.mesh.id),s.properties.push({name:"parameter",targetType:null,value:a})}else s.properties.push({name:"parameter",targetType:null,value:o.parameter});this.actions[r].serialize(s),n.children.push(s)}return n}static Parse(t,n,r){let s=new i(r);n===null?r.actionManager=s:n.actionManager=s;let o=(c,u)=>{let h=Ct("BABYLON."+c);return h&&new h(...u)},a=(c,u,h,d)=>{if(d===null){let _=parseFloat(u);return u==="true"||u==="false"?u==="true":isNaN(_)?u:_}let f=d.split("."),p=u.split(",");for(let _=0;_<f.length;_++)h=h[f[_]];if(typeof h=="boolean")return p[0]==="true";if(typeof h=="string")return p[0];let g=[];for(let _=0;_<p.length;_++)g.push(parseFloat(p[_]));return h instanceof m?m.FromArray(g):h instanceof ht?ht.FromArray(g):h instanceof G?G.FromArray(g):h instanceof le?le.FromArray(g):parseFloat(p[0])},l=(c,u,h,d,f=null)=>{if(c.detached)return;let p=[],g=null,_=null,y=c.combine&&c.combine.length>0;if(c.type===2?p.push(s):p.push(u),y){let E=[];for(let I=0;I<c.combine.length;I++)l(c.combine[I],i.NothingTrigger,h,d,E);p.push(E)}else for(let E=0;E<c.properties.length;E++){let I=c.properties[E].value,v=c.properties[E].name,x=c.properties[E].targetType;v==="target"?x==="SceneProperties"?I=g=r:x==="MaterialProperties"?I=g=r.getMaterialByName(I):I=g=r.getNodeByName(I):v==="parent"?I=r.getNodeByName(I):v==="sound"?r.getSoundByName&&(I=r.getSoundByName(I)):v!=="propertyPath"?c.type===2&&v==="operator"?I=HC[I]:I=a(v,I,g,v==="value"?_:null):_=I,p.push(I)}if(f===null?p.push(h):p.push(null),c.name==="InterpolateValueAction"){let E=p[p.length-2];p[p.length-1]=E,p[p.length-2]=h}let C=o(c.name,p);if(C instanceof Js&&h!==null){let E=new ch(u,h);d?d.then(E):s.registerAction(E),d=E}f===null?C instanceof Js?(h=C,C=d):(h=null,d?d.then(C):s.registerAction(C)):f.push(C);for(let E=0;E<c.children.length;E++)l(c.children[E],u,h,C,null)};for(let c=0;c<t.children.length;c++){let u,h=t.children[c];if(h.properties.length>0){let d=h.properties[0].value,f=h.properties[0].targetType===null?d:r.getMeshByName(d);f._meshId&&(f.mesh=r.getMeshById(f._meshId)),u={trigger:i[h.name],parameter:f}}else u=i[h.name];for(let d=0;d<h.children.length;d++)h.detached||l(h.children[d],u,null,null)}}static GetTriggerName(t){switch(t){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnDoublePickTrigger";case 7:return"OnPickUpTrigger";case 8:return"OnLongPressTrigger";case 9:return"OnPointerOverTrigger";case 10:return"OnPointerOutTrigger";case 11:return"OnEveryFrameTrigger";case 12:return"OnIntersectionEnterTrigger";case 13:return"OnIntersectionExitTrigger";case 14:return"OnKeyDownTrigger";case 15:return"OnKeyUpTrigger";case 16:return"OnPickOutTrigger";default:return""}}}return i.NothingTrigger=0,i.OnPickTrigger=1,i.OnLeftPickTrigger=2,i.OnRightPickTrigger=3,i.OnCenterPickTrigger=4,i.OnPickDownTrigger=5,i.OnDoublePickTrigger=6,i.OnPickUpTrigger=7,i.OnPickOutTrigger=16,i.OnLongPressTrigger=8,i.OnPointerOverTrigger=9,i.OnPointerOutTrigger=10,i.OnEveryFrameTrigger=11,i.OnIntersectionEnterTrigger=12,i.OnIntersectionExitTrigger=13,i.OnKeyDownTrigger=14,i.OnKeyUpTrigger=15,i})();var mD="imageProcessingCompatibility",bB=`#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));
#endif
`;gt.IncludesShadersStore[mD]||(gt.IncludesShadersStore[mD]=bB);var gD="gridPixelShader",xB=`#extension GL_OES_standard_derivatives : enable
#define SQRT2 1.41421356
#define PI 3.14159
precision highp float;uniform float visibility;uniform vec3 mainColor;uniform vec3 lineColor;uniform vec4 gridControl;uniform vec3 gridOffset;varying vec3 vPosition;varying vec3 vNormal;
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#ifdef OPACITY
varying vec2 vOpacityUV;uniform sampler2D opacitySampler;uniform vec2 vOpacityInfos;
#endif
float getDynamicVisibility(float position) {float majorGridFrequency=gridControl.y;if (floor(position+0.5)==floor(position/majorGridFrequency+0.5)*majorGridFrequency)
{return 1.0;}
return gridControl.z;}
float getAnisotropicAttenuation(float differentialLength) {const float maxNumberOfLines=10.0;return clamp(1.0/(differentialLength+1.0)-1.0/maxNumberOfLines,0.0,1.0);}
float isPointOnLine(float position,float differentialLength) {float fractionPartOfPosition=position-floor(position+0.5); 
fractionPartOfPosition/=differentialLength; 
#ifdef ANTIALIAS
fractionPartOfPosition=clamp(fractionPartOfPosition,-1.,1.);float result=0.5+0.5*cos(fractionPartOfPosition*PI); 
return result;
#else
return abs(fractionPartOfPosition)<SQRT2/4. ? 1. : 0.;
#endif
}
float contributionOnAxis(float position) {float differentialLength=length(vec2(dFdx(position),dFdy(position)));differentialLength*=SQRT2; 
float result=isPointOnLine(position,differentialLength);float dynamicVisibility=getDynamicVisibility(position);result*=dynamicVisibility;float anisotropicAttenuation=getAnisotropicAttenuation(differentialLength);result*=anisotropicAttenuation;return result;}
float normalImpactOnAxis(float x) {float normalImpact=clamp(1.0-3.0*abs(x*x*x),0.0,1.0);return normalImpact;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
float gridRatio=gridControl.x;vec3 gridPos=(vPosition+gridOffset.xyz)/gridRatio;float x=contributionOnAxis(gridPos.x);float y=contributionOnAxis(gridPos.y);float z=contributionOnAxis(gridPos.z);vec3 normal=normalize(vNormal);x*=normalImpactOnAxis(normal.x);y*=normalImpactOnAxis(normal.y);z*=normalImpactOnAxis(normal.z);
#ifdef MAX_LINE
float grid=clamp(max(max(x,y),z),0.,1.);
#else
float grid=clamp(x+y+z,0.,1.);
#endif
vec3 color=mix(mainColor,lineColor,grid);
#ifdef FOG
#include<fogFragment>
#endif
float opacity=1.0;
#ifdef TRANSPARENT
opacity=clamp(grid,0.08,gridControl.w*grid);
#endif
#ifdef OPACITY
opacity*=texture2D(opacitySampler,vOpacityUV).a;
#endif
gl_FragColor=vec4(color.rgb,opacity*visibility);
#ifdef TRANSPARENT
#ifdef PREMULTIPLYALPHA
gl_FragColor.rgb*=opacity;
#endif
#else
#endif
#include<logDepthFragment>
#include<imageProcessingCompatibility>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;gt.ShadersStore[gD]||(gt.ShadersStore[gD]=xB);var _D="gridVertexShader",CB=`precision highp float;attribute vec3 position;attribute vec3 normal;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#include<instancesDeclaration>
#include<__decl__sceneVertex>
varying vec3 vPosition;varying vec3 vNormal;
#include<logDepthDeclaration>
#include<fogVertexDeclaration>
#ifdef OPACITY
varying vec2 vOpacityUV;uniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;
#endif
#include<clipPlaneVertexDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
vec4 worldPos=finalWorld*vec4(position,1.0);
#include<fogVertex>
vec4 cameraSpacePosition=view*worldPos;gl_Position=projection*cameraSpacePosition;
#ifdef OPACITY
#ifndef UV1
vec2 uv=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2=vec2(0.,0.);
#endif
if (vOpacityInfos.x==0.)
{vOpacityUV=vec2(opacityMatrix*vec4(uv,1.0,0.0));}
else
{vOpacityUV=vec2(opacityMatrix*vec4(uv2,1.0,0.0));}
#endif 
#include<clipPlaneVertex>
#include<logDepthVertex>
vPosition=position;vNormal=normal;
#define CUSTOM_VERTEX_MAIN_END
}`;gt.ShadersStore[_D]||(gt.ShadersStore[_D]=CB);var ZC=class extends Cs{constructor(){super(),this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.OPACITY=!1,this.ANTIALIAS=!1,this.TRANSPARENT=!1,this.FOG=!1,this.PREMULTIPLYALPHA=!1,this.MAX_LINE=!1,this.UV1=!1,this.UV2=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.LOGARITHMICDEPTH=!1,this.rebuild()}},xn=class i extends _r{constructor(e,t){super(e,t),this.mainColor=G.Black(),this.lineColor=G.Teal(),this.gridRatio=1,this.gridOffset=m.Zero(),this.majorUnitFrequency=10,this.minorUnitVisibility=.33,this.opacity=1,this.antialias=!0,this.preMultiplyAlpha=!1,this.useMaxLine=!1,this._gridControl=new ht(this.gridRatio,this.majorUnitFrequency,this.minorUnitVisibility,this.opacity)}needAlphaBlending(){return this.opacity<1||this._opacityTexture&&this._opacityTexture.isReady()}needAlphaBlendingForMesh(e){return e.visibility<1||this.needAlphaBlending()}isReadyForSubMesh(e,t,n){let r=t._drawWrapper;if(this.isFrozen&&r.effect&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===n)return!0;t.materialDefines||(t.materialDefines=new ZC);let s=t.materialDefines,o=this.getScene();if(this._isReadyForSubMesh(t))return!0;if(s.TRANSPARENT!==this.opacity<1&&(s.TRANSPARENT=!s.TRANSPARENT,s.markAsUnprocessed()),s.PREMULTIPLYALPHA!=this.preMultiplyAlpha&&(s.PREMULTIPLYALPHA=!s.PREMULTIPLYALPHA,s.markAsUnprocessed()),s.MAX_LINE!==this.useMaxLine&&(s.MAX_LINE=!s.MAX_LINE,s.markAsUnprocessed()),s.ANTIALIAS!==this.antialias&&(s.ANTIALIAS=!s.ANTIALIAS,s.markAsUnprocessed()),s._areTexturesDirty&&(s._needUVs=!1,o.texturesEnabled&&this._opacityTexture&&rt.OpacityTextureEnabled))if(this._opacityTexture.isReady())s._needUVs=!0,s.OPACITY=!0;else return!1;if(Aa(e,o,this._useLogarithmicDepth,!1,this.fogEnabled,!1,s,void 0,void 0,void 0,this._isVertexOutputInvariant),wa(o,o.getEngine(),this,s,!!n),s.isDirty){s.markAsProcessed(),o.resetCachedMaterial(),Ma(e,s,!1,!1);let a=[S.PositionKind,S.NormalKind];s.UV1&&a.push(S.UVKind),s.UV2&&a.push(S.UV2Kind),s.IMAGEPROCESSINGPOSTPROCESS=o.imageProcessingConfiguration.applyByPostProcess,Ea(a,s);let l=["projection","mainColor","lineColor","gridControl","gridOffset","vFogInfos","vFogColor","world","view","opacityMatrix","vOpacityInfos","visibility","logarithmicDepthConstant"],c=s.toString();Zn(l),t.setEffect(o.getEngine().createEffect("grid",{attributes:a,uniformsNames:l,uniformBuffersNames:["Scene"],samplers:["opacitySampler"],defines:c,fallbacks:null,onCompiled:this.onCompiled,onError:this.onError},o.getEngine()),s,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(s._renderId=o.getRenderId(),r._wasPreviouslyReady=!0,r._wasPreviouslyUsingInstances=!!n,!0)}bindForSubMesh(e,t,n){let r=this.getScene(),s=n.materialDefines;if(!s)return;let o=n.effect;o&&(this._activeEffect=o,this._activeEffect.setFloat("visibility",t.visibility),(!s.INSTANCES||s.THIN_INSTANCE)&&this.bindOnlyWorldMatrix(e),this.bindView(o),this.bindViewProjection(o),this._mustRebind(r,o,n)&&(this._activeEffect.setColor3("mainColor",this.mainColor),this._activeEffect.setColor3("lineColor",this.lineColor),this._activeEffect.setVector3("gridOffset",this.gridOffset),this._gridControl.x=this.gridRatio,this._gridControl.y=Math.round(this.majorUnitFrequency),this._gridControl.z=this.minorUnitVisibility,this._gridControl.w=this.opacity,this._activeEffect.setVector4("gridControl",this._gridControl),this._opacityTexture&&rt.OpacityTextureEnabled&&(this._activeEffect.setTexture("opacitySampler",this._opacityTexture),this._activeEffect.setFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),this._activeEffect.setMatrix("opacityMatrix",this._opacityTexture.getTextureMatrix())),Qn(o,this,r),this._useLogarithmicDepth&&Jn(s,o,r)),Ni(r,t,this._activeEffect),this._afterBind(t,this._activeEffect,n))}dispose(e){super.dispose(e)}clone(e){return Xe.Clone(()=>new i(e,this.getScene()),this)}serialize(){let e=super.serialize();return e.customType="BABYLON.GridMaterial",e}getClassName(){return"GridMaterial"}static Parse(e,t,n){return Xe.Parse(()=>new i(e.name,t),e,t,n)}};w([pi()],xn.prototype,"mainColor",void 0);w([pi()],xn.prototype,"lineColor",void 0);w([L()],xn.prototype,"gridRatio",void 0);w([yn()],xn.prototype,"gridOffset",void 0);w([L()],xn.prototype,"majorUnitFrequency",void 0);w([L()],xn.prototype,"minorUnitVisibility",void 0);w([L()],xn.prototype,"opacity",void 0);w([L()],xn.prototype,"antialias",void 0);w([L()],xn.prototype,"preMultiplyAlpha",void 0);w([L()],xn.prototype,"useMaxLine",void 0);w([Gn("opacityTexture")],xn.prototype,"_opacityTexture",void 0);w([Re("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"opacityTexture",void 0);ue("BABYLON.GridMaterial",xn);var TB=["renderCanvas"],SB=(i,e)=>e.company,yD=(i,e)=>e.name;function IB(i,e){if(i&1&&(Te(0,"span",25),Ye(1),xe()),i&2){let t=e.$implicit;De(),tn(t)}}function EB(i,e){if(i&1&&(Te(0,"p"),Ye(1),xe()),i&2){let t=e.$implicit;De(),tn(t)}}function AB(i,e){if(i&1&&(Te(0,"div",12)(1,"div",16)(2,"div",17),en(3,"img",18)(4,"div",19)(5,"div",20),xe(),Te(6,"div",21)(7,"h3"),Ye(8),xe(),Te(9,"span",22)(10,"span",23),Ye(11,"\u{1F4CD}"),xe(),Ye(12),xe(),Te(13,"div",24),xi(14,IB,2,1,"span",25,Dr),xe()()(),Te(16,"div",26),xi(17,EB,2,1,"p",null,Dr),xe(),Te(19,"div",27)(20,"a",28)(21,"span"),Ye(22,"\u25B6"),xe(),Ye(23," D4veCovers "),xe(),Te(24,"a",29)(25,"span"),Ye(26,"in"),xe(),Ye(27," LinkedIn "),xe(),Te(28,"a",30)(29,"span"),Ye(30,"\u2709"),xe(),Ye(31," Contact "),xe()()()),i&2){let t=wn();De(3),Rr("src",t.content.avatar,ss),De(5),tn(t.content.role),De(4),os(" ",t.content.location," "),De(2),Ci(t.content.softSkills),De(3),Ci(t.content.bio),De(3),Rr("href",t.content.socials.youtube,ss),De(4),Rr("href",t.content.socials.linkedin,ss),De(4),Rr("href","mailto:"+t.content.socials.email,ss)}}function wB(i,e){if(i&1&&(Te(0,"li"),Ye(1),xe()),i&2){let t=e.$implicit;De(),tn(t)}}function MB(i,e){if(i&1&&(Te(0,"div",31),en(1,"div",32),Te(2,"div",33)(3,"div",34)(4,"h3"),Ye(5),xe(),Te(6,"span",35),Ye(7),xe()(),Te(8,"h4",36),Ye(9),xe(),Te(10,"p",37),Ye(11),xe(),Te(12,"ul",38),xi(13,wB,2,1,"li",null,Dr),xe()()()),i&2){let t=e.$implicit;De(5),tn(t.role),De(2),tn(t.period),De(2),tn(t.company),De(2),tn(t.desc),De(2),Ci(t.highlights)}}function DB(i,e){if(i&1&&(Te(0,"div",13),xi(1,MB,15,4,"div",31,SB),xe()),i&2){let t=wn();De(),Ci(t.content)}}function RB(i,e){if(i&1&&(Te(0,"span",45),Ye(1),xe()),i&2){let t=e.$implicit;De(),tn(t)}}function PB(i,e){if(i&1&&(Te(0,"a",47),Ye(1,"Visit Site \u2197"),xe()),i&2){let t=wn().$implicit;Rr("href",t.link,ss)}}function OB(i,e){if(i&1&&(Te(0,"div",39),en(1,"div",40),Te(2,"div",41)(3,"span",42),Ye(4),xe(),Te(5,"h3"),Ye(6),xe()(),Te(7,"p"),Ye(8),xe(),Te(9,"div",43)(10,"div",44),xi(11,RB,2,1,"span",45,Dr),xe(),Te(13,"div",46),hn(14,PB,2,1,"a",47),xe()()()),i&2){let t=e.$implicit;De(4),tn(t.category),De(2),tn(t.name),De(2),tn(t.description),De(3),Ci(t.stack),De(3),dn(t.link?14:-1)}}function NB(i,e){if(i&1&&(Te(0,"div",14),xi(1,OB,15,4,"div",39,yD),xe()),i&2){let t=wn();De(),Ci(t.content)}}function LB(i,e){if(i&1&&(Te(0,"div",50)(1,"div",55)(2,"span"),Ye(3),xe(),Te(4,"span",56),Ye(5),xe()(),Te(6,"div",57),en(7,"div",58),xe()()),i&2){let t=e.$implicit;De(3),tn(t.name),De(2),os("",t.level,"%"),De(2),wf("width",t.level,"%")}}function FB(i,e){if(i&1&&(Te(0,"span",54),Ye(1),xe()),i&2){let t=e.$implicit;De(),tn(t)}}function kB(i,e){if(i&1&&(Te(0,"span",54),Ye(1),xe()),i&2){let t=e.$implicit;De(),tn(t)}}function BB(i,e){if(i&1&&(Te(0,"div",15)(1,"div",48)(2,"h4",49),Ye(3,"CORE CAPABILITIES"),xe(),xi(4,LB,8,4,"div",50,yD),xe(),Te(6,"div",51)(7,"div",52)(8,"h4",49),Ye(9,"BACKEND & DATA"),xe(),Te(10,"div",53),xi(11,FB,2,1,"span",54,Dr),xe()(),Te(13,"div",52)(14,"h4",49),Ye(15,"INFRA & DEVOPS"),xe(),Te(16,"div",53),xi(17,kB,2,1,"span",54,Dr),xe()()()()),i&2){let t=wn();De(4),Ci(t.content.core),De(7),Ci(t.content.backend),De(6),Ci(t.content.devops)}}function VB(i,e){if(i&1){let t=Jc();Te(0,"div",6)(1,"div",7)(2,"h2",8),Ye(3),xe()(),Te(4,"button",9),fl("click",function(){Qa(t);let r=wn(2);return Ja(r.closeDetails())}),Te(5,"span",10),Ye(6,"\xD7"),xe()()(),Te(7,"div",11),hn(8,AB,32,6,"div",12),hn(9,DB,3,0,"div",13),hn(10,NB,3,0,"div",14),hn(11,BB,19,0,"div",15),xe()}if(i&2){let t=e;De(3),tn(t.title),De(5),dn(t.type==="about"?8:-1),De(),dn(t.type==="experience"?9:-1),De(),dn(t.type==="projects"?10:-1),De(),dn(t.type==="skills"?11:-1)}}function GB(i,e){if(i&1&&(Te(0,"div",3)(1,"div",4),Ye(2,"SYSTEM: ONLINE"),xe()(),Te(3,"div",5),hn(4,VB,12,5),xe()),i&2){let t,n=wn();De(3),Pr("active",n.isDetailsOpen()),De(),dn((t=n.activeSection())?4:-1,t)}}var cg=class i{constructor(e,t,n,r,s,o){this.babylonService=e;this.ngZone=t;this.puzzleStore=n;this.splashService=r;this.shieldService=s;this.nebulaService=o}canvasRef;activeSection=oi(null);isDetailsOpen=oi(!1);isTransitioning=!1;floatingObserver=null;isMobile=wM();ngOnInit(){this.splashService.updateImage("assets/icons/opened-map.png"),this.splashService.autoHide=!1,this.splashService.buttonText="Go",this.splashService.show=!0,this.puzzleStore.setLoading(!0),this.splashService.updateMessage("Unlocking Map"),this.ngZone.runOutsideAngular(()=>{setTimeout(()=>this.initScene(),0)})}initScene(){return T(this,null,function*(){let e=this.canvasRef.nativeElement;if(!e){console.error("Canvas element not found!");return}try{this.babylonService.initScene(e,{createEnvironmentTexture:!1,createLights:!0,allowCamControls:!0,createGlowLayer:!0},{removeKeyBoardInputs:!0,autoElevation:!1,disablePanning:!0});let t=this.babylonService.currentScene;if(!t){console.error("Scene initialization failed!");return}t.clearColor=new le(.02,.02,.08,1);let n=this.babylonService.currentCamera;n&&(n.radius=35,n.beta=Math.PI/2.3,n.alpha=Math.PI*2,n.wheelPrecision=30,n.angularSensibilityX=1500,n.angularSensibilityY=1500,n.lowerRadiusLimit=5,n.upperRadiusLimit=80,n.lowerBetaLimit=.1,n.upperBetaLimit=Math.PI-.1),yield this.loadNebulaDome(),this.createGridUniverse(),yield this.loadGalaxyModel(),yield this.createCentralHologram(),this.spawnCVConstellations(),this.isMobile||this.createShieldSystem(),this.createNebulaBackground(),this.babylonService.startAnimation(),this.ngZone.run(()=>{this.puzzleStore.setLoading(!1),setTimeout(()=>{this.splashService.hide()},500)})}catch(t){console.error("Failed to initialize holographic room:",t),this.ngZone.run(()=>{this.splashService.updateMessage("Error loading holographic interface"),this.puzzleStore.setLoading(!1)})}})}createGridUniverse(){let e=this.babylonService.currentScene;if(!e)return;let t=this.isMobile?32:64,n=gn.CreateSphere("universe",{diameter:100,segments:t},e),r=new xn("gridMat",e);r.majorUnitFrequency=5,r.minorUnitVisibility=1,r.gridRatio=4,r.mainColor=G.FromHexString("#005555"),r.lineColor=G.FromHexString("#00ffff"),r.opacity=.4,r.backFaceCulling=!1,n.material=r,n.isPickable=!1}loadGalaxyModel(){return T(this,null,function*(){if(this.babylonService.currentScene)try{let t=yield this.babylonService.loadModel("assets/models/solar_system.glb");t.addAllToScene();let n=t.meshes;if(n.length>0){let r=n[0];r.position=m.Zero(),r.scaling=new m(.1,.1,.1),n.forEach(s=>{if(s.isPickable=!1,s.material){let a=s.material;a.alpha=.4,a.backFaceCulling=!1}let o=this.babylonService.currentGlowLayer;o&&s&&o.addExcludedMesh(s)})}}catch(t){console.error("Failed to load galaxy.glb:",t)}})}loadNebulaDome(){return T(this,null,function*(){if(this.babylonService.currentScene)try{let t=yield this.babylonService.loadModel("assets/models/nebula_dome.glb");t.addAllToScene();let n=t.meshes;if(n.length>0){let r=n[0];r.position=m.Zero(),r.scaling=new m(100,100,100),n.forEach(s=>{if(s.isPickable=!1,s.material){let a=s.material;a.backFaceCulling=!1}let o=this.babylonService.currentGlowLayer;o&&s&&o.addExcludedMesh(s)})}}catch(t){console.error("Failed to load nebula_dome.glb:",t)}})}createCentralHologram(){return T(this,null,function*(){let e=this.babylonService.currentScene;if(!e)throw new Error("Scene not initialized");let t=new A("coreGroup",e);try{let l=yield this.babylonService.loadModel("assets/models/treasure_map.glb");l.addAllToScene();let c=l.meshes;if(c.length>0){let u=c[0];u.parent=t,u.scaling=new m(1,1,1),c.forEach(h=>{if(h.isPickable=!1,h.material){let d=new Z("treasureMapGreen",e);d.emissiveColor=G.FromHexString("#038a03"),d.alpha=.3,h.material=d}})}}catch(l){console.error("Failed to load treasure_map.glb, using fallback sphere",l);let c=gn.CreateSphere("corePlanet",{diameter:10,segments:64},e);c.parent=t;let u=new Z("planetMat",e);u.diffuseColor=G.FromHexString("#00aa00"),u.specularColor=G.FromHexString("#33ff33"),u.emissiveColor=G.Black(),u.alpha=1,c.material=u}let n=0;this.floatingObserver=e.onBeforeRenderObservable.add(()=>{n+=.03,t.position.y=Math.sin(n)*.25});let r=gn.CreateTorus("ring1",{diameter:25,thickness:.12,tessellation:48},e);r.parent=t,r.position=m.Zero(),r.rotation.x=Math.PI+Math.PI/8,r.rotation.y=0,r.rotation.z=0;let s=new Z("ring1Mat",e);s.emissiveColor=G.FromHexString("#00ff00"),s.diffuseColor=G.Black(),s.specularColor=G.Black(),s.alpha=.85,r.material=s;let a=this.createParticlesRing()?.emitter;return a&&(a.parent=t,a.position=m.Zero(),a.rotation.x=Math.PI-Math.PI/8,a.rotation.y=0,a.rotation.z=0),t})}spawnCVConstellations(){let t=pD,n=t.length;t.forEach((r,s)=>{let o=s/n*Math.PI*2,a=Math.cos(o)*14,l=Math.sin(o)*14,c=Math.sin(o*3)*1.5,u=new m(a,c,l),d=this.createOrbitalNode(r.label,u,"#00ffff",()=>{this.onNodeClicked(r,d)})})}onNodeClicked(e,t){this.isDetailsOpen()||this.ngZone.run(()=>{this.flyToMesh(t,7,()=>{this.ngZone.run(()=>{this.activeSection.set(e),this.isDetailsOpen.set(!0)})})})}closeDetails(){this.isDetailsOpen.set(!1),setTimeout(()=>{this.activeSection.set(null),this.resetCameraView()},100)}createOrbitalNode(e,t,n,r){let s=this.babylonService.currentScene;if(!s)throw new Error("Scene not initialized");let o=this.isMobile?8:16,a=new A(e+"_group",s);a.position=t;let l=gn.CreateSphere(e,{diameter:2,segments:o},s);l.parent=a;let c=new Z(e+"_mat",s);c.emissiveColor=G.FromHexString(n),c.alpha=.8,l.material=c;let u=gn.CreateSphere(e+"_atmo",{diameter:1.5,segments:o},s);u.parent=a;let h=new Z(e+"_atmoMat",s);return h.emissiveColor=G.FromHexString(n),h.alpha=.3,u.material=h,l.isPickable=!0,a.isPickable=!1,l.actionManager=new ac(s),l.actionManager.registerAction(new ha(ac.OnPickTrigger,()=>{this.isTransitioning||r()})),this.setupConstellationHoverEffect(l,u,n),this.createHolographicLabel(e,a,n),this.createConnectionBeam(m.Zero(),t,n),a}setupConstellationHoverEffect(e,t,n){let r=this.babylonService.currentScene;e.actionManager||(e.actionManager=new ac(r));let s=G.FromHexString(n),o=G.FromHexString("#FF8C00"),a=G.FromHexString("#FFA500"),l=e.material,c=t.material;e.actionManager.registerAction(new ha(ac.OnPointerOverTrigger,()=>{this.isTransitioning||(l.emissiveColor=a,c.emissiveColor=o)})),e.actionManager.registerAction(new ha(ac.OnPointerOutTrigger,()=>{l.emissiveColor=s,c.emissiveColor=s}))}createConnectionBeam(e,t,n){let r=[e,t],s=gn.CreateLines("beam",{points:r},this.babylonService.currentScene);s.color=G.FromHexString("#00ffff"),s.alpha=.3,s.isPickable=!1}createParticlesRing(){let e=this.babylonService.currentScene;if(!e)return;let t=this.isMobile,n=1e3,r=t?24:48,s=gn.CreateTorus("torusEmitter",{diameter:25,thickness:.5,tessellation:r},e);s.isVisible=!1,s.scaling.y=.01;let o=new vt("clouds",n,e);return o.particleTexture=new te("assets/textures/flame.png",e),o.emitter=s,o.particleEmitterType=new ec(s),o.color1=new le(.2,1,.3,.8),o.color2=new le(0,1,.1,.7),o.colorDead=new le(0,.5,.1,0),o.minSize=.8,o.maxSize=1.5,o.updateSpeed=.002,o.minLifeTime=10800*60*o.updateSpeed,o.maxLifeTime=o.minLifeTime,o.emitRate=0,o.manualEmitCount=n,o.gravity=new m(0,0,0),o.minEmitPower=0,o.maxEmitPower=0,o.minAngularSpeed=0,o.maxAngularSpeed=Math.PI*2,o.blendMode=vt.BLENDMODE_ONEONE,o.isBillboardBased=!0,o.start(),o}createHolographicLabel(e,t,n){let r=this.babylonService.currentScene,a=gn.CreatePlane("label",{width:12,height:3},r);a.parent=t,a.position.y=-2.8,a.billboardMode=A.BILLBOARDMODE_ALL,a.isPickable=!1;let l=new Vr("dynamic texture",{width:2048,height:512},r);l.hasAlpha=!0;let c=l.getContext();c.clearRect(0,0,2048,512);let u="#ffffff",h="#003875",d="#000000",f=140;c.font=`700 ${f}px "TreasurePlanet", sans-serif`;let g=(2048-c.measureText(e.toUpperCase()).width)/2,_=280;c.shadowColor=h,c.shadowBlur=30,c.shadowOffsetX=0,c.shadowOffsetY=0,c.fillStyle=h,c.fillText(e.toUpperCase(),g,_),c.shadowBlur=18,c.fillText(e.toUpperCase(),g,_),c.shadowBlur=0,c.lineWidth=8,c.strokeStyle=d,c.strokeText(e.toUpperCase(),g,_),c.shadowBlur=12,c.shadowColor=h,c.fillStyle=h,c.fillText(e.toUpperCase(),g,_),c.shadowBlur=6,c.shadowColor="#ffffff",c.fillStyle=u,c.fillText(e.toUpperCase(),g,_),c.shadowBlur=0,c.fillStyle="#ffffff",c.fillText(e.toUpperCase(),g,_),l.update();let y=new Z("labelMat",this.babylonService.currentScene);y.diffuseTexture=l,y.emissiveColor=G.FromHexString("#ffffff"),y.emissiveColor.scale(1.3),y.opacityTexture=l,y.alpha=1,y.disableLighting=!0,y.backFaceCulling=!1,a.material=y,this.babylonService.currentGlowLayer&&this.babylonService.currentGlowLayer.addExcludedMesh(a)}flyToMesh(e,t=4,n){let r=this.babylonService.currentScene,s=this.babylonService.currentCamera;if(!r||!s||this.isTransitioning)return;this.isTransitioning=!0;let o=30,a=60,l=e.absolutePosition.clone(),c=new H("zoom","radius",o,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CONSTANT),u=new H("move","target",o,H.ANIMATIONTYPE_VECTOR3,H.ANIMATIONLOOPMODE_CONSTANT),h=new Ag;h.setEasingMode(ni.EASINGMODE_EASEINOUT),[c,u].forEach(d=>d.setEasingFunction(h)),c.setKeys([{frame:0,value:s.radius},{frame:a,value:t}]),u.setKeys([{frame:0,value:s.target},{frame:a,value:l}]),r.beginDirectAnimation(s,[c,u],0,a,!1,1,()=>{this.isTransitioning=!1,n&&n()})}resetCameraView(e){let t=this.babylonService.currentScene,n=this.babylonService.currentCamera;if(!t||!n)return;this.isTransitioning=!0;let r=60,s=90,o=new H("zoomOut","radius",r,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CONSTANT),a=new H("resetTarget","target",r,H.ANIMATIONTYPE_VECTOR3,H.ANIMATIONLOOPMODE_CONSTANT),l=new Ag;l.setEasingMode(ni.EASINGMODE_EASEINOUT),[o,a].forEach(c=>c.setEasingFunction(l)),o.setKeys([{frame:0,value:n.radius},{frame:s,value:40}]),a.setKeys([{frame:0,value:n.target},{frame:s,value:m.Zero()}]),t.beginDirectAnimation(n,[o,a],0,s,!1,1,()=>{this.isTransitioning=!1,e&&e()})}createNebulaBackground(){let e=this.babylonService.currentScene;if(!e)return;let t=this.isMobile?1e3:2e3,n=this.isMobile?100:200;this.nebulaService.createNebulaBackground(e,!0,t,n),this.nebulaService.startSystems()}createShieldSystem(){let e=this.babylonService.currentScene;e&&(this.shieldService.createShieldSystem(e,50,25),this.shieldService.startAnimation())}ngOnDestroy(){this.floatingObserver&&this.babylonService.currentScene&&(this.babylonService.currentScene.onBeforeRenderObservable.remove(this.floatingObserver),this.floatingObserver=null),this.nebulaService.dispose(),this.shieldService.dispose(),this.babylonService.dispose()}static \u0275fac=function(t){return new(t||i)(Wt(Xl),Wt(Et),Wt(qr),Wt(Zs),Wt(Ym),Wt(og))};static \u0275cmp=sr({type:i,selectors:[["app-holographic-room"]],viewQuery:function(t,n){if(t&1&&tu(TB,7),t&2){let r;nu(r=iu())&&(n.canvasRef=r.first)}},decls:4,vars:1,consts:[["renderCanvas",""],[1,"holographic-container"],[1,"render-canvas"],[1,"hud-overlay"],[1,"status-bar"],[1,"holo-panel"],[1,"panel-header"],[1,"header-content"],[1,"neon-title"],[1,"close-btn",3,"click"],[1,"icon"],[1,"panel-content","custom-scrollbar"],[1,"about-container"],[1,"timeline-container"],[1,"projects-grid"],[1,"skills-layout"],[1,"profile-header"],[1,"avatar-frame"],["alt","David Alvarado",1,"avatar-img",3,"src"],[1,"scan-line"],[1,"avatar-ring"],[1,"profile-intro"],[1,"location"],[1,"pin-icon"],[1,"soft-skills-row"],[1,"skill-pill"],[1,"bio-section"],[1,"connections"],["target","_blank",1,"holo-btn","youtube",3,"href"],["target","_blank",1,"holo-btn",3,"href"],[1,"holo-btn",3,"href"],[1,"timeline-item"],[1,"timeline-marker"],[1,"job-card"],[1,"job-header"],[1,"period"],[1,"company"],[1,"job-desc"],[1,"highlights"],[1,"project-card"],[1,"card-glow"],[1,"project-header"],[1,"category"],[1,"mt-auto"],[1,"tech-stack-mini"],[1,"tech-pill"],[1,"project-links"],["target","_blank",1,"link-btn",3,"href"],[1,"core-skills"],[1,"section-label"],[1,"skill-bar-container"],[1,"secondary-skills"],[1,"skill-group"],[1,"tags"],[1,"tag"],[1,"skill-info"],[1,"percent"],[1,"bar-track"],[1,"bar-fill"]],template:function(t,n){t&1&&(Te(0,"div",1),en(1,"canvas",2,0),hn(3,GB,5,3),xe()),t&2&&(De(3),dn(n.puzzleStore.isLoading()?-1:3))},styles:[".holographic-container[_ngcontent-%COMP%]{width:100%;height:100vh;position:relative;overflow:hidden;background:#000}.holographic-container[_ngcontent-%COMP%]   canvas[_ngcontent-%COMP%]{width:100%;height:100%;outline:none;cursor:grab}.holographic-container[_ngcontent-%COMP%]   canvas[_ngcontent-%COMP%]:active{cursor:grabbing}.hud-overlay[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;padding:.5rem}.hud-overlay[_ngcontent-%COMP%]   .status-bar[_ngcontent-%COMP%]{position:absolute;top:20px;font-family:Courier New,Courier,monospace;font-size:.8rem;color:#0ff9;border:1px solid rgba(0,255,255,.3);padding:4px 8px;background:#00142880}.hud-overlay[_ngcontent-%COMP%]   .status-bar.right[_ngcontent-%COMP%]{right:20px;text-align:right}.holo-panel[_ngcontent-%COMP%]{position:absolute;top:50%;left:50%;transform:translate(-50%,-40%) scale(.9);width:90%;max-width:650px;max-height:80dvh;font-family:Courier New,Courier,monospace;background:#0c141ea6;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid rgba(0,255,255,.3);box-shadow:0 0 30px #00ffff1a;border-radius:12px;display:flex;flex-direction:column;opacity:0;pointer-events:none;transition:all .4s cubic-bezier(.16,1,.3,1)}.holo-panel.active[_ngcontent-%COMP%]{opacity:1;pointer-events:auto;transform:translate(-50%,-50%) scale(1)}.holo-panel[_ngcontent-%COMP%]   .panel-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid rgba(0,255,255,.1)}.holo-panel[_ngcontent-%COMP%]   .panel-header[_ngcontent-%COMP%]   .header-content[_ngcontent-%COMP%]{display:flex;flex-direction:column}.holo-panel[_ngcontent-%COMP%]   .panel-header[_ngcontent-%COMP%]   .neon-title[_ngcontent-%COMP%]{color:#0ff;text-shadow:0 0 10px rgba(0,255,255,.5);margin:0;font-size:1.5rem;letter-spacing:2px}.holo-panel[_ngcontent-%COMP%]   .panel-header[_ngcontent-%COMP%]   .close-btn[_ngcontent-%COMP%]{background:none;border:1px solid rgba(0,255,255,.3);color:#0ff;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1.2rem;transition:all .2s;display:flex;align-items:center;justify-content:center}.holo-panel[_ngcontent-%COMP%]   .panel-header[_ngcontent-%COMP%]   .close-btn[_ngcontent-%COMP%]:hover{background:#0ff3;box-shadow:0 0 10px #0ff6}.holo-panel[_ngcontent-%COMP%]   .panel-content[_ngcontent-%COMP%]{padding:1rem;overflow-y:auto;color:#e0e0e0;line-height:1.6}.holo-panel[_ngcontent-%COMP%]   .panel-content[_ngcontent-%COMP%]::-webkit-scrollbar{width:6px}.holo-panel[_ngcontent-%COMP%]   .panel-content[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:#0000004d}.holo-panel[_ngcontent-%COMP%]   .panel-content[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:#00ffff4d;border-radius:3px}.about-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:20px}.profile-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:20px;border-bottom:1px solid rgba(0,255,255,.2);padding-bottom:20px}@media(max-width:600px){.profile-header[_ngcontent-%COMP%]{flex-direction:column;text-align:center}}.avatar-frame[_ngcontent-%COMP%]{position:relative;width:120px;height:120px;border-radius:50%;border:2px solid #00ffff;box-shadow:0 0 15px #00ffff4d;overflow:hidden;flex-shrink:0}.avatar-frame[_ngcontent-%COMP%]   .avatar-img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover;filter:sepia(20%) hue-rotate(180deg) saturate(90%)}.avatar-frame[_ngcontent-%COMP%]   .scan-line[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom,transparent 40%,rgba(0,255,255,.4) 50%,transparent 60%);background-size:100% 200%;animation:_ngcontent-%COMP%_scanFace 3s linear infinite;pointer-events:none}.profile-intro[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 5px;color:#fff;font-size:1.3rem}.profile-intro[_ngcontent-%COMP%]   .location[_ngcontent-%COMP%]{color:#aaa;font-size:.9rem;display:block;margin-bottom:10px}.soft-skills-row[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:8px}@media(max-width:600px){.soft-skills-row[_ngcontent-%COMP%]{justify-content:center}}.soft-skills-row[_ngcontent-%COMP%]   .skill-pill[_ngcontent-%COMP%]{font-size:.75rem;padding:2px 8px;border:1px solid rgba(0,255,255,.4);color:#0ff;border-radius:4px;background:#00ffff0d}.bio-section[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin-bottom:12px;color:#e0e0e0;font-size:1rem;text-align:justify}.connections[_ngcontent-%COMP%]{display:flex;gap:15px;margin-top:10px;flex-wrap:wrap}@media(max-width:600px){.connections[_ngcontent-%COMP%]{justify-content:center}}.holo-btn[_ngcontent-%COMP%]{text-decoration:none;padding:8px 16px;border:1px solid #00ffff;color:#0ff;font-family:Courier New,monospace;font-weight:700;font-size:.9rem;background:#00ffff1a;transition:all .3s ease;display:flex;align-items:center;gap:8px}.holo-btn[_ngcontent-%COMP%]:hover{background:#0ff;color:#000;box-shadow:0 0 15px #0ff9}.holo-btn.youtube[_ngcontent-%COMP%]{border-color:#f44;color:#f44;background:#ff44441a}.holo-btn.youtube[_ngcontent-%COMP%]:hover{background:#f44;color:#fff;box-shadow:0 0 15px #f449}@keyframes _ngcontent-%COMP%_scanFace{0%{transform:translateY(-100%)}to{transform:translateY(100%)}}.timeline-container[_ngcontent-%COMP%]{position:relative;padding-left:20px;border-left:2px solid rgba(0,255,255,.15)}.timeline-item[_ngcontent-%COMP%]{position:relative;margin-bottom:35px}.timeline-item[_ngcontent-%COMP%]:last-child{margin-bottom:0}.timeline-item[_ngcontent-%COMP%]   .timeline-marker[_ngcontent-%COMP%]{position:absolute;left:-26px;top:5px;width:10px;height:10px;background:#0ff;border-radius:50%;box-shadow:0 0 10px #0ff}.job-card[_ngcontent-%COMP%]{background:#ffffff08;padding:1.2rem;border-radius:8px;border:1px solid rgba(0,255,255,.1);transition:background .3s}.job-card[_ngcontent-%COMP%]:hover{background:#00ffff0f;border-color:#00ffff4d}.job-card[_ngcontent-%COMP%]   .job-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;flex-wrap:wrap}.job-card[_ngcontent-%COMP%]   .job-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;color:#fff;font-size:1.1rem}.job-card[_ngcontent-%COMP%]   .job-header[_ngcontent-%COMP%]   .period[_ngcontent-%COMP%]{color:#0ff;font-family:Courier New,monospace;font-size:.85rem}.job-card[_ngcontent-%COMP%]   .company[_ngcontent-%COMP%]{margin:0 0 10px;color:#aaa;font-weight:400;font-style:italic}.job-card[_ngcontent-%COMP%]   .job-desc[_ngcontent-%COMP%]{margin-bottom:10px;color:#ddd}.job-card[_ngcontent-%COMP%]   .highlights[_ngcontent-%COMP%]{padding-left:18px;margin:0}.job-card[_ngcontent-%COMP%]   .highlights[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{margin-bottom:6px;color:#bdd;font-size:.9rem}.job-card[_ngcontent-%COMP%]   .highlights[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]::marker{color:#0ff}.projects-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px}.project-card[_ngcontent-%COMP%]{position:relative;background:#0006;border:1px solid rgba(0,255,255,.2);padding:1.2rem;border-radius:8px;overflow:hidden;transition:transform .3s ease;display:flex;flex-direction:column}.project-card[_ngcontent-%COMP%]:hover{transform:translateY(-5px);border-color:#0ff}.project-card[_ngcontent-%COMP%]:hover   .card-glow[_ngcontent-%COMP%]{opacity:1}.project-card[_ngcontent-%COMP%]   .card-glow[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at top right,rgba(0,255,255,.1),transparent 60%);opacity:0;transition:opacity .4s;pointer-events:none}.project-card[_ngcontent-%COMP%]   .project-header[_ngcontent-%COMP%]{margin-bottom:10px}.project-card[_ngcontent-%COMP%]   .project-header[_ngcontent-%COMP%]   .category[_ngcontent-%COMP%]{font-size:.7rem;color:#0ff;text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:4px}.project-card[_ngcontent-%COMP%]   .project-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;color:#fff;font-size:1.1rem}.project-card[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:.9rem;color:#ccc;margin-bottom:15px;line-height:1.4}.project-card[_ngcontent-%COMP%]   .tech-stack-mini[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}.project-card[_ngcontent-%COMP%]   .tech-stack-mini[_ngcontent-%COMP%]   .tech-pill[_ngcontent-%COMP%]{background:#ffffff1a;color:#aff;font-size:.75rem;padding:2px 8px;border-radius:4px}.project-card[_ngcontent-%COMP%]   .project-links[_ngcontent-%COMP%]{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}.project-card[_ngcontent-%COMP%]   .project-links[_ngcontent-%COMP%]   .link-btn[_ngcontent-%COMP%]{font-size:.75rem;color:#0ff;text-decoration:none;border:1px solid rgba(0,255,255,.3);padding:4px 8px;border-radius:4px;transition:all .2s}.project-card[_ngcontent-%COMP%]   .project-links[_ngcontent-%COMP%]   .link-btn[_ngcontent-%COMP%]:hover{background:#00ffff1a;border-color:#0ff}.skills-layout[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:30px}.section-label[_ngcontent-%COMP%]{color:#0ff;border-bottom:1px solid rgba(0,255,255,.2);padding-bottom:5px;margin:0 0 15px;font-size:.9rem;letter-spacing:2px;font-family:Courier New,monospace}.core-skills[_ngcontent-%COMP%]   .skill-bar-container[_ngcontent-%COMP%]{margin-bottom:12px}.core-skills[_ngcontent-%COMP%]   .skill-bar-container[_ngcontent-%COMP%]   .skill-info[_ngcontent-%COMP%]{display:flex;justify-content:space-between;margin-bottom:4px;font-size:.9rem;color:#fff}.core-skills[_ngcontent-%COMP%]   .skill-bar-container[_ngcontent-%COMP%]   .skill-info[_ngcontent-%COMP%]   .percent[_ngcontent-%COMP%]{color:#0ff;font-family:Courier New}.core-skills[_ngcontent-%COMP%]   .skill-bar-container[_ngcontent-%COMP%]   .bar-track[_ngcontent-%COMP%]{height:6px;background:#ffffff1a;border-radius:3px;overflow:hidden}.core-skills[_ngcontent-%COMP%]   .skill-bar-container[_ngcontent-%COMP%]   .bar-track[_ngcontent-%COMP%]   .bar-fill[_ngcontent-%COMP%]{height:100%;background:linear-gradient(90deg,#08a,#0ff);box-shadow:0 0 10px #00ffff80}.secondary-skills[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;gap:20px}@media(max-width:500px){.secondary-skills[_ngcontent-%COMP%]{grid-template-columns:1fr}}.secondary-skills[_ngcontent-%COMP%]   .tags[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:8px}.secondary-skills[_ngcontent-%COMP%]   .tags[_ngcontent-%COMP%]   .tag[_ngcontent-%COMP%]{background:#00ffff14;border:1px solid rgba(0,255,255,.2);color:#cff;padding:4px 10px;border-radius:4px;font-size:.8rem;transition:all .2s}.secondary-skills[_ngcontent-%COMP%]   .tags[_ngcontent-%COMP%]   .tag[_ngcontent-%COMP%]:hover{background:#0ff3;border-color:#0ff}.mt-auto[_ngcontent-%COMP%]{margin-top:auto}"]})};var QC=()=>{let i=ae(qr),e=ae(Lr);return i.isUnlocked()?(e.navigate(["/holographic-room"]),!1):(e.navigate(["/treasure-map"]),!1)},vD=()=>{let i=ae(qr),e=ae(Lr);return i.isUnlocked()?!0:(e.navigate(["/map-puzzle"]),!1)},bD=()=>{let i=ae(qr),e=ae(Lr);return i.isUnlocked()?(e.navigate(["/holographic-room"]),!1):!0};var xD=[{path:"",canActivate:[QC],children:[]},{path:"treasure-map",component:ag,title:"David Alvarado - Map Puzzle",canActivate:[bD]},{path:"holographic-room",component:cg,title:"David Alvarado - Holographic Room",canActivate:[vD]},{path:"**",canActivate:[QC],children:[]}];var CD={providers:[zE({eventCoalescing:!0}),Kv(xD)]};function UB(i,e){if(i&1){let t=Jc();Te(0,"button",11),fl("click",function(){Qa(t);let r=wn(2);return Ja(r.onContinue())}),Ye(1),xe()}if(i&2){let t=wn(2);De(),os(" ",t.splashService.buttonText," ")}}function zB(i,e){i&1&&(Te(0,"div",10),en(1,"span")(2,"span")(3,"span"),xe())}function HB(i,e){if(i&1&&(Te(0,"div",1),Fs(1,"async"),Te(2,"div",2)(3,"div",3),en(4,"img",4),Fs(5,"async"),en(6,"div",5)(7,"div",6),xe(),Te(8,"h1",7),Fs(9,"async"),Ye(10),Fs(11,"async"),xe(),Te(12,"div",8),hn(13,UB,2,1,"button",9),Fs(14,"async"),Qc(15,zB,4,0,"div",10),xe()()()),i&2){let t=wn();Pr("exiting",ks(1,9,t.splashService.isExiting$))("transparent-mode",t.splashService.isTransparent),De(4),Rr("src",ks(5,11,t.splashService.image$),ss),De(4),Pr("holo-fade-out",!ks(9,13,t.splashService.textVisible$)),De(2),os(" ",ks(11,15,t.splashService.message$)," "),De(3),dn(ks(14,17,t.splashService.showButton$)?13:15)}}var ug=class i{constructor(e){this.splashService=e}onContinue(){this.splashService.forceClose()}static \u0275fac=function(t){return new(t||i)(Wt(Zs))};static \u0275cmp=sr({type:i,selectors:[["app-splash-screen"]],decls:2,vars:3,consts:[[1,"splash-screen",3,"exiting","transparent-mode"],[1,"splash-screen"],[1,"splash-content"],[1,"splash-icon-container"],["alt","Map Sphere","width","500","height","500",1,"treasure-icon",3,"src"],[1,"glow-core"],[1,"mech-ring"],[1,"splash-title"],[1,"action-placeholder"],[1,"action-btn"],[1,"loading-indicator"],[1,"action-btn",3,"click"]],template:function(t,n){t&1&&(hn(0,HB,16,19,"div",0),Fs(1,"async")),t&2&&dn(ks(1,1,n.splashService.show$)?0:-1)},dependencies:[ml,_v],styles:[`:host{display:block}.splash-screen{position:fixed;inset:0;width:100vw;height:100vh;z-index:99999;background:radial-gradient(circle at center,#131622,#050608);display:flex;align-items:center;justify-content:center}.splash-screen.transparent-mode{background:#0f111ad9;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}.splash-screen{opacity:1;transition:opacity .5s ease-out}.splash-screen.exiting{opacity:0;pointer-events:none}.splash-content{position:relative;display:flex;flex-direction:column;align-items:center;z-index:10}.splash-icon-container{position:relative;width:20rem;height:100%;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;margin-bottom:2rem}.treasure-icon{width:70%;height:70%;object-fit:contain;z-index:5;filter:drop-shadow(0 0 15px rgba(229,192,123,.4));animation:float-map 4s ease-in-out infinite}.glow-core{position:absolute;width:100%;height:100%;background:radial-gradient(circle,var(--color-neon) 0%,transparent 60%);opacity:.15;filter:blur(20px);animation:pulse-glow 3s infinite alternate;z-index:1}.mech-ring{position:absolute;width:100%;height:100%;border:1px dashed rgba(76,244,42,.47);border-radius:50%;box-shadow:0 0 15px #40fa001a;animation:spin-mech 20s linear infinite;z-index:2}.mech-ring:after{content:"";position:absolute;inset:10%;border:1px solid rgba(229,192,123,.2);border-radius:50%;border-left-color:transparent;border-right-color:transparent;animation:spin-mech-reverse 10s linear infinite}.splash-title{color:var(--color-gold);font-size:1.8rem;letter-spacing:4px;text-transform:uppercase;margin:0 0 1.5rem;text-align:center;background:linear-gradient(to bottom,#fff5d6,#d4af37);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 2px 4px rgba(0,0,0,.5));opacity:1;transform:scale(1) translateY(0);transition:opacity .3s ease-in-out,transform .3s ease-in,filter .3s ease-in}.splash-title.holo-fade-out{opacity:0;transform:scale(.95) translateY(5px)}.loading-indicator{display:flex;gap:12px}.loading-indicator span{width:6px;height:6px;background-color:var(--color-gold);border-radius:50%;opacity:.5;animation:sequence-fade 1.4s infinite ease-in-out both}.loading-indicator span:nth-child(1){animation-delay:-.32s}.loading-indicator span:nth-child(2){animation-delay:-.16s}.loading-indicator span:nth-child(3){animation-delay:0s}.action-btn{background:#d4af371a;border:1px solid var(--color-gold);color:var(--color-gold);border-radius:6px;font-family:Courier New,Courier,monospace;font-size:1.2rem;padding:.8rem 2.5rem;cursor:pointer;letter-spacing:3px;text-transform:uppercase;transition:all .3s ease;position:relative;overflow:hidden;box-shadow:0 0 10px #d4af3733}.action-btn:hover{background:#d4af3740;box-shadow:0 0 20px #d4af3799;text-shadow:0 0 8px rgba(212,175,55,.8);transform:translateY(-2px)}.action-btn:active{transform:scale(.98)}.action-placeholder{height:4rem;width:100%;display:flex;align-items:center;justify-content:center;transition:all .3s ease}@keyframes float-map{0%,to{transform:translateY(0)}50%{transform:translateY(-10px)}}@keyframes spin-mech{to{transform:rotate(360deg)}}@keyframes spin-mech-reverse{to{transform:rotate(-360deg)}}@keyframes pulse-glow{0%{opacity:.1;transform:scale(.8)}to{opacity:.25;transform:scale(1.1)}}@keyframes sequence-fade{0%,80%,to{transform:scale(0);opacity:0}40%{transform:scale(1);opacity:1;box-shadow:0 0 10px var(--color-gold)}}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}@media(max-width:768px)or (max-height:700px){.splash-icon-container{width:15rem}.splash-title{font-size:1.2rem}}
`],encapsulation:2})};var hg=class i{title="t-p-portfolio";static \u0275fac=function(t){return new(t||i)};static \u0275cmp=sr({type:i,selectors:[["app-root"]],decls:2,vars:0,template:function(t,n){t&1&&dl(0,"app-splash-screen")(1,"router-outlet")},dependencies:[Iu,ug],encapsulation:2})};Ev(hg,CD).catch(i=>console.error(i));
