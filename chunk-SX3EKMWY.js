import{a as S}from"./chunk-TMFXFWIU.js";import{g as f}from"./chunk-ZIF4NNI2.js";import{y as b}from"./chunk-UB6LWR2H.js";import{b as m}from"./chunk-4UCLQGBG.js";import{a as x,b as _,h as p}from"./chunk-GXO6EN2N.js";var u=class i{constructor(t,e,s,r){this.x=t,this.y=e,this.width=s,this.height=r}toGlobal(t,e){return new i(this.x*t,this.y*e,this.width*t,this.height*e)}toGlobalToRef(t,e,s){return s.x=this.x*t,s.y=this.y*e,s.width=this.width*t,s.height=this.height*e,this}clone(){return new i(this.x,this.y,this.width,this.height)}};var c={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]},P=class{constructor(t,e=c){this._fullscreenViewport=new u(0,0,1,1);let s=e.positions??c.positions,r=e.indices??c.indices;this.engine=t,this._vertexBuffers={[f.PositionKind]:new f(t,s,f.PositionKind,!1,!1,2)},this._indexBuffer=t.createIndexBuffer(r),this._indexBufferLength=r.length,this._onContextRestoredObserver=t.onContextRestoredObservable.add(()=>{this._indexBuffer=t.createIndexBuffer(r);for(let h in this._vertexBuffers)this._vertexBuffers[h]._rebuild()})}setViewport(t=this._fullscreenViewport){this.engine.setViewport(t)}bindBuffers(t){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,t)}applyEffectWrapper(t,e=!1,s=!1){this.engine.setState(!0),this.engine.depthCullingState.depthTest=e,this.engine.stencilState.stencilTest=s,this.engine.enableEffect(t.drawWrapper),this.bindBuffers(t.effect),t.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.engine.depthCullingState.depthTest,this._savedStateStencilTest=this.engine.stencilState.stencilTest}restoreStates(){this.engine.depthCullingState.depthTest=this._savedStateDepthTest,this.engine.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.engine.drawElementsType(0,0,this._indexBufferLength)}_isRenderTargetTexture(t){return t.renderTarget!==void 0}render(t,e=null){if(!t.effect.isReady())return;this.saveStates(),this.setViewport();let s=e===null?null:this._isRenderTargetTexture(e)?e.renderTarget:e;s&&this.engine.bindFramebuffer(s),this.applyEffectWrapper(t),this.draw(),s&&this.engine.unBindFramebuffer(s),this.restoreStates()}dispose(){let t=this._vertexBuffers[f.PositionKind];t&&(t.dispose(),delete this._vertexBuffers[f.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}},G=(()=>{class i{static RegisterShaderCodeProcessing(e,s){if(!s){delete i._CustomShaderCodeProcessing[e??""];return}i._CustomShaderCodeProcessing[e??""]=s}static _GetShaderCodeProcessing(e){return i._CustomShaderCodeProcessing[e]??i._CustomShaderCodeProcessing[""]}get name(){return this.options.name}set name(e){this.options.name=e}isReady(){return this._drawWrapper.effect?.isReady()??!1}get drawWrapper(){return this._drawWrapper}get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}constructor(e){this.alphaMode=0,this.onEffectCreatedObservable=new m(void 0,!0),this.onApplyObservable=new m,this._shadersLoaded=!1,this._webGPUReady=!1,this._importPromises=[],this.options=_(x({},e),{name:e.name||"effectWrapper",engine:e.engine,uniforms:e.uniforms||e.uniformNames||[],uniformNames:void 0,samplers:e.samplers||e.samplerNames||[],samplerNames:void 0,attributeNames:e.attributeNames||["position"],uniformBuffers:e.uniformBuffers||[],defines:e.defines||"",useShaderStore:e.useShaderStore||!1,vertexUrl:e.vertexUrl||e.vertexShader||"postprocess",vertexShader:void 0,fragmentShader:e.fragmentShader||"pass",indexParameters:e.indexParameters,blockCompilation:e.blockCompilation||!1,shaderLanguage:e.shaderLanguage||0,onCompiled:e.onCompiled||void 0,extraInitializations:e.extraInitializations||void 0,extraInitializationsAsync:e.extraInitializationsAsync||void 0,useAsPostProcess:e.useAsPostProcess??!1,allowEmptySourceTexture:e.allowEmptySourceTexture??!1}),this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(!this.options.allowEmptySourceTexture&&this.options.samplers.indexOf("textureSampler")===-1&&this.options.samplers.push("textureSampler"),this.options.uniforms.indexOf("scale")===-1&&this.options.uniforms.push("scale")),e.vertexUrl||e.vertexShader?this._shaderPath={vertexSource:this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push("scale"),this.onApplyObservable.add(()=>{this.effect.setFloat2("scale",1,1)})),this._shaderPath={vertex:this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add(()=>{this.bind()}),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.engine.onContextRestoredObservable.add(()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()})),this._drawWrapper=new S(this.options.engine),this._webGPUReady=this.options.shaderLanguage===1;let s=Array.isArray(this.options.defines)?this.options.defines.join(`
`):this.options.defines;this._postConstructor(this.options.blockCompilation,s,this.options.extraInitializations)}_gatherImports(e=!1,s){this.options.useAsPostProcess&&(e&&this._webGPUReady?s.push(Promise.all([import("./chunk-HLDHD6RX.js")])):s.push(Promise.all([import("./chunk-E64DZWYU.js")])))}_postConstructor(e,s=null,r,h){this._importPromises.length=0,h&&this._importPromises.push(...h);let n=this.options.engine.isWebGPU&&!i.ForceGLSL;this._gatherImports(n,this._importPromises),r!==void 0&&r(n,this._importPromises),n&&this._webGPUReady&&(this.options.shaderLanguage=1),e||this.updateEffect(s)}updateEffect(e=null,s=null,r=null,h,n,v,C,w){let d=i._GetShaderCodeProcessing(this.name);if(d?.defineCustomBindings){let o=s?.slice()??[];o.push(...this.options.uniforms);let a=r?.slice()??[];a.push(...this.options.samplers),e=d.defineCustomBindings(this.name,e,o,a),s=o,r=a}this.options.defines=e||"";let g=this._shadersLoaded||this._importPromises.length===0?void 0:()=>p(this,null,function*(){yield Promise.all(this._importPromises),this._shadersLoaded=!0}),l;this.options.extraInitializationsAsync?l=()=>p(this,null,function*(){g?.(),yield this.options.extraInitializationsAsync()}):l=g,this.options.useShaderStore?this._drawWrapper.effect=this.options.engine.createEffect({vertex:C??this._shaderPath.vertex,fragment:w??this._shaderPath.fragment},{attributes:this.options.attributeNames,uniformsNames:s||this.options.uniforms,uniformBuffersNames:this.options.uniformBuffers,samplers:r||this.options.samplers,defines:e!==null?e:"",fallbacks:null,onCompiled:n??this.options.onCompiled,onError:v??null,indexParameters:h||this.options.indexParameters,processCodeAfterIncludes:d?.processCodeAfterIncludes?(o,a)=>d.processCodeAfterIncludes(this.name,o,a):null,processFinalCode:d?.processFinalCode?(o,a)=>d.processFinalCode(this.name,o,a):null,shaderLanguage:this.options.shaderLanguage,extraInitializationsAsync:l},this.options.engine):this._drawWrapper.effect=new b(this._shaderPath,this.options.attributeNames,s||this.options.uniforms,r||this.options.samplerNames,this.options.engine,e,void 0,n||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,l),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}bind(e=!1){this.options.useAsPostProcess&&!e&&(this.options.engine.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2("scale",1,1)),i._GetShaderCodeProcessing(this.name)?.bindCustomBindings?.(this.name,this._drawWrapper.effect)}dispose(e=!1){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this._drawWrapper.dispose(!0)}}return i.ForceGLSL=!1,i._CustomShaderCodeProcessing={},i})();export{u as a,P as b,G as c};
