import{b as k,c as E,d as N,e as W,f as C,g as Q,h as p}from"./chunk-ONKGPWX4.js";import{X as B}from"./chunk-YWVEFMAA.js";import{a as w}from"./chunk-DTW6C2NU.js";import{d as M,f as y,g as A,h as x}from"./chunk-FWZ75RMU.js";import{e as D}from"./chunk-OPJEXU7D.js";import{e as L}from"./chunk-CWQQB2EJ.js";import{a as I}from"./chunk-CJK33JLH.js";import{g as S}from"./chunk-YVY7FGQB.js";var F=class r extends w{get _matrix(){return this._compose(),this._localMatrix}set _matrix(n){n.updateFlag===this._localMatrix.updateFlag&&!this._needToCompose||(this._needToCompose=!1,this._localMatrix.copyFrom(n),this._markAsDirtyAndDecompose())}constructor(n,e,t=null,i=null,s=null,a=null,o=null){super(n,e.getScene(),!1),this.name=n,this.children=[],this.animations=[],this._index=null,this._scalingDeterminant=1,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=e,this._localMatrix=i?.clone()??A.Identity(),this._restMatrix=s??this._localMatrix.clone(),this._bindMatrix=a??this._localMatrix.clone(),this._index=o,this._absoluteMatrix=new A,this._absoluteBindMatrix=new A,this._absoluteInverseBindMatrix=new A,this._finalMatrix=new A,e.bones.push(this),this.setParent(t,!1),this._updateAbsoluteBindMatrices()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return this._index===null?this.getSkeleton().bones.indexOf(this):this._index}set parent(n){this.setParent(n)}setParent(n,e=!0){if(this.parent!==n){if(this.parent){let t=this.parent.children.indexOf(this);t!==-1&&this.parent.children.splice(t,1)}this._parentNode=n,this.parent&&this.parent.children.push(this),e&&this._updateAbsoluteBindMatrices(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBindMatrix(){return this._bindMatrix}getBaseMatrix(){return this.getBindMatrix()}getRestMatrix(){return this._restMatrix}getRestPose(){return this.getRestMatrix()}setRestMatrix(n){this._restMatrix.copyFrom(n)}setRestPose(n){this.setRestMatrix(n)}getBindPose(){return this.getBindMatrix()}setBindMatrix(n){this.updateMatrix(n)}setBindPose(n){this.setBindMatrix(n)}getFinalMatrix(){return this._finalMatrix}getWorldMatrix(){return this.getFinalMatrix()}returnToRest(){if(this._linkedTransformNode){let n=x.Vector3[0],e=x.Quaternion[0],t=x.Vector3[1];this.getRestMatrix().decompose(n,e,t),this._linkedTransformNode.position.copyFrom(t),this._linkedTransformNode.rotationQuaternion=this._linkedTransformNode.rotationQuaternion??y.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(e),this._linkedTransformNode.scaling.copyFrom(n)}else this._matrix=this._restMatrix}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}getInvertedAbsoluteTransform(){return this.getAbsoluteInverseBindMatrix()}getAbsoluteMatrix(){return this._skeleton.computeAbsoluteMatrices(),this._absoluteMatrix}getAbsoluteTransform(){return this.getAbsoluteMatrix()}linkTransformNode(n){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=n,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(n){this._decompose(),this._localPosition.copyFrom(n),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(n){this.setRotation(n)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(n){this.setRotationQuaternion(n)}get scaling(){return this.getScale()}set scaling(n){this.setScale(n)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=M.Zero(),this._localRotation=y.Zero(),this._localPosition=M.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){if(this._needToCompose){if(!this._localScaling){this._needToCompose=!1;return}this._needToCompose=!1,A.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}}updateMatrix(n,e=!0,t=!0){this._bindMatrix.copyFrom(n),e&&this._updateAbsoluteBindMatrices(),t?this._matrix=n:this.markAsDirty()}_updateAbsoluteBindMatrices(n,e=!0){if(n||(n=this._bindMatrix),this.parent?n.multiplyToRef(this.parent._absoluteBindMatrix,this._absoluteBindMatrix):this._absoluteBindMatrix.copyFrom(n),this._absoluteBindMatrix.invertToRef(this._absoluteInverseBindMatrix),e)for(let t=0;t<this.children.length;t++)this.children[t]._updateAbsoluteBindMatrices();this._scalingDeterminant=this._absoluteBindMatrix.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}_updatePosition(n,e=0,t,i=!0){let s=this.getLocalMatrix();if(e==0)i?(s.addAtIndex(12,n.x),s.addAtIndex(13,n.y),s.addAtIndex(14,n.z)):s.setTranslationFromFloats(n.x,n.y,n.z);else{let a=r._TmpMats[0],o=r._TmpVecs[0];this.parent?(a.copyFrom(this.parent.getAbsoluteMatrix()),t&&a.multiplyToRef(t.getWorldMatrix(),a)):A.IdentityToRef(a),i&&a.setTranslationFromFloats(0,0,0),a.invert(),M.TransformCoordinatesToRef(n,a,o),i?(s.addAtIndex(12,o.x),s.addAtIndex(13,o.y),s.addAtIndex(14,o.z)):s.setTranslationFromFloats(o.x,o.y,o.z)}this._markAsDirtyAndDecompose()}translate(n,e=0,t){this._updatePosition(n,e,t,!0)}setPosition(n,e=0,t){this._updatePosition(n,e,t,!1)}setAbsolutePosition(n,e){this.setPosition(n,1,e)}scale(n,e,t,i=!1){let s=this.getLocalMatrix(),a=r._TmpMats[0];A.ScalingToRef(n,e,t,a),a.multiplyToRef(s,s),a.invert();for(let o of this.children){let l=o.getLocalMatrix();l.multiplyToRef(a,l),l.multiplyAtIndex(12,n),l.multiplyAtIndex(13,e),l.multiplyAtIndex(14,t),o._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),i)for(let o of this.children)o.scale(n,e,t,i)}setScale(n){this._decompose(),this._localScaling.copyFrom(n),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(n){this._decompose(),n.copyFrom(this._localScaling)}setYawPitchRoll(n,e,t,i=0,s){if(i===0){let l=r._TmpQuat;y.RotationYawPitchRollToRef(n,e,t,l),this.setRotationQuaternion(l,i,s);return}let a=r._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(a,s))return;let o=r._TmpMats[1];A.RotationYawPitchRollToRef(n,e,t,o),a.multiplyToRef(o,o),this._rotateWithMatrix(o,i,s)}rotate(n,e,t=0,i){let s=r._TmpMats[0];s.setTranslationFromFloats(0,0,0),A.RotationAxisToRef(n,e,s),this._rotateWithMatrix(s,t,i)}setAxisAngle(n,e,t=0,i){if(t===0){let o=r._TmpQuat;y.RotationAxisToRef(n,e,o),this.setRotationQuaternion(o,t,i);return}let s=r._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,i))return;let a=r._TmpMats[1];A.RotationAxisToRef(n,e,a),s.multiplyToRef(a,a),this._rotateWithMatrix(a,t,i)}setRotation(n,e=0,t){this.setYawPitchRoll(n.y,n.x,n.z,e,t)}setRotationQuaternion(n,e=0,t){if(e===0){this._decompose(),this._localRotation.copyFrom(n),this._markAsDirtyAndCompose();return}let i=r._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(i,t))return;let s=r._TmpMats[1];A.FromQuaternionToRef(n,s),i.multiplyToRef(s,s),this._rotateWithMatrix(s,e,t)}setRotationMatrix(n,e=0,t){if(e===0){let a=r._TmpQuat;y.FromRotationMatrixToRef(n,a),this.setRotationQuaternion(a,e,t);return}let i=r._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(i,t))return;let s=r._TmpMats[1];s.copyFrom(n),i.multiplyToRef(n,s),this._rotateWithMatrix(s,e,t)}_rotateWithMatrix(n,e=0,t){let i=this.getLocalMatrix(),s=i.m[12],a=i.m[13],o=i.m[14],l=this.getParent(),h=r._TmpMats[3],u=r._TmpMats[4];l&&e==1?(t?(h.copyFrom(t.getWorldMatrix()),l.getAbsoluteMatrix().multiplyToRef(h,h)):h.copyFrom(l.getAbsoluteMatrix()),u.copyFrom(h),u.invert(),i.multiplyToRef(h,i),i.multiplyToRef(n,i),i.multiplyToRef(u,i)):e==1&&t?(h.copyFrom(t.getWorldMatrix()),u.copyFrom(h),u.invert(),i.multiplyToRef(h,i),i.multiplyToRef(n,i),i.multiplyToRef(u,i)):i.multiplyToRef(n,i),i.setTranslationFromFloats(s,a,o),this._markAsDirtyAndDecompose()}_getAbsoluteInverseMatrixUnscaledToRef(n,e){let t=r._TmpMats[2];return n.copyFrom(this.getAbsoluteMatrix()),e?(n.multiplyToRef(e.getWorldMatrix(),n),A.ScalingToRef(e.scaling.x,e.scaling.y,e.scaling.z,t)):A.IdentityToRef(t),n.invert(),isNaN(n.m[0])?!1:(t.multiplyAtIndex(0,this._scalingDeterminant),n.multiplyToRef(t,n),!0)}getPosition(n=0,e=null){let t=M.Zero();return this.getPositionToRef(n,e,t),t}getPositionToRef(n=0,e,t){if(n==0){let i=this.getLocalMatrix();t.x=i.m[12],t.y=i.m[13],t.z=i.m[14]}else{let i=r._TmpMats[0].copyFrom(this.getAbsoluteMatrix());e&&i.multiplyToRef(e.getWorldMatrix(),i),t.x=i.m[12],t.y=i.m[13],t.z=i.m[14]}}getAbsolutePosition(n=null){let e=M.Zero();return this.getPositionToRef(1,n,e),e}getAbsolutePositionToRef(n,e){this.getPositionToRef(1,n,e)}computeAbsoluteMatrices(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteMatrix,this._absoluteMatrix);else{this._absoluteMatrix.copyFrom(this._localMatrix);let t=this._skeleton.getPoseMatrix();t&&this._absoluteMatrix.multiplyToRef(t,this._absoluteMatrix)}let n=this.children,e=n.length;for(let t=0;t<e;t++)n[t].computeAbsoluteMatrices()}computeAbsoluteTransforms(){this.computeAbsoluteMatrices()}getDirection(n,e=null){let t=M.Zero();return this.getDirectionToRef(n,e,t),t}getDirectionToRef(n,e=null,t){let i=r._TmpMats[0].copyFrom(this.getAbsoluteMatrix());e&&i.multiplyToRef(e.getWorldMatrix(),i),M.TransformNormalToRef(n,i,t),t.normalize()}getRotation(n=0,e=null){let t=M.Zero();return this.getRotationToRef(n,e,t),t}getRotationToRef(n=0,e=null,t){let i=r._TmpQuat;this.getRotationQuaternionToRef(n,e,i),i.toEulerAnglesToRef(t)}getRotationQuaternion(n=0,e=null){let t=y.Identity();return this.getRotationQuaternionToRef(n,e,t),t}getRotationQuaternionToRef(n=0,e=null,t){if(n==0)this._decompose(),t.copyFrom(this._localRotation);else{let i=r._TmpMats[0],s=this.getAbsoluteMatrix();e?s.multiplyToRef(e.getWorldMatrix(),i):i.copyFrom(s),i.multiplyAtIndex(0,this._scalingDeterminant),i.multiplyAtIndex(1,this._scalingDeterminant),i.multiplyAtIndex(2,this._scalingDeterminant),i.decompose(void 0,t,void 0)}}getRotationMatrix(n=0,e){let t=A.Identity();return this.getRotationMatrixToRef(n,e,t),t}getRotationMatrixToRef(n=0,e,t){if(n==0)this.getLocalMatrix().getRotationMatrixToRef(t);else{let i=r._TmpMats[0],s=this.getAbsoluteMatrix();e?s.multiplyToRef(e.getWorldMatrix(),i):i.copyFrom(s),i.multiplyAtIndex(0,this._scalingDeterminant),i.multiplyAtIndex(1,this._scalingDeterminant),i.multiplyAtIndex(2,this._scalingDeterminant),i.getRotationMatrixToRef(t)}}getAbsolutePositionFromLocal(n,e=null){let t=M.Zero();return this.getAbsolutePositionFromLocalToRef(n,e,t),t}getAbsolutePositionFromLocalToRef(n,e=null,t){let i=r._TmpMats[0].copyFrom(this.getAbsoluteMatrix());e&&i.multiplyToRef(e.getWorldMatrix(),i),M.TransformCoordinatesToRef(n,i,t)}getLocalPositionFromAbsolute(n,e=null){let t=M.Zero();return this.getLocalPositionFromAbsoluteToRef(n,e,t),t}getLocalPositionFromAbsoluteToRef(n,e=null,t){let i=r._TmpMats[0].copyFrom(this.getAbsoluteMatrix());e&&i.multiplyToRef(e.getWorldMatrix(),i),i.invert(),M.TransformCoordinatesToRef(n,i,t)}setCurrentPoseAsRest(){this.setRestMatrix(this.getLocalMatrix())}dispose(){this._linkedTransformNode=null;let n=this._skeleton.bones.indexOf(this);if(n!==-1&&this._skeleton.bones.splice(n,1),this._parentNode&&this._parentNode.children){let e=this._parentNode.children,t=e.indexOf(this);t!==-1&&e.splice(t,1)}super.dispose()}};F._TmpVecs=D(2,M.Zero);F._TmpQuat=y.Identity();F._TmpMats=D(5,A.Identity);var O=class{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(n,e,t,i){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._absoluteFrameOffset=0,this._previousElapsedTime=0,this._yoyoDirection=1,this._previousAbsoluteFrame=0,this._targetIsArray=!1,this._coreRuntimeAnimation=null,this._animation=e,this._target=n,this._scene=t,this._host=i,this._activeTargets=[],e._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===p.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=A.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minFrame!==0){let a={frame:0,value:this._keys[0].value};this._keys.splice(0,0,a)}if(this._target instanceof Array){let a=0;for(let o of this._target)this._preparePath(o,a),this._getOriginalValues(a),a++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];let s=e.getEvents();if(s&&s.length>0)for(let a of s)this._events.push(a._clone());this._enableBlending=n&&n.animationPropertiesOverride?n.animationPropertiesOverride.enableBlending:this._animation.enableBlending}_preparePath(n,e=0){let t=this._animation.targetPropertyPath;if(t.length>1){let i=n;for(let s=0;s<t.length-1;s++){let a=t[s];if(i=i[a],i===void 0)throw new Error(`Invalid property (${a}) in property path (${t.join(".")})`)}this._targetPath=t[t.length-1],this._activeTargets[e]=i}else this._targetPath=t[0],this._activeTargets[e]=n;if(this._activeTargets[e][this._targetPath]===void 0)throw new Error(`Invalid property (${this._targetPath}) in property path (${t.join(".")})`)}get animation(){return this._animation}reset(n=!1){if(n)if(this._target instanceof Array){let e=0;for(let t of this._target)this._originalValue[e]!==void 0&&this._setValue(t,this._activeTargets[e],this._originalValue[e],-1,e),e++}else this._originalValue[0]!==void 0&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let e=0;e<this._events.length;e++)this._events[e].isDone=!1}isStopped(){return this._stopped}dispose(){let n=this._animation.runtimeAnimations.indexOf(this);n>-1&&this._animation.runtimeAnimations.splice(n,1)}setValue(n,e){if(this._targetIsArray){for(let t=0;t<this._target.length;t++){let i=this._target[t];this._setValue(i,this._activeTargets[t],n,e,t)}return}this._setValue(this._target,this._directTarget,n,e,0)}_getOriginalValues(n=0){let e,t=this._activeTargets[n];t.getLocalMatrix&&this._targetPath==="_matrix"?e=t.getLocalMatrix():e=t[this._targetPath],e&&e.clone?this._originalValue[n]=e.clone():this._originalValue[n]=e}_registerTargetForLateAnimationBinding(n,e){let t=n.target;this._scene._registeredForLateAnimationBindings.pushNoDuplicate(t),t._lateAnimationHolders||(t._lateAnimationHolders={}),t._lateAnimationHolders[n.targetPath]||(t._lateAnimationHolders[n.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:e}),n.isAdditive?(t._lateAnimationHolders[n.targetPath].additiveAnimations.push(n),t._lateAnimationHolders[n.targetPath].totalAdditiveWeight+=n.weight):(t._lateAnimationHolders[n.targetPath].animations.push(n),t._lateAnimationHolders[n.targetPath].totalWeight+=n.weight)}_setValue(n,e,t,i,s){if(this._currentActiveTarget=e,this._weight=i,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){let o=e[this._targetPath];o.clone?this._originalBlendValue=o.clone():this._originalBlendValue=o}this._originalBlendValue.m?p.AllowMatrixDecomposeForInterpolation?this._currentValue?A.DecomposeLerpToRef(this._originalBlendValue,t,this._blendingFactor,this._currentValue):this._currentValue=A.DecomposeLerp(this._originalBlendValue,t,this._blendingFactor):this._currentValue?A.LerpToRef(this._originalBlendValue,t,this._blendingFactor,this._currentValue):this._currentValue=A.Lerp(this._originalBlendValue,t,this._blendingFactor):this._currentValue=p._UniversalLerp(this._originalBlendValue,t,this._blendingFactor);let a=n&&n.animationPropertiesOverride?n.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=a}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(t):this._currentValue=t:t?.clone?this._currentValue=t.clone():this._currentValue=t;i!==-1?this._registerTargetForLateAnimationBinding(this,this._originalValue[s]):this._animationState.loopMode===p.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT?this._currentValue.addToRef?this._currentValue.addToRef(this._originalValue[s],e[this._targetPath]):e[this._targetPath]=this._originalValue[s]+this._currentValue:e[this._targetPath]=this._currentValue,n.markAsDirty&&n.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(n,e=-1){let t=this._animation.getKeys();n<t[0].frame?n=t[0].frame:n>t[t.length-1].frame&&(n=t[t.length-1].frame);let i=this._events;if(i.length)for(let a=0;a<i.length;a++)i[a].onlyOnce||(i[a].isDone=i[a].frame<n);this._currentFrame=n;let s=this._animation._interpolate(n,this._animationState);this.setValue(s,e)}_prepareForSpeedRatioChange(n){let e=this._previousElapsedTime*(this._animation.framePerSecond*n)/1e3;this._absoluteFrameOffset=this._previousAbsoluteFrame-e}animate(n,e,t,i,s,a=-1){let o=this._animation,l=o.targetPropertyPath;if(!l||l.length<1)return this._stopped=!0,!1;let h=!0,u,f=this._events,_=0;if(this._coreRuntimeAnimation)_=t-e,u=this._coreRuntimeAnimation.currentFrame,this._currentFrame=u,this._animationState.repeatCount=this._coreRuntimeAnimation._animationState.repeatCount,this._animationState.highLimitValue=this._coreRuntimeAnimation._animationState.highLimitValue,this._animationState.offsetValue=this._coreRuntimeAnimation._animationState.offsetValue;else{(e<this._minFrame||e>this._maxFrame)&&(e=this._minFrame),(t<this._minFrame||t>this._maxFrame)&&(t=this._maxFrame),_=t-e;let c,m=n*(o.framePerSecond*s)/1e3+this._absoluteFrameOffset,P=0,v=!1,b=i&&this._animationState.loopMode===p.ANIMATIONLOOPMODE_YOYO;if(b){let d=(m-e)/_,T=Math.sin(d*Math.PI);m=Math.abs(T)*_+e;let V=T>=0?1:-1;this._yoyoDirection!==V&&(v=!0),this._yoyoDirection=V}if(this._previousElapsedTime=n,this._previousAbsoluteFrame=m,!i&&t>=e&&(m>=_&&s>0||m<=0&&s<0))h=!1,P=o.evaluate(t);else if(!i&&e>=t&&(m<=_&&s<0||m>=0&&s>0))h=!1,P=o.evaluate(e);else if(this._animationState.loopMode!==p.ANIMATIONLOOPMODE_CYCLE){let d=t.toString()+e.toString();if(!this._offsetsCache[d]){this._animationState.repeatCount=0,this._animationState.loopMode=p.ANIMATIONLOOPMODE_CYCLE;let T=o._interpolate(e,this._animationState),R=o._interpolate(t,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),o.dataType){case p.ANIMATIONTYPE_FLOAT:this._offsetsCache[d]=R-T;break;case p.ANIMATIONTYPE_QUATERNION:this._offsetsCache[d]=R.subtract(T);break;case p.ANIMATIONTYPE_VECTOR3:this._offsetsCache[d]=R.subtract(T);break;case p.ANIMATIONTYPE_VECTOR2:this._offsetsCache[d]=R.subtract(T);break;case p.ANIMATIONTYPE_SIZE:this._offsetsCache[d]=R.subtract(T);break;case p.ANIMATIONTYPE_COLOR3:this._offsetsCache[d]=R.subtract(T);break;default:break}this._highLimitsCache[d]=R}P=this._highLimitsCache[d],c=this._offsetsCache[d]}if(c===void 0)switch(o.dataType){case p.ANIMATIONTYPE_FLOAT:c=0;break;case p.ANIMATIONTYPE_QUATERNION:c=k;break;case p.ANIMATIONTYPE_VECTOR3:c=E;break;case p.ANIMATIONTYPE_VECTOR2:c=N;break;case p.ANIMATIONTYPE_SIZE:c=W;break;case p.ANIMATIONTYPE_COLOR3:c=C;break;case p.ANIMATIONTYPE_COLOR4:c=Q;break}if(this._host&&this._host.syncRoot){let d=this._host.syncRoot,T=(d.masterFrame-d.fromFrame)/(d.toFrame-d.fromFrame);u=e+_*T}else m>0&&e>t||m<0&&e<t?u=h&&_!==0?t+m%_:e:u=h&&_!==0?e+m%_:t;if(!b&&(s>0&&this.currentFrame>u||s<0&&this.currentFrame<u)||b&&v){this._onLoop();for(let d=0;d<f.length;d++)f[d].onlyOnce||(f[d].isDone=!1);this._animationState.key=s>0?0:o.getKeys().length-1}this._currentFrame=u,this._animationState.repeatCount=_===0?0:m/_>>0,this._animationState.highLimitValue=P,this._animationState.offsetValue=c}let g=o._interpolate(u,this._animationState);if(this.setValue(g,a),f.length){for(let c=0;c<f.length;c++)if(_>=0&&u>=f[c].frame&&f[c].frame>=e||_<0&&u<=f[c].frame&&f[c].frame<=e){let m=f[c];m.isDone||(m.onlyOnce&&(f.splice(c,1),c--),m.isDone=!0,m.action(u))}}return h||(this._stopped=!0),h}};var Y=(()=>{class r{get syncRoot(){return this._syncRoot}get masterFrame(){return this._runtimeAnimations.length===0?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){if(e===-1){this._weight=-1;return}this._weight=Math.min(Math.max(e,0),1)}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,this._goToFrame!==null&&this.goToFrame(this._goToFrame)}get elapsedTime(){return this._localDelayOffset===null?0:this._scene._animationTime-this._localDelayOffset}constructor(e,t,i=0,s=100,a=!1,o=1,l,h,u,f=!1,_=0){this.target=t,this.fromFrame=i,this.toFrame=s,this.loopAnimation=a,this.onAnimationEnd=l,this.onAnimationLoop=u,this.isAdditive=f,this.playOrder=_,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._previousWeight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new I,this.onAnimationLoopObservable=new I,this._scene=e,h&&this.appendAnimations(t,h),this._speedRatio=o,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){let t=this._scene._activeAnimatables.indexOf(this);t>-1&&(this._scene._activeAnimatables.splice(t,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){let s=t[i],a=new O(e,s,this._scene,this);a._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(a)}}getAnimationByTargetProperty(e){let t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){let t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){let e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){let t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){let e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e,t=!1){let i=this._runtimeAnimations;if(i[0]){let s=i[0].animation.framePerSecond;this._frameToSyncFromJump=this._frameToSyncFromJump??i[0].currentFrame;let a=this.speedRatio===0?0:(e-this._frameToSyncFromJump)/s*1e3/this.speedRatio;this._manualJumpDelay=-a}for(let s=0;s<i.length;s++)i[s].goToFrame(e,t?this._weight:-1);this._goToFrame=e}get paused(){return this._paused}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t,i=!1,s=!1){if(e||t){let a=this._scene._activeAnimatables.indexOf(this);if(a>-1){let o=this._runtimeAnimations;for(let l=o.length-1;l>=0;l--){let h=o[l];e&&h.animation.name!=e||t&&!t(h.target)||(h.dispose(),o.splice(l,1))}o.length==0&&(i||this._scene._activeAnimatables.splice(a,1),s||this._raiseOnAnimationEnd())}}else{let a=this._scene._activeAnimatables.indexOf(this);if(a>-1){i||this._scene._activeAnimatables.splice(a,1);let o=this._runtimeAnimations;for(let l=0;l<o.length;l++)o[l].dispose();this._runtimeAnimations.length=0,s||this._raiseOnAnimationEnd()}}}waitAsync(){return S(this,null,function*(){return yield new Promise(e=>{this.onAnimationEndObservable.add(()=>{e(this)},void 0,void 0,this,!0)})})}_animate(e){if(this._paused)return this.animationStarted=!1,this._pausedDelay===null&&(this._pausedDelay=e),!0;if(this._localDelayOffset===null?(this._localDelayOffset=e,this._pausedDelay=null):this._pausedDelay!==null&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),this._manualJumpDelay!==null&&(this._localDelayOffset+=this.speedRatio<0?-this._manualJumpDelay:this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,!r.ProcessPausedAnimatables&&this._weight===0&&this._previousWeight===0)return!0;this._previousWeight=this._weight;let t=!1,i=this._runtimeAnimations,s;for(s=0;s<i.length;s++){let o=i[s].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||o}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(s=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(s,1),s=0;s<i.length;s++)i[s].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t}}return r.ProcessPausedAnimatables=!1,r})();function z(r){if(r.totalWeight===0&&r.totalAdditiveWeight===0)return r.originalValue;let n=1,e=x.Vector3[0],t=x.Vector3[1],i=x.Quaternion[0],s=0,a=r.animations[0],o=r.originalValue,l=1,h=!1;if(r.totalWeight<1)l=1-r.totalWeight,o.decompose(t,i,e);else{if(s=1,n=r.totalWeight,l=a.weight/n,l==1)if(r.totalAdditiveWeight)h=!0;else return a.currentValue;a.currentValue.decompose(t,i,e)}if(!h){t.scaleInPlace(l),e.scaleInPlace(l),i.scaleInPlace(l);for(let f=s;f<r.animations.length;f++){let _=r.animations[f];if(_.weight===0)continue;l=_.weight/n;let g=x.Vector3[2],c=x.Vector3[3],m=x.Quaternion[1];_.currentValue.decompose(c,m,g),c.scaleAndAddToRef(l,t),m.scaleAndAddToRef(y.Dot(i,m)>0?l:-l,i),g.scaleAndAddToRef(l,e)}i.normalize()}for(let f=0;f<r.additiveAnimations.length;f++){let _=r.additiveAnimations[f];if(_.weight===0)continue;let g=x.Vector3[2],c=x.Vector3[3],m=x.Quaternion[1];_.currentValue.decompose(c,m,g),c.multiplyToRef(t,c),M.LerpToRef(t,c,_.weight,t),i.multiplyToRef(m,m),y.SlerpToRef(i,m,_.weight,i),g.scaleAndAddToRef(_.weight,e)}let u=a?a._animationState.workValue:x.Matrix[0].clone();return A.ComposeToRef(t,i,e,u),u}function Z(r,n){if(r.totalWeight===0&&r.totalAdditiveWeight===0)return n;let e=r.animations[0],t=r.originalValue,i=n;if(r.totalWeight===0&&r.totalAdditiveWeight>0)i.copyFrom(t);else if(r.animations.length===1){if(y.SlerpToRef(t,e.currentValue,Math.min(1,r.totalWeight),i),r.totalAdditiveWeight===0)return i}else if(r.animations.length>1){let s=1,a,o;if(r.totalWeight<1){let h=1-r.totalWeight;a=[],o=[],a.push(t),o.push(h)}else{if(r.animations.length===2&&(y.SlerpToRef(r.animations[0].currentValue,r.animations[1].currentValue,r.animations[1].weight/r.totalWeight,n),r.totalAdditiveWeight===0))return n;a=[],o=[],s=r.totalWeight}for(let h=0;h<r.animations.length;h++){let u=r.animations[h];a.push(u.currentValue),o.push(u.weight/s)}let l=0;for(let h=0;h<a.length;){if(!h){y.SlerpToRef(a[h],a[h+1],o[h+1]/(o[h]+o[h+1]),n),i=n,l=o[h]+o[h+1],h+=2;continue}l+=o[h],y.SlerpToRef(i,a[h],o[h]/l,i),h++}}for(let s=0;s<r.additiveAnimations.length;s++){let a=r.additiveAnimations[s];a.weight!==0&&(i.multiplyToRef(a.currentValue,x.Quaternion[0]),y.SlerpToRef(i,x.Quaternion[0],a.weight,i))}return i}function J(r){if(r._registeredForLateAnimationBindings.length){for(let n=0;n<r._registeredForLateAnimationBindings.length;n++){let e=r._registeredForLateAnimationBindings.data[n];for(let t in e._lateAnimationHolders){let i=e._lateAnimationHolders[t],s=i.animations[0],a=i.originalValue;if(a==null)continue;let o=p.AllowMatrixDecomposeForInterpolation&&a.m,l=e[t];if(o)l=z(i);else if(a.w!==void 0)l=Z(i,l||y.Identity());else{let u=0,f=1,_=s&&s._animationState.loopMode===p.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT;if(i.totalWeight<1)_?l=a.clone?a.clone():a:s&&a.scale?l=a.scale(1-i.totalWeight):s?l=a*(1-i.totalWeight):a.clone?l=a.clone():l=a;else if(s){f=i.totalWeight;let g=s.weight/f;g!==1?s.currentValue.scale?l=s.currentValue.scale(g):l=s.currentValue*g:l=s.currentValue,_&&(l.addToRef?l.addToRef(a,l):l+=a),u=1}for(let g=u;g<i.animations.length;g++){let c=i.animations[g],m=c.weight/f;if(m)c.currentValue.scaleAndAddToRef?c.currentValue.scaleAndAddToRef(m,l):l+=c.currentValue*m;else continue}for(let g=0;g<i.additiveAnimations.length;g++){let c=i.additiveAnimations[g],m=c.weight;if(m)c.currentValue.scaleAndAddToRef?c.currentValue.scaleAndAddToRef(m,l):l+=c.currentValue*m;else continue}}e[t]=l}e._lateAnimationHolders={}}r._registeredForLateAnimationBindings.reset()}}function H(r,n){n&&(n.prototype.copyAnimationRange=function(e,t,i,s=!1,a=null){this.animations.length===0&&(this.animations.push(new p(this.name,"_matrix",e.animations[0].framePerSecond,p.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));let o=e.animations[0].getRange(t);if(!o)return!1;let l=o.from,h=o.to,u=e.animations[0].getKeys(),f=e.length,_=e.getParent(),g=this.getParent(),c=s&&_&&f&&this.length&&f!==this.length,m=c&&g&&_?g.length/_.length:1,P=s&&!g&&a&&(a.x!==1||a.y!==1||a.z!==1),v=this.animations[0].getKeys(),b,d,T;for(let R=0,V=u.length;R<V;R++)b=u[R],b.frame>=l&&b.frame<=h&&(s?(T=b.value.clone(),c?(d=T.getTranslation(),T.setTranslation(d.scaleInPlace(m))):P&&a?(d=T.getTranslation(),T.setTranslation(d.multiplyInPlace(a))):T=b.value):T=b.value,v.push({frame:b.frame+i,value:T}));return this.animations[0].createRange(t,l+i,h+i),!0}),r&&(r.prototype._animate=function(e){if(!this.animationsEnabled)return;let t=L.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=t}this.deltaTime=e!==void 0?e:this.useConstantAnimationDeltaTime?16:(t-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=t;let i=this._activeAnimatables;if(i.length===0)return;this._animationTime+=this.deltaTime;let s=this._animationTime;for(let a=0;a<i.length;a++){let o=i[a];!o._animate(s)&&o.disposeOnEnd&&a--}J(this)},r.prototype.sortActiveAnimatables=function(){this._activeAnimatables.sort((e,t)=>e.playOrder-t.playOrder)},r.prototype.beginWeightedAnimation=function(e,t,i,s=1,a,o=1,l,h,u,f,_=!1){let g=this.beginAnimation(e,t,i,a,o,l,h,!1,u,f,_);return g.weight=s,g},r.prototype.beginAnimation=function(e,t,i,s,a=1,o,l,h=!0,u,f,_=!1){if(a<0){let c=t;t=i,i=c,a=-a}t>i&&(a=-a),h&&this.stopAnimation(e,void 0,u),l||(l=new Y(this,e,t,i,s,a,o,void 0,f,_));let g=u?u(e):!0;if(e.animations&&g&&l.appendAnimations(e,e.animations),e.getAnimatables){let c=e.getAnimatables();for(let m=0;m<c.length;m++)this.beginAnimation(c[m],t,i,s,a,o,l,h,u,f)}return l.reset(),l},r.prototype.beginHierarchyAnimation=function(e,t,i,s,a,o=1,l,h,u=!0,f,_,g=!1){let c=e.getDescendants(t),m=[];m.push(this.beginAnimation(e,i,s,a,o,l,h,u,f,void 0,g));for(let P of c)m.push(this.beginAnimation(P,i,s,a,o,l,h,u,f,void 0,g));return m},r.prototype.beginDirectAnimation=function(e,t,i,s,a,o=1,l,h,u=!1){if(o<0){let _=i;i=s,s=_,o=-o}return i>s&&(o=-o),new Y(this,e,i,s,a,o,l,t,h,u)},r.prototype.beginDirectHierarchyAnimation=function(e,t,i,s,a,o,l,h,u,f=!1){let _=e.getDescendants(t),g=[];g.push(this.beginDirectAnimation(e,i,s,a,o,l,h,u,f));for(let c of _)g.push(this.beginDirectAnimation(c,i,s,a,o,l,h,u,f));return g},r.prototype.getAnimatableByTarget=function(e){for(let t=0;t<this._activeAnimatables.length;t++)if(this._activeAnimatables[t].target===e)return this._activeAnimatables[t];return null},r.prototype.getAllAnimatablesByTarget=function(e){let t=[];for(let i=0;i<this._activeAnimatables.length;i++)this._activeAnimatables[i].target===e&&t.push(this._activeAnimatables[i]);return t},r.prototype.stopAnimation=function(e,t,i){let s=this.getAllAnimatablesByTarget(e);for(let a of s)a.stop(t,i)},r.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let e=0;e<this._activeAnimatables.length;e++)this._activeAnimatables[e].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(let e of this.animationGroups)e.stop()})}H(B,F);export{F as a};
