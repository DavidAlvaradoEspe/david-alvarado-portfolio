import{a as b}from"./chunk-BIUUBQVG.js";import{d as x}from"./chunk-UQ4ZL6C5.js";import{a as w}from"./chunk-TMFXFWIU.js";import{g as M}from"./chunk-ZIF4NNI2.js";var f=class{constructor(e,t,n){this.bu=e,this.bv=t,this.distance=n,this.faceId=0,this.subMeshId=0,this._internalSubMeshId=0}};var W=class c{get materialDefines(){return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:this._getDrawWrapper()?.defines}set materialDefines(e){let t=this._mainDrawWrapperOverride??this._getDrawWrapper(void 0,!0);t.defines=e}_getDrawWrapper(e,t=!1){e=e??this._engine.currentRenderPassId;let n=this._drawWrappers[e];return!n&&t&&(this._drawWrappers[e]=n=new w(this._mesh.getScene().getEngine())),n}_removeDrawWrapper(e,t=!0,n=!1){t&&this._drawWrappers[e]?.dispose(n),this._drawWrappers[e]=void 0}get effect(){return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:this._getDrawWrapper()?.effect??null}get _drawWrapper(){return this._mainDrawWrapperOverride??this._getDrawWrapper(void 0,!0)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(e){this._mainDrawWrapperOverride=e}setEffect(e,t=null,n,h=!0){let s=this._drawWrapper;s.setEffect(e,t,h),n!==void 0&&(s.materialContext=n),e||(s.defines=null,s.materialContext=void 0)}resetDrawCache(e,t=!1){if(this._drawWrappers)if(e!==void 0){this._removeDrawWrapper(e,!0,t);return}else for(let n of this._drawWrappers)n?.dispose(t);this._drawWrappers=[]}static AddToMesh(e,t,n,h,s,r,i,a=!0){return new c(e,t,n,h,s,r,i,a)}constructor(e,t,n,h,s,r,i,a=!0,l=!0){this.materialIndex=e,this.verticesStart=t,this.verticesCount=n,this.indexStart=h,this.indexCount=s,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=r,this._renderingMesh=i||r,l&&r.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=r.subMeshes.length-1,a&&(this.refreshBoundingInfo(),r.computeWorldMatrix(!0))}get IsGlobal(){return this.verticesStart===0&&this.verticesCount===this._mesh.getTotalVertices()&&this.indexStart===0&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal||this._mesh.hasThinInstances?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(e){return this._boundingInfo=e,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){let e=this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null;return e||this._renderingMesh}getMaterial(e=!0){let t=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId)??this._renderingMesh.material;if(t){if(this._isMultiMaterial(t)){let n=t.getSubMaterial(this.materialIndex);return this._currentMaterial!==n&&(this._currentMaterial=n,this.resetDrawCache()),n}}else return e&&this._mesh.getScene()._hasDefaultMaterial?this._mesh.getScene().defaultMaterial:null;return t}_isMultiMaterial(e){return e.getSubMaterial!==void 0}refreshBoundingInfo(e=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(M.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;let t=this._renderingMesh.getIndices(),n;if(this.indexStart===0&&this.indexCount===t.length){let h=this._renderingMesh.getBoundingInfo();n={minimum:h.minimum.clone(),maximum:h.maximum.clone()}}else n=b(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(n.minimum,n.maximum):this._boundingInfo=new x(n.minimum,n.maximum),this}_checkCollision(e){return this.getBoundingInfo()._checkCollision(e)}updateBoundingInfo(e){let t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this}isInFrustum(e){let t=this.getBoundingInfo();return t?t.isInFrustum(e,this._mesh.cullingStrategy):!1}isCompletelyInFrustum(e){let t=this.getBoundingInfo();return t?t.isCompletelyInFrustum(e):!1}render(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(e,t){if(!this._linesIndexBuffer){let n=Math.floor(this.indexCount/3)*6,s=this.verticesStart+this.verticesCount>65535?new Uint32Array(n):new Uint16Array(n),r=0;if(e.length===0)for(let i=this.indexStart;i<this.indexStart+this.indexCount;i+=3)s[r++]=i,s[r++]=i+1,s[r++]=i+1,s[r++]=i+2,s[r++]=i+2,s[r++]=i;else for(let i=this.indexStart;i<this.indexStart+this.indexCount;i+=3)s[r++]=e[i],s[r++]=e[i+1],s[r++]=e[i+1],s[r++]=e[i+2],s[r++]=e[i+2],s[r++]=e[i];this._linesIndexBuffer=t.createIndexBuffer(s),this._linesIndexCount=s.length}return this._linesIndexBuffer}canIntersects(e){let t=this.getBoundingInfo();return t?e.intersectsBox(t.boundingBox):!1}intersects(e,t,n,h,s){let r=this.getMaterial();if(!r)return null;let i=3,a=!1;switch(r.fillMode){case 3:case 5:case 6:case 8:return null;case 7:i=1,a=!0;break;default:break}return r.fillMode===4?n.length?this._intersectLines(e,t,n,this._mesh.intersectionThreshold,h):this._intersectUnIndexedLines(e,t,n,this._mesh.intersectionThreshold,h):!n.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,n,h,s):this._intersectTriangles(e,t,n,i,a,h,s)}_intersectLines(e,t,n,h,s){let r=null;for(let i=this.indexStart;i<this.indexStart+this.indexCount;i+=2){let a=t[n[i]],l=t[n[i+1]],u=e.intersectionSegment(a,l,h);if(!(u<0)&&(s||!r||u<r.distance)&&(r=new f(null,null,u),r.faceId=i/2,s))break}return r}_intersectUnIndexedLines(e,t,n,h,s){let r=null;for(let i=this.verticesStart;i<this.verticesStart+this.verticesCount;i+=2){let a=t[i],l=t[i+1],u=e.intersectionSegment(a,l,h);if(!(u<0)&&(s||!r||u<r.distance)&&(r=new f(null,null,u),r.faceId=i/2,s))break}return r}_intersectTriangles(e,t,n,h,s,r,i){let a=null,l=-1;for(let u=this.indexStart;u<this.indexStart+this.indexCount-(3-h);u+=h){l++;let o=n[u],d=n[u+1],g=n[u+2];if(s&&g===4294967295){u+=2;continue}let m=t[o],I=t[d],p=t[g];if(!m||!I||!p||i&&!i(m,I,p,e,o,d,g))continue;let _=e.intersectsTriangle(m,I,p);if(_){if(_.distance<0)continue;if((r||!a||_.distance<a.distance)&&(a=_,a.faceId=l,r))break}}return a}_intersectUnIndexedTriangles(e,t,n,h,s){let r=null;for(let i=this.verticesStart;i<this.verticesStart+this.verticesCount;i+=3){let a=t[i],l=t[i+1],u=t[i+2];if(s&&!s(a,l,u,e,-1,-1,-1))continue;let o=e.intersectsTriangle(a,l,u);if(o){if(o.distance<0)continue;if((h||!r||o.distance<r.distance)&&(r=o,r.faceId=i/3,h))break}}return r}_rebuild(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)}clone(e,t){let n=new c(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,!1);if(!this.IsGlobal){let h=this.getBoundingInfo();if(!h)return n;n._boundingInfo=new x(h.minimum,h.maximum)}return n}dispose(e=!1){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);let t=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(t,1),this.resetDrawCache(void 0,e)}getClassName(){return"SubMesh"}static CreateFromIndices(e,t,n,h,s,r=!0){let i=Number.MAX_VALUE,a=-Number.MAX_VALUE,u=(s||h).getIndices();for(let o=t;o<t+n;o++){let d=u[o];d<i&&(i=d),d>a&&(a=d)}return new c(e,i,a-i+1,t,n,h,s,r)}};export{f as a,W as b};
