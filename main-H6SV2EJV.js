import"./chunk-6ZYTWFB7.js";import{a as d0,b as f0,c as p0,d as K,e as vi,f as _n}from"./chunk-USQHQODP.js";import"./chunk-RWH2PWGQ.js";import"./chunk-UCOVMCIN.js";import{a as Qi,b as I0,c as A0,e as n_,g as E0,h as Dc,i as rd}from"./chunk-XUCPIFVC.js";import{a as Mc}from"./chunk-R6NZNNKC.js";import{a as i_}from"./chunk-O4KX6OS6.js";import"./chunk-PAIB4B2M.js";import{a as S0}from"./chunk-IBLZLZZZ.js";import"./chunk-HYMNALGP.js";import"./chunk-A6K5JERA.js";import"./chunk-Z6SLAXJD.js";import{a as t_}from"./chunk-ECE5LYUU.js";import{r as C0,u as nd,v as T0}from"./chunk-3I5CJTBG.js";import"./chunk-L5ZS7BLX.js";import{a as y0,b as Va}from"./chunk-Y4LIOE5P.js";import"./chunk-OTG5DIDJ.js";import{a as e_,b as b0}from"./chunk-3CQOVPBJ.js";import{c as Fn,d as x0}from"./chunk-NYOR2HEC.js";import{a as Cr,c as v0}from"./chunk-V5DCP2TD.js";import{a as Ms,b as id,c as Ec,d as ie,e as Zi,i as wc}from"./chunk-OZ3JMH2S.js";import{a as ts}from"./chunk-R3OZJ4HQ.js";import{a as Jg,h as H}from"./chunk-ONKGPWX4.js";import"./chunk-PKQZ43HG.js";import"./chunk-EVKYJ67M.js";import"./chunk-XAO7YOQZ.js";import{a as Re,b as ed,c as ws,d as La,e as _0,f as Tr,g as Ba,h as td,i as ka}from"./chunk-FOF2SK5V.js";import{a as m0,b as g0,c as Xi}from"./chunk-DFECEQQR.js";import{b as a0}from"./chunk-GJAQLXVT.js";import{a as l0}from"./chunk-M7TLCLJJ.js";import"./chunk-X42FE4FQ.js";import"./chunk-LJGIHTVW.js";import"./chunk-NJEJ3VRH.js";import"./chunk-VJIYOY3Y.js";import{a as o0}from"./chunk-JFD5ORGB.js";import"./chunk-4OW5FSW4.js";import"./chunk-255BEQII.js";import{A as br,B as xr,C as i0,D as Da,E as zh,F as Hh,G as Ra,H as Wh,I as Pa,J as $h,K as jh,L as Oa,M as Na,N as qh,O as n0,P as Yh,Q as r0,R as Kh,S as Xh,T as Zh,U as Xg,V as Fe,W as Qg,X as Fa,Y as Ce,a as YT,b as KT,c as gn,d as Zn,e as Oe,f as ZT,g as Lh,h as Bh,i as QT,j as kh,k as Ac,l as As,m as vr,n as Yi,o as Es,p as Ki,q as at,r as Si,s as Nn,t as Vh,u as JT,v as Gh,w as Ma,x as e0,y as Uh,z as t0}from"./chunk-4RUJBL6Z.js";import{a as Ft,b as Zg,c as es}from"./chunk-DE7K33UC.js";import{a as Ee,c as Fh}from"./chunk-ESU2LKTX.js";import{a as Yt,b as s0}from"./chunk-ICZKPOAS.js";import{a as XT}from"./chunk-OOSHHHZN.js";import{a as Ut}from"./chunk-DTW6C2NU.js";import"./chunk-4L3AMN6L.js";import"./chunk-BBMLNH3A.js";import"./chunk-7FSFDK4E.js";import"./chunk-JTBODENQ.js";import"./chunk-BQPQ6TSI.js";import"./chunk-DXIW36IF.js";import"./chunk-FJN7KTAM.js";import"./chunk-ADGVNOWV.js";import"./chunk-RPO3NA2D.js";import"./chunk-MUVVFX4O.js";import"./chunk-CO7QZEHY.js";import"./chunk-TZYBJFW2.js";import"./chunk-MZYVXJQS.js";import"./chunk-TYRUT66Y.js";import"./chunk-QW6QJY4L.js";import"./chunk-EOCVTOQ7.js";import{a as kT}from"./chunk-PWPCYMHR.js";import{b as Nh}from"./chunk-MOVOTFJB.js";import{a as NT,b as LT,c as BT,e as wa,h as $T,i as hi,j as yr,k as di}from"./chunk-JPAFF2TZ.js";import"./chunk-2LR3BD57.js";import{b as Ph,c as Sc,d as FT}from"./chunk-QCR5HLUD.js";import"./chunk-G5DRJZ63.js";import{a as Li}from"./chunk-IMSFUDDL.js";import{a as Sa,b as _r,c as Me,d as Z}from"./chunk-7CJVMH7M.js";import"./chunk-NHIHMT2T.js";import{a as St,b as je}from"./chunk-CW5F3XFN.js";import{a as U,b as ce,c as ot}from"./chunk-NPZEPKVW.js";import{c as me,d as m,e as dt,f as Q,g as L,h as k}from"./chunk-FWZ75RMU.js";import{a as Dh,c as Dt,d as tt,e as Rh}from"./chunk-OPJEXU7D.js";import{b as jT,d as qT,f as Kg}from"./chunk-UCLR2IXJ.js";import"./chunk-IXCX32ZP.js";import{a as Tt,b as z,c as h0}from"./chunk-L2YUZR7F.js";import{a as Is,b as Oh,c as Ic}from"./chunk-MN5EAWYK.js";import{a as zT,b as HT,c as WT,d as ei,e as T,f as Ti}from"./chunk-6KAGRIFJ.js";import{a as w,c as Pe,d as B,e as Bi,f as mn,g as Ia,h as VT,i as Jt,j as Aa,l as GT,o as Yg,p as UT}from"./chunk-CCUABLZY.js";import{a as xa,b as Ca,c as PT,f as c0,m as u0,n as Qh,o as Jh}from"./chunk-N5PQEAVY.js";import{a as gr}from"./chunk-5SDLENZK.js";import{a as Ea}from"./chunk-XXSLHR3E.js";import{a as le,b as vt}from"./chunk-3WG2WLZ4.js";import{a as jg,b as Ae,c as Qt,e as On,h as Tc,i as qg}from"./chunk-ZUHEGR2G.js";import"./chunk-XI4OBPMN.js";import"./chunk-SO644OCK.js";import{C as Jr,E as ne,e as OT,h as $g,i as Cc,v as Pt,x as Ta}from"./chunk-OVVEAJWJ.js";import{a as Zt}from"./chunk-A3WFPZFR.js";import{a as RT,e as Xn}from"./chunk-CWQQB2EJ.js";import{a as ye}from"./chunk-PMYBMJFK.js";import{a as F}from"./chunk-CJK33JLH.js";import{a as P}from"./chunk-PTJ4CXVK.js";import{a as ht}from"./chunk-L3UYHT7M.js";import{a as Y,b as lt,f as DT,g as S}from"./chunk-YVY7FGQB.js";var Ii=null,sd=!1,s_=1,oR=null,Ln=Symbol("SIGNAL");function Ge(n){let e=Ii;return Ii=n,e}function od(){return Ii}var ad={version:0,lastCleanEpoch:0,dirty:!1,producers:void 0,producersTail:void 0,consumers:void 0,consumersTail:void 0,recomputing:!1,consumerAllowSignalWrites:!1,consumerIsAlwaysLive:!1,kind:"unknown",producerMustRecompute:()=>!1,producerRecomputeValue:()=>{},consumerMarkedDirty:()=>{},consumerOnSignalRead:()=>{}};function ld(n){if(sd)throw new Error("");if(Ii===null)return;Ii.consumerOnSignalRead(n);let e=Ii.producersTail;if(e!==void 0&&e.producer===n)return;let t,i=Ii.recomputing;if(i&&(t=e!==void 0?e.nextProducer:Ii.producers,t!==void 0&&t.producer===n)){Ii.producersTail=t,t.lastReadVersion=n.version;return}let r=n.consumersTail;if(r!==void 0&&r.consumer===Ii&&(!i||lR(r,Ii)))return;let s=Ga(Ii),o={producer:n,consumer:Ii,nextProducer:t,prevConsumer:r,lastReadVersion:n.version,nextConsumer:void 0};Ii.producersTail=o,e!==void 0?e.nextProducer=o:Ii.producers=o,s&&P0(n,o)}function w0(){s_++}function M0(n){if(!(Ga(n)&&!n.dirty)&&!(!n.dirty&&n.lastCleanEpoch===s_)){if(!n.producerMustRecompute(n)&&!ud(n)){r_(n);return}n.producerRecomputeValue(n),r_(n)}}function o_(n){if(n.consumers===void 0)return;let e=sd;sd=!0;try{for(let t=n.consumers;t!==void 0;t=t.nextConsumer){let i=t.consumer;i.dirty||aR(i)}}finally{sd=e}}function a_(){return Ii?.consumerAllowSignalWrites!==!1}function aR(n){n.dirty=!0,o_(n),n.consumerMarkedDirty?.(n)}function r_(n){n.dirty=!1,n.lastCleanEpoch=s_}function cd(n){return n&&D0(n),Ge(n)}function D0(n){n.producersTail=void 0,n.recomputing=!0}function l_(n,e){Ge(e),n&&R0(n)}function R0(n){n.recomputing=!1;let e=n.producersTail,t=e!==void 0?e.nextProducer:n.producers;if(t!==void 0){if(Ga(n))do t=c_(t);while(t!==void 0);e!==void 0?e.nextProducer=void 0:n.producers=void 0}}function ud(n){for(let e=n.producers;e!==void 0;e=e.nextProducer){let t=e.producer,i=e.lastReadVersion;if(i!==t.version||(M0(t),i!==t.version))return!0}return!1}function Rc(n){if(Ga(n)){let e=n.producers;for(;e!==void 0;)e=c_(e)}n.producers=void 0,n.producersTail=void 0,n.consumers=void 0,n.consumersTail=void 0}function P0(n,e){let t=n.consumersTail,i=Ga(n);if(t!==void 0?(e.nextConsumer=t.nextConsumer,t.nextConsumer=e):(e.nextConsumer=void 0,n.consumers=e),e.prevConsumer=t,n.consumersTail=e,!i)for(let r=n.producers;r!==void 0;r=r.nextProducer)P0(r.producer,r)}function c_(n){let e=n.producer,t=n.nextProducer,i=n.nextConsumer,r=n.prevConsumer;if(n.nextConsumer=void 0,n.prevConsumer=void 0,i!==void 0?i.prevConsumer=r:e.consumersTail=r,r!==void 0)r.nextConsumer=i;else if(e.consumers=i,!Ga(e)){let s=e.producers;for(;s!==void 0;)s=c_(s)}return t}function Ga(n){return n.consumerIsAlwaysLive||n.consumers!==void 0}function O0(n){oR?.(n)}function lR(n,e){let t=e.producersTail;if(t!==void 0){let i=e.producers;do{if(i===n)return!0;if(i===t)break;i=i.nextProducer}while(i!==void 0)}return!1}function N0(n,e){return Object.is(n,e)}function cR(){throw new Error}var F0=cR;function L0(n){F0(n)}function u_(n){F0=n}var uR=null;function h_(n,e){let t=Object.create(hd);t.value=n,e!==void 0&&(t.equal=e);let i=()=>B0(t);return i[Ln]=t,O0(t),[i,o=>Pc(t,o),o=>k0(t,o)]}function B0(n){return ld(n),n.value}function Pc(n,e){a_()||L0(n),n.equal(n.value,e)||(n.value=e,hR(n))}function k0(n,e){a_()||L0(n),Pc(n,e(n.value))}var hd=lt(Y({},ad),{equal:N0,value:void 0,kind:"signal"});function hR(n){n.version++,w0(),o_(n),uR?.(n)}function d_(n){let e=Ge(null);try{return n()}finally{Ge(e)}}function He(n){return typeof n=="function"}function Ua(n){let t=n(i=>{Error.call(i),i.stack=new Error().stack});return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var dd=Ua(n=>function(t){n(this),this.message=t?`${t.length} errors occurred during unsubscription:
${t.map((i,r)=>`${r+1}) ${i.toString()}`).join(`
  `)}`:"",this.name="UnsubscriptionError",this.errors=t});function lo(n,e){if(n){let t=n.indexOf(e);0<=t&&n.splice(t,1)}}var zt=class n{constructor(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let e;if(!this.closed){this.closed=!0;let{_parentage:t}=this;if(t)if(this._parentage=null,Array.isArray(t))for(let s of t)s.remove(this);else t.remove(this);let{initialTeardown:i}=this;if(He(i))try{i()}catch(s){e=s instanceof dd?s.errors:[s]}let{_finalizers:r}=this;if(r){this._finalizers=null;for(let s of r)try{V0(s)}catch(o){e=e??[],o instanceof dd?e=[...e,...o.errors]:e.push(o)}}if(e)throw new dd(e)}}add(e){var t;if(e&&e!==this)if(this.closed)V0(e);else{if(e instanceof n){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=(t=this._finalizers)!==null&&t!==void 0?t:[]).push(e)}}_hasParent(e){let{_parentage:t}=this;return t===e||Array.isArray(t)&&t.includes(e)}_addParent(e){let{_parentage:t}=this;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e}_removeParent(e){let{_parentage:t}=this;t===e?this._parentage=null:Array.isArray(t)&&lo(t,e)}remove(e){let{_finalizers:t}=this;t&&lo(t,e),e instanceof n&&e._removeParent(this)}};zt.EMPTY=(()=>{let n=new zt;return n.closed=!0,n})();var f_=zt.EMPTY;function fd(n){return n instanceof zt||n&&"closed"in n&&He(n.remove)&&He(n.add)&&He(n.unsubscribe)}function V0(n){He(n)?n():n.unsubscribe()}var Qn={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1};var za={setTimeout(n,e,...t){let{delegate:i}=za;return i?.setTimeout?i.setTimeout(n,e,...t):setTimeout(n,e,...t)},clearTimeout(n){let{delegate:e}=za;return(e?.clearTimeout||clearTimeout)(n)},delegate:void 0};function pd(n){za.setTimeout(()=>{let{onUnhandledError:e}=Qn;if(e)e(n);else throw n})}function co(){}var G0=p_("C",void 0,void 0);function U0(n){return p_("E",void 0,n)}function z0(n){return p_("N",n,void 0)}function p_(n,e,t){return{kind:n,value:e,error:t}}var uo=null;function Ha(n){if(Qn.useDeprecatedSynchronousErrorHandling){let e=!uo;if(e&&(uo={errorThrown:!1,error:null}),n(),e){let{errorThrown:t,error:i}=uo;if(uo=null,t)throw i}}else n()}function H0(n){Qn.useDeprecatedSynchronousErrorHandling&&uo&&(uo.errorThrown=!0,uo.error=n)}var ho=class extends zt{constructor(e){super(),this.isStopped=!1,e?(this.destination=e,fd(e)&&e.add(this)):this.destination=pR}static create(e,t,i){return new Wa(e,t,i)}next(e){this.isStopped?g_(z0(e),this):this._next(e)}error(e){this.isStopped?g_(U0(e),this):(this.isStopped=!0,this._error(e))}complete(){this.isStopped?g_(G0,this):(this.isStopped=!0,this._complete())}unsubscribe(){this.closed||(this.isStopped=!0,super.unsubscribe(),this.destination=null)}_next(e){this.destination.next(e)}_error(e){try{this.destination.error(e)}finally{this.unsubscribe()}}_complete(){try{this.destination.complete()}finally{this.unsubscribe()}}},dR=Function.prototype.bind;function m_(n,e){return dR.call(n,e)}var __=class{constructor(e){this.partialObserver=e}next(e){let{partialObserver:t}=this;if(t.next)try{t.next(e)}catch(i){md(i)}}error(e){let{partialObserver:t}=this;if(t.error)try{t.error(e)}catch(i){md(i)}else md(e)}complete(){let{partialObserver:e}=this;if(e.complete)try{e.complete()}catch(t){md(t)}}},Wa=class extends ho{constructor(e,t,i){super();let r;if(He(e)||!e)r={next:e??void 0,error:t??void 0,complete:i??void 0};else{let s;this&&Qn.useDeprecatedNextContext?(s=Object.create(e),s.unsubscribe=()=>this.unsubscribe(),r={next:e.next&&m_(e.next,s),error:e.error&&m_(e.error,s),complete:e.complete&&m_(e.complete,s)}):r=e}this.destination=new __(r)}};function md(n){Qn.useDeprecatedSynchronousErrorHandling?H0(n):pd(n)}function fR(n){throw n}function g_(n,e){let{onStoppedNotification:t}=Qn;t&&za.setTimeout(()=>t(n,e))}var pR={closed:!0,next:co,error:fR,complete:co};var $a=typeof Symbol=="function"&&Symbol.observable||"@@observable";function Jn(n){return n}function y_(...n){return v_(n)}function v_(n){return n.length===0?Jn:n.length===1?n[0]:function(t){return n.reduce((i,r)=>r(i),t)}}var ct=(()=>{class n{constructor(t){t&&(this._subscribe=t)}lift(t){let i=new n;return i.source=this,i.operator=t,i}subscribe(t,i,r){let s=gR(t)?t:new Wa(t,i,r);return Ha(()=>{let{operator:o,source:a}=this;s.add(o?o.call(s,a):a?this._subscribe(s):this._trySubscribe(s))}),s}_trySubscribe(t){try{return this._subscribe(t)}catch(i){t.error(i)}}forEach(t,i){return i=W0(i),new i((r,s)=>{let o=new Wa({next:a=>{try{t(a)}catch(l){s(l),o.unsubscribe()}},error:s,complete:r});this.subscribe(o)})}_subscribe(t){var i;return(i=this.source)===null||i===void 0?void 0:i.subscribe(t)}[$a](){return this}pipe(...t){return v_(t)(this)}toPromise(t){return t=W0(t),new t((i,r)=>{let s;this.subscribe(o=>s=o,o=>r(o),()=>i(s))})}}return n.create=e=>new n(e),n})();function W0(n){var e;return(e=n??Qn.Promise)!==null&&e!==void 0?e:Promise}function mR(n){return n&&He(n.next)&&He(n.error)&&He(n.complete)}function gR(n){return n&&n instanceof ho||mR(n)&&fd(n)}function _R(n){return He(n?.lift)}function ft(n){return e=>{if(_R(e))return e.lift(function(t){try{return n(t,this)}catch(i){this.error(i)}});throw new TypeError("Unable to lift unknown Observable type")}}function gt(n,e,t,i,r){return new b_(n,e,t,i,r)}var b_=class extends ho{constructor(e,t,i,r,s,o){super(e),this.onFinalize=s,this.shouldUnsubscribe=o,this._next=t?function(a){try{t(a)}catch(l){e.error(l)}}:super._next,this._error=r?function(a){try{r(a)}catch(l){e.error(l)}finally{this.unsubscribe()}}:super._error,this._complete=i?function(){try{i()}catch(a){e.error(a)}finally{this.unsubscribe()}}:super._complete}unsubscribe(){var e;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){let{closed:t}=this;super.unsubscribe(),!t&&((e=this.onFinalize)===null||e===void 0||e.call(this))}}};var $0=Ua(n=>function(){n(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"});var ti=(()=>{class n extends ct{constructor(){super(),this.closed=!1,this.currentObservers=null,this.observers=[],this.isStopped=!1,this.hasError=!1,this.thrownError=null}lift(t){let i=new gd(this,this);return i.operator=t,i}_throwIfClosed(){if(this.closed)throw new $0}next(t){Ha(()=>{if(this._throwIfClosed(),!this.isStopped){this.currentObservers||(this.currentObservers=Array.from(this.observers));for(let i of this.currentObservers)i.next(t)}})}error(t){Ha(()=>{if(this._throwIfClosed(),!this.isStopped){this.hasError=this.isStopped=!0,this.thrownError=t;let{observers:i}=this;for(;i.length;)i.shift().error(t)}})}complete(){Ha(()=>{if(this._throwIfClosed(),!this.isStopped){this.isStopped=!0;let{observers:t}=this;for(;t.length;)t.shift().complete()}})}unsubscribe(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null}get observed(){var t;return((t=this.observers)===null||t===void 0?void 0:t.length)>0}_trySubscribe(t){return this._throwIfClosed(),super._trySubscribe(t)}_subscribe(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)}_innerSubscribe(t){let{hasError:i,isStopped:r,observers:s}=this;return i||r?f_:(this.currentObservers=null,s.push(t),new zt(()=>{this.currentObservers=null,lo(s,t)}))}_checkFinalizedStatuses(t){let{hasError:i,thrownError:r,isStopped:s}=this;i?t.error(r):s&&t.complete()}asObservable(){let t=new ct;return t.source=this,t}}return n.create=(e,t)=>new gd(e,t),n})(),gd=class extends ti{constructor(e,t){super(),this.destination=e,this.source=t}next(e){var t,i;(i=(t=this.destination)===null||t===void 0?void 0:t.next)===null||i===void 0||i.call(t,e)}error(e){var t,i;(i=(t=this.destination)===null||t===void 0?void 0:t.error)===null||i===void 0||i.call(t,e)}complete(){var e,t;(t=(e=this.destination)===null||e===void 0?void 0:e.complete)===null||t===void 0||t.call(e)}_subscribe(e){var t,i;return(i=(t=this.source)===null||t===void 0?void 0:t.subscribe(e))!==null&&i!==void 0?i:f_}};var Ot=class extends ti{constructor(e){super(),this._value=e}get value(){return this.getValue()}_subscribe(e){let t=super._subscribe(e);return!t.closed&&e.next(this._value),t}getValue(){let{hasError:e,thrownError:t,_value:i}=this;if(e)throw t;return this._throwIfClosed(),i}next(e){super.next(this._value=e)}};var x_={now(){return(x_.delegate||Date).now()},delegate:void 0};var _d=class extends zt{constructor(e,t){super()}schedule(e,t=0){return this}};var Oc={setInterval(n,e,...t){let{delegate:i}=Oc;return i?.setInterval?i.setInterval(n,e,...t):setInterval(n,e,...t)},clearInterval(n){let{delegate:e}=Oc;return(e?.clearInterval||clearInterval)(n)},delegate:void 0};var yd=class extends _d{constructor(e,t){super(e,t),this.scheduler=e,this.work=t,this.pending=!1}schedule(e,t=0){var i;if(this.closed)return this;this.state=e;let r=this.id,s=this.scheduler;return r!=null&&(this.id=this.recycleAsyncId(s,r,t)),this.pending=!0,this.delay=t,this.id=(i=this.id)!==null&&i!==void 0?i:this.requestAsyncId(s,this.id,t),this}requestAsyncId(e,t,i=0){return Oc.setInterval(e.flush.bind(e,this),i)}recycleAsyncId(e,t,i=0){if(i!=null&&this.delay===i&&this.pending===!1)return t;t!=null&&Oc.clearInterval(t)}execute(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;let i=this._execute(e,t);if(i)return i;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))}_execute(e,t){let i=!1,r;try{this.work(e)}catch(s){i=!0,r=s||new Error("Scheduled action threw falsy error")}if(i)return this.unsubscribe(),r}unsubscribe(){if(!this.closed){let{id:e,scheduler:t}=this,{actions:i}=t;this.work=this.state=this.scheduler=null,this.pending=!1,lo(i,this),e!=null&&(this.id=this.recycleAsyncId(t,e,null)),this.delay=null,super.unsubscribe()}}};var ja=class n{constructor(e,t=n.now){this.schedulerActionCtor=e,this.now=t}schedule(e,t=0,i){return new this.schedulerActionCtor(this,e).schedule(i,t)}};ja.now=x_.now;var vd=class extends ja{constructor(e,t=ja.now){super(e,t),this.actions=[],this._active=!1}flush(e){let{actions:t}=this;if(this._active){t.push(e);return}let i;this._active=!0;do if(i=e.execute(e.state,e.delay))break;while(e=t.shift());if(this._active=!1,i){for(;e=t.shift();)e.unsubscribe();throw i}}};var C_=new vd(yd),j0=C_;var Ji=new ct(n=>n.complete());function bd(n){return n&&He(n.schedule)}function q0(n){return n[n.length-1]}function Y0(n){return He(q0(n))?n.pop():void 0}function Ds(n){return bd(q0(n))?n.pop():void 0}function X0(n,e,t,i){function r(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function a(u){try{c(i.next(u))}catch(h){o(h)}}function l(u){try{c(i.throw(u))}catch(h){o(h)}}function c(u){u.done?s(u.value):r(u.value).then(a,l)}c((i=i.apply(n,e||[])).next())})}function K0(n){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&n[e],i=0;if(t)return t.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&i>=n.length&&(n=void 0),{value:n&&n[i++],done:!n}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function fo(n){return this instanceof fo?(this.v=n,this):new fo(n)}function Z0(n,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=t.apply(n,e||[]),r,s=[];return r=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),a("next"),a("throw"),a("return",o),r[Symbol.asyncIterator]=function(){return this},r;function o(f){return function(p){return Promise.resolve(p).then(f,h)}}function a(f,p){i[f]&&(r[f]=function(g){return new Promise(function(_,y){s.push([f,g,_,y])>1||l(f,g)})},p&&(r[f]=p(r[f])))}function l(f,p){try{c(i[f](p))}catch(g){d(s[0][3],g)}}function c(f){f.value instanceof fo?Promise.resolve(f.value.v).then(u,h):d(s[0][2],f)}function u(f){l("next",f)}function h(f){l("throw",f)}function d(f,p){f(p),s.shift(),s.length&&l(s[0][0],s[0][1])}}function Q0(n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=n[Symbol.asyncIterator],t;return e?e.call(n):(n=typeof K0=="function"?K0(n):n[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(s){t[s]=n[s]&&function(o){return new Promise(function(a,l){o=n[s](o),r(a,l,o.done,o.value)})}}function r(s,o,a,l){Promise.resolve(l).then(function(c){s({value:c,done:a})},o)}}var xd=n=>n&&typeof n.length=="number"&&typeof n!="function";function Cd(n){return He(n?.then)}function Td(n){return He(n[$a])}function Sd(n){return Symbol.asyncIterator&&He(n?.[Symbol.asyncIterator])}function Id(n){return new TypeError(`You provided ${n!==null&&typeof n=="object"?"an invalid object":`'${n}'`} where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.`)}function yR(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Ad=yR();function Ed(n){return He(n?.[Ad])}function wd(n){return Z0(this,arguments,function*(){let t=n.getReader();try{for(;;){let{value:i,done:r}=yield fo(t.read());if(r)return yield fo(void 0);yield yield fo(i)}}finally{t.releaseLock()}})}function Md(n){return He(n?.getReader)}function Kt(n){if(n instanceof ct)return n;if(n!=null){if(Td(n))return vR(n);if(xd(n))return bR(n);if(Cd(n))return xR(n);if(Sd(n))return J0(n);if(Ed(n))return CR(n);if(Md(n))return TR(n)}throw Id(n)}function vR(n){return new ct(e=>{let t=n[$a]();if(He(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function bR(n){return new ct(e=>{for(let t=0;t<n.length&&!e.closed;t++)e.next(n[t]);e.complete()})}function xR(n){return new ct(e=>{n.then(t=>{e.closed||(e.next(t),e.complete())},t=>e.error(t)).then(null,pd)})}function CR(n){return new ct(e=>{for(let t of n)if(e.next(t),e.closed)return;e.complete()})}function J0(n){return new ct(e=>{SR(n,e).catch(t=>e.error(t))})}function TR(n){return J0(wd(n))}function SR(n,e){var t,i,r,s;return X0(this,void 0,void 0,function*(){try{for(t=Q0(n);i=yield t.next(),!i.done;){let o=i.value;if(e.next(o),e.closed)return}}catch(o){r={error:o}}finally{try{i&&!i.done&&(s=t.return)&&(yield s.call(t))}finally{if(r)throw r.error}}e.complete()})}function en(n,e,t,i=0,r=!1){let s=e.schedule(function(){t(),r?n.add(this.schedule(null,i)):this.unsubscribe()},i);if(n.add(s),!r)return s}function Dd(n,e=0){return ft((t,i)=>{t.subscribe(gt(i,r=>en(i,n,()=>i.next(r),e),()=>en(i,n,()=>i.complete(),e),r=>en(i,n,()=>i.error(r),e)))})}function Rd(n,e=0){return ft((t,i)=>{i.add(n.schedule(()=>t.subscribe(i),e))})}function eS(n,e){return Kt(n).pipe(Rd(e),Dd(e))}function tS(n,e){return Kt(n).pipe(Rd(e),Dd(e))}function iS(n,e){return new ct(t=>{let i=0;return e.schedule(function(){i===n.length?t.complete():(t.next(n[i++]),t.closed||this.schedule())})})}function nS(n,e){return new ct(t=>{let i;return en(t,e,()=>{i=n[Ad](),en(t,e,()=>{let r,s;try{({value:r,done:s}=i.next())}catch(o){t.error(o);return}s?t.complete():t.next(r)},0,!0)}),()=>He(i?.return)&&i.return()})}function Pd(n,e){if(!n)throw new Error("Iterable cannot be null");return new ct(t=>{en(t,e,()=>{let i=n[Symbol.asyncIterator]();en(t,e,()=>{i.next().then(r=>{r.done?t.complete():t.next(r.value)})},0,!0)})})}function rS(n,e){return Pd(wd(n),e)}function sS(n,e){if(n!=null){if(Td(n))return eS(n,e);if(xd(n))return iS(n,e);if(Cd(n))return tS(n,e);if(Sd(n))return Pd(n,e);if(Ed(n))return nS(n,e);if(Md(n))return rS(n,e)}throw Id(n)}function fi(n,e){return e?sS(n,e):Kt(n)}function et(...n){let e=Ds(n);return fi(n,e)}function T_(n,e){let t=He(n)?n:()=>n,i=r=>r.error(t());return new ct(e?r=>e.schedule(i,0,r):i)}function Od(n){return!!n&&(n instanceof ct||He(n.lift)&&He(n.subscribe))}var po=Ua(n=>function(){n(this),this.name="EmptyError",this.message="no elements in sequence"});function oS(n){return n instanceof Date&&!isNaN(n)}function At(n,e){return ft((t,i)=>{let r=0;t.subscribe(gt(i,s=>{i.next(n.call(e,s,r++))}))})}var{isArray:IR}=Array;function AR(n,e){return IR(e)?n(...e):n(e)}function aS(n){return At(e=>AR(n,e))}var{isArray:ER}=Array,{getPrototypeOf:wR,prototype:MR,keys:DR}=Object;function lS(n){if(n.length===1){let e=n[0];if(ER(e))return{args:e,keys:null};if(RR(e)){let t=DR(e);return{args:t.map(i=>e[i]),keys:t}}}return{args:n,keys:null}}function RR(n){return n&&typeof n=="object"&&wR(n)===MR}function cS(n,e){return n.reduce((t,i,r)=>(t[i]=e[r],t),{})}function S_(...n){let e=Ds(n),t=Y0(n),{args:i,keys:r}=lS(n);if(i.length===0)return fi([],e);let s=new ct(PR(i,e,r?o=>cS(r,o):Jn));return t?s.pipe(aS(t)):s}function PR(n,e,t=Jn){return i=>{uS(e,()=>{let{length:r}=n,s=new Array(r),o=r,a=r;for(let l=0;l<r;l++)uS(e,()=>{let c=fi(n[l],e),u=!1;c.subscribe(gt(i,h=>{s[l]=h,u||(u=!0,a--),a||i.next(t(s.slice()))},()=>{--o||i.complete()}))},i)},i)}}function uS(n,e,t){n?en(t,n,e):e()}function hS(n,e,t,i,r,s,o,a){let l=[],c=0,u=0,h=!1,d=()=>{h&&!l.length&&!c&&e.complete()},f=g=>c<i?p(g):l.push(g),p=g=>{s&&e.next(g),c++;let _=!1;Kt(t(g,u++)).subscribe(gt(e,y=>{r?.(y),s?f(y):e.next(y)},()=>{_=!0},void 0,()=>{if(_)try{for(c--;l.length&&c<i;){let y=l.shift();o?en(e,o,()=>p(y)):p(y)}d()}catch(y){e.error(y)}}))};return n.subscribe(gt(e,f,()=>{h=!0,d()})),()=>{a?.()}}function bi(n,e,t=1/0){return He(e)?bi((i,r)=>At((s,o)=>e(i,s,r,o))(Kt(n(i,r))),t):(typeof e=="number"&&(t=e),ft((i,r)=>hS(i,r,n,t)))}function dS(n=1/0){return bi(Jn,n)}function fS(){return dS(1)}function Rs(...n){return fS()(fi(n,Ds(n)))}function Nc(n){return new ct(e=>{Kt(n()).subscribe(e)})}function pS(n=0,e,t=j0){let i=-1;return e!=null&&(bd(e)?t=e:i=e),new ct(r=>{let s=oS(n)?+n-t.now():n;s<0&&(s=0);let o=0;return t.schedule(function(){r.closed||(r.next(o++),0<=i?this.schedule(void 0,i):r.complete())},s)})}function Sr(n,e){return ft((t,i)=>{let r=0;t.subscribe(gt(i,s=>n.call(e,s,r++)&&i.next(s)))})}function Fc(n){return ft((e,t)=>{let i=null,r=!1,s;i=e.subscribe(gt(t,void 0,void 0,o=>{s=Kt(n(o,Fc(n)(e))),i?(i.unsubscribe(),i=null,s.subscribe(t)):r=!0})),r&&(i.unsubscribe(),i=null,s.subscribe(t))})}function mo(n,e){return He(e)?bi(n,e,1):bi(n,1)}function I_(n){return ft((e,t)=>{let i=!1;e.subscribe(gt(t,r=>{i=!0,t.next(r)},()=>{i||t.next(n),t.complete()}))})}function Bn(n){return n<=0?()=>Ji:ft((e,t)=>{let i=0;e.subscribe(gt(t,r=>{++i<=n&&(t.next(r),n<=i&&t.complete())}))})}function mS(){return ft((n,e)=>{n.subscribe(gt(e,co))})}function gS(n){return At(()=>n)}function A_(n,e){return e?t=>Rs(e.pipe(Bn(1),mS()),t.pipe(A_(n))):bi((t,i)=>Kt(n(t,i)).pipe(Bn(1),gS(t)))}function Nd(n,e=C_){let t=pS(n,e);return A_(()=>t)}function _S(n=OR){return ft((e,t)=>{let i=!1;e.subscribe(gt(t,r=>{i=!0,t.next(r)},()=>i?t.complete():t.error(n())))})}function OR(){return new po}function E_(n){return ft((e,t)=>{try{e.subscribe(t)}finally{t.add(n)}})}function is(n,e){let t=arguments.length>=2;return i=>i.pipe(n?Sr((r,s)=>n(r,s,i)):Jn,Bn(1),t?I_(e):_S(()=>new po))}function Fd(n){return n<=0?()=>Ji:ft((e,t)=>{let i=[];e.subscribe(gt(t,r=>{i.push(r),n<i.length&&i.shift()},()=>{for(let r of i)t.next(r);t.complete()},void 0,()=>{i=null}))})}function w_(...n){let e=Ds(n);return ft((t,i)=>{(e?Rs(n,t,e):Rs(n,t)).subscribe(i)})}function Ir(n,e){return ft((t,i)=>{let r=null,s=0,o=!1,a=()=>o&&!r&&i.complete();t.subscribe(gt(i,l=>{r?.unsubscribe();let c=0,u=s++;Kt(n(l,u)).subscribe(r=gt(i,h=>i.next(e?e(l,h,u,c++):h),()=>{r=null,a()}))},()=>{o=!0,a()}))})}function Lc(n){return ft((e,t)=>{Kt(n).subscribe(gt(t,()=>t.complete(),co)),!t.closed&&e.subscribe(t)})}function pi(n,e,t){let i=He(n)||e||t?{next:n,error:e,complete:t}:n;return i?ft((r,s)=>{var o;(o=i.subscribe)===null||o===void 0||o.call(i);let a=!0;r.subscribe(gt(s,l=>{var c;(c=i.next)===null||c===void 0||c.call(i,l),s.next(l)},()=>{var l;a=!1,(l=i.complete)===null||l===void 0||l.call(i),s.complete()},l=>{var c;a=!1,(c=i.error)===null||c===void 0||c.call(i,l),s.error(l)},()=>{var l,c;a&&((l=i.unsubscribe)===null||l===void 0||l.call(i)),(c=i.finalize)===null||c===void 0||c.call(i)}))}):Jn}var M_;function Ld(){return M_}function Ar(n){let e=M_;return M_=n,e}var yS=Symbol("NotFound");function qa(n){return n===yS||n?.name==="\u0275NotFound"}var zd="https://angular.dev/best-practices/security#preventing-cross-site-scripting-xss",Le=class extends Error{code;constructor(e,t){super(Ka(e,t)),this.code=e}};function BR(n){return`NG0${Math.abs(n)}`}function Ka(n,e){return`${BR(n)}${e?": "+e:""}`}function _t(n){for(let e in n)if(n[e]===_t)return e;throw Error("")}function rs(n){if(typeof n=="string")return n;if(Array.isArray(n))return`[${n.map(rs).join(", ")}]`;if(n==null)return""+n;let e=n.overriddenName||n.name;if(e)return`${e}`;let t=n.toString();if(t==null)return""+t;let i=t.indexOf(`
`);return i>=0?t.slice(0,i):t}function W_(n,e){return n?e?`${n} ${e}`:n:e||""}var kR=_t({__forward_ref__:_t});function Hd(n){return n.__forward_ref__=Hd,n.toString=function(){return rs(this())},n}function tn(n){return $_(n)?n():n}function $_(n){return typeof n=="function"&&n.hasOwnProperty(kR)&&n.__forward_ref__===Hd}function Ne(n){return{token:n.token,providedIn:n.providedIn||null,factory:n.factory,value:void 0}}function Xa(n){return{providers:n.providers||[],imports:n.imports||[]}}function zc(n){return VR(n,Wd)}function j_(n){return zc(n)!==null}function VR(n,e){return n.hasOwnProperty(e)&&n[e]||null}function GR(n){let e=n?.[Wd]??null;return e||null}function R_(n){return n&&n.hasOwnProperty(kd)?n[kd]:null}var Wd=_t({\u0275prov:_t}),kd=_t({\u0275inj:_t}),Ue=class{_desc;ngMetadataName="InjectionToken";\u0275prov;constructor(e,t){this._desc=e,this.\u0275prov=void 0,typeof t=="number"?this.__NG_ELEMENT_ID__=t:t!==void 0&&(this.\u0275prov=Ne({token:this,providedIn:t.providedIn||"root",factory:t.factory}))}get multi(){return this}toString(){return`InjectionToken ${this._desc}`}};function q_(n){return n&&!!n.\u0275providers}var Y_=_t({\u0275cmp:_t}),K_=_t({\u0275dir:_t}),X_=_t({\u0275pipe:_t}),Z_=_t({\u0275mod:_t}),kc=_t({\u0275fac:_t}),bo=_t({__NG_ELEMENT_ID__:_t}),vS=_t({__NG_ENV_ID__:_t});function $d(n){return typeof n=="string"?n:n==null?"":String(n)}function TS(n){return typeof n=="function"?n.name||n.toString():typeof n=="object"&&n!=null&&typeof n.type=="function"?n.type.name||n.type.toString():$d(n)}var SS=_t({ngErrorCode:_t}),UR=_t({ngErrorMessage:_t}),zR=_t({ngTokenPath:_t});function Q_(n,e){return IS("",-200,e)}function jd(n,e){throw new Le(-201,!1)}function IS(n,e,t){let i=new Le(e,n);return i[SS]=e,i[UR]=n,t&&(i[zR]=t),i}function HR(n){return n[SS]}var P_;function AS(){return P_}function ki(n){let e=P_;return P_=n,e}function J_(n,e,t){let i=zc(n);if(i&&i.providedIn=="root")return i.value===void 0?i.value=i.factory():i.value;if(t&8)return null;if(e!==void 0)return e;jd(n,"Injector")}var WR={},go=WR,$R="__NG_DI_FLAG__",O_=class{injector;constructor(e){this.injector=e}retrieve(e,t){let i=_o(t)||0;try{return this.injector.get(e,i&8?null:go,i)}catch(r){if(qa(r))return r;throw r}}};function jR(n,e=0){let t=Ld();if(t===void 0)throw new Le(-203,!1);if(t===null)return J_(n,void 0,e);{let i=qR(e),r=t.retrieve(n,i);if(qa(r)){if(i.optional)return null;throw r}return r}}function qe(n,e=0){return(AS()||jR)(tn(n),e)}function ue(n,e){return qe(n,_o(e))}function _o(n){return typeof n>"u"||typeof n=="number"?n:0|(n.optional&&8)|(n.host&&1)|(n.self&&2)|(n.skipSelf&&4)}function qR(n){return{optional:!!(n&8),host:!!(n&1),self:!!(n&2),skipSelf:!!(n&4)}}function N_(n){let e=[];for(let t=0;t<n.length;t++){let i=tn(n[t]);if(Array.isArray(i)){if(i.length===0)throw new Le(900,!1);let r,s=0;for(let o=0;o<i.length;o++){let a=i[o],l=YR(a);typeof l=="number"?l===-1?r=a.token:s|=l:r=a}e.push(qe(r,s))}else e.push(qe(i))}return e}function YR(n){return n[$R]}function Ps(n,e){let t=n.hasOwnProperty(kc);return t?n[kc]:null}function ES(n,e,t){if(n.length!==e.length)return!1;for(let i=0;i<n.length;i++){let r=n[i],s=e[i];if(t&&(r=t(r),s=t(s)),s!==r)return!1}return!0}function wS(n){return n.flat(Number.POSITIVE_INFINITY)}function qd(n,e){n.forEach(t=>Array.isArray(t)?qd(t,e):e(t))}function ey(n,e,t){e>=n.length?n.push(t):n.splice(e,0,t)}function Hc(n,e){return e>=n.length-1?n.pop():n.splice(e,1)[0]}function MS(n,e,t,i){let r=n.length;if(r==e)n.push(t,i);else if(r===1)n.push(i,n[0]),n[0]=t;else{for(r--,n.push(n[r-1],n[r]);r>e;){let s=r-2;n[r]=n[s],r--}n[e]=t,n[e+1]=i}}function DS(n,e,t){let i=Za(n,e);return i>=0?n[i|1]=t:(i=~i,MS(n,i,e,t)),i}function Yd(n,e){let t=Za(n,e);if(t>=0)return n[t|1]}function Za(n,e){return KR(n,e,1)}function KR(n,e,t){let i=0,r=n.length>>t;for(;r!==i;){let s=i+(r-i>>1),o=n[s<<t];if(e===o)return s<<t;o>e?r=s:i=s+1}return~(r<<t)}var xo={},kn=[],Ns=new Ue(""),ty=new Ue("",-1),iy=new Ue(""),Vc=class{get(e,t=go){if(t===go){let r=IS("",-201);throw r.name="\u0275NotFound",r}return t}};function ny(n){return n[Z_]||null}function Fs(n){return n[Y_]||null}function ry(n){return n[K_]||null}function RS(n){return n[X_]||null}function Qa(n){return{\u0275providers:n}}function PS(...n){return{\u0275providers:sy(!0,n),\u0275fromNgModule:!0}}function sy(n,...e){let t=[],i=new Set,r,s=o=>{t.push(o)};return qd(e,o=>{let a=o;Vd(a,s,[],i)&&(r||=[],r.push(a))}),r!==void 0&&OS(r,s),t}function OS(n,e){for(let t=0;t<n.length;t++){let{ngModule:i,providers:r}=n[t];oy(r,s=>{e(s,i)})}}function Vd(n,e,t,i){if(n=tn(n),!n)return!1;let r=null,s=R_(n),o=!s&&Fs(n);if(!s&&!o){let l=n.ngModule;if(s=R_(l),s)r=l;else return!1}else{if(o&&!o.standalone)return!1;r=n}let a=i.has(r);if(o){if(a)return!1;if(i.add(r),o.dependencies){let l=typeof o.dependencies=="function"?o.dependencies():o.dependencies;for(let c of l)Vd(c,e,t,i)}}else if(s){if(s.imports!=null&&!a){i.add(r);let c;try{qd(s.imports,u=>{Vd(u,e,t,i)&&(c||=[],c.push(u))})}finally{}c!==void 0&&OS(c,e)}if(!a){let c=Ps(r)||(()=>new r);e({provide:r,useFactory:c,deps:kn},r),e({provide:iy,useValue:r,multi:!0},r),e({provide:Ns,useValue:()=>qe(r),multi:!0},r)}let l=s.providers;if(l!=null&&!a){let c=n;oy(l,u=>{e(u,c)})}}else return!1;return r!==n&&n.providers!==void 0}function oy(n,e){for(let t of n)q_(t)&&(t=t.\u0275providers),Array.isArray(t)?oy(t,e):e(t)}var XR=_t({provide:String,useValue:_t});function NS(n){return n!==null&&typeof n=="object"&&XR in n}function ZR(n){return!!(n&&n.useExisting)}function QR(n){return!!(n&&n.useFactory)}function Gd(n){return typeof n=="function"}var Wc=new Ue(""),Bd={},bS={},D_;function $c(){return D_===void 0&&(D_=new Vc),D_}var Ai=class{},yo=class extends Ai{parent;source;scopes;records=new Map;_ngOnDestroyHooks=new Set;_onDestroyHooks=[];get destroyed(){return this._destroyed}_destroyed=!1;injectorDefTypes;constructor(e,t,i,r){super(),this.parent=t,this.source=i,this.scopes=r,L_(e,o=>this.processProvider(o)),this.records.set(ty,Ya(void 0,this)),r.has("environment")&&this.records.set(Ai,Ya(void 0,this));let s=this.records.get(Wc);s!=null&&typeof s.value=="string"&&this.scopes.add(s.value),this.injectorDefTypes=new Set(this.get(iy,kn,{self:!0}))}retrieve(e,t){let i=_o(t)||0;try{return this.get(e,go,i)}catch(r){if(qa(r))return r;throw r}}destroy(){Bc(this),this._destroyed=!0;let e=Ge(null);try{for(let i of this._ngOnDestroyHooks)i.ngOnDestroy();let t=this._onDestroyHooks;this._onDestroyHooks=[];for(let i of t)i()}finally{this.records.clear(),this._ngOnDestroyHooks.clear(),this.injectorDefTypes.clear(),Ge(e)}}onDestroy(e){return Bc(this),this._onDestroyHooks.push(e),()=>this.removeOnDestroy(e)}runInContext(e){Bc(this);let t=Ar(this),i=ki(void 0),r;try{return e()}finally{Ar(t),ki(i)}}get(e,t=go,i){if(Bc(this),e.hasOwnProperty(vS))return e[vS](this);let r=_o(i),s,o=Ar(this),a=ki(void 0);try{if(!(r&4)){let c=this.records.get(e);if(c===void 0){let u=nP(e)&&zc(e);u&&this.injectableDefInScope(u)?c=Ya(F_(e),Bd):c=null,this.records.set(e,c)}if(c!=null)return this.hydrate(e,c,r)}let l=r&2?$c():this.parent;return t=r&8&&t===go?null:t,l.get(e,t)}catch(l){let c=HR(l);throw c===-200||c===-201?new Le(c,null):l}finally{ki(a),Ar(o)}}resolveInjectorInitializers(){let e=Ge(null),t=Ar(this),i=ki(void 0),r;try{let s=this.get(Ns,kn,{self:!0});for(let o of s)o()}finally{Ar(t),ki(i),Ge(e)}}toString(){let e=[],t=this.records;for(let i of t.keys())e.push(rs(i));return`R3Injector[${e.join(", ")}]`}processProvider(e){e=tn(e);let t=Gd(e)?e:tn(e&&e.provide),i=eP(e);if(!Gd(e)&&e.multi===!0){let r=this.records.get(t);r||(r=Ya(void 0,Bd,!0),r.factory=()=>N_(r.multi),this.records.set(t,r)),t=e,r.multi.push(e)}this.records.set(t,i)}hydrate(e,t,i){let r=Ge(null);try{if(t.value===bS)throw Q_(rs(e));return t.value===Bd&&(t.value=bS,t.value=t.factory(void 0,i)),typeof t.value=="object"&&t.value&&iP(t.value)&&this._ngOnDestroyHooks.add(t.value),t.value}finally{Ge(r)}}injectableDefInScope(e){if(!e.providedIn)return!1;let t=tn(e.providedIn);return typeof t=="string"?t==="any"||this.scopes.has(t):this.injectorDefTypes.has(t)}removeOnDestroy(e){let t=this._onDestroyHooks.indexOf(e);t!==-1&&this._onDestroyHooks.splice(t,1)}};function F_(n){let e=zc(n),t=e!==null?e.factory:Ps(n);if(t!==null)return t;if(n instanceof Ue)throw new Le(204,!1);if(n instanceof Function)return JR(n);throw new Le(204,!1)}function JR(n){if(n.length>0)throw new Le(204,!1);let t=GR(n);return t!==null?()=>t.factory(n):()=>new n}function eP(n){if(NS(n))return Ya(void 0,n.useValue);{let e=FS(n);return Ya(e,Bd)}}function FS(n,e,t){let i;if(Gd(n)){let r=tn(n);return Ps(r)||F_(r)}else if(NS(n))i=()=>tn(n.useValue);else if(QR(n))i=()=>n.useFactory(...N_(n.deps||[]));else if(ZR(n))i=(r,s)=>qe(tn(n.useExisting),s!==void 0&&s&8?8:void 0);else{let r=tn(n&&(n.useClass||n.provide));if(tP(n))i=()=>new r(...N_(n.deps));else return Ps(r)||F_(r)}return i}function Bc(n){if(n.destroyed)throw new Le(205,!1)}function Ya(n,e,t=!1){return{factory:n,value:e,multi:t?[]:void 0}}function tP(n){return!!n.deps}function iP(n){return n!==null&&typeof n=="object"&&typeof n.ngOnDestroy=="function"}function nP(n){return typeof n=="function"||typeof n=="object"&&n.ngMetadataName==="InjectionToken"}function L_(n,e){for(let t of n)Array.isArray(t)?L_(t,e):t&&q_(t)?L_(t.\u0275providers,e):e(t)}function Gi(n,e){let t;n instanceof yo?(Bc(n),t=n):t=new O_(n);let i,r=Ar(t),s=ki(void 0);try{return e()}finally{Ar(r),ki(s)}}function LS(){return AS()!==void 0||Ld()!=null}var er=0,ke=1,Ye=2,ii=3,Vn=4,Gn=5,Ja=6,el=7,Ht=8,os=9,wr=10,ni=11,tl=12,ay=13,Co=14,yn=15,Ls=16,To=17,Mr=18,jc=19,ly=20,ns=21,Kd=22,qc=23,vn=24,Xd=25,So=26,ri=27,BS=1,cy=6,Bs=7,Yc=8,Io=9,kt=10;function as(n){return Array.isArray(n)&&typeof n[BS]=="object"}function tr(n){return Array.isArray(n)&&n[BS]===!0}function uy(n){return(n.flags&4)!==0}function Ao(n){return n.componentOffset>-1}function Zd(n){return(n.flags&1)===1}function Eo(n){return!!n.template}function il(n){return(n[Ye]&512)!==0}function wo(n){return(n[Ye]&256)===256}var kS="svg",VS="math";function Un(n){for(;Array.isArray(n);)n=n[er];return n}function hy(n,e){return Un(e[n])}function Dr(n,e){return Un(e[n.index])}function Kc(n,e){return n.data[e]}function GS(n,e){return n[e]}function dy(n,e,t,i){t>=n.data.length&&(n.data[t]=null,n.blueprint[t]=null),e[t]=i}function Rr(n,e){let t=e[n];return as(t)?t:t[er]}function US(n){return(n[Ye]&4)===4}function Qd(n){return(n[Ye]&128)===128}function zS(n){return tr(n[ii])}function Pr(n,e){return e==null?null:n[e]}function fy(n){n[To]=0}function py(n){n[Ye]&1024||(n[Ye]|=1024,Qd(n)&&Zc(n))}function HS(n,e){for(;n>0;)e=e[Co],n--;return e}function Xc(n){return!!(n[Ye]&9216||n[vn]?.dirty)}function Jd(n){n[wr].changeDetectionScheduler?.notify(8),n[Ye]&64&&(n[Ye]|=1024),Xc(n)&&Zc(n)}function Zc(n){n[wr].changeDetectionScheduler?.notify(0);let e=Os(n);for(;e!==null&&!(e[Ye]&8192||(e[Ye]|=8192,!Qd(e)));)e=Os(e)}function my(n,e){if(wo(n))throw new Le(911,!1);n[ns]===null&&(n[ns]=[]),n[ns].push(e)}function WS(n,e){if(n[ns]===null)return;let t=n[ns].indexOf(e);t!==-1&&n[ns].splice(t,1)}function Os(n){let e=n[ii];return tr(e)?e[ii]:e}function gy(n){return n[el]??=[]}function _y(n){return n.cleanup??=[]}function $S(n,e,t,i){let r=gy(e);r.push(t),n.firstCreatePass&&_y(n).push(i,r.length-1)}var Xe={lFrame:oI(null),bindingsEnabled:!0,skipHydrationRootTNode:null};var B_=!1;function jS(){return Xe.lFrame.elementDepthCount}function qS(){Xe.lFrame.elementDepthCount++}function yy(){Xe.lFrame.elementDepthCount--}function YS(){return Xe.bindingsEnabled}function KS(){return Xe.skipHydrationRootTNode!==null}function vy(n){return Xe.skipHydrationRootTNode===n}function by(){Xe.skipHydrationRootTNode=null}function pt(){return Xe.lFrame.lView}function bn(){return Xe.lFrame.tView}function nl(n){return Xe.lFrame.contextLView=n,n[Ht]}function rl(n){return Xe.lFrame.contextLView=null,n}function ir(){let n=xy();for(;n!==null&&n.type===64;)n=n.parent;return n}function xy(){return Xe.lFrame.currentTNode}function XS(){let n=Xe.lFrame,e=n.currentTNode;return n.isParent?e:e.parent}function sl(n,e){let t=Xe.lFrame;t.currentTNode=n,t.isParent=e}function Cy(){return Xe.lFrame.isParent}function ZS(){Xe.lFrame.isParent=!1}function Ty(){return B_}function Sy(n){let e=B_;return B_=n,e}function QS(){let n=Xe.lFrame,e=n.bindingRootIndex;return e===-1&&(e=n.bindingRootIndex=n.tView.bindingStartIndex),e}function JS(n){return Xe.lFrame.bindingIndex=n}function Qc(){return Xe.lFrame.bindingIndex++}function eI(n){let e=Xe.lFrame,t=e.bindingIndex;return e.bindingIndex=e.bindingIndex+n,t}function tI(){return Xe.lFrame.inI18n}function iI(n,e){let t=Xe.lFrame;t.bindingIndex=t.bindingRootIndex=n,ef(e)}function nI(){return Xe.lFrame.currentDirectiveIndex}function ef(n){Xe.lFrame.currentDirectiveIndex=n}function rI(n){let e=Xe.lFrame.currentDirectiveIndex;return e===-1?null:n[e]}function Iy(){return Xe.lFrame.currentQueryIndex}function tf(n){Xe.lFrame.currentQueryIndex=n}function rP(n){let e=n[ke];return e.type===2?e.declTNode:e.type===1?n[Gn]:null}function Ay(n,e,t){if(t&4){let r=e,s=n;for(;r=r.parent,r===null&&!(t&1);)if(r=rP(s),r===null||(s=s[Co],r.type&10))break;if(r===null)return!1;e=r,n=s}let i=Xe.lFrame=sI();return i.currentTNode=e,i.lView=n,!0}function nf(n){let e=sI(),t=n[ke];Xe.lFrame=e,e.currentTNode=t.firstChild,e.lView=n,e.tView=t,e.contextLView=n,e.bindingIndex=t.bindingStartIndex,e.inI18n=!1}function sI(){let n=Xe.lFrame,e=n===null?null:n.child;return e===null?oI(n):e}function oI(n){let e={currentTNode:null,isParent:!0,lView:null,tView:null,selectedIndex:-1,contextLView:null,elementDepthCount:0,currentNamespace:null,currentDirectiveIndex:-1,bindingRootIndex:-1,bindingIndex:-1,currentQueryIndex:0,parent:n,child:null,inI18n:!1};return n!==null&&(n.child=e),e}function aI(){let n=Xe.lFrame;return Xe.lFrame=n.parent,n.currentTNode=null,n.lView=null,n}var Ey=aI;function rf(){let n=aI();n.isParent=!0,n.tView=null,n.selectedIndex=-1,n.contextLView=null,n.elementDepthCount=0,n.currentDirectiveIndex=-1,n.currentNamespace=null,n.bindingRootIndex=-1,n.bindingIndex=-1,n.currentQueryIndex=0}function lI(n){return(Xe.lFrame.contextLView=HS(n,Xe.lFrame.contextLView))[Ht]}function ks(){return Xe.lFrame.selectedIndex}function Vs(n){Xe.lFrame.selectedIndex=n}function cI(){let n=Xe.lFrame;return Kc(n.tView,n.selectedIndex)}function uI(){return Xe.lFrame.currentNamespace}var hI=!0;function sf(){return hI}function of(n){hI=n}function k_(n,e=null,t=null,i){let r=wy(n,e,t,i);return r.resolveInjectorInitializers(),r}function wy(n,e=null,t=null,i,r=new Set){let s=[t||kn,PS(n)];return i=i||(typeof n=="object"?void 0:rs(n)),new yo(s,e||$c(),i||null,r)}var Er=class n{static THROW_IF_NOT_FOUND=go;static NULL=new Vc;static create(e,t){if(Array.isArray(e))return k_({name:""},t,e,"");{let i=e.name??"";return k_({name:i},e.parent,e.providers,i)}}static \u0275prov=Ne({token:n,providedIn:"any",factory:()=>qe(ty)});static __NG_ELEMENT_ID__=-1},Ui=new Ue(""),ol=(()=>{class n{static __NG_ELEMENT_ID__=sP;static __NG_ENV_ID__=t=>t}return n})(),V_=class extends ol{_lView;constructor(e){super(),this._lView=e}get destroyed(){return wo(this._lView)}onDestroy(e){let t=this._lView;return my(t,e),()=>WS(t,e)}};function sP(){return new V_(pt())}var My=!1,ls=(()=>{class n{taskId=0;pendingTasks=new Set;destroyed=!1;pendingTask=new Ot(!1);get hasPendingTasks(){return this.destroyed?!1:this.pendingTask.value}get hasPendingTasksObservable(){return this.destroyed?new ct(t=>{t.next(!1),t.complete()}):this.pendingTask}add(){!this.hasPendingTasks&&!this.destroyed&&this.pendingTask.next(!0);let t=this.taskId++;return this.pendingTasks.add(t),t}has(t){return this.pendingTasks.has(t)}remove(t){this.pendingTasks.delete(t),this.pendingTasks.size===0&&this.hasPendingTasks&&this.pendingTask.next(!1)}ngOnDestroy(){this.pendingTasks.clear(),this.hasPendingTasks&&this.pendingTask.next(!1),this.destroyed=!0,this.pendingTask.unsubscribe()}static \u0275prov=Ne({token:n,providedIn:"root",factory:()=>new n})}return n})(),G_=class extends ti{__isAsync;destroyRef=void 0;pendingTasks=void 0;constructor(e=!1){super(),this.__isAsync=e,LS()&&(this.destroyRef=ue(ol,{optional:!0})??void 0,this.pendingTasks=ue(ls,{optional:!0})??void 0)}emit(e){let t=Ge(null);try{super.next(e)}finally{Ge(t)}}subscribe(e,t,i){let r=e,s=t||(()=>null),o=i;if(e&&typeof e=="object"){let l=e;r=l.next?.bind(l),s=l.error?.bind(l),o=l.complete?.bind(l)}this.__isAsync&&(s=this.wrapInTimeout(s),r&&(r=this.wrapInTimeout(r)),o&&(o=this.wrapInTimeout(o)));let a=super.subscribe({next:r,error:s,complete:o});return e instanceof zt&&e.add(a),a}wrapInTimeout(e){return t=>{let i=this.pendingTasks?.add();setTimeout(()=>{try{e(t)}finally{i!==void 0&&this.pendingTasks?.remove(i)}})}}},Vi=G_;function Ud(...n){}function Dy(n){let e,t;function i(){n=Ud;try{t!==void 0&&typeof cancelAnimationFrame=="function"&&cancelAnimationFrame(t),e!==void 0&&clearTimeout(e)}catch{}}return e=setTimeout(()=>{n(),i()}),typeof requestAnimationFrame=="function"&&(t=requestAnimationFrame(()=>{n(),i()})),()=>i()}function Ry(n){return queueMicrotask(()=>n()),()=>{n=Ud}}var Py="isAngularZone",Gc=Py+"_ID",oP=0,Et=class n{hasPendingMacrotasks=!1;hasPendingMicrotasks=!1;isStable=!0;onUnstable=new Vi(!1);onMicrotaskEmpty=new Vi(!1);onStable=new Vi(!1);onError=new Vi(!1);constructor(e){let{enableLongStackTrace:t=!1,shouldCoalesceEventChangeDetection:i=!1,shouldCoalesceRunChangeDetection:r=!1,scheduleInRootZone:s=My}=e;if(typeof Zone>"u")throw new Le(908,!1);Zone.assertZonePatched();let o=this;o._nesting=0,o._outer=o._inner=Zone.current,Zone.TaskTrackingZoneSpec&&(o._inner=o._inner.fork(new Zone.TaskTrackingZoneSpec)),t&&Zone.longStackTraceZoneSpec&&(o._inner=o._inner.fork(Zone.longStackTraceZoneSpec)),o.shouldCoalesceEventChangeDetection=!r&&i,o.shouldCoalesceRunChangeDetection=r,o.callbackScheduled=!1,o.scheduleInRootZone=s,cP(o)}static isInAngularZone(){return typeof Zone<"u"&&Zone.current.get(Py)===!0}static assertInAngularZone(){if(!n.isInAngularZone())throw new Le(909,!1)}static assertNotInAngularZone(){if(n.isInAngularZone())throw new Le(909,!1)}run(e,t,i){return this._inner.run(e,t,i)}runTask(e,t,i,r){let s=this._inner,o=s.scheduleEventTask("NgZoneEvent: "+r,e,aP,Ud,Ud);try{return s.runTask(o,t,i)}finally{s.cancelTask(o)}}runGuarded(e,t,i){return this._inner.runGuarded(e,t,i)}runOutsideAngular(e){return this._outer.run(e)}},aP={};function Oy(n){if(n._nesting==0&&!n.hasPendingMicrotasks&&!n.isStable)try{n._nesting++,n.onMicrotaskEmpty.emit(null)}finally{if(n._nesting--,!n.hasPendingMicrotasks)try{n.runOutsideAngular(()=>n.onStable.emit(null))}finally{n.isStable=!0}}}function lP(n){if(n.isCheckStableRunning||n.callbackScheduled)return;n.callbackScheduled=!0;function e(){Dy(()=>{n.callbackScheduled=!1,U_(n),n.isCheckStableRunning=!0,Oy(n),n.isCheckStableRunning=!1})}n.scheduleInRootZone?Zone.root.run(()=>{e()}):n._outer.run(()=>{e()}),U_(n)}function cP(n){let e=()=>{lP(n)},t=oP++;n._inner=n._inner.fork({name:"angular",properties:{[Py]:!0,[Gc]:t,[Gc+t]:!0},onInvokeTask:(i,r,s,o,a,l)=>{if(uP(l))return i.invokeTask(s,o,a,l);try{return xS(n),i.invokeTask(s,o,a,l)}finally{(n.shouldCoalesceEventChangeDetection&&o.type==="eventTask"||n.shouldCoalesceRunChangeDetection)&&e(),CS(n)}},onInvoke:(i,r,s,o,a,l,c)=>{try{return xS(n),i.invoke(s,o,a,l,c)}finally{n.shouldCoalesceRunChangeDetection&&!n.callbackScheduled&&!hP(l)&&e(),CS(n)}},onHasTask:(i,r,s,o)=>{i.hasTask(s,o),r===s&&(o.change=="microTask"?(n._hasPendingMicrotasks=o.microTask,U_(n),Oy(n)):o.change=="macroTask"&&(n.hasPendingMacrotasks=o.macroTask))},onHandleError:(i,r,s,o)=>(i.handleError(s,o),n.runOutsideAngular(()=>n.onError.emit(o)),!1)})}function U_(n){n._hasPendingMicrotasks||(n.shouldCoalesceEventChangeDetection||n.shouldCoalesceRunChangeDetection)&&n.callbackScheduled===!0?n.hasPendingMicrotasks=!0:n.hasPendingMicrotasks=!1}function xS(n){n._nesting++,n.isStable&&(n.isStable=!1,n.onUnstable.emit(null))}function CS(n){n._nesting--,Oy(n)}var Uc=class{hasPendingMicrotasks=!1;hasPendingMacrotasks=!1;isStable=!0;onUnstable=new Vi;onMicrotaskEmpty=new Vi;onStable=new Vi;onError=new Vi;run(e,t,i){return e.apply(t,i)}runGuarded(e,t,i){return e.apply(t,i)}runOutsideAngular(e){return e()}runTask(e,t,i,r){return e.apply(t,i)}};function uP(n){return dI(n,"__ignore_ng_zone__")}function hP(n){return dI(n,"__scheduler_tick__")}function dI(n,e){return!Array.isArray(n)||n.length!==1?!1:n[0]?.data?.[e]===!0}var ss=class{_console=console;handleError(e){this._console.error("ERROR",e)}},zn=new Ue("",{factory:()=>{let n=ue(Et),e=ue(Ai),t;return i=>{n.runOutsideAngular(()=>{e.destroyed&&!t?setTimeout(()=>{throw i}):(t??=e.get(ss),t.handleError(i))})}}}),fI={provide:Ns,useValue:()=>{let n=ue(ss,{optional:!0})},multi:!0};function nn(n,e){let[t,i,r]=h_(n,e?.equal),s=t,o=s[Ln];return s.set=i,s.update=r,s.asReadonly=pI.bind(s),s}function pI(){let n=this[Ln];if(n.readonlyFn===void 0){let e=()=>this();e[Ln]=n,n.readonlyFn=e}return n.readonlyFn}var vo=class{},al=new Ue("",{factory:()=>!0});var af=new Ue("");var Ny=(()=>{class n{static \u0275prov=Ne({token:n,providedIn:"root",factory:()=>new z_})}return n})(),z_=class{dirtyEffectCount=0;queues=new Map;add(e){this.enqueue(e),this.schedule(e)}schedule(e){e.dirty&&this.dirtyEffectCount++}remove(e){let t=e.zone,i=this.queues.get(t);i.has(e)&&(i.delete(e),e.dirty&&this.dirtyEffectCount--)}enqueue(e){let t=e.zone;this.queues.has(t)||this.queues.set(t,new Set);let i=this.queues.get(t);i.has(e)||i.add(e)}flush(){for(;this.dirtyEffectCount>0;){let e=!1;for(let[t,i]of this.queues)t===null?e||=this.flushQueue(i):e||=t.run(()=>this.flushQueue(i));e||(this.dirtyEffectCount=0)}}flushQueue(e){let t=!1;for(let i of e)i.dirty&&(this.dirtyEffectCount--,t=!0,i.run());return t}},H_=class{[Ln];constructor(e){this[Ln]=e}destroy(){this[Ln].destroy()}};function Hn(n){return d_(n)}function au(n){return{toString:n}.toString()}function xP(n){return typeof n=="function"}function UI(n,e,t,i){e!==null?e.applyValueToInputSignal(e,i):n[t]=i}var ff=class{previousValue;currentValue;firstChange;constructor(e,t,i){this.previousValue=e,this.currentValue=t,this.firstChange=i}isFirstChange(){return this.firstChange}},Rf=(()=>{let n=()=>zI;return n.ngInherit=!0,n})();function zI(n){return n.type.prototype.ngOnChanges&&(n.setInput=TP),CP}function CP(){let n=WI(this),e=n?.current;if(e){let t=n.previous;if(t===xo)n.previous=e;else for(let i in e)t[i]=e[i];n.current=null,this.ngOnChanges(e)}}function TP(n,e,t,i,r){let s=this.declaredInputs[i],o=WI(n)||SP(n,{previous:xo,current:null}),a=o.current||(o.current={}),l=o.previous,c=l[s];a[s]=new ff(c&&c.currentValue,t,l===xo),UI(n,e,r,t)}var HI="__ngSimpleChanges__";function WI(n){return n[HI]||null}function SP(n,e){return n[HI]=e}var mI=[];var It=function(n,e=null,t){for(let i=0;i<mI.length;i++){let r=mI[i];r(n,e,t)}};function IP(n,e,t){let{ngOnChanges:i,ngOnInit:r,ngDoCheck:s}=e.type.prototype;if(i){let o=zI(e);(t.preOrderHooks??=[]).push(n,o),(t.preOrderCheckHooks??=[]).push(n,o)}r&&(t.preOrderHooks??=[]).push(0-n,r),s&&((t.preOrderHooks??=[]).push(n,s),(t.preOrderCheckHooks??=[]).push(n,s))}function AP(n,e){for(let t=e.directiveStart,i=e.directiveEnd;t<i;t++){let s=n.data[t].type.prototype,{ngAfterContentInit:o,ngAfterContentChecked:a,ngAfterViewInit:l,ngAfterViewChecked:c,ngOnDestroy:u}=s;o&&(n.contentHooks??=[]).push(-t,o),a&&((n.contentHooks??=[]).push(t,a),(n.contentCheckHooks??=[]).push(t,a)),l&&(n.viewHooks??=[]).push(-t,l),c&&((n.viewHooks??=[]).push(t,c),(n.viewCheckHooks??=[]).push(t,c)),u!=null&&(n.destroyHooks??=[]).push(t,u)}}function cf(n,e,t){$I(n,e,3,t)}function uf(n,e,t,i){(n[Ye]&3)===t&&$I(n,e,t,i)}function Fy(n,e){let t=n[Ye];(t&3)===e&&(t&=16383,t+=1,n[Ye]=t)}function $I(n,e,t,i){let r=i!==void 0?n[To]&65535:0,s=i??-1,o=e.length-1,a=0;for(let l=r;l<o;l++)if(typeof e[l+1]=="number"){if(a=e[l],i!=null&&a>=i)break}else e[l]<0&&(n[To]+=65536),(a<s||s==-1)&&(EP(n,t,e,l),n[To]=(n[To]&4294901760)+l+2),l++}function gI(n,e){It(4,n,e);let t=Ge(null);try{e.call(n)}finally{Ge(t),It(5,n,e)}}function EP(n,e,t,i){let r=t[i]<0,s=t[i+1],o=r?-t[i]:t[i],a=n[o];r?n[Ye]>>14<n[To]>>16&&(n[Ye]&3)===e&&(n[Ye]+=16384,gI(a,s)):gI(a,s)}var cl=-1,tu=class{factory;name;injectImpl;resolving=!1;canSeeViewProviders;multi;componentProviders;index;providerFactory;constructor(e,t,i,r){this.factory=e,this.name=r,this.canSeeViewProviders=t,this.injectImpl=i}};function wP(n){return(n.flags&8)!==0}function MP(n){return(n.flags&16)!==0}function DP(n,e,t){let i=0;for(;i<t.length;){let r=t[i];if(typeof r=="number"){if(r!==0)break;i++;let s=t[i++],o=t[i++],a=t[i++];n.setAttribute(e,o,a,s)}else{let s=r,o=t[++i];PP(s)?n.setProperty(e,s,o):n.setAttribute(e,s,o),i++}}return i}function RP(n){return n===3||n===4||n===6}function PP(n){return n.charCodeAt(0)===64}function Pf(n,e){if(!(e===null||e.length===0))if(n===null||n.length===0)n=e.slice();else{let t=-1;for(let i=0;i<e.length;i++){let r=e[i];typeof r=="number"?t=r:t===0||(t===-1||t===2?_I(n,t,r,null,e[++i]):_I(n,t,r,null,null))}}return n}function _I(n,e,t,i,r){let s=0,o=n.length;if(e===-1)o=-1;else for(;s<n.length;){let a=n[s++];if(typeof a=="number"){if(a===e){o=-1;break}else if(a>e){o=s-1;break}}}for(;s<n.length;){let a=n[s];if(typeof a=="number")break;if(a===t){r!==null&&(n[s+1]=r);return}s++,r!==null&&s++}o!==-1&&(n.splice(o,0,e),s=o+1),n.splice(s++,0,t),r!==null&&n.splice(s++,0,r)}function jI(n){return n!==cl}function pf(n){return n&32767}function OP(n){return n>>16}function mf(n,e){let t=OP(n),i=e;for(;t>0;)i=i[Co],t--;return i}var zy=!0;function gf(n){let e=zy;return zy=n,e}var NP=256,qI=NP-1,YI=5,FP=0,Or={};function LP(n,e,t){let i;typeof t=="string"?i=t.charCodeAt(0)||0:t.hasOwnProperty(bo)&&(i=t[bo]),i==null&&(i=t[bo]=FP++);let r=i&qI,s=1<<r;e.data[n+(r>>YI)]|=s}function KI(n,e){let t=XI(n,e);if(t!==-1)return t;let i=e[ke];i.firstCreatePass&&(n.injectorIndex=e.length,Ly(i.data,n),Ly(e,null),Ly(i.blueprint,null));let r=pv(n,e),s=n.injectorIndex;if(jI(r)){let o=pf(r),a=mf(r,e),l=a[ke].data;for(let c=0;c<8;c++)e[s+c]=a[o+c]|l[o+c]}return e[s+8]=r,s}function Ly(n,e){n.push(0,0,0,0,0,0,0,0,e)}function XI(n,e){return n.injectorIndex===-1||n.parent&&n.parent.injectorIndex===n.injectorIndex||e[n.injectorIndex+8]===null?-1:n.injectorIndex}function pv(n,e){if(n.parent&&n.parent.injectorIndex!==-1)return n.parent.injectorIndex;let t=0,i=null,r=e;for(;r!==null;){if(i=tA(r),i===null)return cl;if(t++,r=r[Co],i.injectorIndex!==-1)return i.injectorIndex|t<<16}return cl}function BP(n,e,t){LP(n,e,t)}function ZI(n,e,t){if(t&8||n!==void 0)return n;jd(e,"NodeInjector")}function QI(n,e,t,i){if(t&8&&i===void 0&&(i=null),(t&3)===0){let r=n[os],s=ki(void 0);try{return r?r.get(e,i,t&8):J_(e,i,t&8)}finally{ki(s)}}return ZI(i,e,t)}function JI(n,e,t,i=0,r){if(n!==null){if(e[Ye]&2048&&!(i&2)){let o=UP(n,e,t,i,Or);if(o!==Or)return o}let s=eA(n,e,t,i,Or);if(s!==Or)return s}return QI(e,t,i,r)}function eA(n,e,t,i,r){let s=VP(t);if(typeof s=="function"){if(!Ay(e,n,i))return i&1?ZI(r,t,i):QI(e,t,i,r);try{let o;if(o=s(i),o==null&&!(i&8))jd(t);else return o}finally{Ey()}}else if(typeof s=="number"){let o=null,a=XI(n,e),l=cl,c=i&1?e[yn][Gn]:null;for((a===-1||i&4)&&(l=a===-1?pv(n,e):e[a+8],l===cl||!vI(i,!1)?a=-1:(o=e[ke],a=pf(l),e=mf(l,e)));a!==-1;){let u=e[ke];if(yI(s,a,u.data)){let h=kP(a,e,t,o,i,c);if(h!==Or)return h}l=e[a+8],l!==cl&&vI(i,e[ke].data[a+8]===c)&&yI(s,a,e)?(o=u,a=pf(l),e=mf(l,e)):a=-1}}return r}function kP(n,e,t,i,r,s){let o=e[ke],a=o.data[n+8],l=i==null?Ao(a)&&zy:i!=o&&(a.type&3)!==0,c=r&1&&s===a,u=hf(a,o,t,l,c);return u!==null?_f(e,o,u,a,r):Or}function hf(n,e,t,i,r){let s=n.providerIndexes,o=e.data,a=s&1048575,l=n.directiveStart,c=n.directiveEnd,u=s>>20,h=i?a:a+u,d=r?a+u:c;for(let f=h;f<d;f++){let p=o[f];if(f<l&&t===p||f>=l&&p.type===t)return f}if(r){let f=o[l];if(f&&Eo(f)&&f.type===t)return l}return null}function _f(n,e,t,i,r){let s=n[t],o=e.data;if(s instanceof tu){let a=s;if(a.resolving){let f=TS(o[t]);throw Q_(f)}let l=gf(a.canSeeViewProviders);a.resolving=!0;let c=o[t].type||o[t],u,h=a.injectImpl?ki(a.injectImpl):null,d=Ay(n,i,0);try{s=n[t]=a.factory(void 0,r,o,n,i),e.firstCreatePass&&t>=i.directiveStart&&IP(t,o[t],e)}finally{h!==null&&ki(h),gf(l),a.resolving=!1,Ey()}}return s}function VP(n){if(typeof n=="string")return n.charCodeAt(0)||0;let e=n.hasOwnProperty(bo)?n[bo]:void 0;return typeof e=="number"?e>=0?e&qI:GP:e}function yI(n,e,t){let i=1<<n;return!!(t[e+(n>>YI)]&i)}function vI(n,e){return!(n&2)&&!(n&1&&e)}var Mo=class{_tNode;_lView;constructor(e,t){this._tNode=e,this._lView=t}get(e,t,i){return JI(this._tNode,this._lView,e,_o(i),t)}};function GP(){return new Mo(ir(),pt())}function Of(n){return au(()=>{let e=n.prototype.constructor,t=e[kc]||Hy(e),i=Object.prototype,r=Object.getPrototypeOf(n.prototype).constructor;for(;r&&r!==i;){let s=r[kc]||Hy(r);if(s&&s!==t)return s;r=Object.getPrototypeOf(r)}return s=>new s})}function Hy(n){return $_(n)?()=>{let e=Hy(tn(n));return e&&e()}:Ps(n)}function UP(n,e,t,i,r){let s=n,o=e;for(;s!==null&&o!==null&&o[Ye]&2048&&!il(o);){let a=eA(s,o,t,i|2,Or);if(a!==Or)return a;let l=s.parent;if(!l){let c=o[ly];if(c){let u=c.get(t,Or,i);if(u!==Or)return u}l=tA(o),o=o[Co]}s=l}return r}function tA(n){let e=n[ke],t=e.type;return t===2?e.declTNode:t===1?n[Gn]:null}function zP(){return pl(ir(),pt())}function pl(n,e){return new ml(Dr(n,e))}var ml=(()=>{class n{nativeElement;constructor(t){this.nativeElement=t}static __NG_ELEMENT_ID__=zP}return n})();function HP(n){return n instanceof ml?n.nativeElement:n}function WP(){return this._results[Symbol.iterator]()}var yf=class{_emitDistinctChangesOnly;dirty=!0;_onDirty=void 0;_results=[];_changesDetected=!1;_changes=void 0;length=0;first=void 0;last=void 0;get changes(){return this._changes??=new ti}constructor(e=!1){this._emitDistinctChangesOnly=e}get(e){return this._results[e]}map(e){return this._results.map(e)}filter(e){return this._results.filter(e)}find(e){return this._results.find(e)}reduce(e,t){return this._results.reduce(e,t)}forEach(e){this._results.forEach(e)}some(e){return this._results.some(e)}toArray(){return this._results.slice()}toString(){return this._results.toString()}reset(e,t){this.dirty=!1;let i=wS(e);(this._changesDetected=!ES(this._results,i,t))&&(this._results=i,this.length=i.length,this.last=i[this.length-1],this.first=i[0])}notifyOnChanges(){this._changes!==void 0&&(this._changesDetected||!this._emitDistinctChangesOnly)&&this._changes.next(this)}onDirty(e){this._onDirty=e}setDirty(){this.dirty=!0,this._onDirty?.()}destroy(){this._changes!==void 0&&(this._changes.complete(),this._changes.unsubscribe())}[Symbol.iterator]=WP};function iA(n){return(n.flags&128)===128}var mv=(function(n){return n[n.OnPush=0]="OnPush",n[n.Default=1]="Default",n})(mv||{}),nA=new Map,$P=0;function jP(){return $P++}function qP(n){nA.set(n[jc],n)}function Wy(n){nA.delete(n[jc])}var bI="__ngContext__";function ul(n,e){as(e)?(n[bI]=e[jc],qP(e)):n[bI]=e}function rA(n){return oA(n[tl])}function sA(n){return oA(n[Vn])}function oA(n){for(;n!==null&&!tr(n);)n=n[Vn];return n}var $y;function gv(n){$y=n}function aA(){if($y!==void 0)return $y;if(typeof document<"u")return document;throw new Le(210,!1)}var Nf=new Ue("",{factory:()=>YP}),YP="ng";var Ff=new Ue(""),lu=new Ue("",{providedIn:"platform",factory:()=>"unknown"});var Lf=new Ue("",{factory:()=>aA().body?.querySelector("[ngCspNonce]")?.getAttribute("ngCspNonce")||null});var lA="r";var cA="di";var uA=!1,hA=new Ue("",{factory:()=>uA});var KP=(n,e,t,i)=>{};function XP(n,e,t,i){KP(n,e,t,i)}function _v(n){return(n.flags&32)===32}var ZP=()=>null;function dA(n,e,t=!1){return ZP(n,e,t)}function fA(n,e){let t=n.contentQueries;if(t!==null){let i=Ge(null);try{for(let r=0;r<t.length;r+=2){let s=t[r],o=t[r+1];if(o!==-1){let a=n.data[o];tf(s),a.contentQueries(2,e[o],o)}}}finally{Ge(i)}}}function jy(n,e,t){tf(0);let i=Ge(null);try{e(n,t)}finally{Ge(i)}}function pA(n,e,t){if(uy(e)){let i=Ge(null);try{let r=e.directiveStart,s=e.directiveEnd;for(let o=r;o<s;o++){let a=n.data[o];if(a.contentQueries){let l=t[o];a.contentQueries(1,l,o)}}}finally{Ge(i)}}}var rr=(function(n){return n[n.Emulated=0]="Emulated",n[n.None=2]="None",n[n.ShadowDom=3]="ShadowDom",n[n.ExperimentalIsolatedShadowDom=4]="ExperimentalIsolatedShadowDom",n})(rr||{});var vf=class{changingThisBreaksApplicationSecurity;constructor(e){this.changingThisBreaksApplicationSecurity=e}toString(){return`SafeValue must use [property]=binding: ${this.changingThisBreaksApplicationSecurity} (see ${zd})`}};function yv(n){return n instanceof vf?n.changingThisBreaksApplicationSecurity:n}function mA(n,e){let t=gA(n);if(t!=null&&t!==e){if(t==="ResourceURL"&&e==="URL")return!0;throw new Error(`Required a safe ${e}, got a ${t} (see ${zd})`)}return t===e}function gA(n){return n instanceof vf&&n.getTypeName()||null}var QP=/^(?!javascript:)(?:[a-z0-9+.-]+:|[^&:\/?#]*(?:[\/?#]|$))/i;function _A(n){return n=String(n),n.match(QP)?n:"unsafe:"+n}var vv=(function(n){return n[n.NONE=0]="NONE",n[n.HTML=1]="HTML",n[n.STYLE=2]="STYLE",n[n.SCRIPT=3]="SCRIPT",n[n.URL=4]="URL",n[n.RESOURCE_URL=5]="RESOURCE_URL",n})(vv||{});function cs(n){let e=JP();return e?e.sanitize(vv.URL,n)||"":mA(n,"URL")?yv(n):_A($d(n))}function JP(){let n=pt();return n&&n[wr].sanitizer}function yA(n){return n instanceof Function?n():n}function eO(n,e,t){let i=n.length;for(;;){let r=n.indexOf(e,t);if(r===-1)return r;if(r===0||n.charCodeAt(r-1)<=32){let s=e.length;if(r+s===i||n.charCodeAt(r+s)<=32)return r}t=r+1}}var vA="ng-template";function tO(n,e,t,i){let r=0;if(i){for(;r<e.length&&typeof e[r]=="string";r+=2)if(e[r]==="class"&&eO(e[r+1].toLowerCase(),t,0)!==-1)return!0}else if(bv(n))return!1;if(r=e.indexOf(1,r),r>-1){let s;for(;++r<e.length&&typeof(s=e[r])=="string";)if(s.toLowerCase()===t)return!0}return!1}function bv(n){return n.type===4&&n.value!==vA}function iO(n,e,t){let i=n.type===4&&!t?vA:n.value;return e===i}function nO(n,e,t){let i=4,r=n.attrs,s=r!==null?oO(r):0,o=!1;for(let a=0;a<e.length;a++){let l=e[a];if(typeof l=="number"){if(!o&&!nr(i)&&!nr(l))return!1;if(o&&nr(l))continue;o=!1,i=l|i&1;continue}if(!o)if(i&4){if(i=2|i&1,l!==""&&!iO(n,l,t)||l===""&&e.length===1){if(nr(i))return!1;o=!0}}else if(i&8){if(r===null||!tO(n,r,l,t)){if(nr(i))return!1;o=!0}}else{let c=e[++a],u=rO(l,r,bv(n),t);if(u===-1){if(nr(i))return!1;o=!0;continue}if(c!==""){let h;if(u>s?h="":h=r[u+1].toLowerCase(),i&2&&c!==h){if(nr(i))return!1;o=!0}}}}return nr(i)||o}function nr(n){return(n&1)===0}function rO(n,e,t,i){if(e===null)return-1;let r=0;if(i||!t){let s=!1;for(;r<e.length;){let o=e[r];if(o===n)return r;if(o===3||o===6)s=!0;else if(o===1||o===2){let a=e[++r];for(;typeof a=="string";)a=e[++r];continue}else{if(o===4)break;if(o===0){r+=4;continue}}r+=s?1:2}return-1}else return aO(e,n)}function sO(n,e,t=!1){for(let i=0;i<e.length;i++)if(nO(n,e[i],t))return!0;return!1}function oO(n){for(let e=0;e<n.length;e++){let t=n[e];if(RP(t))return e}return n.length}function aO(n,e){let t=n.indexOf(4);if(t>-1)for(t++;t<n.length;){let i=n[t];if(typeof i=="number")return-1;if(i===e)return t;t++}return-1}function xI(n,e){return n?":not("+e.trim()+")":e}function lO(n){let e=n[0],t=1,i=2,r="",s=!1;for(;t<n.length;){let o=n[t];if(typeof o=="string")if(i&2){let a=n[++t];r+="["+o+(a.length>0?'="'+a+'"':"")+"]"}else i&8?r+="."+o:i&4&&(r+=" "+o);else r!==""&&!nr(o)&&(e+=xI(s,r),r=""),i=o,s=s||!nr(i);t++}return r!==""&&(e+=xI(s,r)),e}function cO(n){return n.map(lO).join(",")}function uO(n){let e=[],t=[],i=1,r=2;for(;i<n.length;){let s=n[i];if(typeof s=="string")r===2?s!==""&&e.push(s,n[++i]):r===8&&t.push(s);else{if(!nr(r))break;r=s}i++}return t.length&&e.push(1,...t),e}var Fr={};function hO(n,e){return n.createText(e)}function dO(n,e,t){n.setValue(e,t)}function bA(n,e,t){return n.createElement(e,t)}function bf(n,e,t,i,r){n.insertBefore(e,t,i,r)}function xA(n,e,t){n.appendChild(e,t)}function CI(n,e,t,i,r){i!==null?bf(n,e,t,i,r):xA(n,e,t)}function CA(n,e,t,i){n.removeChild(null,e,t,i)}function fO(n,e,t){n.setAttribute(e,"style",t)}function pO(n,e,t){t===""?n.removeAttribute(e,"class"):n.setAttribute(e,"class",t)}function TA(n,e,t){let{mergedAttrs:i,classes:r,styles:s}=t;i!==null&&DP(n,e,i),r!==null&&pO(n,e,r),s!==null&&fO(n,e,s)}function xv(n,e,t,i,r,s,o,a,l,c,u){let h=ri+i,d=h+r,f=mO(h,d),p=typeof c=="function"?c():c;return f[ke]={type:n,blueprint:f,template:t,queries:null,viewQuery:a,declTNode:e,data:f.slice().fill(null,h),bindingStartIndex:h,expandoStartIndex:d,hostBindingOpCodes:null,firstCreatePass:!0,firstUpdatePass:!0,staticViewQueries:!1,staticContentQueries:!1,preOrderHooks:null,preOrderCheckHooks:null,contentHooks:null,contentCheckHooks:null,viewHooks:null,viewCheckHooks:null,destroyHooks:null,cleanup:null,contentQueries:null,components:null,directiveRegistry:typeof s=="function"?s():s,pipeRegistry:typeof o=="function"?o():o,firstChild:null,schemas:l,consts:p,incompleteFirstPass:!1,ssrId:u}}function mO(n,e){let t=[];for(let i=0;i<e;i++)t.push(i<n?null:Fr);return t}function gO(n){let e=n.tView;return e===null||e.incompleteFirstPass?n.tView=xv(1,null,n.template,n.decls,n.vars,n.directiveDefs,n.pipeDefs,n.viewQuery,n.schemas,n.consts,n.id):e}function Cv(n,e,t,i,r,s,o,a,l,c,u){let h=e.blueprint.slice();return h[er]=r,h[Ye]=i|4|128|8|64|1024,(c!==null||n&&n[Ye]&2048)&&(h[Ye]|=2048),fy(h),h[ii]=h[Co]=n,h[Ht]=t,h[wr]=o||n&&n[wr],h[ni]=a||n&&n[ni],h[os]=l||n&&n[os]||null,h[Gn]=s,h[jc]=jP(),h[Ja]=u,h[ly]=c,h[yn]=e.type==2?n[yn]:h,h}function _O(n,e,t){let i=Dr(e,n),r=gO(t),s=n[wr].rendererFactory,o=Tv(n,Cv(n,r,null,SA(t),i,e,null,s.createRenderer(i,t),null,null,null));return n[e.index]=o}function SA(n){let e=16;return n.signals?e=4096:n.onPush&&(e=64),e}function IA(n,e,t,i){if(t===0)return-1;let r=e.length;for(let s=0;s<t;s++)e.push(i),n.blueprint.push(i),n.data.push(null);return r}function Tv(n,e){return n[tl]?n[ay][Vn]=e:n[tl]=e,n[ay]=e,e}function Be(n=1){AA(bn(),pt(),ks()+n,!1)}function AA(n,e,t,i){if(!i)if((e[Ye]&3)===3){let s=n.preOrderCheckHooks;s!==null&&cf(e,s,t)}else{let s=n.preOrderHooks;s!==null&&uf(e,s,0,t)}Vs(t)}var Bf=(function(n){return n[n.None=0]="None",n[n.SignalBased=1]="SignalBased",n[n.HasDecoratorInputTransform=2]="HasDecoratorInputTransform",n})(Bf||{});function qy(n,e,t,i){let r=Ge(null);try{let[s,o,a]=n.inputs[t],l=null;(o&Bf.SignalBased)!==0&&(l=e[s][Ln]),l!==null&&l.transformFn!==void 0?i=l.transformFn(i):a!==null&&(i=a.call(e,i)),n.setInput!==null?n.setInput(e,l,i,t,s):UI(e,l,s,i)}finally{Ge(r)}}var Nr=(function(n){return n[n.Important=1]="Important",n[n.DashCase=2]="DashCase",n})(Nr||{}),yO;function Sv(n,e){return yO(n,e)}var Do=new Set,Iv=(function(n){return n[n.CHANGE_DETECTION=0]="CHANGE_DETECTION",n[n.AFTER_NEXT_RENDER=1]="AFTER_NEXT_RENDER",n})(Iv||{}),cu=new Ue(""),TI=new Set;function Us(n){TI.has(n)||(TI.add(n),performance?.mark?.("mark_feature_usage",{detail:{feature:n}}))}var EA=(()=>{class n{impl=null;execute(){this.impl?.execute()}static \u0275prov=Ne({token:n,providedIn:"root",factory:()=>new n})}return n})();var wA=new Ue("",{factory:()=>({queue:new Set,isScheduled:!1,scheduler:null})});function MA(n,e,t){let i=n.get(wA);if(Array.isArray(e))for(let r of e)i.queue.add(r),t?.detachedLeaveAnimationFns?.push(r);else i.queue.add(e),t?.detachedLeaveAnimationFns?.push(e);i.scheduler&&i.scheduler(n)}function vO(n,e){let t=n.get(wA);if(e.detachedLeaveAnimationFns){for(let i of e.detachedLeaveAnimationFns)t.queue.delete(i);e.detachedLeaveAnimationFns=void 0}}function bO(n,e){for(let[t,i]of e)MA(n,i.animateFns)}function SI(n,e,t,i){let r=n?.[So]?.enter;e!==null&&r&&r.has(t.index)&&bO(i,r)}function ll(n,e,t,i,r,s,o,a){if(r!=null){let l,c=!1;tr(r)?l=r:as(r)&&(c=!0,r=r[er]);let u=Un(r);n===0&&i!==null?(SI(a,i,s,t),o==null?xA(e,i,u):bf(e,i,u,o||null,!0)):n===1&&i!==null?(SI(a,i,s,t),bf(e,i,u,o||null,!0)):n===2?II(a,s,t,h=>{CA(e,u,c,h)}):n===3&&II(a,s,t,()=>{e.destroyNode(u)}),l!=null&&OO(e,n,t,l,s,i,o)}}function xO(n,e){DA(n,e),e[er]=null,e[Gn]=null}function CO(n,e,t,i,r,s){i[er]=r,i[Gn]=e,Vf(n,i,t,1,r,s)}function DA(n,e){e[wr].changeDetectionScheduler?.notify(9),Vf(n,e,e[ni],2,null,null)}function TO(n){let e=n[tl];if(!e)return By(n[ke],n);for(;e;){let t=null;if(as(e))t=e[tl];else{let i=e[kt];i&&(t=i)}if(!t){for(;e&&!e[Vn]&&e!==n;)as(e)&&By(e[ke],e),e=e[ii];e===null&&(e=n),as(e)&&By(e[ke],e),t=e&&e[Vn]}e=t}}function Av(n,e){let t=n[Io],i=t.indexOf(e);t.splice(i,1)}function kf(n,e){if(wo(e))return;let t=e[ni];t.destroyNode&&Vf(n,e,t,3,null,null),TO(e)}function By(n,e){if(wo(e))return;let t=Ge(null);try{e[Ye]&=-129,e[Ye]|=256,e[vn]&&Rc(e[vn]),AO(n,e),IO(n,e),e[ke].type===1&&e[ni].destroy();let i=e[Ls];if(i!==null&&tr(e[ii])){i!==e[ii]&&Av(i,e);let r=e[Mr];r!==null&&r.detachView(n)}Wy(e)}finally{Ge(t)}}function II(n,e,t,i){let r=n?.[So];if(r==null||r.leave==null||!r.leave.has(e.index))return i(!1);n&&Do.add(n),MA(t,()=>{if(r.leave&&r.leave.has(e.index)){let o=r.leave.get(e.index),a=[];if(o){for(let l=0;l<o.animateFns.length;l++){let c=o.animateFns[l],{promise:u}=c();a.push(u)}r.detachedLeaveAnimationFns=void 0}r.running=Promise.allSettled(a),SO(n,i)}else n&&Do.delete(n),i(!1)},r)}function SO(n,e){let t=n[So]?.running;if(t){t.then(()=>{n[So].running=void 0,Do.delete(n),e(!0)});return}e(!1)}function IO(n,e){let t=n.cleanup,i=e[el];if(t!==null)for(let o=0;o<t.length-1;o+=2)if(typeof t[o]=="string"){let a=t[o+3];a>=0?i[a]():i[-a].unsubscribe(),o+=2}else{let a=i[t[o+1]];t[o].call(a)}i!==null&&(e[el]=null);let r=e[ns];if(r!==null){e[ns]=null;for(let o=0;o<r.length;o++){let a=r[o];a()}}let s=e[qc];if(s!==null){e[qc]=null;for(let o of s)o.destroy()}}function AO(n,e){let t;if(n!=null&&(t=n.destroyHooks)!=null)for(let i=0;i<t.length;i+=2){let r=e[t[i]];if(!(r instanceof tu)){let s=t[i+1];if(Array.isArray(s))for(let o=0;o<s.length;o+=2){let a=r[s[o]],l=s[o+1];It(4,a,l);try{l.call(a)}finally{It(5,a,l)}}else{It(4,r,s);try{s.call(r)}finally{It(5,r,s)}}}}}function EO(n,e,t){return wO(n,e.parent,t)}function wO(n,e,t){let i=e;for(;i!==null&&i.type&168;)e=i,i=e.parent;if(i===null)return t[er];if(Ao(i)){let{encapsulation:r}=n.data[i.directiveStart+i.componentOffset];if(r===rr.None||r===rr.Emulated)return null}return Dr(i,t)}function MO(n,e,t){return RO(n,e,t)}function DO(n,e,t){return n.type&40?Dr(n,t):null}var RO=DO,AI;function Ev(n,e,t,i){let r=EO(n,i,e),s=e[ni],o=i.parent||e[Gn],a=MO(o,i,e);if(r!=null)if(Array.isArray(t))for(let l=0;l<t.length;l++)CI(s,r,t[l],a,!1);else CI(s,r,t,a,!1);AI!==void 0&&AI(s,i,e,t,r)}function Jc(n,e){if(e!==null){let t=e.type;if(t&3)return Dr(e,n);if(t&4)return Yy(-1,n[e.index]);if(t&8){let i=e.child;if(i!==null)return Jc(n,i);{let r=n[e.index];return tr(r)?Yy(-1,r):Un(r)}}else{if(t&128)return Jc(n,e.next);if(t&32)return Sv(e,n)()||Un(n[e.index]);{let i=RA(n,e);if(i!==null){if(Array.isArray(i))return i[0];let r=Os(n[yn]);return Jc(r,i)}else return Jc(n,e.next)}}}return null}function RA(n,e){if(e!==null){let i=n[yn][Gn],r=e.projection;return i.projection[r]}return null}function Yy(n,e){let t=kt+n+1;if(t<e.length){let i=e[t],r=i[ke].firstChild;if(r!==null)return Jc(i,r)}return e[Bs]}function wv(n,e,t,i,r,s,o){for(;t!=null;){let a=i[os];if(t.type===128){t=t.next;continue}let l=i[t.index],c=t.type;if(o&&e===0&&(l&&ul(Un(l),i),t.flags|=2),!_v(t))if(c&8)wv(n,e,t.child,i,r,s,!1),ll(e,n,a,r,l,t,s,i);else if(c&32){let u=Sv(t,i),h;for(;h=u();)ll(e,n,a,r,h,t,s,i);ll(e,n,a,r,l,t,s,i)}else c&16?PO(n,e,i,t,r,s):ll(e,n,a,r,l,t,s,i);t=o?t.projectionNext:t.next}}function Vf(n,e,t,i,r,s){wv(t,i,n.firstChild,e,r,s,!1)}function PO(n,e,t,i,r,s){let o=t[yn],l=o[Gn].projection[i.projection];if(Array.isArray(l))for(let c=0;c<l.length;c++){let u=l[c];ll(e,n,t[os],r,u,i,s,t)}else{let c=l,u=o[ii];iA(i)&&(c.flags|=128),wv(n,e,c,u,r,s,!0)}}function OO(n,e,t,i,r,s,o){let a=i[Bs],l=Un(i);a!==l&&ll(e,n,t,s,a,r,o);for(let c=kt;c<i.length;c++){let u=i[c];Vf(u[ke],u,n,e,s,a)}}function NO(n,e,t,i,r){if(e)r?n.addClass(t,i):n.removeClass(t,i);else{let s=i.indexOf("-")===-1?void 0:Nr.DashCase;r==null?n.removeStyle(t,i,s):(typeof r=="string"&&r.endsWith("!important")&&(r=r.slice(0,-10),s|=Nr.Important),n.setStyle(t,i,r,s))}}function PA(n,e,t,i,r){let s=ks(),o=i&2;try{Vs(-1),o&&e.length>ri&&AA(n,e,ri,!1),It(o?2:0,r,t),t(i,r)}finally{Vs(s),It(o?3:1,r,t)}}function OA(n,e,t){VO(n,e,t),(t.flags&64)===64&&GO(n,e,t)}function Mv(n,e,t=Dr){let i=e.localNames;if(i!==null){let r=e.index+1;for(let s=0;s<i.length;s+=2){let o=i[s+1],a=o===-1?t(e,n):n[o];n[r++]=a}}}function FO(n,e,t,i){let s=i.get(hA,uA)||t===rr.ShadowDom||t===rr.ExperimentalIsolatedShadowDom,o=n.selectRootElement(e,s);return LO(o),o}function LO(n){BO(n)}var BO=()=>null;function kO(n,e,t,i,r,s){if(n.type&3){let o=Dr(n,e);i=s!=null?s(i,n.value||"",t):i,r.setProperty(o,t,i)}else n.type&12}function VO(n,e,t){let i=t.directiveStart,r=t.directiveEnd;Ao(t)&&_O(e,t,n.data[i+t.componentOffset]),n.firstCreatePass||KI(t,e);let s=t.initialInputs;for(let o=i;o<r;o++){let a=n.data[o],l=_f(e,n,o,t);if(ul(l,e),s!==null&&HO(e,o-i,l,a,t,s),Eo(a)){let c=Rr(t.index,e);c[Ht]=_f(e,n,o,t)}}}function GO(n,e,t){let i=t.directiveStart,r=t.directiveEnd,s=t.index,o=nI();try{Vs(s);for(let a=i;a<r;a++){let l=n.data[a],c=e[a];ef(a),(l.hostBindings!==null||l.hostVars!==0||l.hostAttrs!==null)&&UO(l,c)}}finally{Vs(-1),ef(o)}}function UO(n,e){n.hostBindings!==null&&n.hostBindings(1,e)}function zO(n,e){let t=n.directiveRegistry,i=null;if(t)for(let r=0;r<t.length;r++){let s=t[r];sO(e,s.selectors,!1)&&(i??=[],Eo(s)?i.unshift(s):i.push(s))}return i}function HO(n,e,t,i,r,s){let o=s[e];if(o!==null)for(let a=0;a<o.length;a+=2){let l=o[a],c=o[a+1];qy(i,t,l,c)}}function NA(n,e,t,i,r){let s=ri+t,o=e[ke],a=r(o,e,n,i,t);e[s]=a,sl(n,!0);let l=n.type===2;return l?(TA(e[ni],a,n),(jS()===0||Zd(n))&&ul(a,e),qS()):ul(a,e),sf()&&(!l||!_v(n))&&Ev(o,e,a,n),n}function FA(n){let e=n;return Cy()?ZS():(e=e.parent,sl(e,!1)),e}function WO(n,e){let t=n[os];if(!t)return;let i;try{i=t.get(zn,null)}catch{i=null}i?.(e)}function LA(n,e,t,i,r){let s=n.inputs?.[i],o=n.hostDirectiveInputs?.[i],a=!1;if(o)for(let l=0;l<o.length;l+=2){let c=o[l],u=o[l+1],h=e.data[c];qy(h,t[c],u,r),a=!0}if(s)for(let l of s){let c=t[l],u=e.data[l];qy(u,c,i,r),a=!0}return a}function $O(n,e){let t=Rr(e,n),i=t[ke];jO(i,t);let r=t[er];r!==null&&t[Ja]===null&&(t[Ja]=dA(r,t[os])),It(18),Dv(i,t,t[Ht]),It(19,t[Ht])}function jO(n,e){for(let t=e.length;t<n.blueprint.length;t++)e.push(n.blueprint[t])}function Dv(n,e,t){nf(e);try{let i=n.viewQuery;i!==null&&jy(1,i,t);let r=n.template;r!==null&&PA(n,e,r,1,t),n.firstCreatePass&&(n.firstCreatePass=!1),e[Mr]?.finishViewCreation(n),n.staticContentQueries&&fA(n,e),n.staticViewQueries&&jy(2,n.viewQuery,t);let s=n.components;s!==null&&qO(e,s)}catch(i){throw n.firstCreatePass&&(n.incompleteFirstPass=!0,n.firstCreatePass=!1),i}finally{e[Ye]&=-5,rf()}}function qO(n,e){for(let t=0;t<e.length;t++)$O(n,e[t])}function Gf(n,e,t,i){let r=Ge(null);try{let s=e.tView,a=n[Ye]&4096?4096:16,l=Cv(n,s,t,a,null,e,null,null,i?.injector??null,i?.embeddedViewInjector??null,i?.dehydratedView??null),c=n[e.index];l[Ls]=c;let u=n[Mr];return u!==null&&(l[Mr]=u.createEmbeddedView(s)),Dv(s,l,t),l}finally{Ge(r)}}function iu(n,e){return!e||e.firstChild===null||iA(n)}function nu(n,e,t,i,r=!1){for(;t!==null;){if(t.type===128){t=r?t.projectionNext:t.next;continue}let s=e[t.index];s!==null&&i.push(Un(s)),tr(s)&&BA(s,i);let o=t.type;if(o&8)nu(n,e,t.child,i);else if(o&32){let a=Sv(t,e),l;for(;l=a();)i.push(l)}else if(o&16){let a=RA(e,t);if(Array.isArray(a))i.push(...a);else{let l=Os(e[yn]);nu(l[ke],l,a,i,!0)}}t=r?t.projectionNext:t.next}return i}function BA(n,e){for(let t=kt;t<n.length;t++){let i=n[t],r=i[ke].firstChild;r!==null&&nu(i[ke],i,r,e)}n[Bs]!==n[er]&&e.push(n[Bs])}function kA(n){if(n[Xd]!==null){for(let e of n[Xd])e.impl.addSequence(e);n[Xd].length=0}}var VA=[];function YO(n){return n[vn]??KO(n)}function KO(n){let e=VA.pop()??Object.create(ZO);return e.lView=n,e}function XO(n){n.lView[vn]!==n&&(n.lView=null,VA.push(n))}var ZO=lt(Y({},ad),{consumerIsAlwaysLive:!0,kind:"template",consumerMarkedDirty:n=>{Zc(n.lView)},consumerOnSignalRead(){this.lView[vn]=this}});function QO(n){let e=n[vn]??Object.create(JO);return e.lView=n,e}var JO=lt(Y({},ad),{consumerIsAlwaysLive:!0,kind:"template",consumerMarkedDirty:n=>{let e=Os(n.lView);for(;e&&!GA(e[ke]);)e=Os(e);e&&py(e)},consumerOnSignalRead(){this.lView[vn]=this}});function GA(n){return n.type!==2}function UA(n){if(n[qc]===null)return;let e=!0;for(;e;){let t=!1;for(let i of n[qc])i.dirty&&(t=!0,i.zone===null||Zone.current===i.zone?i.run():i.zone.run(()=>i.run()));e=t&&!!(n[Ye]&8192)}}var e1=100;function zA(n,e=0){let i=n[wr].rendererFactory,r=!1;r||i.begin?.();try{t1(n,e)}finally{r||i.end?.()}}function t1(n,e){let t=Ty();try{Sy(!0),Ky(n,e);let i=0;for(;Xc(n);){if(i===e1)throw new Le(103,!1);i++,Ky(n,1)}}finally{Sy(t)}}function i1(n,e,t,i){if(wo(e))return;let r=e[Ye],s=!1,o=!1;nf(e);let a=!0,l=null,c=null;s||(GA(n)?(c=YO(e),l=cd(c)):od()===null?(a=!1,c=QO(e),l=cd(c)):e[vn]&&(Rc(e[vn]),e[vn]=null));try{fy(e),JS(n.bindingStartIndex),t!==null&&PA(n,e,t,2,i);let u=(r&3)===3;if(!s)if(u){let f=n.preOrderCheckHooks;f!==null&&cf(e,f,null)}else{let f=n.preOrderHooks;f!==null&&uf(e,f,0,null),Fy(e,0)}if(o||n1(e),UA(e),HA(e,0),n.contentQueries!==null&&fA(n,e),!s)if(u){let f=n.contentCheckHooks;f!==null&&cf(e,f)}else{let f=n.contentHooks;f!==null&&uf(e,f,1),Fy(e,1)}s1(n,e);let h=n.components;h!==null&&$A(e,h,0);let d=n.viewQuery;if(d!==null&&jy(2,d,i),!s)if(u){let f=n.viewCheckHooks;f!==null&&cf(e,f)}else{let f=n.viewHooks;f!==null&&uf(e,f,2),Fy(e,2)}if(n.firstUpdatePass===!0&&(n.firstUpdatePass=!1),e[Kd]){for(let f of e[Kd])f();e[Kd]=null}s||(kA(e),e[Ye]&=-73)}catch(u){throw s||Zc(e),u}finally{c!==null&&(l_(c,l),a&&XO(c)),rf()}}function HA(n,e){for(let t=rA(n);t!==null;t=sA(t))for(let i=kt;i<t.length;i++){let r=t[i];WA(r,e)}}function n1(n){for(let e=rA(n);e!==null;e=sA(e)){if(!(e[Ye]&2))continue;let t=e[Io];for(let i=0;i<t.length;i++){let r=t[i];py(r)}}}function r1(n,e,t){It(18);let i=Rr(e,n);WA(i,t),It(19,i[Ht])}function WA(n,e){Qd(n)&&Ky(n,e)}function Ky(n,e){let i=n[ke],r=n[Ye],s=n[vn],o=!!(e===0&&r&16);if(o||=!!(r&64&&e===0),o||=!!(r&1024),o||=!!(s?.dirty&&ud(s)),o||=!1,s&&(s.dirty=!1),n[Ye]&=-9217,o)i1(i,n,i.template,n[Ht]);else if(r&8192){let a=Ge(null);try{UA(n),HA(n,1);let l=i.components;l!==null&&$A(n,l,1),kA(n)}finally{Ge(a)}}}function $A(n,e,t){for(let i=0;i<e.length;i++)r1(n,e[i],t)}function s1(n,e){let t=n.hostBindingOpCodes;if(t!==null)try{for(let i=0;i<t.length;i++){let r=t[i];if(r<0)Vs(~r);else{let s=r,o=t[++i],a=t[++i];iI(o,s);let l=e[s];It(24,l),a(2,l),It(25,l)}}}finally{Vs(-1)}}function Rv(n,e){let t=Ty()?64:1088;for(n[wr].changeDetectionScheduler?.notify(e);n;){n[Ye]|=t;let i=Os(n);if(il(n)&&!i)return n;n=i}return null}function jA(n,e,t,i){return[n,!0,0,e,null,i,null,t,null,null]}function qA(n,e){let t=kt+e;if(t<n.length)return n[t]}function Uf(n,e,t,i=!0){let r=e[ke];if(o1(r,e,n,t),i){let o=Yy(t,n),a=e[ni],l=a.parentNode(n[Bs]);l!==null&&CO(r,n[Gn],a,e,l,o)}let s=e[Ja];s!==null&&s.firstChild!==null&&(s.firstChild=null)}function YA(n,e){let t=ru(n,e);return t!==void 0&&kf(t[ke],t),t}function ru(n,e){if(n.length<=kt)return;let t=kt+e,i=n[t];if(i){let r=i[Ls];r!==null&&r!==n&&Av(r,i),e>0&&(n[t-1][Vn]=i[Vn]);let s=Hc(n,kt+e);xO(i[ke],i);let o=s[Mr];o!==null&&o.detachView(s[ke]),i[ii]=null,i[Vn]=null,i[Ye]&=-129}return i}function o1(n,e,t,i){let r=kt+i,s=t.length;i>0&&(t[r-1][Vn]=e),i<s-kt?(e[Vn]=t[r],ey(t,kt+i,e)):(t.push(e),e[Vn]=null),e[ii]=t;let o=e[Ls];o!==null&&t!==o&&KA(o,e);let a=e[Mr];a!==null&&a.insertView(n),Jd(e),e[Ye]|=128}function KA(n,e){let t=n[Io],i=e[ii];if(as(i))n[Ye]|=2;else{let r=i[ii][yn];e[yn]!==r&&(n[Ye]|=2)}t===null?n[Io]=[e]:t.push(e)}var Gs=class{_lView;_cdRefInjectingView;_appRef=null;_attachedToViewContainer=!1;exhaustive;get rootNodes(){let e=this._lView,t=e[ke];return nu(t,e,t.firstChild,[])}constructor(e,t){this._lView=e,this._cdRefInjectingView=t}get context(){return this._lView[Ht]}set context(e){this._lView[Ht]=e}get destroyed(){return wo(this._lView)}destroy(){if(this._appRef)this._appRef.detachView(this);else if(this._attachedToViewContainer){let e=this._lView[ii];if(tr(e)){let t=e[Yc],i=t?t.indexOf(this):-1;i>-1&&(ru(e,i),Hc(t,i))}this._attachedToViewContainer=!1}kf(this._lView[ke],this._lView)}onDestroy(e){my(this._lView,e)}markForCheck(){Rv(this._cdRefInjectingView||this._lView,4)}detach(){this._lView[Ye]&=-129}reattach(){Jd(this._lView),this._lView[Ye]|=128}detectChanges(){this._lView[Ye]|=1024,zA(this._lView)}checkNoChanges(){}attachToViewContainerRef(){if(this._appRef)throw new Le(902,!1);this._attachedToViewContainer=!0}detachFromAppRef(){this._appRef=null;let e=il(this._lView),t=this._lView[Ls];t!==null&&!e&&Av(t,this._lView),DA(this._lView[ke],this._lView)}attachToAppRef(e){if(this._attachedToViewContainer)throw new Le(902,!1);this._appRef=e;let t=il(this._lView),i=this._lView[Ls];i!==null&&!t&&KA(i,this._lView),Jd(this._lView)}};var hl=(()=>{class n{_declarationLView;_declarationTContainer;elementRef;static __NG_ELEMENT_ID__=a1;constructor(t,i,r){this._declarationLView=t,this._declarationTContainer=i,this.elementRef=r}get ssrId(){return this._declarationTContainer.tView?.ssrId||null}createEmbeddedView(t,i){return this.createEmbeddedViewImpl(t,i)}createEmbeddedViewImpl(t,i,r){let s=Gf(this._declarationLView,this._declarationTContainer,t,{embeddedViewInjector:i,dehydratedView:r});return new Gs(s)}}return n})();function a1(){return Pv(ir(),pt())}function Pv(n,e){return n.type&4?new hl(e,n,pl(n,e)):null}function zf(n,e,t,i,r){let s=n.data[e];if(s===null)s=l1(n,e,t,i,r),tI()&&(s.flags|=32);else if(s.type&64){s.type=t,s.value=i,s.attrs=r;let o=XS();s.injectorIndex=o===null?-1:o.injectorIndex}return sl(s,!0),s}function l1(n,e,t,i,r){let s=xy(),o=Cy(),a=o?s:s&&s.parent,l=n.data[e]=u1(n,a,t,e,i,r);return c1(n,l,s,o),l}function c1(n,e,t,i){n.firstChild===null&&(n.firstChild=e),t!==null&&(i?t.child==null&&e.parent!==null&&(t.child=e):t.next===null&&(t.next=e,e.prev=t))}function u1(n,e,t,i,r,s){let o=e?e.injectorIndex:-1,a=0;return KS()&&(a|=128),{type:t,index:i,insertBeforeIndex:null,injectorIndex:o,directiveStart:-1,directiveEnd:-1,directiveStylingLast:-1,componentOffset:-1,propertyBindings:null,flags:a,providerIndexes:0,value:r,attrs:s,mergedAttrs:null,localNames:null,initialInputs:null,inputs:null,hostDirectiveInputs:null,outputs:null,hostDirectiveOutputs:null,directiveToIndex:null,tView:null,next:null,prev:null,projectionNext:null,child:null,parent:e,projection:null,styles:null,stylesWithoutHost:null,residualStyles:void 0,classes:null,classesWithoutHost:null,residualClasses:void 0,classBindings:0,styleBindings:0}}function h1(n){let e=n[cy]??[],i=n[ii][ni],r=[];for(let s of e)s.data[cA]!==void 0?r.push(s):d1(s,i);n[cy]=r}function d1(n,e){let t=0,i=n.firstChild;if(i){let r=n.data[lA];for(;t<r;){let s=i.nextSibling;CA(e,i,!1),i=s,t++}}}var f1=()=>null,p1=()=>null;function Xy(n,e){return f1(n,e)}function XA(n,e,t){return p1(n,e,t)}var ZA=class{},Hf=class{},Zy=class{resolveComponentFactory(e){throw new Le(917,!1)}},uu=class{static NULL=new Zy},Ro=class{};var QA=(()=>{class n{static \u0275prov=Ne({token:n,providedIn:"root",factory:()=>null})}return n})();var df={},Qy=class{injector;parentInjector;constructor(e,t){this.injector=e,this.parentInjector=t}get(e,t,i){let r=this.injector.get(e,df,i);return r!==df||t===df?r:this.parentInjector.get(e,t,i)}};function xf(n,e,t){let i=t?n.styles:null,r=t?n.classes:null,s=0;if(e!==null)for(let o=0;o<e.length;o++){let a=e[o];if(typeof a=="number")s=a;else if(s==1)r=W_(r,a);else if(s==2){let l=a,c=e[++o];i=W_(i,l+": "+c+";")}}t?n.styles=i:n.stylesWithoutHost=i,t?n.classes=r:n.classesWithoutHost=r}function si(n,e=0){let t=pt();if(t===null)return qe(n,e);let i=ir();return JI(i,t,tn(n),e)}function m1(n,e,t,i,r){let s=i===null?null:{"":-1},o=r(n,t);if(o!==null){let a=o,l=null,c=null;for(let u of o)if(u.resolveHostDirectives!==null){[a,l,c]=u.resolveHostDirectives(o);break}y1(n,e,t,a,s,l,c)}s!==null&&i!==null&&g1(t,i,s)}function g1(n,e,t){let i=n.localNames=[];for(let r=0;r<e.length;r+=2){let s=t[e[r+1]];if(s==null)throw new Le(-301,!1);i.push(e[r],s)}}function _1(n,e,t){e.componentOffset=t,(n.components??=[]).push(e.index)}function y1(n,e,t,i,r,s,o){let a=i.length,l=!1;for(let d=0;d<a;d++){let f=i[d];!l&&Eo(f)&&(l=!0,_1(n,t,d)),BP(KI(t,e),n,f.type)}S1(t,n.data.length,a);for(let d=0;d<a;d++){let f=i[d];f.providersResolver&&f.providersResolver(f)}let c=!1,u=!1,h=IA(n,e,a,null);a>0&&(t.directiveToIndex=new Map);for(let d=0;d<a;d++){let f=i[d];if(t.mergedAttrs=Pf(t.mergedAttrs,f.hostAttrs),b1(n,t,e,h,f),T1(h,f,r),o!==null&&o.has(f)){let[g,_]=o.get(f);t.directiveToIndex.set(f.type,[h,g+t.directiveStart,_+t.directiveStart])}else(s===null||!s.has(f))&&t.directiveToIndex.set(f.type,h);f.contentQueries!==null&&(t.flags|=4),(f.hostBindings!==null||f.hostAttrs!==null||f.hostVars!==0)&&(t.flags|=64);let p=f.type.prototype;!c&&(p.ngOnChanges||p.ngOnInit||p.ngDoCheck)&&((n.preOrderHooks??=[]).push(t.index),c=!0),!u&&(p.ngOnChanges||p.ngDoCheck)&&((n.preOrderCheckHooks??=[]).push(t.index),u=!0),h++}v1(n,t,s)}function v1(n,e,t){for(let i=e.directiveStart;i<e.directiveEnd;i++){let r=n.data[i];if(t===null||!t.has(r))EI(0,e,r,i),EI(1,e,r,i),MI(e,i,!1);else{let s=t.get(r);wI(0,e,s,i),wI(1,e,s,i),MI(e,i,!0)}}}function EI(n,e,t,i){let r=n===0?t.inputs:t.outputs;for(let s in r)if(r.hasOwnProperty(s)){let o;n===0?o=e.inputs??={}:o=e.outputs??={},o[s]??=[],o[s].push(i),JA(e,s)}}function wI(n,e,t,i){let r=n===0?t.inputs:t.outputs;for(let s in r)if(r.hasOwnProperty(s)){let o=r[s],a;n===0?a=e.hostDirectiveInputs??={}:a=e.hostDirectiveOutputs??={},a[o]??=[],a[o].push(i,s),JA(e,o)}}function JA(n,e){e==="class"?n.flags|=8:e==="style"&&(n.flags|=16)}function MI(n,e,t){let{attrs:i,inputs:r,hostDirectiveInputs:s}=n;if(i===null||!t&&r===null||t&&s===null||bv(n)){n.initialInputs??=[],n.initialInputs.push(null);return}let o=null,a=0;for(;a<i.length;){let l=i[a];if(l===0){a+=4;continue}else if(l===5){a+=2;continue}else if(typeof l=="number")break;if(!t&&r.hasOwnProperty(l)){let c=r[l];for(let u of c)if(u===e){o??=[],o.push(l,i[a+1]);break}}else if(t&&s.hasOwnProperty(l)){let c=s[l];for(let u=0;u<c.length;u+=2)if(c[u]===e){o??=[],o.push(c[u+1],i[a+1]);break}}a+=2}n.initialInputs??=[],n.initialInputs.push(o)}function b1(n,e,t,i,r){n.data[i]=r;let s=r.factory||(r.factory=Ps(r.type,!0)),o=new tu(s,Eo(r),si,null);n.blueprint[i]=o,t[i]=o,x1(n,e,i,IA(n,t,r.hostVars,Fr),r)}function x1(n,e,t,i,r){let s=r.hostBindings;if(s){let o=n.hostBindingOpCodes;o===null&&(o=n.hostBindingOpCodes=[]);let a=~e.index;C1(o)!=a&&o.push(a),o.push(t,i,s)}}function C1(n){let e=n.length;for(;e>0;){let t=n[--e];if(typeof t=="number"&&t<0)return t}return 0}function T1(n,e,t){if(t){if(e.exportAs)for(let i=0;i<e.exportAs.length;i++)t[e.exportAs[i]]=n;Eo(e)&&(t[""]=n)}}function S1(n,e,t){n.flags|=1,n.directiveStart=e,n.directiveEnd=e+t,n.providerIndexes=e}function eE(n,e,t,i,r,s,o,a){let l=e[ke],c=l.consts,u=Pr(c,o),h=zf(l,n,t,i,u);return s&&m1(l,e,h,Pr(c,a),r),h.mergedAttrs=Pf(h.mergedAttrs,h.attrs),h.attrs!==null&&xf(h,h.attrs,!1),h.mergedAttrs!==null&&xf(h,h.mergedAttrs,!0),l.queries!==null&&l.queries.elementStart(l,h),h}function tE(n,e){AP(n,e),uy(e)&&n.queries.elementEnd(e)}function I1(n,e,t,i,r,s){let o=e.consts,a=Pr(o,r),l=zf(e,n,t,i,a);if(l.mergedAttrs=Pf(l.mergedAttrs,l.attrs),s!=null){let c=Pr(o,s);l.localNames=[];for(let u=0;u<c.length;u+=2)l.localNames.push(c[u],-1)}return l.attrs!==null&&xf(l,l.attrs,!1),l.mergedAttrs!==null&&xf(l,l.mergedAttrs,!0),e.queries!==null&&e.queries.elementStart(e,l),l}function A1(n,e,t){return n[e]=t}function gl(n,e,t){if(t===Fr)return!1;let i=n[e];return Object.is(i,t)?!1:(n[e]=t,!0)}function E1(n,e,t){return function i(r){let s=Ao(n)?Rr(n.index,e):e;Rv(s,5);let o=e[Ht],a=DI(e,o,t,r),l=i.__ngNextListenerFn__;for(;l;)a=DI(e,o,l,r)&&a,l=l.__ngNextListenerFn__;return a}}function DI(n,e,t,i){let r=Ge(null);try{return It(6,e,t),t(i)!==!1}catch(s){return WO(n,s),!1}finally{It(7,e,t),Ge(r)}}function w1(n,e,t,i,r,s,o,a){let l=Zd(n),c=!1,u=null;if(!i&&l&&(u=D1(e,t,s,n.index)),u!==null){let h=u.__ngLastListenerFn__||u;h.__ngNextListenerFn__=o,u.__ngLastListenerFn__=o,c=!0}else{let h=Dr(n,t),d=i?i(h):h;XP(t,d,s,a);let f=r.listen(d,s,a);if(!M1(s)){let p=i?g=>i(Un(g[n.index])):n.index;R1(p,e,t,s,a,f,!1)}}return c}function M1(n){return n.startsWith("animation")||n.startsWith("transition")}function D1(n,e,t,i){let r=n.cleanup;if(r!=null)for(let s=0;s<r.length-1;s+=2){let o=r[s];if(o===t&&r[s+1]===i){let a=e[el],l=r[s+2];return a&&a.length>l?a[l]:null}typeof o=="string"&&(s+=2)}return null}function R1(n,e,t,i,r,s,o){let a=e.firstCreatePass?_y(e):null,l=gy(t),c=l.length;l.push(r,s),a&&a.push(i,n,c,(c+1)*(o?-1:1))}var Jy=Symbol("BINDING");var Cf=class extends uu{ngModule;constructor(e){super(),this.ngModule=e}resolveComponentFactory(e){let t=Fs(e);return new dl(t,this.ngModule)}};function P1(n){return Object.keys(n).map(e=>{let[t,i,r]=n[e],s={propName:t,templateName:e,isSignal:(i&Bf.SignalBased)!==0};return r&&(s.transform=r),s})}function O1(n){return Object.keys(n).map(e=>({propName:n[e],templateName:e}))}function N1(n,e,t){let i=e instanceof Ai?e:e?.injector;return i&&n.getStandaloneInjector!==null&&(i=n.getStandaloneInjector(i)||i),i?new Qy(t,i):t}function F1(n){let e=n.get(Ro,null);if(e===null)throw new Le(407,!1);let t=n.get(QA,null),i=n.get(vo,null);return{rendererFactory:e,sanitizer:t,changeDetectionScheduler:i,ngReflect:!1}}function L1(n,e){let t=iE(n);return bA(e,t,t==="svg"?kS:t==="math"?VS:null)}function iE(n){return(n.selectors[0][0]||"div").toLowerCase()}var dl=class extends Hf{componentDef;ngModule;selector;componentType;ngContentSelectors;isBoundToModule;cachedInputs=null;cachedOutputs=null;get inputs(){return this.cachedInputs??=P1(this.componentDef.inputs),this.cachedInputs}get outputs(){return this.cachedOutputs??=O1(this.componentDef.outputs),this.cachedOutputs}constructor(e,t){super(),this.componentDef=e,this.ngModule=t,this.componentType=e.type,this.selector=cO(e.selectors),this.ngContentSelectors=e.ngContentSelectors??[],this.isBoundToModule=!!t}create(e,t,i,r,s,o){It(22);let a=Ge(null);try{let l=this.componentDef,c=B1(i,l,o,s),u=N1(l,r||this.ngModule,e),h=F1(u),d=h.rendererFactory.createRenderer(null,l),f=i?FO(d,i,l.encapsulation,u):L1(l,d),p=o?.some(RI)||s?.some(y=>typeof y!="function"&&y.bindings.some(RI)),g=Cv(null,c,null,512|SA(l),null,null,h,d,u,null,dA(f,u,!0));g[ri]=f,nf(g);let _=null;try{let y=eE(ri,g,2,"#host",()=>c.directiveRegistry,!0,0);TA(d,f,y),ul(f,g),OA(c,g,y),pA(c,y,g),tE(c,y),t!==void 0&&V1(y,this.ngContentSelectors,t),_=Rr(y.index,g),g[Ht]=_[Ht],Dv(c,g,null)}catch(y){throw _!==null&&Wy(_),Wy(g),y}finally{It(23),rf()}return new Tf(this.componentType,g,!!p)}finally{Ge(a)}}};function B1(n,e,t,i){let r=n?["ng-version","21.0.0"]:uO(e.selectors[0]),s=null,o=null,a=0;if(t)for(let u of t)a+=u[Jy].requiredVars,u.create&&(u.targetIdx=0,(s??=[]).push(u)),u.update&&(u.targetIdx=0,(o??=[]).push(u));if(i)for(let u=0;u<i.length;u++){let h=i[u];if(typeof h!="function")for(let d of h.bindings){a+=d[Jy].requiredVars;let f=u+1;d.create&&(d.targetIdx=f,(s??=[]).push(d)),d.update&&(d.targetIdx=f,(o??=[]).push(d))}}let l=[e];if(i)for(let u of i){let h=typeof u=="function"?u:u.type,d=ry(h);l.push(d)}return xv(0,null,k1(s,o),1,a,l,null,null,null,[r],null)}function k1(n,e){return!n&&!e?null:t=>{if(t&1&&n)for(let i of n)i.create();if(t&2&&e)for(let i of e)i.update()}}function RI(n){let e=n[Jy].kind;return e==="input"||e==="twoWay"}var Tf=class extends ZA{_rootLView;_hasInputBindings;instance;hostView;changeDetectorRef;componentType;location;previousInputValues=null;_tNode;constructor(e,t,i){super(),this._rootLView=t,this._hasInputBindings=i,this._tNode=Kc(t[ke],ri),this.location=pl(this._tNode,t),this.instance=Rr(this._tNode.index,t)[Ht],this.hostView=this.changeDetectorRef=new Gs(t,void 0),this.componentType=e}setInput(e,t){this._hasInputBindings;let i=this._tNode;if(this.previousInputValues??=new Map,this.previousInputValues.has(e)&&Object.is(this.previousInputValues.get(e),t))return;let r=this._rootLView,s=LA(i,r[ke],r,e,t);this.previousInputValues.set(e,t);let o=Rr(i.index,r);Rv(o,1)}get injector(){return new Mo(this._tNode,this._rootLView)}destroy(){this.hostView.destroy()}onDestroy(e){this.hostView.onDestroy(e)}};function V1(n,e,t){let i=n.projection=[];for(let r=0;r<e.length;r++){let s=t[r];i.push(s!=null&&s.length?Array.from(s):null)}}var No=(()=>{class n{static __NG_ELEMENT_ID__=G1}return n})();function G1(){let n=ir();return rE(n,pt())}var U1=No,nE=class extends U1{_lContainer;_hostTNode;_hostLView;constructor(e,t,i){super(),this._lContainer=e,this._hostTNode=t,this._hostLView=i}get element(){return pl(this._hostTNode,this._hostLView)}get injector(){return new Mo(this._hostTNode,this._hostLView)}get parentInjector(){let e=pv(this._hostTNode,this._hostLView);if(jI(e)){let t=mf(e,this._hostLView),i=pf(e),r=t[ke].data[i+8];return new Mo(r,t)}else return new Mo(null,this._hostLView)}clear(){for(;this.length>0;)this.remove(this.length-1)}get(e){let t=PI(this._lContainer);return t!==null&&t[e]||null}get length(){return this._lContainer.length-kt}createEmbeddedView(e,t,i){let r,s;typeof i=="number"?r=i:i!=null&&(r=i.index,s=i.injector);let o=Xy(this._lContainer,e.ssrId),a=e.createEmbeddedViewImpl(t||{},s,o);return this.insertImpl(a,r,iu(this._hostTNode,o)),a}createComponent(e,t,i,r,s,o,a){let l=e&&!xP(e),c;if(l)c=t;else{let _=t||{};c=_.index,i=_.injector,r=_.projectableNodes,s=_.environmentInjector||_.ngModuleRef,o=_.directives,a=_.bindings}let u=l?e:new dl(Fs(e)),h=i||this.parentInjector;if(!s&&u.ngModule==null){let y=(l?h:this.parentInjector).get(Ai,null);y&&(s=y)}let d=Fs(u.componentType??{}),f=Xy(this._lContainer,d?.id??null),p=f?.firstChild??null,g=u.create(h,r,p,s,o,a);return this.insertImpl(g.hostView,c,iu(this._hostTNode,f)),g}insert(e,t){return this.insertImpl(e,t,!0)}insertImpl(e,t,i){let r=e._lView;if(zS(r)){let a=this.indexOf(e);if(a!==-1)this.detach(a);else{let l=r[ii],c=new nE(l,l[Gn],l[ii]);c.detach(c.indexOf(e))}}let s=this._adjustIndex(t),o=this._lContainer;return Uf(o,r,s,i),e.attachToViewContainerRef(),ey(ky(o),s,e),e}move(e,t){return this.insert(e,t)}indexOf(e){let t=PI(this._lContainer);return t!==null?t.indexOf(e):-1}remove(e){let t=this._adjustIndex(e,-1),i=ru(this._lContainer,t);i&&(Hc(ky(this._lContainer),t),kf(i[ke],i))}detach(e){let t=this._adjustIndex(e,-1),i=ru(this._lContainer,t);return i&&Hc(ky(this._lContainer),t)!=null?new Gs(i):null}_adjustIndex(e,t=0){return e??this.length+t}};function PI(n){return n[Yc]}function ky(n){return n[Yc]||(n[Yc]=[])}function rE(n,e){let t,i=e[n.index];return tr(i)?t=i:(t=jA(i,e,null,n),e[n.index]=t,Tv(e,t)),H1(t,e,n,i),new nE(t,n,e)}function z1(n,e){let t=n[ni],i=t.createComment(""),r=Dr(e,n),s=t.parentNode(r);return bf(t,s,i,t.nextSibling(r),!1),i}var H1=j1,W1=()=>!1;function $1(n,e,t){return W1(n,e,t)}function j1(n,e,t,i){if(n[Bs])return;let r;t.type&8?r=Un(i):r=z1(e,t),n[Bs]=r}var ev=class n{queryList;matches=null;constructor(e){this.queryList=e}clone(){return new n(this.queryList)}setDirty(){this.queryList.setDirty()}},tv=class n{queries;constructor(e=[]){this.queries=e}createEmbeddedView(e){let t=e.queries;if(t!==null){let i=e.contentQueries!==null?e.contentQueries[0]:t.length,r=[];for(let s=0;s<i;s++){let o=t.getByIndex(s),a=this.queries[o.indexInDeclarationView];r.push(a.clone())}return new n(r)}return null}insertView(e){this.dirtyQueriesWithMatches(e)}detachView(e){this.dirtyQueriesWithMatches(e)}finishViewCreation(e){this.dirtyQueriesWithMatches(e)}dirtyQueriesWithMatches(e){for(let t=0;t<this.queries.length;t++)Ov(e,t).matches!==null&&this.queries[t].setDirty()}},iv=class{flags;read;predicate;constructor(e,t,i=null){this.flags=t,this.read=i,typeof e=="string"?this.predicate=eN(e):this.predicate=e}},nv=class n{queries;constructor(e=[]){this.queries=e}elementStart(e,t){for(let i=0;i<this.queries.length;i++)this.queries[i].elementStart(e,t)}elementEnd(e){for(let t=0;t<this.queries.length;t++)this.queries[t].elementEnd(e)}embeddedTView(e){let t=null;for(let i=0;i<this.length;i++){let r=t!==null?t.length:0,s=this.getByIndex(i).embeddedTView(e,r);s&&(s.indexInDeclarationView=i,t!==null?t.push(s):t=[s])}return t!==null?new n(t):null}template(e,t){for(let i=0;i<this.queries.length;i++)this.queries[i].template(e,t)}getByIndex(e){return this.queries[e]}get length(){return this.queries.length}track(e){this.queries.push(e)}},rv=class n{metadata;matches=null;indexInDeclarationView=-1;crossesNgTemplate=!1;_declarationNodeIndex;_appliesToNextNode=!0;constructor(e,t=-1){this.metadata=e,this._declarationNodeIndex=t}elementStart(e,t){this.isApplyingToNode(t)&&this.matchTNode(e,t)}elementEnd(e){this._declarationNodeIndex===e.index&&(this._appliesToNextNode=!1)}template(e,t){this.elementStart(e,t)}embeddedTView(e,t){return this.isApplyingToNode(e)?(this.crossesNgTemplate=!0,this.addMatch(-e.index,t),new n(this.metadata)):null}isApplyingToNode(e){if(this._appliesToNextNode&&(this.metadata.flags&1)!==1){let t=this._declarationNodeIndex,i=e.parent;for(;i!==null&&i.type&8&&i.index!==t;)i=i.parent;return t===(i!==null?i.index:-1)}return this._appliesToNextNode}matchTNode(e,t){let i=this.metadata.predicate;if(Array.isArray(i))for(let r=0;r<i.length;r++){let s=i[r];this.matchTNodeWithReadOption(e,t,q1(t,s)),this.matchTNodeWithReadOption(e,t,hf(t,e,s,!1,!1))}else i===hl?t.type&4&&this.matchTNodeWithReadOption(e,t,-1):this.matchTNodeWithReadOption(e,t,hf(t,e,i,!1,!1))}matchTNodeWithReadOption(e,t,i){if(i!==null){let r=this.metadata.read;if(r!==null)if(r===ml||r===No||r===hl&&t.type&4)this.addMatch(t.index,-2);else{let s=hf(t,e,r,!1,!1);s!==null&&this.addMatch(t.index,s)}else this.addMatch(t.index,i)}}addMatch(e,t){this.matches===null?this.matches=[e,t]:this.matches.push(e,t)}};function q1(n,e){let t=n.localNames;if(t!==null){for(let i=0;i<t.length;i+=2)if(t[i]===e)return t[i+1]}return null}function Y1(n,e){return n.type&11?pl(n,e):n.type&4?Pv(n,e):null}function K1(n,e,t,i){return t===-1?Y1(e,n):t===-2?X1(n,e,i):_f(n,n[ke],t,e)}function X1(n,e,t){if(t===ml)return pl(e,n);if(t===hl)return Pv(e,n);if(t===No)return rE(e,n)}function sE(n,e,t,i){let r=e[Mr].queries[i];if(r.matches===null){let s=n.data,o=t.matches,a=[];for(let l=0;o!==null&&l<o.length;l+=2){let c=o[l];if(c<0)a.push(null);else{let u=s[c];a.push(K1(e,u,o[l+1],t.metadata.read))}}r.matches=a}return r.matches}function sv(n,e,t,i){let r=n.queries.getByIndex(t),s=r.matches;if(s!==null){let o=sE(n,e,r,t);for(let a=0;a<s.length;a+=2){let l=s[a];if(l>0)i.push(o[a/2]);else{let c=s[a+1],u=e[-l];for(let h=kt;h<u.length;h++){let d=u[h];d[Ls]===d[ii]&&sv(d[ke],d,c,i)}if(u[Io]!==null){let h=u[Io];for(let d=0;d<h.length;d++){let f=h[d];sv(f[ke],f,c,i)}}}}}return i}function Z1(n,e){return n[Mr].queries[e].queryList}function Q1(n,e,t){let i=new yf((t&4)===4);return $S(n,e,i,i.destroy),(e[Mr]??=new tv).queries.push(new ev(i))-1}function J1(n,e,t){let i=bn();return i.firstCreatePass&&(tN(i,new iv(n,e,t),-1),(e&2)===2&&(i.staticViewQueries=!0)),Q1(i,pt(),e)}function eN(n){return n.split(",").map(e=>e.trim())}function tN(n,e,t){n.queries===null&&(n.queries=new nv),n.queries.track(new rv(e,t))}function Ov(n,e){return n.queries.getByIndex(e)}function iN(n,e){let t=n[ke],i=Ov(t,e);return i.crossesNgTemplate?sv(t,n,e,[]):sE(t,n,i,e)}var Po=class{},Wf=class{};var Sf=class extends Po{ngModuleType;_parent;_bootstrapComponents=[];_r3Injector;instance;destroyCbs=[];componentFactoryResolver=new Cf(this);constructor(e,t,i,r=!0){super(),this.ngModuleType=e,this._parent=t;let s=ny(e);this._bootstrapComponents=yA(s.bootstrap),this._r3Injector=wy(e,t,[{provide:Po,useValue:this},{provide:uu,useValue:this.componentFactoryResolver},...i],rs(e),new Set(["environment"])),r&&this.resolveInjectorInitializers()}resolveInjectorInitializers(){this._r3Injector.resolveInjectorInitializers(),this.instance=this._r3Injector.get(this.ngModuleType)}get injector(){return this._r3Injector}destroy(){let e=this._r3Injector;!e.destroyed&&e.destroy(),this.destroyCbs.forEach(t=>t()),this.destroyCbs=null}onDestroy(e){this.destroyCbs.push(e)}},If=class extends Wf{moduleType;constructor(e){super(),this.moduleType=e}create(e){return new Sf(this.moduleType,e,[])}};var su=class extends Po{injector;componentFactoryResolver=new Cf(this);instance=null;constructor(e){super();let t=new yo([...e.providers,{provide:Po,useValue:this},{provide:uu,useValue:this.componentFactoryResolver}],e.parent||$c(),e.debugName,new Set(["environment"]));this.injector=t,e.runEnvironmentInitializers&&t.resolveInjectorInitializers()}destroy(){this.injector.destroy()}onDestroy(e){this.injector.onDestroy(e)}};function hu(n,e,t=null){return new su({providers:n,parent:e,debugName:t,runEnvironmentInitializers:!0}).injector}var nN=(()=>{class n{_injector;cachedInjectors=new Map;constructor(t){this._injector=t}getOrCreateStandaloneInjector(t){if(!t.standalone)return null;if(!this.cachedInjectors.has(t)){let i=sy(!1,t.type),r=i.length>0?hu([i],this._injector,`Standalone[${t.type.name}]`):null;this.cachedInjectors.set(t,r)}return this.cachedInjectors.get(t)}ngOnDestroy(){try{for(let t of this.cachedInjectors.values())t!==null&&t.destroy()}finally{this.cachedInjectors.clear()}}static \u0275prov=Ne({token:n,providedIn:"environment",factory:()=>new n(qe(Ai))})}return n})();function sr(n){return au(()=>{let e=oE(n),t=lt(Y({},e),{decls:n.decls,vars:n.vars,template:n.template,consts:n.consts||null,ngContentSelectors:n.ngContentSelectors,onPush:n.changeDetection===mv.OnPush,directiveDefs:null,pipeDefs:null,dependencies:e.standalone&&n.dependencies||null,getStandaloneInjector:e.standalone?r=>r.get(nN).getOrCreateStandaloneInjector(t):null,getExternalStyles:null,signals:n.signals??!1,data:n.data||{},encapsulation:n.encapsulation||rr.Emulated,styles:n.styles||kn,_:null,schemas:n.schemas||null,tView:null,id:""});e.standalone&&Us("NgStandalone"),aE(t);let i=n.dependencies;return t.directiveDefs=OI(i,rN),t.pipeDefs=OI(i,RS),t.id=aN(t),t})}function rN(n){return Fs(n)||ry(n)}function du(n){return au(()=>({type:n.type,bootstrap:n.bootstrap||kn,declarations:n.declarations||kn,imports:n.imports||kn,exports:n.exports||kn,transitiveCompileScopes:null,schemas:n.schemas||null,id:n.id||null}))}function sN(n,e){if(n==null)return xo;let t={};for(let i in n)if(n.hasOwnProperty(i)){let r=n[i],s,o,a,l;Array.isArray(r)?(a=r[0],s=r[1],o=r[2]??s,l=r[3]||null):(s=r,o=r,a=Bf.None,l=null),t[s]=[i,a,l],e[s]=o}return t}function oN(n){if(n==null)return xo;let e={};for(let t in n)n.hasOwnProperty(t)&&(e[n[t]]=t);return e}function $f(n){return au(()=>{let e=oE(n);return aE(e),e})}function Nv(n){return{type:n.type,name:n.name,factory:null,pure:n.pure!==!1,standalone:n.standalone??!0,onDestroy:n.type.prototype.ngOnDestroy||null}}function oE(n){let e={};return{type:n.type,providersResolver:null,factory:null,hostBindings:n.hostBindings||null,hostVars:n.hostVars||0,hostAttrs:n.hostAttrs||null,contentQueries:n.contentQueries||null,declaredInputs:e,inputConfig:n.inputs||xo,exportAs:n.exportAs||null,standalone:n.standalone??!0,signals:n.signals===!0,selectors:n.selectors||kn,viewQuery:n.viewQuery||null,features:n.features||null,setInput:null,resolveHostDirectives:null,hostDirectives:null,inputs:sN(n.inputs,e),outputs:oN(n.outputs),debugInfo:null}}function aE(n){n.features?.forEach(e=>e(n))}function OI(n,e){return n?()=>{let t=typeof n=="function"?n():n,i=[];for(let r of t){let s=e(r);s!==null&&i.push(s)}return i}:null}function aN(n){let e=0,t=typeof n.consts=="function"?"":n.consts,i=[n.selectors,n.ngContentSelectors,n.hostVars,n.hostAttrs,t,n.vars,n.decls,n.encapsulation,n.standalone,n.signals,n.exportAs,JSON.stringify(n.inputs),JSON.stringify(n.outputs),Object.getOwnPropertyNames(n.type.prototype),!!n.contentQueries,!!n.viewQuery];for(let s of i.join("|"))e=Math.imul(31,e)+s.charCodeAt(0)<<0;return e+=2147483648,"c"+e}function lN(n,e,t,i,r,s,o,a){if(t.firstCreatePass){n.mergedAttrs=Pf(n.mergedAttrs,n.attrs);let u=n.tView=xv(2,n,r,s,o,t.directiveRegistry,t.pipeRegistry,null,t.schemas,t.consts,null);t.queries!==null&&(t.queries.template(t,n),u.queries=t.queries.embeddedTView(n))}a&&(n.flags|=a),sl(n,!1);let l=cN(t,e,n,i);sf()&&Ev(t,e,l,n),ul(l,e);let c=jA(l,e,l,n);e[i+ri]=c,Tv(e,c),$1(c,n,e)}function Af(n,e,t,i,r,s,o,a,l,c,u){let h=t+ri,d;if(e.firstCreatePass){if(d=zf(e,h,4,o||null,a||null),c!=null){let f=Pr(e.consts,c);d.localNames=[];for(let p=0;p<f.length;p+=2)d.localNames.push(f[p],-1)}}else d=e.data[h];return lN(d,n,e,t,i,r,s,l),c!=null&&Mv(n,d,u),d}var cN=uN;function uN(n,e,t,i){return of(!0),e[ni].createComment("")}var Fv=(()=>{class n{log(t){console.log(t)}warn(t){console.warn(t)}static \u0275fac=function(i){return new(i||n)};static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"platform"})}return n})();var Lv=new Ue("");function Fo(n){return!!n&&typeof n.then=="function"}function jf(n){return!!n&&typeof n.subscribe=="function"}var lE=new Ue("");var Bv=(()=>{class n{resolve;reject;initialized=!1;done=!1;donePromise=new Promise((t,i)=>{this.resolve=t,this.reject=i});appInits=ue(lE,{optional:!0})??[];injector=ue(Er);constructor(){}runInitializers(){if(this.initialized)return;let t=[];for(let r of this.appInits){let s=Gi(this.injector,r);if(Fo(s))t.push(s);else if(jf(s)){let o=new Promise((a,l)=>{s.subscribe({complete:a,error:l})});t.push(o)}}let i=()=>{this.done=!0,this.resolve()};Promise.all(t).then(()=>{i()}).catch(r=>{this.reject(r)}),t.length===0&&i(),this.initialized=!0}static \u0275fac=function(i){return new(i||n)};static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})(),qf=new Ue("");function cE(){u_(()=>{let n="";throw new Le(600,n)})}function uE(n){return n.isBoundToModule}var hN=10;var Lo=(()=>{class n{_runningTick=!1;_destroyed=!1;_destroyListeners=[];_views=[];internalErrorHandler=ue(zn);afterRenderManager=ue(EA);zonelessEnabled=ue(al);rootEffectScheduler=ue(Ny);dirtyFlags=0;tracingSnapshot=null;allTestViews=new Set;autoDetectTestViews=new Set;includeAllTestViews=!1;afterTick=new ti;get allViews(){return[...(this.includeAllTestViews?this.allTestViews:this.autoDetectTestViews).keys(),...this._views]}get destroyed(){return this._destroyed}componentTypes=[];components=[];internalPendingTask=ue(ls);get isStable(){return this.internalPendingTask.hasPendingTasksObservable.pipe(At(t=>!t))}constructor(){ue(cu,{optional:!0})}whenStable(){let t;return new Promise(i=>{t=this.isStable.subscribe({next:r=>{r&&i()}})}).finally(()=>{t.unsubscribe()})}_injector=ue(Ai);_rendererFactory=null;get injector(){return this._injector}bootstrap(t,i){return this.bootstrapImpl(t,i)}bootstrapImpl(t,i,r=Er.NULL){return this._injector.get(Et).run(()=>{It(10);let o=t instanceof Hf;if(!this._injector.get(Bv).done){let p="";throw new Le(405,p)}let l;o?l=t:l=this._injector.get(uu).resolveComponentFactory(t),this.componentTypes.push(l.componentType);let c=uE(l)?void 0:this._injector.get(Po),u=i||l.selector,h=l.create(r,[],u,c),d=h.location.nativeElement,f=h.injector.get(Lv,null);return f?.registerApplication(d),h.onDestroy(()=>{this.detachView(h.hostView),eu(this.components,h),f?.unregisterApplication(d)}),this._loadComponent(h),It(11,h),h})}tick(){this.zonelessEnabled||(this.dirtyFlags|=1),this._tick()}_tick(){It(12),this.tracingSnapshot!==null?this.tracingSnapshot.run(Iv.CHANGE_DETECTION,this.tickImpl):this.tickImpl()}tickImpl=()=>{if(this._runningTick)throw new Le(101,!1);let t=Ge(null);try{this._runningTick=!0,this.synchronize()}finally{this._runningTick=!1,this.tracingSnapshot?.dispose(),this.tracingSnapshot=null,Ge(t),this.afterTick.next(),It(13)}};synchronize(){this._rendererFactory===null&&!this._injector.destroyed&&(this._rendererFactory=this._injector.get(Ro,null,{optional:!0}));let t=0;for(;this.dirtyFlags!==0&&t++<hN;)It(14),this.synchronizeOnce(),It(15)}synchronizeOnce(){this.dirtyFlags&16&&(this.dirtyFlags&=-17,this.rootEffectScheduler.flush());let t=!1;if(this.dirtyFlags&7){let i=!!(this.dirtyFlags&1);this.dirtyFlags&=-8,this.dirtyFlags|=8;for(let{_lView:r}of this.allViews){if(!i&&!Xc(r))continue;let s=i&&!this.zonelessEnabled?0:1;zA(r,s),t=!0}if(this.dirtyFlags&=-5,this.syncDirtyFlagsWithViews(),this.dirtyFlags&23)return}t||(this._rendererFactory?.begin?.(),this._rendererFactory?.end?.()),this.dirtyFlags&8&&(this.dirtyFlags&=-9,this.afterRenderManager.execute()),this.syncDirtyFlagsWithViews()}syncDirtyFlagsWithViews(){if(this.allViews.some(({_lView:t})=>Xc(t))){this.dirtyFlags|=2;return}else this.dirtyFlags&=-8}attachView(t){let i=t;this._views.push(i),i.attachToAppRef(this)}detachView(t){let i=t;eu(this._views,i),i.detachFromAppRef()}_loadComponent(t){this.attachView(t.hostView);try{this.tick()}catch(r){this.internalErrorHandler(r)}this.components.push(t),this._injector.get(qf,[]).forEach(r=>r(t))}ngOnDestroy(){if(!this._destroyed)try{this._destroyListeners.forEach(t=>t()),this._views.slice().forEach(t=>t.destroy())}finally{this._destroyed=!0,this._views=[],this._destroyListeners=[]}}onDestroy(t){return this._destroyListeners.push(t),()=>eu(this._destroyListeners,t)}destroy(){if(this._destroyed)throw new Le(406,!1);let t=this._injector;t.destroy&&!t.destroyed&&t.destroy()}get viewCount(){return this._views.length}static \u0275fac=function(i){return new(i||n)};static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();function eu(n,e){let t=n.indexOf(e);t>-1&&n.splice(t,1)}var JW=typeof document<"u"&&typeof document?.documentElement?.getAnimations=="function";var ov=class{destroy(e){}updateValue(e,t){}swap(e,t){let i=Math.min(e,t),r=Math.max(e,t),s=this.detach(r);if(r-i>1){let o=this.detach(i);this.attach(i,s),this.attach(r,o)}else this.attach(i,s)}move(e,t){this.attach(t,this.detach(e))}};function Vy(n,e,t,i,r){return n===t&&Object.is(e,i)?1:Object.is(r(n,e),r(t,i))?-1:0}function dN(n,e,t,i){let r,s,o=0,a=n.length-1,l=void 0;if(Array.isArray(e)){Ge(i);let c=e.length-1;for(Ge(null);o<=a&&o<=c;){let u=n.at(o),h=e[o],d=Vy(o,u,o,h,t);if(d!==0){d<0&&n.updateValue(o,h),o++;continue}let f=n.at(a),p=e[c],g=Vy(a,f,c,p,t);if(g!==0){g<0&&n.updateValue(a,p),a--,c--;continue}let _=t(o,u),y=t(a,f),b=t(o,h);if(Object.is(b,y)){let A=t(c,p);Object.is(A,_)?(n.swap(o,a),n.updateValue(a,p),c--,a--):n.move(a,o),n.updateValue(o,h),o++;continue}if(r??=new Ef,s??=FI(n,o,a,t),av(n,r,o,b))n.updateValue(o,h),o++,a++;else if(s.has(b))r.set(_,n.detach(o)),a--;else{let A=n.create(o,e[o]);n.attach(o,A),o++,a++}}for(;o<=c;)NI(n,r,t,o,e[o]),o++}else if(e!=null){Ge(i);let c=e[Symbol.iterator]();Ge(null);let u=c.next();for(;!u.done&&o<=a;){let h=n.at(o),d=u.value,f=Vy(o,h,o,d,t);if(f!==0)f<0&&n.updateValue(o,d),o++,u=c.next();else{r??=new Ef,s??=FI(n,o,a,t);let p=t(o,d);if(av(n,r,o,p))n.updateValue(o,d),o++,a++,u=c.next();else if(!s.has(p))n.attach(o,n.create(o,d)),o++,a++,u=c.next();else{let g=t(o,h);r.set(g,n.detach(o)),a--}}}for(;!u.done;)NI(n,r,t,n.length,u.value),u=c.next()}for(;o<=a;)n.destroy(n.detach(a--));r?.forEach(c=>{n.destroy(c)})}function av(n,e,t,i){return e!==void 0&&e.has(i)?(n.attach(t,e.get(i)),e.delete(i),!0):!1}function NI(n,e,t,i,r){if(av(n,e,i,t(i,r)))n.updateValue(i,r);else{let s=n.create(i,r);n.attach(i,s)}}function FI(n,e,t,i){let r=new Set;for(let s=e;s<=t;s++)r.add(i(s,n.at(s)));return r}var Ef=class{kvMap=new Map;_vMap=void 0;has(e){return this.kvMap.has(e)}delete(e){if(!this.has(e))return!1;let t=this.kvMap.get(e);return this._vMap!==void 0&&this._vMap.has(t)?(this.kvMap.set(e,this._vMap.get(t)),this._vMap.delete(t)):this.kvMap.delete(e),!0}get(e){return this.kvMap.get(e)}set(e,t){if(this.kvMap.has(e)){let i=this.kvMap.get(e);this._vMap===void 0&&(this._vMap=new Map);let r=this._vMap;for(;r.has(i);)i=r.get(i);r.set(i,t)}else this.kvMap.set(e,t)}forEach(e){for(let[t,i]of this.kvMap)if(e(i,t),this._vMap!==void 0){let r=this._vMap;for(;r.has(i);)i=r.get(i),e(i,t)}}};function rn(n,e,t,i,r,s,o,a){Us("NgControlFlow");let l=pt(),c=bn(),u=Pr(c.consts,s);return Af(l,c,n,e,t,i,r,u,256,o,a),fu}function fu(n,e,t,i,r,s,o,a){Us("NgControlFlow");let l=pt(),c=bn(),u=Pr(c.consts,s);return Af(l,c,n,e,t,i,r,u,512,o,a),fu}function sn(n,e){Us("NgControlFlow");let t=pt(),i=Qc(),r=t[i]!==Fr?t[i]:-1,s=r!==-1?wf(t,ri+r):void 0,o=0;if(gl(t,i,n)){let a=Ge(null);try{if(s!==void 0&&YA(s,o),n!==-1){let l=ri+n,c=wf(t,l),u=hv(t[ke],l),h=XA(c,u,t),d=Gf(t,u,e,{dehydratedView:h});Uf(c,d,o,iu(u,h))}}finally{Ge(a)}}else if(s!==void 0){let a=qA(s,o);a!==void 0&&(a[Ht]=e)}}var lv=class{lContainer;$implicit;$index;constructor(e,t,i){this.lContainer=e,this.$implicit=t,this.$index=i}get $count(){return this.lContainer.length-kt}};function Lr(n,e){return e}var cv=class{hasEmptyBlock;trackByFn;liveCollection;constructor(e,t,i){this.hasEmptyBlock=e,this.trackByFn=t,this.liveCollection=i}};function xn(n,e,t,i,r,s,o,a,l,c,u,h,d){Us("NgControlFlow");let f=pt(),p=bn(),g=l!==void 0,_=pt(),y=a?o.bind(_[yn][Ht]):o,b=new cv(g,y);_[ri+n]=b,Af(f,p,n+1,e,t,i,r,Pr(p.consts,s),256),g&&Af(f,p,n+2,l,c,u,h,Pr(p.consts,d),512)}var uv=class extends ov{lContainer;hostLView;templateTNode;operationsCounter=void 0;needsIndexUpdate=!1;constructor(e,t,i){super(),this.lContainer=e,this.hostLView=t,this.templateTNode=i}get length(){return this.lContainer.length-kt}at(e){return this.getLView(e)[Ht].$implicit}attach(e,t){let i=t[Ja];this.needsIndexUpdate||=e!==this.length,Uf(this.lContainer,t,e,iu(this.templateTNode,i)),fN(this.lContainer,e)}detach(e){return this.needsIndexUpdate||=e!==this.length-1,pN(this.lContainer,e),mN(this.lContainer,e)}create(e,t){let i=Xy(this.lContainer,this.templateTNode.tView.ssrId),r=Gf(this.hostLView,this.templateTNode,new lv(this.lContainer,t,e),{dehydratedView:i});return this.operationsCounter?.recordCreate(),r}destroy(e){kf(e[ke],e),this.operationsCounter?.recordDestroy()}updateValue(e,t){this.getLView(e)[Ht].$implicit=t}reset(){this.needsIndexUpdate=!1,this.operationsCounter?.reset()}updateIndexes(){if(this.needsIndexUpdate)for(let e=0;e<this.length;e++)this.getLView(e)[Ht].$index=e}getLView(e){return gN(this.lContainer,e)}};function Cn(n){let e=Ge(null),t=ks();try{let i=pt(),r=i[ke],s=i[t],o=t+1,a=wf(i,o);if(s.liveCollection===void 0){let c=hv(r,o);s.liveCollection=new uv(a,i,c)}else s.liveCollection.reset();let l=s.liveCollection;if(dN(l,n,s.trackByFn,e),l.updateIndexes(),s.hasEmptyBlock){let c=Qc(),u=l.length===0;if(gl(i,c,u)){let h=t+2,d=wf(i,h);if(u){let f=hv(r,h),p=XA(d,f,i),g=Gf(i,f,void 0,{dehydratedView:p});Uf(d,g,0,iu(f,p))}else r.firstUpdatePass&&h1(d),YA(d,0)}}}finally{Ge(e)}}function wf(n,e){return n[e]}function fN(n,e){if(n.length<=kt)return;let t=kt+e,i=n[t],r=i?i[So]:void 0;if(i&&r&&r.detachedLeaveAnimationFns&&r.detachedLeaveAnimationFns.length>0){let s=i[os];vO(s,r),Do.delete(i),r.detachedLeaveAnimationFns=void 0}}function pN(n,e){if(n.length<=kt)return;let t=kt+e,i=n[t],r=i?i[So]:void 0;r&&r.leave&&r.leave.size>0&&(r.detachedLeaveAnimationFns=[])}function mN(n,e){return ru(n,e)}function gN(n,e){return qA(n,e)}function hv(n,e){return Kc(n,e)}function LI(n,e,t,i,r){LA(e,n,t,r?"class":"style",i)}function kv(n,e,t,i){let r=pt(),s=r[ke],o=n+ri,a=s.firstCreatePass?eE(o,r,2,e,zO,YS(),t,i):s.data[o];if(NA(a,r,n,e,hE),Zd(a)){let l=r[ke];OA(l,r,a),pA(l,a,r)}return i!=null&&Mv(r,a),kv}function Vv(){let n=bn(),e=ir(),t=FA(e);return n.firstCreatePass&&tE(n,t),vy(t)&&by(),yy(),t.classesWithoutHost!=null&&wP(t)&&LI(n,t,pt(),t.classesWithoutHost,!0),t.stylesWithoutHost!=null&&MP(t)&&LI(n,t,pt(),t.stylesWithoutHost,!1),Vv}function _l(n,e,t,i){return kv(n,e,t,i),Vv(),_l}function De(n,e,t,i){let r=pt(),s=r[ke],o=n+ri,a=s.firstCreatePass?I1(o,s,2,e,t,i):s.data[o];return NA(a,r,n,e,hE),i!=null&&Mv(r,a),De}function we(){let n=ir(),e=FA(n);return vy(e)&&by(),yy(),we}function on(n,e,t,i){return De(n,e,t,i),we(),on}var hE=(n,e,t,i,r)=>(of(!0),bA(e[ni],i,uI()));function pu(){return pt()}function Br(n,e,t){let i=pt(),r=Qc();if(gl(i,r,e)){let s=bn(),o=cI();kO(o,i,n,e,i[ni],t)}return Br}var mu="en-US";var _N=mu;function dE(n){typeof n=="string"&&(_N=n.toLowerCase().replace(/_/g,"-"))}function yl(n,e,t){let i=pt(),r=bn(),s=ir();return(s.type&3||t)&&w1(s,r,i,t,i[ni],n,e,E1(s,i,e)),yl}function Ei(n=1){return lI(n)}function gu(n,e,t){J1(n,e,t)}function _u(n){let e=pt(),t=bn(),i=Iy();tf(i+1);let r=Ov(t,i);if(n.dirty&&US(e)===((r.metadata.flags&2)===2)){if(r.matches===null)n.reset([]);else{let s=iN(e,i);n.reset(s,HP),n.notifyOnChanges()}return!0}return!1}function yu(){return Z1(pt(),Iy())}function lf(n,e){return n<<17|e<<2}function Oo(n){return n>>17&32767}function yN(n){return(n&2)==2}function vN(n,e){return n&131071|e<<17}function dv(n){return n|2}function fl(n){return(n&131068)>>2}function Gy(n,e){return n&-131069|e<<2}function bN(n){return(n&1)===1}function fv(n){return n|1}function xN(n,e,t,i,r,s){let o=s?e.classBindings:e.styleBindings,a=Oo(o),l=fl(o);n[i]=t;let c=!1,u;if(Array.isArray(t)){let h=t;u=h[1],(u===null||Za(h,u)>0)&&(c=!0)}else u=t;if(r)if(l!==0){let d=Oo(n[a+1]);n[i+1]=lf(d,a),d!==0&&(n[d+1]=Gy(n[d+1],i)),n[a+1]=vN(n[a+1],i)}else n[i+1]=lf(a,0),a!==0&&(n[a+1]=Gy(n[a+1],i)),a=i;else n[i+1]=lf(l,0),a===0?a=i:n[l+1]=Gy(n[l+1],i),l=i;c&&(n[i+1]=dv(n[i+1])),BI(n,u,i,!0),BI(n,u,i,!1),CN(e,u,n,i,s),o=lf(a,l),s?e.classBindings=o:e.styleBindings=o}function CN(n,e,t,i,r){let s=r?n.residualClasses:n.residualStyles;s!=null&&typeof e=="string"&&Za(s,e)>=0&&(t[i+1]=fv(t[i+1]))}function BI(n,e,t,i){let r=n[t+1],s=e===null,o=i?Oo(r):fl(r),a=!1;for(;o!==0&&(a===!1||s);){let l=n[o],c=n[o+1];TN(l,e)&&(a=!0,n[o+1]=i?fv(c):dv(c)),o=i?Oo(c):fl(c)}a&&(n[t+1]=i?dv(r):fv(r))}function TN(n,e){return n===null||e==null||(Array.isArray(n)?n[1]:n)===e?!0:Array.isArray(n)&&typeof e=="string"?Za(n,e)>=0:!1}function Yf(n,e,t){return fE(n,e,t,!1),Yf}function us(n,e){return fE(n,e,null,!0),us}function fE(n,e,t,i){let r=pt(),s=bn(),o=eI(2);if(s.firstUpdatePass&&IN(s,n,o,i),e!==Fr&&gl(r,o,e)){let a=s.data[ks()];DN(s,a,r,r[ni],n,r[o+1]=RN(e,t),i,o)}}function SN(n,e){return e>=n.expandoStartIndex}function IN(n,e,t,i){let r=n.data;if(r[t+1]===null){let s=r[ks()],o=SN(n,t);PN(s,i)&&e===null&&!o&&(e=!1),e=AN(r,s,e,i),xN(r,s,e,t,o,i)}}function AN(n,e,t,i){let r=rI(n),s=i?e.residualClasses:e.residualStyles;if(r===null)(i?e.classBindings:e.styleBindings)===0&&(t=Uy(null,n,e,t,i),t=ou(t,e.attrs,i),s=null);else{let o=e.directiveStylingLast;if(o===-1||n[o]!==r)if(t=Uy(r,n,e,t,i),s===null){let l=EN(n,e,i);l!==void 0&&Array.isArray(l)&&(l=Uy(null,n,e,l[1],i),l=ou(l,e.attrs,i),wN(n,e,i,l))}else s=MN(n,e,i)}return s!==void 0&&(i?e.residualClasses=s:e.residualStyles=s),t}function EN(n,e,t){let i=t?e.classBindings:e.styleBindings;if(fl(i)!==0)return n[Oo(i)]}function wN(n,e,t,i){let r=t?e.classBindings:e.styleBindings;n[Oo(r)]=i}function MN(n,e,t){let i,r=e.directiveEnd;for(let s=1+e.directiveStylingLast;s<r;s++){let o=n[s].hostAttrs;i=ou(i,o,t)}return ou(i,e.attrs,t)}function Uy(n,e,t,i,r){let s=null,o=t.directiveEnd,a=t.directiveStylingLast;for(a===-1?a=t.directiveStart:a++;a<o&&(s=e[a],i=ou(i,s.hostAttrs,r),s!==n);)a++;return n!==null&&(t.directiveStylingLast=a),i}function ou(n,e,t){let i=t?1:2,r=-1;if(e!==null)for(let s=0;s<e.length;s++){let o=e[s];typeof o=="number"?r=o:r===i&&(Array.isArray(n)||(n=n===void 0?[]:["",n]),DS(n,o,t?!0:e[++s]))}return n===void 0?null:n}function DN(n,e,t,i,r,s,o,a){if(!(e.type&3))return;let l=n.data,c=l[a+1],u=bN(c)?kI(l,e,t,r,fl(c),o):void 0;if(!Mf(u)){Mf(s)||yN(c)&&(s=kI(l,null,t,r,a,o));let h=hy(ks(),t);NO(i,o,h,r,s)}}function kI(n,e,t,i,r,s){let o=e===null,a;for(;r>0;){let l=n[r],c=Array.isArray(l),u=c?l[1]:l,h=u===null,d=t[r+1];d===Fr&&(d=h?kn:void 0);let f=h?Yd(d,i):u===i?d:void 0;if(c&&!Mf(f)&&(f=Yd(l,i)),Mf(f)&&(a=f,o))return a;let p=n[r+1];r=o?Oo(p):fl(p)}if(e!==null){let l=s?e.residualClasses:e.residualStyles;l!=null&&(a=Yd(l,i))}return a}function Mf(n){return n!==void 0}function RN(n,e){return n==null||n===""||(typeof e=="string"?n=n+e:typeof n=="object"&&(n=rs(yv(n)))),n}function PN(n,e){return(n.flags&(e?8:16))!==0}function Ke(n,e=""){let t=pt(),i=bn(),r=n+ri,s=i.firstCreatePass?zf(i,r,1,e,null):i.data[r],o=ON(i,t,s,e,n);t[r]=o,sf()&&Ev(i,t,o,s),sl(s,!1)}var ON=(n,e,t,i,r)=>(of(!0),hO(e[ni],i));function NN(n,e,t,i=""){return gl(n,Qc(),t)?e+$d(t)+i:Fr}function oi(n){return or("",n),oi}function or(n,e,t){let i=pt(),r=NN(i,n,e,t);return r!==Fr&&FN(i,ks(),r),or}function FN(n,e,t){let i=hy(e,n);dO(n[ni],i,t)}function LN(n,e){let t=n[e];return t===Fr?void 0:t}function BN(n,e,t,i,r,s){let o=e+t;return gl(n,o,r)?A1(n,o+1,s?i.call(s,r):i(r)):LN(n,o+1)}function zs(n,e){let t=bn(),i,r=n+ri;t.firstCreatePass?(i=kN(e,t.pipeRegistry),t.data[r]=i,i.onDestroy&&(t.destroyHooks??=[]).push(r,i.onDestroy)):i=t.data[r];let s=i.factory||(i.factory=Ps(i.type,!0)),o,a=ki(si);try{let l=gf(!1),c=s();return gf(l),dy(t,pt(),r,c),c}finally{ki(a)}}function kN(n,e){if(e)for(let t=e.length-1;t>=0;t--){let i=e[t];if(n===i.name)return i}}function Hs(n,e,t){let i=n+ri,r=pt(),s=GS(r,i);return VN(r,i)?BN(r,QS(),e,s.transform,t,s):s.transform(t)}function VN(n,e){return n[ke].data[e].pure}var Df=class{ngModuleFactory;componentFactories;constructor(e,t){this.ngModuleFactory=e,this.componentFactories=t}},Gv=(()=>{class n{compileModuleSync(t){return new If(t)}compileModuleAsync(t){return Promise.resolve(this.compileModuleSync(t))}compileModuleAndAllComponentsSync(t){let i=this.compileModuleSync(t),r=ny(t),s=yA(r.declarations).reduce((o,a)=>{let l=Fs(a);return l&&o.push(new dl(l)),o},[]);return new Df(i,s)}compileModuleAndAllComponentsAsync(t){return Promise.resolve(this.compileModuleAndAllComponentsSync(t))}clearCache(){}clearCacheFor(t){}getModuleId(t){}static \u0275fac=function(i){return new(i||n)};static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();var pE=(()=>{class n{applicationErrorHandler=ue(zn);appRef=ue(Lo);taskService=ue(ls);ngZone=ue(Et);zonelessEnabled=ue(al);tracing=ue(cu,{optional:!0});zoneIsDefined=typeof Zone<"u"&&!!Zone.root.run;schedulerTickApplyArgs=[{data:{__scheduler_tick__:!0}}];subscriptions=new zt;angularZoneId=this.zoneIsDefined?this.ngZone._inner?.get(Gc):null;scheduleInRootZone=!this.zonelessEnabled&&this.zoneIsDefined&&(ue(af,{optional:!0})??!1);cancelScheduledCallback=null;useMicrotaskScheduler=!1;runningTick=!1;pendingRenderTaskId=null;constructor(){this.subscriptions.add(this.appRef.afterTick.subscribe(()=>{this.runningTick||this.cleanup()})),this.subscriptions.add(this.ngZone.onUnstable.subscribe(()=>{this.runningTick||this.cleanup()}))}notify(t){if(!this.zonelessEnabled&&t===5)return;switch(t){case 0:{this.appRef.dirtyFlags|=2;break}case 3:case 2:case 4:case 5:case 1:{this.appRef.dirtyFlags|=4;break}case 6:{this.appRef.dirtyFlags|=2;break}case 12:{this.appRef.dirtyFlags|=16;break}case 13:{this.appRef.dirtyFlags|=2;break}case 11:break;case 9:case 8:case 7:case 10:default:this.appRef.dirtyFlags|=8}if(this.appRef.tracingSnapshot=this.tracing?.snapshot(this.appRef.tracingSnapshot)??null,!this.shouldScheduleTick())return;let i=this.useMicrotaskScheduler?Ry:Dy;this.pendingRenderTaskId=this.taskService.add(),this.scheduleInRootZone?this.cancelScheduledCallback=Zone.root.run(()=>i(()=>this.tick())):this.cancelScheduledCallback=this.ngZone.runOutsideAngular(()=>i(()=>this.tick()))}shouldScheduleTick(){return!(this.appRef.destroyed||this.pendingRenderTaskId!==null||this.runningTick||this.appRef._runningTick||!this.zonelessEnabled&&this.zoneIsDefined&&Zone.current.get(Gc+this.angularZoneId))}tick(){if(this.runningTick||this.appRef.destroyed)return;if(this.appRef.dirtyFlags===0){this.cleanup();return}!this.zonelessEnabled&&this.appRef.dirtyFlags&7&&(this.appRef.dirtyFlags|=1);let t=this.taskService.add();try{this.ngZone.run(()=>{this.runningTick=!0,this.appRef._tick()},void 0,this.schedulerTickApplyArgs)}catch(i){this.taskService.remove(t),this.applicationErrorHandler(i)}finally{this.cleanup()}this.useMicrotaskScheduler=!0,Ry(()=>{this.useMicrotaskScheduler=!1,this.taskService.remove(t)})}ngOnDestroy(){this.subscriptions.unsubscribe(),this.cleanup()}cleanup(){if(this.runningTick=!1,this.cancelScheduledCallback?.(),this.cancelScheduledCallback=null,this.pendingRenderTaskId!==null){let t=this.pendingRenderTaskId;this.pendingRenderTaskId=null,this.taskService.remove(t)}}static \u0275fac=function(i){return new(i||n)};static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();function mE(){return[{provide:vo,useExisting:pE},{provide:Et,useClass:Uc},{provide:al,useValue:!0}]}function GN(){return typeof $localize<"u"&&$localize.locale||mu}var Kf=new Ue("",{factory:()=>ue(Kf,{optional:!0,skipSelf:!0})||GN()});var _E=Symbol("InputSignalNode#UNSET"),nF=lt(Y({},hd),{transformFn:void 0,applyValueToInputSignal(n,e){Pc(n,e)}});function yE(n,e){let t=Object.create(nF);t.value=n,t.transformFn=e?.transform;function i(){if(ld(t),t.value===_E){let r=null;throw new Le(-950,r)}return t.value}return i[Ln]=t,i}function gE(n,e){return yE(n,e)}function rF(n){return yE(_E,n)}var vE=(gE.required=rF,gE);var sF=(()=>{class n{zone=ue(Et);changeDetectionScheduler=ue(vo);applicationRef=ue(Lo);applicationErrorHandler=ue(zn);_onMicrotaskEmptySubscription;initialize(){this._onMicrotaskEmptySubscription||(this._onMicrotaskEmptySubscription=this.zone.onMicrotaskEmpty.subscribe({next:()=>{this.changeDetectionScheduler.runningTick||this.zone.run(()=>{try{this.applicationRef.dirtyFlags|=1,this.applicationRef._tick()}catch(t){this.applicationErrorHandler(t)}})}}))}ngOnDestroy(){this._onMicrotaskEmptySubscription?.unsubscribe()}static \u0275fac=function(i){return new(i||n)};static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})(),oF=new Ue("",{factory:()=>!1});function aF({ngZoneFactory:n,scheduleInRootZone:e}){return n??=()=>new Et(lt(Y({},xE()),{scheduleInRootZone:e})),[{provide:al,useValue:!1},{provide:Et,useFactory:n},{provide:Ns,multi:!0,useFactory:()=>{let t=ue(sF,{optional:!0});return()=>t.initialize()}},{provide:Ns,multi:!0,useFactory:()=>{let t=ue(lF);return()=>{t.initialize()}}},{provide:af,useValue:e??My}]}function bE(n){let e=n?.scheduleInRootZone,t=aF({ngZoneFactory:()=>{let i=xE(n);return i.scheduleInRootZone=e,i.shouldCoalesceEventChangeDetection&&Us("NgZone_CoalesceEvent"),new Et(i)},scheduleInRootZone:e});return Qa([{provide:oF,useValue:!0},t])}function xE(n){return{enableLongStackTrace:!1,shouldCoalesceEventChangeDetection:n?.eventCoalescing??!1,shouldCoalesceRunChangeDetection:n?.runCoalescing??!1}}var lF=(()=>{class n{subscription=new zt;initialized=!1;zone=ue(Et);pendingTasks=ue(ls);initialize(){if(this.initialized)return;this.initialized=!0;let t=null;!this.zone.isStable&&!this.zone.hasPendingMacrotasks&&!this.zone.hasPendingMicrotasks&&(t=this.pendingTasks.add()),this.zone.runOutsideAngular(()=>{this.subscription.add(this.zone.onStable.subscribe(()=>{Et.assertNotInAngularZone(),queueMicrotask(()=>{t!==null&&!this.zone.hasPendingMacrotasks&&!this.zone.hasPendingMicrotasks&&(this.pendingTasks.remove(t),t=null)})}))}),this.subscription.add(this.zone.onUnstable.subscribe(()=>{Et.assertInAngularZone(),t??=this.pendingTasks.add()}))}ngOnDestroy(){this.subscription.unsubscribe()}static \u0275fac=function(i){return new(i||n)};static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();var Uv=new Ue(""),cF=new Ue("");function vu(n){return!n.moduleRef}function uF(n){let e=vu(n)?n.r3Injector:n.moduleRef.injector,t=e.get(Et);return t.run(()=>{vu(n)?n.r3Injector.resolveInjectorInitializers():n.moduleRef.resolveInjectorInitializers();let i=e.get(zn),r;if(t.runOutsideAngular(()=>{r=t.onError.subscribe({next:i})}),vu(n)){let s=()=>e.destroy(),o=n.platformInjector.get(Uv);o.add(s),e.onDestroy(()=>{r.unsubscribe(),o.delete(s)})}else{let s=()=>n.moduleRef.destroy(),o=n.platformInjector.get(Uv);o.add(s),n.moduleRef.onDestroy(()=>{eu(n.allPlatformModules,n.moduleRef),r.unsubscribe(),o.delete(s)})}return dF(i,t,()=>{let s=e.get(ls),o=s.add(),a=e.get(Bv);return a.runInitializers(),a.donePromise.then(()=>{let l=e.get(Kf,mu);if(dE(l||mu),!e.get(cF,!0))return vu(n)?e.get(Lo):(n.allPlatformModules.push(n.moduleRef),n.moduleRef);if(vu(n)){let u=e.get(Lo);return n.rootComponent!==void 0&&u.bootstrap(n.rootComponent),u}else return hF?.(n.moduleRef,n.allPlatformModules),n.moduleRef}).finally(()=>void s.remove(o))})})}var hF;function dF(n,e,t){try{let i=t();return Fo(i)?i.catch(r=>{throw e.runOutsideAngular(()=>n(r)),r}):i}catch(i){throw e.runOutsideAngular(()=>n(i)),i}}var Xf=null;function fF(n=[],e){return Er.create({name:e,providers:[{provide:Wc,useValue:"platform"},{provide:Uv,useValue:new Set([()=>Xf=null])},...n]})}function pF(n=[]){if(Xf)return Xf;let e=fF(n);return Xf=e,cE(),mF(e),e}function mF(n){let e=n.get(Ff,null);Gi(n,()=>{e?.forEach(t=>t())})}var Qf=(()=>{class n{static __NG_ELEMENT_ID__=gF}return n})();function gF(n){return _F(ir(),pt(),(n&16)===16)}function _F(n,e,t){if(Ao(n)&&!t){let i=Rr(n.index,e);return new Gs(i,i)}else if(n.type&175){let i=e[yn];return new Gs(i,e)}return null}function CE(n){let{rootComponent:e,appProviders:t,platformProviders:i,platformRef:r}=n;It(8);try{let s=r?.injector??pF(i),o=[mE(),fI,...t||[]],a=new su({providers:o,parent:s,debugName:"",runEnvironmentInitializers:!1});return uF({r3Injector:a.injector,platformInjector:s,rootComponent:e})}catch(s){return Promise.reject(s)}finally{It(9)}}var IE=null;function hs(){return IE}function zv(n){IE??=n}var bu=class{},Hv=(()=>{class n{historyGo(t){throw new Error("")}static \u0275fac=function(i){return new(i||n)};static \u0275prov=Ne({token:n,factory:()=>ue(AE),providedIn:"platform"})}return n})();var AE=(()=>{class n extends Hv{_location;_history;_doc=ue(Ui);constructor(){super(),this._location=window.location,this._history=window.history}getBaseHrefFromDOM(){return hs().getBaseHref(this._doc)}onPopState(t){let i=hs().getGlobalEventTarget(this._doc,"window");return i.addEventListener("popstate",t,!1),()=>i.removeEventListener("popstate",t)}onHashChange(t){let i=hs().getGlobalEventTarget(this._doc,"window");return i.addEventListener("hashchange",t,!1),()=>i.removeEventListener("hashchange",t)}get href(){return this._location.href}get protocol(){return this._location.protocol}get hostname(){return this._location.hostname}get port(){return this._location.port}get pathname(){return this._location.pathname}get search(){return this._location.search}get hash(){return this._location.hash}set pathname(t){this._location.pathname=t}pushState(t,i,r){this._history.pushState(t,i,r)}replaceState(t,i,r){this._history.replaceState(t,i,r)}forward(){this._history.forward()}back(){this._history.back()}historyGo(t=0){this._history.go(t)}getState(){return this._history.state}static \u0275fac=function(i){return new(i||n)};static \u0275prov=Ne({token:n,factory:()=>new n,providedIn:"platform"})}return n})();function EE(n,e){return n?e?n.endsWith("/")?e.startsWith("/")?n+e.slice(1):n+e:e.startsWith("/")?n+e:`${n}/${e}`:n:e}function TE(n){let e=n.search(/#|\?|$/);return n[e-1]==="/"?n.slice(0,e-1)+n.slice(e):n}function Ws(n){return n&&n[0]!=="?"?`?${n}`:n}var Jf=(()=>{class n{historyGo(t){throw new Error("")}static \u0275fac=function(i){return new(i||n)};static \u0275prov=Ne({token:n,factory:()=>ue(ME),providedIn:"root"})}return n})(),wE=new Ue(""),ME=(()=>{class n extends Jf{_platformLocation;_baseHref;_removeListenerFns=[];constructor(t,i){super(),this._platformLocation=t,this._baseHref=i??this._platformLocation.getBaseHrefFromDOM()??ue(Ui).location?.origin??""}ngOnDestroy(){for(;this._removeListenerFns.length;)this._removeListenerFns.pop()()}onPopState(t){this._removeListenerFns.push(this._platformLocation.onPopState(t),this._platformLocation.onHashChange(t))}getBaseHref(){return this._baseHref}prepareExternalUrl(t){return EE(this._baseHref,t)}path(t=!1){let i=this._platformLocation.pathname+Ws(this._platformLocation.search),r=this._platformLocation.hash;return r&&t?`${i}${r}`:i}pushState(t,i,r,s){let o=this.prepareExternalUrl(r+Ws(s));this._platformLocation.pushState(t,i,o)}replaceState(t,i,r,s){let o=this.prepareExternalUrl(r+Ws(s));this._platformLocation.replaceState(t,i,o)}forward(){this._platformLocation.forward()}back(){this._platformLocation.back()}getState(){return this._platformLocation.getState()}historyGo(t=0){this._platformLocation.historyGo?.(t)}static \u0275fac=function(i){return new(i||n)(qe(Hv),qe(wE,8))};static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})(),vl=(()=>{class n{_subject=new ti;_basePath;_locationStrategy;_urlChangeListeners=[];_urlChangeSubscription=null;constructor(t){this._locationStrategy=t;let i=this._locationStrategy.getBaseHref();this._basePath=bF(TE(SE(i))),this._locationStrategy.onPopState(r=>{this._subject.next({url:this.path(!0),pop:!0,state:r.state,type:r.type})})}ngOnDestroy(){this._urlChangeSubscription?.unsubscribe(),this._urlChangeListeners=[]}path(t=!1){return this.normalize(this._locationStrategy.path(t))}getState(){return this._locationStrategy.getState()}isCurrentPathEqualTo(t,i=""){return this.path()==this.normalize(t+Ws(i))}normalize(t){return n.stripTrailingSlash(vF(this._basePath,SE(t)))}prepareExternalUrl(t){return t&&t[0]!=="/"&&(t="/"+t),this._locationStrategy.prepareExternalUrl(t)}go(t,i="",r=null){this._locationStrategy.pushState(r,"",t,i),this._notifyUrlChangeListeners(this.prepareExternalUrl(t+Ws(i)),r)}replaceState(t,i="",r=null){this._locationStrategy.replaceState(r,"",t,i),this._notifyUrlChangeListeners(this.prepareExternalUrl(t+Ws(i)),r)}forward(){this._locationStrategy.forward()}back(){this._locationStrategy.back()}historyGo(t=0){this._locationStrategy.historyGo?.(t)}onUrlChange(t){return this._urlChangeListeners.push(t),this._urlChangeSubscription??=this.subscribe(i=>{this._notifyUrlChangeListeners(i.url,i.state)}),()=>{let i=this._urlChangeListeners.indexOf(t);this._urlChangeListeners.splice(i,1),this._urlChangeListeners.length===0&&(this._urlChangeSubscription?.unsubscribe(),this._urlChangeSubscription=null)}}_notifyUrlChangeListeners(t="",i){this._urlChangeListeners.forEach(r=>r(t,i))}subscribe(t,i,r){return this._subject.subscribe({next:t,error:i??void 0,complete:r??void 0})}static normalizeQueryParams=Ws;static joinWithSlash=EE;static stripTrailingSlash=TE;static \u0275fac=function(i){return new(i||n)(qe(Jf))};static \u0275prov=Ne({token:n,factory:()=>yF(),providedIn:"root"})}return n})();function yF(){return new vl(qe(Jf))}function vF(n,e){if(!n||!e.startsWith(n))return e;let t=e.substring(n.length);return t===""||["/",";","?","#"].includes(t[0])?t:e}function SE(n){return n.replace(/\/index.html$/,"")}function bF(n){if(new RegExp("^(https?:)?//").test(n)){let[,t]=n.split(/\/\/[^\/]+/);return t}return n}function xF(n,e){return new Le(2100,!1)}var Wv=class{createSubscription(e,t,i){return Hn(()=>e.subscribe({next:t,error:i}))}dispose(e){Hn(()=>e.unsubscribe())}},$v=class{createSubscription(e,t,i){return e.then(r=>t?.(r),r=>i?.(r)),{unsubscribe:()=>{t=null,i=null}}}dispose(e){e.unsubscribe()}},CF=new $v,TF=new Wv,jv=(()=>{class n{_ref;_latestValue=null;markForCheckOnValueUpdate=!0;_subscription=null;_obj=null;_strategy=null;applicationErrorHandler=ue(zn);constructor(t){this._ref=t}ngOnDestroy(){this._subscription&&this._dispose(),this._ref=null}transform(t){if(!this._obj){if(t)try{this.markForCheckOnValueUpdate=!1,this._subscribe(t)}finally{this.markForCheckOnValueUpdate=!0}return this._latestValue}return t!==this._obj?(this._dispose(),this.transform(t)):this._latestValue}_subscribe(t){this._obj=t,this._strategy=this._selectStrategy(t),this._subscription=this._strategy.createSubscription(t,i=>this._updateLatestValue(t,i),i=>this.applicationErrorHandler(i))}_selectStrategy(t){if(Fo(t))return CF;if(jf(t))return TF;throw xF(n,t)}_dispose(){this._strategy.dispose(this._subscription),this._latestValue=null,this._subscription=null,this._obj=null}_updateLatestValue(t,i){t===this._obj&&(this._latestValue=i,this.markForCheckOnValueUpdate&&this._ref?.markForCheck())}static \u0275fac=function(i){return new(i||n)(si(Qf,16))};static \u0275pipe=Nv({name:"async",type:n,pure:!1})}return n})();var bl=(()=>{class n{static \u0275fac=function(i){return new(i||n)};static \u0275mod=du({type:n});static \u0275inj=Xa({})}return n})();function qv(n,e){e=encodeURIComponent(e);for(let t of n.split(";")){let i=t.indexOf("="),[r,s]=i==-1?[t,""]:[t.slice(0,i),t.slice(i+1)];if(r.trim()===e)return decodeURIComponent(s)}return null}var xu=class{};var DE="browser";var Cu=class{_doc;constructor(e){this._doc=e}manager},ep=(()=>{class n extends Cu{constructor(t){super(t)}supports(t){return!0}addEventListener(t,i,r,s){return t.addEventListener(i,r,s),()=>this.removeEventListener(t,i,r,s)}removeEventListener(t,i,r,s){return t.removeEventListener(i,r,s)}static \u0275fac=function(i){return new(i||n)(qe(Ui))};static \u0275prov=Ne({token:n,factory:n.\u0275fac})}return n})(),np=new Ue(""),Zv=(()=>{class n{_zone;_plugins;_eventNameToPlugin=new Map;constructor(t,i){this._zone=i,t.forEach(o=>{o.manager=this});let r=t.filter(o=>!(o instanceof ep));this._plugins=r.slice().reverse();let s=t.find(o=>o instanceof ep);s&&this._plugins.push(s)}addEventListener(t,i,r,s){return this._findPluginFor(i).addEventListener(t,i,r,s)}getZone(){return this._zone}_findPluginFor(t){let i=this._eventNameToPlugin.get(t);if(i)return i;if(i=this._plugins.find(s=>s.supports(t)),!i)throw new Le(5101,!1);return this._eventNameToPlugin.set(t,i),i}static \u0275fac=function(i){return new(i||n)(qe(np),qe(Et))};static \u0275prov=Ne({token:n,factory:n.\u0275fac})}return n})(),Yv="ng-app-id";function RE(n){for(let e of n)e.remove()}function PE(n,e){let t=e.createElement("style");return t.textContent=n,t}function AF(n,e,t,i){let r=n.head?.querySelectorAll(`style[${Yv}="${e}"],link[${Yv}="${e}"]`);if(r)for(let s of r)s.removeAttribute(Yv),s instanceof HTMLLinkElement?i.set(s.href.slice(s.href.lastIndexOf("/")+1),{usage:0,elements:[s]}):s.textContent&&t.set(s.textContent,{usage:0,elements:[s]})}function Xv(n,e){let t=e.createElement("link");return t.setAttribute("rel","stylesheet"),t.setAttribute("href",n),t}var Qv=(()=>{class n{doc;appId;nonce;inline=new Map;external=new Map;hosts=new Set;constructor(t,i,r,s={}){this.doc=t,this.appId=i,this.nonce=r,AF(t,i,this.inline,this.external),this.hosts.add(t.head)}addStyles(t,i){for(let r of t)this.addUsage(r,this.inline,PE);i?.forEach(r=>this.addUsage(r,this.external,Xv))}removeStyles(t,i){for(let r of t)this.removeUsage(r,this.inline);i?.forEach(r=>this.removeUsage(r,this.external))}addUsage(t,i,r){let s=i.get(t);s?s.usage++:i.set(t,{usage:1,elements:[...this.hosts].map(o=>this.addElement(o,r(t,this.doc)))})}removeUsage(t,i){let r=i.get(t);r&&(r.usage--,r.usage<=0&&(RE(r.elements),i.delete(t)))}ngOnDestroy(){for(let[,{elements:t}]of[...this.inline,...this.external])RE(t);this.hosts.clear()}addHost(t){this.hosts.add(t);for(let[i,{elements:r}]of this.inline)r.push(this.addElement(t,PE(i,this.doc)));for(let[i,{elements:r}]of this.external)r.push(this.addElement(t,Xv(i,this.doc)))}removeHost(t){this.hosts.delete(t)}addElement(t,i){return this.nonce&&i.setAttribute("nonce",this.nonce),t.appendChild(i)}static \u0275fac=function(i){return new(i||n)(qe(Ui),qe(Nf),qe(Lf,8),qe(lu))};static \u0275prov=Ne({token:n,factory:n.\u0275fac})}return n})(),Kv={svg:"http://www.w3.org/2000/svg",xhtml:"http://www.w3.org/1999/xhtml",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/",math:"http://www.w3.org/1998/Math/MathML"},Jv=/%COMP%/g;var NE="%COMP%",EF=`_nghost-${NE}`,wF=`_ngcontent-${NE}`,MF=!0,DF=new Ue("",{factory:()=>MF});function RF(n){return wF.replace(Jv,n)}function PF(n){return EF.replace(Jv,n)}function FE(n,e){return e.map(t=>t.replace(Jv,n))}var eb=(()=>{class n{eventManager;sharedStylesHost;appId;removeStylesOnCompDestroy;doc;ngZone;nonce;tracingService;rendererByCompId=new Map;defaultRenderer;platformIsServer;constructor(t,i,r,s,o,a,l=null,c=null){this.eventManager=t,this.sharedStylesHost=i,this.appId=r,this.removeStylesOnCompDestroy=s,this.doc=o,this.ngZone=a,this.nonce=l,this.tracingService=c,this.platformIsServer=!1,this.defaultRenderer=new Tu(t,o,a,this.platformIsServer,this.tracingService)}createRenderer(t,i){if(!t||!i)return this.defaultRenderer;let r=this.getOrCreateRenderer(t,i);return r instanceof ip?r.applyToHost(t):r instanceof Su&&r.applyStyles(),r}getOrCreateRenderer(t,i){let r=this.rendererByCompId,s=r.get(i.id);if(!s){let o=this.doc,a=this.ngZone,l=this.eventManager,c=this.sharedStylesHost,u=this.removeStylesOnCompDestroy,h=this.platformIsServer,d=this.tracingService;switch(i.encapsulation){case rr.Emulated:s=new ip(l,c,i,this.appId,u,o,a,h,d);break;case rr.ShadowDom:return new tp(l,t,i,o,a,this.nonce,h,d,c);case rr.ExperimentalIsolatedShadowDom:return new tp(l,t,i,o,a,this.nonce,h,d);default:s=new Su(l,c,i,u,o,a,h,d);break}r.set(i.id,s)}return s}ngOnDestroy(){this.rendererByCompId.clear()}componentReplaced(t){this.rendererByCompId.delete(t)}static \u0275fac=function(i){return new(i||n)(qe(Zv),qe(Qv),qe(Nf),qe(DF),qe(Ui),qe(Et),qe(Lf),qe(cu,8))};static \u0275prov=Ne({token:n,factory:n.\u0275fac})}return n})(),Tu=class{eventManager;doc;ngZone;platformIsServer;tracingService;data=Object.create(null);throwOnSyntheticProps=!0;constructor(e,t,i,r,s){this.eventManager=e,this.doc=t,this.ngZone=i,this.platformIsServer=r,this.tracingService=s}destroy(){}destroyNode=null;createElement(e,t){return t?this.doc.createElementNS(Kv[t]||t,e):this.doc.createElement(e)}createComment(e){return this.doc.createComment(e)}createText(e){return this.doc.createTextNode(e)}appendChild(e,t){(OE(e)?e.content:e).appendChild(t)}insertBefore(e,t,i){e&&(OE(e)?e.content:e).insertBefore(t,i)}removeChild(e,t){t.remove()}selectRootElement(e,t){let i=typeof e=="string"?this.doc.querySelector(e):e;if(!i)throw new Le(-5104,!1);return t||(i.textContent=""),i}parentNode(e){return e.parentNode}nextSibling(e){return e.nextSibling}setAttribute(e,t,i,r){if(r){t=r+":"+t;let s=Kv[r];s?e.setAttributeNS(s,t,i):e.setAttribute(t,i)}else e.setAttribute(t,i)}removeAttribute(e,t,i){if(i){let r=Kv[i];r?e.removeAttributeNS(r,t):e.removeAttribute(`${i}:${t}`)}else e.removeAttribute(t)}addClass(e,t){e.classList.add(t)}removeClass(e,t){e.classList.remove(t)}setStyle(e,t,i,r){r&(Nr.DashCase|Nr.Important)?e.style.setProperty(t,i,r&Nr.Important?"important":""):e.style[t]=i}removeStyle(e,t,i){i&Nr.DashCase?e.style.removeProperty(t):e.style[t]=""}setProperty(e,t,i){e!=null&&(e[t]=i)}setValue(e,t){e.nodeValue=t}listen(e,t,i,r){if(typeof e=="string"&&(e=hs().getGlobalEventTarget(this.doc,e),!e))throw new Le(5102,!1);let s=this.decoratePreventDefault(i);return this.tracingService?.wrapEventListener&&(s=this.tracingService.wrapEventListener(e,t,s)),this.eventManager.addEventListener(e,t,s,r)}decoratePreventDefault(e){return t=>{if(t==="__ngUnwrap__")return e;e(t)===!1&&t.preventDefault()}}};function OE(n){return n.tagName==="TEMPLATE"&&n.content!==void 0}var tp=class extends Tu{hostEl;sharedStylesHost;shadowRoot;constructor(e,t,i,r,s,o,a,l,c){super(e,r,s,a,l),this.hostEl=t,this.sharedStylesHost=c,this.shadowRoot=t.attachShadow({mode:"open"}),this.sharedStylesHost&&this.sharedStylesHost.addHost(this.shadowRoot);let u=i.styles;u=FE(i.id,u);for(let d of u){let f=document.createElement("style");o&&f.setAttribute("nonce",o),f.textContent=d,this.shadowRoot.appendChild(f)}let h=i.getExternalStyles?.();if(h)for(let d of h){let f=Xv(d,r);o&&f.setAttribute("nonce",o),this.shadowRoot.appendChild(f)}}nodeOrShadowRoot(e){return e===this.hostEl?this.shadowRoot:e}appendChild(e,t){return super.appendChild(this.nodeOrShadowRoot(e),t)}insertBefore(e,t,i){return super.insertBefore(this.nodeOrShadowRoot(e),t,i)}removeChild(e,t){return super.removeChild(null,t)}parentNode(e){return this.nodeOrShadowRoot(super.parentNode(this.nodeOrShadowRoot(e)))}destroy(){this.sharedStylesHost&&this.sharedStylesHost.removeHost(this.shadowRoot)}},Su=class extends Tu{sharedStylesHost;removeStylesOnCompDestroy;styles;styleUrls;constructor(e,t,i,r,s,o,a,l,c){super(e,s,o,a,l),this.sharedStylesHost=t,this.removeStylesOnCompDestroy=r;let u=i.styles;this.styles=c?FE(c,u):u,this.styleUrls=i.getExternalStyles?.(c)}applyStyles(){this.sharedStylesHost.addStyles(this.styles,this.styleUrls)}destroy(){this.removeStylesOnCompDestroy&&Do.size===0&&this.sharedStylesHost.removeStyles(this.styles,this.styleUrls)}},ip=class extends Su{contentAttr;hostAttr;constructor(e,t,i,r,s,o,a,l,c){let u=r+"-"+i.id;super(e,t,i,s,o,a,l,c,u),this.contentAttr=RF(u),this.hostAttr=PF(u)}applyToHost(e){this.applyStyles(),this.setAttribute(e,this.hostAttr,"")}createElement(e,t){let i=super.createElement(e,t);return super.setAttribute(i,this.contentAttr,""),i}};var rp=class n extends bu{supportsDOMEvents=!0;static makeCurrent(){zv(new n)}onAndCancel(e,t,i,r){return e.addEventListener(t,i,r),()=>{e.removeEventListener(t,i,r)}}dispatchEvent(e,t){e.dispatchEvent(t)}remove(e){e.remove()}createElement(e,t){return t=t||this.getDefaultDocument(),t.createElement(e)}createHtmlDocument(){return document.implementation.createHTMLDocument("fakeTitle")}getDefaultDocument(){return document}isElementNode(e){return e.nodeType===Node.ELEMENT_NODE}isShadowRoot(e){return e instanceof DocumentFragment}getGlobalEventTarget(e,t){return t==="window"?window:t==="document"?e:t==="body"?e.body:null}getBaseHref(e){let t=OF();return t==null?null:NF(t)}resetBaseElement(){Iu=null}getUserAgent(){return window.navigator.userAgent}getCookie(e){return qv(document.cookie,e)}},Iu=null;function OF(){return Iu=Iu||document.head.querySelector("base"),Iu?Iu.getAttribute("href"):null}function NF(n){return new URL(n,document.baseURI).pathname}var FF=(()=>{class n{build(){return new XMLHttpRequest}static \u0275fac=function(i){return new(i||n)};static \u0275prov=Ne({token:n,factory:n.\u0275fac})}return n})(),LE=["alt","control","meta","shift"],LF={"\b":"Backspace","	":"Tab","\x7F":"Delete","\x1B":"Escape",Del:"Delete",Esc:"Escape",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Down:"ArrowDown",Menu:"ContextMenu",Scroll:"ScrollLock",Win:"OS"},BF={alt:n=>n.altKey,control:n=>n.ctrlKey,meta:n=>n.metaKey,shift:n=>n.shiftKey},BE=(()=>{class n extends Cu{constructor(t){super(t)}supports(t){return n.parseEventName(t)!=null}addEventListener(t,i,r,s){let o=n.parseEventName(i),a=n.eventCallback(o.fullKey,r,this.manager.getZone());return this.manager.getZone().runOutsideAngular(()=>hs().onAndCancel(t,o.domEventName,a,s))}static parseEventName(t){let i=t.toLowerCase().split("."),r=i.shift();if(i.length===0||!(r==="keydown"||r==="keyup"))return null;let s=n._normalizeKey(i.pop()),o="",a=i.indexOf("code");if(a>-1&&(i.splice(a,1),o="code."),LE.forEach(c=>{let u=i.indexOf(c);u>-1&&(i.splice(u,1),o+=c+".")}),o+=s,i.length!=0||s.length===0)return null;let l={};return l.domEventName=r,l.fullKey=o,l}static matchEventFullKeyCode(t,i){let r=LF[t.key]||t.key,s="";return i.indexOf("code.")>-1&&(r=t.code,s="code."),r==null||!r?!1:(r=r.toLowerCase(),r===" "?r="space":r==="."&&(r="dot"),LE.forEach(o=>{if(o!==r){let a=BF[o];a(t)&&(s+=o+".")}}),s+=r,s===i)}static eventCallback(t,i,r){return s=>{n.matchEventFullKeyCode(s,t)&&r.runGuarded(()=>i(s))}}static _normalizeKey(t){return t==="esc"?"escape":t}static \u0275fac=function(i){return new(i||n)(qe(Ui))};static \u0275prov=Ne({token:n,factory:n.\u0275fac})}return n})();function tb(n,e,t){let i=Y({rootComponent:n,platformRef:t?.platformRef},kF(e));return CE(i)}function kF(n){return{appProviders:[...HF,...n?.providers??[]],platformProviders:zF}}function VF(){rp.makeCurrent()}function GF(){return new ss}function UF(){return gv(document),document}var zF=[{provide:lu,useValue:DE},{provide:Ff,useValue:VF,multi:!0},{provide:Ui,useFactory:UF}];var HF=[{provide:Wc,useValue:"root"},{provide:ss,useFactory:GF},{provide:np,useClass:ep,multi:!0},{provide:np,useClass:BE,multi:!0},eb,Qv,Zv,{provide:Ro,useExisting:eb},{provide:xu,useClass:FF},[]];var kE=(()=>{class n{_doc;constructor(t){this._doc=t}getTitle(){return this._doc.title}setTitle(t){this._doc.title=t||""}static \u0275fac=function(i){return new(i||n)(qe(Ui))};static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();var ze="primary",ku=Symbol("RouteTitle"),ob=class{params;constructor(e){this.params=e||{}}has(e){return Object.prototype.hasOwnProperty.call(this.params,e)}get(e){if(this.has(e)){let t=this.params[e];return Array.isArray(t)?t[0]:t}return null}getAll(e){if(this.has(e)){let t=this.params[e];return Array.isArray(t)?t:[t]}return[]}get keys(){return Object.keys(this.params)}};function Go(n){return new ob(n)}function qE(n,e,t){let i=t.path.split("/");if(i.length>n.length||t.pathMatch==="full"&&(e.hasChildren()||i.length<n.length))return null;let r={};for(let s=0;s<i.length;s++){let o=i[s],a=n[s];if(o[0]===":")r[o.substring(1)]=a;else if(o!==a.path)return null}return{consumed:n.slice(0,i.length),posParams:r}}function up(n){return new Promise((e,t)=>{n.pipe(is()).subscribe({next:i=>e(i),error:i=>t(i)})})}function $F(n,e){if(n.length!==e.length)return!1;for(let t=0;t<n.length;++t)if(!kr(n[t],e[t]))return!1;return!0}function kr(n,e){let t=n?ab(n):void 0,i=e?ab(e):void 0;if(!t||!i||t.length!=i.length)return!1;let r;for(let s=0;s<t.length;s++)if(r=t[s],!YE(n[r],e[r]))return!1;return!0}function ab(n){return[...Object.keys(n),...Object.getOwnPropertySymbols(n)]}function YE(n,e){if(Array.isArray(n)&&Array.isArray(e)){if(n.length!==e.length)return!1;let t=[...n].sort(),i=[...e].sort();return t.every((r,s)=>i[s]===r)}else return n===e}function KE(n){return n.length>0?n[n.length-1]:null}function zo(n){return Od(n)?n:Fo(n)?fi(Promise.resolve(n)):et(n)}function XE(n){return Od(n)?up(n):Promise.resolve(n)}var jF={exact:QE,subset:JE},ZE={exact:qF,subset:YF,ignored:()=>!0};function VE(n,e,t){return jF[t.paths](n.root,e.root,t.matrixParams)&&ZE[t.queryParams](n.queryParams,e.queryParams)&&!(t.fragment==="exact"&&n.fragment!==e.fragment)}function qF(n,e){return kr(n,e)}function QE(n,e,t){if(!ko(n.segments,e.segments)||!ap(n.segments,e.segments,t)||n.numberOfChildren!==e.numberOfChildren)return!1;for(let i in e.children)if(!n.children[i]||!QE(n.children[i],e.children[i],t))return!1;return!0}function YF(n,e){return Object.keys(e).length<=Object.keys(n).length&&Object.keys(e).every(t=>YE(n[t],e[t]))}function JE(n,e,t){return ew(n,e,e.segments,t)}function ew(n,e,t,i){if(n.segments.length>t.length){let r=n.segments.slice(0,t.length);return!(!ko(r,t)||e.hasChildren()||!ap(r,t,i))}else if(n.segments.length===t.length){if(!ko(n.segments,t)||!ap(n.segments,t,i))return!1;for(let r in e.children)if(!n.children[r]||!JE(n.children[r],e.children[r],i))return!1;return!0}else{let r=t.slice(0,n.segments.length),s=t.slice(n.segments.length);return!ko(n.segments,r)||!ap(n.segments,r,i)||!n.children[ze]?!1:ew(n.children[ze],e,s,i)}}function ap(n,e,t){return e.every((i,r)=>ZE[t](n[r].parameters,i.parameters))}var lr=class{root;queryParams;fragment;_queryParamMap;constructor(e=new mt([],{}),t={},i=null){this.root=e,this.queryParams=t,this.fragment=i}get queryParamMap(){return this._queryParamMap??=Go(this.queryParams),this._queryParamMap}toString(){return ZF.serialize(this)}},mt=class{segments;children;parent=null;constructor(e,t){this.segments=e,this.children=t,Object.values(t).forEach(i=>i.parent=this)}hasChildren(){return this.numberOfChildren>0}get numberOfChildren(){return Object.keys(this.children).length}toString(){return lp(this)}},$s=class{path;parameters;_parameterMap;constructor(e,t){this.path=e,this.parameters=t}get parameterMap(){return this._parameterMap??=Go(this.parameters),this._parameterMap}toString(){return iw(this)}};function KF(n,e){return ko(n,e)&&n.every((t,i)=>kr(t.parameters,e[i].parameters))}function ko(n,e){return n.length!==e.length?!1:n.every((t,i)=>t.path===e[i].path)}function XF(n,e){let t=[];return Object.entries(n.children).forEach(([i,r])=>{i===ze&&(t=t.concat(e(r,i)))}),Object.entries(n.children).forEach(([i,r])=>{i!==ze&&(t=t.concat(e(r,i)))}),t}var Vu=(()=>{class n{static \u0275fac=function(i){return new(i||n)};static \u0275prov=Ne({token:n,factory:()=>new js,providedIn:"root"})}return n})(),js=class{parse(e){let t=new cb(e);return new lr(t.parseRootSegment(),t.parseQueryParams(),t.parseFragment())}serialize(e){let t=`/${Au(e.root,!0)}`,i=eL(e.queryParams),r=typeof e.fragment=="string"?`#${QF(e.fragment)}`:"";return`${t}${i}${r}`}},ZF=new js;function lp(n){return n.segments.map(e=>iw(e)).join("/")}function Au(n,e){if(!n.hasChildren())return lp(n);if(e){let t=n.children[ze]?Au(n.children[ze],!1):"",i=[];return Object.entries(n.children).forEach(([r,s])=>{r!==ze&&i.push(`${r}:${Au(s,!1)}`)}),i.length>0?`${t}(${i.join("//")})`:t}else{let t=XF(n,(i,r)=>r===ze?[Au(n.children[ze],!1)]:[`${r}:${Au(i,!1)}`]);return Object.keys(n.children).length===1&&n.children[ze]!=null?`${lp(n)}/${t[0]}`:`${lp(n)}/(${t.join("//")})`}}function tw(n){return encodeURIComponent(n).replace(/%40/g,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",")}function sp(n){return tw(n).replace(/%3B/gi,";")}function QF(n){return encodeURI(n)}function lb(n){return tw(n).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/%26/gi,"&")}function cp(n){return decodeURIComponent(n)}function GE(n){return cp(n.replace(/\+/g,"%20"))}function iw(n){return`${lb(n.path)}${JF(n.parameters)}`}function JF(n){return Object.entries(n).map(([e,t])=>`;${lb(e)}=${lb(t)}`).join("")}function eL(n){let e=Object.entries(n).map(([t,i])=>Array.isArray(i)?i.map(r=>`${sp(t)}=${sp(r)}`).join("&"):`${sp(t)}=${sp(i)}`).filter(t=>t);return e.length?`?${e.join("&")}`:""}var tL=/^[^\/()?;#]+/;function ib(n){let e=n.match(tL);return e?e[0]:""}var iL=/^[^\/()?;=#]+/;function nL(n){let e=n.match(iL);return e?e[0]:""}var rL=/^[^=?&#]+/;function sL(n){let e=n.match(rL);return e?e[0]:""}var oL=/^[^&#]+/;function aL(n){let e=n.match(oL);return e?e[0]:""}var cb=class{url;remaining;constructor(e){this.url=e,this.remaining=e}parseRootSegment(){return this.consumeOptional("/"),this.remaining===""||this.peekStartsWith("?")||this.peekStartsWith("#")?new mt([],{}):new mt([],this.parseChildren())}parseQueryParams(){let e={};if(this.consumeOptional("?"))do this.parseQueryParam(e);while(this.consumeOptional("&"));return e}parseFragment(){return this.consumeOptional("#")?decodeURIComponent(this.remaining):null}parseChildren(){if(this.remaining==="")return{};this.consumeOptional("/");let e=[];for(this.peekStartsWith("(")||e.push(this.parseSegment());this.peekStartsWith("/")&&!this.peekStartsWith("//")&&!this.peekStartsWith("/(");)this.capture("/"),e.push(this.parseSegment());let t={};this.peekStartsWith("/(")&&(this.capture("/"),t=this.parseParens(!0));let i={};return this.peekStartsWith("(")&&(i=this.parseParens(!1)),(e.length>0||Object.keys(t).length>0)&&(i[ze]=new mt(e,t)),i}parseSegment(){let e=ib(this.remaining);if(e===""&&this.peekStartsWith(";"))throw new Le(4009,!1);return this.capture(e),new $s(cp(e),this.parseMatrixParams())}parseMatrixParams(){let e={};for(;this.consumeOptional(";");)this.parseParam(e);return e}parseParam(e){let t=nL(this.remaining);if(!t)return;this.capture(t);let i="";if(this.consumeOptional("=")){let r=ib(this.remaining);r&&(i=r,this.capture(i))}e[cp(t)]=cp(i)}parseQueryParam(e){let t=sL(this.remaining);if(!t)return;this.capture(t);let i="";if(this.consumeOptional("=")){let o=aL(this.remaining);o&&(i=o,this.capture(i))}let r=GE(t),s=GE(i);if(e.hasOwnProperty(r)){let o=e[r];Array.isArray(o)||(o=[o],e[r]=o),o.push(s)}else e[r]=s}parseParens(e){let t={};for(this.capture("(");!this.consumeOptional(")")&&this.remaining.length>0;){let i=ib(this.remaining),r=this.remaining[i.length];if(r!=="/"&&r!==")"&&r!==";")throw new Le(4010,!1);let s;i.indexOf(":")>-1?(s=i.slice(0,i.indexOf(":")),this.capture(s),this.capture(":")):e&&(s=ze);let o=this.parseChildren();t[s??ze]=Object.keys(o).length===1&&o[ze]?o[ze]:new mt([],o),this.consumeOptional("//")}return t}peekStartsWith(e){return this.remaining.startsWith(e)}consumeOptional(e){return this.peekStartsWith(e)?(this.remaining=this.remaining.substring(e.length),!0):!1}capture(e){if(!this.consumeOptional(e))throw new Le(4011,!1)}};function nw(n){return n.segments.length>0?new mt([],{[ze]:n}):n}function rw(n){let e={};for(let[i,r]of Object.entries(n.children)){let s=rw(r);if(i===ze&&s.segments.length===0&&s.hasChildren())for(let[o,a]of Object.entries(s.children))e[o]=a;else(s.segments.length>0||s.hasChildren())&&(e[i]=s)}let t=new mt(n.segments,e);return lL(t)}function lL(n){if(n.numberOfChildren===1&&n.children[ze]){let e=n.children[ze];return new mt(n.segments.concat(e.segments),e.children)}return n}function Sl(n){return n instanceof lr}function sw(n,e,t=null,i=null,r=new js){let s=ow(n);return aw(s,e,t,i,r)}function ow(n){let e;function t(s){let o={};for(let l of s.children){let c=t(l);o[l.outlet]=c}let a=new mt(s.url,o);return s===n&&(e=a),a}let i=t(n.root),r=nw(i);return e??r}function aw(n,e,t,i,r){let s=n;for(;s.parent;)s=s.parent;if(e.length===0)return nb(s,s,s,t,i,r);let o=cL(e);if(o.toRoot())return nb(s,s,new mt([],{}),t,i,r);let a=uL(o,s,n),l=a.processChildren?wu(a.segmentGroup,a.index,o.commands):cw(a.segmentGroup,a.index,o.commands);return nb(s,a.segmentGroup,l,t,i,r)}function hp(n){return typeof n=="object"&&n!=null&&!n.outlets&&!n.segmentPath}function Ru(n){return typeof n=="object"&&n!=null&&n.outlets}function UE(n,e,t){n||="\u0275";let i=new lr;return i.queryParams={[n]:e},t.parse(t.serialize(i)).queryParams[n]}function nb(n,e,t,i,r,s){let o={};for(let[c,u]of Object.entries(i??{}))o[c]=Array.isArray(u)?u.map(h=>UE(c,h,s)):UE(c,u,s);let a;n===e?a=t:a=lw(n,e,t);let l=nw(rw(a));return new lr(l,o,r)}function lw(n,e,t){let i={};return Object.entries(n.children).forEach(([r,s])=>{s===e?i[r]=t:i[r]=lw(s,e,t)}),new mt(n.segments,i)}var dp=class{isAbsolute;numberOfDoubleDots;commands;constructor(e,t,i){if(this.isAbsolute=e,this.numberOfDoubleDots=t,this.commands=i,e&&i.length>0&&hp(i[0]))throw new Le(4003,!1);let r=i.find(Ru);if(r&&r!==KE(i))throw new Le(4004,!1)}toRoot(){return this.isAbsolute&&this.commands.length===1&&this.commands[0]=="/"}};function cL(n){if(typeof n[0]=="string"&&n.length===1&&n[0]==="/")return new dp(!0,0,n);let e=0,t=!1,i=n.reduce((r,s,o)=>{if(typeof s=="object"&&s!=null){if(s.outlets){let a={};return Object.entries(s.outlets).forEach(([l,c])=>{a[l]=typeof c=="string"?c.split("/"):c}),[...r,{outlets:a}]}if(s.segmentPath)return[...r,s.segmentPath]}return typeof s!="string"?[...r,s]:o===0?(s.split("/").forEach((a,l)=>{l==0&&a==="."||(l==0&&a===""?t=!0:a===".."?e++:a!=""&&r.push(a))}),r):[...r,s]},[]);return new dp(t,e,i)}var Cl=class{segmentGroup;processChildren;index;constructor(e,t,i){this.segmentGroup=e,this.processChildren=t,this.index=i}};function uL(n,e,t){if(n.isAbsolute)return new Cl(e,!0,0);if(!t)return new Cl(e,!1,NaN);if(t.parent===null)return new Cl(t,!0,0);let i=hp(n.commands[0])?0:1,r=t.segments.length-1+i;return hL(t,r,n.numberOfDoubleDots)}function hL(n,e,t){let i=n,r=e,s=t;for(;s>r;){if(s-=r,i=i.parent,!i)throw new Le(4005,!1);r=i.segments.length}return new Cl(i,!1,r-s)}function dL(n){return Ru(n[0])?n[0].outlets:{[ze]:n}}function cw(n,e,t){if(n??=new mt([],{}),n.segments.length===0&&n.hasChildren())return wu(n,e,t);let i=fL(n,e,t),r=t.slice(i.commandIndex);if(i.match&&i.pathIndex<n.segments.length){let s=new mt(n.segments.slice(0,i.pathIndex),{});return s.children[ze]=new mt(n.segments.slice(i.pathIndex),n.children),wu(s,0,r)}else return i.match&&r.length===0?new mt(n.segments,{}):i.match&&!n.hasChildren()?ub(n,e,t):i.match?wu(n,0,r):ub(n,e,t)}function wu(n,e,t){if(t.length===0)return new mt(n.segments,{});{let i=dL(t),r={};if(Object.keys(i).some(s=>s!==ze)&&n.children[ze]&&n.numberOfChildren===1&&n.children[ze].segments.length===0){let s=wu(n.children[ze],e,t);return new mt(n.segments,s.children)}return Object.entries(i).forEach(([s,o])=>{typeof o=="string"&&(o=[o]),o!==null&&(r[s]=cw(n.children[s],e,o))}),Object.entries(n.children).forEach(([s,o])=>{i[s]===void 0&&(r[s]=o)}),new mt(n.segments,r)}}function fL(n,e,t){let i=0,r=e,s={match:!1,pathIndex:0,commandIndex:0};for(;r<n.segments.length;){if(i>=t.length)return s;let o=n.segments[r],a=t[i];if(Ru(a))break;let l=`${a}`,c=i<t.length-1?t[i+1]:null;if(r>0&&l===void 0)break;if(l&&c&&typeof c=="object"&&c.outlets===void 0){if(!HE(l,c,o))return s;i+=2}else{if(!HE(l,{},o))return s;i++}r++}return{match:!0,pathIndex:r,commandIndex:i}}function ub(n,e,t){let i=n.segments.slice(0,e),r=0;for(;r<t.length;){let s=t[r];if(Ru(s)){let l=pL(s.outlets);return new mt(i,l)}if(r===0&&hp(t[0])){let l=n.segments[e];i.push(new $s(l.path,zE(t[0]))),r++;continue}let o=Ru(s)?s.outlets[ze]:`${s}`,a=r<t.length-1?t[r+1]:null;o&&a&&hp(a)?(i.push(new $s(o,zE(a))),r+=2):(i.push(new $s(o,{})),r++)}return new mt(i,{})}function pL(n){let e={};return Object.entries(n).forEach(([t,i])=>{typeof i=="string"&&(i=[i]),i!==null&&(e[t]=ub(new mt([],{}),0,i))}),e}function zE(n){let e={};return Object.entries(n).forEach(([t,i])=>e[t]=`${i}`),e}function HE(n,e,t){return n==t.path&&kr(e,t.parameters)}var Mu="imperative",mi=(function(n){return n[n.NavigationStart=0]="NavigationStart",n[n.NavigationEnd=1]="NavigationEnd",n[n.NavigationCancel=2]="NavigationCancel",n[n.NavigationError=3]="NavigationError",n[n.RoutesRecognized=4]="RoutesRecognized",n[n.ResolveStart=5]="ResolveStart",n[n.ResolveEnd=6]="ResolveEnd",n[n.GuardsCheckStart=7]="GuardsCheckStart",n[n.GuardsCheckEnd=8]="GuardsCheckEnd",n[n.RouteConfigLoadStart=9]="RouteConfigLoadStart",n[n.RouteConfigLoadEnd=10]="RouteConfigLoadEnd",n[n.ChildActivationStart=11]="ChildActivationStart",n[n.ChildActivationEnd=12]="ChildActivationEnd",n[n.ActivationStart=13]="ActivationStart",n[n.ActivationEnd=14]="ActivationEnd",n[n.Scroll=15]="Scroll",n[n.NavigationSkipped=16]="NavigationSkipped",n})(mi||{}),Sn=class{id;url;constructor(e,t){this.id=e,this.url=t}},Uo=class extends Sn{type=mi.NavigationStart;navigationTrigger;restoredState;constructor(e,t,i="imperative",r=null){super(e,t),this.navigationTrigger=i,this.restoredState=r}toString(){return`NavigationStart(id: ${this.id}, url: '${this.url}')`}},ds=class extends Sn{urlAfterRedirects;type=mi.NavigationEnd;constructor(e,t,i){super(e,t),this.urlAfterRedirects=i}toString(){return`NavigationEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}')`}},zi=(function(n){return n[n.Redirect=0]="Redirect",n[n.SupersededByNewNavigation=1]="SupersededByNewNavigation",n[n.NoDataFromResolver=2]="NoDataFromResolver",n[n.GuardRejected=3]="GuardRejected",n[n.Aborted=4]="Aborted",n})(zi||{}),Pu=(function(n){return n[n.IgnoredSameUrlNavigation=0]="IgnoredSameUrlNavigation",n[n.IgnoredByUrlHandlingStrategy=1]="IgnoredByUrlHandlingStrategy",n})(Pu||{}),Vr=class extends Sn{reason;code;type=mi.NavigationCancel;constructor(e,t,i,r){super(e,t),this.reason=i,this.code=r}toString(){return`NavigationCancel(id: ${this.id}, url: '${this.url}')`}},fs=class extends Sn{reason;code;type=mi.NavigationSkipped;constructor(e,t,i,r){super(e,t),this.reason=i,this.code=r}},Il=class extends Sn{error;target;type=mi.NavigationError;constructor(e,t,i,r){super(e,t),this.error=i,this.target=r}toString(){return`NavigationError(id: ${this.id}, url: '${this.url}', error: ${this.error})`}},Ou=class extends Sn{urlAfterRedirects;state;type=mi.RoutesRecognized;constructor(e,t,i,r){super(e,t),this.urlAfterRedirects=i,this.state=r}toString(){return`RoutesRecognized(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},fp=class extends Sn{urlAfterRedirects;state;type=mi.GuardsCheckStart;constructor(e,t,i,r){super(e,t),this.urlAfterRedirects=i,this.state=r}toString(){return`GuardsCheckStart(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},pp=class extends Sn{urlAfterRedirects;state;shouldActivate;type=mi.GuardsCheckEnd;constructor(e,t,i,r,s){super(e,t),this.urlAfterRedirects=i,this.state=r,this.shouldActivate=s}toString(){return`GuardsCheckEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state}, shouldActivate: ${this.shouldActivate})`}},mp=class extends Sn{urlAfterRedirects;state;type=mi.ResolveStart;constructor(e,t,i,r){super(e,t),this.urlAfterRedirects=i,this.state=r}toString(){return`ResolveStart(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},gp=class extends Sn{urlAfterRedirects;state;type=mi.ResolveEnd;constructor(e,t,i,r){super(e,t),this.urlAfterRedirects=i,this.state=r}toString(){return`ResolveEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},_p=class{route;type=mi.RouteConfigLoadStart;constructor(e){this.route=e}toString(){return`RouteConfigLoadStart(path: ${this.route.path})`}},yp=class{route;type=mi.RouteConfigLoadEnd;constructor(e){this.route=e}toString(){return`RouteConfigLoadEnd(path: ${this.route.path})`}},vp=class{snapshot;type=mi.ChildActivationStart;constructor(e){this.snapshot=e}toString(){return`ChildActivationStart(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},bp=class{snapshot;type=mi.ChildActivationEnd;constructor(e){this.snapshot=e}toString(){return`ChildActivationEnd(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},xp=class{snapshot;type=mi.ActivationStart;constructor(e){this.snapshot=e}toString(){return`ActivationStart(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},Cp=class{snapshot;type=mi.ActivationEnd;constructor(e){this.snapshot=e}toString(){return`ActivationEnd(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}};var Nu=class{},Al=class{url;navigationBehaviorOptions;constructor(e,t){this.url=e,this.navigationBehaviorOptions=t}};function mL(n){return!(n instanceof Nu)&&!(n instanceof Al)}function gL(n,e){return n.providers&&!n._injector&&(n._injector=hu(n.providers,e,`Route: ${n.path}`)),n._injector??e}function ar(n){return n.outlet||ze}function _L(n,e){let t=n.filter(i=>ar(i)===e);return t.push(...n.filter(i=>ar(i)!==e)),t}function Ml(n){if(!n)return null;if(n.routeConfig?._injector)return n.routeConfig._injector;for(let e=n.parent;e;e=e.parent){let t=e.routeConfig;if(t?._loadedInjector)return t._loadedInjector;if(t?._injector)return t._injector}return null}var Tp=class{rootInjector;outlet=null;route=null;children;attachRef=null;get injector(){return Ml(this.route?.snapshot)??this.rootInjector}constructor(e){this.rootInjector=e,this.children=new Dl(this.rootInjector)}},Dl=(()=>{class n{rootInjector;contexts=new Map;constructor(t){this.rootInjector=t}onChildOutletCreated(t,i){let r=this.getOrCreateContext(t);r.outlet=i,this.contexts.set(t,r)}onChildOutletDestroyed(t){let i=this.getContext(t);i&&(i.outlet=null,i.attachRef=null)}onOutletDeactivated(){let t=this.contexts;return this.contexts=new Map,t}onOutletReAttached(t){this.contexts=t}getOrCreateContext(t){let i=this.getContext(t);return i||(i=new Tp(this.rootInjector),this.contexts.set(t,i)),i}getContext(t){return this.contexts.get(t)||null}static \u0275fac=function(i){return new(i||n)(qe(Ai))};static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})(),Sp=class{_root;constructor(e){this._root=e}get root(){return this._root.value}parent(e){let t=this.pathFromRoot(e);return t.length>1?t[t.length-2]:null}children(e){let t=hb(e,this._root);return t?t.children.map(i=>i.value):[]}firstChild(e){let t=hb(e,this._root);return t&&t.children.length>0?t.children[0].value:null}siblings(e){let t=db(e,this._root);return t.length<2?[]:t[t.length-2].children.map(r=>r.value).filter(r=>r!==e)}pathFromRoot(e){return db(e,this._root).map(t=>t.value)}};function hb(n,e){if(n===e.value)return e;for(let t of e.children){let i=hb(n,t);if(i)return i}return null}function db(n,e){if(n===e.value)return[e];for(let t of e.children){let i=db(n,t);if(i.length)return i.unshift(e),i}return[]}var Tn=class{value;children;constructor(e,t){this.value=e,this.children=t}toString(){return`TreeNode(${this.value})`}};function xl(n){let e={};return n&&n.children.forEach(t=>e[t.value.outlet]=t),e}var Fu=class extends Sp{snapshot;constructor(e,t){super(e),this.snapshot=t,yb(this,e)}toString(){return this.snapshot.toString()}};function uw(n){let e=yL(n),t=new Ot([new $s("",{})]),i=new Ot({}),r=new Ot({}),s=new Ot({}),o=new Ot(""),a=new qs(t,i,s,o,r,ze,n,e.root);return a.snapshot=e.root,new Fu(new Tn(a,[]),e)}function yL(n){let e={},t={},i={},s=new Vo([],e,i,"",t,ze,n,null,{});return new Lu("",new Tn(s,[]))}var qs=class{urlSubject;paramsSubject;queryParamsSubject;fragmentSubject;dataSubject;outlet;component;snapshot;_futureSnapshot;_routerState;_paramMap;_queryParamMap;title;url;params;queryParams;fragment;data;constructor(e,t,i,r,s,o,a,l){this.urlSubject=e,this.paramsSubject=t,this.queryParamsSubject=i,this.fragmentSubject=r,this.dataSubject=s,this.outlet=o,this.component=a,this._futureSnapshot=l,this.title=this.dataSubject?.pipe(At(c=>c[ku]))??et(void 0),this.url=e,this.params=t,this.queryParams=i,this.fragment=r,this.data=s}get routeConfig(){return this._futureSnapshot.routeConfig}get root(){return this._routerState.root}get parent(){return this._routerState.parent(this)}get firstChild(){return this._routerState.firstChild(this)}get children(){return this._routerState.children(this)}get pathFromRoot(){return this._routerState.pathFromRoot(this)}get paramMap(){return this._paramMap??=this.params.pipe(At(e=>Go(e))),this._paramMap}get queryParamMap(){return this._queryParamMap??=this.queryParams.pipe(At(e=>Go(e))),this._queryParamMap}toString(){return this.snapshot?this.snapshot.toString():`Future(${this._futureSnapshot})`}};function Ip(n,e,t="emptyOnly"){let i,{routeConfig:r}=n;return e!==null&&(t==="always"||r?.path===""||!e.component&&!e.routeConfig?.loadComponent)?i={params:Y(Y({},e.params),n.params),data:Y(Y({},e.data),n.data),resolve:Y(Y(Y(Y({},n.data),e.data),r?.data),n._resolvedData)}:i={params:Y({},n.params),data:Y({},n.data),resolve:Y(Y({},n.data),n._resolvedData??{})},r&&dw(r)&&(i.resolve[ku]=r.title),i}var Vo=class{url;params;queryParams;fragment;data;outlet;component;routeConfig;_resolve;_resolvedData;_routerState;_paramMap;_queryParamMap;get title(){return this.data?.[ku]}constructor(e,t,i,r,s,o,a,l,c){this.url=e,this.params=t,this.queryParams=i,this.fragment=r,this.data=s,this.outlet=o,this.component=a,this.routeConfig=l,this._resolve=c}get root(){return this._routerState.root}get parent(){return this._routerState.parent(this)}get firstChild(){return this._routerState.firstChild(this)}get children(){return this._routerState.children(this)}get pathFromRoot(){return this._routerState.pathFromRoot(this)}get paramMap(){return this._paramMap??=Go(this.params),this._paramMap}get queryParamMap(){return this._queryParamMap??=Go(this.queryParams),this._queryParamMap}toString(){let e=this.url.map(i=>i.toString()).join("/"),t=this.routeConfig?this.routeConfig.path:"";return`Route(url:'${e}', path:'${t}')`}},Lu=class extends Sp{url;constructor(e,t){super(t),this.url=e,yb(this,t)}toString(){return hw(this._root)}};function yb(n,e){e.value._routerState=n,e.children.forEach(t=>yb(n,t))}function hw(n){let e=n.children.length>0?` { ${n.children.map(hw).join(", ")} } `:"";return`${n.value}${e}`}function rb(n){if(n.snapshot){let e=n.snapshot,t=n._futureSnapshot;n.snapshot=t,kr(e.queryParams,t.queryParams)||n.queryParamsSubject.next(t.queryParams),e.fragment!==t.fragment&&n.fragmentSubject.next(t.fragment),kr(e.params,t.params)||n.paramsSubject.next(t.params),$F(e.url,t.url)||n.urlSubject.next(t.url),kr(e.data,t.data)||n.dataSubject.next(t.data)}else n.snapshot=n._futureSnapshot,n.dataSubject.next(n._futureSnapshot.data)}function fb(n,e){let t=kr(n.params,e.params)&&KF(n.url,e.url),i=!n.parent!=!e.parent;return t&&!i&&(!n.parent||fb(n.parent,e.parent))}function dw(n){return typeof n.title=="string"||n.title===null}var fw=new Ue(""),Gu=(()=>{class n{activated=null;get activatedComponentRef(){return this.activated}_activatedRoute=null;name=ze;activateEvents=new Vi;deactivateEvents=new Vi;attachEvents=new Vi;detachEvents=new Vi;routerOutletData=vE();parentContexts=ue(Dl);location=ue(No);changeDetector=ue(Qf);inputBinder=ue(Mp,{optional:!0});supportsBindingToComponentInputs=!0;ngOnChanges(t){if(t.name){let{firstChange:i,previousValue:r}=t.name;if(i)return;this.isTrackedInParentContexts(r)&&(this.deactivate(),this.parentContexts.onChildOutletDestroyed(r)),this.initializeOutletWithName()}}ngOnDestroy(){this.isTrackedInParentContexts(this.name)&&this.parentContexts.onChildOutletDestroyed(this.name),this.inputBinder?.unsubscribeFromRouteData(this)}isTrackedInParentContexts(t){return this.parentContexts.getContext(t)?.outlet===this}ngOnInit(){this.initializeOutletWithName()}initializeOutletWithName(){if(this.parentContexts.onChildOutletCreated(this.name,this),this.activated)return;let t=this.parentContexts.getContext(this.name);t?.route&&(t.attachRef?this.attach(t.attachRef,t.route):this.activateWith(t.route,t.injector))}get isActivated(){return!!this.activated}get component(){if(!this.activated)throw new Le(4012,!1);return this.activated.instance}get activatedRoute(){if(!this.activated)throw new Le(4012,!1);return this._activatedRoute}get activatedRouteData(){return this._activatedRoute?this._activatedRoute.snapshot.data:{}}detach(){if(!this.activated)throw new Le(4012,!1);this.location.detach();let t=this.activated;return this.activated=null,this._activatedRoute=null,this.detachEvents.emit(t.instance),t}attach(t,i){this.activated=t,this._activatedRoute=i,this.location.insert(t.hostView),this.inputBinder?.bindActivatedRouteToOutletComponent(this),this.attachEvents.emit(t.instance)}deactivate(){if(this.activated){let t=this.component;this.activated.destroy(),this.activated=null,this._activatedRoute=null,this.deactivateEvents.emit(t)}}activateWith(t,i){if(this.isActivated)throw new Le(4013,!1);this._activatedRoute=t;let r=this.location,o=t.snapshot.component,a=this.parentContexts.getOrCreateContext(this.name).children,l=new pb(t,a,r.injector,this.routerOutletData);this.activated=r.createComponent(o,{index:r.length,injector:l,environmentInjector:i}),this.changeDetector.markForCheck(),this.inputBinder?.bindActivatedRouteToOutletComponent(this),this.activateEvents.emit(this.activated.instance)}static \u0275fac=function(i){return new(i||n)};static \u0275dir=$f({type:n,selectors:[["router-outlet"]],inputs:{name:"name",routerOutletData:[1,"routerOutletData"]},outputs:{activateEvents:"activate",deactivateEvents:"deactivate",attachEvents:"attach",detachEvents:"detach"},exportAs:["outlet"],features:[Rf]})}return n})(),pb=class{route;childContexts;parent;outletData;constructor(e,t,i,r){this.route=e,this.childContexts=t,this.parent=i,this.outletData=r}get(e,t){return e===qs?this.route:e===Dl?this.childContexts:e===fw?this.outletData:this.parent.get(e,t)}},Mp=new Ue("");var vb=(()=>{class n{static \u0275fac=function(i){return new(i||n)};static \u0275cmp=sr({type:n,selectors:[["ng-component"]],exportAs:["emptyRouterOutlet"],decls:1,vars:0,template:function(i,r){i&1&&_l(0,"router-outlet")},dependencies:[Gu],encapsulation:2})}return n})();function bb(n){let e=n.children&&n.children.map(bb),t=e?lt(Y({},n),{children:e}):Y({},n);return!t.component&&!t.loadComponent&&(e||t.loadChildren)&&t.outlet&&t.outlet!==ze&&(t.component=vb),t}function vL(n,e,t){let i=Bu(n,e._root,t?t._root:void 0);return new Fu(i,e)}function Bu(n,e,t){if(t&&n.shouldReuseRoute(e.value,t.value.snapshot)){let i=t.value;i._futureSnapshot=e.value;let r=bL(n,e,t);return new Tn(i,r)}else{if(n.shouldAttach(e.value)){let s=n.retrieve(e.value);if(s!==null){let o=s.route;return o.value._futureSnapshot=e.value,o.children=e.children.map(a=>Bu(n,a)),o}}let i=xL(e.value),r=e.children.map(s=>Bu(n,s));return new Tn(i,r)}}function bL(n,e,t){return e.children.map(i=>{for(let r of t.children)if(n.shouldReuseRoute(i.value,r.value.snapshot))return Bu(n,i,r);return Bu(n,i)})}function xL(n){return new qs(new Ot(n.url),new Ot(n.params),new Ot(n.queryParams),new Ot(n.fragment),new Ot(n.data),n.outlet,n.component,n)}var El=class{redirectTo;navigationBehaviorOptions;constructor(e,t){this.redirectTo=e,this.navigationBehaviorOptions=t}},pw="ngNavigationCancelingError";function Ap(n,e){let{redirectTo:t,navigationBehaviorOptions:i}=Sl(e)?{redirectTo:e,navigationBehaviorOptions:void 0}:e,r=mw(!1,zi.Redirect);return r.url=t,r.navigationBehaviorOptions=i,r}function mw(n,e){let t=new Error(`NavigationCancelingError: ${n||""}`);return t[pw]=!0,t.cancellationCode=e,t}function CL(n){return gw(n)&&Sl(n.url)}function gw(n){return!!n&&n[pw]}var TL=(n,e,t,i)=>At(r=>(new mb(e,r.targetRouterState,r.currentRouterState,t,i).activate(n),r)),mb=class{routeReuseStrategy;futureState;currState;forwardEvent;inputBindingEnabled;constructor(e,t,i,r,s){this.routeReuseStrategy=e,this.futureState=t,this.currState=i,this.forwardEvent=r,this.inputBindingEnabled=s}activate(e){let t=this.futureState._root,i=this.currState?this.currState._root:null;this.deactivateChildRoutes(t,i,e),rb(this.futureState.root),this.activateChildRoutes(t,i,e)}deactivateChildRoutes(e,t,i){let r=xl(t);e.children.forEach(s=>{let o=s.value.outlet;this.deactivateRoutes(s,r[o],i),delete r[o]}),Object.values(r).forEach(s=>{this.deactivateRouteAndItsChildren(s,i)})}deactivateRoutes(e,t,i){let r=e.value,s=t?t.value:null;if(r===s)if(r.component){let o=i.getContext(r.outlet);o&&this.deactivateChildRoutes(e,t,o.children)}else this.deactivateChildRoutes(e,t,i);else s&&this.deactivateRouteAndItsChildren(t,i)}deactivateRouteAndItsChildren(e,t){e.value.component&&this.routeReuseStrategy.shouldDetach(e.value.snapshot)?this.detachAndStoreRouteSubtree(e,t):this.deactivateRouteAndOutlet(e,t)}detachAndStoreRouteSubtree(e,t){let i=t.getContext(e.value.outlet),r=i&&e.value.component?i.children:t,s=xl(e);for(let o of Object.values(s))this.deactivateRouteAndItsChildren(o,r);if(i&&i.outlet){let o=i.outlet.detach(),a=i.children.onOutletDeactivated();this.routeReuseStrategy.store(e.value.snapshot,{componentRef:o,route:e,contexts:a})}}deactivateRouteAndOutlet(e,t){let i=t.getContext(e.value.outlet),r=i&&e.value.component?i.children:t,s=xl(e);for(let o of Object.values(s))this.deactivateRouteAndItsChildren(o,r);i&&(i.outlet&&(i.outlet.deactivate(),i.children.onOutletDeactivated()),i.attachRef=null,i.route=null)}activateChildRoutes(e,t,i){let r=xl(t);e.children.forEach(s=>{this.activateRoutes(s,r[s.value.outlet],i),this.forwardEvent(new Cp(s.value.snapshot))}),e.children.length&&this.forwardEvent(new bp(e.value.snapshot))}activateRoutes(e,t,i){let r=e.value,s=t?t.value:null;if(rb(r),r===s)if(r.component){let o=i.getOrCreateContext(r.outlet);this.activateChildRoutes(e,t,o.children)}else this.activateChildRoutes(e,t,i);else if(r.component){let o=i.getOrCreateContext(r.outlet);if(this.routeReuseStrategy.shouldAttach(r.snapshot)){let a=this.routeReuseStrategy.retrieve(r.snapshot);this.routeReuseStrategy.store(r.snapshot,null),o.children.onOutletReAttached(a.contexts),o.attachRef=a.componentRef,o.route=a.route.value,o.outlet&&o.outlet.attach(a.componentRef,a.route.value),rb(a.route.value),this.activateChildRoutes(e,null,o.children)}else o.attachRef=null,o.route=r,o.outlet&&o.outlet.activateWith(r,o.injector),this.activateChildRoutes(e,null,o.children)}else this.activateChildRoutes(e,null,i)}},Ep=class{path;route;constructor(e){this.path=e,this.route=this.path[this.path.length-1]}},Tl=class{component;route;constructor(e,t){this.component=e,this.route=t}};function SL(n,e,t){let i=n._root,r=e?e._root:null;return Eu(i,r,t,[i.value])}function IL(n){let e=n.routeConfig?n.routeConfig.canActivateChild:null;return!e||e.length===0?null:{node:n,guards:e}}function Rl(n,e){let t=Symbol(),i=e.get(n,t);return i===t?typeof n=="function"&&!j_(n)?n:e.get(n):i}function Eu(n,e,t,i,r={canDeactivateChecks:[],canActivateChecks:[]}){let s=xl(e);return n.children.forEach(o=>{AL(o,s[o.value.outlet],t,i.concat([o.value]),r),delete s[o.value.outlet]}),Object.entries(s).forEach(([o,a])=>Du(a,t.getContext(o),r)),r}function AL(n,e,t,i,r={canDeactivateChecks:[],canActivateChecks:[]}){let s=n.value,o=e?e.value:null,a=t?t.getContext(n.value.outlet):null;if(o&&s.routeConfig===o.routeConfig){let l=EL(o,s,s.routeConfig.runGuardsAndResolvers);l?r.canActivateChecks.push(new Ep(i)):(s.data=o.data,s._resolvedData=o._resolvedData),s.component?Eu(n,e,a?a.children:null,i,r):Eu(n,e,t,i,r),l&&a&&a.outlet&&a.outlet.isActivated&&r.canDeactivateChecks.push(new Tl(a.outlet.component,o))}else o&&Du(e,a,r),r.canActivateChecks.push(new Ep(i)),s.component?Eu(n,null,a?a.children:null,i,r):Eu(n,null,t,i,r);return r}function EL(n,e,t){if(typeof t=="function")return t(n,e);switch(t){case"pathParamsChange":return!ko(n.url,e.url);case"pathParamsOrQueryParamsChange":return!ko(n.url,e.url)||!kr(n.queryParams,e.queryParams);case"always":return!0;case"paramsOrQueryParamsChange":return!fb(n,e)||!kr(n.queryParams,e.queryParams);case"paramsChange":default:return!fb(n,e)}}function Du(n,e,t){let i=xl(n),r=n.value;Object.entries(i).forEach(([s,o])=>{r.component?e?Du(o,e.children.getContext(s),t):Du(o,null,t):Du(o,e,t)}),r.component?e&&e.outlet&&e.outlet.isActivated?t.canDeactivateChecks.push(new Tl(e.outlet.component,r)):t.canDeactivateChecks.push(new Tl(null,r)):t.canDeactivateChecks.push(new Tl(null,r))}function Uu(n){return typeof n=="function"}function wL(n){return typeof n=="boolean"}function ML(n){return n&&Uu(n.canLoad)}function DL(n){return n&&Uu(n.canActivate)}function RL(n){return n&&Uu(n.canActivateChild)}function PL(n){return n&&Uu(n.canDeactivate)}function OL(n){return n&&Uu(n.canMatch)}function _w(n){return n instanceof po||n?.name==="EmptyError"}var op=Symbol("INITIAL_VALUE");function wl(){return Ir(n=>S_(n.map(e=>e.pipe(Bn(1),w_(op)))).pipe(At(e=>{for(let t of e)if(t!==!0){if(t===op)return op;if(t===!1||NL(t))return t}return!0}),Sr(e=>e!==op),Bn(1)))}function NL(n){return Sl(n)||n instanceof El}function yw(n){return n.aborted?et(void 0).pipe(Bn(1)):new ct(e=>{let t=()=>{e.next(),e.complete()};return n.addEventListener("abort",t),()=>n.removeEventListener("abort",t)})}function vw(n){return Lc(yw(n))}function FL(n,e){return bi(t=>{let{targetSnapshot:i,currentSnapshot:r,guards:{canActivateChecks:s,canDeactivateChecks:o}}=t;return o.length===0&&s.length===0?et(lt(Y({},t),{guardsResult:!0})):LL(o,i,r,n).pipe(bi(a=>a&&wL(a)?BL(i,s,n,e):et(a)),At(a=>lt(Y({},t),{guardsResult:a})))})}function LL(n,e,t,i){return fi(n).pipe(bi(r=>zL(r.component,r.route,t,e,i)),is(r=>r!==!0,!0))}function BL(n,e,t,i){return fi(e).pipe(mo(r=>Rs(VL(r.route.parent,i),kL(r.route,i),UL(n,r.path,t),GL(n,r.route,t))),is(r=>r!==!0,!0))}function kL(n,e){return n!==null&&e&&e(new xp(n)),et(!0)}function VL(n,e){return n!==null&&e&&e(new vp(n)),et(!0)}function GL(n,e,t){let i=e.routeConfig?e.routeConfig.canActivate:null;if(!i||i.length===0)return et(!0);let r=i.map(s=>Nc(()=>{let o=Ml(e)??t,a=Rl(s,o),l=DL(a)?a.canActivate(e,n):Gi(o,()=>a(e,n));return zo(l).pipe(is())}));return et(r).pipe(wl())}function UL(n,e,t){let i=e[e.length-1],s=e.slice(0,e.length-1).reverse().map(o=>IL(o)).filter(o=>o!==null).map(o=>Nc(()=>{let a=o.guards.map(l=>{let c=Ml(o.node)??t,u=Rl(l,c),h=RL(u)?u.canActivateChild(i,n):Gi(c,()=>u(i,n));return zo(h).pipe(is())});return et(a).pipe(wl())}));return et(s).pipe(wl())}function zL(n,e,t,i,r){let s=e&&e.routeConfig?e.routeConfig.canDeactivate:null;if(!s||s.length===0)return et(!0);let o=s.map(a=>{let l=Ml(e)??r,c=Rl(a,l),u=PL(c)?c.canDeactivate(n,e,t,i):Gi(l,()=>c(n,e,t,i));return zo(u).pipe(is())});return et(o).pipe(wl())}function HL(n,e,t,i,r){let s=e.canLoad;if(s===void 0||s.length===0)return et(!0);let o=s.map(a=>{let l=Rl(a,n),c=ML(l)?l.canLoad(e,t):Gi(n,()=>l(e,t)),u=zo(c);return r?u.pipe(vw(r)):u});return et(o).pipe(wl(),bw(i))}function bw(n){return y_(pi(e=>{if(typeof e!="boolean")throw Ap(n,e)}),At(e=>e===!0))}function WL(n,e,t,i,r){let s=e.canMatch;if(!s||s.length===0)return et(!0);let o=s.map(a=>{let l=Rl(a,n),c=OL(l)?l.canMatch(e,t):Gi(n,()=>l(e,t)),u=zo(c);return r?u.pipe(vw(r)):u});return et(o).pipe(wl(),bw(i))}var Bo=class xw extends Error{segmentGroup;constructor(e){super(),this.segmentGroup=e||null,Object.setPrototypeOf(this,xw.prototype)}},gb=class Cw extends Error{urlTree;constructor(e){super(),this.urlTree=e,Object.setPrototypeOf(this,Cw.prototype)}};function $L(n){throw new Le(4e3,!1)}function jL(n){throw mw(!1,zi.GuardRejected)}var qL=class{urlSerializer;urlTree;constructor(e,t){this.urlSerializer=e,this.urlTree=t}lineralizeSegments(e,t){return S(this,null,function*(){let i=[],r=t.root;for(;;){if(i=i.concat(r.segments),r.numberOfChildren===0)return i;if(r.numberOfChildren>1||!r.children[ze])throw $L(`${e.redirectTo}`);r=r.children[ze]}})}applyRedirectCommands(e,t,i,r,s){return S(this,null,function*(){let o=yield YL(t,r,s);if(o instanceof lr)throw new gb(o);let a=this.applyRedirectCreateUrlTree(o,this.urlSerializer.parse(o),e,i);if(o[0]==="/")throw new gb(a);return a})}applyRedirectCreateUrlTree(e,t,i,r){let s=this.createSegmentGroup(e,t.root,i,r);return new lr(s,this.createQueryParams(t.queryParams,this.urlTree.queryParams),t.fragment)}createQueryParams(e,t){let i={};return Object.entries(e).forEach(([r,s])=>{if(typeof s=="string"&&s[0]===":"){let a=s.substring(1);i[r]=t[a]}else i[r]=s}),i}createSegmentGroup(e,t,i,r){let s=this.createSegments(e,t.segments,i,r),o={};return Object.entries(t.children).forEach(([a,l])=>{o[a]=this.createSegmentGroup(e,l,i,r)}),new mt(s,o)}createSegments(e,t,i,r){return t.map(s=>s.path[0]===":"?this.findPosParam(e,s,r):this.findOrReturn(s,i))}findPosParam(e,t,i){let r=i[t.path.substring(1)];if(!r)throw new Le(4001,!1);return r}findOrReturn(e,t){let i=0;for(let r of t){if(r.path===e.path)return t.splice(i),r;i++}return e}};function YL(n,e,t){if(typeof n=="string")return Promise.resolve(n);let i=n,{queryParams:r,fragment:s,routeConfig:o,url:a,outlet:l,params:c,data:u,title:h}=e;return up(zo(Gi(t,()=>i({params:c,data:u,queryParams:r,fragment:s,routeConfig:o,url:a,outlet:l,title:h}))))}var _b={matched:!1,consumedSegments:[],remainingSegments:[],parameters:{},positionalParamSegments:{}};function KL(n,e,t,i,r,s){let o=Tw(n,e,t);return o.matched?(i=gL(e,i),WL(i,e,t,r,s).pipe(At(a=>a===!0?o:Y({},_b)))):et(o)}function Tw(n,e,t){if(e.path==="**")return XL(t);if(e.path==="")return e.pathMatch==="full"&&(n.hasChildren()||t.length>0)?Y({},_b):{matched:!0,consumedSegments:[],remainingSegments:t,parameters:{},positionalParamSegments:{}};let r=(e.matcher||qE)(t,n,e);if(!r)return Y({},_b);let s={};Object.entries(r.posParams??{}).forEach(([a,l])=>{s[a]=l.path});let o=r.consumed.length>0?Y(Y({},s),r.consumed[r.consumed.length-1].parameters):s;return{matched:!0,consumedSegments:r.consumed,remainingSegments:t.slice(r.consumed.length),parameters:o,positionalParamSegments:r.posParams??{}}}function XL(n){return{matched:!0,parameters:n.length>0?KE(n).parameters:{},consumedSegments:n,remainingSegments:[],positionalParamSegments:{}}}function WE(n,e,t,i){return t.length>0&&JL(n,t,i)?{segmentGroup:new mt(e,QL(i,new mt(t,n.children))),slicedSegments:[]}:t.length===0&&eB(n,t,i)?{segmentGroup:new mt(n.segments,ZL(n,t,i,n.children)),slicedSegments:t}:{segmentGroup:new mt(n.segments,n.children),slicedSegments:t}}function ZL(n,e,t,i){let r={};for(let s of t)if(Dp(n,e,s)&&!i[ar(s)]){let o=new mt([],{});r[ar(s)]=o}return Y(Y({},i),r)}function QL(n,e){let t={};t[ze]=e;for(let i of n)if(i.path===""&&ar(i)!==ze){let r=new mt([],{});t[ar(i)]=r}return t}function JL(n,e,t){return t.some(i=>Dp(n,e,i)&&ar(i)!==ze)}function eB(n,e,t){return t.some(i=>Dp(n,e,i))}function Dp(n,e,t){return(n.hasChildren()||e.length>0)&&t.pathMatch==="full"?!1:t.path===""}function tB(n,e,t){return e.length===0&&!n.children[t]}var iB=class{};function nB(n,e,t,i,r,s,o="emptyOnly",a){return S(this,null,function*(){return new sB(n,e,t,i,r,o,s,a).recognize()})}var rB=31,sB=class{injector;configLoader;rootComponentType;config;urlTree;paramsInheritanceStrategy;urlSerializer;abortSignal;applyRedirects;absoluteRedirectCount=0;allowRedirects=!0;constructor(e,t,i,r,s,o,a,l){this.injector=e,this.configLoader=t,this.rootComponentType=i,this.config=r,this.urlTree=s,this.paramsInheritanceStrategy=o,this.urlSerializer=a,this.abortSignal=l,this.applyRedirects=new qL(this.urlSerializer,this.urlTree)}noMatchError(e){return new Le(4002,`'${e.segmentGroup}'`)}recognize(){return S(this,null,function*(){let e=WE(this.urlTree.root,[],[],this.config).segmentGroup,{children:t,rootSnapshot:i}=yield this.match(e),r=new Tn(i,t),s=new Lu("",r),o=sw(i,[],this.urlTree.queryParams,this.urlTree.fragment);return o.queryParams=this.urlTree.queryParams,s.url=this.urlSerializer.serialize(o),{state:s,tree:o}})}match(e){return S(this,null,function*(){let t=new Vo([],Object.freeze({}),Object.freeze(Y({},this.urlTree.queryParams)),this.urlTree.fragment,Object.freeze({}),ze,this.rootComponentType,null,{});try{return{children:yield this.processSegmentGroup(this.injector,this.config,e,ze,t),rootSnapshot:t}}catch(i){if(i instanceof gb)return this.urlTree=i.urlTree,this.match(i.urlTree.root);throw i instanceof Bo?this.noMatchError(i):i}})}processSegmentGroup(e,t,i,r,s){return S(this,null,function*(){if(i.segments.length===0&&i.hasChildren())return this.processChildren(e,t,i,s);let o=yield this.processSegment(e,t,i,i.segments,r,!0,s);return o instanceof Tn?[o]:[]})}processChildren(e,t,i,r){return S(this,null,function*(){let s=[];for(let l of Object.keys(i.children))l==="primary"?s.unshift(l):s.push(l);let o=[];for(let l of s){let c=i.children[l],u=_L(t,l),h=yield this.processSegmentGroup(e,u,c,l,r);o.push(...h)}let a=Sw(o);return oB(a),a})}processSegment(e,t,i,r,s,o,a){return S(this,null,function*(){for(let l of t)try{return yield this.processSegmentAgainstRoute(l._injector??e,t,l,i,r,s,o,a)}catch(c){if(c instanceof Bo||_w(c))continue;throw c}if(tB(i,r,s))return new iB;throw new Bo(i)})}processSegmentAgainstRoute(e,t,i,r,s,o,a,l){return S(this,null,function*(){if(ar(i)!==o&&(o===ze||!Dp(r,s,i)))throw new Bo(r);if(i.redirectTo===void 0)return this.matchSegmentAgainstRoute(e,r,i,s,o,l);if(this.allowRedirects&&a)return this.expandSegmentAgainstRouteUsingRedirect(e,r,t,i,s,o,l);throw new Bo(r)})}expandSegmentAgainstRouteUsingRedirect(e,t,i,r,s,o,a){return S(this,null,function*(){let{matched:l,parameters:c,consumedSegments:u,positionalParamSegments:h,remainingSegments:d}=Tw(t,r,s);if(!l)throw new Bo(t);typeof r.redirectTo=="string"&&r.redirectTo[0]==="/"&&(this.absoluteRedirectCount++,this.absoluteRedirectCount>rB&&(this.allowRedirects=!1));let f=new Vo(s,c,Object.freeze(Y({},this.urlTree.queryParams)),this.urlTree.fragment,$E(r),ar(r),r.component??r._loadedComponent??null,r,jE(r)),p=Ip(f,a,this.paramsInheritanceStrategy);if(f.params=Object.freeze(p.params),f.data=Object.freeze(p.data),this.abortSignal.aborted)throw new Error(this.abortSignal.reason);let g=yield this.applyRedirects.applyRedirectCommands(u,r.redirectTo,h,f,e),_=yield this.applyRedirects.lineralizeSegments(r,g);return this.processSegment(e,i,t,_.concat(d),o,!1,a)})}matchSegmentAgainstRoute(e,t,i,r,s,o){return S(this,null,function*(){if(this.abortSignal.aborted)throw new Error(this.abortSignal.reason);let a=yield up(KL(t,i,r,e,this.urlSerializer,this.abortSignal));if(i.path==="**"&&(t.children={}),!a?.matched)throw new Bo(t);e=i._injector??e;let{routes:l}=yield this.getChildConfig(e,i,r),c=i._loadedInjector??e,{parameters:u,consumedSegments:h,remainingSegments:d}=a,f=new Vo(h,u,Object.freeze(Y({},this.urlTree.queryParams)),this.urlTree.fragment,$E(i),ar(i),i.component??i._loadedComponent??null,i,jE(i)),p=Ip(f,o,this.paramsInheritanceStrategy);f.params=Object.freeze(p.params),f.data=Object.freeze(p.data);let{segmentGroup:g,slicedSegments:_}=WE(t,h,d,l);if(_.length===0&&g.hasChildren()){let A=yield this.processChildren(c,l,g,f);return new Tn(f,A)}if(l.length===0&&_.length===0)return new Tn(f,[]);let y=ar(i)===s,b=yield this.processSegment(c,l,g,_,y?ze:s,!0,f);return new Tn(f,b instanceof Tn?[b]:[])})}getChildConfig(e,t,i){return S(this,null,function*(){if(t.children)return{routes:t.children,injector:e};if(t.loadChildren){if(t._loadedRoutes!==void 0)return{routes:t._loadedRoutes,injector:t._loadedInjector};if(this.abortSignal.aborted)throw new Error(this.abortSignal.reason);if(yield up(HL(e,t,i,this.urlSerializer,this.abortSignal))){let s=yield this.configLoader.loadChildren(e,t);return t._loadedRoutes=s.routes,t._loadedInjector=s.injector,s}throw jL(t)}return{routes:[],injector:e}})}};function oB(n){n.sort((e,t)=>e.value.outlet===ze?-1:t.value.outlet===ze?1:e.value.outlet.localeCompare(t.value.outlet))}function aB(n){let e=n.value.routeConfig;return e&&e.path===""}function Sw(n){let e=[],t=new Set;for(let i of n){if(!aB(i)){e.push(i);continue}let r=e.find(s=>i.value.routeConfig===s.value.routeConfig);r!==void 0?(r.children.push(...i.children),t.add(r)):e.push(i)}for(let i of t){let r=Sw(i.children);e.push(new Tn(i.value,r))}return e.filter(i=>!t.has(i))}function $E(n){return n.data||{}}function jE(n){return n.resolve||{}}var lB=new Ue("",{factory:()=>nB});function cB(n,e,t,i,r,s,o){let a=n.get(lB);return bi(l=>et(l).pipe(Ir(c=>a(n,e,t,i,c.extractedUrl,r,s,o)),At(({state:c,tree:u})=>lt(Y({},l),{targetSnapshot:c,urlAfterRedirects:u}))))}function uB(n,e){return bi(t=>{let{targetSnapshot:i,guards:{canActivateChecks:r}}=t;if(!r.length)return et(t);let s=new Set(r.map(l=>l.route)),o=new Set;for(let l of s)if(!o.has(l))for(let c of Iw(l))o.add(c);let a=0;return fi(o).pipe(mo(l=>s.has(l)?hB(l,i,n,e):(l.data=Ip(l,l.parent,n).resolve,et(void 0))),pi(()=>a++),Fd(1),bi(l=>a===o.size?et(t):Ji))})}function Iw(n){let e=n.children.map(t=>Iw(t)).flat();return[n,...e]}function hB(n,e,t,i){let r=n.routeConfig,s=n._resolve;return r?.title!==void 0&&!dw(r)&&(s[ku]=r.title),Nc(()=>(n.data=Ip(n,n.parent,t).resolve,dB(s,n,e,i).pipe(At(o=>(n._resolvedData=o,n.data=Y(Y({},n.data),o),null)))))}function dB(n,e,t,i){let r=ab(n);if(r.length===0)return et({});let s={};return fi(r).pipe(bi(o=>fB(n[o],e,t,i).pipe(is(),pi(a=>{if(a instanceof El)throw Ap(new js,a);s[o]=a}))),Fd(1),At(()=>s),Fc(o=>_w(o)?Ji:T_(o)))}function fB(n,e,t,i){let r=Ml(e)??i,s=Rl(n,r),o=s.resolve?s.resolve(e,t):Gi(r,()=>s(e,t));return zo(o)}function sb(n){return Ir(e=>{let t=n(e);return t?fi(t).pipe(At(()=>e)):et(e)})}var xb=(()=>{class n{buildTitle(t){let i,r=t.root;for(;r!==void 0;)i=this.getResolvedTitleForRoute(r)??i,r=r.children.find(s=>s.outlet===ze);return i}getResolvedTitleForRoute(t){return t.data[ku]}static \u0275fac=function(i){return new(i||n)};static \u0275prov=Ne({token:n,factory:()=>ue(Aw),providedIn:"root"})}return n})(),Aw=(()=>{class n extends xb{title;constructor(t){super(),this.title=t}updateTitle(t){let i=this.buildTitle(t);i!==void 0&&this.title.setTitle(i)}static \u0275fac=function(i){return new(i||n)(qe(kE))};static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})(),zu=new Ue("",{factory:()=>({})}),Hu=new Ue(""),Ew=(()=>{class n{componentLoaders=new WeakMap;childrenLoaders=new WeakMap;onLoadStartListener;onLoadEndListener;compiler=ue(Gv);loadComponent(t,i){return S(this,null,function*(){if(this.componentLoaders.get(i))return this.componentLoaders.get(i);if(i._loadedComponent)return Promise.resolve(i._loadedComponent);this.onLoadStartListener&&this.onLoadStartListener(i);let r=S(this,null,function*(){try{let s=yield XE(Gi(t,()=>i.loadComponent())),o=yield Dw(Mw(s));return this.onLoadEndListener&&this.onLoadEndListener(i),i._loadedComponent=o,o}finally{this.componentLoaders.delete(i)}});return this.componentLoaders.set(i,r),r})}loadChildren(t,i){if(this.childrenLoaders.get(i))return this.childrenLoaders.get(i);if(i._loadedRoutes)return Promise.resolve({routes:i._loadedRoutes,injector:i._loadedInjector});this.onLoadStartListener&&this.onLoadStartListener(i);let r=S(this,null,function*(){try{let s=yield ww(i,this.compiler,t,this.onLoadEndListener);return i._loadedRoutes=s.routes,i._loadedInjector=s.injector,s}finally{this.childrenLoaders.delete(i)}});return this.childrenLoaders.set(i,r),r}static \u0275fac=function(i){return new(i||n)};static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();function ww(n,e,t,i){return S(this,null,function*(){let r=yield XE(Gi(t,()=>n.loadChildren())),s=yield Dw(Mw(r)),o;s instanceof Wf||Array.isArray(s)?o=s:o=yield e.compileModuleAsync(s),i&&i(n);let a,l,c=!1;return Array.isArray(o)?(l=o,c=!0):(a=o.create(t).injector,l=a.get(Hu,[],{optional:!0,self:!0}).flat()),{routes:l.map(bb),injector:a}})}function pB(n){return n&&typeof n=="object"&&"default"in n}function Mw(n){return pB(n)?n.default:n}function Dw(n){return S(this,null,function*(){return n})}var Rp=(()=>{class n{static \u0275fac=function(i){return new(i||n)};static \u0275prov=Ne({token:n,factory:()=>ue(mB),providedIn:"root"})}return n})(),mB=(()=>{class n{shouldProcessUrl(t){return!0}extract(t){return t}merge(t,i){return t}static \u0275fac=function(i){return new(i||n)};static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})(),Rw=new Ue("");var gB=()=>{},Pw=new Ue(""),Ow=(()=>{class n{currentNavigation=nn(null,{equal:()=>!1});currentTransition=null;lastSuccessfulNavigation=nn(null);events=new ti;transitionAbortWithErrorSubject=new ti;configLoader=ue(Ew);environmentInjector=ue(Ai);destroyRef=ue(ol);urlSerializer=ue(Vu);rootContexts=ue(Dl);location=ue(vl);inputBindingEnabled=ue(Mp,{optional:!0})!==null;titleStrategy=ue(xb);options=ue(zu,{optional:!0})||{};paramsInheritanceStrategy=this.options.paramsInheritanceStrategy||"emptyOnly";urlHandlingStrategy=ue(Rp);createViewTransition=ue(Rw,{optional:!0});navigationErrorHandler=ue(Pw,{optional:!0});navigationId=0;get hasRequestedNavigation(){return this.navigationId!==0}transitions;afterPreactivation=()=>et(void 0);rootComponentType=null;destroyed=!1;constructor(){let t=r=>this.events.next(new _p(r)),i=r=>this.events.next(new yp(r));this.configLoader.onLoadEndListener=i,this.configLoader.onLoadStartListener=t,this.destroyRef.onDestroy(()=>{this.destroyed=!0})}complete(){this.transitions?.complete()}handleNavigationRequest(t){let i=++this.navigationId;Hn(()=>{this.transitions?.next(lt(Y({},t),{extractedUrl:this.urlHandlingStrategy.extract(t.rawUrl),targetSnapshot:null,targetRouterState:null,guards:{canActivateChecks:[],canDeactivateChecks:[]},guardsResult:null,id:i}))})}setupNavigations(t){return this.transitions=new Ot(null),this.transitions.pipe(Sr(i=>i!==null),Ir(i=>{let r=!1,s=new AbortController;return et(i).pipe(Ir(o=>{if(this.navigationId>i.id)return this.cancelNavigationTransition(i,"",zi.SupersededByNewNavigation),Ji;this.currentTransition=i;let a=this.lastSuccessfulNavigation();this.currentNavigation.set({id:o.id,initialUrl:o.rawUrl,extractedUrl:o.extractedUrl,targetBrowserUrl:typeof o.extras.browserUrl=="string"?this.urlSerializer.parse(o.extras.browserUrl):o.extras.browserUrl,trigger:o.source,extras:o.extras,previousNavigation:a?lt(Y({},a),{previousNavigation:null}):null,abort:()=>s.abort()});let l=!t.navigated||this.isUpdatingInternalState()||this.isUpdatedBrowserUrl(),c=o.extras.onSameUrlNavigation??t.onSameUrlNavigation;if(!l&&c!=="reload")return this.events.next(new fs(o.id,this.urlSerializer.serialize(o.rawUrl),"",Pu.IgnoredSameUrlNavigation)),o.resolve(!1),Ji;if(this.urlHandlingStrategy.shouldProcessUrl(o.rawUrl))return et(o).pipe(Ir(u=>(this.events.next(new Uo(u.id,this.urlSerializer.serialize(u.extractedUrl),u.source,u.restoredState)),u.id!==this.navigationId?Ji:Promise.resolve(u))),cB(this.environmentInjector,this.configLoader,this.rootComponentType,t.config,this.urlSerializer,this.paramsInheritanceStrategy,s.signal),pi(u=>{i.targetSnapshot=u.targetSnapshot,i.urlAfterRedirects=u.urlAfterRedirects,this.currentNavigation.update(d=>(d.finalUrl=u.urlAfterRedirects,d));let h=new Ou(u.id,this.urlSerializer.serialize(u.extractedUrl),this.urlSerializer.serialize(u.urlAfterRedirects),u.targetSnapshot);this.events.next(h)}));if(l&&this.urlHandlingStrategy.shouldProcessUrl(o.currentRawUrl)){let{id:u,extractedUrl:h,source:d,restoredState:f,extras:p}=o,g=new Uo(u,this.urlSerializer.serialize(h),d,f);this.events.next(g);let _=uw(this.rootComponentType).snapshot;return this.currentTransition=i=lt(Y({},o),{targetSnapshot:_,urlAfterRedirects:h,extras:lt(Y({},p),{skipLocationChange:!1,replaceUrl:!1})}),this.currentNavigation.update(y=>(y.finalUrl=h,y)),et(i)}else return this.events.next(new fs(o.id,this.urlSerializer.serialize(o.extractedUrl),"",Pu.IgnoredByUrlHandlingStrategy)),o.resolve(!1),Ji}),pi(o=>{let a=new fp(o.id,this.urlSerializer.serialize(o.extractedUrl),this.urlSerializer.serialize(o.urlAfterRedirects),o.targetSnapshot);this.events.next(a)}),At(o=>(this.currentTransition=i=lt(Y({},o),{guards:SL(o.targetSnapshot,o.currentSnapshot,this.rootContexts)}),i)),FL(this.environmentInjector,o=>this.events.next(o)),pi(o=>{if(i.guardsResult=o.guardsResult,o.guardsResult&&typeof o.guardsResult!="boolean")throw Ap(this.urlSerializer,o.guardsResult);let a=new pp(o.id,this.urlSerializer.serialize(o.extractedUrl),this.urlSerializer.serialize(o.urlAfterRedirects),o.targetSnapshot,!!o.guardsResult);this.events.next(a)}),Sr(o=>o.guardsResult?!0:(this.cancelNavigationTransition(o,"",zi.GuardRejected),!1)),sb(o=>{if(o.guards.canActivateChecks.length!==0)return et(o).pipe(pi(a=>{let l=new mp(a.id,this.urlSerializer.serialize(a.extractedUrl),this.urlSerializer.serialize(a.urlAfterRedirects),a.targetSnapshot);this.events.next(l)}),Ir(a=>{let l=!1;return et(a).pipe(uB(this.paramsInheritanceStrategy,this.environmentInjector),pi({next:()=>l=!0,complete:()=>{l||this.cancelNavigationTransition(a,"",zi.NoDataFromResolver)}}))}),pi(a=>{let l=new gp(a.id,this.urlSerializer.serialize(a.extractedUrl),this.urlSerializer.serialize(a.urlAfterRedirects),a.targetSnapshot);this.events.next(l)}))}),sb(o=>{let a=c=>{let u=[];if(c.routeConfig?._loadedComponent)c.component=c.routeConfig?._loadedComponent;else if(c.routeConfig?.loadComponent){let h=Ml(c)??this.environmentInjector;u.push(this.configLoader.loadComponent(h,c.routeConfig).then(d=>{c.component=d}))}for(let h of c.children)u.push(...a(h));return u},l=a(o.targetSnapshot.root);return l.length===0?et(o):fi(Promise.all(l).then(()=>o))}),sb(()=>this.afterPreactivation()),Ir(()=>{let{currentSnapshot:o,targetSnapshot:a}=i,l=this.createViewTransition?.(this.environmentInjector,o.root,a.root);return l?fi(l).pipe(At(()=>i)):et(i)}),At(o=>{let a=vL(t.routeReuseStrategy,o.targetSnapshot,o.currentRouterState);return this.currentTransition=i=lt(Y({},o),{targetRouterState:a}),this.currentNavigation.update(l=>(l.targetRouterState=a,l)),i}),pi(()=>{this.events.next(new Nu)}),TL(this.rootContexts,t.routeReuseStrategy,o=>this.events.next(o),this.inputBindingEnabled),Bn(1),Lc(yw(s.signal).pipe(Sr(()=>!r&&!i.targetRouterState),pi(()=>{this.cancelNavigationTransition(i,s.signal.reason+"",zi.Aborted)}))),pi({next:o=>{r=!0,this.currentNavigation.update(a=>(a.abort=gB,a)),this.lastSuccessfulNavigation.set(Hn(this.currentNavigation)),this.events.next(new ds(o.id,this.urlSerializer.serialize(o.extractedUrl),this.urlSerializer.serialize(o.urlAfterRedirects))),this.titleStrategy?.updateTitle(o.targetRouterState.snapshot),o.resolve(!0)},complete:()=>{r=!0}}),Lc(this.transitionAbortWithErrorSubject.pipe(pi(o=>{throw o}))),E_(()=>{s.abort(),r||this.cancelNavigationTransition(i,"",zi.SupersededByNewNavigation),this.currentTransition?.id===i.id&&(this.currentNavigation.set(null),this.currentTransition=null)}),Fc(o=>{if(this.destroyed)return i.resolve(!1),Ji;if(r=!0,gw(o))this.events.next(new Vr(i.id,this.urlSerializer.serialize(i.extractedUrl),o.message,o.cancellationCode)),CL(o)?this.events.next(new Al(o.url,o.navigationBehaviorOptions)):i.resolve(!1);else{let a=new Il(i.id,this.urlSerializer.serialize(i.extractedUrl),o,i.targetSnapshot??void 0);try{let l=Gi(this.environmentInjector,()=>this.navigationErrorHandler?.(a));if(l instanceof El){let{message:c,cancellationCode:u}=Ap(this.urlSerializer,l);this.events.next(new Vr(i.id,this.urlSerializer.serialize(i.extractedUrl),c,u)),this.events.next(new Al(l.redirectTo,l.navigationBehaviorOptions))}else throw this.events.next(a),o}catch(l){this.options.resolveNavigationPromiseOnError?i.resolve(!1):i.reject(l)}}return Ji}))}))}cancelNavigationTransition(t,i,r){let s=new Vr(t.id,this.urlSerializer.serialize(t.extractedUrl),i,r);this.events.next(s),t.resolve(!1)}isUpdatingInternalState(){return this.currentTransition?.extractedUrl.toString()!==this.currentTransition?.currentUrlTree.toString()}isUpdatedBrowserUrl(){let t=this.urlHandlingStrategy.extract(this.urlSerializer.parse(this.location.path(!0))),i=Hn(this.currentNavigation),r=i?.targetBrowserUrl??i?.extractedUrl;return t.toString()!==r?.toString()&&!i?.extras.skipLocationChange}static \u0275fac=function(i){return new(i||n)};static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();function _B(n){return n!==Mu}var Nw=(()=>{class n{static \u0275fac=function(i){return new(i||n)};static \u0275prov=Ne({token:n,factory:()=>ue(yB),providedIn:"root"})}return n})(),wp=class{shouldDetach(e){return!1}store(e,t){}shouldAttach(e){return!1}retrieve(e){return null}shouldReuseRoute(e,t){return e.routeConfig===t.routeConfig}},yB=(()=>{class n extends wp{static \u0275fac=(()=>{let t;return function(r){return(t||(t=Of(n)))(r||n)}})();static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})(),Cb=(()=>{class n{urlSerializer=ue(Vu);options=ue(zu,{optional:!0})||{};canceledNavigationResolution=this.options.canceledNavigationResolution||"replace";location=ue(vl);urlHandlingStrategy=ue(Rp);urlUpdateStrategy=this.options.urlUpdateStrategy||"deferred";currentUrlTree=new lr;getCurrentUrlTree(){return this.currentUrlTree}rawUrlTree=this.currentUrlTree;getRawUrlTree(){return this.rawUrlTree}createBrowserPath({finalUrl:t,initialUrl:i,targetBrowserUrl:r}){let s=t!==void 0?this.urlHandlingStrategy.merge(t,i):i,o=r??s;return o instanceof lr?this.urlSerializer.serialize(o):o}commitTransition({targetRouterState:t,finalUrl:i,initialUrl:r}){i&&t?(this.currentUrlTree=i,this.rawUrlTree=this.urlHandlingStrategy.merge(i,r),this.routerState=t):this.rawUrlTree=r}routerState=uw(null);getRouterState(){return this.routerState}stateMemento=this.createStateMemento();updateStateMemento(){this.stateMemento=this.createStateMemento()}createStateMemento(){return{rawUrlTree:this.rawUrlTree,currentUrlTree:this.currentUrlTree,routerState:this.routerState}}resetInternalState({finalUrl:t}){this.routerState=this.stateMemento.routerState,this.currentUrlTree=this.stateMemento.currentUrlTree,this.rawUrlTree=this.urlHandlingStrategy.merge(this.currentUrlTree,t??this.rawUrlTree)}static \u0275fac=function(i){return new(i||n)};static \u0275prov=Ne({token:n,factory:()=>ue(Fw),providedIn:"root"})}return n})(),Fw=(()=>{class n extends Cb{currentPageId=0;lastSuccessfulId=-1;restoredState(){return this.location.getState()}get browserPageId(){return this.canceledNavigationResolution!=="computed"?this.currentPageId:this.restoredState()?.\u0275routerPageId??this.currentPageId}registerNonRouterCurrentEntryChangeListener(t){return this.location.subscribe(i=>{i.type==="popstate"&&setTimeout(()=>{t(i.url,i.state,"popstate")})})}handleRouterEvent(t,i){t instanceof Uo?this.updateStateMemento():t instanceof fs?this.commitTransition(i):t instanceof Ou?this.urlUpdateStrategy==="eager"&&(i.extras.skipLocationChange||this.setBrowserUrl(this.createBrowserPath(i),i)):t instanceof Nu?(this.commitTransition(i),this.urlUpdateStrategy==="deferred"&&!i.extras.skipLocationChange&&this.setBrowserUrl(this.createBrowserPath(i),i)):t instanceof Vr&&t.code!==zi.SupersededByNewNavigation&&t.code!==zi.Redirect?this.restoreHistory(i):t instanceof Il?this.restoreHistory(i,!0):t instanceof ds&&(this.lastSuccessfulId=t.id,this.currentPageId=this.browserPageId)}setBrowserUrl(t,{extras:i,id:r}){let{replaceUrl:s,state:o}=i;if(this.location.isCurrentPathEqualTo(t)||s){let a=this.browserPageId,l=Y(Y({},o),this.generateNgRouterState(r,a));this.location.replaceState(t,"",l)}else{let a=Y(Y({},o),this.generateNgRouterState(r,this.browserPageId+1));this.location.go(t,"",a)}}restoreHistory(t,i=!1){if(this.canceledNavigationResolution==="computed"){let r=this.browserPageId,s=this.currentPageId-r;s!==0?this.location.historyGo(s):this.getCurrentUrlTree()===t.finalUrl&&s===0&&(this.resetInternalState(t),this.resetUrlToCurrentUrlTree())}else this.canceledNavigationResolution==="replace"&&(i&&this.resetInternalState(t),this.resetUrlToCurrentUrlTree())}resetUrlToCurrentUrlTree(){this.location.replaceState(this.urlSerializer.serialize(this.getRawUrlTree()),"",this.generateNgRouterState(this.lastSuccessfulId,this.currentPageId))}generateNgRouterState(t,i){return this.canceledNavigationResolution==="computed"?{navigationId:t,\u0275routerPageId:i}:{navigationId:t}}static \u0275fac=(()=>{let t;return function(r){return(t||(t=Of(n)))(r||n)}})();static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();function Tb(n,e){n.events.pipe(Sr(t=>t instanceof ds||t instanceof Vr||t instanceof Il||t instanceof fs),At(t=>t instanceof ds||t instanceof fs?0:(t instanceof Vr?t.code===zi.Redirect||t.code===zi.SupersededByNewNavigation:!1)?2:1),Sr(t=>t!==2),Bn(1)).subscribe(()=>{e()})}var vB={paths:"exact",fragment:"ignored",matrixParams:"ignored",queryParams:"exact"},bB={paths:"subset",fragment:"ignored",matrixParams:"ignored",queryParams:"subset"},Gr=(()=>{class n{get currentUrlTree(){return this.stateManager.getCurrentUrlTree()}get rawUrlTree(){return this.stateManager.getRawUrlTree()}disposed=!1;nonRouterCurrentEntryChangeSubscription;console=ue(Fv);stateManager=ue(Cb);options=ue(zu,{optional:!0})||{};pendingTasks=ue(ls);urlUpdateStrategy=this.options.urlUpdateStrategy||"deferred";navigationTransitions=ue(Ow);urlSerializer=ue(Vu);location=ue(vl);urlHandlingStrategy=ue(Rp);injector=ue(Ai);_events=new ti;get events(){return this._events}get routerState(){return this.stateManager.getRouterState()}navigated=!1;routeReuseStrategy=ue(Nw);onSameUrlNavigation=this.options.onSameUrlNavigation||"ignore";config=ue(Hu,{optional:!0})?.flat()??[];componentInputBindingEnabled=!!ue(Mp,{optional:!0});currentNavigation=this.navigationTransitions.currentNavigation.asReadonly();constructor(){this.resetConfig(this.config),this.navigationTransitions.setupNavigations(this).subscribe({error:t=>{this.console.warn(t)}}),this.subscribeToNavigationEvents()}eventsSubscription=new zt;subscribeToNavigationEvents(){let t=this.navigationTransitions.events.subscribe(i=>{try{let r=this.navigationTransitions.currentTransition,s=Hn(this.navigationTransitions.currentNavigation);if(r!==null&&s!==null){if(this.stateManager.handleRouterEvent(i,s),i instanceof Vr&&i.code!==zi.Redirect&&i.code!==zi.SupersededByNewNavigation)this.navigated=!0;else if(i instanceof ds)this.navigated=!0;else if(i instanceof Al){let o=i.navigationBehaviorOptions,a=this.urlHandlingStrategy.merge(i.url,r.currentRawUrl),l=Y({browserUrl:r.extras.browserUrl,info:r.extras.info,skipLocationChange:r.extras.skipLocationChange,replaceUrl:r.extras.replaceUrl||this.urlUpdateStrategy==="eager"||_B(r.source)},o);this.scheduleNavigation(a,Mu,null,l,{resolve:r.resolve,reject:r.reject,promise:r.promise})}}mL(i)&&this._events.next(i)}catch(r){this.navigationTransitions.transitionAbortWithErrorSubject.next(r)}});this.eventsSubscription.add(t)}resetRootComponentType(t){this.routerState.root.component=t,this.navigationTransitions.rootComponentType=t}initialNavigation(){this.setUpLocationChangeListener(),this.navigationTransitions.hasRequestedNavigation||this.navigateToSyncWithBrowser(this.location.path(!0),Mu,this.stateManager.restoredState())}setUpLocationChangeListener(){this.nonRouterCurrentEntryChangeSubscription??=this.stateManager.registerNonRouterCurrentEntryChangeListener((t,i,r)=>{this.navigateToSyncWithBrowser(t,r,i)})}navigateToSyncWithBrowser(t,i,r){let s={replaceUrl:!0},o=r?.navigationId?r:null;if(r){let l=Y({},r);delete l.navigationId,delete l.\u0275routerPageId,Object.keys(l).length!==0&&(s.state=l)}let a=this.parseUrl(t);this.scheduleNavigation(a,i,o,s).catch(l=>{this.disposed||this.injector.get(zn)(l)})}get url(){return this.serializeUrl(this.currentUrlTree)}getCurrentNavigation(){return Hn(this.navigationTransitions.currentNavigation)}get lastSuccessfulNavigation(){return this.navigationTransitions.lastSuccessfulNavigation}resetConfig(t){this.config=t.map(bb),this.navigated=!1}ngOnDestroy(){this.dispose()}dispose(){this._events.unsubscribe(),this.navigationTransitions.complete(),this.nonRouterCurrentEntryChangeSubscription&&(this.nonRouterCurrentEntryChangeSubscription.unsubscribe(),this.nonRouterCurrentEntryChangeSubscription=void 0),this.disposed=!0,this.eventsSubscription.unsubscribe()}createUrlTree(t,i={}){let{relativeTo:r,queryParams:s,fragment:o,queryParamsHandling:a,preserveFragment:l}=i,c=l?this.currentUrlTree.fragment:o,u=null;switch(a??this.options.defaultQueryParamsHandling){case"merge":u=Y(Y({},this.currentUrlTree.queryParams),s);break;case"preserve":u=this.currentUrlTree.queryParams;break;default:u=s||null}u!==null&&(u=this.removeEmptyProps(u));let h;try{let d=r?r.snapshot:this.routerState.snapshot.root;h=ow(d)}catch{(typeof t[0]!="string"||t[0][0]!=="/")&&(t=[]),h=this.currentUrlTree.root}return aw(h,t,u,c??null,this.urlSerializer)}navigateByUrl(t,i={skipLocationChange:!1}){let r=Sl(t)?t:this.parseUrl(t),s=this.urlHandlingStrategy.merge(r,this.rawUrlTree);return this.scheduleNavigation(s,Mu,null,i)}navigate(t,i={skipLocationChange:!1}){return xB(t),this.navigateByUrl(this.createUrlTree(t,i),i)}serializeUrl(t){return this.urlSerializer.serialize(t)}parseUrl(t){try{return this.urlSerializer.parse(t)}catch{return this.console.warn(Ka(4018,!1)),this.urlSerializer.parse("/")}}isActive(t,i){let r;if(i===!0?r=Y({},vB):i===!1?r=Y({},bB):r=i,Sl(t))return VE(this.currentUrlTree,t,r);let s=this.parseUrl(t);return VE(this.currentUrlTree,s,r)}removeEmptyProps(t){return Object.entries(t).reduce((i,[r,s])=>(s!=null&&(i[r]=s),i),{})}scheduleNavigation(t,i,r,s,o){if(this.disposed)return Promise.resolve(!1);let a,l,c;o?(a=o.resolve,l=o.reject,c=o.promise):c=new Promise((h,d)=>{a=h,l=d});let u=this.pendingTasks.add();return Tb(this,()=>{queueMicrotask(()=>this.pendingTasks.remove(u))}),this.navigationTransitions.handleNavigationRequest({source:i,restoredState:r,currentUrlTree:this.currentUrlTree,currentRawUrl:this.currentUrlTree,rawUrl:t,extras:s,resolve:a,reject:l,promise:c,currentSnapshot:this.routerState.snapshot,currentRouterState:this.routerState}),c.catch(h=>Promise.reject(h))}static \u0275fac=function(i){return new(i||n)};static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();function xB(n){for(let e=0;e<n.length;e++)if(n[e]==null)throw new Le(4008,!1)}var TB=new Ue("");function Sb(n,...e){return Qa([{provide:Hu,multi:!0,useValue:n},[],{provide:qs,useFactory:SB},{provide:qf,multi:!0,useFactory:IB},e.map(t=>t.\u0275providers)])}function SB(){return ue(Gr).routerState.root}function IB(){let n=ue(Er);return e=>{let t=n.get(Lo);if(e!==t.components[0])return;let i=n.get(Gr),r=n.get(AB);n.get(EB)===1&&i.initialNavigation(),n.get(wB,null,{optional:!0})?.setUpPreloading(),n.get(TB,null,{optional:!0})?.init(),i.resetRootComponentType(t.componentTypes[0]),r.closed||(r.next(),r.complete(),r.unsubscribe())}}var AB=new Ue("",{factory:()=>new ti}),EB=new Ue("",{factory:()=>1});var wB=new Ue("");var Nt=(()=>{class n{static get ForceFullSceneLoadingForIncremental(){return n._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(t){n._ForceFullSceneLoadingForIncremental=t}static get ShowLoadingScreen(){return n._ShowLoadingScreen}static set ShowLoadingScreen(t){n._ShowLoadingScreen=t}static get loggingLevel(){return n._LoggingLevel}static set loggingLevel(t){n._LoggingLevel=t}static get CleanBoneMatrixWeights(){return n._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(t){n._CleanBoneMatrixWeights=t}}return n._ForceFullSceneLoadingForIncremental=!1,n._ShowLoadingScreen=!0,n._CleanBoneMatrixWeights=!1,n._LoggingLevel=0,n})();function Lw(n,e){return S(this,null,function*(){let t=e.method||"GET";return yield new Promise((i,r)=>{let s=new gr;s.addEventListener("readystatechange",()=>{if(s.readyState==4)if(s.status==200){let o={};if(e.responseHeaders)for(let a of e.responseHeaders)o[a]=s.getResponseHeader(a)||"";i({response:s.response,headerValues:o})}else r(`Unable to fetch data from ${n}. Error code: ${s.status}`)}),s.open(t,n),s.send()})})}function RB(n){return!!n.createPlugin}function PB(n){return!!n.name}var Bw=new F,Ur={},Ib=!1;function Pp(){return Ur[".babylon"]}function OB(n){for(let e in Ur){let t=Ur[e];if(t.mimeType===n)return t}}function Ab(n,e){let t=Ur[n];return t||(P.Warn("Unable to find a plugin to load "+n+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),e?Pp():void 0)}function NB(n){return!!Ur[n]}function FB(n){for(let e in Ur){let t=Ur[e].plugin;if(t.canDirectLoad&&t.canDirectLoad(n))return Ur[e]}return Pp()}function LB(n){let e=n.indexOf("?");e!==-1&&(n=n.substring(0,e));let t=n.lastIndexOf(".");return n.substring(t,n.length).toLowerCase()}function BB(n){return n.substring(0,5)==="data:"?n.substring(5):null}function Eb(n,e,t){let r="Unable to load from "+(n.rawData?"binary data":n.url);return e?r+=`: ${e}`:t&&(r+=`: ${t}`),r}function wb(n,e,t,i,r,s,o,a,l){return S(this,null,function*(){let c=BB(n.url);if(n.rawData&&!o)throw"When using ArrayBufferView to load data the file extension must be provided.";let u=!c&&!o?LB(n.url):"",h=o?Ab(o,!0):c?FB(n.url):Ab(u,!1);if(!h&&u){if(n.url&&!n.url.startsWith("blob:")){let f=yield Lw(n.url,{method:"HEAD",responseHeaders:["Content-Type"]}),p=f.headerValues?f.headerValues["Content-Type"]:"";p&&(h=OB(p))}h||(h=Pp())}if(!h)throw new Error(`No plugin or fallback for ${o??n.url}`);if(l?.[h.plugin.name]?.enabled===!1)throw new Error(`The '${h.plugin.name}' plugin is disabled via the loader options passed to the loading operation.`);if(n.rawData&&!h.isBinary)throw"Loading from ArrayBufferView can not be used with plugins that don't support binary loading.";return(f=>{if(RB(h.plugin)){let g=h.plugin.createPlugin(l??{});return g instanceof Promise?(g.then(f).catch(_=>{r("Error instantiating plugin.",_)}),null):(f(g),g)}else return f(h.plugin),h.plugin})(f=>{if(!f)throw`The loader plugin corresponding to the '${o}' file type has not been found. If using es6, please import the plugin you wish to use before.`;if(Bw.notifyObservers(f),c&&(f.canDirectLoad&&f.canDirectLoad(n.url)||!Qh(n.url))){if(f.directLoad){let v=f.directLoad(e,c);v instanceof Promise?v.then(x=>{t(f,x)}).catch(x=>{r("Error in directLoad of _loadData: "+x,x)}):t(f,v)}else t(f,c);return}let p=h.isBinary,g=(v,x)=>{if(e.isDisposed){r("Scene has been disposed");return}t(f,v,x)},_=null,y=!1;f.onDisposeObservable?.add(()=>{y=!0,_&&(_.abort(),_=null),s()});let b=()=>{if(y)return;let v=(x,C)=>{r(x?.statusText,C)};if(!f.loadFile&&n.rawData)throw"Plugin does not support loading ArrayBufferView.";_=f.loadFile?f.loadFile(e,n.rawData||n.file||n.url,n.rootUrl,g,i,p,v,a):e._loadFile(n.file||n.url,g,i,!0,p,v)},A=e.getEngine(),I=A.enableOfflineSupport;if(I){let v=!1;for(let x of e.disableOfflineSupportExceptionRules)if(x.test(n.url)){v=!0;break}I=!v}I&&ne.OfflineProviderFactory?e.offlineProvider=ne.OfflineProviderFactory(n.url,b,A.disableManifestCheck):b()})})}function Mb(n,e){let t,i,r=null,s=null;if(!e)t=n,i=z.GetFilename(n),n=z.GetFolderPath(n);else if(PB(e))t=`file:${e.name}`,i=e.name,r=e;else if(ArrayBuffer.isView(e))t="",i=Ea(),s=e;else if(e.startsWith("data:"))t=e,i="";else if(n){let o=e;if(o.substring(0,1)==="/")return z.Error("Wrong sceneFilename parameter"),null;t=n+o,i=o}else t=e,i=z.GetFilename(e),n=z.GetFolderPath(e);return{url:t,rootUrl:n,name:i,file:r,rawData:s}}function Wu(n){if(typeof n.extensions=="string"){let e=n.extensions;Ur[e.toLowerCase()]={plugin:n,isBinary:!1}}else{let e=n.extensions,t=Object.keys(e);for(let i of t)Ur[i.toLowerCase()]={plugin:n,isBinary:e[i].isBinary,mimeType:e[i].mimeType}}}function kw(u,h){return S(this,arguments,function*(n,e,t="",i=ye.LastCreatedScene,r=null,s=null,o=null,a=null,l="",c={}){if(!i)return P.Error("No scene available to import mesh to"),null;let d=Mb(e,t);if(!d)return null;let f={};i.addPendingData(f);let p=()=>{i.removePendingData(f)},g=(b,A)=>{let I=Eb(d,b,A);o?o(i,I,new Ca(I,xa.SceneLoaderError,A)):P.Error(I),p()},_=s?b=>{try{s(b)}catch(A){g("Error in onProgress callback: "+A,A)}}:void 0,y=(b,A,I,v,x,C,R,M)=>{if(i.importedMeshesFiles.push(d.url),r)try{r(b,A,I,v,x,C,R,M)}catch(D){g("Error in onSuccess callback: "+D,D)}i.removePendingData(f)};return yield wb(d,i,(b,A,I)=>{if(b.rewriteRootURL&&(d.rootUrl=b.rewriteRootURL(d.rootUrl,I)),b.importMesh){let v=b,x=[],C=[],R=[];if(!v.importMesh(n,i,A,d.rootUrl,x,C,R,g))return;i.loadingPluginName=b.name,y(x,C,R,[],[],[],[],[])}else b.importMeshAsync(n,i,A,d.rootUrl,_,d.name).then(x=>{i.loadingPluginName=b.name,y(x.meshes,x.particleSystems,x.skeletons,x.animationGroups,x.transformNodes,x.geometries,x.lights,x.spriteManagers)}).catch(x=>{g(x.message,x)})},_,g,p,a,l,c)})}function kB(n,e,t,i,r,s,o,a){return S(this,null,function*(){return yield new Promise((l,c)=>{try{kw(n,e,t,i,(u,h,d,f,p,g,_,y)=>{l({meshes:u,particleSystems:h,skeletons:d,animationGroups:f,transformNodes:p,geometries:g,lights:_,spriteManagers:y})},r,(u,h,d)=>{c(d||new Error(h))},s,o,a).catch(c)}catch(u){c(u)}})})}function Vw(c){return S(this,arguments,function*(n,e="",t=ye.LastCreatedEngine,i=null,r=null,s=null,o=null,a="",l={}){if(!t){z.Error("No engine available");return}yield Db(n,e,new Ce(t),i,r,s,o,a,l)})}function VB(n,e,t,i,r,s,o){return S(this,null,function*(){return yield new Promise((a,l)=>{Vw(n,e,t,c=>{a(c)},i,(c,u,h)=>{l(h||new Error(u))},r,s,o)})})}function Db(c){return S(this,arguments,function*(n,e="",t=ye.LastCreatedScene,i=null,r=null,s=null,o=null,a="",l={}){if(!t)return P.Error("No scene available to append to"),null;let u=Mb(n,e);if(!u)return null;let h={};t.addPendingData(h);let d=()=>{t.removePendingData(h)};Nt.ShowLoadingScreen&&!Ib&&(Ib=!0,t.getEngine().displayLoadingUI(),t.executeWhenReady(()=>{t.getEngine().hideLoadingUI(),Ib=!1}));let f=(_,y)=>{let b=Eb(u,_,y);s?s(t,b,new Ca(b,xa.SceneLoaderError,y)):P.Error(b),d()},p=r?_=>{try{r(_)}catch(y){f("Error in onProgress callback",y)}}:void 0,g=()=>{if(i)try{i(t)}catch(_){f("Error in onSuccess callback",_)}t.removePendingData(h)};return yield wb(u,t,(_,y)=>{if(_.load){if(!_.load(t,y,u.rootUrl,f))return;t.loadingPluginName=_.name,g()}else _.loadAsync(t,y,u.rootUrl,p,u.name).then(()=>{t.loadingPluginName=_.name,g()}).catch(A=>{f(A.message,A)})},p,f,d,o,a,l)})}function GB(n,e,t,i,r,s,o){return S(this,null,function*(){return yield new Promise((a,l)=>{try{Db(n,e,t,c=>{a(c)},i,(c,u,h)=>{l(h||new Error(u))},r,s,o).catch(l)}catch(c){l(c)}})})}function Rb(c){return S(this,arguments,function*(n,e="",t=ye.LastCreatedScene,i=null,r=null,s=null,o=null,a="",l={}){if(!t)return P.Error("No scene available to load asset container to"),null;let u=Mb(n,e);if(!u)return null;let h={};t.addPendingData(h);let d=()=>{t.removePendingData(h)},f=(_,y)=>{let b=Eb(u,_,y);s?s(t,b,new Ca(b,xa.SceneLoaderError,y)):P.Error(b),d()},p=r?_=>{try{r(_)}catch(y){f("Error in onProgress callback",y)}}:void 0,g=_=>{if(i)try{i(_)}catch(y){f("Error in onSuccess callback",y)}t.removePendingData(h)};return yield wb(u,t,(_,y)=>{if(_.loadAssetContainer){let A=_.loadAssetContainer(t,y,u.rootUrl,f);if(!A)return;A.populateRootNodes(),t.loadingPluginName=_.name,g(A)}else _.loadAssetContainerAsync?_.loadAssetContainerAsync(t,y,u.rootUrl,p,u.name).then(A=>{A.populateRootNodes(),t.loadingPluginName=_.name,g(A)}).catch(A=>{f(A.message,A)}):f("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")},p,f,d,o,a,l)})}function Gw(n,e,t){return S(this,null,function*(){let{rootUrl:i="",onProgress:r,pluginExtension:s,name:o,pluginOptions:a}=t??{};return yield Uw(i,n,e,r,s,o,a)})}function Uw(n,e,t,i,r,s,o){return S(this,null,function*(){return yield new Promise((a,l)=>{try{Rb(n,e,t,c=>{a(c)},i,(c,u,h)=>{l(h||new Error(u))},r,s,o).catch(l)}catch(c){l(c)}})})}function zw(d){return S(this,arguments,function*(n,e="",t=ye.LastCreatedScene,i=!0,r=0,s=null,o=null,a=null,l=null,c=null,u="",h={}){if(!t){P.Error("No scene available to load animations to");return}if(i){for(let y of t.animatables)y.reset();t.stopAllAnimations();let g=t.animationGroups.slice();for(let y of g)y.dispose();let _=t.getNodes();for(let y of _)y.animations&&(y.animations=[])}else switch(r){case 0:let g=t.animationGroups.slice();for(let _ of g)_.dispose();break;case 1:for(let _ of t.animationGroups)_.stop();break;case 2:for(let _ of t.animationGroups)_.reset(),_.restart();break;case 3:break;default:P.Error("Unknown animation group loading mode value '"+r+"'");return}let f=t.animatables.length;yield Rb(n,e,t,g=>{g.mergeAnimationsTo(t,t.animatables.slice(f),s),g.dispose(),t.onAnimationFileImportedObservable.notifyObservers(t),o&&o(t)},a,l,c,u,h)})}function UB(n,e,t,i,r,s,o,a,l,c){return S(this,null,function*(){return yield new Promise((u,h)=>{try{zw(n,e,t,i,r,s,d=>{u(d)},o,(d,f,p)=>{h(p||new Error(f))},a,l,c).catch(h)}catch(d){h(d)}})})}var Ho=(()=>{class n{static get ForceFullSceneLoadingForIncremental(){return Nt.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(t){Nt.ForceFullSceneLoadingForIncremental=t}static get ShowLoadingScreen(){return Nt.ShowLoadingScreen}static set ShowLoadingScreen(t){Nt.ShowLoadingScreen=t}static get loggingLevel(){return Nt.loggingLevel}static set loggingLevel(t){Nt.loggingLevel=t}static get CleanBoneMatrixWeights(){return Nt.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(t){Nt.CleanBoneMatrixWeights=t}static GetDefaultPlugin(){return Pp()}static GetPluginForExtension(t){return Ab(t,!0)?.plugin}static IsPluginForExtensionAvailable(t){return NB(t)}static RegisterPlugin(t){Wu(t)}static ImportMesh(t,i,r,s,o,a,l,c,u,h){kw(t,i,r,s,o,a,l,c,u,h).catch(d=>l?.(ye.LastCreatedScene,d?.message,d))}static ImportMeshAsync(t,i,r,s,o,a,l){return S(this,null,function*(){return yield kB(t,i,r,s,o,a,l)})}static Load(t,i,r,s,o,a,l,c){Vw(t,i,r,s,o,a,l,c).catch(u=>a?.(ye.LastCreatedScene,u?.message,u))}static LoadAsync(t,i,r,s,o,a){return S(this,null,function*(){return yield VB(t,i,r,s,o,a)})}static Append(t,i,r,s,o,a,l,c){Db(t,i,r,s,o,a,l,c).catch(u=>a?.(r??ye.LastCreatedScene,u?.message,u))}static AppendAsync(t,i,r,s,o,a){return S(this,null,function*(){return yield GB(t,i,r,s,o,a)})}static LoadAssetContainer(t,i,r,s,o,a,l,c){Rb(t,i,r,s,o,a,l,c).catch(u=>a?.(r??ye.LastCreatedScene,u?.message,u))}static LoadAssetContainerAsync(t,i,r,s,o,a){return S(this,null,function*(){return yield Uw(t,i,r,s,o,a)})}static ImportAnimations(t,i,r,s,o,a,l,c,u,h,d){zw(t,i,r,s,o,a,l,c,u,h,d).catch(f=>u?.(r??ye.LastCreatedScene,f?.message,f))}static ImportAnimationsAsync(t,i,r,s,o,a,l,c,u,h,d){return S(this,null,function*(){return yield UB(t,i,r,s,o,a,c,h,d)})}}return n.NO_LOGGING=0,n.MINIMAL_LOGGING=1,n.SUMMARY_LOGGING=2,n.DETAILED_LOGGING=3,n.OnPluginActivatedObservable=Bw,n})();var Lt=class n{get boundingBias(){return this._boundingBias}set boundingBias(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)}static CreateGeometryForMesh(e){let t=new n(n.RandomId(),e.getScene());return t.applyToMesh(e),t}get meshes(){return this._meshes}constructor(e,t,i,r=!1,s=null){this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._extend={minimum:new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),maximum:new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=t||ye.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=r,i?this.setAllVerticesData(i,r):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),s&&(this.applyToMesh(s),s.computeWorldMatrix(!0)))}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return this.delayLoadState===1||this.delayLoadState===0}get doNotSerialize(){for(let e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0}_rebuild(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable,"Geometry_"+this.id+"_IndexBuffer"));let e=new Set;for(let t in this._vertexBuffers)e.add(this._vertexBuffers[t].getWrapperBuffer());e.forEach(t=>{t._rebuild()})}setAllVerticesData(e,t){e.applyToGeometry(this,t),this._notifyUpdate()}setVerticesData(e,t,i=!1,r){i&&Array.isArray(t)&&(t=new Float32Array(t));let s=new T(this._engine,t,e,{updatable:i,postponeInternalCreation:this._meshes.length===0,stride:r,label:"Geometry_"+this.id+"_"+e});this.setVerticesBuffer(s)}removeVerticesData(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}setVerticesBuffer(e,t=null,i=!0){let r=e.getKind();this._vertexBuffers[r]&&i&&this._vertexBuffers[r].dispose(),e._buffer&&e._ownsBuffer&&e._buffer._increaseReferences(),this._vertexBuffers[r]=e;let s=this._meshes,o=s.length;if(r===T.PositionKind){this._totalVertices=t??e._maxVerticesCount,this._updateExtend(this.useBoundingInfoFromGeometry&&this._boundingInfo?null:e.getFloatData(this._totalVertices)),this._resetPointsArrayCache();let a=this._extend&&this._extend.minimum||new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),l=this._extend&&this._extend.maximum||new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);for(let c=0;c<o;c++){let u=s[c];u.buildBoundingInfo(a,l),u._createGlobalSubMesh(u.isUnIndexed),u.computeWorldMatrix(!0),u.synchronizeInstances()}}this._notifyUpdate(r)}updateVerticesDataDirectly(e,t,i,r=!1){let s=this.getVertexBuffer(e);s&&(s.updateDirectly(t,i,r),this._notifyUpdate(e))}updateVerticesData(e,t,i=!1){let r=this.getVertexBuffer(e);r&&(r.update(t),e===T.PositionKind&&this._updateBoundingInfo(i,t),this._notifyUpdate(e))}_updateBoundingInfo(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e){let i=this._meshes;for(let r of i){r.hasBoundingInfo?r.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):r.buildBoundingInfo(this._extend.minimum,this._extend.maximum);let s=r.subMeshes;for(let o of s)o.refreshBoundingInfo()}}}_bind(e,t,i,r){if(!e)return;t===void 0&&(t=this._indexBuffer);let s=this.getVertexBuffers();if(!s)return;if(t!=this._indexBuffer||!this._vertexArrayObjects&&!r){this._engine.bindBuffers(s,t,e,i);return}let o=r||this._vertexArrayObjects,a=this._engine;o[e.key]||(o[e.key]=a.recordVertexArrayObject(s,t,e,i)),a.bindVertexArrayObject(o[e.key],t)}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(e,t,i){let r=this.getVertexBuffer(e);return r?r.getFloatData(this._totalVertices,i||t&&this._meshes.length!==1):null}copyVerticesData(e,t){let i=this.getVertexBuffer(e);if(!i)return;t[e]||(t[e]=new Float32Array(this._totalVertices*i.getSize()));let r=i.getData();r&&WT(r,i.getSize(),i.type,i.byteOffset,i.byteStride,i.normalized,this._totalVertices,t[e])}isVertexBufferUpdatable(e){let t=this._vertexBuffers[e];return t?t.isUpdatable():!1}getVertexBuffer(e){return this.isReady()?this._vertexBuffers[e]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(e){return this._vertexBuffers?this._vertexBuffers[e]!==void 0:this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}getVerticesDataKinds(){let e=[],t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e}updateIndices(e,t,i=!1){if(this._indexBuffer)if(!this._indexBufferIsUpdatable)this.setIndices(e,null,!0);else{let r=e.length!==this._indices.length;if(i||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),r)for(let s of this._meshes)s._createGlobalSubMesh(!0)}}setIndexBuffer(e,t,i,r=null){this._indices=[],this._indexBufferIsUpdatable=!1,this._indexBuffer=e,this._totalVertices=t,this._totalIndices=i,r===null?e.is32Bits=t>65535:e.is32Bits=r;for(let s of this._meshes)s._createGlobalSubMesh(!0),s.synchronizeInstances();this._notifyUpdate()}setIndices(e,t=null,i=!1,r=!1){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=i,this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,i,"Geometry_"+this.id+"_IndexBuffer")),t!=null&&(this._totalVertices=t);for(let s of this._meshes)s._createGlobalSubMesh(!r),s.synchronizeInstances();this._notifyUpdate()}getTotalIndices(){return this.isReady()?this._totalIndices!==void 0?this._totalIndices:this._indices.length:0}getIndices(e,t){if(!this.isReady())return null;let i=this._indices;return!t&&(!e||this._meshes.length===1)?i:i.slice()}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(e=null){!e||!this._vertexArrayObjects||this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])}releaseForMesh(e,t){let i=this._meshes,r=i.indexOf(e);r!==-1&&(i.splice(r,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,i.length===0&&t&&this.dispose())}applyToMesh(e){if(e._geometry===this)return;let t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();let i=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),i.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}_updateExtend(e=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&(e=this.getVerticesData(T.PositionKind),!e))return;this._extend=g0(e,0,this._totalVertices,this.boundingBias,3)}}_applyToMesh(e){for(let t in this._vertexBuffers){let i=this._vertexBuffers[t];i._buffer.getBuffer()||i.create(),t===T.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo())}!this._indexBuffer&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable,"Geometry_"+this.id+"_IndexBuffer")),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()}_notifyUpdate(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(let t of this._meshes)t._markSubMeshesAsAttributesDirty()}load(e,t){if(this.delayLoadState!==2){if(this.isReady()){t&&t();return}this.delayLoadState=2,this._queueLoad(e,t)}}_queueLoad(e,t){this.delayLoadingFile&&(e.addPendingData(this),e._loadFile(this.delayLoadingFile,i=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(i),this),this.delayLoadState=1,this._delayInfo=[],e.removePendingData(this);let r=this._meshes,s=r.length;for(let o=0;o<s;o++)this._applyToMesh(r[o]);t&&t()},void 0,!0))}toLeftHanded(){let e=this.getIndices(!1);if(e!=null&&e.length>0){for(let r=0;r<e.length;r+=3){let s=e[r+0];e[r+0]=e[r+2],e[r+2]=s}this.setIndices(e)}let t=this.getVerticesData(T.PositionKind,!1);if(t!=null&&t.length>0){for(let r=0;r<t.length;r+=3)t[r+2]=-t[r+2];this.setVerticesData(T.PositionKind,t,!1)}let i=this.getVerticesData(T.NormalKind,!1);if(i!=null&&i.length>0){for(let r=0;r<i.length;r+=3)i[r+2]=-i[r+2];this.setVerticesData(T.NormalKind,i,!1)}}_resetPointsArrayCache(){this._positions=null}_generatePointsArray(){if(this._positions)return!0;let e=this.getVerticesData(T.PositionKind);if(!e||e.length===0)return!1;for(let t=this._positionsCache.length*3,i=this._positionsCache.length;t<e.length;t+=3,++i)this._positionsCache[i]=m.FromArray(e,t);for(let t=0,i=0;t<e.length;t+=3,++i)this._positionsCache[i].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(let i in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[i]);this._vertexArrayObjects={};let e=this._meshes,t=e.length;for(let i=0;i<t;i++)e[i]._invalidateInstanceVertexArrayObject()}}dispose(){let e=this._meshes,t=e.length,i;for(i=0;i<t;i++)this.releaseForMesh(e[i]);this._meshes.length=0,this._disposeVertexArrayObjects();for(let r in this._vertexBuffers)this._vertexBuffers[r].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){let r=this._parentContainer.geometries.indexOf(this);r>-1&&this._parentContainer.geometries.splice(r,1),this._parentContainer=null}this._isDisposed=!0}copy(e){let t=new n(e,this._scene),i=this.getIndices(void 0,!0);i&&t.setIndices(i);let r=!1,s;for(s in this._vertexBuffers){let o=this.getVertexBuffer(s),a=o.getData();if(!a)continue;let l=o.isUpdatable(),c=o.getSize(),{type:u,byteOffset:h,byteStride:d,normalized:f}=o;r=r||l;let p=HT(a,c,u,h,d,this._totalVertices,!0),g=new T(this._engine,p,s,{updatable:l,useBytes:!1,stride:c,size:c,offset:0,type:u,normalized:f,takeBufferOwnership:!0});t.setVerticesBuffer(g,this._totalVertices)}t._updatable=r,t.delayLoadState=this.delayLoadState,t.delayLoadingFile=this.delayLoadingFile,t._delayLoadingFunction=this._delayLoadingFunction;for(s in this._delayInfo)t._delayInfo=t._delayInfo||[],t._delayInfo.push(s);return t._boundingInfo=new es(this._extend.minimum,this._extend.maximum),t}serialize(){let e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,St&&St.HasTags(this)&&(e.tags=St.GetTags(this)),e}_toNumberArray(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}clearCachedData(){this._indices=[],this._resetPointsArrayCache();for(let e in this._vertexBuffers)Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)&&(this._vertexBuffers[e]._buffer._data=null)}serializeVerticeData(){let e=this.serialize();return this.isVerticesDataPresent(T.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(T.PositionKind)),this.isVertexBufferUpdatable(T.PositionKind)&&(e.positionsUpdatable=!0)),this.isVerticesDataPresent(T.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(T.NormalKind)),this.isVertexBufferUpdatable(T.NormalKind)&&(e.normalsUpdatable=!0)),this.isVerticesDataPresent(T.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(T.TangentKind)),this.isVertexBufferUpdatable(T.TangentKind)&&(e.tangentsUpdatable=!0)),this.isVerticesDataPresent(T.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(T.UVKind)),this.isVertexBufferUpdatable(T.UVKind)&&(e.uvsUpdatable=!0)),this.isVerticesDataPresent(T.UV2Kind)&&(e.uvs2=this._toNumberArray(this.getVerticesData(T.UV2Kind)),this.isVertexBufferUpdatable(T.UV2Kind)&&(e.uvs2Updatable=!0)),this.isVerticesDataPresent(T.UV3Kind)&&(e.uvs3=this._toNumberArray(this.getVerticesData(T.UV3Kind)),this.isVertexBufferUpdatable(T.UV3Kind)&&(e.uvs3Updatable=!0)),this.isVerticesDataPresent(T.UV4Kind)&&(e.uvs4=this._toNumberArray(this.getVerticesData(T.UV4Kind)),this.isVertexBufferUpdatable(T.UV4Kind)&&(e.uvs4Updatable=!0)),this.isVerticesDataPresent(T.UV5Kind)&&(e.uvs5=this._toNumberArray(this.getVerticesData(T.UV5Kind)),this.isVertexBufferUpdatable(T.UV5Kind)&&(e.uvs5Updatable=!0)),this.isVerticesDataPresent(T.UV6Kind)&&(e.uvs6=this._toNumberArray(this.getVerticesData(T.UV6Kind)),this.isVertexBufferUpdatable(T.UV6Kind)&&(e.uvs6Updatable=!0)),this.isVerticesDataPresent(T.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(T.ColorKind)),this.isVertexBufferUpdatable(T.ColorKind)&&(e.colorsUpdatable=!0)),this.isVerticesDataPresent(T.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(T.MatricesIndicesKind)),e.matricesIndicesExpanded=!0,this.isVertexBufferUpdatable(T.MatricesIndicesKind)&&(e.matricesIndicesUpdatable=!0)),this.isVerticesDataPresent(T.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(T.MatricesWeightsKind)),this.isVertexBufferUpdatable(T.MatricesWeightsKind)&&(e.matricesWeightsUpdatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e}static ExtractFromMesh(e,t){let i=e._geometry;return i?i.copy(t):null}static RandomId(){return z.RandomId()}static _GetGeometryByLoadedUniqueId(e,t){for(let i=0;i<t.geometries.length;i++)if(t.geometries[i]._loadedUniqueId===e)return t.geometries[i];return null}static _ImportGeometry(e,t){let i=t.getScene(),r=e.geometryUniqueId,s=e.geometryId;if(r||s){let o=r?this._GetGeometryByLoadedUniqueId(r,i):i.getGeometryById(s);o&&o.applyToMesh(t)}else if(e instanceof ArrayBuffer){let o=t._binaryInfo;if(o.positionsAttrDesc&&o.positionsAttrDesc.count>0){let a=new Float32Array(e,o.positionsAttrDesc.offset,o.positionsAttrDesc.count);t.setVerticesData(T.PositionKind,a,!1)}if(o.normalsAttrDesc&&o.normalsAttrDesc.count>0){let a=new Float32Array(e,o.normalsAttrDesc.offset,o.normalsAttrDesc.count);t.setVerticesData(T.NormalKind,a,!1)}if(o.tangetsAttrDesc&&o.tangetsAttrDesc.count>0){let a=new Float32Array(e,o.tangetsAttrDesc.offset,o.tangetsAttrDesc.count);t.setVerticesData(T.TangentKind,a,!1)}if(o.uvsAttrDesc&&o.uvsAttrDesc.count>0){let a=new Float32Array(e,o.uvsAttrDesc.offset,o.uvsAttrDesc.count);if(Me)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(T.UVKind,a,!1)}if(o.uvs2AttrDesc&&o.uvs2AttrDesc.count>0){let a=new Float32Array(e,o.uvs2AttrDesc.offset,o.uvs2AttrDesc.count);if(Me)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(T.UV2Kind,a,!1)}if(o.uvs3AttrDesc&&o.uvs3AttrDesc.count>0){let a=new Float32Array(e,o.uvs3AttrDesc.offset,o.uvs3AttrDesc.count);if(Me)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(T.UV3Kind,a,!1)}if(o.uvs4AttrDesc&&o.uvs4AttrDesc.count>0){let a=new Float32Array(e,o.uvs4AttrDesc.offset,o.uvs4AttrDesc.count);if(Me)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(T.UV4Kind,a,!1)}if(o.uvs5AttrDesc&&o.uvs5AttrDesc.count>0){let a=new Float32Array(e,o.uvs5AttrDesc.offset,o.uvs5AttrDesc.count);if(Me)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(T.UV5Kind,a,!1)}if(o.uvs6AttrDesc&&o.uvs6AttrDesc.count>0){let a=new Float32Array(e,o.uvs6AttrDesc.offset,o.uvs6AttrDesc.count);if(Me)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(T.UV6Kind,a,!1)}if(o.colorsAttrDesc&&o.colorsAttrDesc.count>0){let a=new Float32Array(e,o.colorsAttrDesc.offset,o.colorsAttrDesc.count);t.setVerticesData(T.ColorKind,a,!1,o.colorsAttrDesc.stride)}if(o.matricesIndicesAttrDesc&&o.matricesIndicesAttrDesc.count>0){let a=new Int32Array(e,o.matricesIndicesAttrDesc.offset,o.matricesIndicesAttrDesc.count),l=[];for(let c=0;c<a.length;c++){let u=a[c];l.push(u&255),l.push((u&65280)>>8),l.push((u&16711680)>>16),l.push(u>>24&255)}t.setVerticesData(T.MatricesIndicesKind,l,!1)}if(o.matricesIndicesExtraAttrDesc&&o.matricesIndicesExtraAttrDesc.count>0){let a=new Int32Array(e,o.matricesIndicesExtraAttrDesc.offset,o.matricesIndicesExtraAttrDesc.count),l=[];for(let c=0;c<a.length;c++){let u=a[c];l.push(u&255),l.push((u&65280)>>8),l.push((u&16711680)>>16),l.push(u>>24&255)}t.setVerticesData(T.MatricesIndicesExtraKind,l,!1)}if(o.matricesWeightsAttrDesc&&o.matricesWeightsAttrDesc.count>0){let a=new Float32Array(e,o.matricesWeightsAttrDesc.offset,o.matricesWeightsAttrDesc.count);t.setVerticesData(T.MatricesWeightsKind,a,!1)}if(o.indicesAttrDesc&&o.indicesAttrDesc.count>0){let a=new Int32Array(e,o.indicesAttrDesc.offset,o.indicesAttrDesc.count);t.setIndices(a,null)}if(o.subMeshesAttrDesc&&o.subMeshesAttrDesc.count>0){let a=new Int32Array(e,o.subMeshesAttrDesc.offset,o.subMeshesAttrDesc.count*5);t.subMeshes=[];for(let l=0;l<o.subMeshesAttrDesc.count;l++){let c=a[l*5+0],u=a[l*5+1],h=a[l*5+2],d=a[l*5+3],f=a[l*5+4];Xi.AddToMesh(c,u,h,d,f,t)}}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(T.PositionKind,e.positions,e.positions._updatable||e.positionsUpdatable),t.setVerticesData(T.NormalKind,e.normals,e.normals._updatable||e.normalsUpdatable),e.tangents&&t.setVerticesData(T.TangentKind,e.tangents,e.tangents._updatable||e.tangentsUpdatable),e.uvs&&t.setVerticesData(T.UVKind,e.uvs,e.uvs._updatable||e.uvsUpdatable),e.uvs2&&t.setVerticesData(T.UV2Kind,e.uvs2,e.uvs2._updatable||e.uvs2Updatable),e.uvs3&&t.setVerticesData(T.UV3Kind,e.uvs3,e.uvs3._updatable||e.uvs3Updatable),e.uvs4&&t.setVerticesData(T.UV4Kind,e.uvs4,e.uvs4._updatable||e.uvs4Updatable),e.uvs5&&t.setVerticesData(T.UV5Kind,e.uvs5,e.uvs5._updatable||e.uvs5Updatable),e.uvs6&&t.setVerticesData(T.UV6Kind,e.uvs6,e.uvs6._updatable||e.uvs6Updatable),e.colors&&t.setVerticesData(T.ColorKind,ce.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(!e.matricesIndices._isExpanded&&!e.matricesIndicesExpanded){let o=[];for(let a=0;a<e.matricesIndices.length;a++){let l=e.matricesIndices[a];o.push(l&255),o.push((l&65280)>>8),o.push((l&16711680)>>16),o.push(l>>24&255)}t.setVerticesData(T.MatricesIndicesKind,o,e.matricesIndices._updatable||e.matricesIndicesUpdatable)}else delete e.matricesIndices._isExpanded,delete e.matricesIndicesExpanded,t.setVerticesData(T.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable||e.matricesIndicesUpdatable);if(e.matricesIndicesExtra)if(e.matricesIndicesExtraExpanded||e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,delete e.matricesIndicesExtraExpanded,t.setVerticesData(T.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable||e.matricesIndicesExtraUpdatable);else{let o=[];for(let a=0;a<e.matricesIndicesExtra.length;a++){let l=e.matricesIndicesExtra[a];o.push(l&255),o.push((l&65280)>>8),o.push((l&16711680)>>16),o.push(l>>24&255)}t.setVerticesData(T.MatricesIndicesExtraKind,o,e.matricesIndicesExtra._updatable||e.matricesIndicesExtraUpdatable)}e.matricesWeights&&(n._CleanMatricesWeights(e,t),t.setVerticesData(T.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(T.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null)}if(e.subMeshes){t.subMeshes=[];for(let o=0;o<e.subMeshes.length;o++){let a=e.subMeshes[o];Xi.AddToMesh(a.materialIndex,a.verticesStart,a.verticesCount,a.indexStart,a.indexCount,t)}}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),t._shouldGenerateFlatShading=!1),t.computeWorldMatrix(!0),i.onMeshImportedObservable.notifyObservers(t)}static _CleanMatricesWeights(e,t){if(!Nt.CleanBoneMatrixWeights)return;let r=0;if(e.skeletonId>-1){let h=t.getScene().getLastSkeletonById(e.skeletonId);if(!h)return;r=h.bones.length}else return;let s=t.getVerticesData(T.MatricesIndicesKind),o=t.getVerticesData(T.MatricesIndicesExtraKind),a=e.matricesWeights,l=e.matricesWeightsExtra,c=e.numBoneInfluencer,u=a.length;for(let h=0;h<u;h+=4){let d=0,f=-1;for(let p=0;p<4;p++){let g=a[h+p];d+=g,g<.001&&f<0&&(f=p)}if(l)for(let p=0;p<4;p++){let g=l[h+p];d+=g,g<.001&&f<0&&(f=p+4)}if((f<0||f>c-1)&&(f=c-1),d>.001){let p=1/d;for(let g=0;g<4;g++)a[h+g]*=p;if(l)for(let g=0;g<4;g++)l[h+g]*=p}else f>=4?(l[h+f-4]=1-d,o[h+f-4]=r):(a[h+f]=1-d,s[h+f]=r)}t.setVerticesData(T.MatricesIndicesKind,s),e.matricesWeightsExtra&&t.setVerticesData(T.MatricesIndicesExtraKind,o)}static Parse(e,t,i){let r=new n(e.id,t,void 0,e.updatable);return r._loadedUniqueId=e.uniqueId,St&&St.AddTagsTo(r,e.tags),e.delayLoadingFile?(r.delayLoadState=4,r.delayLoadingFile=i+e.delayLoadingFile,r._boundingInfo=new es(m.FromArray(e.boundingBoxMinimum),m.FromArray(e.boundingBoxMaximum)),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(T.UVKind),e.hasUVs2&&r._delayInfo.push(T.UV2Kind),e.hasUVs3&&r._delayInfo.push(T.UV3Kind),e.hasUVs4&&r._delayInfo.push(T.UV4Kind),e.hasUVs5&&r._delayInfo.push(T.UV5Kind),e.hasUVs6&&r._delayInfo.push(T.UV6Kind),e.hasColors&&r._delayInfo.push(T.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(T.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(T.MatricesWeightsKind),r._delayLoadingFunction=K.ImportVertexData):K.ImportVertexData(e,r),t.pushGeometry(r,!0),r}};var cr=class n extends Re{get subMaterials(){return this._subMaterials}set subMaterials(e){this._subMaterials=e,this._hookArray(e)}getChildren(){return this.subMaterials}constructor(e,t){super(e,t,!0),this._waitingSubMaterialsUniqueIds=[],this.getScene().addMultiMaterial(this),this.subMaterials=[],this._storeEffectOnSubMeshes=!0}_hookArray(e){let t=e.push;e.push=(...r)=>{let s=t.apply(e,r);return this._markAllSubMeshesAsTexturesDirty(),s};let i=e.splice;e.splice=(r,s)=>{let o=i.apply(e,[r,s]);return this._markAllSubMeshesAsTexturesDirty(),o}}getSubMaterial(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map(e=>e?e.getActiveTextures():[]))}hasTexture(e){if(super.hasTexture(e))return!0;for(let t=0;t<this.subMaterials.length;t++)if(this.subMaterials[t]?.hasTexture(e))return!0;return!1}getClassName(){return"MultiMaterial"}isReadyForSubMesh(e,t,i){for(let r=0;r<this.subMaterials.length;r++){let s=this.subMaterials[r];if(s){if(s._storeEffectOnSubMeshes){if(!s.isReadyForSubMesh(e,t,i))return!1;continue}if(!s.isReady(e))return!1}}return!0}clone(e,t){let i=new n(e,this.getScene());for(let r=0;r<this.subMaterials.length;r++){let s=null,o=this.subMaterials[r];t&&o?s=o.clone(e+"-"+o.name):s=this.subMaterials[r],i.subMaterials.push(s)}return i}serialize(){let e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,St&&(e.tags=St.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(let t=0;t<this.subMaterials.length;t++){let i=this.subMaterials[t];i?(e.materialsUniqueIds.push(i.uniqueId),e.materials.push(i.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e}dispose(e,t,i){let r=this.getScene();if(!r)return;if(i)for(let o=0;o<this.subMaterials.length;o++){let a=this.subMaterials[o];a&&a.dispose(e,t)}let s=r.multiMaterials.indexOf(this);s>=0&&r.multiMaterials.splice(s,1),super.dispose(e,t)}static ParseMultiMaterial(e,t){let i=new n(e.name,t);if(i.id=e.id,i._loadedUniqueId=e.uniqueId,St&&St.AddTagsTo(i,e.tags),e.materialsUniqueIds)i._waitingSubMaterialsUniqueIds=e.materialsUniqueIds;else for(let r of e.materials)i.subMaterials.push(t.getLastMaterialById(r));return i}};le("BABYLON.MultiMaterial",cr);var Op=class{constructor(e,t){this.distanceOrScreenCoverage=e,this.mesh=t}};var Pl=class{},Pb=class{constructor(){this.batchCache=new Np(this),this.batchCacheReplacementModeInFrozenMode=new Np(this),this.instancesBufferSize=512*4}},Ob=class{constructor(){this.renderPasses={}}},Np=class{constructor(e){this.parent=e,this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=[],this.hardwareInstancedRendering=[]}},Nb=class{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=512,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}},Fb=class{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0,this._overrideRenderingFillMode=null}},zr={source:null,parent:null,doNotCloneChildren:!1,clonePhysicsImpostor:!0,cloneThinInstances:!1},E=class n extends _n{static _GetDefaultSideOrientation(e){return e||n.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels()}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(T.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(T.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new F),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new F),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new F),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new F),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new F),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){return(this.forcedInstanceCount||this._thinInstanceDataStorage.instancesCount||0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e}get sideOrientation(){return this._internalMeshDataInfo._sideOrientation}set sideOrientation(e){this._internalMeshDataInfo._sideOrientation=e,this._internalAbstractMeshDataInfo._sideOrientationHint=this._scene.useRightHandedSystem&&e===1||!this._scene.useRightHandedSystem&&e===0}get _effectiveSideOrientation(){return this._internalMeshDataInfo._effectiveSideOrientation}get overrideMaterialSideOrientation(){return this.sideOrientation}set overrideMaterialSideOrientation(e){this.sideOrientation=e,this.material&&(this.material.sideOrientation=null)}get overrideRenderingFillMode(){return this._internalMeshDataInfo._overrideRenderingFillMode}set overrideRenderingFillMode(e){this._internalMeshDataInfo._overrideRenderingFillMode=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){e&&(this.material&&this.material.sideOrientation===null||this._internalAbstractMeshDataInfo._sideOrientationHint)&&(e.sideOrientation=null),this._setMaterial(e)}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){let e=this._instanceDataStorage.renderPasses[this._instanceDataStorage.engine.isWebGPU?this._instanceDataStorage.engine.currentRenderPassId:0];return e?e.instancesData:void 0}get previousWorldMatrixInstancedBuffer(){let e=this._instanceDataStorage.renderPasses[this._instanceDataStorage.engine.isWebGPU?this._instanceDataStorage.engine.currentRenderPassId:0];return e?e.instancesPreviousData:void 0}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(e){this._instanceDataStorage.forceMatrixUpdates=e}_copySource(e,t,i=!0,r=!1){let s=this.getScene();if(e._geometry&&e._geometry.applyToMesh(this),Tt.DeepCopy(e,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo","physicsBody","physicsImpostor"],["_poseMatrix"]),this._internalMeshDataInfo._source=e,s.useClonedMeshMap&&(e._internalMeshDataInfo.meshMap||(e._internalMeshDataInfo.meshMap={}),e._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=e._originalBuilderSideOrientation,this._creationDataStorage=e._creationDataStorage,e._ranges){let o=e._ranges;for(let a in o)Object.prototype.hasOwnProperty.call(o,a)&&o[a]&&this.createAnimationRange(a,o[a].from,o[a].to)}if(e.metadata&&e.metadata.clone?this.metadata=e.metadata.clone():this.metadata=e.metadata,this._internalMetadata=e._internalMetadata,St&&St.HasTags(e)&&St.AddTagsTo(this,St.GetTags(e,!0)),this.setEnabled(e.isEnabled(!1)),this.parent=e.parent,this.setPivotMatrix(e.getPivotMatrix(),this._postMultiplyPivotMatrix),this.id=this.name+"."+e.id,this.material=e.material,!t){let o=e.getDescendants(!0);for(let a=0;a<o.length;a++){let l=o[a];l._isMesh?(zr.parent=this,zr.doNotCloneChildren=t,zr.clonePhysicsImpostor=i,zr.cloneThinInstances=r,l.clone(this.name+"."+l.name,zr)):l.clone&&l.clone(this.name+"."+l.name,this)}}if(e.morphTargetManager&&(this.morphTargetManager=e.morphTargetManager),s.getPhysicsEngine){let o=s.getPhysicsEngine();if(i&&o)if(o.getPluginVersion()===1){let a=o.getImpostorForPhysicsObject(e);a&&(this.physicsImpostor=a.clone(this))}else o.getPluginVersion()===2&&e.physicsBody&&e.physicsBody.clone(this)}for(let o=0;o<s.particleSystems.length;o++){let a=s.particleSystems[o];a.emitter===e&&a.clone(a.name,this)}if(this.skeleton=e.skeleton,r&&(e._thinInstanceDataStorage.matrixData?(this.thinInstanceSetBuffer("matrix",new Float32Array(e._thinInstanceDataStorage.matrixData),16,!e._thinInstanceDataStorage.matrixBuffer.isUpdatable()),this._thinInstanceDataStorage.matrixBufferSize=e._thinInstanceDataStorage.matrixBufferSize,this._thinInstanceDataStorage.instancesCount=e._thinInstanceDataStorage.instancesCount):this._thinInstanceDataStorage.matrixBufferSize=e._thinInstanceDataStorage.matrixBufferSize,e._userThinInstanceBuffersStorage)){let o=e._userThinInstanceBuffersStorage;for(let a in o.data)this.thinInstanceSetBuffer(a,new Float32Array(o.data[a]),o.strides[a],!o.vertexBuffers?.[a]?.isUpdatable()),this._userThinInstanceBuffersStorage.sizes[a]=o.sizes[a]}this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}constructor(e,t=null,i=null,r=null,s,o=!0){super(e,t),this._internalMeshDataInfo=new Fb,this.delayLoadState=0,this.instances=[],this._creationDataStorage=null,this._geometry=null,this._thinInstanceDataStorage=new Nb,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=n.DEFAULTSIDE,this.ignoreCameraMaxZ=!1,t=this.getScene(),this._instanceDataStorage=new Ob,this._instanceDataStorage.engine=t.getEngine(),this._scene.useRightHandedSystem?this.sideOrientation=0:this.sideOrientation=1,this._onBeforeDraw=(c,u,h)=>{c&&h&&(this._uniformBuffer?this.transferToEffect(u):h.bindOnlyWorldMatrix(u))};let a=null,l=!1;if(i&&i._addToSceneRootNodes===void 0){let c=i;a=c.parent??null,r=c.source??null,s=c.doNotCloneChildren??!1,o=c.clonePhysicsImpostor??!0,l=c.cloneThinInstances??!1}else a=i;r&&this._copySource(r,s,o,l),a!==null&&(this.parent=a),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=c=>{c.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add(()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))}))},this.onMeshReadyObservable=new F(this._internalMeshDataInfo._onMeshReadyObserverAdded),r&&r.onClonedObservable.notifyObservers(this)}instantiateHierarchy(e=null,t,i){let r=this.getTotalVertices()===0||t&&t.doNotInstantiate&&(t.doNotInstantiate===!0||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));r.parent=e||this.parent,r.position=this.position.clone(),r.scaling=this.scaling.clone(),this.rotationQuaternion?r.rotationQuaternion=this.rotationQuaternion.clone():r.rotation=this.rotation.clone(),i&&i(this,r);for(let s of this.getChildTransformNodes(!0))s.getClassName()==="InstancedMesh"&&r.getClassName()==="Mesh"&&s.sourceMesh===this?s.instantiateHierarchy(r,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:r},i):s.instantiateHierarchy(r,t,i);return r}getClassName(){return"Mesh"}get _isMesh(){return!0}toString(e){let t=super.toString(e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);if(e)if(this._geometry){let i=this.getIndices(),r=this.getVerticesData(T.PositionKind);r&&i&&(t+=", flat shading: "+(r.length/3===i.length?"YES":"NO"))}else t+=", flat shading: UNKNOWN";return t}_unBindEffect(){super._unBindEffect();for(let e of this.instances)e._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){let e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort((t,i)=>t.distanceOrScreenCoverage<i.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>i.distanceOrScreenCoverage?-e:0)}addLODLevel(e,t){if(t&&t._masterMesh)return P.Warn("You cannot use a mesh as LOD level twice"),this;let i=new Op(e,t);return this._internalMeshDataInfo._LODLevels.push(i),t&&(t._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){let t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++){let r=t._LODLevels[i];if(r.distanceOrScreenCoverage===e)return r.mesh}return null}removeLODLevel(e){let t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++)t._LODLevels[i].mesh===e&&(t._LODLevels.splice(i,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,t){let i=this._internalMeshDataInfo;if(!i._LODLevels||i._LODLevels.length===0)return this;let r=t||this.getBoundingInfo().boundingSphere,s=e.mode===Fe.ORTHOGRAPHIC_CAMERA?e.minZ:r.centerWorld.subtract(e.globalPosition).length(),o=s,a=1;if(i._useLODScreenCoverage){let l=e.screenArea,c=r.radiusWorld*e.minZ/s;c=c*c*Math.PI,o=c/l,a=-1}if(a*i._LODLevels[i._LODLevels.length-1].distanceOrScreenCoverage>a*o)return this.onLODLevelSelection&&this.onLODLevelSelection(o,this,this),this;for(let l=0;l<i._LODLevels.length;l++){let c=i._LODLevels[l];if(a*c.distanceOrScreenCoverage<a*o){if(c.mesh){if(c.mesh.delayLoadState===4)return c.mesh._checkDelayState(),this;if(c.mesh.delayLoadState===2)return this;c.mesh._preActivate(),c.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(o,this,c.mesh),c.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(o,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return this._geometry===null||this._geometry===void 0?0:this._geometry.getTotalVertices()}getVerticesData(e,t,i,r){if(!this._geometry)return null;let s=r?void 0:this._userInstancedBuffersStorage?.vertexBuffers[e]?.getFloatData(this.instances.length+1,i||t&&this._geometry.meshes.length!==1);return s||(s=this._geometry.getVerticesData(e,t,i)),s}copyVerticesData(e,t){this._geometry&&this._geometry.copyVerticesData(e,t)}getVertexBuffer(e,t){return this._geometry?(t?void 0:this._userInstancedBuffersStorage?.vertexBuffers[e])??this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e,t){return this._geometry?!t&&this._userInstancedBuffersStorage?.vertexBuffers[e]!==void 0||this._geometry.isVerticesDataPresent(e):this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}isVertexBufferUpdatable(e,t){if(!this._geometry)return this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1;if(!t){let i=this._userInstancedBuffersStorage?.vertexBuffers[e];if(i)return i.isUpdatable()}return this._geometry.isVertexBufferUpdatable(e)}getVerticesDataKinds(e){if(!this._geometry){let i=[];if(this._delayInfo)for(let r of this._delayInfo)i.push(r);return i}let t=this._geometry.getVerticesDataKinds();if(!e&&this._userInstancedBuffersStorage)for(let i in this._userInstancedBuffersStorage.vertexBuffers)t.indexOf(i)===-1&&t.push(i);return t}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}get isBlocked(){return this._masterMesh!==null&&this._masterMesh!==void 0}isReady(e=!1,t=!1){if(this.delayLoadState===2||!super.isReady(e))return!1;if(!this.subMeshes||this.subMeshes.length===0||!e)return!0;let i=this.getEngine(),r=this.getScene(),s=t||i.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();let o=this.material||r.defaultMaterial;if(o){if(o._storeEffectOnSubMeshes)for(let l of this.subMeshes){let c=l.getMaterial();if(c){if(c._storeEffectOnSubMeshes){if(!c.isReadyForSubMesh(this,l,s))return!1}else if(!c.isReady(this,s))return!1}}else if(!o.isReady(this,s))return!1}let a=i.currentRenderPassId;for(let l of this.lightSources){let c=l.getShadowGenerators();if(!c)continue;let u=c.values();for(let h=u.next();h.done!==!0;h=u.next()){let d=h.value;if(d&&(!d.getShadowMap()?.renderList||d.getShadowMap()?.renderList&&d.getShadowMap()?.renderList?.indexOf(this)!==-1)){let p=d.getShadowMap().renderPassIds??[i.currentRenderPassId];for(let g=0;g<p.length;++g){i.currentRenderPassId=p[g];for(let _ of this.subMeshes)if(!d.isReady(_,s,_.getMaterial()?.needAlphaBlendingForMesh(this)??!1))return i.currentRenderPassId=a,!1}i.currentRenderPassId=a}}}for(let l of this._internalMeshDataInfo._LODLevels)if(l.mesh&&!l.mesh.isReady(s))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e}_getInstanceDataStorage(){let e=this._instanceDataStorage.engine.isWebGPU?this._instanceDataStorage.engine.currentRenderPassId:0,t=this._instanceDataStorage.renderPasses[e];return t||(t=new Pb,this._instanceDataStorage.renderPasses[e]=t),t}_preActivate(){let e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t?this:(e._preActivateId=t,this._getInstanceDataStorage().visibleInstances=null,this)}_preActivateForIntermediateRendering(e){let t=this._getInstanceDataStorage();return t.visibleInstances&&(t.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,t){let i=this._getInstanceDataStorage();return i.visibleInstances||(i.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId,intermediateDefaultRenderId:-1}),i.visibleInstances[t]||(i.previousRenderId!==void 0&&this._instanceDataStorage.isFrozen&&(i.visibleInstances[i.previousRenderId]=null),i.previousRenderId=t,i.visibleInstances[t]=new Array),i.visibleInstances[t].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let i;typeof e=="object"?i=e:i={applySkeleton:e,applyMorph:t};let r=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getData(i,null,T.PositionKind),r),this}_createGlobalSubMesh(e){let t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){let i=this.getIndices();if(!i)return null;let r=i.length,s=!1;if(e)s=!0;else for(let o of this.subMeshes){if(o.indexStart+o.indexCount>r){s=!0;break}if(o.verticesStart+o.verticesCount>t){s=!0;break}}if(!s)return this.subMeshes[0]}return this.releaseSubMeshes(),new Xi(0,0,t,0,this.getTotalIndices()||(this.isUnIndexed?t:0),this)}subdivide(e){if(e<1)return;let t=this.getTotalIndices(),i=t/e|0,r=0;for(;i%3!==0;)i++;this.releaseSubMeshes();for(let s=0;s<e&&!(r>=t);s++)Xi.CreateFromIndices(0,r,s===e-1?t-r:i,this,void 0,!1),r+=i;this.refreshBoundingInfo(),this.synchronizeInstances()}setVerticesData(e,t,i=!1,r){if(this._geometry)this._geometry.setVerticesData(e,t,i,r);else{let s=new K;s.set(t,e);let o=this.getScene();new Lt(Lt.RandomId(),o,s,i,this)}return this}removeVerticesData(e){this._geometry&&this._geometry.removeVerticesData(e)}markVerticesDataAsUpdatable(e,t=!0){let i=this.getVertexBuffer(e);!i||i.isUpdatable()===t||this.setVerticesData(e,this.getVerticesData(e),t)}setVerticesBuffer(e,t=!0){return this._geometry||(this._geometry=Lt.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}updateVerticesData(e,t,i,r){return this._geometry?(r?(this.makeGeometryUnique(),this.updateVerticesData(e,t,i,!1)):this._geometry.updateVerticesData(e,t,i),this):this}updateMeshPositions(e,t=!0){let i=this.getVerticesData(T.PositionKind);if(!i)return this;if(e(i),this.updateVerticesData(T.PositionKind,i,!1,!1),t){let r=this.getIndices(),s=this.getVerticesData(T.NormalKind);if(!s)return this;K.ComputeNormals(i,r,s),this.updateVerticesData(T.NormalKind,s,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry)return this;if(this._geometry.meshes.length===1)return this;let e=this._geometry,t=this._geometry.copy(Lt.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}setIndexBuffer(e,t,i,r=null){let s=this._geometry;s||(s=new Lt(Lt.RandomId(),this.getScene(),void 0,void 0,this)),s.setIndexBuffer(e,t,i,r)}setIndices(e,t=null,i=!1,r=!1){if(this._geometry)this._geometry.setIndices(e,t,i,r);else{let s=new K;s.indices=e;let o=this.getScene();new Lt(Lt.RandomId(),o,s,i,this)}return this}updateIndices(e,t,i=!1){return this._geometry?(this._geometry.updateIndices(e,t,i),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(e,t,i,r=!0){if(!this._geometry)return this;let s=this.getScene().getEngine(),o;if(this._unIndexed)switch(this._getRenderingFillMode(i)){case Re.WireFrameFillMode:o=e._getLinesIndexBuffer(this.getIndices(),s);break;default:o=null;break}else switch(this._getRenderingFillMode(i)){case Re.PointFillMode:o=null;break;case Re.WireFrameFillMode:o=e._getLinesIndexBuffer(this.getIndices(),s);break;default:case Re.TriangleFillMode:o=this._geometry.getIndexBuffer();break}return this._bindDirect(t,o,r)}_bindDirect(e,t,i=!0){if(!this._geometry)return this;if(this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(e),!i||!this._userInstancedBuffersStorage||this.hasThinInstances)this._geometry._bind(e,t);else{if(this._instanceDataStorage.engine.isWebGPU&&this._userInstancedBuffersStorage.renderPasses&&this._userInstancedBuffersStorage.renderPasses[this._instanceDataStorage.engine.currentRenderPassId]){let r=this._userInstancedBuffersStorage.renderPasses[this._instanceDataStorage.engine.currentRenderPassId];for(let s in r)this._userInstancedBuffersStorage.vertexBuffers[s]=r[s]}this._geometry._bind(e,t,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects)}return this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);let s=this.getScene().getEngine(),o=s._currentMaterialContext,a=o&&o.useVertexPulling;return this._unIndexed&&t!==Re.WireFrameFillMode||t==Re.PointFillMode?s.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||i):t==Re.WireFrameFillMode?s.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||i):a?s.drawArraysType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i):s.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,t=!1){let i=this._getInstanceDataStorage();if(this._instanceDataStorage.isFrozen){if(t)return i.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,i.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,i.batchCacheReplacementModeInFrozenMode;if(i.previousBatch)return i.previousBatch}let r=this.getScene(),s=r._isInIntermediateRendering(),o=s?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,a=i.batchCache;if(a.mustReturn=!1,a.renderSelf[e]=t||!o&&this.isEnabled()&&this.isVisible,a.visibleInstances[e]=null,i.visibleInstances&&!t){let l=i.visibleInstances,c=r.getRenderId(),u=s?l.intermediateDefaultRenderId:l.defaultRenderId;a.visibleInstances[e]=l[c],!a.visibleInstances[e]&&u&&(a.visibleInstances[e]=l[u])}return a.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&a.visibleInstances[e]!==null&&a.visibleInstances[e]!==void 0,i.previousBatch=a,a}_updateInstancedBuffers(e,t,i,r,s,o){let a=t.visibleInstances[e._id],l=a?a.length:0,c=t.parent,u=this._instanceDataStorage,h=c.instancesBuffer,d=c.instancesPreviousBuffer,f=0,p=0,g=t.renderSelf[e._id],_=this._scene.floatingOriginOffset,y=!h||i!==c.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!c.instancesPreviousBuffer;if(!this._instanceDataStorage.manualUpdate&&(!u.isFrozen||y)){let b=this.getWorldMatrix();if(g&&(this._scene.needsPreviousWorldMatrices&&(u.masterMeshPreviousWorldMatrix?(u.masterMeshPreviousWorldMatrix.copyToArray(c.instancesPreviousData,f),u.masterMeshPreviousWorldMatrix.copyFrom(b)):(u.masterMeshPreviousWorldMatrix=b.clone(),u.masterMeshPreviousWorldMatrix.copyToArray(c.instancesPreviousData,f))),b.copyToArray(c.instancesData,f),c.instancesData[f+12]-=_.x,c.instancesData[f+13]-=_.y,c.instancesData[f+14]-=_.z,f+=16,p++),a){if(n.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&e.getMaterial()?.needAlphaBlendingForMesh(e.getRenderingMesh())){let A=this._scene.activeCamera.globalPosition;for(let I=0;I<a.length;I++){let v=a[I];v._distanceToCamera=m.Distance(v.getBoundingInfo().boundingSphere.centerWorld,A)}a.sort((I,v)=>I._distanceToCamera>v._distanceToCamera?-1:I._distanceToCamera<v._distanceToCamera?1:0)}for(let A=0;A<a.length;A++){let I=a[A],v=I.getWorldMatrix();v.copyToArray(c.instancesData,f),this._scene.needsPreviousWorldMatrices&&(I._previousWorldMatrix?(I._previousWorldMatrix.copyToArray(c.instancesPreviousData,f),I._previousWorldMatrix.copyFrom(v)):(I._previousWorldMatrix=v.clone(),I._previousWorldMatrix.copyToArray(c.instancesPreviousData,f))),c.instancesData[f+12]-=_.x,c.instancesData[f+13]-=_.y,c.instancesData[f+14]-=_.z,f+=16,p++}}}else p=(g?1:0)+l;if(y){h&&h.dispose(),d&&d.dispose(),h=new ei(r,c.instancesData,!0,16,!1,!0),c.instancesBuffer=h,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0});let b;if(this._instanceDataStorage.engine.isWebGPU){this._userInstancedBuffersStorage.renderPasses||(this._userInstancedBuffersStorage.renderPasses={});let A=this._instanceDataStorage.engine.currentRenderPassId;b=this._userInstancedBuffersStorage.renderPasses[A],b||(this._userInstancedBuffersStorage.renderPasses[A]=b={})}else b=this._userInstancedBuffersStorage.vertexBuffers;b.world0=h.createVertexBuffer("world0",0,4),b.world1=h.createVertexBuffer("world1",4,4),b.world2=h.createVertexBuffer("world2",8,4),b.world3=h.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(d=new ei(r,c.instancesPreviousData,!0,16,!1,!0),c.instancesPreviousBuffer=d,b.previousWorld0=d.createVertexBuffer("previousWorld0",0,4),b.previousWorld1=d.createVertexBuffer("previousWorld1",4,4),b.previousWorld2=d.createVertexBuffer("previousWorld2",8,4),b.previousWorld3=d.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()}else(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&(h.updateDirectly(c.instancesData,0,p),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&d.updateDirectly(c.instancesPreviousData,0,p));this._processInstancedBuffers(a,g),o&&s!==void 0&&(this.getScene()._activeIndices.addCount(e.indexCount*p,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(e,o,s),this._draw(e,s,p)),this._scene.needsPreviousWorldMatrices&&!y&&this._instanceDataStorage.manualUpdate&&(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&!this._instanceDataStorage.previousManualUpdate&&d.updateDirectly(c.instancesData,0,p)}_renderWithInstances(e,t,i,r,s){let o=i.visibleInstances[e._id],a=o?o.length:0,l=i.parent,c=l.instancesBufferSize,h=(a+1)*16*4;for(;l.instancesBufferSize<h;)l.instancesBufferSize*=2;return(!l.instancesData||c!=l.instancesBufferSize)&&(l.instancesData=new Float32Array(l.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!l.instancesPreviousData||c!=l.instancesBufferSize)&&(l.instancesPreviousData=new Float32Array(l.instancesBufferSize/4)),this._updateInstancedBuffers(e,i,c,s,t,r),s.unbindInstanceAttributes(),this}_renderWithThinInstances(e,t,i,r){let s=this._thinInstanceDataStorage?.instancesCount??0;this.getScene()._activeIndices.addCount(e.indexCount*s,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(e,i,t),this._draw(e,t,s),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,s):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),r.unbindInstanceAttributes()}_processInstancedBuffers(e,t){}_processRendering(e,t,i,r,s,o,a,l){let c=this.getScene(),u=c.getEngine();if(r=this._getRenderingFillMode(r),o&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,r,i,u),this;if(o)this._renderWithInstances(t,r,s,i,u);else{u._currentDrawContext&&(u._currentDrawContext.useInstancing=!1);let h=0;s.renderSelf[t._id]&&(a&&a(!1,e.getWorldMatrix(),l),h++,this._draw(t,r,this._instanceDataStorage.overridenInstanceCount));let d=s.visibleInstances[t._id];if(d){let f=d.length;h+=f;for(let p=0;p<f;p++){let _=d[p].getWorldMatrix();a&&a(!0,_,l),this._draw(t,r)}}c._activeIndices.addCount(t.indexCount*h,!1)}return this}_rebuild(e=!1){for(let t in this._instanceDataStorage.renderPasses){let i=this._instanceDataStorage.renderPasses[t];i.instancesBuffer&&(e&&i.instancesBuffer.dispose(),i.instancesBuffer=null)}if(this._userInstancedBuffersStorage){for(let t in this._userInstancedBuffersStorage.vertexBuffers){let i=this._userInstancedBuffersStorage.vertexBuffers[t];i&&(e&&i.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e)}_freeze(){if(this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1;for(let e in this._instanceDataStorage.renderPasses){let t=this._instanceDataStorage.renderPasses[e];t.previousBatch=null}}renderWithRenderPassId(e,t,i,r,s=!0){let o=this._scene.getEngine(),a=o.currentRenderPassId;if(e!==void 0&&(o.currentRenderPassId=e),r)(!s||s&&r.isInFrustum(this._scene._frustumPlanes))&&this.render(r,!!t,i);else for(let l=0;l<this.subMeshes.length;l++){let c=this.subMeshes[l];(!s||s&&c.isInFrustum(this._scene._frustumPlanes))&&this.render(c,!!t,i)}return e!==void 0&&(o.currentRenderPassId=a),this}directRender(){if(!this.subMeshes)return this;for(let e of this.subMeshes)this.render(e,!1);return this}render(e,t,i){let r=this.getScene();this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1;let s=r.activeCameras?.length??0;if((s>1&&r.activeCamera===r.activeCameras[0]||s<=1)&&this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;let a=this._getInstancesRenderList(e._id,!!i);if(a.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;let l=r.getEngine(),c=0,u=null;this.ignoreCameraMaxZ&&r.activeCamera&&!r._isInIntermediateRendering()&&(c=r.activeCamera.maxZ,u=r.activeCamera,r.activeCamera.maxZ=0,r.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);let h=e.getRenderingMesh(),d=a.hardwareInstancedRendering[e._id]||h.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,f=this._instanceDataStorage,p=e.getMaterial();if(!p)return u&&(u.maxZ=c,r.updateTransformMatrix(!0)),this;if(!f.isFrozen||!this._internalMeshDataInfo._effectiveMaterial||this._internalMeshDataInfo._effectiveMaterial!==p){if(p._storeEffectOnSubMeshes){if(!p.isReadyForSubMesh(this,e,d))return u&&(u.maxZ=c,r.updateTransformMatrix(!0)),this}else if(!p.isReady(this,d))return u&&(u.maxZ=c,r.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=p}else if(p._storeEffectOnSubMeshes&&!e._drawWrapper?._wasPreviouslyReady||!p._storeEffectOnSubMeshes&&!p._getDrawWrapper()._wasPreviouslyReady)return u&&(u.maxZ=c,r.updateTransformMatrix(!0)),this;if(t){let C=this._internalMeshDataInfo._effectiveMaterial;if(C.alphaModes.length===1)l.setAlphaMode(C.alphaMode);else for(let R=0;R<C.alphaModes.length;R++){let M=C.alphaModes[R];l.setAlphaMode(M!==void 0?M:2,!1,R)}}let g;this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?g=e._drawWrapper:g=this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();let _=g?.effect??null;for(let C of r._beforeRenderingMeshStage)C.action(this,e,a,_);if(!g||!_)return u&&(u.maxZ=c,r.updateTransformMatrix(!0)),this;let y=i||this,b;if(!f.isFrozen&&(this._internalMeshDataInfo._effectiveMaterial.backFaceCulling||this._internalMeshDataInfo._effectiveMaterial.sideOrientation!==null||this._internalMeshDataInfo._effectiveMaterial._twoSidedLighting)){let C=y._getWorldMatrixDeterminant();b=this._internalMeshDataInfo._effectiveMaterial._getEffectiveOrientation(this),C<0&&(b=b===Re.ClockWiseSideOrientation?Re.CounterClockWiseSideOrientation:Re.ClockWiseSideOrientation),this._internalMeshDataInfo._effectiveSideOrientation=b}else b=this._internalMeshDataInfo._effectiveSideOrientation;let A=this._internalMeshDataInfo._effectiveMaterial._preBind(g,this._internalMeshDataInfo._effectiveSideOrientation);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&l.setDepthWrite(!0);let I=this._internalMeshDataInfo._effectiveMaterial,v=I.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),d||this._bind(e,_,v,!1);let x=y.getWorldMatrix();I._storeEffectOnSubMeshes?I.bindForSubMesh(x,this,e):I.bind(x,this),!I.backFaceCulling&&I.separateCullingPass&&(l.setState(!0,I.zOffset,!1,!A,I.cullBackFaces,I.stencil,I.zOffsetUnits),this._processRendering(this,e,_,v,a,d,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),l.setState(!0,I.zOffset,!1,A,I.cullBackFaces,I.stencil,I.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,_,v,a,d,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(let C of r._afterRenderingMeshStage)C.action(this,e,a,_);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),u&&(u.maxZ=c,r.updateTransformMatrix(!0)),r.performancePriority===2&&!f.isFrozen&&this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(T.MatricesWeightsKind)&&(this.isVerticesDataPresent(T.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){let e=this.getVerticesData(T.MatricesWeightsKind),t=e.length;for(let i=0;i<t;i+=4){let r=e[i]+e[i+1]+e[i+2]+e[i+3];if(r===0)e[i]=1;else{let s=1/r;e[i]*=s,e[i+1]*=s,e[i+2]*=s,e[i+3]*=s}}this.setVerticesData(T.MatricesWeightsKind,e)}_normalizeSkinWeightsAndExtra(){let e=this.getVerticesData(T.MatricesWeightsExtraKind),t=this.getVerticesData(T.MatricesWeightsKind),i=t.length;for(let r=0;r<i;r+=4){let s=t[r]+t[r+1]+t[r+2]+t[r+3];if(s+=e[r]+e[r+1]+e[r+2]+e[r+3],s===0)t[r]=1;else{let o=1/s;t[r]*=o,t[r+1]*=o,t[r+2]*=o,t[r+3]*=o,e[r]*=o,e[r+1]*=o,e[r+2]*=o,e[r+3]*=o}}this.setVerticesData(T.MatricesWeightsKind,t),this.setVerticesData(T.MatricesWeightsKind,e)}validateSkinning(){let e=this.getVerticesData(T.MatricesWeightsExtraKind),t=this.getVerticesData(T.MatricesWeightsKind);if(t===null||this.skeleton==null)return{skinned:!1,valid:!0,report:"not skinned"};let i=t.length,r=0,s=0,o=0,a=0,l=e===null?4:8,c=[];for(let _=0;_<=l;_++)c[_]=0;let u=.001;for(let _=0;_<i;_+=4){let y=t[_],b=y,A=b===0?0:1;for(let I=1;I<l;I++){let v=I<4?t[_+I]:e[_+I-4];v>y&&r++,v!==0&&A++,b+=v,y=v}if(c[A]++,A>o&&(o=A),b===0)s++;else{let I=1/b,v=0;for(let x=0;x<l;x++)x<4?v+=Math.abs(t[_+x]-t[_+x]*I):v+=Math.abs(e[_+x-4]-e[_+x-4]*I);v>u&&a++}}let h=this.skeleton.bones.length,d=this.getVerticesData(T.MatricesIndicesKind),f=this.getVerticesData(T.MatricesIndicesExtraKind),p=0;for(let _=0;_<i;_+=4)for(let y=0;y<l;y++){let b=y<4?d[_+y]:f[_+y-4];(b>=h||b<0)&&p++}let g="Number of Weights = "+i/4+`
Maximum influences = `+o+`
Missing Weights = `+s+`
Not Sorted = `+r+`
Not Normalized = `+a+`
WeightCounts = [`+c+`]
Number of bones = `+h+`
Bad Bone Indices = `+p;return{skinned:!0,valid:s===0&&a===0&&p===0,report:g}}_checkDelayState(){let e=this.getScene();return this._geometry?this._geometry.load(e):this.delayLoadState===4&&(this.delayLoadState=2,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);let t=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;return z.LoadFile(this.delayLoadingFile,i=>{i instanceof ArrayBuffer?this._delayLoadingFunction(i,this):this._delayLoadingFunction(JSON.parse(i),this);for(let r of this.instances)r.refreshBoundingInfo(),r._syncSubMeshes();this.delayLoadState=1,e.removePendingData(this)},()=>{},e.offlineProvider,t),this}isInFrustum(e){return this.delayLoadState===2||!super.isInFrustum(e)?!1:(this._checkDelayState(),!0)}setMaterialById(e){let t=this.getScene().materials,i;for(i=t.length-1;i>-1;i--)if(t[i].id===e)return this.material=t[i],this;let r=this.getScene().multiMaterials;for(i=r.length-1;i>-1;i--)if(r[i].id===e)return this.material=r[i],this;return this}getAnimatables(){let e=[];return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(T.PositionKind))return this;let t=this.subMeshes.splice(0);this._resetPointsArrayCache();let i=this.getVerticesData(T.PositionKind),r=m.Zero(),s;for(s=0;s<i.length;s+=3)m.TransformCoordinatesFromFloatsToRef(i[s],i[s+1],i[s+2],e,r).toArray(i,s);if(this.setVerticesData(T.PositionKind,i,this.getVertexBuffer(T.PositionKind).isUpdatable()),this.isVerticesDataPresent(T.NormalKind)){for(i=this.getVerticesData(T.NormalKind),s=0;s<i.length;s+=3)m.TransformNormalFromFloatsToRef(i[s],i[s+1],i[s+2],e,r).normalize().toArray(i,s);this.setVerticesData(T.NormalKind,i,this.getVertexBuffer(T.NormalKind).isUpdatable())}if(this.isVerticesDataPresent(T.TangentKind)){for(i=this.getVerticesData(T.TangentKind),s=0;s<i.length;s+=4)m.TransformNormalFromFloatsToRef(i[s],i[s+1],i[s+2],e,r).normalize().toArray(i,s);this.setVerticesData(T.TangentKind,i,this.getVertexBuffer(T.TangentKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}bakeCurrentTransformIntoVertices(e=!0,t=!1){return t&&this.makeGeometryUnique(),this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions||this._geometry&&this._geometry._positions||null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return this._geometry?this._geometry._generatePointsArray():!1}clone(e="",t=null,i,r=!0){if(t&&t._addToSceneRootNodes===void 0){let s=t;return zr.source=this,zr.doNotCloneChildren=s.doNotCloneChildren,zr.clonePhysicsImpostor=s.clonePhysicsImpostor,zr.cloneThinInstances=s.cloneThinInstances,new n(e,this.getScene(),zr)}return new n(e,this.getScene(),t,this,i,r)}dispose(e,t=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);let i=this._internalMeshDataInfo;if(i._onBeforeDrawObservable&&i._onBeforeDrawObservable.clear(),i._onBeforeBindObservable&&i._onBeforeBindObservable.clear(),i._onBeforeRenderObservable&&i._onBeforeRenderObservable.clear(),i._onAfterRenderObservable&&i._onAfterRenderObservable.clear(),i._onBetweenPassObservable&&i._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(i.meshMap)for(let r in i.meshMap){let s=i.meshMap[r];s&&(s._internalMeshDataInfo._source=null,i.meshMap[r]=void 0)}i._source&&i._source._internalMeshDataInfo.meshMap&&(i._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{let r=this.getScene().meshes;for(let s of r){let o=s;o._internalMeshDataInfo&&o._internalMeshDataInfo._source&&o._internalMeshDataInfo._source===this&&(o._internalMeshDataInfo._source=null)}}i._source=null,this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,t)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,t,i,r,s,o,a=!1,l){let c=this.getScene(),u=h=>{let d=h.width,f=h.height,g=this.getEngine().createCanvas(d,f).getContext("2d");g.drawImage(h,0,0);let _=g.getImageData(0,0,d,f).data;this.applyDisplacementMapFromBuffer(_,d,f,t,i,s,o,a),r&&r(this)};return z.LoadImage(e,u,l||(()=>{}),c.offlineProvider),this}applyDisplacementMapFromBuffer(e,t,i,r,s,o,a,l=!1){if(!this.isVerticesDataPresent(T.PositionKind)||!this.isVerticesDataPresent(T.NormalKind)||!this.isVerticesDataPresent(T.UVKind))return P.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;let c=this.getVerticesData(T.PositionKind,!0,!0),u=this.getVerticesData(T.NormalKind),h=this.getVerticesData(T.UVKind),d=m.Zero(),f=m.Zero(),p=me.Zero();o=o||me.Zero(),a=a||new me(1,1);for(let g=0;g<c.length;g+=3){m.FromArrayToRef(c,g,d),m.FromArrayToRef(u,g,f),me.FromArrayToRef(h,g/3*2,p);let _=Math.abs(p.x*a.x+o.x%1)*(t-1)%t|0,y=Math.abs(p.y*a.y+o.y%1)*(i-1)%i|0,b=(_+y*t)*4,A=e[b]/255,I=e[b+1]/255,v=e[b+2]/255,x=A*.3+I*.59+v*.11;f.normalize(),f.scaleInPlace(r+(s-r)*x),d=d.add(f),d.toArray(c,g)}return K.ComputeNormals(c,this.getIndices(),u),l?(this.setVerticesData(T.PositionKind,c),this.setVerticesData(T.NormalKind,u),this.setVerticesData(T.UVKind,h)):(this.updateVerticesData(T.PositionKind,c),this.updateVerticesData(T.NormalKind,u)),this}_getFlattenedNormals(e,t){let i=new Float32Array(e.length*3),r=0,s=this.sideOrientation===(this._scene.useRightHandedSystem?1:0);for(let o=0;o<e.length;o+=3){let a=m.FromArray(t,e[o]*3),l=m.FromArray(t,e[o+1]*3),c=m.FromArray(t,e[o+2]*3),u=a.subtract(l),h=c.subtract(l),d=m.Normalize(m.Cross(u,h));s&&d.scaleInPlace(-1);for(let f=0;f<3;f++)i[r++]=d.x,i[r++]=d.y,i[r++]=d.z}return i}_convertToUnIndexedMesh(e=!1){let t=this.getVerticesDataKinds().filter(l=>!this.getVertexBuffer(l)?.getIsInstanced()),i=this.getIndices(),r={},s=(l,c)=>{let u=new Float32Array(i.length*c),h=0;for(let d=0;d<i.length;d++)for(let f=0;f<c;f++)u[h++]=l[i[d]*c+f];return u},o=this.getBoundingInfo(),a=this.geometry?this.subMeshes.slice(0):[];for(let l of t)r[l]=this.getVerticesData(l);for(let l of t){let c=this.getVertexBuffer(l),u=c.getSize();if(e&&l===T.NormalKind){let h=this._getFlattenedNormals(i,r[T.PositionKind]);this.setVerticesData(T.NormalKind,h,c.isUpdatable(),u)}else this.setVerticesData(l,s(r[l],u),c.isUpdatable(),u)}if(this.morphTargetManager){for(let l=0;l<this.morphTargetManager.numTargets;l++){let c=this.morphTargetManager.getTarget(l),u=c.getPositions();c.setPositions(s(u,3));let h=c.getNormals();h&&c.setNormals(e?this._getFlattenedNormals(i,u):s(h,3));let d=c.getTangents();d&&c.setTangents(s(d,3));let f=c.getUVs();f&&c.setUVs(s(f,2));let p=c.getColors();p&&c.setColors(s(p,4))}this.morphTargetManager.synchronize()}for(let l=0;l<i.length;l++)i[l]=l;this.setIndices(i),this._unIndexed=!0,this.releaseSubMeshes();for(let l of a){let c=l.getBoundingInfo();Xi.AddToMesh(l.materialIndex,l.indexStart,l.indexCount,l.indexStart,l.indexCount,this).setBoundingInfo(c)}return this.setBoundingInfo(o),this.synchronizeInstances(),this}convertToFlatShadedMesh(){return this._convertToUnIndexedMesh(!0)}convertToUnIndexedMesh(){return this._convertToUnIndexedMesh()}flipFaces(e=!1){let t=K.ExtractFromMesh(this),i;if(e&&this.isVerticesDataPresent(T.NormalKind)&&t.normals){for(i=0;i<t.normals.length;i++)t.normals[i]*=-1;this.setVerticesData(T.NormalKind,t.normals,this.isVertexBufferUpdatable(T.NormalKind))}if(t.indices){let r;for(i=0;i<t.indices.length;i+=3)r=t.indices[i+1],t.indices[i+1]=t.indices[i+2],t.indices[i+2]=r;this.setIndices(t.indices,null,this.isVertexBufferUpdatable(T.PositionKind),!0)}return this}increaseVertices(e=1){let t=K.ExtractFromMesh(this),i=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,r=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,s=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,o=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(!i||!r)P.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions");else{t.indices=i,t.positions=r,s&&(t.uvs=s),o&&(t.normals=o);let a=e+1,l=[];for(let v=0;v<a+1;v++)l[v]=[];let c,u,h=new m(0,0,0),d=new m(0,0,0),f=new me(0,0),p=[],g=[],_=[],y,b=r.length,A;s&&(A=s.length);let I;o&&(I=o.length);for(let v=0;v<i.length;v+=3){g[0]=i[v],g[1]=i[v+1],g[2]=i[v+2];for(let x=0;x<3;x++)if(c=g[x],u=g[(x+1)%3],_[c]===void 0&&_[u]===void 0?(_[c]=[],_[u]=[]):(_[c]===void 0&&(_[c]=[]),_[u]===void 0&&(_[u]=[])),_[c][u]===void 0&&_[u][c]===void 0){_[c][u]=[],h.x=(r[3*u]-r[3*c])/a,h.y=(r[3*u+1]-r[3*c+1])/a,h.z=(r[3*u+2]-r[3*c+2])/a,o&&(d.x=(o[3*u]-o[3*c])/a,d.y=(o[3*u+1]-o[3*c+1])/a,d.z=(o[3*u+2]-o[3*c+2])/a),s&&(f.x=(s[2*u]-s[2*c])/a,f.y=(s[2*u+1]-s[2*c+1])/a),_[c][u].push(c);for(let C=1;C<a;C++)_[c][u].push(r.length/3),r[b++]=r[3*c]+C*h.x,r[b++]=r[3*c+1]+C*h.y,r[b++]=r[3*c+2]+C*h.z,o&&(o[I++]=o[3*c]+C*d.x,o[I++]=o[3*c+1]+C*d.y,o[I++]=o[3*c+2]+C*d.z),s&&(s[A++]=s[2*c]+C*f.x,s[A++]=s[2*c+1]+C*f.y);_[c][u].push(u),_[u][c]=[],y=_[c][u].length;for(let C=0;C<y;C++)_[u][c][C]=_[c][u][y-1-C]}l[0][0]=i[v],l[1][0]=_[i[v]][i[v+1]][1],l[1][1]=_[i[v]][i[v+2]][1];for(let x=2;x<a;x++){l[x][0]=_[i[v]][i[v+1]][x],l[x][x]=_[i[v]][i[v+2]][x],h.x=(r[3*l[x][x]]-r[3*l[x][0]])/x,h.y=(r[3*l[x][x]+1]-r[3*l[x][0]+1])/x,h.z=(r[3*l[x][x]+2]-r[3*l[x][0]+2])/x,o&&(d.x=(o[3*l[x][x]]-o[3*l[x][0]])/x,d.y=(o[3*l[x][x]+1]-o[3*l[x][0]+1])/x,d.z=(o[3*l[x][x]+2]-o[3*l[x][0]+2])/x),s&&(f.x=(s[2*l[x][x]]-s[2*l[x][0]])/x,f.y=(s[2*l[x][x]+1]-s[2*l[x][0]+1])/x);for(let C=1;C<x;C++)l[x][C]=r.length/3,r[b++]=r[3*l[x][0]]+C*h.x,r[b++]=r[3*l[x][0]+1]+C*h.y,r[b++]=r[3*l[x][0]+2]+C*h.z,o&&(o[I++]=o[3*l[x][0]]+C*d.x,o[I++]=o[3*l[x][0]+1]+C*d.y,o[I++]=o[3*l[x][0]+2]+C*d.z),s&&(s[A++]=s[2*l[x][0]]+C*f.x,s[A++]=s[2*l[x][0]+1]+C*f.y)}l[a]=_[i[v+1]][i[v+2]],p.push(l[0][0],l[1][0],l[1][1]);for(let x=1;x<a;x++){let C;for(C=0;C<x;C++)p.push(l[x][C],l[x+1][C],l[x+1][C+1]),p.push(l[x][C],l[x+1][C+1],l[x][C+1]);p.push(l[x][C],l[x+1][C],l[x+1][C+1])}}t.indices=p,t.applyToMesh(this,this.isVertexBufferUpdatable(T.PositionKind))}}forceSharedVertices(){let e=K.ExtractFromMesh(this),t=e.uvs,i=e.indices,r=e.positions,s=e.colors,o=e.matricesIndices,a=e.matricesWeights,l=e.matricesIndicesExtra,c=e.matricesWeightsExtra;if(i===void 0||r===void 0||i===null||r===null)P.Warn("VertexData contains empty entries");else{let u=[],h=[],d=[],f=[],p=[],g=[],_=[],y=[],b=[],A=0,I={},v,x;for(let R=0;R<i.length;R+=3){x=[i[R],i[R+1],i[R+2]],b=[];for(let M=0;M<3;M++){b[M]="";for(let D=0;D<3;D++)Math.abs(r[3*x[M]+D])<1e-8&&(r[3*x[M]+D]=0),b[M]+=r[3*x[M]+D]+"|"}if(!(b[0]==b[1]||b[0]==b[2]||b[1]==b[2]))for(let M=0;M<3;M++){if(v=I[b[M]],v===void 0){I[b[M]]=A,v=A++;for(let D=0;D<3;D++)u.push(r[3*x[M]+D]);if(s!=null)for(let D=0;D<4;D++)f.push(s[4*x[M]+D]);if(t!=null)for(let D=0;D<2;D++)d.push(t[2*x[M]+D]);if(o!=null)for(let D=0;D<4;D++)p.push(o[4*x[M]+D]);if(a!=null)for(let D=0;D<4;D++)g.push(a[4*x[M]+D]);if(l!=null)for(let D=0;D<4;D++)_.push(l[4*x[M]+D]);if(c!=null)for(let D=0;D<4;D++)y.push(c[4*x[M]+D])}h.push(v)}}let C=[];K.ComputeNormals(u,h,C),e.positions=u,e.indices=h,e.normals=C,t!=null&&(e.uvs=d),s!=null&&(e.colors=f),o!=null&&(e.matricesIndices=p),a!=null&&(e.matricesWeights=g),l!=null&&(e.matricesIndicesExtra=_),a!=null&&(e.matricesWeightsExtra=y),e.applyToMesh(this,this.isVertexBufferUpdatable(T.PositionKind))}}static _instancedMeshFactory(e,t){throw Zt("InstancedMesh")}static _PhysicsImpostorParser(e,t,i){throw Zt("PhysicsImpostor")}createInstance(e){let t=n._instancedMeshFactory(e,this);return t.parent=this.parent,t}synchronizeInstances(){for(let e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}optimizeIndices(e){let t=this.getIndices(),i=this.getVerticesData(T.PositionKind);if(!i||!t)return this;let r=[];for(let o=0;o<i.length;o=o+3)r.push(m.FromArray(i,o));let s=[];return h0.SyncAsyncForLoop(r.length,40,o=>{let a=r.length-1-o,l=r[a];for(let c=0;c<a;++c){let u=r[c];if(l.equals(u)){s[a]=c;break}}},()=>{for(let a=0;a<t.length;++a)t[a]=s[t[a]]||t[a];let o=this.subMeshes.slice(0);this.setIndices(t),this.subMeshes=o,e&&e(this)}),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),St&&St.HasTags(this)&&(e.tags=St.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.alwaysSelectAsActiveMesh=this.alwaysSelectAsActiveMesh,e.checkCollisions=this.checkCollisions,e.ellipsoid=this.ellipsoid.asArray(),e.ellipsoidOffset=this.ellipsoidOffset.asArray(),e.doNotSyncBoundingInfo=this.doNotSyncBoundingInfo,e.isBlocker=this.isBlocker,e.sideOrientation=this.sideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;let t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(let i=0;i<this.subMeshes.length;i++){let r=this.subMeshes[i];e.subMeshes.push({materialIndex:r.materialIndex,verticesStart:r.verticesStart,verticesCount:r.verticesCount,indexStart:r.indexStart,indexCount:r.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(Oe.NAME_PHYSICSENGINE)){let i=this.getPhysicsImpostor();i&&(e.physicsMass=i.getParam("mass"),e.physicsFriction=i.getParam("friction"),e.physicsRestitution=i.getParam("mass"),e.physicsImpostor=i.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let i=0;i<this.instances.length;i++){let r=this.instances[i];if(r.doNotSerialize)continue;let s={name:r.name,id:r.id,isEnabled:r.isEnabled(!1),isVisible:r.isVisible,isPickable:r.isPickable,checkCollisions:r.checkCollisions,position:r.position.asArray(),scaling:r.scaling.asArray()};if(r.parent&&r.parent._serializeAsParent(s),r.rotationQuaternion?s.rotationQuaternion=r.rotationQuaternion.asArray():r.rotation&&(s.rotation=r.rotation.asArray()),this.getScene()._getComponent(Oe.NAME_PHYSICSENGINE)){let o=r.getPhysicsImpostor();o&&(s.physicsMass=o.getParam("mass"),s.physicsFriction=o.getParam("friction"),s.physicsRestitution=o.getParam("mass"),s.physicsImpostor=o.type)}r.metadata&&(s.metadata=r.metadata),r.actionManager&&(s.actions=r.actionManager.serialize(r.name)),e.instances.push(s),je.AppendSerializedAnimations(r,s),s.ranges=r.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){let i={data:{},sizes:{},strides:{}};for(let r in this._userThinInstanceBuffersStorage.data)i.data[r]=Array.from(this._userThinInstanceBuffersStorage.data[r]),i.sizes[r]=this._userThinInstanceBuffersStorage.sizes[r],i.strides[r]=this._userThinInstanceBuffersStorage.strides[r];e.thinInstances.userThinInstance=i}return je.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();let e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices()){P.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),this.morphTargetManager=null;return}if(e.isUsingTextureForTargets)return;for(let t=0;t<e.numInfluencers;t++){let i=e.getActiveTarget(t),r=i.getPositions();if(!r){P.Error("Invalid morph target. Target must have positions.");return}this.geometry.setVerticesData(T.PositionKind+t,r,!1,3);let s=i.getNormals();s&&this.geometry.setVerticesData(T.NormalKind+t,s,!1,3);let o=i.getTangents();o&&this.geometry.setVerticesData(T.TangentKind+t,o,!1,3);let a=i.getUVs();a&&this.geometry.setVerticesData(T.UVKind+"_"+t,a,!1,2);let l=i.getUV2s();l&&this.geometry.setVerticesData(T.UV2Kind+"_"+t,l,!1,2);let c=i.getColors();c&&this.geometry.setVerticesData(T.ColorKind+t,c,!1,4)}}else{let t=0;for(;this.geometry.isVerticesDataPresent(T.PositionKind+t);)this.geometry.removeVerticesData(T.PositionKind+t),this.geometry.isVerticesDataPresent(T.NormalKind+t)&&this.geometry.removeVerticesData(T.NormalKind+t),this.geometry.isVerticesDataPresent(T.TangentKind+t)&&this.geometry.removeVerticesData(T.TangentKind+t),this.geometry.isVerticesDataPresent(T.UVKind+t)&&this.geometry.removeVerticesData(T.UVKind+"_"+t),this.geometry.isVerticesDataPresent(T.UV2Kind+t)&&this.geometry.removeVerticesData(T.UV2Kind+"_"+t),this.geometry.isVerticesDataPresent(T.ColorKind+t)&&this.geometry.removeVerticesData(T.ColorKind+t),t++}}static Parse(e,t,i){let r;if(e.type&&e.type==="LinesMesh"?r=n._LinesMeshParser(e,t):e.type&&e.type==="GroundMesh"?r=n._GroundMeshParser(e,t):e.type&&e.type==="GoldbergMesh"?r=n._GoldbergMeshParser(e,t):e.type&&e.type==="GreasedLineMesh"?r=n._GreasedLineMeshParser(e,t):e.type&&e.type==="TrailMesh"?r=n._TrailMeshParser(e,t):r=new n(e.name,t),r.id=e.id,r._waitingParsedUniqueId=e.uniqueId,St&&St.AddTagsTo(r,e.tags),r.position=m.FromArray(e.position),e.metadata!==void 0&&(r.metadata=e.metadata),e.rotationQuaternion?r.rotationQuaternion=Q.FromArray(e.rotationQuaternion):e.rotation&&(r.rotation=m.FromArray(e.rotation)),r.scaling=m.FromArray(e.scaling),e.localMatrix?r.setPreTransformMatrix(L.FromArray(e.localMatrix)):e.pivotMatrix&&r.setPivotMatrix(L.FromArray(e.pivotMatrix)),r.setEnabled(e.isEnabled),r.isVisible=e.isVisible,r.infiniteDistance=e.infiniteDistance,r.alwaysSelectAsActiveMesh=!!e.alwaysSelectAsActiveMesh,r.showBoundingBox=e.showBoundingBox,r.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,e.applyFog!==void 0&&(r.applyFog=e.applyFog),e.pickable!==void 0&&(r.isPickable=e.pickable),e.alphaIndex!==void 0&&(r.alphaIndex=e.alphaIndex),r.receiveShadows=e.receiveShadows,e.billboardMode!==void 0&&(r.billboardMode=e.billboardMode),e.visibility!==void 0&&(r.visibility=e.visibility),r.checkCollisions=e.checkCollisions,r.doNotSyncBoundingInfo=!!e.doNotSyncBoundingInfo,e.ellipsoid&&(r.ellipsoid=m.FromArray(e.ellipsoid)),e.ellipsoidOffset&&(r.ellipsoidOffset=m.FromArray(e.ellipsoidOffset)),e.overrideMaterialSideOrientation!=null&&(r.sideOrientation=e.overrideMaterialSideOrientation),e.sideOrientation!==void 0&&(r.sideOrientation=e.sideOrientation),e.isBlocker!==void 0&&(r.isBlocker=e.isBlocker),r._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(r._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.actions!==void 0&&(r._waitingData.actions=e.actions),e.overlayAlpha!==void 0&&(r.overlayAlpha=e.overlayAlpha),e.overlayColor!==void 0&&(r.overlayColor=U.FromArray(e.overlayColor)),e.renderOverlay!==void 0&&(r.renderOverlay=e.renderOverlay),r.isUnIndexed=!!e.isUnIndexed,r.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(r.delayLoadState=4,r.delayLoadingFile=i+e.delayLoadingFile,r.buildBoundingInfo(m.FromArray(e.boundingBoxMinimum),m.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(r._binaryInfo=e._binaryInfo),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(T.UVKind),e.hasUVs2&&r._delayInfo.push(T.UV2Kind),e.hasUVs3&&r._delayInfo.push(T.UV3Kind),e.hasUVs4&&r._delayInfo.push(T.UV4Kind),e.hasUVs5&&r._delayInfo.push(T.UV5Kind),e.hasUVs6&&r._delayInfo.push(T.UV6Kind),e.hasColors&&r._delayInfo.push(T.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(T.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(T.MatricesWeightsKind),r._delayLoadingFunction=Lt._ImportGeometry,Nt.ForceFullSceneLoadingForIncremental&&r._checkDelayState()):Lt._ImportGeometry(e,r),e.materialUniqueId?r._waitingMaterialId=e.materialUniqueId:e.materialId&&(r._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(r._waitingMorphTargetManagerId=e.morphTargetManagerId),e.skeletonId!==void 0&&e.skeletonId!==null&&(r.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(r.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(let s=0;s<e.animations.length;s++){let o=e.animations[s],a=vt("BABYLON.Animation");a&&r.animations.push(a.Parse(o))}Ut.ParseAnimationRanges(r,e,t)}if(e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?r.layerMask=Math.abs(parseInt(e.layerMask)):r.layerMask=268435455,e.physicsImpostor&&(r.physicsImpostor=n._PhysicsImpostorParser(t,r,e)),e.lodMeshIds&&(r._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(let s=0;s<e.instances.length;s++){let o=e.instances[s],a=r.createInstance(o.name);if(o.id&&(a.id=o.id),St&&(o.tags?St.AddTagsTo(a,o.tags):St.AddTagsTo(a,e.tags)),a.position=m.FromArray(o.position),o.metadata!==void 0&&(a.metadata=o.metadata),o.parentId!==void 0&&(a._waitingParentId=o.parentId),o.parentInstanceIndex!==void 0&&(a._waitingParentInstanceIndex=o.parentInstanceIndex),o.isEnabled!==void 0&&o.isEnabled!==null&&a.setEnabled(o.isEnabled),o.isVisible!==void 0&&o.isVisible!==null&&(a.isVisible=o.isVisible),o.isPickable!==void 0&&o.isPickable!==null&&(a.isPickable=o.isPickable),o.rotationQuaternion?a.rotationQuaternion=Q.FromArray(o.rotationQuaternion):o.rotation&&(a.rotation=m.FromArray(o.rotation)),a.scaling=m.FromArray(o.scaling),o.checkCollisions!=null&&o.checkCollisions!=null&&(a.checkCollisions=o.checkCollisions),o.pickable!=null&&o.pickable!=null&&(a.isPickable=o.pickable),o.showBoundingBox!=null&&o.showBoundingBox!=null&&(a.showBoundingBox=o.showBoundingBox),o.showSubMeshesBoundingBox!=null&&o.showSubMeshesBoundingBox!=null&&(a.showSubMeshesBoundingBox=o.showSubMeshesBoundingBox),o.alphaIndex!=null&&o.showSubMeshesBoundingBox!=null&&(a.alphaIndex=o.alphaIndex),o.physicsImpostor&&(a.physicsImpostor=n._PhysicsImpostorParser(t,a,o)),o.actions!==void 0&&(a._waitingData.actions=o.actions),o.animations){for(let l=0;l<o.animations.length;l++){let c=o.animations[l],u=vt("BABYLON.Animation");u&&a.animations.push(u.Parse(c))}Ut.ParseAnimationRanges(a,o,t),o.autoAnimate&&t.beginAnimation(a,o.autoAnimateFrom,o.autoAnimateTo,o.autoAnimateLoop,o.autoAnimateSpeed||1)}}if(e.thinInstances){let s=e.thinInstances;if(r.thinInstanceEnablePicking=!!s.enablePicking,s.matrixData?(r.thinInstanceSetBuffer("matrix",new Float32Array(s.matrixData),16,!1),r._thinInstanceDataStorage.matrixBufferSize=s.matrixBufferSize,r._thinInstanceDataStorage.instancesCount=s.instancesCount):r._thinInstanceDataStorage.matrixBufferSize=s.matrixBufferSize,e.thinInstances.userThinInstance){let o=e.thinInstances.userThinInstance;for(let a in o.data)r.thinInstanceSetBuffer(a,new Float32Array(o.data[a]),o.strides[a],!1),r._userThinInstanceBuffersStorage.sizes[a]=o.sizes[a]}}return r}setPositionsForCPUSkinning(){let e=this._internalMeshDataInfo;if(!e._sourcePositions){let t=this.getVerticesData(T.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(T.PositionKind)||this.setVerticesData(T.PositionKind,t,!0)}return e._sourcePositions}setNormalsForCPUSkinning(){let e=this._internalMeshDataInfo;if(!e._sourceNormals){let t=this.getVerticesData(T.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(T.NormalKind)||this.setVerticesData(T.NormalKind,t,!0)}return e._sourceNormals}applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(T.PositionKind))return this;if(!this.isVerticesDataPresent(T.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(T.MatricesWeightsKind))return this;let t=this.isVerticesDataPresent(T.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){let y=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=y}t&&!i._sourceNormals&&this.setNormalsForCPUSkinning();let r=this.getVerticesData(T.PositionKind);if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r));let s=this.getVerticesData(T.NormalKind);if(t){if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s))}let o=this.getVerticesData(T.MatricesIndicesKind),a=this.getVerticesData(T.MatricesWeightsKind);if(!a||!o)return this;let l=this.numBoneInfluencers>4,c=l?this.getVerticesData(T.MatricesIndicesExtraKind):null,u=l?this.getVerticesData(T.MatricesWeightsExtraKind):null,h=e.getTransformMatrices(this),d=m.Zero(),f=new L,p=new L,g=0,_;for(let y=0;y<r.length;y+=3,g+=4){let b;for(_=0;_<4;_++)b=a[g+_],b>0&&(L.FromFloat32ArrayToRefScaled(h,Math.floor(o[g+_]*16),b,p),f.addToSelf(p));if(l)for(_=0;_<4;_++)b=u[g+_],b>0&&(L.FromFloat32ArrayToRefScaled(h,Math.floor(c[g+_]*16),b,p),f.addToSelf(p));m.TransformCoordinatesFromFloatsToRef(i._sourcePositions[y],i._sourcePositions[y+1],i._sourcePositions[y+2],f,d),d.toArray(r,y),t&&(m.TransformNormalFromFloatsToRef(i._sourceNormals[y],i._sourceNormals[y+1],i._sourceNormals[y+2],f,d),d.toArray(s,y)),f.reset()}return this.updateVerticesData(T.PositionKind,r),t&&this.updateVerticesData(T.NormalKind,s),this}static MinMax(e){let t=null,i=null;for(let r of e){let o=r.getBoundingInfo().boundingBox;!t||!i?(t=o.minimumWorld.clone(),i=o.maximumWorld.clone()):(t.minimizeInPlace(o.minimumWorld),i.maximizeInPlace(o.maximumWorld))}return!t||!i?{min:m.Zero(),max:m.Zero()}:{min:t,max:i}}static Center(e){let t=e instanceof Array?n.MinMax(e):e;return m.Center(t.min,t.max)}static MergeMeshes(e,t=!0,i,r,s,o){return f0(n._MergeMeshesCoroutine(e,t,i,r,s,o,!1))}static MergeMeshesAsync(e,t=!0,i,r,s,o){return S(this,null,function*(){return yield p0(n._MergeMeshesCoroutine(e,t,i,r,s,o,!0),d0())})}static*_MergeMeshesCoroutine(e,t=!0,i,r,s,o,a){if(e=e.filter(Boolean),e.length===0)return null;let l;if(!i){let C=0;for(l=0;l<e.length;l++)if(C+=e[l].getTotalVertices(),C>=65536)return P.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}o&&(s=!1);let c=new Array,u=new Array,h=new Array,d=e[0].sideOrientation;for(l=0;l<e.length;l++){let C=e[l];if(C.isAnInstance)return P.Warn("Cannot merge instance meshes."),null;if(d!==C.sideOrientation)return P.Warn("Cannot merge meshes with different sideOrientation values."),null;if(s&&h.push({start:0,count:C.getTotalIndices()}),o){let R=h.reduce((M,D)=>Math.max(M,D.start+D.count),0);if(C.material){let M=C.material;if(M instanceof cr){for(let D=0;D<M.subMaterials.length;D++)c.indexOf(M.subMaterials[D])<0&&c.push(M.subMaterials[D]);for(let D=0;D<C.subMeshes.length;D++)u.push(c.indexOf(M.subMaterials[C.subMeshes[D].materialIndex])),h.push({start:R+C.subMeshes[D].indexStart,count:C.subMeshes[D].indexCount})}else{c.indexOf(M)<0&&c.push(M);for(let D=0;D<C.subMeshes.length;D++)u.push(c.indexOf(M)),h.push({start:R+C.subMeshes[D].indexStart,count:C.subMeshes[D].indexCount})}}else for(let M=0;M<C.subMeshes.length;M++)u.push(0),h.push({start:R+C.subMeshes[M].indexStart,count:C.subMeshes[M].indexCount})}}let f=e[0],p=C=>{let R=C.computeWorldMatrix(!0);return{vertexData:K.ExtractFromMesh(C,!1,!1),transform:R}},{vertexData:g,transform:_}=p(f);a&&(yield);let y=new Array(e.length-1);for(let C=1;C<e.length;C++)y[C-1]=p(e[C]),a&&(yield);let b=g._mergeCoroutine(_,y,i,a,!t),A=b.next();for(;!A.done;)a&&(yield),A=b.next();let I=A.value;r||(r=new n(f.name+"_merged",f.getScene()));let v=I._applyToCoroutine(r,void 0,a),x=v.next();for(;!x.done;)a&&(yield),x=v.next();if(r.checkCollisions=f.checkCollisions,r.sideOrientation=f.sideOrientation,t)for(l=0;l<e.length;l++)e[l].dispose();if(s||o){for(r.releaseSubMeshes(),l=0;l<h.length;)Xi.CreateFromIndices(0,h[l].start,h[l].count,r,void 0,!1),l++;for(let C of r.subMeshes)C.refreshBoundingInfo();r.computeWorldMatrix(!0)}if(o){let C=new cr(f.name+"_merged",f.getScene());C.subMaterials=c;for(let R=0;R<r.subMeshes.length;R++)r.subMeshes[R].materialIndex=u[R];r.material=C}else r.material=f.material;return r}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}removeInstance(e){let t=e._indexInSourceMeshInstanceArray;if(t!=-1){if(t!==this.instances.length-1){let i=this.instances[this.instances.length-1];this.instances[t]=i,i._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this._scene.useRightHandedSystem&&this.sideOrientation===Re.CounterClockWiseSideOrientation}_getRenderingFillMode(e){let t=this.getScene();return t.forcePointsCloud?Re.PointFillMode:t.forceWireframe?Re.WireFrameFillMode:this.overrideRenderingFillMode??e}setMaterialByID(e){return this.setMaterialById(e)}static CreateRibbon(e,t,i,r,s,o,a,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateDisc(e,t,i,r,s,o){throw new Error("Import MeshBuilder to populate this function")}static CreateBox(e,t,i,r,s){throw new Error("Import MeshBuilder to populate this function")}static CreateSphere(e,t,i,r,s,o){throw new Error("Import MeshBuilder to populate this function")}static CreateHemisphere(e,t,i,r){throw new Error("Import MeshBuilder to populate this function")}static CreateCylinder(e,t,i,r,s,o,a,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateTorus(e,t,i,r,s,o,a){throw new Error("Import MeshBuilder to populate this function")}static CreateTorusKnot(e,t,i,r,s,o,a,l,c,u){throw new Error("Import MeshBuilder to populate this function")}static CreateLines(e,t,i,r,s){throw new Error("Import MeshBuilder to populate this function")}static CreateDashedLines(e,t,i,r,s,o,a,l){throw new Error("Import MeshBuilder to populate this function")}static CreatePolygon(e,t,i,r,s,o,a){throw new Error("Import MeshBuilder to populate this function")}static ExtrudePolygon(e,t,i,r,s,o,a,l){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShape(e,t,i,r,s,o,a,l,c,u){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShapeCustom(e,t,i,r,s,o,a,l,c,u,h,d){throw new Error("Import MeshBuilder to populate this function")}static CreateLathe(e,t,i,r,s,o,a){throw new Error("Import MeshBuilder to populate this function")}static CreatePlane(e,t,i,r,s){throw new Error("Import MeshBuilder to populate this function")}static CreateGround(e,t,i,r,s,o){throw new Error("Import MeshBuilder to populate this function")}static CreateTiledGround(e,t,i,r,s,o,a,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateGroundFromHeightMap(e,t,i,r,s,o,a,l,c,u,h){throw new Error("Import MeshBuilder to populate this function")}static CreateTube(e,t,i,r,s,o,a,l,c,u){throw new Error("Import MeshBuilder to populate this function")}static CreatePolyhedron(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateIcoSphere(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateDecal(e,t,i,r,s,o){throw new Error("Import MeshBuilder to populate this function")}static CreateCapsule(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static ExtendToGoldberg(e){throw new Error("Import MeshBuilder to populate this function")}};E.FRONTSIDE=K.FRONTSIDE;E.BACKSIDE=K.BACKSIDE;E.DOUBLESIDE=K.DOUBLESIDE;E.DEFAULTSIDE=K.DEFAULTSIDE;E.NO_CAP=0;E.CAP_START=1;E.CAP_END=2;E.CAP_ALL=3;E.NO_FLIP=0;E.FLIP_TILE=1;E.ROTATE_TILE=2;E.FLIP_ROW=3;E.ROTATE_ROW=4;E.FLIP_N_ROTATE_TILE=5;E.FLIP_N_ROTATE_ROW=6;E.CENTER=0;E.LEFT=1;E.RIGHT=2;E.TOP=3;E.BOTTOM=4;E.INSTANCEDMESH_SORT_TRANSPARENT=!1;E._GroundMeshParser=(n,e)=>{throw Zt("GroundMesh")};E._GoldbergMeshParser=(n,e)=>{throw Zt("GoldbergMesh")};E._LinesMeshParser=(n,e)=>{throw Zt("LinesMesh")};E._GreasedLineMeshParser=(n,e)=>{throw Zt("GreasedLineMesh")};E._GreasedLineRibbonMeshParser=(n,e)=>{throw Zt("GreasedLineRibbonMesh")};E._TrailMeshParser=(n,e)=>{throw Zt("TrailMesh")};le("BABYLON.Mesh",E);E._instancedMeshFactory=(n,e)=>{let t=new ps(n,e);if(e.instancedBuffers){t.instancedBuffers={};for(let i in e.instancedBuffers)t.instancedBuffers[i]=e.instancedBuffers[i]}return t};var ps=class extends _n{constructor(e,t){super(e,t.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,t.addInstance(this),this._sourceMesh=t,this._unIndexed=t._unIndexed,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scaling.copyFrom(t.scaling),t.rotationQuaternion&&(this.rotationQuaternion=t.rotationQuaternion.clone()),this.animations=t.animations.slice();for(let i of t.getAnimationRanges())i!=null&&this.createAnimationRange(i.name,i.from,i.to);if(this.infiniteDistance=t.infiniteDistance,this.setPivotMatrix(t.getPivotMatrix()),!t.skeleton&&!t.morphTargetManager&&t.hasBoundingInfo){let i=t.getBoundingInfo();this.buildBoundingInfo(i.minimum,i.maximum)}else this.refreshBoundingInfo(!0,!0);this._syncSubMeshes()}getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}set receiveShadows(e){this._sourceMesh?.receiveShadows!==e&&z.Warn("Setting receiveShadows on an instanced mesh has no effect")}get material(){return this._sourceMesh.material}set material(e){this._sourceMesh?.material!==e&&z.Warn("Setting material on an instanced mesh has no effect")}get visibility(){return this._sourceMesh.visibility}set visibility(e){this._sourceMesh?.visibility!==e&&z.Warn("Setting visibility on an instanced mesh has no effect")}get skeleton(){return this._sourceMesh.skeleton}set skeleton(e){this._sourceMesh?.skeleton!==e&&z.Warn("Setting skeleton on an instanced mesh has no effect")}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){!this._sourceMesh||e===this._sourceMesh.renderingGroupId||P.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}get geometry(){return this._sourceMesh._geometry}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,t,i){return this._sourceMesh.getVerticesData(e,t,i)}copyVerticesData(e,t){this._sourceMesh.copyVerticesData(e,t)}getVertexBuffer(e,t){return this._sourceMesh.getVertexBuffer(e,t)}setVerticesData(e,t,i,r){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,i,r),this.sourceMesh}updateVerticesData(e,t,i,r){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,i,r),this.sourceMesh}setIndices(e,t=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let i;typeof e=="object"?i=e:i={applySkeleton:e,applyMorph:t};let r=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getData(i,null,T.PositionKind),r),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,t){if(super._activate(e,t),this._sourceMesh.subMeshes||P.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD!==this._sourceMesh&&this._currentLOD.billboardMode!==vi.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new L);let e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,k.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(k.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;let t=this.sourceMesh.getLODLevels();if(!t||t.length===0)this._currentLOD=this.sourceMesh;else{let i=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,i.boundingSphere)}return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,t=null,i,r){let s=(r||this._sourceMesh).createInstance(e);if(Tt.DeepCopy(this,s,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo","geometry"],[]),t&&(s.parent=t),!i)for(let o=0;o<this.getScene().meshes.length;o++){let a=this.getScene().meshes[o];a.parent===this&&a.clone(a.name,s)}return s.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(s),s}dispose(e,t=!1){this._sourceMesh.removeInstance(this),super.dispose(e,t)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,t,i){let r=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,t&&t.newSourcedMesh);r&&i&&i(this,r);for(let s of this.getChildTransformNodes(!0))s.instantiateHierarchy(r,t,i);return r}};E.prototype.registerInstancedBuffer=function(n,e){if(this._userInstancedBuffersStorage?.vertexBuffers[n]?.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(let t of this.instances)t.instancedBuffers={}}this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this.instancedBuffers[n]=null,this._userInstancedBuffersStorage.strides[n]=e,this._userInstancedBuffersStorage.sizes[n]=e*32,this._userInstancedBuffersStorage.data[n]=new Float32Array(this._userInstancedBuffersStorage.sizes[n]),this._userInstancedBuffersStorage.vertexBuffers[n]=new T(this.getEngine(),this._userInstancedBuffersStorage.data[n],n,!0,!1,e,!0);for(let t of this.instances)t.instancedBuffers[n]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()};E.prototype._processInstancedBuffers=function(n,e){let t=n?n.length:0;for(let i in this.instancedBuffers){let r=this._userInstancedBuffersStorage.sizes[i],s=this._userInstancedBuffersStorage.strides[i],o=(t+1)*s;for(;r<o;)r*=2;this._userInstancedBuffersStorage.data[i].length!=r&&(this._userInstancedBuffersStorage.data[i]=new Float32Array(r),this._userInstancedBuffersStorage.sizes[i]=r,this._userInstancedBuffersStorage.vertexBuffers[i]&&(this._userInstancedBuffersStorage.vertexBuffers[i].dispose(),this._userInstancedBuffersStorage.vertexBuffers[i]=null));let a=this._userInstancedBuffersStorage.data[i],l=0;if(e){let c=this.instancedBuffers[i];c.toArray?c.toArray(a,l):c.copyToArray?c.copyToArray(a,l):a[l]=c,l+=s}for(let c=0;c<t;c++){let h=n[c].instancedBuffers[i];h.toArray?h.toArray(a,l):h.copyToArray?h.copyToArray(a,l):a[l]=h,l+=s}this._userInstancedBuffersStorage.vertexBuffers[i]?this._userInstancedBuffersStorage.vertexBuffers[i].updateDirectly(a,0):(this._userInstancedBuffersStorage.vertexBuffers[i]=new T(this.getEngine(),this._userInstancedBuffersStorage.data[i],i,!0,!1,s,!0),this._invalidateInstanceVertexArrayObject())}};E.prototype._invalidateInstanceVertexArrayObject=function(){if(!(!this._userInstancedBuffersStorage||this._userInstancedBuffersStorage.vertexArrayObjects===void 0)){for(let n in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[n]);this._userInstancedBuffersStorage.vertexArrayObjects={}}};E.prototype._disposeInstanceSpecificData=function(){for(let n in this._instanceDataStorage.renderPasses)this._instanceDataStorage.renderPasses[n].instancesBuffer?.dispose();for(this._instanceDataStorage.renderPasses={};this.instances.length;)this.instances[0].dispose();for(let n in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[n]&&this._userInstancedBuffersStorage.vertexBuffers[n].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};le("BABYLON.InstancedMesh",ps);var Fp=class{constructor(){this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.sounds=null,this.effectLayers=[],this.layers=[],this.reflectionProbes=[]}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=[];e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes);for(let t of this.skeletons)e=e.concat(t.bones);return e}},Lb=class extends Fp{},Bb=class{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){let e=this.rootNodes;for(let r of e)r.dispose();e.length=0;let t=this.skeletons;for(let r of t)r.dispose();t.length=0;let i=this.animationGroups;for(let r of i)r.dispose();i.length=0}},Ol=class extends Fp{constructor(e){super(),this._wasAddedToScene=!1,e=e||ye.LastCreatedScene,e&&(this.scene=e,this.proceduralTextures=[],e.onDisposeObservable.add(()=>{this._wasAddedToScene||this.dispose()}),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{for(let t of this.geometries)t._rebuild();for(let t of this.meshes)t._rebuild();for(let t of this.particleSystems)t.rebuild();for(let t of this.textures)t._rebuild()}))}_topologicalSort(e){let t=new Map;for(let a of e)t.set(a.uniqueId,a);let i={dependsOn:new Map,dependedBy:new Map};for(let a of e){let l=a.uniqueId;i.dependsOn.set(l,new Set),i.dependedBy.set(l,new Set)}for(let a of e){let l=a.uniqueId,c=i.dependsOn.get(l);if(a instanceof ps){let h=a.sourceMesh;t.has(h.uniqueId)&&(c.add(h.uniqueId),i.dependedBy.get(h.uniqueId).add(l))}let u=i.dependedBy.get(l);for(let h of a.getDescendants()){let d=h.uniqueId;t.has(d)&&(u.add(d),i.dependsOn.get(d).add(l))}}let r=[],s=[];for(let a of e){let l=a.uniqueId;i.dependsOn.get(l).size===0&&(s.push(a),t.delete(l))}let o=s;for(;o.length>0;){let a=o.shift();r.push(a);let l=i.dependedBy.get(a.uniqueId);for(let c of Array.from(l.values())){let u=i.dependsOn.get(c);u.delete(a.uniqueId),u.size===0&&t.get(c)&&(o.push(t.get(c)),t.delete(c))}}return t.size>0&&(P.Error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach(a=>{P.Error(a.name)})),r}_addNodeAndDescendantsToList(e,t,i,r){if(!(!i||r&&!r(i)||t.has(i.uniqueId))){e.push(i),t.add(i.uniqueId);for(let s of i.getDescendants(!0))this._addNodeAndDescendantsToList(e,t,s,r)}}_isNodeInContainer(e){return e instanceof _n&&this.meshes.indexOf(e)!==-1||e instanceof vi&&this.transformNodes.indexOf(e)!==-1||e instanceof Yt&&this.lights.indexOf(e)!==-1||e instanceof Fe&&this.cameras.indexOf(e)!==-1}_isValidHierarchy(){for(let e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return P.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(let e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return P.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(let e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return P.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(let e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return P.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,i){this._isValidHierarchy()||z.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");let r={},s={},o=new Bb,a=[],l=[],c=Y({doNotInstantiate:!0},i),u=(g,_)=>{if(r[g.uniqueId]=_.uniqueId,s[_.uniqueId]=_,e&&(_.name=e(g.name)),_ instanceof E){let y=_;if(y.morphTargetManager){let b=g.morphTargetManager;y.morphTargetManager=b.clone();for(let A=0;A<b.numTargets;A++){let I=b.getTarget(A),v=y.morphTargetManager.getTarget(A);r[I.uniqueId]=v.uniqueId,s[v.uniqueId]=v}}}},h=[],d=new Set;for(let g of this.transformNodes)g.parent===null&&this._addNodeAndDescendantsToList(h,d,g,c.predicate);for(let g of this.meshes)g.parent===null&&this._addNodeAndDescendantsToList(h,d,g,c.predicate);let f=this._topologicalSort(h),p=(g,_)=>{if(u(g,_),g.parent){let y=r[g.parent.uniqueId],b=s[y];b?_.parent=b:_.parent=g.parent}if(_.position&&g.position&&_.position.copyFrom(g.position),_.rotationQuaternion&&g.rotationQuaternion&&_.rotationQuaternion.copyFrom(g.rotationQuaternion),_.rotation&&g.rotation&&_.rotation.copyFrom(g.rotation),_.scaling&&g.scaling&&_.scaling.copyFrom(g.scaling),_.material){let y=_;if(y.material)if(t){let b=g.material;if(l.indexOf(b)===-1){let A=b.clone(e?e(b.name):"Clone of "+b.name);if(l.push(b),r[b.uniqueId]=A.uniqueId,s[A.uniqueId]=A,b.getClassName()==="MultiMaterial"){let I=b;for(let v of I.subMaterials)v&&(A=v.clone(e?e(v.name):"Clone of "+v.name),l.push(v),r[v.uniqueId]=A.uniqueId,s[A.uniqueId]=A);I.subMaterials=I.subMaterials.map(v=>v&&s[r[v.uniqueId]])}}y.getClassName()!=="InstancedMesh"&&(y.material=s[r[b.uniqueId]])}else y.material.getClassName()==="MultiMaterial"?this.scene.multiMaterials.indexOf(y.material)===-1&&this.scene.addMultiMaterial(y.material):this.scene.materials.indexOf(y.material)===-1&&this.scene.addMaterial(y.material)}_.parent===null&&o.rootNodes.push(_)};for(let g of f)if(g.getClassName()==="InstancedMesh"){let _=g,y=_.sourceMesh,b=r[y.uniqueId],I=(typeof b=="number"?s[b]:y).createInstance(_.name);p(_,I)}else{let _=!0;g.getClassName()==="TransformNode"||g.getClassName()==="Node"||g.skeleton||!g.getTotalVertices||g.getTotalVertices()===0?_=!1:c.doNotInstantiate&&(typeof c.doNotInstantiate=="function"?_=!c.doNotInstantiate(g):_=!c.doNotInstantiate);let y=_?g.createInstance(`instance of ${g.name}`):g.clone(`Clone of ${g.name}`,null,!0);if(!y)throw new Error(`Could not clone or instantiate node on Asset Container ${g.name}`);p(g,y)}for(let g of this.skeletons){if(c.predicate&&!c.predicate(g))continue;let _=g.clone(e?e(g.name):"Clone of "+g.name);for(let y of this.meshes)if(y.skeleton===g&&!y.isAnInstance){let b=s[r[y.uniqueId]];if(!b||b.isAnInstance||(b.skeleton=_,a.indexOf(_)!==-1))continue;a.push(_);for(let A of _.bones)A._linkedTransformNode&&(A._linkedTransformNode=s[r[A._linkedTransformNode.uniqueId]])}o.skeletons.push(_)}for(let g of this.animationGroups){if(c.predicate&&!c.predicate(g))continue;let _=g.clone(e?e(g.name):"Clone of "+g.name,y=>s[r[y.uniqueId]]||y);o.animationGroups.push(_)}return o}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||z.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(let e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){let t=[];for(let i of this.cameras)e&&!e(i)||(this.scene.addCamera(i),t.push(i));for(let i of this.lights)e&&!e(i)||(this.scene.addLight(i),t.push(i));for(let i of this.meshes)e&&!e(i)||(this.scene.addMesh(i),t.push(i));for(let i of this.skeletons)e&&!e(i)||this.scene.addSkeleton(i);for(let i of this.animations)e&&!e(i)||this.scene.addAnimation(i);for(let i of this.animationGroups)e&&!e(i)||this.scene.addAnimationGroup(i);for(let i of this.multiMaterials)e&&!e(i)||this.scene.addMultiMaterial(i);for(let i of this.materials)e&&!e(i)||this.scene.addMaterial(i);for(let i of this.morphTargetManagers)e&&!e(i)||this.scene.addMorphTargetManager(i);for(let i of this.geometries)e&&!e(i)||this.scene.addGeometry(i);for(let i of this.transformNodes)e&&!e(i)||(this.scene.addTransformNode(i),t.push(i));for(let i of this.actionManagers)e&&!e(i)||this.scene.addActionManager(i);for(let i of this.textures)e&&!e(i)||this.scene.addTexture(i);for(let i of this.reflectionProbes)e&&!e(i)||this.scene.addReflectionProbe(i);if(t.length){let i=new Set(this.scene.meshes);for(let r of this.scene.lights)i.add(r);for(let r of this.scene.cameras)i.add(r);for(let r of this.scene.transformNodes)i.add(r);for(let r of this.skeletons)for(let s of r.bones)i.add(s);for(let r of t)r.parent&&!i.has(r.parent)&&(r.setParent?r.setParent(null):r.parent=null)}}removeAllFromScene(){this._isValidHierarchy()||z.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(let e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){for(let t of this.cameras)e&&!e(t)||this.scene.removeCamera(t);for(let t of this.lights)e&&!e(t)||this.scene.removeLight(t);for(let t of this.meshes)e&&!e(t)||this.scene.removeMesh(t,!0);for(let t of this.skeletons)e&&!e(t)||this.scene.removeSkeleton(t);for(let t of this.animations)e&&!e(t)||this.scene.removeAnimation(t);for(let t of this.animationGroups)e&&!e(t)||this.scene.removeAnimationGroup(t);for(let t of this.multiMaterials)e&&!e(t)||this.scene.removeMultiMaterial(t);for(let t of this.materials)e&&!e(t)||this.scene.removeMaterial(t);for(let t of this.morphTargetManagers)e&&!e(t)||this.scene.removeMorphTargetManager(t);for(let t of this.geometries)e&&!e(t)||this.scene.removeGeometry(t);for(let t of this.transformNodes)e&&!e(t)||this.scene.removeTransformNode(t);for(let t of this.actionManagers)e&&!e(t)||this.scene.removeActionManager(t);for(let t of this.textures)e&&!e(t)||this.scene.removeTexture(t);for(let t of this.reflectionProbes)e&&!e(t)||this.scene.removeReflectionProbe(t)}dispose(){let e=this.cameras.slice(0);for(let p of e)p.dispose();this.cameras.length=0;let t=this.lights.slice(0);for(let p of t)p.dispose();this.lights.length=0;let i=this.meshes.slice(0);for(let p of i)p.dispose();this.meshes.length=0;let r=this.skeletons.slice(0);for(let p of r)p.dispose();this.skeletons.length=0;let s=this.animationGroups.slice(0);for(let p of s)p.dispose();this.animationGroups.length=0;let o=this.multiMaterials.slice(0);for(let p of o)p.dispose();this.multiMaterials.length=0;let a=this.materials.slice(0);for(let p of a)p.dispose();this.materials.length=0;let l=this.geometries.slice(0);for(let p of l)p.dispose();this.geometries.length=0;let c=this.transformNodes.slice(0);for(let p of c)p.dispose();this.transformNodes.length=0;let u=this.actionManagers.slice(0);for(let p of u)p.dispose();this.actionManagers.length=0;let h=this.textures.slice(0);for(let p of h)p.dispose();this.textures.length=0;let d=this.reflectionProbes.slice(0);for(let p of d)p.dispose();this.reflectionProbes.length=0;let f=this.morphTargetManagers.slice(0);for(let p of f)p.dispose();this.morphTargetManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(let p of this.scene._serializableComponents)p.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,i){if(!(!e||!t))for(let r of e){let s=!0;if(i){for(let o of i)if(r===o){s=!1;break}}s&&(t.push(r),r._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,e===void 0&&(e=new Lb);for(let t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||(t==="_environmentTexture"?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){let e=new E("assetContainerRootMesh",this.scene);for(let t of this.meshes)t.parent||e.addChild(t);return this.meshes.unshift(e),e}mergeAnimationsTo(e=ye.LastCreatedScene,t,i=null){if(!e)return P.Error("No scene available to merge animations to"),[];let r=i||(l=>{let c=null,u=l.animations.length?l.animations[0].targetProperty:"",h=l.name.split(".").join("").split("_primitive")[0];switch(u){case"position":case"rotationQuaternion":c=e.getTransformNodeByName(l.name)||e.getTransformNodeByName(h);break;case"influence":c=e.getMorphTargetByName(l.name)||e.getMorphTargetByName(h);break;default:c=e.getNodeByName(l.name)||e.getNodeByName(h)}return c}),s=this.getNodes();for(let l of s){let c=r(l);if(c!==null){for(let u of l.animations){let h=c.animations.filter(d=>d.targetProperty===u.targetProperty);for(let d of h){let f=c.animations.indexOf(d,0);f>-1&&c.animations.splice(f,1)}}c.animations=c.animations.concat(l.animations)}}let o=[],a=this.animationGroups.slice();for(let l of a){o.push(l.clone(l.name,r));for(let c of l.animatables)c.stop()}for(let l of t){let c=r(l.target);c&&(e.beginAnimation(c,l.fromFrame,l.toFrame,l.loopAnimation,l.speedRatio,l.onAnimationEnd?l.onAnimationEnd:void 0,void 0,!0,void 0,l.onAnimationLoop?l.onAnimationLoop:void 0),e.stopAnimation(l.target))}return o}populateRootNodes(){this.rootNodes.length=0;for(let e of this.meshes)!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e);for(let e of this.transformNodes)!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e);for(let e of this.lights)!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e);for(let e of this.cameras)!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)}addAllAssetsToContainer(e){if(!e)return;let t=[],i=new Set;for(t.push(e);t.length>0;){let r=t.pop();if(r instanceof E?(r.geometry&&this.geometries.indexOf(r.geometry)===-1&&this.geometries.push(r.geometry),this.meshes.push(r)):r instanceof ps?this.meshes.push(r):r instanceof vi?this.transformNodes.push(r):r instanceof Yt?this.lights.push(r):r instanceof Fe&&this.cameras.push(r),r instanceof _n){if(r.material&&this.materials.indexOf(r.material)===-1){this.materials.push(r.material);for(let s of r.material.getActiveTextures())this.textures.indexOf(s)===-1&&this.textures.push(s)}r.skeleton&&this.skeletons.indexOf(r.skeleton)===-1&&this.skeletons.push(r.skeleton),r.morphTargetManager&&this.morphTargetManagers.indexOf(r.morphTargetManager)===-1&&this.morphTargetManagers.push(r.morphTargetManager)}for(let s of r.getChildren())i.has(s)||t.push(s);i.add(r)}this.populateRootNodes()}_getByTags(e,t,i){if(t===void 0)return e;let r=[];for(let s in e){let o=e[s];St&&St.MatchesQuery(o,t)&&(!i||i(o))&&r.push(o)}return r}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialsByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}};var Wo=class{constructor(e){this.byteOffset=0,this.buffer=e}loadAsync(e){return S(this,null,function*(){let t=yield this.buffer.readAsync(this.byteOffset,e);this._dataView=new DataView(t.buffer,t.byteOffset,t.byteLength),this._dataByteOffset=0})}readUint32(){let e=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,e}readUint8Array(e){let t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,this.byteOffset+=e,t}readString(e){return PT(this.readUint8Array(e))}skipBytes(e){this._dataByteOffset+=e,this.byteOffset+=e}};function kb(n,e,t,i){let r={externalResourceFunction:i};return t&&(r.uri=e==="file:"?t:e+t),ArrayBuffer.isView(n)?GLTFValidator.validateBytes(n,r):GLTFValidator.validateString(n,r)}function zB(){let n=[];onmessage=e=>{let t=e.data;switch(t.id){case"init":{importScripts(t.url);break}case"validate":{kb(t.data,t.rootUrl,t.fileName,i=>new Promise((r,s)=>{let o=n.length;n.push({resolve:r,reject:s}),postMessage({id:"getExternalResource",index:o,uri:i})})).then(i=>{postMessage({id:"validate.resolve",value:i})},i=>{postMessage({id:"validate.reject",reason:i})});break}case"getExternalResource.resolve":{n[t.index].resolve(t.value);break}case"getExternalResource.reject":{n[t.index].reject(t.reason);break}}}}var $u=class{static ValidateAsync(e,t,i,r){return typeof Worker=="function"?new Promise((s,o)=>{let a=`${kb}(${zB})()`,l=URL.createObjectURL(new Blob([a],{type:"application/javascript"})),c=new Worker(l),u=d=>{c.removeEventListener("error",u),c.removeEventListener("message",h),o(d)},h=d=>{let f=d.data;switch(f.id){case"getExternalResource":{r(f.uri).then(p=>{c.postMessage({id:"getExternalResource.resolve",index:f.index,value:p},[p.buffer])},p=>{c.postMessage({id:"getExternalResource.reject",index:f.index,reason:p})});break}case"validate.resolve":{c.removeEventListener("error",u),c.removeEventListener("message",h),s(f.value),c.terminate();break}case"validate.reject":c.removeEventListener("error",u),c.removeEventListener("message",h),o(f.reason),c.terminate()}};if(c.addEventListener("error",u),c.addEventListener("message",h),c.postMessage({id:"init",url:z.GetBabylonScriptURL(this.Configuration.url)}),ArrayBuffer.isView(e)){let d=e.slice();c.postMessage({id:"validate",data:d,rootUrl:t,fileName:i},[d.buffer])}else c.postMessage({id:"validate",data:e,rootUrl:t,fileName:i})}):(this._LoadScriptPromise||(this._LoadScriptPromise=z.LoadBabylonScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(()=>kb(e,t,i,r)))}};$u.Configuration={url:`${z._DefaultCdnUrl}/gltf_validator.js`};var ms="Z2xURg",ju={name:"gltf",extensions:{".gltf":{isBinary:!1,mimeType:"model/gltf+json"},".glb":{isBinary:!0,mimeType:"model/gltf-binary"}},canDirectLoad(n){return n.indexOf("asset")!==-1&&n.indexOf("version")!==-1||n.startsWith("data:base64,"+ms)||n.startsWith("data:;base64,"+ms)||n.startsWith("data:application/octet-stream;base64,"+ms)||n.startsWith("data:model/gltf-binary;base64,"+ms)}};function Hw(n,e,t){try{return Promise.resolve(new Uint8Array(n,e,t))}catch(i){return Promise.reject(i)}}function HB(n,e,t){try{if(e<0||e>=n.byteLength)throw new RangeError("Offset is out of range.");if(e+t>n.byteLength)throw new RangeError("Length is out of range.");return Promise.resolve(new Uint8Array(n.buffer,n.byteOffset+e,t))}catch(i){return Promise.reject(i)}}var qu=(function(n){return n[n.AUTO=0]="AUTO",n[n.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED",n})(qu||{}),Nl=(function(n){return n[n.NONE=0]="NONE",n[n.FIRST=1]="FIRST",n[n.ALL=2]="ALL",n})(Nl||{}),ln=(function(n){return n[n.LOADING=0]="LOADING",n[n.READY=1]="READY",n[n.COMPLETE=2]="COMPLETE",n})(ln||{}),Lp=class{constructor(){this.alwaysComputeBoundingBox=!1,this.alwaysComputeSkeletonRootNode=!1,this.animationStartMode=Nl.FIRST,this.compileMaterials=!1,this.compileShadowGenerators=!1,this.coordinateSystemMode=qu.AUTO,this.createInstances=!0,this.loadAllMaterials=!1,this.loadMorphTargets=!0,this.loadNodeAnimations=!0,this.loadOnlyMaterials=!1,this.loadSkins=!0,this.skipMaterials=!1,this.targetFps=60,this.transparencyAsCoverage=!1,this.useClipPlane=!1,this.useGltfTextureNames=!1,this.useRangeRequests=!1,this.useSRGBBuffers=!0,this.validate=!1,this.useOpenPBR=!1}},WB=new Lp,Vb=class extends Lp{constructor(){super(...arguments),this.extensionOptions={},this.preprocessUrlAsync=e=>Promise.resolve(e)}copyFrom(e){e&&(this.alwaysComputeBoundingBox=e.alwaysComputeBoundingBox??this.alwaysComputeBoundingBox,this.alwaysComputeSkeletonRootNode=e.alwaysComputeSkeletonRootNode??this.alwaysComputeSkeletonRootNode,this.animationStartMode=e.animationStartMode??this.animationStartMode,this.capturePerformanceCounters=e.capturePerformanceCounters??this.capturePerformanceCounters,this.compileMaterials=e.compileMaterials??this.compileMaterials,this.compileShadowGenerators=e.compileShadowGenerators??this.compileShadowGenerators,this.coordinateSystemMode=e.coordinateSystemMode??this.coordinateSystemMode,this.createInstances=e.createInstances??this.createInstances,this.customRootNode=e.customRootNode,this.extensionOptions=e.extensionOptions??this.extensionOptions,this.loadAllMaterials=e.loadAllMaterials??this.loadAllMaterials,this.loadMorphTargets=e.loadMorphTargets??this.loadMorphTargets,this.loadNodeAnimations=e.loadNodeAnimations??this.loadNodeAnimations,this.loadOnlyMaterials=e.loadOnlyMaterials??this.loadOnlyMaterials,this.loadSkins=e.loadSkins??this.loadSkins,this.loggingEnabled=e.loggingEnabled??this.loggingEnabled,this.onCameraLoaded=e.onCameraLoaded,this.onMaterialLoaded=e.onMaterialLoaded,this.onMeshLoaded=e.onMeshLoaded,this.onParsed=e.onParsed,this.onSkinLoaded=e.onSkinLoaded,this.onTextureLoaded=e.onTextureLoaded,this.onValidated=e.onValidated,this.preprocessUrlAsync=e.preprocessUrlAsync??this.preprocessUrlAsync,this.skipMaterials=e.skipMaterials??this.skipMaterials,this.targetFps=e.targetFps??this.targetFps,this.transparencyAsCoverage=e.transparencyAsCoverage??this.transparencyAsCoverage,this.useClipPlane=e.useClipPlane??this.useClipPlane,this.useGltfTextureNames=e.useGltfTextureNames??this.useGltfTextureNames,this.useOpenPBR=e.useOpenPBR??this.useOpenPBR,this.useRangeRequests=e.useRangeRequests??this.useRangeRequests,this.useSRGBBuffers=e.useSRGBBuffers??this.useSRGBBuffers,this.validate=e.validate??this.validate)}},Hr=(()=>{class n extends Vb{constructor(t){super(),this.onParsedObservable=new F,this.onMeshLoadedObservable=new F,this.onSkinLoadedObservable=new F,this.onTextureLoadedObservable=new F,this.onMaterialLoadedObservable=new F,this.onCameraLoadedObservable=new F,this.onCompleteObservable=new F,this.onErrorObservable=new F,this.onDisposeObservable=new F,this.onExtensionLoadedObservable=new F,this.onValidatedObservable=new F,this._loader=null,this._state=null,this._requests=new Array,this.name=ju.name,this.extensions=ju.extensions,this.onLoaderStateChangedObservable=new F,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled,this.copyFrom(Object.assign(Y({},WB),t))}set onParsed(t){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),t&&(this._onParsedObserver=this.onParsedObservable.add(t))}set onMeshLoaded(t){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),t&&(this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(t))}set onSkinLoaded(t){this._onSkinLoadedObserver&&this.onSkinLoadedObservable.remove(this._onSkinLoadedObserver),t&&(this._onSkinLoadedObserver=this.onSkinLoadedObservable.add(i=>t(i.node,i.skinnedNode)))}set onTextureLoaded(t){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),t&&(this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(t))}set onMaterialLoaded(t){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),t&&(this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(t))}set onCameraLoaded(t){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),t&&(this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(t))}set onComplete(t){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(t)}set onError(t){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(t)}set onDispose(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)}set onExtensionLoaded(t){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(t)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(t){this._loggingEnabled!==t&&(this._loggingEnabled=t,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(t){this._capturePerformanceCounters!==t&&(this._capturePerformanceCounters=t,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(t){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(t)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(let t of this._requests)t.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=t=>Promise.resolve(t),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(t,i,r,s,o,a,l,c){if(ArrayBuffer.isView(i))return this._loadBinary(t,i,r,s,l,c),null;this._progressCallback=o;let u=i.name||z.GetFilename(i);if(a){if(this.useRangeRequests){this.validate&&P.Warn("glTF validation is not supported when range requests are enabled");let h={abort:()=>{},onCompleteObservable:new F},d={readAsync:(f,p)=>new Promise((g,_)=>{this._loadFile(t,i,y=>{g(new Uint8Array(y))},!0,y=>{_(y)},y=>{y.setRequestHeader("Range",`bytes=${f}-${f+p-1}`)})}),byteLength:0};return this._unpackBinaryAsync(new Wo(d)).then(f=>{h.onCompleteObservable.notifyObservers(h),s(f)},l?f=>l(void 0,f):void 0),h}return this._loadFile(t,i,h=>{this._validate(t,new Uint8Array(h,0,h.byteLength),r,u),this._unpackBinaryAsync(new Wo({readAsync:(d,f)=>Hw(h,d,f),byteLength:h.byteLength})).then(d=>{s(d)},l?d=>l(void 0,d):void 0)},!0,l)}else return this._loadFile(t,i,h=>{try{this._validate(t,h,r,u),s({json:this._parseJson(h)})}catch{l&&l()}},!1,l)}_loadBinary(t,i,r,s,o,a){this._validate(t,new Uint8Array(i.buffer,i.byteOffset,i.byteLength),r,a),this._unpackBinaryAsync(new Wo({readAsync:(l,c)=>HB(i,l,c),byteLength:i.byteLength})).then(l=>{s(l)},o?l=>o(void 0,l):void 0)}importMeshAsync(t,i,r,s,o,a){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(r),this.onParsedObservable.clear(),this._log(`Loading ${a||""}`),this._loader=this._getLoader(r),this._loader.importMeshAsync(t,i,null,r,s,o,a)))}loadAsync(t,i,r,s,o){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(i),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(i),this._loader.loadAsync(t,i,r,s,o)))}loadAssetContainerAsync(t,i,r,s,o){return Promise.resolve().then(()=>{this.onParsedObservable.notifyObservers(i),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(i);let a=new Ol(t),l=[];this.onMaterialLoadedObservable.add(d=>{l.push(d)});let c=[];this.onTextureLoadedObservable.add(d=>{c.push(d)});let u=[];this.onCameraLoadedObservable.add(d=>{u.push(d)});let h=[];return this.onMeshLoadedObservable.add(d=>{d.morphTargetManager&&h.push(d.morphTargetManager)}),this._loader.importMeshAsync(null,t,a,i,r,s,o).then(d=>(Array.prototype.push.apply(a.geometries,d.geometries),Array.prototype.push.apply(a.meshes,d.meshes),Array.prototype.push.apply(a.particleSystems,d.particleSystems),Array.prototype.push.apply(a.skeletons,d.skeletons),Array.prototype.push.apply(a.animationGroups,d.animationGroups),Array.prototype.push.apply(a.materials,l),Array.prototype.push.apply(a.textures,c),Array.prototype.push.apply(a.lights,d.lights),Array.prototype.push.apply(a.transformNodes,d.transformNodes),Array.prototype.push.apply(a.cameras,u),Array.prototype.push.apply(a.morphTargetManagers,h),a))})}canDirectLoad(t){return ju.canDirectLoad(t)}directLoad(t,i){if(i.startsWith("base64,"+ms)||i.startsWith(";base64,"+ms)||i.startsWith("application/octet-stream;base64,"+ms)||i.startsWith("model/gltf-binary;base64,"+ms)){let r=Jh(i);return this._validate(t,new Uint8Array(r,0,r.byteLength)),this._unpackBinaryAsync(new Wo({readAsync:(s,o)=>Hw(r,s,o),byteLength:r.byteLength}))}return this._validate(t,i),Promise.resolve({json:this._parseJson(i)})}createPlugin(t){return new n(t[ju.name])}get loaderState(){return this._state}whenCompleteAsync(){return new Promise((t,i)=>{this.onCompleteObservable.addOnce(()=>{t()}),this.onErrorObservable.addOnce(r=>{i(r)})})}_setState(t){this._state!==t&&(this._state=t,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(ln[this._state]))}_loadFile(t,i,r,s,o,a){let l=t._loadFile(i,r,c=>{this._onProgress(c,l)},!0,s,o,a);return l.onCompleteObservable.add(()=>{l._lengthComputable=!0,l._total=l._loaded}),this._requests.push(l),l}_onProgress(t,i){if(!this._progressCallback)return;i._lengthComputable=t.lengthComputable,i._loaded=t.loaded,i._total=t.total;let r=!0,s=0,o=0;for(let a of this._requests){if(a._lengthComputable===void 0||a._loaded===void 0||a._total===void 0)return;r=r&&a._lengthComputable,s+=a._loaded,o+=a._total}this._progressCallback({lengthComputable:r,loaded:s,total:r?o:0})}_validate(t,i,r="",s=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),$u.ValidateAsync(i,r,s,o=>this.preprocessUrlAsync(r+o).then(a=>t._loadFileAsync(a,void 0,!0,!0).then(l=>new Uint8Array(l,0,l.byteLength)))).then(o=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(o),this.onValidatedObservable.clear()},o=>{this._endPerformanceCounter("Validate JSON"),z.Warn(`Failed to validate: ${o.message}`),this.onValidatedObservable.clear()}))}_getLoader(t){let i=t.json.asset||{};this._log(`Asset version: ${i.version}`),i.minVersion&&this._log(`Asset minimum version: ${i.minVersion}`),i.generator&&this._log(`Asset generator: ${i.generator}`);let r=n._parseVersion(i.version);if(!r)throw new Error("Invalid version: "+i.version);if(i.minVersion!==void 0){let a=n._parseVersion(i.minVersion);if(!a)throw new Error("Invalid minimum version: "+i.minVersion);if(n._compareVersion(a,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+i.minVersion)}let o={1:n._CreateGLTF1Loader,2:n._CreateGLTF2Loader}[r.major];if(!o)throw new Error("Unsupported version: "+i.version);return o(this)}_parseJson(t){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${t.length}`);let i=JSON.parse(t);return this._endPerformanceCounter("Parse JSON"),i}_unpackBinaryAsync(t){return this._startPerformanceCounter("Unpack Binary"),t.loadAsync(20).then(()=>{let i={Magic:1179937895},r=t.readUint32();if(r!==i.Magic)throw new Ca("Unexpected magic: "+r,xa.GLTFLoaderUnexpectedMagicError);let s=t.readUint32();this.loggingEnabled&&this._log(`Binary version: ${s}`);let o=t.readUint32();!this.useRangeRequests&&o!==t.buffer.byteLength&&P.Warn(`Length in header does not match actual data length: ${o} != ${t.buffer.byteLength}`);let a;switch(s){case 1:{a=this._unpackBinaryV1Async(t,o);break}case 2:{a=this._unpackBinaryV2Async(t,o);break}default:throw new Error("Unsupported version: "+s)}return this._endPerformanceCounter("Unpack Binary"),a})}_unpackBinaryV1Async(t,i){let r={JSON:0},s=t.readUint32(),o=t.readUint32();if(o!==r.JSON)throw new Error(`Unexpected content format: ${o}`);let a=i-t.byteOffset,l={json:this._parseJson(t.readString(s)),bin:null};if(a!==0){let c=t.byteOffset;l.bin={readAsync:(u,h)=>t.buffer.readAsync(c+u,h),byteLength:a}}return Promise.resolve(l)}_unpackBinaryV2Async(t,i){let r={JSON:1313821514,BIN:5130562},s=t.readUint32();if(t.readUint32()!==r.JSON)throw new Error("First chunk format is not JSON");return t.byteOffset+s===i?t.loadAsync(s).then(()=>({json:this._parseJson(t.readString(s)),bin:null})):t.loadAsync(s+8).then(()=>{let a={json:this._parseJson(t.readString(s)),bin:null},l=()=>{let c=t.readUint32();switch(t.readUint32()){case r.JSON:throw new Error("Unexpected JSON chunk");case r.BIN:{let h=t.byteOffset;a.bin={readAsync:(d,f)=>t.buffer.readAsync(h+d,f),byteLength:c},t.skipBytes(c);break}default:{t.skipBytes(c);break}}return t.byteOffset!==i?t.loadAsync(8).then(l):Promise.resolve(a)};return l()})}static _parseVersion(t){if(t==="1.0"||t==="1.0.1")return{major:1,minor:0};let i=(t+"").match(/^(\d+)\.(\d+)/);return i?{major:parseInt(i[1]),minor:parseInt(i[2])}:null}static _compareVersion(t,i){return t.major>i.major?1:t.major<i.major?-1:t.minor>i.minor?1:t.minor<i.minor?-1:0}_logOpen(t){this._log(t),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(t){let i=n._logSpaces.substring(0,this._logIndentLevel*2);P.Log(`${i}${t}`)}_logDisabled(t){}_startPerformanceCounterEnabled(t){z.StartPerformanceCounter(t)}_startPerformanceCounterDisabled(t){}_endPerformanceCounterEnabled(t){z.EndPerformanceCounter(t)}_endPerformanceCounterDisabled(t){}}return n.IncrementalLoading=!0,n.HomogeneousCoordinates=!1,n._logSpaces="                                ",n})();Wu(new Hr);var gs=(function(n){return n[n.BYTE=5120]="BYTE",n[n.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",n[n.SHORT=5122]="SHORT",n[n.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",n[n.FLOAT=5126]="FLOAT",n})(gs||{}),Gb=(function(n){return n[n.FRAGMENT=35632]="FRAGMENT",n[n.VERTEX=35633]="VERTEX",n})(Gb||{}),wi=(function(n){return n[n.BYTE=5120]="BYTE",n[n.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",n[n.SHORT=5122]="SHORT",n[n.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",n[n.INT=5124]="INT",n[n.UNSIGNED_INT=5125]="UNSIGNED_INT",n[n.FLOAT=5126]="FLOAT",n[n.FLOAT_VEC2=35664]="FLOAT_VEC2",n[n.FLOAT_VEC3=35665]="FLOAT_VEC3",n[n.FLOAT_VEC4=35666]="FLOAT_VEC4",n[n.INT_VEC2=35667]="INT_VEC2",n[n.INT_VEC3=35668]="INT_VEC3",n[n.INT_VEC4=35669]="INT_VEC4",n[n.BOOL=35670]="BOOL",n[n.BOOL_VEC2=35671]="BOOL_VEC2",n[n.BOOL_VEC3=35672]="BOOL_VEC3",n[n.BOOL_VEC4=35673]="BOOL_VEC4",n[n.FLOAT_MAT2=35674]="FLOAT_MAT2",n[n.FLOAT_MAT3=35675]="FLOAT_MAT3",n[n.FLOAT_MAT4=35676]="FLOAT_MAT4",n[n.SAMPLER_2D=35678]="SAMPLER_2D",n})(wi||{}),Yu=(function(n){return n[n.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",n[n.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",n[n.REPEAT=10497]="REPEAT",n})(Yu||{}),Wn=(function(n){return n[n.NEAREST=9728]="NEAREST",n[n.LINEAR=9728]="LINEAR",n[n.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",n[n.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",n[n.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",n[n.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",n})(Wn||{});var Ub=(function(n){return n[n.FRONT=1028]="FRONT",n[n.BACK=1029]="BACK",n[n.FRONT_AND_BACK=1032]="FRONT_AND_BACK",n})(Ub||{}),wt=(function(n){return n[n.ZERO=0]="ZERO",n[n.ONE=1]="ONE",n[n.SRC_COLOR=768]="SRC_COLOR",n[n.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",n[n.DST_COLOR=774]="DST_COLOR",n[n.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",n[n.SRC_ALPHA=770]="SRC_ALPHA",n[n.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",n[n.DST_ALPHA=772]="DST_ALPHA",n[n.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",n[n.CONSTANT_COLOR=32769]="CONSTANT_COLOR",n[n.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",n[n.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",n[n.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",n[n.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",n})(wt||{});Ut.AddNodeConstructor("TargetCamera",(n,e)=>()=>new gi(n,m.Zero(),e));var Bp=L.Zero(),zb=Q.Identity(),gi=class n extends Fe{constructor(e,t,i,r=!0){super(e,t,i,r),this.cameraDirection=new m(0,0,0),this.cameraRotation=new me(0,0),this.updateUpVectorFromRotation=!1,this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this._panningEpsilon=tt,this._rotationEpsilon=tt,this.lockedTarget=null,this._currentTarget=m.Zero(),this._initialFocalDistance=1,this._viewMatrix=L.Zero(),this._cameraTransformMatrix=L.Zero(),this._cameraRotationMatrix=L.Zero(),this._transformedReferencePoint=m.Zero(),this._deferredPositionUpdate=new m,this._deferredRotationQuaternionUpdate=new Q,this._deferredRotationUpdate=new m,this._deferredUpdated=!1,this._deferOnly=!1,this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0,this._referencePoint=m.Forward(this.getScene().useRightHandedSystem),this.rotation=new m(0,this.getScene().useRightHandedSystem?Math.PI:0,0)}getFrontPosition(e){this.getWorldMatrix();let t=k.Vector3[0],i=k.Vector3[1];return i.set(0,0,this._scene.useRightHandedSystem?-1:1),this.getDirectionToRef(i,t),t.scaleInPlace(e),this.globalPosition.add(t)}_getLockedTargetPosition(){if(!this.lockedTarget)return null;if(this.lockedTarget.absolutePosition){let e=this.lockedTarget;e.computeWorldMatrix().getTranslationToRef(e.absolutePosition)}return this.lockedTarget.absolutePosition||this.lockedTarget}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return super._restoreStateValues()?(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&this._storedRotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0):!1}_initCache(){super._initCache(),this._cache.lockedTarget=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new Q(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}_updateCache(e){e||super._updateCache();let t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return!1;let e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){let e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(e.getFps()*100))}setTarget(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=tt),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),this.getScene().useRightHandedSystem?L.LookAtRHToRef(this.position,e,m.UpReadOnly,Bp):L.LookAtLHToRef(this.position,e,m.UpReadOnly,Bp),Bp.invert();let t=this.rotationQuaternion||zb;Q.FromRotationMatrixToRef(Bp,t),t.toEulerAnglesToRef(this.rotation),this.rotation.z=0}get target(){return this.getTarget()}set target(e){this.setTarget(e)}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent){this.parent.getWorldMatrix().invertToRef(k.Matrix[0]),m.TransformNormalToRef(this.cameraDirection,k.Matrix[0],k.Vector3[0]),this._deferredPositionUpdate.addInPlace(k.Vector3[0]),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate);return}this._deferredPositionUpdate.addInPlace(this.cameraDirection),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate)}_checkInputs(){let e=this.invertRotation?-this.inverseRotationSpeed:1,t=this._decideIfNeedsToMove(),i=this.cameraRotation.x||this.cameraRotation.y;this._deferredUpdated=!1,this._deferredRotationUpdate.copyFrom(this.rotation),this._deferredPositionUpdate.copyFrom(this.position),this.rotationQuaternion&&this._deferredRotationQuaternionUpdate.copyFrom(this.rotationQuaternion),t&&this._updatePosition(),i&&(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this._deferredRotationUpdate),this._deferredRotationUpdate.x+=this.cameraRotation.x*e,this._deferredRotationUpdate.y+=this.cameraRotation.y*e,this.noRotationConstraint||(this._deferredRotationUpdate.x>1.570796&&(this._deferredRotationUpdate.x=1.570796),this._deferredRotationUpdate.x<-1.570796&&(this._deferredRotationUpdate.x=-1.570796)),this._deferOnly?this._deferredUpdated=!0:this.rotation.copyFrom(this._deferredRotationUpdate),this.rotationQuaternion&&this._deferredRotationUpdate.lengthSquared()&&(Q.RotationYawPitchRollToRef(this._deferredRotationUpdate.y,this._deferredRotationUpdate.x,this._deferredRotationUpdate.z,this._deferredRotationQuaternionUpdate),this._deferOnly?this._deferredUpdated=!0:this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate)));let r=this.speed*this._panningEpsilon,s=this.speed*this._rotationEpsilon;t&&(Math.abs(this.cameraDirection.x)<r&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<r&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<r&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),i&&(Math.abs(this.cameraRotation.x)<s&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<s&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs()}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):L.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}_rotateUpVectorWithCameraRotationMatrix(){return m.TransformNormalToRef(m.UpReadOnly,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),m.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?Li.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(Q.FromEulerVectorToRef(this.rotation,zb),Li.Y.rotateByQuaternionToRef(zb,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(e,t,i){if(this.getScene().useRightHandedSystem?L.LookAtRHToRef(e,t,i,this._viewMatrix):L.LookAtLHToRef(e,t,i,this._viewMatrix),this.parent){let r=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(r,this._viewMatrix),this._viewMatrix.invert(),this._markSyncedWithParent()}}createRigCamera(e,t){if(this.cameraRigMode!==Fe.RIG_MODE_NONE){let i=new n(e,this.position.clone(),this.getScene());return i.isRigCamera=!0,i.rigParent=this,this.cameraRigMode===Fe.RIG_MODE_VR&&(this.rotationQuaternion||(this.rotationQuaternion=new Q),i._cameraRigParams={},i.rotationQuaternion=new Q),i.mode=this.mode,i.orthoLeft=this.orthoLeft,i.orthoRight=this.orthoRight,i.orthoTop=this.orthoTop,i.orthoBottom=this.orthoBottom,i}return null}_updateRigCameras(){let e=this._rigCameras[0],t=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case Fe.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Fe.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Fe.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case Fe.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Fe.RIG_MODE_STEREOSCOPIC_INTERLACED:{let i=this.cameraRigMode===Fe.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,r=this.cameraRigMode===Fe.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*i,e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*r,t);break}case Fe.RIG_MODE_VR:e.rotationQuaternion&&t.rotationQuaternion&&this.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position);break}super._updateRigCameras()}_getRigCamPositionAndTarget(e,t){this.getTarget().subtractToRef(this.position,n._TargetFocalPoint),n._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);let r=n._TargetFocalPoint.addInPlace(this.position);L.TranslationToRef(-r.x,-r.y,-r.z,n._TargetTransformMatrix),n._TargetTransformMatrix.multiplyToRef(L.RotationAxis(t.upVector,e),n._RigCamTransformMatrix),L.TranslationToRef(r.x,r.y,r.z,n._TargetTransformMatrix),n._RigCamTransformMatrix.multiplyToRef(n._TargetTransformMatrix,n._RigCamTransformMatrix),m.TransformCoordinatesToRef(this.position,n._RigCamTransformMatrix,t.position),t.setTarget(r)}getClassName(){return"TargetCamera"}};gi._RigCamTransformMatrix=new L;gi._TargetTransformMatrix=new L;gi._TargetFocalPoint=new m;w([B()],gi.prototype,"updateUpVectorFromRotation",void 0);w([Jt()],gi.prototype,"rotation",void 0);w([B()],gi.prototype,"speed",void 0);w([Aa("lockedTargetId")],gi.prototype,"lockedTarget",void 0);var Vt={},Fl=class{constructor(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=()=>{}}add(e){let t=e.getSimpleName();if(this.attached[t]){P.Warn("camera input of type "+t+" already exists on camera");return}this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl(this.noPreventDefault)}remove(e){for(let t in this.attached){let i=this.attached[t];if(i===e){i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck();return}}}removeByType(e){for(let t in this.attached){let i=this.attached[t];i.getClassName()===e&&(i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck())}}_addCheckInputs(e){let t=this.checkInputs;return()=>{t(),e()}}attachInput(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)}attachElement(e=!1){if(!this.attachedToElement){e=Fe.ForceAttachControlToAlwaysPreventDefault?!1:e,this.attachedToElement=!0,this.noPreventDefault=e;for(let t in this.attached)this.attached[t].attachControl(e)}}detachElement(e=!1){for(let t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=!1}rebuildInputCheck(){this.checkInputs=()=>{};for(let e in this.attached){let t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}}clear(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=()=>{}}serialize(e){let t={};for(let i in this.attached){let r=this.attached[i],s=je.Serialize(r);t[r.getClassName()]=s}e.inputsmgr=t}parse(e){let t=e.inputsmgr;if(t){this.clear();for(let i in t){let r=Vt[i];if(r){let s=t[i],o=je.Parse(()=>new r,s,null);this.add(o)}}}else for(let i in this.attached){let r=Vt[this.attached[i].getClassName()];if(r){let s=je.Parse(()=>new r,e,null);this.remove(this.attached[i]),this.add(s)}}}};var Mi=class{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array}attachControl(e){e=z.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{let i=t.event;if(!i.metaKey){if(t.type===Lh.KEYDOWN)(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1||this.keysRotateUp.indexOf(i.keyCode)!==-1||this.keysRotateDown.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),e||i.preventDefault());else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1||this.keysRotateUp.indexOf(i.keyCode)!==-1||this.keysRotateDown.indexOf(i.keyCode)!==-1){let r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),e||i.preventDefault()}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){let e=this.camera;for(let t=0;t<this._keys.length;t++){let i=this._keys[t],r=e._computeLocalCameraSpeed();this.keysLeft.indexOf(i)!==-1?e._localDirection.copyFromFloats(-r,0,0):this.keysUp.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,r):this.keysRight.indexOf(i)!==-1?e._localDirection.copyFromFloats(r,0,0):this.keysDown.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,-r):this.keysUpward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,r,0):this.keysDownward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,-r,0):this.keysRotateLeft.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):this.keysRotateRight.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):this.keysRotateUp.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):this.keysRotateDown.indexOf(i)!==-1&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),m.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){let e=this.camera._calculateHandednessMultiplier();return this.rotationSpeed*this._engine.getDeltaTime()/1e3*e}};w([B()],Mi.prototype,"keysUp",void 0);w([B()],Mi.prototype,"keysUpward",void 0);w([B()],Mi.prototype,"keysDown",void 0);w([B()],Mi.prototype,"keysDownward",void 0);w([B()],Mi.prototype,"keysLeft",void 0);w([B()],Mi.prototype,"keysRight",void 0);w([B()],Mi.prototype,"rotationSpeed",void 0);w([B()],Mi.prototype,"keysRotateLeft",void 0);w([B()],Mi.prototype,"keysRotateRight",void 0);w([B()],Mi.prototype,"keysRotateUp",void 0);w([B()],Mi.prototype,"keysRotateDown",void 0);Vt.FreeCameraKeyboardMoveInput=Mi;var $o=class{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new F,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}attachControl(e){e=z.BackCompatCameraNoPreventDefault(arguments);let t=this.camera.getEngine(),i=t.getInputElement();this._pointerInput||(this._pointerInput=r=>{let s=r.event,o=s.pointerType==="touch";if(!this.touchEnabled&&o||r.type!==Ee.POINTERMOVE&&this.buttons.indexOf(s.button)===-1)return;let a=s.target;if(r.type===Ee.POINTERDOWN){if(o&&this._activePointerId!==-1||!o&&this._currentActiveButton!==-1)return;this._activePointerId=s.pointerId;try{a?.setPointerCapture(s.pointerId)}catch{}this._currentActiveButton===-1&&(this._currentActiveButton=s.button),this._previousPosition={x:s.clientX,y:s.clientY},e||(s.preventDefault(),i&&i.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(r.event)}else if(r.type===Ee.POINTERUP){if(o&&this._activePointerId!==s.pointerId||!o&&this._currentActiveButton!==s.button)return;try{a?.releasePointerCapture(s.pointerId)}catch{}this._currentActiveButton=-1,this._previousPosition=null,e||s.preventDefault(),this._activePointerId=-1}else if(r.type===Ee.POINTERMOVE&&(this._activePointerId===s.pointerId||!o)){if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(r.event);else if(this._previousPosition){let l=this.camera._calculateHandednessMultiplier(),c=(s.clientX-this._previousPosition.x)*l,u=(s.clientY-this._previousPosition.y)*l;this._allowCameraRotation&&(this.camera.cameraRotation.y+=c/this.angularSensibility,this.camera.cameraRotation.x+=u/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:c,offsetY:u}),this._previousPosition={x:s.clientX,y:s.clientY},e||s.preventDefault()}}}),this._onMouseMove=r=>{if(!t.isPointerLock)return;let s=this.camera._calculateHandednessMultiplier();this.camera.cameraRotation.y+=r.movementX*s/this.angularSensibility,this.camera.cameraRotation.x+=r.movementY*s/this.angularSensibility,this._previousPosition=null,e||r.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Ee.POINTERDOWN|Ee.POINTERUP|Ee.POINTERMOVE),i&&(this._contextMenuBind=r=>this.onContextMenu(r),i.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){let t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._activePointerId=-1,this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}};w([B()],$o.prototype,"buttons",void 0);w([B()],$o.prototype,"angularSensibility",void 0);Vt.FreeCameraMouseInput=$o;var jo=class{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new F,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=z.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Ee.POINTERWHEEL)return;let i=t.event,r=i.deltaMode===Bh.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*r*i.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*r*i.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*r*i.deltaZ/this._normalize,i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Ee.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}};w([B()],jo.prototype,"wheelPrecisionX",void 0);w([B()],jo.prototype,"wheelPrecisionY",void 0);w([B()],jo.prototype,"wheelPrecisionZ",void 0);var ut=(function(n){return n[n.MoveRelative=0]="MoveRelative",n[n.RotateRelative=1]="RotateRelative",n[n.MoveScene=2]="MoveScene",n})(ut||{}),cn=class extends jo{constructor(){super(...arguments),this._moveRelative=m.Zero(),this._rotateRelative=m.Zero(),this._moveScene=m.Zero(),this._wheelXAction=ut.MoveRelative,this._wheelXActionCoordinate=0,this._wheelYAction=ut.MoveRelative,this._wheelYActionCoordinate=2,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){e===null&&this._wheelXAction!==ut.MoveRelative||(this._wheelXAction=ut.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==ut.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){e===null&&this._wheelYAction!==ut.MoveRelative||(this._wheelYAction=ut.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==ut.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){e===null&&this._wheelZAction!==ut.MoveRelative||(this._wheelZAction=ut.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==ut.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){e===null&&this._wheelXAction!==ut.RotateRelative||(this._wheelXAction=ut.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==ut.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){e===null&&this._wheelYAction!==ut.RotateRelative||(this._wheelYAction=ut.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==ut.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){e===null&&this._wheelZAction!==ut.RotateRelative||(this._wheelZAction=ut.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==ut.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){e===null&&this._wheelXAction!==ut.MoveScene||(this._wheelXAction=ut.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==ut.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){e===null&&this._wheelYAction!==ut.MoveScene||(this._wheelYAction=ut.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==ut.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){e===null&&this._wheelZAction!==ut.MoveScene||(this._wheelZAction=ut.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==ut.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(this._wheelDeltaX===0&&this._wheelDeltaY===0&&this._wheelDeltaZ==0)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);let e=L.Zero();this.camera.getViewMatrix().invertToRef(e);let t=m.Zero();m.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,i){if(e===0||t===null||i===null)return;let r=null;switch(t){case ut.MoveRelative:r=this._moveRelative;break;case ut.RotateRelative:r=this._rotateRelative;break;case ut.MoveScene:r=this._moveScene;break}switch(i){case 0:r.set(e,0,0);break;case 1:r.set(0,e,0);break;case 2:r.set(0,0,e);break}}};w([B()],cn.prototype,"wheelXMoveRelative",null);w([B()],cn.prototype,"wheelYMoveRelative",null);w([B()],cn.prototype,"wheelZMoveRelative",null);w([B()],cn.prototype,"wheelXRotateRelative",null);w([B()],cn.prototype,"wheelYRotateRelative",null);w([B()],cn.prototype,"wheelZRotateRelative",null);w([B()],cn.prototype,"wheelXMoveScene",null);w([B()],cn.prototype,"wheelYMoveScene",null);w([B()],cn.prototype,"wheelZMoveScene",null);Vt.FreeCameraMouseWheelInput=cn;var qo=class{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=z.IsSafari()}attachControl(e){e=z.BackCompatCameraNoPreventDefault(arguments);let t=null;if(this._pointerInput===void 0&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=i=>{let r=i.event,s=r.pointerType==="mouse"||this._isSafari&&typeof r.pointerType>"u";if(!(!this.allowMouse&&s)){if(i.type===Ee.POINTERDOWN){if(e||r.preventDefault(),this._pointerPressed.push(r.pointerId),this._pointerPressed.length!==1)return;t={x:r.clientX,y:r.clientY}}else if(i.type===Ee.POINTERUP){e||r.preventDefault();let o=this._pointerPressed.indexOf(r.pointerId);if(o===-1||(this._pointerPressed.splice(o,1),o!=0))return;t=null,this._offsetX=null,this._offsetY=null}else if(i.type===Ee.POINTERMOVE){if(e||r.preventDefault(),!t||this._pointerPressed.indexOf(r.pointerId)!=0)return;this._offsetX=r.clientX-t.x,this._offsetY=-(r.clientY-t.y)}}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Ee.POINTERDOWN|Ee.POINTERUP|Ee.POINTERMOVE),this._onLostFocus){let r=this.camera.getEngine().getInputElement();r&&r.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){let t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(this._offsetX===null||this._offsetY===null||this._offsetX===0&&this._offsetY===0)return;let e=this.camera,t=e._calculateHandednessMultiplier();if(e.cameraRotation.y=this._offsetX*t/this.touchAngularSensibility,this.singleFingerRotate&&this._pointerPressed.length===1||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-(this._offsetY*t)/this.touchAngularSensibility;else{let r=e._computeLocalCameraSpeed(),s=new m(0,0,this.touchMoveSensibility!==0?r*this._offsetY/this.touchMoveSensibility:0);L.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(m.TransformCoordinates(s,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}};w([B()],qo.prototype,"touchAngularSensibility",void 0);w([B()],qo.prototype,"touchMoveSensibility",void 0);Vt.FreeCameraTouchInput=qo;var Ys=class extends Fl{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new Mi),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new $o(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new cn,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new qo),this}clear(){super.clear(),this._mouseInput=null}};var Bt=class extends gi{get angularSensibility(){let e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){let t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){let e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){let t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){let e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){let t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){let e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){let t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){let e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){let t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){let e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){let t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){let e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){let t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){let e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){let t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){let e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){let t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}get keysRotateUp(){let e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){let t=this.inputs.attached.keyboard;t&&(t.keysRotateUp=e)}get keysRotateDown(){let e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){let t=this.inputs.attached.keyboard;t&&(t.keysRotateDown=e)}constructor(e,t,i,r=!0){super(e,t,i,r),this.ellipsoid=new m(.5,1,.5),this.ellipsoidOffset=new m(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=m.Zero(),this._diffPosition=m.Zero(),this._newPosition=m.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(s,o,a=null)=>{this._newPosition.copyFrom(o),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>ne.CollisionsEpsilon&&(this.position.addToRef(this._diffPosition,this._deferredPositionUpdate),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate),this.onCollide&&a&&this.onCollide(a))},this.inputs=new Ys(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=z.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new m(0,0,0),this.cameraRotation=new me(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;this.parent?t=m.TransformCoordinates(this.position,this.parent.getWorldMatrix()):t=this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);let i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let r=e;this.applyGravity&&(r=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,r,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=m.Zero(),this._transformedDirection=m.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}};w([Jt()],Bt.prototype,"ellipsoid",void 0);w([Jt()],Bt.prototype,"ellipsoidOffset",void 0);w([B()],Bt.prototype,"checkCollisions",void 0);w([B()],Bt.prototype,"applyGravity",void 0);le("BABYLON.FreeCamera",Bt);var _i=class n extends Z{constructor(e,t,i,r,s,o=!0,a=!1,l=3,c=0,u,h,d){super(null,s,!o,a,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,u),this.format=r,this._engine&&(!this._engine._caps.textureFloatLinearFiltering&&c===1&&(l=1),!this._engine._caps.textureHalfFloatLinearFiltering&&c===2&&(l=1),this._texture=this._engine.createRawTexture(e,t,i,r,o,a,l,null,c,u??0,h??!1),this.wrapU=Z.CLAMP_ADDRESSMODE,this.wrapV=Z.CLAMP_ADDRESSMODE,this._waitingForData=!!d&&!e)}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer),this._waitingForData=!1}clone(){if(!this._texture)return super.clone();let e=new n(null,this.getSize().width,this.getSize().height,this.format,this.getScene(),this._texture.generateMipMaps,this._invertY,this.samplingMode,this._texture.type,this._texture._creationFlags,this._useSRGBBuffer);return e._texture=this._texture,this._texture.incrementReferences(),e}isReady(){return super.isReady()&&!this._waitingForData}static CreateLuminanceTexture(e,t,i,r,s=!0,o=!1,a=3){return new n(e,t,i,1,r,s,o,a)}static CreateLuminanceAlphaTexture(e,t,i,r,s=!0,o=!1,a=3){return new n(e,t,i,2,r,s,o,a)}static CreateAlphaTexture(e,t,i,r,s=!0,o=!1,a=3){return new n(e,t,i,0,r,s,o,a)}static CreateRGBTexture(e,t,i,r,s=!0,o=!1,a=3,l=0,c=0,u=!1){return new n(e,t,i,4,r,s,o,a,l,c,u)}static CreateRGBATexture(e,t,i,r,s=!0,o=!1,a=3,l=0,c=0,u=!1,h=!1){return new n(e,t,i,5,r,s,o,a,l,c,u,h)}static CreateRGBAStorageTexture(e,t,i,r,s=!0,o=!1,a=3,l=0,c=!1){return new n(e,t,i,5,r,s,o,a,l,1,c)}static CreateRTexture(e,t,i,r,s=!0,o=!1,a=Z.TRILINEAR_SAMPLINGMODE,l=1){return new n(e,t,i,6,r,s,o,a,l)}static CreateRStorageTexture(e,t,i,r,s=!0,o=!1,a=Z.TRILINEAR_SAMPLINGMODE,l=1){return new n(e,t,i,6,r,s,o,a,l,1)}};var Wr=class n{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,t,i){this.name=e,this.id=t,this.bones=[],this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=L.Identity(),this._currentRenderId=-1,this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new F,this.metadata=null,this.bones=[],this._scene=i||ye.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;let r=this._scene.getEngine().getCaps();this._canUseTextureForBones=r.textureFloat&&r.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter(e=>!e.getParent())}getTransformMatrices(e){if(this.needInitialSkinMatrix){if(!e)throw new Error("getTransformMatrices: When using the needInitialSkinMatrix flag, a mesh must be provided");return e._bonesTransformMatrices||this.prepare(!0),e._bonesTransformMatrices}return(!this._transformMatrices||this._isDirty)&&this.prepare(!this._transformMatrices),this._transformMatrices}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){t+=", Ranges: {";let i=!0;for(let r in this._ranges)i&&(t+=", ",i=!1),t+=r;t+="}"}return t}getBoneIndexByName(e){for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].name===e)return t;return-1}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=new Jg(e,t,i);for(let r=0,s=this.bones.length;r<s;r++)this.bones[r].animations[0]&&this.bones[r].animations[0].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,r=this.bones.length;i<r;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){let e=[],t;for(t in this._ranges)e.push(this._ranges[t]);return e}copyAnimationRange(e,t,i=!1){if(this._ranges[t]||!e.getAnimationRange(t))return!1;let r=!0,s=this._getHighestAnimationFrame()+1,o={},a=e.bones,l,c;for(c=0,l=a.length;c<l;c++)o[a[c].name]=a[c];this.bones.length!==a.length&&(P.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${a.length}`),r=!1);let u=i&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(c=0,l=this.bones.length;c<l;c++){let d=this.bones[c].name,f=o[d];f?r=r&&this.bones[c].copyAnimationRange(f,t,s,i,u):(P.Warn("copyAnimationRange: not same rig, missing source bone "+d),r=!1)}let h=e.getAnimationRange(t);return h&&(this._ranges[t]=new Jg(t,h.from+s,h.to+s)),r}returnToRest(){for(let e of this.bones)e._index!==-1&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].animations[0]){let r=this.bones[t].animations[0].getHighestFrame();e<r&&(e=r)}return e}beginAnimation(e,t,i,r){let s=this.getAnimationRange(e);return s?this._scene.beginAnimation(this,s.from,s.to,t,i,r):null}static MakeAnimationAdditive(e,t=0,i){let r=e.getAnimationRange(i);if(!r)return null;let s=e._scene.getAllAnimatablesByTarget(e),o=null;for(let l=0;l<s.length;l++){let c=s[l];if(c.fromFrame===r?.from&&c.toFrame===r?.to){o=c;break}}let a=e.getAnimatables();for(let l=0;l<a.length;l++){let u=a[l].animations;if(u)for(let h=0;h<u.length;h++)H.MakeAnimationAdditive(u[h],t,i)}return o&&(o.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){let t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let i=0;i<this.bones.length;i++){let r=this.bones[i];r._childUpdateId++;let s=r.getParent();if(s?r.getLocalMatrix().multiplyToRef(s.getFinalMatrix(),r.getFinalMatrix()):t?r.getLocalMatrix().multiplyToRef(t,r.getFinalMatrix()):r.getFinalMatrix().copyFrom(r.getLocalMatrix()),r._index!==-1){let o=r._index===null?i:r._index;r.getAbsoluteInverseBindMatrix().multiplyToArray(r.getFinalMatrix(),e,o*16)}}this._identity.copyToArray(e,this.bones.length*16)}prepare(e=!1){if(!e){let t=this.getScene().getRenderId();if(this._currentRenderId===t)return;this._currentRenderId=t}if(this._numBonesWithLinkedTransformNode>0){for(let t of this.bones)if(t._linkedTransformNode){let i=t._linkedTransformNode;t.position=i.position,i.rotationQuaternion?t.rotationQuaternion=i.rotationQuaternion:t.rotation=i.rotation,t.scaling=i.scaling}}if(this.needInitialSkinMatrix)for(let t of this._meshesWithPoseMatrix){let i=t.getPoseMatrix(),r=this._isDirty;if((!t._bonesTransformMatrices||t._bonesTransformMatrices.length!==16*(this.bones.length+1))&&(t._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),r=!0),!!r){if(this._synchronizedWithMesh!==t){this._synchronizedWithMesh=t;for(let s of this.bones)s.getParent()||(s.getBindMatrix().multiplyToRef(i,k.Matrix[1]),s._updateAbsoluteBindMatrices(k.Matrix[1]));if(this.isUsingTextureForMatrices){let s=(this.bones.length+1)*4;(!t._transformMatrixTexture||t._transformMatrixTexture.getSize().width!==s)&&(t._transformMatrixTexture&&t._transformMatrixTexture.dispose(),t._transformMatrixTexture=_i.CreateRGBATexture(t._bonesTransformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(t._bonesTransformMatrices,i),this.isUsingTextureForMatrices&&t._transformMatrixTexture&&t._transformMatrixTexture.update(t._bonesTransformMatrices)}}else{if(!this._isDirty)return;(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=_i.CreateRGBATexture(this._transformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,t){let i=new n(e,t||e,this._scene);i.needInitialSkinMatrix=this.needInitialSkinMatrix,i.metadata=this.metadata;for(let r=0;r<this.bones.length;r++){let s=this.bones[r],o=null,a=s.getParent();if(a){let c=this.bones.indexOf(a);o=i.bones[c]}let l=new Cr(s.name,i,o,s.getBindMatrix().clone(),s.getRestMatrix().clone());l._index=s._index,s._linkedTransformNode&&l.linkTransformNode(s._linkedTransformNode),Tt.DeepCopy(s.animations,l.animations)}if(this._ranges){i._ranges={};for(let r in this._ranges){let s=this._ranges[r];s&&(i._ranges[r]=s.clone())}}return this._isDirty=!0,i.prepare(!0),i}enableBlending(e=.01){for(let t of this.bones)for(let i of t.animations)i.enableBlending=!0,i.blendingSpeed=e}dispose(){if(this._meshesWithPoseMatrix.length=0,this.metadata=null,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){let e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){let e={};e.name=this.name,e.id=this.id,this.dimensionsAtRest&&(e.dimensionsAtRest=this.dimensionsAtRest.asArray()),e.bones=[],e.needInitialSkinMatrix=this.needInitialSkinMatrix,this.metadata&&(e.metadata=this.metadata);for(let t=0;t<this.bones.length;t++){let i=this.bones[t],r=i.getParent(),s={parentBoneIndex:r?this.bones.indexOf(r):-1,index:i.getIndex(),name:i.name,id:i.id,matrix:i.getBindMatrix().asArray(),rest:i.getRestMatrix().asArray(),linkedTransformNodeId:i.getTransformNode()?.id};e.bones.push(s),i.length&&(s.length=i.length),i.metadata&&(s.metadata=i.metadata),i.animations&&i.animations.length>0&&(s.animation=i.animations[0].serialize()),e.ranges=[];for(let o in this._ranges){let a=this._ranges[o];if(!a)continue;let l={};l.name=o,l.from=a.from,l.to=a.to,e.ranges.push(l)}}return e}static Parse(e,t){let i=new n(e.name,e.id,t);e.dimensionsAtRest&&(i.dimensionsAtRest=m.FromArray(e.dimensionsAtRest)),i.needInitialSkinMatrix=e.needInitialSkinMatrix,e.metadata&&(i.metadata=e.metadata);let r;for(r=0;r<e.bones.length;r++){let s=e.bones[r],o=e.bones[r].index,a=null;s.parentBoneIndex>-1&&(a=i.bones[s.parentBoneIndex]);let l=s.rest?L.FromArray(s.rest):null,c=new Cr(s.name,i,a,L.FromArray(s.matrix),l,null,o);s.id!==void 0&&s.id!==null&&(c.id=s.id),s.length&&(c.length=s.length),s.metadata&&(c.metadata=s.metadata),s.animation&&c.animations.push(H.Parse(s.animation)),s.linkedTransformNodeId!==void 0&&s.linkedTransformNodeId!==null&&(i._hasWaitingData=!0,c._waitingTransformNodeId=s.linkedTransformNodeId)}if(e.ranges)for(r=0;r<e.ranges.length;r++){let s=e.ranges[r];i.createAnimationRange(s.name,s.from,s.to)}return i}computeAbsoluteMatrices(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteMatrices(),this._absoluteTransformIsDirty=!1)}computeAbsoluteTransforms(e=!1){this.computeAbsoluteMatrices(e)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){let e=[],t=new Array(this.bones.length);for(let i=0;i<this.bones.length;i++)this._sortBones(i,e,t);this.bones=e}_sortBones(e,t,i){if(i[e])return;i[e]=!0;let r=this.bones[e];if(!r)return;r._index===void 0&&(r._index=e);let s=r.getParent();s&&this._sortBones(this.bones.indexOf(s),t,i),t.push(r)}setCurrentPoseAsRest(){for(let e of this.bones)e.setCurrentPoseAsRest()}};var Hb={effect:null,subMesh:null},Wb=class extends td(ws){},$b=class extends La(Wb){constructor(e){super(e),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_POSITION=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.MORPHTARGETS_UV2=!1,this.MORPHTARGETS_COLOR=!1,this.MORPHTARGETTEXTURE_HASPOSITIONS=!1,this.MORPHTARGETTEXTURE_HASNORMALS=!1,this.MORPHTARGETTEXTURE_HASTANGENTS=!1,this.MORPHTARGETTEXTURE_HASUVS=!1,this.MORPHTARGETTEXTURE_HASUV2S=!1,this.MORPHTARGETTEXTURE_HASCOLORS=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_COLOR=!1,this.PREPASS_COLOR_INDEX=-1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO=!1,this.PREPASS_ALBEDO_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.PREPASS_NORMALIZED_VIEW_DEPTH=!1,this.PREPASS_NORMALIZED_VIEW_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_VELOCITY_LINEAR=!1,this.PREPASS_VELOCITY_LINEAR_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.AREALIGHTSUPPORTED=!0,this.USE_VERTEX_PULLING=!1,this.CLUSTLIGHT_SLICES=0,this.CLUSTLIGHT_BATCH=0,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.DECAL_AFTER_DETAIL=!1,this.rebuild()}},jb=class extends ka(Tr){},te=class n extends jb{get isPrePassCapable(){return!this.disableDepthWrite}get canRenderToMRT(){return!0}constructor(e,t,i=!1){super(e,t,void 0,i||n.ForceGLSL),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new U(0,0,0),this.diffuseColor=new U(1,1,1),this.specularColor=new U(1,1,1),this.emissiveColor=new U(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._applyDecalMapAfterDetailMap=!1,this._shadersLoaded=!1,this._renderTargets=new wa(16),this._globalAmbientColor=new U(0,0,0),this._cacheHasRenderTargetTextures=!1,this.detailMap=new y0(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new ed,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),n.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),n.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}get hasRenderTargetTextures(){return n.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget||n.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}needAlphaBlending(){return this._hasTransparencyMode?this._transparencyModeIsBlend:this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled}needAlphaTesting(){return this._hasTransparencyMode?this._transparencyModeIsTest:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===Re.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==Re.MATERIAL_OPAQUE}_hasAlphaChannel(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,t,i=!1){this._uniformBufferLayoutBuilt||this.buildUniformLayout();let r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(4,this._eventInfo),t.materialDefines=new $b(this._eventInfo.defineNames));let s=this.getScene(),o=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;let a=s.getEngine();o._needNormals=$h(s,e,o,!0,this._maxSimultaneousLights,this._disableLighting),qh(s,o);let l=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(Yh(s,o,this.canRenderToMRT&&!l),n0(s,o,l),Ba.PrepareDefines(a.currentRenderPassId,e,o),o._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,o._needUVs=!1;for(let u=1;u<=6;++u)o["MAINUV"+u]=!1;if(s.texturesEnabled){if(o.DIFFUSEDIRECTUV=0,o.BUMPDIRECTUV=0,o.AMBIENTDIRECTUV=0,o.OPACITYDIRECTUV=0,o.EMISSIVEDIRECTUV=0,o.SPECULARDIRECTUV=0,o.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&n.DiffuseTextureEnabled)if(this._diffuseTexture.isReadyOrNotBlocking())br(this._diffuseTexture,o,"DIFFUSE");else return!1;else o.DIFFUSE=!1;if(this._ambientTexture&&n.AmbientTextureEnabled)if(this._ambientTexture.isReadyOrNotBlocking())br(this._ambientTexture,o,"AMBIENT");else return!1;else o.AMBIENT=!1;if(this._opacityTexture&&n.OpacityTextureEnabled)if(this._opacityTexture.isReadyOrNotBlocking())br(this._opacityTexture,o,"OPACITY"),o.OPACITYRGB=this._opacityTexture.getAlphaFromRGB;else return!1;else o.OPACITY=!1;if(this._reflectionTexture&&n.ReflectionTextureEnabled?(o.ROUGHNESS=this._roughness>0,o.REFLECTIONOVERALPHA=this._useReflectionOverAlpha):(o.ROUGHNESS=!1,o.REFLECTIONOVERALPHA=!1),!jh(s,this._reflectionTexture,o))return!1;if(this._emissiveTexture&&n.EmissiveTextureEnabled)if(this._emissiveTexture.isReadyOrNotBlocking())br(this._emissiveTexture,o,"EMISSIVE");else return!1;else o.EMISSIVE=!1;if(this._lightmapTexture&&n.LightmapTextureEnabled)if(this._lightmapTexture.isReadyOrNotBlocking())br(this._lightmapTexture,o,"LIGHTMAP"),o.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,o.RGBDLIGHTMAP=this._lightmapTexture.isRGBD;else return!1;else o.LIGHTMAP=!1;if(this._specularTexture&&n.SpecularTextureEnabled)if(this._specularTexture.isReadyOrNotBlocking())br(this._specularTexture,o,"SPECULAR"),o.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha;else return!1;else o.SPECULAR=!1;if(s.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&n.BumpTextureEnabled){if(this._bumpTexture.isReady())br(this._bumpTexture,o,"BUMP"),o.PARALLAX=this._useParallax,o.PARALLAX_RHS=s.useRightHandedSystem,o.PARALLAXOCCLUSION=this._useParallaxOcclusion;else return!1;o.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else o.BUMP=!1,o.PARALLAX=!1,o.PARALLAX_RHS=!1,o.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&n.RefractionTextureEnabled)if(this._refractionTexture.isReadyOrNotBlocking())o._needUVs=!0,o.REFRACTION=!0,o.REFRACTIONMAP_3D=this._refractionTexture.isCube,o.RGBDREFRACTION=this._refractionTexture.isRGBD,o.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize;else return!1;else o.REFRACTION=!1;o.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else o.DIFFUSE=!1,o.AMBIENT=!1,o.OPACITY=!1,o.REFLECTION=!1,o.EMISSIVE=!1,o.LIGHTMAP=!1,o.BUMP=!1,o.REFRACTION=!1;o.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),o.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,o.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,o.SPECULAROVERALPHA=this._useSpecularOverAlpha,o.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,o.ALPHATEST_AFTERALLALPHACOMPUTATIONS=this.transparencyMode!==null,o.ALPHABLEND=this.transparencyMode===null||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=o,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(o._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(o),o.IS_REFLECTION_LINEAR=this.reflectionTexture!=null&&!this.reflectionTexture.gammaSpace,o.IS_REFRACTION_LINEAR=this.refractionTexture!=null&&!this.refractionTexture.gammaSpace}if(o._areFresnelDirty&&(n.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(o.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,o.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,o.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,o.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,o.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,o.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,o._needNormals=!0,o.FRESNEL=!0):o.FRESNEL=!1),o.AREALIGHTUSED||o.CLUSTLIGHT_BATCH){for(let u=0;u<e.lightSources.length;u++)if(!e.lightSources[u]._isReady())return!1}Pa(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),o,this._applyDecalMapAfterDetailMap,this._useVertexPulling,t.getRenderingMesh(),this._isVertexOutputInvariant),Oa(s,a,this,o,i,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=o,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),Na(e,o,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);let c=!1;if(o.isDirty){let u=o._areLightsDisposed;o.markAsProcessed();let h=new vr;o.REFLECTION&&h.addFallback(0,"REFLECTION"),o.SPECULAR&&h.addFallback(0,"SPECULAR"),o.BUMP&&h.addFallback(0,"BUMP"),o.PARALLAX&&h.addFallback(1,"PARALLAX"),o.PARALLAX_RHS&&h.addFallback(1,"PARALLAX_RHS"),o.PARALLAXOCCLUSION&&h.addFallback(0,"PARALLAXOCCLUSION"),o.SPECULAROVERALPHA&&h.addFallback(0,"SPECULAROVERALPHA"),o.FOG&&h.addFallback(1,"FOG"),o.POINTSIZE&&h.addFallback(0,"POINTSIZE"),o.LOGARITHMICDEPTH&&h.addFallback(0,"LOGARITHMICDEPTH"),Wh(o,h,this._maxSimultaneousLights),o.SPECULARTERM&&h.addFallback(0,"SPECULARTERM"),o.DIFFUSEFRESNEL&&h.addFallback(1,"DIFFUSEFRESNEL"),o.OPACITYFRESNEL&&h.addFallback(2,"OPACITYFRESNEL"),o.REFLECTIONFRESNEL&&h.addFallback(3,"REFLECTIONFRESNEL"),o.EMISSIVEFRESNEL&&h.addFallback(4,"EMISSIVEFRESNEL"),o.FRESNEL&&h.addFallback(4,"FRESNEL"),o.MULTIVIEW&&h.addFallback(0,"MULTIVIEW");let d=[T.PositionKind];o.NORMAL&&d.push(T.NormalKind),o.TANGENT&&d.push(T.TangentKind);for(let x=1;x<=6;++x)o["UV"+x]&&d.push(`uv${x===1?"":x}`);o.VERTEXCOLOR&&d.push(T.ColorKind),Hh(d,e,o,h),Ra(d,o),JT(d,e,o),i0(d,e,o);let f="default",p=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices","cameraInfo"],g=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler","areaLightsLTC1Sampler","areaLightsLTC2Sampler"];Kh(p,g,!1);let _=["Material","Scene","Mesh"],y={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:o.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=h,this._eventInfo.fallbackRank=0,this._eventInfo.defines=o,this._eventInfo.uniforms=p,this._eventInfo.attributes=d,this._eventInfo.samplers=g,this._eventInfo.uniformBuffersNames=_,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=y,this._callbackPluginEventGeneric(128,this._eventInfo),Ba.AddUniformsAndSamplers(p,g),ed.AddUniforms(p),ed.AddSamplers(g),gn&&(gn.PrepareUniforms(p,o),gn.PrepareSamplers(g,o)),Xh({uniformsNames:p,uniformBuffersNames:_,samplers:g,defines:o,maxSimultaneousLights:this._maxSimultaneousLights}),Yi(p);let b={};this.customShaderNameResolve&&(f=this.customShaderNameResolve(f,p,_,g,o,d,b));let A=o.toString(),I=t.effect,v=s.getEngine().createEffect(f,{attributes:d,uniformsNames:p,uniformBuffersNames:_,samplers:g,defines:A,fallbacks:h,onCompiled:this.onCompiled,onError:this.onError,indexParameters:y,processFinalCode:b.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:o.PREPASS,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:()=>S(this,null,function*(){this._shaderLanguage===1?yield Promise.all([import("./chunk-6RZX4B7Q.js"),import("./chunk-NZMAYNPD.js")]):yield Promise.all([import("./chunk-PV37QPNS.js"),import("./chunk-DHVATVDK.js")]),this._shadersLoaded=!0})},a);if(this._eventInfo.customCode=void 0,v)if(this._onEffectCreatedObservable&&(Hb.effect=v,Hb.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Hb)),this.allowShaderHotSwapping&&I&&!v.isReady()){if(v=I,o.markAsUnprocessed(),c=this.isFrozen,u)return o._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),t.setEffect(v,o,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(o._renderId=s.getRenderId(),r._wasPreviouslyReady=!c,r._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}buildUniformLayout(){let e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),e.addUniform("cameraInfo",4),Zh(e,!1,!0),super.buildUniformLayout()}bindForSubMesh(e,t,i){let r=this.getScene(),s=i.materialDefines;if(!s)return;let o=i.effect;if(!o)return;this._activeEffect=o,t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(o,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,t,e,this.isFrozen),Ba.Bind(r.getEngine().currentRenderPassId,this._activeEffect,t,e,this);let a=r.activeCamera;a?this._uniformBuffer.updateFloat4("cameraInfo",a.minZ,a.maxZ,0,0):this._uniformBuffer.updateFloat4("cameraInfo",0,0,0,0),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),s.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));let l=this._mustRebind(r,o,i,t.visibility);Da(t,o);let c=this._uniformBuffer;if(l){if(this.bindViewProjection(o),!c.useUbo||!this.isFrozen||!c.isSync||i._drawWrapper._forceRebindOnNextCall){if(n.FresnelEnabled&&s.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(c.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),c.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&c.updateColor4("opacityParts",new U(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(c.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),c.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(c.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),c.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(c.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),c.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),r.texturesEnabled&&(this._diffuseTexture&&n.DiffuseTextureEnabled&&(c.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),xr(this._diffuseTexture,c,"diffuse")),this._ambientTexture&&n.AmbientTextureEnabled&&(c.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),xr(this._ambientTexture,c,"ambient")),this._opacityTexture&&n.OpacityTextureEnabled&&(c.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),xr(this._opacityTexture,c,"opacity")),this._hasAlphaChannel()&&c.updateFloat("alphaCutOff",this.alphaCutOff),Uh(r,s,c,U.White(),this._reflectionTexture,!1,!1,!0,!1,!1,!1,this.roughness),(!this._reflectionTexture||!n.ReflectionTextureEnabled)&&c.updateFloat2("vReflectionInfos",0,this.roughness),this._emissiveTexture&&n.EmissiveTextureEnabled&&(c.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),xr(this._emissiveTexture,c,"emissive")),this._lightmapTexture&&n.LightmapTextureEnabled&&(c.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),xr(this._lightmapTexture,c,"lightmap")),this._specularTexture&&n.SpecularTextureEnabled&&(c.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),xr(this._specularTexture,c,"specular")),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&n.BumpTextureEnabled&&(c.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),xr(this._bumpTexture,c,"bump"),r._mirroredCameraPosition?c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&n.RefractionTextureEnabled)){let u=1;if(this._refractionTexture.isCube||(c.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(u=this._refractionTexture.depth)),c.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,u,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){let h=this._refractionTexture;c.updateVector3("vRefractionPosition",h.boundingBoxPosition),c.updateVector3("vRefractionSize",h.boundingBoxSize)}}this.pointsCloud&&c.updateFloat("pointSize",this.pointSize),c.updateColor4("vSpecularColor",this.specularColor,this.specularPower),c.updateColor3("vEmissiveColor",n.EmissiveTextureEnabled?this.emissiveColor:U.BlackReadOnly),c.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),r.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),c.updateColor3("vAmbientColor",this._globalAmbientColor)}r.texturesEnabled&&(this._diffuseTexture&&n.DiffuseTextureEnabled&&o.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&n.AmbientTextureEnabled&&o.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&n.OpacityTextureEnabled&&o.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&n.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?o.setTexture("reflectionCubeSampler",this._reflectionTexture):o.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&n.EmissiveTextureEnabled&&o.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&n.LightmapTextureEnabled&&o.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&n.SpecularTextureEnabled&&o.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&n.BumpTextureEnabled&&o.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&n.RefractionTextureEnabled&&(this._refractionTexture.isCube?o.setTexture("refractionCubeSampler",this._refractionTexture):o.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(o),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),Ki(o,this,r),this.bindEyePosition(o)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(l||!this.isFrozen)&&(r.lightsEnabled&&!this._disableLighting&&zh(r,t,o,s,this._maxSimultaneousLights),(r.fogEnabled&&t.applyFog&&r.fogMode!==Ce.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||s.PREPASS||s.CLUSTLIGHT_BATCH)&&this.bindView(o),Nn(r,t,o),s.NUM_MORPH_INFLUENCERS&&Ma(t,o),s.BAKED_VERTEX_ANIMATION_TEXTURE&&t.bakedVertexAnimationManager?.bind(o,s.INSTANCES),this.useLogarithmicDepth&&Si(s,o,r),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect,i),c.update()}getAnimatables(){let e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){let e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._diffuseTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._specularTexture===e||this._bumpTexture===e||this._lightmapTexture===e||this._refractionTexture===e)}dispose(e,t){t&&(this._diffuseTexture?.dispose(),this._ambientTexture?.dispose(),this._opacityTexture?.dispose(),this._reflectionTexture?.dispose(),this._emissiveTexture?.dispose(),this._specularTexture?.dispose(),this._bumpTexture?.dispose(),this._lightmapTexture?.dispose(),this._refractionTexture?.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}clone(e,t=!0,i=""){let r=je.Clone(()=>new n(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return r.name=e,r.id=e,this.stencil.copyTo(r.stencil),this._clonePlugins(r,i),r}static Parse(e,t,i){let r=je.Parse(()=>new n(e.name,t),e,t,i);return e.stencil&&r.stencil.parse(e.stencil,t,i),Re._ParsePlugins(e,r,t,i),r}static get DiffuseTextureEnabled(){return at.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){at.DiffuseTextureEnabled=e}static get DetailTextureEnabled(){return at.DetailTextureEnabled}static set DetailTextureEnabled(e){at.DetailTextureEnabled=e}static get AmbientTextureEnabled(){return at.AmbientTextureEnabled}static set AmbientTextureEnabled(e){at.AmbientTextureEnabled=e}static get OpacityTextureEnabled(){return at.OpacityTextureEnabled}static set OpacityTextureEnabled(e){at.OpacityTextureEnabled=e}static get ReflectionTextureEnabled(){return at.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){at.ReflectionTextureEnabled=e}static get EmissiveTextureEnabled(){return at.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){at.EmissiveTextureEnabled=e}static get SpecularTextureEnabled(){return at.SpecularTextureEnabled}static set SpecularTextureEnabled(e){at.SpecularTextureEnabled=e}static get BumpTextureEnabled(){return at.BumpTextureEnabled}static set BumpTextureEnabled(e){at.BumpTextureEnabled=e}static get LightmapTextureEnabled(){return at.LightmapTextureEnabled}static set LightmapTextureEnabled(e){at.LightmapTextureEnabled=e}static get RefractionTextureEnabled(){return at.RefractionTextureEnabled}static set RefractionTextureEnabled(e){at.RefractionTextureEnabled=e}static get ColorGradingTextureEnabled(){return at.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){at.ColorGradingTextureEnabled=e}static get FresnelEnabled(){return at.FresnelEnabled}static set FresnelEnabled(e){at.FresnelEnabled=e}};te.ForceGLSL=!1;w([Bi("diffuseTexture")],te.prototype,"_diffuseTexture",void 0);w([Pe("_markAllSubMeshesAsTexturesAndMiscDirty")],te.prototype,"diffuseTexture",void 0);w([Bi("ambientTexture")],te.prototype,"_ambientTexture",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],te.prototype,"ambientTexture",void 0);w([Bi("opacityTexture")],te.prototype,"_opacityTexture",void 0);w([Pe("_markAllSubMeshesAsTexturesAndMiscDirty")],te.prototype,"opacityTexture",void 0);w([Bi("reflectionTexture")],te.prototype,"_reflectionTexture",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],te.prototype,"reflectionTexture",void 0);w([Bi("emissiveTexture")],te.prototype,"_emissiveTexture",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],te.prototype,"emissiveTexture",void 0);w([Bi("specularTexture")],te.prototype,"_specularTexture",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],te.prototype,"specularTexture",void 0);w([Bi("bumpTexture")],te.prototype,"_bumpTexture",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],te.prototype,"bumpTexture",void 0);w([Bi("lightmapTexture")],te.prototype,"_lightmapTexture",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],te.prototype,"lightmapTexture",void 0);w([Bi("refractionTexture")],te.prototype,"_refractionTexture",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],te.prototype,"refractionTexture",void 0);w([mn("ambient")],te.prototype,"ambientColor",void 0);w([mn("diffuse")],te.prototype,"diffuseColor",void 0);w([mn("specular")],te.prototype,"specularColor",void 0);w([mn("emissive")],te.prototype,"emissiveColor",void 0);w([B()],te.prototype,"specularPower",void 0);w([B("useAlphaFromDiffuseTexture")],te.prototype,"_useAlphaFromDiffuseTexture",void 0);w([Pe("_markAllSubMeshesAsTexturesAndMiscDirty")],te.prototype,"useAlphaFromDiffuseTexture",void 0);w([B("useEmissiveAsIllumination")],te.prototype,"_useEmissiveAsIllumination",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],te.prototype,"useEmissiveAsIllumination",void 0);w([B("linkEmissiveWithDiffuse")],te.prototype,"_linkEmissiveWithDiffuse",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],te.prototype,"linkEmissiveWithDiffuse",void 0);w([B("useSpecularOverAlpha")],te.prototype,"_useSpecularOverAlpha",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],te.prototype,"useSpecularOverAlpha",void 0);w([B("useReflectionOverAlpha")],te.prototype,"_useReflectionOverAlpha",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],te.prototype,"useReflectionOverAlpha",void 0);w([B("disableLighting")],te.prototype,"_disableLighting",void 0);w([Pe("_markAllSubMeshesAsLightsDirty")],te.prototype,"disableLighting",void 0);w([B("useObjectSpaceNormalMap")],te.prototype,"_useObjectSpaceNormalMap",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],te.prototype,"useObjectSpaceNormalMap",void 0);w([B("useParallax")],te.prototype,"_useParallax",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],te.prototype,"useParallax",void 0);w([B("useParallaxOcclusion")],te.prototype,"_useParallaxOcclusion",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],te.prototype,"useParallaxOcclusion",void 0);w([B()],te.prototype,"parallaxScaleBias",void 0);w([B("roughness")],te.prototype,"_roughness",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],te.prototype,"roughness",void 0);w([B()],te.prototype,"indexOfRefraction",void 0);w([B()],te.prototype,"invertRefractionY",void 0);w([B()],te.prototype,"alphaCutOff",void 0);w([B("useLightmapAsShadowmap")],te.prototype,"_useLightmapAsShadowmap",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],te.prototype,"useLightmapAsShadowmap",void 0);w([Ia("diffuseFresnelParameters")],te.prototype,"_diffuseFresnelParameters",void 0);w([Pe("_markAllSubMeshesAsFresnelDirty")],te.prototype,"diffuseFresnelParameters",void 0);w([Ia("opacityFresnelParameters")],te.prototype,"_opacityFresnelParameters",void 0);w([Pe("_markAllSubMeshesAsFresnelAndMiscDirty")],te.prototype,"opacityFresnelParameters",void 0);w([Ia("reflectionFresnelParameters")],te.prototype,"_reflectionFresnelParameters",void 0);w([Pe("_markAllSubMeshesAsFresnelDirty")],te.prototype,"reflectionFresnelParameters",void 0);w([Ia("refractionFresnelParameters")],te.prototype,"_refractionFresnelParameters",void 0);w([Pe("_markAllSubMeshesAsFresnelDirty")],te.prototype,"refractionFresnelParameters",void 0);w([Ia("emissiveFresnelParameters")],te.prototype,"_emissiveFresnelParameters",void 0);w([Pe("_markAllSubMeshesAsFresnelDirty")],te.prototype,"emissiveFresnelParameters",void 0);w([B("useReflectionFresnelFromSpecular")],te.prototype,"_useReflectionFresnelFromSpecular",void 0);w([Pe("_markAllSubMeshesAsFresnelDirty")],te.prototype,"useReflectionFresnelFromSpecular",void 0);w([B("useGlossinessFromSpecularMapAlpha")],te.prototype,"_useGlossinessFromSpecularMapAlpha",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],te.prototype,"useGlossinessFromSpecularMapAlpha",void 0);w([B("maxSimultaneousLights")],te.prototype,"_maxSimultaneousLights",void 0);w([Pe("_markAllSubMeshesAsLightsDirty")],te.prototype,"maxSimultaneousLights",void 0);w([B("invertNormalMapX")],te.prototype,"_invertNormalMapX",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],te.prototype,"invertNormalMapX",void 0);w([B("invertNormalMapY")],te.prototype,"_invertNormalMapY",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],te.prototype,"invertNormalMapY",void 0);w([B("twoSidedLighting")],te.prototype,"_twoSidedLighting",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],te.prototype,"twoSidedLighting",void 0);w([B("applyDecalMapAfterDetailMap")],te.prototype,"_applyDecalMapAfterDetailMap",void 0);w([Pe("_markAllSubMeshesAsMiscDirty")],te.prototype,"applyDecalMapAfterDetailMap",void 0);le("BABYLON.StandardMaterial",te);Ce.DefaultMaterialFactory=n=>new te("default material",n);var qb={effect:null,subMesh:null},un=class n extends Tr{constructor(e,t,i,r={},s=!0){super(e,t,s),this._textures={},this._internalTextures={},this._textureArrays={},this._externalTextures={},this._floats={},this._ints={},this._uints={},this._floatsArrays={},this._colors3={},this._colors3Arrays={},this._colors4={},this._colors4Arrays={},this._vectors2={},this._vectors3={},this._vectors4={},this._quaternions={},this._quaternionsArrays={},this._matrices={},this._matrixArrays={},this._matrices3x3={},this._matrices2x2={},this._vectors2Arrays={},this._vectors3Arrays={},this._vectors4Arrays={},this._uniformBuffers={},this._textureSamplers={},this._storageBuffers={},this._cachedWorldViewMatrix=new L,this._cachedWorldViewProjectionMatrix=new L,this._multiview=!1,this._materialHelperNeedsPreviousMatrices=!1,this._shaderPath=i,this._options=Y({needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1},r)}get shaderPath(){return this._shaderPath}set shaderPath(e){this._shaderPath=e}get options(){return this._options}get isMultiview(){return this._multiview}getClassName(){return"ShaderMaterial"}needAlphaBlending(){return this.alpha<1||this._options.needAlphaBlending}needAlphaTesting(){return this._options.needAlphaTesting}_checkUniform(e){this._options.uniforms.indexOf(e)===-1&&this._options.uniforms.push(e)}setTexture(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._textures[e]=t,this}setInternalTexture(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._internalTextures[e]=t,this}removeTexture(e){delete this._textures[e]}setTextureArray(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=t,this}setExternalTexture(e,t){return this._options.externalTextures.indexOf(e)===-1&&this._options.externalTextures.push(e),this._externalTextures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setUInt(e,t){return this._checkUniform(e),this._uints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor3Array(e,t){return this._checkUniform(e),this._colors3Arrays[e]=t.reduce((i,r)=>(i.push(r.r,r.g,r.b),i),[]),this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setColor4Array(e,t){return this._checkUniform(e),this._colors4Arrays[e]=t.reduce((i,r)=>(i.push(r.r,r.g,r.b,r.a),i),[]),this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setQuaternion(e,t){return this._checkUniform(e),this._quaternions[e]=t,this}setQuaternionArray(e,t){return this._checkUniform(e),this._quaternionsArrays[e]=t.reduce((i,r)=>(r.toArray(i,i.length),i),[]),this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}setMatrices(e,t){this._checkUniform(e);let i=new Float32Array(t.length*16);for(let r=0;r<t.length;r++)t[r].copyToArray(i,r*16);return this._matrixArrays[e]=i,this}setMatrix3x3(e,t){return this._checkUniform(e),this._matrices3x3[e]=t,this}setMatrix2x2(e,t){return this._checkUniform(e),this._matrices2x2[e]=t,this}setArray2(e,t){return this._checkUniform(e),this._vectors2Arrays[e]=t,this}setArray3(e,t){return this._checkUniform(e),this._vectors3Arrays[e]=t,this}setArray4(e,t){return this._checkUniform(e),this._vectors4Arrays[e]=t,this}setUniformBuffer(e,t){return this._options.uniformBuffers.indexOf(e)===-1&&this._options.uniformBuffers.push(e),this._uniformBuffers[e]=t,this}setTextureSampler(e,t){return this._options.samplerObjects.indexOf(e)===-1&&this._options.samplerObjects.push(e),this._textureSamplers[e]=t,this}setStorageBuffer(e,t){return this._options.storageBuffers.indexOf(e)===-1&&this._options.storageBuffers.push(e),this._storageBuffers[e]=t,this}setDefine(e,t){let i=e.trimEnd()+" ",r=this.options.defines.findIndex(s=>s===e||s.startsWith(i));return r>=0&&this.options.defines.splice(r,1),(typeof t!="boolean"||t)&&this.options.defines.push(i+t),this}isReadyForSubMesh(e,t,i){return this.isReady(e,i,t)}isReady(e,t,i){let r=i&&this._storeEffectOnSubMeshes;if(this.isFrozen){let x=r?i._drawWrapper:this._drawWrapper;if(x.effect&&x._wasPreviouslyReady&&x._wasPreviouslyUsingInstances===t)return!0}let s=this.getScene(),o=s.getEngine(),a=[],l=[],c=null,u=this._shaderPath,h=this._options.uniforms,d=this._options.uniformBuffers,f=this._options.samplers;o.getCaps().multiview&&s.activeCamera&&s.activeCamera.outputRenderTarget&&s.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,a.push("#define MULTIVIEW"),h.indexOf("viewProjection")!==-1&&h.indexOf("viewProjectionR")===-1&&h.push("viewProjectionR"));for(let x=0;x<this._options.defines.length;x++){let C=this._options.defines[x].indexOf("#define")===0?this._options.defines[x]:`#define ${this._options.defines[x]}`;a.push(C)}for(let x=0;x<this._options.attributes.length;x++)l.push(this._options.attributes[x]);if(e&&e.isVerticesDataPresent(T.ColorKind)&&(l.indexOf(T.ColorKind)===-1&&l.push(T.ColorKind),a.push("#define VERTEXCOLOR")),t&&(a.push("#define INSTANCES"),Gh(l,this._materialHelperNeedsPreviousMatrices),e?.hasThinInstances&&(a.push("#define THIN_INSTANCES"),e&&e.isVerticesDataPresent(T.ColorInstanceKind)&&(l.push(T.ColorInstanceKind),a.push("#define INSTANCESCOLOR")))),e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){l.push(T.MatricesIndicesKind),l.push(T.MatricesWeightsKind),e.numBoneInfluencers>4&&(l.push(T.MatricesIndicesExtraKind),l.push(T.MatricesWeightsExtraKind));let x=e.skeleton;a.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),c=new vr,c.addCPUSkinningFallback(0,e),x.isUsingTextureForMatrices?(a.push("#define BONETEXTURE"),h.indexOf("boneTextureWidth")===-1&&h.push("boneTextureWidth"),this._options.samplers.indexOf("boneSampler")===-1&&this._options.samplers.push("boneSampler")):(a.push("#define BonesPerMesh "+(x.bones.length+1)),h.indexOf("mBones")===-1&&h.push("mBones"))}else a.push("#define NUM_BONE_INFLUENCERS 0");let p=0,g=e?e.morphTargetManager:null;if(g){let x=a.indexOf("#define UV1")!==-1,C=a.indexOf("#define UV2")!==-1,R=a.indexOf("#define TANGENT")!==-1,M=a.indexOf("#define NORMAL")!==-1,D=a.indexOf("#define VERTEXCOLOR")!==-1;p=Vh(g,a,l,e,!0,M,R,x,C,D),g.isUsingTextureForTargets&&(h.indexOf("morphTargetTextureIndices")===-1&&h.push("morphTargetTextureIndices"),this._options.samplers.indexOf("morphTargets")===-1&&this._options.samplers.push("morphTargets")),p>0&&(h=h.slice(),h.push("morphTargetInfluences"),h.push("morphTargetCount"),h.push("morphTargetTextureInfo"),h.push("morphTargetTextureIndices"))}else a.push("#define NUM_MORPH_INFLUENCERS 0");if(e){let x=e.bakedVertexAnimationManager;x&&x.isEnabled&&(a.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),h.indexOf("bakedVertexAnimationSettings")===-1&&h.push("bakedVertexAnimationSettings"),h.indexOf("bakedVertexAnimationTextureSizeInverted")===-1&&h.push("bakedVertexAnimationTextureSizeInverted"),h.indexOf("bakedVertexAnimationTime")===-1&&h.push("bakedVertexAnimationTime"),this._options.samplers.indexOf("bakedVertexAnimationTexture")===-1&&this._options.samplers.push("bakedVertexAnimationTexture"),t&&l.push("bakedVertexAnimationSettingsInstanced"))}for(let x in this._textures)if(!this._textures[x].isReady())return!1;for(let x in this._internalTextures)if(!this._internalTextures[x].isReady)return!1;e&&this.needAlphaTestingForMesh(e)&&a.push("#define ALPHATEST"),this._options.useClipPlane!==!1&&(Yi(h),Es(this,s,a)),s.fogEnabled&&e?.applyFog&&s.fogMode!==Ce.FOGMODE_NONE&&(a.push("#define FOG"),h.indexOf("view")===-1&&h.push("view"),h.indexOf("vFogInfos")===-1&&h.push("vFogInfos"),h.indexOf("vFogColor")===-1&&h.push("vFogColor")),this._useLogarithmicDepth&&(a.push("#define LOGARITHMICDEPTH"),h.indexOf("logarithmicDepthConstant")===-1&&h.push("logarithmicDepthConstant")),this.customShaderNameResolve&&(h=h.slice(),d=d.slice(),f=f.slice(),u=this.customShaderNameResolve(this.name,h,d,f,a,l));let _=i?i.getRenderingMesh():e;if(_&&this.useVertexPulling){a.push("#define USE_VERTEX_PULLING");let x=_.geometry?.getIndexBuffer();x&&(a.push("#define VERTEX_PULLING_USE_INDEX_BUFFER"),x.is32Bits&&a.push("#define VERTEX_PULLING_INDEX_BUFFER_32BITS"))}let y=r?i._getDrawWrapper(void 0,!0):this._drawWrapper,b=y?.effect??null,A=y?.defines??null,I=a.join(`
`),v=b;return A!==I&&(v=o.createEffect(u,{attributes:l,uniformsNames:h,uniformBuffersNames:d,samplers:f,defines:I,fallbacks:c,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:p},shaderLanguage:this._options.shaderLanguage,extraInitializationsAsync:this._options.extraInitializationsAsync},o),r?i.setEffect(v,I,this._materialContext):y&&y.setEffect(v,I),this._onEffectCreatedObservable&&(qb.effect=v,qb.subMesh=i??e?.subMeshes[0]??null,this._onEffectCreatedObservable.notifyObservers(qb))),y._wasPreviouslyUsingInstances=!!t,v?.isReady()?(b!==v&&s.resetCachedMaterial(),y._wasPreviouslyReady=!0,!0):!1}bindOnlyWorldMatrix(e,t){let i=t??this.getEffect();if(!i)return;let r=this._options.uniforms;r.indexOf("world")!==-1&&i.setMatrix("world",e);let s=this.getScene();r.indexOf("worldView")!==-1&&(e.multiplyToRef(s.getViewMatrix(),this._cachedWorldViewMatrix),i.setMatrix("worldView",this._cachedWorldViewMatrix)),r.indexOf("worldViewProjection")!==-1&&(e.multiplyToRef(s.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),i.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)),r.indexOf("view")!==-1&&i.setMatrix("view",s.getViewMatrix())}bindForSubMesh(e,t,i){this.bind(e,t,i._drawWrapperOverride?.effect,i)}bind(e,t,i,r){let s=r&&this._storeEffectOnSubMeshes,o=i??(s?r.effect:this.getEffect());if(!o)return;let a=this.getScene();this._activeEffect=o,this.bindOnlyWorldMatrix(e,i);let l=this._options.uniformBuffers,c=!1;if(o&&l&&l.length>0&&a.getEngine().supportsUniformBuffers)for(let h=0;h<l.length;++h)switch(l[h]){case"Mesh":t&&(t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e));break;case"Scene":e0(o,a.getSceneUniformBuffer()),a.finalizeSceneUbo(),c=!0;break}let u=t&&s?this._mustRebind(a,o,r,t.visibility):a.getCachedMaterial()!==this;if(o&&u){!c&&this._options.uniforms.indexOf("view")!==-1&&o.setMatrix("view",a.getViewMatrix()),!c&&this._options.uniforms.indexOf("projection")!==-1&&o.setMatrix("projection",a.getProjectionMatrix()),!c&&this._options.uniforms.indexOf("viewProjection")!==-1&&(o.setMatrix("viewProjection",a.getTransformMatrix()),this._multiview&&o.setMatrix("viewProjectionR",a._transformMatrixR)),a.activeCamera&&this._options.uniforms.indexOf("cameraPosition")!==-1&&o.setVector3("cameraPosition",a.activeCamera.globalPosition),Da(t,o),Ki(o,this,a),this._useLogarithmicDepth&&Si(s?r.materialDefines:o.defines,o,a),t&&Nn(a,t,o);let h;for(h in this._textures)o.setTexture(h,this._textures[h]);for(h in this._internalTextures)o._bindTexture(h,this._internalTextures[h]);for(h in this._textureArrays)o.setTextureArray(h,this._textureArrays[h]);for(h in this._ints)o.setInt(h,this._ints[h]);for(h in this._uints)o.setUInt(h,this._uints[h]);for(h in this._floats)o.setFloat(h,this._floats[h]);for(h in this._floatsArrays)o.setArray(h,this._floatsArrays[h]);for(h in this._colors3)o.setColor3(h,this._colors3[h]);for(h in this._colors3Arrays)o.setArray3(h,this._colors3Arrays[h]);for(h in this._colors4){let _=this._colors4[h];o.setFloat4(h,_.r,_.g,_.b,_.a)}for(h in this._colors4Arrays)o.setArray4(h,this._colors4Arrays[h]);for(h in this._vectors2)o.setVector2(h,this._vectors2[h]);for(h in this._vectors3)o.setVector3(h,this._vectors3[h]);for(h in this._vectors4)o.setVector4(h,this._vectors4[h]);for(h in this._quaternions)o.setQuaternion(h,this._quaternions[h]);for(h in this._matrices)o.setMatrix(h,this._matrices[h]);for(h in this._matrixArrays)o.setMatrices(h,this._matrixArrays[h]);for(h in this._matrices3x3)o.setMatrix3x3(h,this._matrices3x3[h]);for(h in this._matrices2x2)o.setMatrix2x2(h,this._matrices2x2[h]);for(h in this._vectors2Arrays)o.setArray2(h,this._vectors2Arrays[h]);for(h in this._vectors3Arrays)o.setArray3(h,this._vectors3Arrays[h]);for(h in this._vectors4Arrays)o.setArray4(h,this._vectors4Arrays[h]);for(h in this._quaternionsArrays)o.setArray4(h,this._quaternionsArrays[h]);for(h in this._uniformBuffers){let _=this._uniformBuffers[h].getBuffer();_&&o.bindUniformBuffer(_,h)}let d=a.getEngine(),f=d.setExternalTexture;if(f)for(h in this._externalTextures)f.call(d,h,this._externalTextures[h]);let p=d.setTextureSampler;if(p)for(h in this._textureSamplers)p.call(d,h,this._textureSamplers[h]);let g=d.setStorageBuffer;if(g)for(h in this._storageBuffers)g.call(d,h,this._storageBuffers[h])}if(o&&t&&(u||!this.isFrozen)){Ma(t,o),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(o);let h=t.bakedVertexAnimationManager;if(h&&h.isEnabled){let d=s?r._drawWrapper:this._drawWrapper;t.bakedVertexAnimationManager?.bind(o,!!d._wasPreviouslyUsingInstances)}}this._afterBind(t,o,r)}getActiveTextures(){let e=super.getActiveTextures();for(let t in this._textures)e.push(this._textures[t]);for(let t in this._textureArrays){let i=this._textureArrays[t];for(let r=0;r<i.length;r++)e.push(i[r])}return e}hasTexture(e){if(super.hasTexture(e))return!0;for(let i in this._textures)if(this._textures[i]===e)return!0;let t=e.getInternalTexture();for(let i in this._internalTextures)if(this._internalTextures[i]===t)return!0;for(let i in this._textureArrays){let r=this._textureArrays[i];for(let s=0;s<r.length;s++)if(r[s]===e)return!0}return!1}clone(e){let t=je.Clone(()=>new n(e,this.getScene(),this._shaderPath,this._options,this._storeEffectOnSubMeshes),this);t.name=e,t.id=e,typeof t._shaderPath=="object"&&(t._shaderPath=Y({},t._shaderPath)),this._options=Y({},this._options);let i=Object.keys(this._options);for(let r of i){let s=this._options[r];Array.isArray(s)&&(this._options[r]=s.slice(0))}this.stencil.copyTo(t.stencil);for(let r in this._textures)t.setTexture(r,this._textures[r]);for(let r in this._internalTextures)t.setInternalTexture(r,this._internalTextures[r]);for(let r in this._textureArrays)t.setTextureArray(r,this._textureArrays[r]);for(let r in this._externalTextures)t.setExternalTexture(r,this._externalTextures[r]);for(let r in this._ints)t.setInt(r,this._ints[r]);for(let r in this._uints)t.setUInt(r,this._uints[r]);for(let r in this._floats)t.setFloat(r,this._floats[r]);for(let r in this._floatsArrays)t.setFloats(r,this._floatsArrays[r]);for(let r in this._colors3)t.setColor3(r,this._colors3[r]);for(let r in this._colors3Arrays)t._colors3Arrays[r]=this._colors3Arrays[r];for(let r in this._colors4)t.setColor4(r,this._colors4[r]);for(let r in this._colors4Arrays)t._colors4Arrays[r]=this._colors4Arrays[r];for(let r in this._vectors2)t.setVector2(r,this._vectors2[r]);for(let r in this._vectors3)t.setVector3(r,this._vectors3[r]);for(let r in this._vectors4)t.setVector4(r,this._vectors4[r]);for(let r in this._quaternions)t.setQuaternion(r,this._quaternions[r]);for(let r in this._quaternionsArrays)t._quaternionsArrays[r]=this._quaternionsArrays[r];for(let r in this._matrices)t.setMatrix(r,this._matrices[r]);for(let r in this._matrixArrays)t._matrixArrays[r]=this._matrixArrays[r].slice();for(let r in this._matrices3x3)t.setMatrix3x3(r,this._matrices3x3[r]);for(let r in this._matrices2x2)t.setMatrix2x2(r,this._matrices2x2[r]);for(let r in this._vectors2Arrays)t.setArray2(r,this._vectors2Arrays[r]);for(let r in this._vectors3Arrays)t.setArray3(r,this._vectors3Arrays[r]);for(let r in this._vectors4Arrays)t.setArray4(r,this._vectors4Arrays[r]);for(let r in this._uniformBuffers)t.setUniformBuffer(r,this._uniformBuffers[r]);for(let r in this._textureSamplers)t.setTextureSampler(r,this._textureSamplers[r]);for(let r in this._storageBuffers)t.setStorageBuffer(r,this._storageBuffers[r]);return t}dispose(e,t,i){if(t){let r;for(r in this._textures)this._textures[r].dispose();for(r in this._internalTextures)this._internalTextures[r].dispose();for(r in this._textureArrays){let s=this._textureArrays[r];for(let o=0;o<s.length;o++)s[o].dispose()}}this._textures={},this._internalTextures={},super.dispose(e,t,i)}serialize(){let e=je.Serialize(this);e.customType="BABYLON.ShaderMaterial",e.uniqueId=this.uniqueId,e.options=this._options,e.shaderPath=this._shaderPath,e.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes;let t;e.stencil=this.stencil.serialize(),e.textures={};for(t in this._textures)e.textures[t]=this._textures[t].serialize();e.textureArrays={};for(t in this._textureArrays){e.textureArrays[t]=[];let i=this._textureArrays[t];for(let r=0;r<i.length;r++)e.textureArrays[t].push(i[r].serialize())}e.ints={};for(t in this._ints)e.ints[t]=this._ints[t];e.uints={};for(t in this._uints)e.uints[t]=this._uints[t];e.floats={};for(t in this._floats)e.floats[t]=this._floats[t];e.floatsArrays={};for(t in this._floatsArrays)e.floatsArrays[t]=this._floatsArrays[t];e.colors3={};for(t in this._colors3){let i=this._colors3[t];e.colors3[t]=[i.r,i.g,i.b]}e.colors3Arrays={};for(t in this._colors3Arrays)e.colors3Arrays[t]=this._colors3Arrays[t];e.colors4={};for(t in this._colors4){let i=this._colors4[t];e.colors4[t]=[i.r,i.g,i.b,i.a]}e.colors4Arrays={};for(t in this._colors4Arrays)e.colors4Arrays[t]=this._colors4Arrays[t];e.vectors2={};for(t in this._vectors2){let i=this._vectors2[t];e.vectors2[t]=[i.x,i.y]}e.vectors3={};for(t in this._vectors3){let i=this._vectors3[t];e.vectors3[t]=[i.x,i.y,i.z]}e.vectors4={};for(t in this._vectors4){let i=this._vectors4[t];e.vectors4[t]=[i.x,i.y,i.z,i.w]}e.quaternions={};for(t in this._quaternions)e.quaternions[t]=this._quaternions[t].asArray();e.matrices={};for(t in this._matrices)e.matrices[t]=this._matrices[t].asArray();e.matrixArray={};for(t in this._matrixArrays)e.matrixArray[t]=this._matrixArrays[t];e.matrices3x3={};for(t in this._matrices3x3)e.matrices3x3[t]=this._matrices3x3[t];e.matrices2x2={};for(t in this._matrices2x2)e.matrices2x2[t]=this._matrices2x2[t];e.vectors2Arrays={};for(t in this._vectors2Arrays)e.vectors2Arrays[t]=this._vectors2Arrays[t];e.vectors3Arrays={};for(t in this._vectors3Arrays)e.vectors3Arrays[t]=this._vectors3Arrays[t];e.vectors4Arrays={};for(t in this._vectors4Arrays)e.vectors4Arrays[t]=this._vectors4Arrays[t];e.quaternionsArrays={};for(t in this._quaternionsArrays)e.quaternionsArrays[t]=this._quaternionsArrays[t];return e}static Parse(e,t,i){let r=je.Parse(()=>new n(e.name,t,e.shaderPath,e.options,e.storeEffectOnSubMeshes),e,t,i),s;e.stencil&&r.stencil.parse(e.stencil,t,i);for(s in e.textures)r.setTexture(s,Z.Parse(e.textures[s],t,i));for(s in e.textureArrays){let o=e.textureArrays[s],a=[];for(let l=0;l<o.length;l++)a.push(Z.Parse(o[l],t,i));r.setTextureArray(s,a)}for(s in e.ints)r.setInt(s,e.ints[s]);for(s in e.uints)r.setUInt(s,e.uints[s]);for(s in e.floats)r.setFloat(s,e.floats[s]);for(s in e.floatsArrays)r.setFloats(s,e.floatsArrays[s]);for(s in e.colors3){let o=e.colors3[s];r.setColor3(s,{r:o[0],g:o[1],b:o[2]})}for(s in e.colors3Arrays){let o=e.colors3Arrays[s].reduce((a,l,c)=>(c%3===0?a.push([l]):a[a.length-1].push(l),a),[]).map(a=>({r:a[0],g:a[1],b:a[2]}));r.setColor3Array(s,o)}for(s in e.colors4){let o=e.colors4[s];r.setColor4(s,{r:o[0],g:o[1],b:o[2],a:o[3]})}for(s in e.colors4Arrays){let o=e.colors4Arrays[s].reduce((a,l,c)=>(c%4===0?a.push([l]):a[a.length-1].push(l),a),[]).map(a=>({r:a[0],g:a[1],b:a[2],a:a[3]}));r.setColor4Array(s,o)}for(s in e.vectors2){let o=e.vectors2[s];r.setVector2(s,{x:o[0],y:o[1]})}for(s in e.vectors3){let o=e.vectors3[s];r.setVector3(s,{x:o[0],y:o[1],z:o[2]})}for(s in e.vectors4){let o=e.vectors4[s];r.setVector4(s,{x:o[0],y:o[1],z:o[2],w:o[3]})}for(s in e.quaternions)r.setQuaternion(s,Q.FromArray(e.quaternions[s]));for(s in e.matrices)r.setMatrix(s,L.FromArray(e.matrices[s]));for(s in e.matrixArray)r._matrixArrays[s]=new Float32Array(e.matrixArray[s]);for(s in e.matrices3x3)r.setMatrix3x3(s,e.matrices3x3[s]);for(s in e.matrices2x2)r.setMatrix2x2(s,e.matrices2x2[s]);for(s in e.vectors2Arrays)r.setArray2(s,e.vectors2Arrays[s]);for(s in e.vectors3Arrays)r.setArray3(s,e.vectors3Arrays[s]);for(s in e.vectors4Arrays)r.setArray4(s,e.vectors4Arrays[s]);for(s in e.quaternionsArrays)r.setArray4(s,e.quaternionsArrays[s]);return r}static ParseFromFileAsync(e,t,i,r=""){return S(this,null,function*(){return yield new Promise((s,o)=>{let a=new gr;a.addEventListener("readystatechange",()=>{if(a.readyState==4)if(a.status==200){let l=JSON.parse(a.responseText),c=this.Parse(l,i||ye.LastCreatedScene,r);e&&(c.name=e),s(c)}else o("Unable to load the ShaderMaterial")}),a.open("GET",t),a.send()})})}static ParseFromSnippetAsync(e,t,i=""){return S(this,null,function*(){return yield new Promise((r,s)=>{let o=new gr;o.addEventListener("readystatechange",()=>{if(o.readyState==4)if(o.status==200){let a=JSON.parse(JSON.parse(o.responseText).jsonPayload),l=JSON.parse(a.shaderMaterial),c=this.Parse(l,t||ye.LastCreatedScene,i);c.snippetId=e,r(c)}else s("Unable to load the snippet "+e)}),o.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),o.send()})})}};un.SnippetUrl="https://snippet.babylonjs.com";un.CreateFromSnippetAsync=un.ParseFromSnippetAsync;le("BABYLON.ShaderMaterial",un);Ut.AddNodeConstructor("Light_Type_3",(n,e)=>()=>new Di(n,m.Zero(),e));var Di=class extends Yt{constructor(e,t,i){super(e,i),this.groundColor=new U(0,0,0),this.direction=t||m.Up()}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(e){return this.direction=m.Normalize(e.subtract(m.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(e,t){let i=m.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",i.x,i.y,i.z,0,t),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),t),this}transferToNodeMaterialEffect(e,t){let i=m.Normalize(this.direction);return e.setFloat3(t,i.x,i.y,i.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=L.Identity()),this._worldMatrix}getTypeID(){return Yt.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(e,t){e["HEMILIGHT"+t]=!0}};w([mn()],Di.prototype,"groundColor",void 0);w([Jt()],Di.prototype,"direction",void 0);le("BABYLON.HemisphericLight",Di);Ut.AddNodeConstructor("Light_Type_0",(n,e)=>()=>new In(n,m.Zero(),e));var In=class extends s0{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){let t=this.needCube();if(this._direction=e,this.needCube()!==t&&this._shadowGenerators){let i=this._shadowGenerators.values();for(let r=i.next();r.done!==!0;r=i.next())r.value.recreateShadowMap()}}constructor(e,t,i){super(e,i),this._shadowAngle=Math.PI/2,this.position=t}getClassName(){return"PointLight"}getTypeID(){return Yt.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new m(1,0,0);case 1:return new m(-1,0,0);case 2:return new m(0,-1,0);case 3:return new m(0,1,0);case 4:return new m(0,0,1);case 5:return new m(0,0,-1)}return m.Zero()}_setDefaultShadowProjectionMatrix(e,t,i){let r=this.getScene().activeCamera,s=this.getDepthMinZ(r),o=this.getDepthMaxZ(r),a=this.getScene().getEngine().useReverseDepthBuffer;L.PerspectiveFovLHToRef(this.shadowAngle,1,a?o:s,a?s:o,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,a)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){let i=this._scene.floatingOriginOffset;return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x-i.x,this.transformedPosition.y-i.y,this.transformedPosition.z-i.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x-i.x,this.position.y-i.y,this.position.z-i.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){let i=this._scene.floatingOriginOffset;return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x-i.x,this.transformedPosition.y-i.y,this.transformedPosition.z-i.z):e.setFloat3(t,this.position.x-i.x,this.position.y-i.y,this.position.z-i.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=!0}};w([B()],In.prototype,"shadowAngle",null);le("BABYLON.PointLight",In);var Ri=(()=>{class n{static SetMatrix(t,i,r,s,o){let a=null;if(r.semantic==="MODEL"?a=i.getWorldMatrix():r.semantic==="PROJECTION"?a=t.getProjectionMatrix():r.semantic==="VIEW"?a=t.getViewMatrix():r.semantic==="MODELVIEWINVERSETRANSPOSE"?a=L.Transpose(i.getWorldMatrix().multiply(t.getViewMatrix()).invert()):r.semantic==="MODELVIEW"?a=i.getWorldMatrix().multiply(t.getViewMatrix()):r.semantic==="MODELVIEWPROJECTION"?a=i.getWorldMatrix().multiply(t.getTransformMatrix()):r.semantic==="MODELINVERSE"?a=i.getWorldMatrix().invert():r.semantic==="VIEWINVERSE"?a=t.getViewMatrix().invert():r.semantic==="PROJECTIONINVERSE"?a=t.getProjectionMatrix().invert():r.semantic==="MODELVIEWINVERSE"?a=i.getWorldMatrix().multiply(t.getViewMatrix()).invert():r.semantic==="MODELVIEWPROJECTIONINVERSE"?a=i.getWorldMatrix().multiply(t.getTransformMatrix()).invert():r.semantic==="MODELINVERSETRANSPOSE"&&(a=L.Transpose(i.getWorldMatrix().invert())),a)switch(r.type){case wi.FLOAT_MAT2:o.setMatrix2x2(s,L.GetAsMatrix2x2(a));break;case wi.FLOAT_MAT3:o.setMatrix3x3(s,L.GetAsMatrix3x3(a));break;case wi.FLOAT_MAT4:o.setMatrix(s,a);break;default:break}}static SetUniform(t,i,r,s){switch(s){case wi.FLOAT:return t.setFloat(i,r),!0;case wi.FLOAT_VEC2:return t.setVector2(i,me.FromArray(r)),!0;case wi.FLOAT_VEC3:return t.setVector3(i,m.FromArray(r)),!0;case wi.FLOAT_VEC4:return t.setVector4(i,dt.FromArray(r)),!0;default:return!1}}static GetWrapMode(t){switch(t){case Yu.CLAMP_TO_EDGE:return Z.CLAMP_ADDRESSMODE;case Yu.MIRRORED_REPEAT:return Z.MIRROR_ADDRESSMODE;case Yu.REPEAT:return Z.WRAP_ADDRESSMODE;default:return Z.WRAP_ADDRESSMODE}}static GetByteStrideFromType(t){switch(t.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}}static GetTextureFilterMode(t){switch(t){case Wn.LINEAR:case Wn.LINEAR_MIPMAP_NEAREST:case Wn.LINEAR_MIPMAP_LINEAR:return Z.TRILINEAR_SAMPLINGMODE;case Wn.NEAREST:case Wn.NEAREST_MIPMAP_NEAREST:return Z.NEAREST_SAMPLINGMODE;default:return Z.BILINEAR_SAMPLINGMODE}}static GetBufferFromBufferView(t,i,r,s,o){r=i.byteOffset+r;let a=t.loadedBufferViews[i.buffer];if(r+s>a.byteLength)throw new Error("Buffer access is out of range");let l=a.buffer;switch(r+=a.byteOffset,o){case gs.BYTE:return new Int8Array(l,r,s);case gs.UNSIGNED_BYTE:return new Uint8Array(l,r,s);case gs.SHORT:return new Int16Array(l,r,s);case gs.UNSIGNED_SHORT:return new Uint16Array(l,r,s);default:return new Float32Array(l,r,s)}}static GetBufferFromAccessor(t,i){let r=t.bufferViews[i.bufferView],s=i.count*n.GetByteStrideFromType(i);return n.GetBufferFromBufferView(t,r,i.byteOffset,s,i.componentType)}static DecodeBufferToText(t){let i="",r=t.byteLength;for(let s=0;s<r;++s)i+=String.fromCharCode(t[s]);return i}static GetDefaultMaterial(t){if(!n._DefaultMaterial){Pt.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join(`
`),Pt.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join(`
`);let i={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},r={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};n._DefaultMaterial=new un("GLTFDefaultMaterial",t,i,r),n._DefaultMaterial.setColor4("u_emission",new ce(.5,.5,.5,1))}return n._DefaultMaterial}}return n._DefaultMaterial=null,n})();var Yo=(function(n){return n[n.IDENTIFIER=1]="IDENTIFIER",n[n.UNKNOWN=2]="UNKNOWN",n[n.END_OF_INPUT=3]="END_OF_INPUT",n})(Yo||{}),kp=class{constructor(e){this._pos=0,this.currentToken=Yo.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}getNextToken(){if(this.isEnd())return Yo.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=Yo.UNKNOWN,this.currentString==="_"||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=Yo.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||this.currentString==="_");)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken}peek(){return this._toParse[this._pos]}read(){return this._toParse[this._pos++]}forward(){this._pos++}isEnd(){return this._pos>=this._maxPos}},Kw=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],Xw=["world","view","projection","worldView","worldViewProjection","mBones"],$B=["translation","rotation","scale"],jB=["position","rotationQuaternion","scaling"],qB=(n,e)=>{for(let t in n){let i=n[t];e.buffers[t]=i,e.buffersCount++}},YB=(n,e)=>{for(let t in n){let i=n[t];e.shaders[t]=i,e.shaderscount++}},Pi=(n,e,t)=>{for(let i in n){let r=n[i];t[e][i]=r}},KB=n=>{if(n)for(let e=0;e<n.length/2;e++)n[e*2+1]=1-n[e*2+1]},Ww=n=>{if(n.semantic==="NORMAL")return"normal";if(n.semantic==="POSITION")return"position";if(n.semantic==="JOINT")return"matricesIndices";if(n.semantic==="WEIGHT")return"matricesWeights";if(n.semantic==="COLOR")return"color";if(n.semantic&&n.semantic.indexOf("TEXCOORD_")!==-1){let e=Number(n.semantic.split("_")[1]);return"uv"+(e===0?"":e+1)}return null},XB=n=>{for(let e in n.animations){let t=n.animations[e];if(!t.channels||!t.samplers)continue;let i=null;for(let r=0;r<t.channels.length;r++){let s=t.channels[r],o=t.samplers[s.sampler];if(!o)continue;let a=null,l=null;t.parameters?(a=t.parameters[o.input],l=t.parameters[o.output]):(a=o.input,l=o.output);let c=Ri.GetBufferFromAccessor(n,n.accessors[a]),u=Ri.GetBufferFromAccessor(n,n.accessors[l]),h=s.target.id,d=n.scene.getNodeById(h);if(d===null&&(d=n.scene.getNodeByName(h)),d===null){z.Warn("Creating animation named "+e+". But cannot find node named "+h+" to attach to");continue}let f=d instanceof Cr,p=s.target.path,g=$B.indexOf(p);g!==-1&&(p=jB[g]);let _=H.ANIMATIONTYPE_MATRIX;f||(p==="rotationQuaternion"?(_=H.ANIMATIONTYPE_QUATERNION,d.rotationQuaternion=new Q):_=H.ANIMATIONTYPE_VECTOR3);let y=null,b=[],A=0,I=!1;f&&i&&i.getKeys().length===c.length&&(y=i,I=!0),I||(n.scene._blockEntityCollection=!!n.assetContainer,y=new H(e,f?"_matrix":p,1,_,H.ANIMATIONLOOPMODE_CYCLE),n.scene._blockEntityCollection=!1);for(let v=0;v<c.length;v++){let x=null;if(p==="rotationQuaternion"?(x=Q.FromArray([u[A],u[A+1],u[A+2],u[A+3]]),A+=4):(x=m.FromArray([u[A],u[A+1],u[A+2]]),A+=3),f){let C=d,R=m.Zero(),M=new Q,D=m.Zero(),W=C.getBaseMatrix();I&&i&&(W=i.getKeys()[v].value),W.decompose(D,M,R),p==="position"?R=x:p==="rotationQuaternion"?M=x:D=x,x=L.Compose(D,M,R)}I?i&&(i.getKeys()[v].value=x):b.push({frame:c[v],value:x})}!I&&y&&(y.setKeys(b),d.animations.push(y)),i=y,n.scene.stopAnimation(d),n.scene.beginAnimation(d,0,c[c.length-1],!0,1)}}},Xb=n=>{let e=null;if(n.translation||n.rotation||n.scale){let t=m.FromArray(n.scale||[1,1,1]),i=Q.FromArray(n.rotation||[0,0,0,1]),r=m.FromArray(n.translation||[0,0,0]);e=L.Compose(t,i,r)}else e=L.FromArray(n.matrix);return e},Zw=(n,e,t,i)=>{for(let s=0;s<i.bones.length;s++)if(i.bones[s].name===t)return i.bones[s];let r=n.nodes;for(let s in r){let o=r[s];if(!o.jointName)continue;let a=o.children;for(let l=0;l<a.length;l++){let c=n.nodes[a[l]];if(c.jointName&&c.jointName===t){let u=Xb(o),h=new Cr(o.name||"",i,Zw(n,e,o.jointName,i),u);return h.id=s,h}}}return null},ZB=(n,e)=>{for(let t=0;t<n.length;t++){let i=n[t];for(let r=0;r<i.node.children.length;r++)if(i.node.children[r]===e)return i.bone}return null},Yb=(n,e)=>{let t=n.nodes,i=t[e];if(i)return{node:i,id:e};for(let r in t)if(i=t[r],i.jointName===e)return{node:i,id:r};return null},QB=(n,e)=>{for(let t=0;t<n.jointNames.length;t++)if(n.jointNames[t]===e)return!0;return!1},JB=(n,e,t,i)=>{for(let r in n.nodes){let s=n.nodes[r],o=r;if(!s.jointName||QB(t,s.jointName))continue;let a=Xb(s),l=new Cr(s.name||"",e,null,a);l.id=o,i.push({bone:l,node:s,id:o})}for(let r=0;r<i.length;r++){let s=i[r],o=s.node.children;for(let a=0;a<o.length;a++){let l=null;for(let c=0;c<i.length;c++)if(i[c].id===o[a]){l=i[c];break}l&&(l.bone._parent=s.bone,s.bone.children.push(l.bone))}}},ek=(n,e,t,i)=>{if(i||(i=new Wr(e.name||"","",n.scene)),!e.babylonSkeleton)return i;let r=[],s=[];JB(n,i,e,r),i.bones=[];for(let a=0;a<e.jointNames.length;a++){let l=Yb(n,e.jointNames[a]);if(!l)continue;let c=l.node;if(!c){z.Warn("Joint named "+e.jointNames[a]+" does not exist");continue}let u=l.id,h=n.scene.getBoneById(u);if(h){i.bones.push(h);continue}let d=!1,f=null;for(let _=0;_<a;_++){let y=Yb(n,e.jointNames[_]);if(!y)continue;let b=y.node;if(!b){z.Warn("Joint named "+e.jointNames[_]+" does not exist when looking for parent");continue}let A=b.children;if(A){d=!1;for(let I=0;I<A.length;I++)if(A[I]===u){f=Zw(n,e,e.jointNames[_],i),d=!0;break}if(d)break}}let p=Xb(c);!f&&r.length>0&&(f=ZB(r,u),f&&s.indexOf(f)===-1&&s.push(f));let g=new Cr(c.jointName||"",i,f,p);g.id=u}let o=i.bones;i.bones=[];for(let a=0;a<e.jointNames.length;a++){let l=Yb(n,e.jointNames[a]);if(l){for(let c=0;c<o.length;c++)if(o[c].id===l.id){i.bones.push(o[c]);break}}}i.prepare();for(let a=0;a<s.length;a++)i.bones.push(s[a]);return i},$w=(n,e,t,i,r)=>{if(r||(n.scene._blockEntityCollection=!!n.assetContainer,r=new E(e.name||"",n.scene),r._parentContainer=n.assetContainer,n.scene._blockEntityCollection=!1,r.id=i),!e.babylonNode)return r;let s=[],o=null,a=[],l=[],c=[],u=[];for(let f=0;f<t.length;f++){let p=t[f],g=n.meshes[p];if(g)for(let _=0;_<g.primitives.length;_++){let y=new K,b=g.primitives[_];b.mode;let A=b.attributes,I=null,v=null;for(let C in A)if(I=n.accessors[A[C]],v=Ri.GetBufferFromAccessor(n,I),C==="NORMAL")y.normals=new Float32Array(v.length),y.normals.set(v);else if(C==="POSITION"){if(Hr.HomogeneousCoordinates){y.positions=new Float32Array(v.length-v.length/4);for(let R=0;R<v.length;R+=4)y.positions[R]=v[R],y.positions[R+1]=v[R+1],y.positions[R+2]=v[R+2]}else y.positions=new Float32Array(v.length),y.positions.set(v);l.push(y.positions.length)}else if(C.indexOf("TEXCOORD_")!==-1){let R=Number(C.split("_")[1]),M=T.UVKind+(R===0?"":R+1),D=new Float32Array(v.length);D.set(v),KB(D),y.set(D,M)}else C==="JOINT"?(y.matricesIndices=new Float32Array(v.length),y.matricesIndices.set(v)):C==="WEIGHT"?(y.matricesWeights=new Float32Array(v.length),y.matricesWeights.set(v)):C==="COLOR"&&(y.colors=new Float32Array(v.length),y.colors.set(v));if(I=n.accessors[b.indices],I)v=Ri.GetBufferFromAccessor(n,I),y.indices=new Int32Array(v.length),y.indices.set(v),u.push(y.indices.length);else{let C=[];for(let R=0;R<y.positions.length/3;R++)C.push(R);y.indices=new Int32Array(C),u.push(y.indices.length)}o?o.merge(y):o=y;let x=n.scene.getMaterialById(b.material);s.push(x===null?Ri.GetDefaultMaterial(n.scene):x),a.push(a.length===0?0:a[a.length-1]+l[l.length-2]),c.push(c.length===0?0:c[c.length-1]+u[u.length-2])}}let h;n.scene._blockEntityCollection=!!n.assetContainer,s.length>1?(h=new cr("multimat"+i,n.scene),h.subMaterials=s):h=new te("multimat"+i,n.scene),s.length===1&&(h=s[0]),h._parentContainer=n.assetContainer,r.material||(r.material=h),new Lt(i,n.scene,o,!1,r),r.computeWorldMatrix(!0),n.scene._blockEntityCollection=!1,r.subMeshes=[];let d=0;for(let f=0;f<t.length;f++){let p=t[f],g=n.meshes[p];if(g)for(let _=0;_<g.primitives.length;_++)g.primitives[_].mode,Xi.AddToMesh(d,a[d],l[d],c[d],u[d],r,r,!0),d++}return r},Kb=(n,e,t,i)=>{n.position&&(n.position=e),(n.rotationQuaternion||n.rotation)&&(n.rotationQuaternion=t),n.scaling&&(n.scaling=i)},tk=(n,e)=>{if(e.matrix){let t=new m(0,0,0),i=new Q,r=new m(0,0,0);L.FromArray(e.matrix).decompose(r,i,t),Kb(n,t,i,r)}else e.translation&&e.rotation&&e.scale&&Kb(n,m.FromArray(e.translation),Q.FromArray(e.rotation),m.FromArray(e.scale));n.computeWorldMatrix(!0)},ik=(n,e,t)=>{let i=null;if(n.importOnlyMeshes&&(e.skin||e.meshes)&&n.importMeshesNames&&n.importMeshesNames.length>0&&n.importMeshesNames.indexOf(e.name||"")===-1)return null;if(e.skin){if(e.meshes){let r=n.skins[e.skin],s=$w(n,e,e.meshes,t,e.babylonNode);s.skeleton=n.scene.getLastSkeletonById(e.skin),s.skeleton===null&&(s.skeleton=ek(n,r,s,r.babylonSkeleton),r.babylonSkeleton||(r.babylonSkeleton=s.skeleton)),i=s}}else if(e.meshes)i=$w(n,e,e.mesh?[e.mesh]:e.meshes,t,e.babylonNode);else if(e.light&&!e.babylonNode&&!n.importOnlyMeshes){let r=n.lights[e.light];if(r){if(r.type==="ambient"){let s=r[r.type],o=new Di(e.light,m.Zero(),n.scene);o.name=e.name||"",s.color&&(o.diffuse=U.FromArray(s.color)),i=o}else if(r.type==="directional"){let s=r[r.type],o=new Fa(e.light,m.Zero(),n.scene);o.name=e.name||"",s.color&&(o.diffuse=U.FromArray(s.color)),i=o}else if(r.type==="point"){let s=r[r.type],o=new In(e.light,m.Zero(),n.scene);o.name=e.name||"",s.color&&(o.diffuse=U.FromArray(s.color)),i=o}else if(r.type==="spot"){let s=r[r.type],o=new Ms(e.light,m.Zero(),m.Zero(),0,0,n.scene);o.name=e.name||"",s.color&&(o.diffuse=U.FromArray(s.color)),s.fallOfAngle&&(o.angle=s.fallOfAngle),s.fallOffExponent&&(o.exponent=s.fallOffExponent),i=o}}}else if(e.camera&&!e.babylonNode&&!n.importOnlyMeshes){let r=n.cameras[e.camera];if(r){if(n.scene._blockEntityCollection=!!n.assetContainer,r.type==="orthographic"){let s=new Bt(e.camera,m.Zero(),n.scene,!1);s.name=e.name||"",s.mode=Fe.ORTHOGRAPHIC_CAMERA,s.attachControl(),i=s,s._parentContainer=n.assetContainer}else if(r.type==="perspective"){let s=r[r.type],o=new Bt(e.camera,m.Zero(),n.scene,!1);o.name=e.name||"",o.attachControl(),s.aspectRatio||(s.aspectRatio=n.scene.getEngine().getRenderWidth()/n.scene.getEngine().getRenderHeight()),s.znear&&s.zfar&&(o.maxZ=s.zfar,o.minZ=s.znear),i=o,o._parentContainer=n.assetContainer}n.scene._blockEntityCollection=!1}}if(!e.jointName){if(e.babylonNode)return e.babylonNode;if(i===null){n.scene._blockEntityCollection=!!n.assetContainer;let r=new E(e.name||"",n.scene);r._parentContainer=n.assetContainer,n.scene._blockEntityCollection=!1,e.babylonNode=r,i=r}}if(i!==null){if(e.matrix&&i instanceof E)tk(i,e);else{let r=e.translation||[0,0,0],s=e.rotation||[0,0,0,1],o=e.scale||[1,1,1];Kb(i,m.FromArray(r),Q.FromArray(s),m.FromArray(o))}i.updateCache(!0),e.babylonNode=i}return i},Ku=(n,e,t,i=!1)=>{let r=n.nodes[e],s=null;if(n.importOnlyMeshes&&!i&&n.importMeshesNames?n.importMeshesNames.indexOf(r.name||"")!==-1||n.importMeshesNames.length===0?i=!0:i=!1:i=!0,!r.jointName&&i&&(s=ik(n,r,e),s!==null&&(s.id=e,s.parent=t)),r.children)for(let o=0;o<r.children.length;o++)Ku(n,r.children[o],s,i)},jw=n=>{let e=n.currentScene;if(e)for(let t=0;t<e.nodes.length;t++)Ku(n,e.nodes[t],null);else for(let t in n.scenes){e=n.scenes[t];for(let i=0;i<e.nodes.length;i++)Ku(n,e.nodes[i],null)}XB(n);for(let t=0;t<n.scene.skeletons.length;t++){let i=n.scene.skeletons[t];n.scene.beginAnimation(i,0,Number.MAX_VALUE,!0,1)}},nk=(n,e,t,i,r,s,o)=>{let a=s.values||r.parameters;for(let l in t){let c=t[l],u=c.type;if(u===wi.FLOAT_MAT2||u===wi.FLOAT_MAT3||u===wi.FLOAT_MAT4){if(c.semantic&&!c.source&&!c.node)Ri.SetMatrix(e.scene,n,c,l,i.getEffect());else if(c.semantic&&(c.source||c.node)){let h=e.scene.getNodeByName(c.source||c.node||"");if(h===null&&(h=e.scene.getNodeById(c.source||c.node||"")),h===null)continue;Ri.SetMatrix(e.scene,h,c,l,i.getEffect())}}else{let h=a[r.uniforms[l]];if(!h)continue;if(u===wi.SAMPLER_2D){let d=e.textures[s.values?h:c.value].babylonTexture;if(d==null)continue;i.getEffect().setTexture(l,d)}else Ri.SetUniform(i.getEffect(),l,h,u)}}o(i)},rk=(n,e,t,i,r)=>{let s=i.values||t.parameters,o=t.uniforms;for(let a in r){let l=r[a],c=l.type,u=s[o[a]];if(u===void 0&&(u=l.value),!u)continue;let h=d=>f=>{l.value&&d&&(e.setTexture(d,f),delete r[d])};c===wi.SAMPLER_2D?En.LoadTextureAsync(n,i.values?u:l.value,h(a),()=>h(null)):l.value&&Ri.SetUniform(e,a,i.values?u:l.value,c)&&delete r[a]}},sk=(n,e,t)=>(i,r)=>{e.dispose(!0),t("Cannot compile program named "+n.name+". Error: "+r+". Default material will be applied")},ok=(n,e,t,i,r,s)=>o=>{rk(n,e,t,i,r),e.onBind=a=>{nk(a,n,r,e,t,i,s)}},qw=(n,e,t)=>{for(let i in e.uniforms){let r=e.uniforms[i],s=e.parameters[r];if(n.currentIdentifier===i&&s.semantic&&!s.source&&!s.node){let o=Kw.indexOf(s.semantic);if(o!==-1)return delete t[i],Xw[o]}}return n.currentIdentifier},Yw=n=>{for(let e in n.materials)En.LoadMaterialAsync(n,e,()=>{},()=>{})},An=class{static CreateRuntime(e,t,i){let r={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:t,rootUrl:i,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&Pi(e.extensions,"extensions",r),e.extensionsUsed&&Pi(e.extensionsUsed,"extensionsUsed",r),e.buffers&&qB(e.buffers,r),e.bufferViews&&Pi(e.bufferViews,"bufferViews",r),e.accessors&&Pi(e.accessors,"accessors",r),e.meshes&&Pi(e.meshes,"meshes",r),e.lights&&Pi(e.lights,"lights",r),e.cameras&&Pi(e.cameras,"cameras",r),e.nodes&&Pi(e.nodes,"nodes",r),e.images&&Pi(e.images,"images",r),e.textures&&Pi(e.textures,"textures",r),e.shaders&&YB(e.shaders,r),e.programs&&Pi(e.programs,"programs",r),e.samplers&&Pi(e.samplers,"samplers",r),e.techniques&&Pi(e.techniques,"techniques",r),e.materials&&Pi(e.materials,"materials",r),e.animations&&Pi(e.animations,"animations",r),e.skins&&Pi(e.skins,"skins",r),e.scenes&&(r.scenes=e.scenes),e.scene&&e.scenes&&(r.currentScene=e.scenes[e.scene]),r}static LoadBufferAsync(e,t,i,r,s){let o=e.buffers[t];z.IsBase64(o.uri)?setTimeout(()=>i(new Uint8Array(z.DecodeBase64(o.uri)))):z.LoadFile(e.rootUrl+o.uri,a=>i(new Uint8Array(a)),s,void 0,!0,a=>{a&&r(a.status+" "+a.statusText)})}static LoadTextureBufferAsync(e,t,i,r){let s=e.textures[t];if(!s||!s.source){r("");return}if(s.babylonTexture){i(null);return}let o=e.images[s.source];z.IsBase64(o.uri)?setTimeout(()=>i(new Uint8Array(z.DecodeBase64(o.uri)))):z.LoadFile(e.rootUrl+o.uri,a=>i(new Uint8Array(a)),void 0,void 0,!0,a=>{a&&r(a.status+" "+a.statusText)})}static CreateTextureAsync(e,t,i,r){let s=e.textures[t];if(s.babylonTexture){r(s.babylonTexture);return}let o=e.samplers[s.sampler],a=o.minFilter===Wn.NEAREST_MIPMAP_NEAREST||o.minFilter===Wn.NEAREST_MIPMAP_LINEAR||o.minFilter===Wn.LINEAR_MIPMAP_NEAREST||o.minFilter===Wn.LINEAR_MIPMAP_LINEAR,l=Z.BILINEAR_SAMPLINGMODE,c=i==null?new Blob:new Blob([i]),u=URL.createObjectURL(c),h=()=>URL.revokeObjectURL(u),d=new Z(u,e.scene,!a,!0,l,h,h);o.wrapS!==void 0&&(d.wrapU=Ri.GetWrapMode(o.wrapS)),o.wrapT!==void 0&&(d.wrapV=Ri.GetWrapMode(o.wrapT)),d.name=t,s.babylonTexture=d,r(d)}static LoadShaderStringAsync(e,t,i,r){let s=e.shaders[t];if(z.IsBase64(s.uri)){let o=atob(s.uri.split(",")[1]);i&&i(o)}else z.LoadFile(e.rootUrl+s.uri,i,void 0,void 0,!1,o=>{o&&r&&r(o.status+" "+o.statusText)})}static LoadMaterialAsync(e,t,i,r){let s=e.materials[t];if(!s.technique){r&&r("No technique found.");return}let o=e.techniques[s.technique];if(!o){e.scene._blockEntityCollection=!!e.assetContainer;let x=new te(t,e.scene);x._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,x.diffuseColor=new U(.5,.5,.5),x.sideOrientation=Re.CounterClockWiseSideOrientation,i(x);return}let a=e.programs[o.program],l=o.states,c=Pt.ShadersStore[a.vertexShader+"VertexShader"],u=Pt.ShadersStore[a.fragmentShader+"PixelShader"],h="",d="",f=new kp(c),p=new kp(u),g={},_=[],y=[],b=[];for(let x in o.uniforms){let C=o.uniforms[x],R=o.parameters[C];if(g[x]=R,R.semantic&&!R.node&&!R.source){let M=Kw.indexOf(R.semantic);M!==-1?(_.push(Xw[M]),delete g[x]):_.push(x)}else R.type===wi.SAMPLER_2D?b.push(x):_.push(x)}for(let x in o.attributes){let C=o.attributes[x],R=o.parameters[C];if(R.semantic){let M=Ww(R);M&&y.push(M)}}for(;!f.isEnd()&&f.getNextToken();){if(f.currentToken!==Yo.IDENTIFIER){h+=f.currentString;continue}let C=!1;for(let R in o.attributes){let M=o.attributes[R],D=o.parameters[M];if(f.currentIdentifier===R&&D.semantic){h+=Ww(D),C=!0;break}}C||(h+=qw(f,o,g))}for(;!p.isEnd()&&p.getNextToken();){if(p.currentToken!==Yo.IDENTIFIER){d+=p.currentString;continue}d+=qw(p,o,g)}let A={vertex:a.vertexShader+t,fragment:a.fragmentShader+t},I={attributes:y,uniforms:_,samplers:b,needAlphaBlending:l&&l.enable&&l.enable.indexOf(3042)!==-1};Pt.ShadersStore[a.vertexShader+t+"VertexShader"]=h,Pt.ShadersStore[a.fragmentShader+t+"PixelShader"]=d;let v=new un(t,e.scene,A,I);if(v.onError=sk(a,v,r),v.onCompiled=ok(e,v,o,s,g,i),v.sideOrientation=Re.CounterClockWiseSideOrientation,l&&l.functions){let x=l.functions;x.cullFace&&x.cullFace[0]!==Ub.BACK&&(v.backFaceCulling=!1);let C=x.blendFuncSeparate;C&&(C[0]===wt.SRC_ALPHA&&C[1]===wt.ONE_MINUS_SRC_ALPHA&&C[2]===wt.ONE&&C[3]===wt.ONE?v.alphaMode=ts.ALPHA_COMBINE:C[0]===wt.ONE&&C[1]===wt.ONE&&C[2]===wt.ZERO&&C[3]===wt.ONE?v.alphaMode=ts.ALPHA_ONEONE:C[0]===wt.SRC_ALPHA&&C[1]===wt.ONE&&C[2]===wt.ZERO&&C[3]===wt.ONE?v.alphaMode=ts.ALPHA_ADD:C[0]===wt.ZERO&&C[1]===wt.ONE_MINUS_SRC_COLOR&&C[2]===wt.ONE&&C[3]===wt.ONE?v.alphaMode=ts.ALPHA_SUBTRACT:C[0]===wt.DST_COLOR&&C[1]===wt.ZERO&&C[2]===wt.ONE&&C[3]===wt.ONE?v.alphaMode=ts.ALPHA_MULTIPLY:C[0]===wt.SRC_ALPHA&&C[1]===wt.ONE_MINUS_SRC_COLOR&&C[2]===wt.ONE&&C[3]===wt.ONE&&(v.alphaMode=ts.ALPHA_MAXIMIZED))}}},Ko=(()=>{class n{static RegisterExtension(t){if(n.Extensions[t.name]){z.Error('Tool with the same name "'+t.name+'" already exists');return}n.Extensions[t.name]=t}dispose(){}_importMeshAsync(t,i,r,s,o,a,l,c){return i.useRightHandedSystem=!0,En.LoadRuntimeAsync(i,r,s,u=>{u.assetContainer=o,u.importOnlyMeshes=!0,t===""?u.importMeshesNames=[]:typeof t=="string"?u.importMeshesNames=[t]:t&&!(t instanceof Array)?u.importMeshesNames=[t]:(u.importMeshesNames=[],z.Warn("Argument meshesNames must be of type string or string[]")),this._createNodes(u);let h=[],d=[];for(let f in u.nodes){let p=u.nodes[f];p.babylonNode instanceof _n&&h.push(p.babylonNode)}for(let f in u.skins){let p=u.skins[f];p.babylonSkeleton instanceof Wr&&d.push(p.babylonSkeleton)}this._loadBuffersAsync(u,()=>{this._loadShadersAsync(u,()=>{Yw(u),jw(u),!Hr.IncrementalLoading&&a&&a(h,d)})}),Hr.IncrementalLoading&&a&&a(h,d)},c),!0}importMeshAsync(t,i,r,s,o,a){return new Promise((l,c)=>{this._importMeshAsync(t,i,s,o,r,(u,h)=>{l({meshes:u,particleSystems:[],skeletons:h,animationGroups:[],lights:[],transformNodes:[],geometries:[],spriteManagers:[]})},a,u=>{c(new Error(u))})})}_loadAsync(t,i,r,s,o,a){t.useRightHandedSystem=!0,En.LoadRuntimeAsync(t,i,r,l=>{En.LoadRuntimeExtensionsAsync(l,()=>{this._createNodes(l),this._loadBuffersAsync(l,()=>{this._loadShadersAsync(l,()=>{Yw(l),jw(l),Hr.IncrementalLoading||s()})}),Hr.IncrementalLoading&&s()},a)},a)}loadAsync(t,i,r,s){return S(this,null,function*(){return yield new Promise((o,a)=>{this._loadAsync(t,i,r,()=>{o()},s,l=>{a(new Error(l))})})})}_loadShadersAsync(t,i){let r=!1,s=(o,a)=>{En.LoadShaderStringAsync(t,o,l=>{l instanceof ArrayBuffer||(t.loadedShaderCount++,l&&(Pt.ShadersStore[o+(a.type===Gb.VERTEX?"VertexShader":"PixelShader")]=l),t.loadedShaderCount===t.shaderscount&&i())},()=>{z.Error("Error when loading shader program named "+o+" located at "+a.uri)})};for(let o in t.shaders){r=!0;let a=t.shaders[o];a?s.bind(this,o,a)():z.Error("No shader named: "+o)}r||i()}_loadBuffersAsync(t,i){let r=!1,s=(o,a)=>{En.LoadBufferAsync(t,o,l=>{t.loadedBufferCount++,l&&(l.byteLength!=t.buffers[o].byteLength&&z.Error("Buffer named "+o+" is length "+l.byteLength+". Expected: "+a.byteLength),t.loadedBufferViews[o]=l),t.loadedBufferCount===t.buffersCount&&i()},()=>{z.Error("Error when loading buffer named "+o+" located at "+a.uri)})};for(let o in t.buffers){r=!0;let a=t.buffers[o];a?s.bind(this,o,a)():z.Error("No buffer named: "+o)}r||i()}_createNodes(t){let i=t.currentScene;if(i)for(let r=0;r<i.nodes.length;r++)Ku(t,i.nodes[r],null);else for(let r in t.scenes){i=t.scenes[r];for(let s=0;s<i.nodes.length;s++)Ku(t,i.nodes[s],null)}}}return n.Extensions={},n})(),En=class n{constructor(e){this._name=e}get name(){return this._name}loadRuntimeAsync(e,t,i,r,s){return!1}loadRuntimeExtensionsAsync(e,t,i){return!1}loadBufferAsync(e,t,i,r,s){return!1}loadTextureBufferAsync(e,t,i,r){return!1}createTextureAsync(e,t,i,r,s){return!1}loadShaderStringAsync(e,t,i,r){return!1}loadMaterialAsync(e,t,i,r){return!1}static LoadRuntimeAsync(e,t,i,r,s){n._ApplyExtensions(o=>o.loadRuntimeAsync(e,t,i,r,s),()=>{setTimeout(()=>{r&&r(An.CreateRuntime(t.json,e,i))})})}static LoadRuntimeExtensionsAsync(e,t,i){n._ApplyExtensions(r=>r.loadRuntimeExtensionsAsync(e,t,i),()=>{setTimeout(()=>{t()})})}static LoadBufferAsync(e,t,i,r,s){n._ApplyExtensions(o=>o.loadBufferAsync(e,t,i,r,s),()=>{An.LoadBufferAsync(e,t,i,r,s)})}static LoadTextureAsync(e,t,i,r){n._LoadTextureBufferAsync(e,t,s=>{s&&n._CreateTextureAsync(e,t,s,i,r)},r)}static LoadShaderStringAsync(e,t,i,r){n._ApplyExtensions(s=>s.loadShaderStringAsync(e,t,i,r),()=>{An.LoadShaderStringAsync(e,t,i,r)})}static LoadMaterialAsync(e,t,i,r){n._ApplyExtensions(s=>s.loadMaterialAsync(e,t,i,r),()=>{An.LoadMaterialAsync(e,t,i,r)})}static _LoadTextureBufferAsync(e,t,i,r){n._ApplyExtensions(s=>s.loadTextureBufferAsync(e,t,i,r),()=>{An.LoadTextureBufferAsync(e,t,i,r)})}static _CreateTextureAsync(e,t,i,r,s){n._ApplyExtensions(o=>o.createTextureAsync(e,t,i,r,s),()=>{An.CreateTextureAsync(e,t,i,r)})}static _ApplyExtensions(e,t){for(let i in Ko.Extensions){let r=Ko.Extensions[i];if(e(r))return}t()}};Hr._CreateGLTF1Loader=()=>new Ko;var ak="binary_glTF",Zb=class extends En{constructor(){super("KHR_binary_glTF")}loadRuntimeAsync(e,t,i,r){let s=t.json.extensionsUsed;return!s||s.indexOf(this.name)===-1||!t.bin?!1:(this._bin=t.bin,r(An.CreateRuntime(t.json,e,i)),!0)}loadBufferAsync(e,t,i,r){return e.extensionsUsed.indexOf(this.name)===-1||t!==ak?!1:(this._bin.readAsync(0,this._bin.byteLength).then(i,s=>r(s.message)),!0)}loadTextureBufferAsync(e,t,i){let r=e.textures[t],s=e.images[r.source];if(!s.extensions||!(this.name in s.extensions))return!1;let o=s.extensions[this.name],a=e.bufferViews[o.bufferView],l=Ri.GetBufferFromBufferView(e,a,0,a.byteLength,gs.UNSIGNED_BYTE);return i(l),!0}loadShaderStringAsync(e,t,i){let r=e.shaders[t];if(!r.extensions||!(this.name in r.extensions))return!1;let s=r.extensions[this.name],o=e.bufferViews[s.bufferView],a=Ri.GetBufferFromBufferView(e,o,0,o.byteLength,gs.UNSIGNED_BYTE);return setTimeout(()=>{let l=Ri.DecodeBufferToText(a);i(l)}),!0}};Ko.RegisterExtension(new Zb);var Qb=class extends En{constructor(){super("KHR_materials_common")}loadRuntimeExtensionsAsync(e){if(!e.extensions)return!1;let t=e.extensions[this.name];if(!t)return!1;let i=t.lights;if(i)for(let r in i){let s=i[r];switch(s.type){case"ambient":{let o=new Di(s.name,new m(0,1,0),e.scene),a=s.ambient;a&&(o.diffuse=U.FromArray(a.color||[1,1,1]));break}case"point":{let o=new In(s.name,new m(10,10,10),e.scene),a=s.point;a&&(o.diffuse=U.FromArray(a.color||[1,1,1]));break}case"directional":{let o=new Fa(s.name,new m(0,-1,0),e.scene),a=s.directional;a&&(o.diffuse=U.FromArray(a.color||[1,1,1]));break}case"spot":{let o=s.spot;if(o){let a=new Ms(s.name,new m(0,10,0),new m(0,-1,0),o.fallOffAngle||Math.PI,o.fallOffExponent||0,e.scene);a.diffuse=U.FromArray(o.color||[1,1,1])}break}default:z.Warn('GLTF Material Common extension: light type "'+s.type+"\u201D not supported");break}}return!1}loadMaterialAsync(e,t,i,r){let s=e.materials[t];if(!s||!s.extensions)return!1;let o=s.extensions[this.name];if(!o)return!1;let a=new te(t,e.scene);return a.sideOrientation=Re.CounterClockWiseSideOrientation,o.technique==="CONSTANT"&&(a.disableLighting=!0),a.backFaceCulling=o.doubleSided===void 0?!1:!o.doubleSided,a.alpha=o.values.transparency===void 0?1:o.values.transparency,a.specularPower=o.values.shininess===void 0?0:o.values.shininess,typeof o.values.ambient=="string"?this._loadTexture(e,o.values.ambient,a,"ambientTexture",r):a.ambientColor=U.FromArray(o.values.ambient||[0,0,0]),typeof o.values.diffuse=="string"?this._loadTexture(e,o.values.diffuse,a,"diffuseTexture",r):a.diffuseColor=U.FromArray(o.values.diffuse||[0,0,0]),typeof o.values.emission=="string"?this._loadTexture(e,o.values.emission,a,"emissiveTexture",r):a.emissiveColor=U.FromArray(o.values.emission||[0,0,0]),typeof o.values.specular=="string"?this._loadTexture(e,o.values.specular,a,"specularTexture",r):a.specularColor=U.FromArray(o.values.specular||[0,0,0]),!0}_loadTexture(e,t,i,r,s){An.LoadTextureBufferAsync(e,t,o=>{An.CreateTextureAsync(e,t,o,a=>i[r]=a)},s)}};Ko.RegisterExtension(new Qb);var _s=class{get resolve(){return this._resolve}get reject(){return this._reject}constructor(){this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}};var Xo=class n{get influence(){return this._influence}set influence(e){if(this._influence===e)return;let t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(t===0||e===0)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}constructor(e,t=0,i=null){this.name=e,this.animations=[],this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uv2s=null,this._colors=null,this._uniqueId=0,this.onInfluenceChanged=new F,this._onDataLayoutChanged=new F,this._animationPropertiesOverride=null,this.id=e,this._scene=i||ye.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}get hasUV2s(){return!!this._uv2s}get hasColors(){return!!this._colors}get vertexCount(){return this._positions?this._positions.length/3:this._normals?this._normals.length/3:this._tangents?this._tangents.length/3:this._uvs?this._uvs.length/2:this._uv2s?this._uv2s.length/2:this._colors?this._colors.length/4:0}setPositions(e){let t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){let t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){let t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){let t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}setUV2s(e){let t=this.hasUV2s;this._uv2s=e,t!==this.hasUV2s&&this._onDataLayoutChanged.notifyObservers(void 0)}getUV2s(){return this._uv2s}setColors(e){let t=this.hasColors;this._colors=e,t!==this.hasColors&&this._onDataLayoutChanged.notifyObservers(void 0)}getColors(){return this._colors}clone(){let e=je.Clone(()=>new n(this.name,this.influence,this._scene),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e._uv2s=this._uv2s,e._colors=this._colors,e}serialize(){let e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),this.id!=null&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),this.hasUV2s&&(e.uv2s=Array.prototype.slice.call(this.getUV2s())),this.hasColors&&(e.colors=Array.prototype.slice.call(this.getColors())),je.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){let i=new n(e.name,e.influence);if(i.setPositions(e.positions),e.id!=null&&(i.id=e.id),e.normals&&i.setNormals(e.normals),e.tangents&&i.setTangents(e.tangents),e.uvs&&i.setUVs(e.uvs),e.uv2s&&i.setUV2s(e.uv2s),e.colors&&i.setColors(e.colors),e.animations){for(let r=0;r<e.animations.length;r++){let s=e.animations[r],o=vt("BABYLON.Animation");o&&i.animations.push(o.Parse(s))}e.autoAnimate&&t&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return i}static FromMesh(e,t,i){t||(t=e.name);let r=new n(t,i,e.getScene());return r.setPositions(e.getVerticesData(T.PositionKind)),e.isVerticesDataPresent(T.NormalKind)&&r.setNormals(e.getVerticesData(T.NormalKind)),e.isVerticesDataPresent(T.TangentKind)&&r.setTangents(e.getVerticesData(T.TangentKind)),e.isVerticesDataPresent(T.UVKind)&&r.setUVs(e.getVerticesData(T.UVKind)),e.isVerticesDataPresent(T.UV2Kind)&&r.setUV2s(e.getVerticesData(T.UV2Kind)),e.isVerticesDataPresent(T.ColorKind)&&r.setColors(e.getVerticesData(T.ColorKind)),r}};w([B()],Xo.prototype,"id",void 0);var Vp=class n extends Z{get depth(){return this._depth}constructor(e,t,i,r,s,o,a=!0,l=!1,c=Z.TRILINEAR_SAMPLINGMODE,u=0,h){super(null,o,!a,l),this.format=s,this._texture=o.getEngine().createRawTexture2DArray(e,t,i,r,s,a,l,c,null,u,h),this._depth=r,this.is2DArray=!0}update(e){this._texture&&this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,i,r,s,o=!0,a=!1,l=3,c=0){return new n(e,t,i,r,5,s,o,a,l,c)}};var Xu=(()=>{class n{set areUpdatesFrozen(t){t?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(this._forceUpdateWhenUnfrozen),this._forceUpdateWhenUnfrozen=!1))}get areUpdatesFrozen(){return this._blockCounter>0}constructor(t=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new wa(16),this._supportsPositions=!1,this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._supportsUV2s=!1,this._supportsColors=!1,this._vertexCount=0,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._mustSynchronize=!0,this._forceUpdateWhenUnfrozen=!1,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._parentContainer=null,this.optimizeInfluencers=!0,this.enablePositionMorphing=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this.enableUV2Morphing=!0,this.enableColorMorphing=!0,this._numMaxInfluencers=0,this._useTextureToStoreTargets=!0,this.metadata=null,this._influencesAreDirty=!1,this._needUpdateInfluences=!1,t||(t=ye.LastCreatedScene),this._scene=t,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();let i=this._scene.getEngine().getCaps();this._canUseTextureForTargets=i.canUseGLVertexID&&i.textureFloat&&i.maxVertexTextureImageUnits>0&&i.texture2DArrayMaxLayerCount>1}}get numMaxInfluencers(){return n.ConstantTargetCountForTextureMode>0&&this.isUsingTextureForTargets?n.ConstantTargetCountForTextureMode:this._numMaxInfluencers}set numMaxInfluencers(t){this._numMaxInfluencers!==t&&(this._numMaxInfluencers=t,this._mustSynchronize=!0,this._syncActiveTargets())}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsPositions(){return this._supportsPositions&&this.enablePositionMorphing}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get supportsUV2s(){return this._supportsUV2s&&this.enableUV2Morphing}get supportsColors(){return this._supportsColors&&this.enableColorMorphing}get hasPositions(){return this._supportsPositions}get hasNormals(){return this._supportsNormals}get hasTangents(){return this._supportsTangents}get hasUVs(){return this._supportsUVs}get hasUV2s(){return this._supportsUV2s}get hasColors(){return this._supportsColors}get numTargets(){return this._targets.length}get numInfluencers(){return this._influencesAreDirty&&this._syncActiveTargets(),this._activeTargets.length}get influences(){return this._influencesAreDirty&&this._syncActiveTargets(),this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(t){this._useTextureToStoreTargets!==t&&(this._useTextureToStoreTargets=t,this._mustSynchronize=!0,this._syncActiveTargets())}get isUsingTextureForTargets(){return n.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets&&!this._scene?.getEngine().getCaps().disableMorphTargetTexture}getActiveTarget(t){return this._influencesAreDirty&&this._syncActiveTargets(),this._activeTargets.data[t]}getTarget(t){return this._targets[t]}getTargetByName(t){for(let i of this._targets)if(i.name===t)return i;return null}addTarget(t){this._targets.push(t),this._targetInfluenceChangedObservers.push(t.onInfluenceChanged.add(i=>{this.areUpdatesFrozen&&i&&(this._forceUpdateWhenUnfrozen=!0),this._influencesAreDirty=!0,this._needUpdateInfluences=this._needUpdateInfluences||i})),this._targetDataLayoutChangedObservers.push(t._onDataLayoutChanged.add(()=>{this._mustSynchronize=!0,this._syncActiveTargets()})),this._mustSynchronize=!0,this._syncActiveTargets()}removeTarget(t){let i=this._targets.indexOf(t);i>=0&&(this._targets.splice(i,1),t.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(i,1)[0]),t._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(i,1)[0]),this._mustSynchronize=!0,this._syncActiveTargets()),this._scene&&this._scene.stopAnimation(t)}_bind(t){this._influencesAreDirty&&this._syncActiveTargets(),t.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),t.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),t.setTexture("morphTargets",this._targetStoreTexture),t.setFloat("morphTargetCount",this.numInfluencers)}clone(){let t=new n(this._scene);t.areUpdatesFrozen=!0;for(let i of this._targets)t.addTarget(i.clone());return t.areUpdatesFrozen=!1,t.enablePositionMorphing=this.enablePositionMorphing,t.enableNormalMorphing=this.enableNormalMorphing,t.enableTangentMorphing=this.enableTangentMorphing,t.enableUVMorphing=this.enableUVMorphing,t.enableUV2Morphing=this.enableUV2Morphing,t.enableColorMorphing=this.enableColorMorphing,t.metadata=this.metadata,t}serialize(){let t={};t.id=this.uniqueId,t.targets=[];for(let i of this._targets)t.targets.push(i.serialize());return this.metadata&&(t.metadata=this.metadata),t}_syncActiveTargets(t=!1){if(this.areUpdatesFrozen)return;t=t||this._needUpdateInfluences,this._needUpdateInfluences=!1,this._influencesAreDirty=!1;let i=!!this._targetStoreTexture,r=this.isUsingTextureForTargets;(this._mustSynchronize||i!==r)&&(this._mustSynchronize=!1,this.synchronize());let s=0;this._activeTargets.reset(),(!this._morphTargetTextureIndices||this._morphTargetTextureIndices.length!==this._targets.length)&&(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let o=-1;for(let a of this._targets)if(o++,!(a.influence===0&&this.optimizeInfluencers)){if(this._activeTargets.length>=n.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(a),this._morphTargetTextureIndices[s]=o,this._tempInfluences[s++]=a.influence}this._morphTargetTextureIndices.length!==s&&(this._morphTargetTextureIndices=this._morphTargetTextureIndices.slice(0,s)),(!this._influences||this._influences.length!==s)&&(this._influences=new Float32Array(s));for(let a=0;a<s;a++)this._influences[a]=this._tempInfluences[a];if(t&&this._scene)for(let a of this._scene.meshes)a.morphTargetManager===this&&(r?a._markSubMeshesAsAttributesDirty():a._syncGeometryWithMorphTargetManager())}synchronize(){if(!this._scene||this.areUpdatesFrozen)return;let t=this._scene.getEngine();this._supportsPositions=!0,this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._supportsUV2s=!0,this._supportsColors=!0,this._vertexCount=0,this._targetStoreTexture?.dispose(),this._targetStoreTexture=null,this.isUsingTextureForTargets&&this._targets.length>t.getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1);for(let i of this._targets){this._supportsPositions=this._supportsPositions&&i.hasPositions,this._supportsNormals=this._supportsNormals&&i.hasNormals,this._supportsTangents=this._supportsTangents&&i.hasTangents,this._supportsUVs=this._supportsUVs&&i.hasUVs,this._supportsUV2s=this._supportsUV2s&&i.hasUV2s,this._supportsColors=this._supportsColors&&i.hasColors;let r=i.vertexCount;if(this._vertexCount===0)this._vertexCount=r;else if(this._vertexCount!==r){P.Error(`Incompatible target. Targets must all have the same vertices count. Current vertex count: ${this._vertexCount}, vertex count for target "${i.name}": ${r}`);return}}if(this.isUsingTextureForTargets){this._textureVertexStride=0,this._supportsPositions&&this._textureVertexStride++,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._supportsUV2s&&this._textureVertexStride++,this._supportsColors&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride||1,this._textureHeight=1;let i=t.getCaps().maxTextureSize;this._textureWidth>i&&(this._textureHeight=Math.ceil(this._textureWidth/i),this._textureWidth=i);let r=this._targets.length,s=new Float32Array(r*this._textureWidth*this._textureHeight*4),o=0;for(let a=0;a<r;a++){let l=this._targets[a],c=l.getPositions(),u=l.getNormals(),h=l.getUVs(),d=l.getTangents(),f=l.getUV2s(),p=l.getColors();o=a*this._textureWidth*this._textureHeight*4;for(let g=0;g<this._vertexCount;g++)this._supportsPositions&&c&&(s[o]=c[g*3],s[o+1]=c[g*3+1],s[o+2]=c[g*3+2],o+=4),this._supportsNormals&&u&&(s[o]=u[g*3],s[o+1]=u[g*3+1],s[o+2]=u[g*3+2],o+=4),this._supportsUVs&&h&&(s[o]=h[g*2],s[o+1]=h[g*2+1],o+=4),this._supportsTangents&&d&&(s[o]=d[g*3],s[o+1]=d[g*3+1],s[o+2]=d[g*3+2],o+=4),this._supportsUV2s&&f&&(s[o]=f[g*2],s[o+1]=f[g*2+1],o+=4),this._supportsColors&&p&&(s[o]=p[g*4],s[o+1]=p[g*4+1],s[o+2]=p[g*4+2],s[o+3]=p[g*4+3],o+=4)}this._targetStoreTexture=Vp.CreateRGBATexture(s,this._textureWidth,this._textureHeight,r,this._scene,!1,!1,1,1),this._targetStoreTexture.name=`Morph texture_${this.uniqueId}`}for(let i of this._scene.meshes)i.morphTargetManager===this&&i._syncGeometryWithMorphTargetManager()}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this.metadata=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){let t=this._parentContainer.morphTargetManagers.indexOf(this);t>-1&&this._parentContainer.morphTargetManagers.splice(t,1),this._parentContainer=null}for(let t of this._targets)this._scene.stopAnimation(t)}}static Parse(t,i){let r=new n(i);for(let s of t.targets)r.addTarget(Xo.Parse(s,i));return t.metadata&&(r.metadata=t.metadata),r}}return n.EnableTextureStorage=!0,n.MaxActiveMorphTargetsInVertexAttributeMode=8,n.ConstantTargetCountForTextureMode=0,n})();var Jb=new Map,Qw=Jb;function fe(n,e,t){de(n)&&P.Warn(`Extension with the name '${n}' already exists`),Jb.set(n,{isGLTFExtension:e,factory:t})}function de(n){return Jb.delete(n)}function ex(...n){let e=t=>!!t&&typeof t=="object";return n.reduce((t,i)=>{let r=Object.keys(i);for(let s of r){let o=t[s],a=i[s];Array.isArray(o)&&Array.isArray(a)?t[s]=o.concat(...a):e(o)&&e(a)?t[s]=ex(o,a):t[s]=a}return t},{})}var Zu=class{constructor(e){this._factory=e}get value(){return this._factory&&(this._value=this._factory(),this._factory=void 0),this._value}};var ck=new Zu(()=>import("./chunk-JYBZVNQY.js")),uk=new Zu(()=>import("./chunk-IWMJWVK4.js"));var se=class{static Get(e,t,i){if(!t||i==null||!t[i])throw new Error(`${e}: Failed to find index (${i})`);return t[i]}static TryGet(e,t){return!e||t==null||!e[t]?null:e[t]}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}};function tx(n){if(n.min&&n.max){let e=n.min,t=n.max,i=k.Vector3[0].copyFromFloats(e[0],e[1],e[2]),r=k.Vector3[1].copyFromFloats(t[0],t[1],t[2]);if(n.normalized&&n.componentType!==5126){let s=1;switch(n.componentType){case 5120:s=127;break;case 5121:s=255;break;case 5122:s=32767;break;case 5123:s=65535;break}let o=1/s;i.scaleInPlace(o),r.scaleInPlace(o)}return new es(i,r)}return null}var ge=(()=>{class n{static RegisterExtension(t,i){fe(t,!1,i)}static UnregisterExtension(t){return de(t)}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}get rootUrl(){return this._rootUrl}constructor(t){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._allMaterialsDirtyRequired=!1,this._skipStartAnimationStep=!1,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._materialAdapterCache=new WeakMap,this._pbrMaterialImpl=null,this._parent=t}_getOrCreateMaterialAdapter(t){let i=this._materialAdapterCache.get(t);if(!i){if(this._pbrMaterialImpl)i=new this._pbrMaterialImpl.adapterClass(t);else throw new Error("Appropriate material adapter class not found");this._materialAdapterCache.set(t,i)}return i}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(t=>t.dispose&&t.dispose()),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}importMeshAsync(t,i,r,s,o,a,l=""){return S(this,null,function*(){return yield Promise.resolve().then(()=>S(this,null,function*(){this._babylonScene=i,this._assetContainer=r,this._loadData(s);let c=null;if(t){let u={};if(this._gltf.nodes)for(let d of this._gltf.nodes)d.name&&(u[d.name]=d.index);c=(t instanceof Array?t:[t]).map(d=>{let f=u[d];if(f===void 0)throw new Error(`Failed to find node '${d}'`);return f})}return yield this._loadAsync(o,l,c,()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries(),spriteManagers:[]}))}))})}loadAsync(t,i,r,s,o=""){return S(this,null,function*(){return this._babylonScene=t,this._loadData(i),yield this._loadAsync(r,o,null,()=>{})})}_loadAsync(t,i,r,s){return S(this,null,function*(){return yield Promise.resolve().then(()=>S(this,null,function*(){this._rootUrl=t,this._uniqueRootUrl=!t.startsWith("file:")&&i?t:`${t}${Date.now()}/`,this._fileName=i,this._allMaterialsDirtyRequired=!1,yield this._loadExtensionsAsync(),!this.parent.skipMaterials&&this._pbrMaterialImpl==null&&(this.parent.useOpenPBR||this.isExtensionUsed("KHR_materials_openpbr")?this._pbrMaterialImpl={materialClass:(yield import("./chunk-25ZH64A3.js")).OpenPBRMaterial,adapterClass:(yield import("./chunk-ATBMA4WZ.js")).OpenPBRMaterialLoadingAdapter}:this._pbrMaterialImpl={materialClass:(yield import("./chunk-Y4KUCWGA.js")).PBRMaterial,adapterClass:(yield import("./chunk-HPCBU7DH.js")).PBRMaterialLoadingAdapter});let o=`${ln[ln.LOADING]} => ${ln[ln.READY]}`,a=`${ln[ln.LOADING]} => ${ln[ln.COMPLETE]}`;this._parent._startPerformanceCounter(o),this._parent._startPerformanceCounter(a),this._parent._setState(ln.LOADING),this._extensionsOnLoading();let l=new Array,c=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials){if(r)l.push(this.loadSceneAsync("/nodes",{nodes:r,index:-1}));else if(this._gltf.scene!=null||this._gltf.scenes&&this._gltf.scenes[0]){let h=se.Get("/scene",this._gltf.scenes,this._gltf.scene||0);l.push(this.loadSceneAsync(`/scenes/${h.index}`,h))}}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let h=0;h<this._gltf.materials.length;++h){let d=this._gltf.materials[h],f="/materials/"+h,p=Re.TriangleFillMode;l.push(this._loadMaterialAsync(f,d,null,p,()=>{}))}return this._allMaterialsDirtyRequired?this._babylonScene.blockMaterialDirtyMechanism=c:this._babylonScene._forceBlockMaterialDirtyMechanism(c),this._parent.compileMaterials&&l.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&l.push(this._compileShadowGeneratorsAsync()),yield Promise.all(l).then(()=>{this._rootBabylonMesh&&this._rootBabylonMesh!==this._parent.customRootNode&&this._rootBabylonMesh.setEnabled(!0);for(let h of this._babylonScene.materials){let d=h;d.maxSimultaneousLights!==void 0&&(d.maxSimultaneousLights=Math.max(d.maxSimultaneousLights,this._babylonScene.lights.length))}return this._extensionsOnReady(),this._parent._setState(ln.READY),this._skipStartAnimationStep||this._startAnimations(),s()}).then(h=>(this._parent._endPerformanceCounter(o),z.SetImmediate(()=>{this._disposed||Promise.all(this._completePromises).then(()=>{this._parent._endPerformanceCounter(a),this._parent._setState(ln.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()},d=>{this._parent.onErrorObservable.notifyObservers(d),this._parent.onErrorObservable.clear(),this.dispose()})}),h))})).catch(o=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(o),this._parent.onErrorObservable.clear(),this.dispose()),o})})}_loadData(t){if(this._gltf=t.json,this._setupData(),t.bin){let i=this._gltf.buffers;if(i&&i[0]&&!i[0].uri){let r=i[0];(r.byteLength<t.bin.byteLength-3||r.byteLength>t.bin.byteLength)&&P.Warn(`Binary buffer length (${r.byteLength}) from JSON does not match chunk length (${t.bin.byteLength})`),this._bin=t.bin}else P.Warn("Unexpected BIN chunk")}}_setupData(){if(se.Assign(this._gltf.accessors),se.Assign(this._gltf.animations),se.Assign(this._gltf.buffers),se.Assign(this._gltf.bufferViews),se.Assign(this._gltf.cameras),se.Assign(this._gltf.images),se.Assign(this._gltf.materials),se.Assign(this._gltf.meshes),se.Assign(this._gltf.nodes),se.Assign(this._gltf.samplers),se.Assign(this._gltf.scenes),se.Assign(this._gltf.skins),se.Assign(this._gltf.textures),this._gltf.nodes){let t={};for(let r of this._gltf.nodes)if(r.children)for(let s of r.children)t[s]=r.index;let i=this._createRootNode();for(let r of this._gltf.nodes){let s=t[r.index];r.parent=s===void 0?i:this._gltf.nodes[s]}}}_loadExtensionsAsync(){return S(this,null,function*(){let t=[];if(Qw.forEach((i,r)=>{this.parent.extensionOptions[r]?.enabled===!1?i.isGLTFExtension&&this.isExtensionUsed(r)&&P.Warn(`Extension ${r} is used but has been explicitly disabled.`):(!i.isGLTFExtension||this.isExtensionUsed(r))&&t.push(S(this,null,function*(){let s=yield i.factory(this);return s.name!==r&&P.Warn(`The name of the glTF loader extension instance does not match the registered name: ${s.name} !== ${r}`),this._parent.onExtensionLoadedObservable.notifyObservers(s),s}))}),this._extensions.push(...yield Promise.all(t)),this._extensions.sort((i,r)=>(i.order||Number.MAX_VALUE)-(r.order||Number.MAX_VALUE)),this._parent.onExtensionLoadedObservable.clear(),this._gltf.extensionsRequired){for(let i of this._gltf.extensionsRequired)if(!this._extensions.some(s=>s.name===i&&s.enabled))throw this.parent.extensionOptions[i]?.enabled===!1?new Error(`Required extension ${i} is disabled`):new Error(`Required extension ${i} is not available`)}})}_createRootNode(){if(this._parent.customRootNode!==void 0)return this._rootBabylonMesh=this._parent.customRootNode,{_babylonTransformNode:this._rootBabylonMesh===null?void 0:this._rootBabylonMesh,index:-1};this._babylonScene._blockEntityCollection=!!this._assetContainer;let t=new E("__root__",this._babylonScene);this._rootBabylonMesh=t,this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);let i={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case qu.AUTO:{this._babylonScene.useRightHandedSystem||(i.rotation=[0,1,0,0],i.scale=[1,1,-1],n._LoadTransform(i,this._rootBabylonMesh));break}case qu.FORCE_RIGHT_HANDED:{this._babylonScene.useRightHandedSystem=!0;break}default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(t),i}loadSceneAsync(t,i){let r=this._extensionsLoadSceneAsync(t,i);if(r)return r;let s=new Array;if(this.logOpen(`${t} ${i.name||""}`),i.nodes)for(let o of i.nodes){let a=se.Get(`${t}/nodes/${o}`,this._gltf.nodes,o);s.push(this.loadNodeAsync(`/nodes/${a.index}`,a,l=>{l.parent=this._rootBabylonMesh}))}for(let o of this._postSceneLoadActions)o();return s.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(s).then(()=>{})}_forEachPrimitive(t,i){if(t._primitiveBabylonMeshes)for(let r of t._primitiveBabylonMeshes)i(r)}_getGeometries(){let t=[],i=this._gltf.nodes;if(i)for(let r of i)this._forEachPrimitive(r,s=>{let o=s.geometry;o&&t.indexOf(o)===-1&&t.push(o)});return t}_getMeshes(){let t=[];this._rootBabylonMesh instanceof _n&&t.push(this._rootBabylonMesh);let i=this._gltf.nodes;if(i)for(let r of i)this._forEachPrimitive(r,s=>{t.push(s)});return t}_getTransformNodes(){let t=[],i=this._gltf.nodes;if(i)for(let r of i)r._babylonTransformNode&&r._babylonTransformNode.getClassName()==="TransformNode"&&t.push(r._babylonTransformNode),r._babylonTransformNodeForSkin&&t.push(r._babylonTransformNodeForSkin);return t}_getSkeletons(){let t=[],i=this._gltf.skins;if(i)for(let r of i)r._data&&t.push(r._data.babylonSkeleton);return t}_getAnimationGroups(){let t=[],i=this._gltf.animations;if(i)for(let r of i)r._babylonAnimationGroup&&t.push(r._babylonAnimationGroup);return t}_startAnimations(){switch(this._parent.animationStartMode){case Nl.NONE:break;case Nl.FIRST:{let t=this._getAnimationGroups();t.length!==0&&t[0].start(!0);break}case Nl.ALL:{let t=this._getAnimationGroups();for(let i of t)i.start(!0);break}default:{P.Error(`Invalid animation start mode (${this._parent.animationStartMode})`);return}}}loadNodeAsync(t,i,r=()=>{}){let s=this._extensionsLoadNodeAsync(t,i,r);if(s)return s;if(i._babylonTransformNode)throw new Error(`${t}: Invalid recursive node hierarchy`);let o=new Array;this.logOpen(`${t} ${i.name||""}`);let a=u=>{if(n.AddPointerMetadata(u,t),n._LoadTransform(i,u),i.camera!=null){let h=se.Get(`${t}/camera`,this._gltf.cameras,i.camera);o.push(this.loadCameraAsync(`/cameras/${h.index}`,h,d=>{d.parent=u,this._babylonScene.useRightHandedSystem||(u.scaling.x=-1)}))}if(i.children)for(let h of i.children){let d=se.Get(`${t}/children/${h}`,this._gltf.nodes,h);o.push(this.loadNodeAsync(`/nodes/${d.index}`,d,f=>{f.parent=u}))}r(u)},l=i.mesh!=null,c=this._parent.loadSkins&&i.skin!=null;if(!l||c){let u=i.name||`node${i.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;let h=new vi(u,this._babylonScene);h._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i.mesh==null?i._babylonTransformNode=h:i._babylonTransformNodeForSkin=h,a(h)}if(l)if(c){let u=se.Get(`${t}/mesh`,this._gltf.meshes,i.mesh);o.push(this._loadMeshAsync(`/meshes/${u.index}`,i,u,h=>{let d=i._babylonTransformNodeForSkin;h.metadata=ex(d.metadata,h.metadata||{});let f=se.Get(`${t}/skin`,this._gltf.skins,i.skin);o.push(this._loadSkinAsync(`/skins/${f.index}`,i,f,p=>{this._forEachPrimitive(i,g=>{g.skeleton=p}),this._postSceneLoadActions.push(()=>{if(f.skeleton!=null){let g=se.Get(`/skins/${f.index}/skeleton`,this._gltf.nodes,f.skeleton).parent;i.index===g.index?h.parent=d.parent:h.parent=g._babylonTransformNode}else h.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:d,skinnedNode:h})})}))}))}else{let u=se.Get(`${t}/mesh`,this._gltf.meshes,i.mesh);o.push(this._loadMeshAsync(`/meshes/${u.index}`,i,u,a))}return this.logClose(),Promise.all(o).then(()=>(this._forEachPrimitive(i,u=>{let h=u;!h.isAnInstance&&h.geometry&&h.geometry.useBoundingInfoFromGeometry?u._updateBoundingInfo():u.refreshBoundingInfo(!0,!0)}),i._babylonTransformNode))}_loadMeshAsync(t,i,r,s){let o=r.primitives;if(!o||!o.length)throw new Error(`${t}: Primitives are missing`);o[0].index==null&&se.Assign(o);let a=new Array;this.logOpen(`${t} ${r.name||""}`);let l=i.name||`node${i.index}`;if(o.length===1){let c=r.primitives[0];a.push(this._loadMeshPrimitiveAsync(`${t}/primitives/${c.index}`,l,i,r,c,u=>{i._babylonTransformNode=u,i._primitiveBabylonMeshes=[u]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,i._babylonTransformNode=new vi(l,this._babylonScene),i._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i._primitiveBabylonMeshes=[];for(let c of o)a.push(this._loadMeshPrimitiveAsync(`${t}/primitives/${c.index}`,`${l}_primitive${c.index}`,i,r,c,u=>{u.parent=i._babylonTransformNode,i._primitiveBabylonMeshes.push(u)}))}return s(i._babylonTransformNode),this.logClose(),Promise.all(a).then(()=>i._babylonTransformNode)}_loadMeshPrimitiveAsync(t,i,r,s,o,a){let l=this._extensionsLoadMeshPrimitiveAsync(t,i,r,s,o,a);if(l)return l;this.logOpen(`${t}`);let c=this._disableInstancedMesh===0&&this._parent.createInstances&&r.skin==null&&!s.primitives[0].targets,u,h;if(c&&o._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,u=o._instanceData.babylonSourceMesh.createInstance(i),u._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,h=o._instanceData.promise;else{let d=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;let f=new E(i,this._babylonScene);if(f._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,f.sideOrientation=this._babylonScene.useRightHandedSystem?Re.CounterClockWiseSideOrientation:Re.ClockWiseSideOrientation,this._createMorphTargets(t,r,s,o,f),d.push(this._loadVertexDataAsync(t,o,f).then(p=>S(this,null,function*(){return yield this._loadMorphTargetsAsync(t,o,f,p).then(()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,p.applyToMesh(f),p._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)})}))),!this.parent.skipMaterials){let p=n._GetDrawMode(t,o.mode);if(o.material==null){let g=this._defaultBabylonMaterialData[p];g||(g=this._createDefaultMaterial("__GLTFLoader._default",p),this._parent.onMaterialLoadedObservable.notifyObservers(g),this._defaultBabylonMaterialData[p]=g),f.material=g}else{let g=se.Get(`${t}/material`,this._gltf.materials,o.material);d.push(this._loadMaterialAsync(`/materials/${g.index}`,g,f,p,_=>{f.material=_}))}}h=Promise.all(d),c&&(o._instanceData={babylonSourceMesh:f,promise:h}),u=f}return n.AddPointerMetadata(u,t),this._parent.onMeshLoadedObservable.notifyObservers(u),a(u),this.logClose(),h.then(()=>u)}_loadVertexDataAsync(t,i,r){let s=this._extensionsLoadVertexDataAsync(t,i,r);if(s)return s;let o=i.attributes;if(!o)throw new Error(`${t}: Attributes are missing`);let a=new Array,l=new Lt(r.name,this._babylonScene);if(i.indices==null)r.isUnIndexed=!0;else{let u=se.Get(`${t}/indices`,this._gltf.accessors,i.indices);a.push(this._loadIndicesAccessorAsync(`/accessors/${u.index}`,u).then(h=>{l.setIndices(h)}))}let c=(u,h,d)=>{if(o[u]==null)return;r._delayInfo=r._delayInfo||[],r._delayInfo.indexOf(h)===-1&&r._delayInfo.push(h);let f=se.Get(`${t}/attributes/${u}`,this._gltf.accessors,o[u]);a.push(this._loadVertexAccessorAsync(`/accessors/${f.index}`,f,h).then(p=>{if(p.getKind()===T.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!r.skeleton){let g=tx(f);g&&(l._boundingInfo=g,l.useBoundingInfoFromGeometry=!0)}l.setVerticesBuffer(p,f.count)})),h==T.MatricesIndicesExtraKind&&(r.numBoneInfluencers=8),d&&d(f)};return c("POSITION",T.PositionKind),c("NORMAL",T.NormalKind),c("TANGENT",T.TangentKind),c("TEXCOORD_0",T.UVKind),c("TEXCOORD_1",T.UV2Kind),c("TEXCOORD_2",T.UV3Kind),c("TEXCOORD_3",T.UV4Kind),c("TEXCOORD_4",T.UV5Kind),c("TEXCOORD_5",T.UV6Kind),c("JOINTS_0",T.MatricesIndicesKind),c("WEIGHTS_0",T.MatricesWeightsKind),c("JOINTS_1",T.MatricesIndicesExtraKind),c("WEIGHTS_1",T.MatricesWeightsExtraKind),c("COLOR_0",T.ColorKind,u=>{u.type==="VEC4"&&(r.hasVertexAlpha=!0)}),Promise.all(a).then(()=>l)}_createMorphTargets(t,i,r,s,o){if(!s.targets||!this._parent.loadMorphTargets)return;if(i._numMorphTargets==null)i._numMorphTargets=s.targets.length;else if(s.targets.length!==i._numMorphTargets)throw new Error(`${t}: Primitives do not have the same number of targets`);let a=r.extras?r.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,o.morphTargetManager=new Xu(this._babylonScene),o.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,o.morphTargetManager.areUpdatesFrozen=!0;for(let l=0;l<s.targets.length;l++){let c=i.weights?i.weights[l]:r.weights?r.weights[l]:0,u=a?a[l]:`morphTarget${l}`;o.morphTargetManager.addTarget(new Xo(u,c,o.getScene()))}}_loadMorphTargetsAsync(t,i,r,s){if(!i.targets||!this._parent.loadMorphTargets)return Promise.resolve();let o=new Array,a=r.morphTargetManager;for(let l=0;l<a.numTargets;l++){let c=a.getTarget(l);o.push(this._loadMorphTargetVertexDataAsync(`${t}/targets/${l}`,s,i.targets[l],c))}return Promise.all(o).then(()=>{a.areUpdatesFrozen=!1})}_loadMorphTargetVertexDataAsync(t,i,r,s){return S(this,null,function*(){let o=new Array,a=(l,c,u)=>{if(r[l]==null)return;let h=i.getVertexBuffer(c);if(!h)return;let d=se.Get(`${t}/${l}`,this._gltf.accessors,r[l]);o.push(this._loadFloatAccessorAsync(`/accessors/${d.index}`,d).then(f=>{u(h,f)}))};return a("POSITION",T.PositionKind,(l,c)=>{let u=new Float32Array(c.length);l.forEach(c.length,(h,d)=>{u[d]=c[d]+h}),s.setPositions(u)}),a("NORMAL",T.NormalKind,(l,c)=>{let u=new Float32Array(c.length);l.forEach(u.length,(h,d)=>{u[d]=c[d]+h}),s.setNormals(u)}),a("TANGENT",T.TangentKind,(l,c)=>{let u=new Float32Array(c.length/3*4),h=0;l.forEach(c.length/3*4,(d,f)=>{(f+1)%4!==0&&(u[h]=c[h]+d,h++)}),s.setTangents(u)}),a("TEXCOORD_0",T.UVKind,(l,c)=>{let u=new Float32Array(c.length);l.forEach(c.length,(h,d)=>{u[d]=c[d]+h}),s.setUVs(u)}),a("TEXCOORD_1",T.UV2Kind,(l,c)=>{let u=new Float32Array(c.length);l.forEach(c.length,(h,d)=>{u[d]=c[d]+h}),s.setUV2s(u)}),a("COLOR_0",T.ColorKind,(l,c)=>{let u=null,h=l.getSize();if(h===3){u=new Float32Array(c.length/3*4),l.forEach(c.length,(d,f)=>{let p=Math.floor(f/3),g=f%3;u[4*p+g]=c[3*p+g]+d});for(let d=0;d<c.length/3;++d)u[4*d+3]=1}else if(h===4)u=new Float32Array(c.length),l.forEach(c.length,(d,f)=>{u[f]=c[f]+d});else throw new Error(`${t}: Invalid number of components (${h}) for COLOR_0 attribute`);s.setColors(u)}),yield Promise.all(o).then(()=>{})})}static _LoadTransform(t,i){if(t.skin!=null)return;let r=m.Zero(),s=Q.Identity(),o=m.One();t.matrix?L.FromArray(t.matrix).decompose(o,s,r):(t.translation&&(r=m.FromArray(t.translation)),t.rotation&&(s=Q.FromArray(t.rotation)),t.scale&&(o=m.FromArray(t.scale))),i.position=r,i.rotationQuaternion=s,i.scaling=o}_loadSkinAsync(t,i,r,s){if(!this._parent.loadSkins)return Promise.resolve();let o=this._extensionsLoadSkinAsync(t,i,r);if(o)return o;if(r._data)return s(r._data.babylonSkeleton),r._data.promise;let a=`skeleton${r.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;let l=new Wr(r.name||a,a,this._babylonScene);l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(t,r,l);let c=this._loadSkinInverseBindMatricesDataAsync(t,r).then(u=>{this._updateBoneMatrices(l,u)});return r._data={babylonSkeleton:l,promise:c},s(l),c}_loadBones(t,i,r){if(i.skeleton==null||this._parent.alwaysComputeSkeletonRootNode){let o=this._findSkeletonRootNode(`${t}/joints`,i.joints);if(o)if(i.skeleton===void 0)i.skeleton=o.index;else{let a=(c,u)=>{for(;u.parent;u=u.parent)if(u.parent===c)return!0;return!1},l=se.Get(`${t}/skeleton`,this._gltf.nodes,i.skeleton);l!==o&&!a(l,o)&&(P.Warn(`${t}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),i.skeleton=o.index)}else P.Warn(`${t}: Failed to find common root`)}let s={};for(let o of i.joints){let a=se.Get(`${t}/joints/${o}`,this._gltf.nodes,o);this._loadBone(a,i,r,s)}}_findSkeletonRootNode(t,i){if(i.length===0)return null;let r={};for(let o of i){let a=[],l=se.Get(`${t}/${o}`,this._gltf.nodes,o);for(;l.index!==-1;)a.unshift(l),l=l.parent;r[o]=a}let s=null;for(let o=0;;++o){let a=r[i[0]];if(o>=a.length)return s;let l=a[o];for(let c=1;c<i.length;++c)if(a=r[i[c]],o>=a.length||l!==a[o])return s;s=l}}_loadBone(t,i,r,s){t._isJoint=!0;let o=s[t.index];if(o)return o;let a=null;t.index!==i.skeleton&&(t.parent&&t.parent.index!==-1?a=this._loadBone(t.parent,i,r,s):i.skeleton!==void 0&&P.Warn(`/skins/${i.index}/skeleton: Skeleton node is not a common root`));let l=i.joints.indexOf(t.index);return o=new Cr(t.name||`joint${t.index}`,r,a,this._getNodeMatrix(t),null,null,l),s[t.index]=o,this._postSceneLoadActions.push(()=>{o.linkTransformNode(t._babylonTransformNode)}),o}_loadSkinInverseBindMatricesDataAsync(t,i){if(i.inverseBindMatrices==null)return Promise.resolve(null);let r=se.Get(`${t}/inverseBindMatrices`,this._gltf.accessors,i.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${r.index}`,r)}_updateBoneMatrices(t,i){for(let r of t.bones){let s=L.Identity(),o=r._index;i&&o!==-1&&(L.FromArrayToRef(i,o*16,s),s.invertToRef(s));let a=r.getParent();a&&s.multiplyToRef(a.getAbsoluteInverseBindMatrix(),s),r.updateMatrix(s,!1,!1),r._updateAbsoluteBindMatrices(void 0,!1)}}_getNodeMatrix(t){return t.matrix?L.FromArray(t.matrix):L.Compose(t.scale?m.FromArray(t.scale):m.One(),t.rotation?Q.FromArray(t.rotation):Q.Identity(),t.translation?m.FromArray(t.translation):m.Zero())}loadCameraAsync(t,i,r=()=>{}){let s=this._extensionsLoadCameraAsync(t,i,r);if(s)return s;let o=new Array;this.logOpen(`${t} ${i.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;let a=new Bt(i.name||`camera${i.index}`,m.Zero(),this._babylonScene,!1);switch(a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i._babylonCamera=a,a.setTarget(new m(0,0,-1)),i.type){case"perspective":{let l=i.perspective;if(!l)throw new Error(`${t}: Camera perspective properties are missing`);a.fov=l.yfov,a.minZ=l.znear,a.maxZ=l.zfar||0;break}case"orthographic":{if(!i.orthographic)throw new Error(`${t}: Camera orthographic properties are missing`);a.mode=Fe.ORTHOGRAPHIC_CAMERA,a.orthoLeft=-i.orthographic.xmag,a.orthoRight=i.orthographic.xmag,a.orthoBottom=-i.orthographic.ymag,a.orthoTop=i.orthographic.ymag,a.minZ=i.orthographic.znear,a.maxZ=i.orthographic.zfar;break}default:throw new Error(`${t}: Invalid camera type (${i.type})`)}return n.AddPointerMetadata(a,t),this._parent.onCameraLoadedObservable.notifyObservers(a),r(a),this.logClose(),Promise.all(o).then(()=>a)}_loadAnimationsAsync(){this._parent._startPerformanceCounter("Load animations");let t=this._gltf.animations;if(!t)return Promise.resolve();let i=new Array;for(let r=0;r<t.length;r++){let s=t[r];i.push(this.loadAnimationAsync(`/animations/${s.index}`,s).then(o=>{o.targetedAnimations.length===0&&o.dispose()}))}return Promise.all(i).then(()=>{this._parent._endPerformanceCounter("Load animations")})}loadAnimationAsync(t,i){this._parent._startPerformanceCounter("Load animation");let r=this._extensionsLoadAnimationAsync(t,i);return r||ck.value.then(({AnimationGroup:s})=>{this._babylonScene._blockEntityCollection=!!this._assetContainer;let o=new s(i.name||`animation${i.index}`,this._babylonScene);o._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i._babylonAnimationGroup=o;let a=new Array;se.Assign(i.channels),se.Assign(i.samplers);for(let l of i.channels)a.push(this._loadAnimationChannelAsync(`${t}/channels/${l.index}`,t,i,l,(c,u)=>{c.animations=c.animations||[],c.animations.push(u),o.addTargetedAnimation(u,c)}));return this._parent._endPerformanceCounter("Load animation"),Promise.all(a).then(()=>(o.normalize(0),o))})}_loadAnimationChannelAsync(t,i,r,s,o){let a=this._extensionsLoadAnimationChannelAsync(t,i,r,s,o);if(a)return a;if(s.target.node==null)return Promise.resolve();let l=se.Get(`${t}/target/node`,this._gltf.nodes,s.target.node),c=s.target.path,u=c==="weights";return u&&!l._numMorphTargets||!u&&!l._babylonTransformNode||!this._parent.loadNodeAnimations&&!u&&!l._isJoint?Promise.resolve():uk.value.then(()=>{let h;switch(c){case"translation":{h=Ec("/nodes/{}/translation")?.interpolation;break}case"rotation":{h=Ec("/nodes/{}/rotation")?.interpolation;break}case"scale":{h=Ec("/nodes/{}/scale")?.interpolation;break}case"weights":{h=Ec("/nodes/{}/weights")?.interpolation;break}default:throw new Error(`${t}/target/path: Invalid value (${s.target.path})`)}if(!h)throw new Error(`${t}/target/path: Could not find interpolation properties for target path (${s.target.path})`);let d={object:l,info:h};return this._loadAnimationChannelFromTargetInfoAsync(t,i,r,s,d,o)})}_loadAnimationChannelFromTargetInfoAsync(t,i,r,s,o,a){let l=this.parent.targetFps,c=1/l,u=se.Get(`${t}/sampler`,r.samplers,s.sampler);return this._loadAnimationSamplerAsync(`${i}/samplers/${s.sampler}`,u).then(h=>{let d=0,f=o.object,p=o.info;for(let g of p){let _=g.getStride(f),y=h.input,b=h.output,A=new Array(y.length),I=0;switch(h.interpolation){case"STEP":{for(let v=0;v<y.length;v++){let x=g.getValue(f,b,I,1);I+=_,A[v]={frame:y[v]*l,value:x,interpolation:1}}break}case"CUBICSPLINE":{for(let v=0;v<y.length;v++){let x=g.getValue(f,b,I,c);I+=_;let C=g.getValue(f,b,I,1);I+=_;let R=g.getValue(f,b,I,c);I+=_,A[v]={frame:y[v]*l,inTangent:x,value:C,outTangent:R}}break}case"LINEAR":{for(let v=0;v<y.length;v++){let x=g.getValue(f,b,I,1);I+=_,A[v]={frame:y[v]*l,value:x}}break}}if(I>0){let v=`${r.name||`animation${r.index}`}_channel${s.index}_${d}`,x=g.buildAnimations(f,v,l,A);for(let C of x)d++,a(C.babylonAnimatable,C.babylonAnimation)}}})}_loadAnimationSamplerAsync(t,i){if(i._data)return i._data;let r=i.interpolation||"LINEAR";switch(r){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${t}/interpolation: Invalid value (${i.interpolation})`)}let s=se.Get(`${t}/input`,this._gltf.accessors,i.input),o=se.Get(`${t}/output`,this._gltf.accessors,i.output);return i._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${s.index}`,s),this._loadFloatAccessorAsync(`/accessors/${o.index}`,o)]).then(([a,l])=>({input:a,interpolation:r,output:l})),i._data}loadBufferAsync(t,i,r,s){let o=this._extensionsLoadBufferAsync(t,i,r,s);if(o)return o;if(!i._data)if(i.uri)i._data=this.loadUriAsync(`${t}/uri`,i,i.uri);else{if(!this._bin)throw new Error(`${t}: Uri is missing or the binary glTF is missing its binary chunk`);i._data=this._bin.readAsync(0,i.byteLength)}return i._data.then(a=>{try{return new Uint8Array(a.buffer,a.byteOffset+r,s)}catch(l){throw new Error(`${t}: ${l.message}`)}})}loadBufferViewAsync(t,i){let r=this._extensionsLoadBufferViewAsync(t,i);if(r)return r;if(i._data)return i._data;let s=se.Get(`${t}/buffer`,this._gltf.buffers,i.buffer);return i._data=this.loadBufferAsync(`/buffers/${s.index}`,s,i.byteOffset||0,i.byteLength),i._data}_loadAccessorAsync(t,i,r){if(i._data)return i._data;let s=n._GetNumComponents(t,i.type),o=s*T.GetTypeByteLength(i.componentType),a=s*i.count;if(i.bufferView==null)i._data=Promise.resolve(new r(a));else{let l=se.Get(`${t}/bufferView`,this._gltf.bufferViews,i.bufferView);i._data=this.loadBufferViewAsync(`/bufferViews/${l.index}`,l).then(c=>{if(i.componentType===5126&&!i.normalized&&(!l.byteStride||l.byteStride===o))return n._GetTypedArray(t,i.componentType,c,i.byteOffset,a);{let u=new r(a);return T.ForEach(c,i.byteOffset||0,l.byteStride||o,s,i.componentType,u.length,i.normalized||!1,(h,d)=>{u[d]=h}),u}})}if(i.sparse){let l=i.sparse;i._data=i._data.then(c=>{let u=c,h=se.Get(`${t}/sparse/indices/bufferView`,this._gltf.bufferViews,l.indices.bufferView),d=se.Get(`${t}/sparse/values/bufferView`,this._gltf.bufferViews,l.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${h.index}`,h),this.loadBufferViewAsync(`/bufferViews/${d.index}`,d)]).then(([f,p])=>{let g=n._GetTypedArray(`${t}/sparse/indices`,l.indices.componentType,f,l.indices.byteOffset,l.count),_=s*l.count,y;if(i.componentType===5126&&!i.normalized)y=n._GetTypedArray(`${t}/sparse/values`,i.componentType,p,l.values.byteOffset,_);else{let A=n._GetTypedArray(`${t}/sparse/values`,i.componentType,p,l.values.byteOffset,_);y=new r(_),T.ForEach(A,0,o,s,i.componentType,y.length,i.normalized||!1,(I,v)=>{y[v]=I})}let b=0;for(let A=0;A<g.length;A++){let I=g[A]*s;for(let v=0;v<s;v++)u[I++]=y[b++]}return u})})}return i._data}_loadFloatAccessorAsync(t,i){return this._loadAccessorAsync(t,i,Float32Array)}_loadIndicesAccessorAsync(t,i){if(i.type!=="SCALAR")throw new Error(`${t}/type: Invalid value ${i.type}`);if(i.componentType!==5121&&i.componentType!==5123&&i.componentType!==5125)throw new Error(`${t}/componentType: Invalid value ${i.componentType}`);if(i._data)return i._data;if(i.sparse){let r=n._GetTypedArrayConstructor(`${t}/componentType`,i.componentType);i._data=this._loadAccessorAsync(t,i,r)}else{let r=se.Get(`${t}/bufferView`,this._gltf.bufferViews,i.bufferView);i._data=this.loadBufferViewAsync(`/bufferViews/${r.index}`,r).then(s=>n._GetTypedArray(t,i.componentType,s,i.byteOffset,i.count))}return i._data}_loadVertexBufferViewAsync(t){if(t._babylonBuffer)return t._babylonBuffer;let i=this._babylonScene.getEngine();return t._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${t.index}`,t).then(r=>new ei(i,r,!1)),t._babylonBuffer}_loadVertexAccessorAsync(t,i,r){if(i._babylonVertexBuffer?.[r])return i._babylonVertexBuffer[r];i._babylonVertexBuffer||(i._babylonVertexBuffer={});let s=this._babylonScene.getEngine();if(i.sparse||i.bufferView==null)i._babylonVertexBuffer[r]=this._loadFloatAccessorAsync(t,i).then(o=>new T(s,o,r,!1));else{let o=se.Get(`${t}/bufferView`,this._gltf.bufferViews,i.bufferView);i._babylonVertexBuffer[r]=this._loadVertexBufferViewAsync(o).then(a=>{let l=n._GetNumComponents(t,i.type);return new T(s,a,r,!1,void 0,o.byteStride,void 0,i.byteOffset,l,i.componentType,i.normalized,!0,void 0,!0)})}return i._babylonVertexBuffer[r]}_loadMaterialMetallicRoughnessPropertiesAsync(t,i,r){let s=new Array,o=this._getOrCreateMaterialAdapter(r);return i&&(i.baseColorFactor?(o.baseColor=U.FromArray(i.baseColorFactor),o.geometryOpacity=i.baseColorFactor[3]):o.baseColor=U.White(),o.baseMetalness=i.metallicFactor==null?1:i.metallicFactor,o.specularRoughness=i.roughnessFactor==null?1:i.roughnessFactor,i.baseColorTexture&&s.push(this.loadTextureInfoAsync(`${t}/baseColorTexture`,i.baseColorTexture,a=>{a.name=`${r.name} (Base Color)`,o.baseColorTexture=a})),i.metallicRoughnessTexture&&(i.metallicRoughnessTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${t}/metallicRoughnessTexture`,i.metallicRoughnessTexture,a=>{a.name=`${r.name} (Metallic Roughness)`,o.baseMetalnessTexture=a,o.specularRoughnessTexture=a})),o.useRoughnessFromMetallicTextureGreen=!0,o.useMetallicFromMetallicTextureBlue=!0)),Promise.all(s).then(()=>{})}_loadMaterialAsync(t,i,r,s,o=()=>{}){let a=this._extensionsLoadMaterialAsync(t,i,r,s,o);if(a)return a;i._data=i._data||{};let l=i._data[s];if(!l){this.logOpen(`${t} ${i.name||""}`);let c=this.createMaterial(t,i,s);l={babylonMaterial:c,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(t,i,c)},i._data[s]=l,n.AddPointerMetadata(c,t),this._parent.onMaterialLoadedObservable.notifyObservers(c),this.logClose()}return r&&(l.babylonMeshes.push(r),r.onDisposeObservable.addOnce(()=>{let c=l.babylonMeshes.indexOf(r);c!==-1&&l.babylonMeshes.splice(c,1)})),o(l.babylonMaterial),l.promise.then(()=>l.babylonMaterial)}_createDefaultMaterial(t,i){if(!this._pbrMaterialImpl)throw new Error("PBR Material class not loaded");this._babylonScene._blockEntityCollection=!!this._assetContainer;let r=new this._pbrMaterialImpl.materialClass(t,this._babylonScene);r._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,r.fillMode=i,r.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_OPAQUE;let s=this._getOrCreateMaterialAdapter(r);return s.transparencyAsAlphaCoverage=this._parent.transparencyAsCoverage,s.baseMetalness=1,s.specularRoughness=1,r}createMaterial(t,i,r){let s=this._extensionsCreateMaterial(t,i,r);if(s)return s;let o=i.name||`material${i.index}`;return this._createDefaultMaterial(o,r)}loadMaterialPropertiesAsync(t,i,r){let s=this._extensionsLoadMaterialPropertiesAsync(t,i,r);if(s)return s;let o=new Array;return o.push(this.loadMaterialBasePropertiesAsync(t,i,r)),i.pbrMetallicRoughness&&o.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${t}/pbrMetallicRoughness`,i.pbrMetallicRoughness,r)),this.loadMaterialAlphaProperties(t,i,r),Promise.all(o).then(()=>{})}loadMaterialBasePropertiesAsync(t,i,r){let s=new Array,o=this._getOrCreateMaterialAdapter(r);o.emissionColor=i.emissiveFactor?U.FromArray(i.emissiveFactor):new U(0,0,0),i.doubleSided&&(o.backFaceCulling=!1,o.twoSidedLighting=!0),i.normalTexture&&(i.normalTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${t}/normalTexture`,i.normalTexture,u=>{u.name=`${r.name} (Normal)`,o.geometryNormalTexture=u,i.normalTexture?.scale!=null&&(u.level=i.normalTexture.scale)})),o.setNormalMapInversions(!this._babylonScene.useRightHandedSystem,this._babylonScene.useRightHandedSystem));let a,l=1,c;return i.occlusionTexture&&(i.occlusionTexture.nonColorData=!0,s.push(this.loadTextureInfoAsync(`${t}/occlusionTexture`,i.occlusionTexture,u=>{u.name=`${r.name} (Occlusion)`,a=u})),i.occlusionTexture.strength!=null&&(l=i.occlusionTexture.strength)),i.emissiveTexture&&s.push(this.loadTextureInfoAsync(`${t}/emissiveTexture`,i.emissiveTexture,u=>{u.name=`${r.name} (Emissive)`,c=u})),Promise.all(s).then(()=>{a&&(o.ambientOcclusionTexture=a,o.ambientOcclusionTextureStrength=l),c&&(o.emissionColorTexture=c)})}loadMaterialAlphaProperties(t,i,r){if(!this._pbrMaterialImpl)throw new Error(`${t}: Material type not supported`);let s=this._getOrCreateMaterialAdapter(r),o=s.baseColorTexture;switch(i.alphaMode||"OPAQUE"){case"OPAQUE":{r.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_OPAQUE,r.alpha=1;break}case"MASK":{r.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_ALPHATEST,s.alphaCutOff=i.alphaCutoff==null?.5:i.alphaCutoff,o&&(o.hasAlpha=!0);break}case"BLEND":{r.transparencyMode=this._pbrMaterialImpl.materialClass.MATERIAL_ALPHABLEND,o&&(o.hasAlpha=!0,s.useAlphaFromBaseColorTexture=!0);break}default:throw new Error(`${t}/alphaMode: Invalid value (${i.alphaMode})`)}}loadTextureInfoAsync(t,i,r=()=>{}){let s=this._extensionsLoadTextureInfoAsync(t,i,r);if(s)return s;if(this.logOpen(`${t}`),i.texCoord>=6)throw new Error(`${t}/texCoord: Invalid value (${i.texCoord})`);let o=se.Get(`${t}/index`,this._gltf.textures,i.index);o._textureInfo=i;let a=this._loadTextureAsync(`/textures/${i.index}`,o,l=>{l.coordinatesIndex=i.texCoord||0,n.AddPointerMetadata(l,t),this._parent.onTextureLoadedObservable.notifyObservers(l),r(l)});return this.logClose(),a}_loadTextureAsync(t,i,r=()=>{}){let s=this._extensionsLoadTextureAsync(t,i,r);if(s)return s;this.logOpen(`${t} ${i.name||""}`);let o=i.sampler==null?n.DefaultSampler:se.Get(`${t}/sampler`,this._gltf.samplers,i.sampler),a=se.Get(`${t}/source`,this._gltf.images,i.source),l=this._createTextureAsync(t,o,a,r,void 0,!i._textureInfo.nonColorData);return this.logClose(),l}_createTextureAsync(t,i,r,s=()=>{},o,a){let l=this._loadSampler(`/samplers/${i.index}`,i),c=new Array,u=new _s;this._babylonScene._blockEntityCollection=!!this._assetContainer;let h={noMipmap:l.noMipMaps,invertY:!1,samplingMode:l.samplingMode,onLoad:()=>{this._disposed||u.resolve()},onError:(f,p)=>{this._disposed||u.reject(new Error(`${t}: ${p&&p.message?p.message:f||"Failed to load texture"}`))},mimeType:r.mimeType??u0(r.uri??""),loaderOptions:o,useSRGBBuffer:!!a&&this._parent.useSRGBBuffers},d=new Z(null,this._babylonScene,h);return d._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,c.push(u.promise),c.push(this.loadImageAsync(`/images/${r.index}`,r).then(f=>{let p=r.uri||`${this._fileName}#image${r.index}`,g=`data:${this._uniqueRootUrl}${p}`;d.updateURL(g,f);let _=d.getInternalTexture();_&&(_.label=r.name)})),d.wrapU=l.wrapU,d.wrapV=l.wrapV,s(d),this._parent.useGltfTextureNames&&(d.name=r.name||r.uri||`image${r.index}`),Promise.all(c).then(()=>d)}_loadSampler(t,i){return i._data||(i._data={noMipMaps:i.minFilter===9728||i.minFilter===9729,samplingMode:n._GetTextureSamplingMode(t,i),wrapU:n._GetTextureWrapMode(`${t}/wrapS`,i.wrapS),wrapV:n._GetTextureWrapMode(`${t}/wrapT`,i.wrapT)}),i._data}loadImageAsync(t,i){if(!i._data){if(this.logOpen(`${t} ${i.name||""}`),i.uri)i._data=this.loadUriAsync(`${t}/uri`,i,i.uri);else{let r=se.Get(`${t}/bufferView`,this._gltf.bufferViews,i.bufferView);i._data=this.loadBufferViewAsync(`/bufferViews/${r.index}`,r)}this.logClose()}return i._data}loadUriAsync(t,i,r){let s=this._extensionsLoadUriAsync(t,i,r);if(s)return s;if(!n._ValidateUri(r))throw new Error(`${t}: '${r}' is invalid`);if(Qh(r)){let o=new Uint8Array(Jh(r));return this.log(`${t}: Decoded ${r.substring(0,64)}... (${o.length} bytes)`),Promise.resolve(o)}return this.log(`${t}: Loading ${r}`),this._parent.preprocessUrlAsync(this._rootUrl+r).then(o=>new Promise((a,l)=>{this._parent._loadFile(this._babylonScene,o,c=>{this._disposed||(this.log(`${t}: Loaded ${r} (${c.byteLength} bytes)`),a(new Uint8Array(c)))},!0,c=>{l(new c0(`${t}: Failed to load '${r}'${c?": "+c.status+" "+c.statusText:""}`,c))})}))}static AddPointerMetadata(t,i){t.metadata=t.metadata||{};let r=t._internalMetadata=t._internalMetadata||{},s=r.gltf=r.gltf||{};(s.pointers=s.pointers||[]).push(i)}static _GetTextureWrapMode(t,i){switch(i=i??10497,i){case 33071:return Z.CLAMP_ADDRESSMODE;case 33648:return Z.MIRROR_ADDRESSMODE;case 10497:return Z.WRAP_ADDRESSMODE;default:return P.Warn(`${t}: Invalid value (${i})`),Z.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(t,i){let r=i.magFilter==null?9729:i.magFilter,s=i.minFilter==null?9987:i.minFilter;if(r===9729)switch(s){case 9728:return Z.LINEAR_NEAREST;case 9729:return Z.LINEAR_LINEAR;case 9984:return Z.LINEAR_NEAREST_MIPNEAREST;case 9985:return Z.LINEAR_LINEAR_MIPNEAREST;case 9986:return Z.LINEAR_NEAREST_MIPLINEAR;case 9987:return Z.LINEAR_LINEAR_MIPLINEAR;default:return P.Warn(`${t}/minFilter: Invalid value (${s})`),Z.LINEAR_LINEAR_MIPLINEAR}else switch(r!==9728&&P.Warn(`${t}/magFilter: Invalid value (${r})`),s){case 9728:return Z.NEAREST_NEAREST;case 9729:return Z.NEAREST_LINEAR;case 9984:return Z.NEAREST_NEAREST_MIPNEAREST;case 9985:return Z.NEAREST_LINEAR_MIPNEAREST;case 9986:return Z.NEAREST_NEAREST_MIPLINEAR;case 9987:return Z.NEAREST_LINEAR_MIPLINEAR;default:return P.Warn(`${t}/minFilter: Invalid value (${s})`),Z.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(t,i){try{return zT(i)}catch(r){throw new Error(`${t}: ${r.message}`)}}static _GetTypedArray(t,i,r,s,o){let a=r.buffer;s=r.byteOffset+(s||0);let l=n._GetTypedArrayConstructor(`${t}/componentType`,i),c=T.GetTypeByteLength(i);return s%c!==0?(P.Warn(`${t}: Copying buffer as byte offset (${s}) is not a multiple of component type byte length (${c})`),new l(a.slice(s,s+o*c),0)):new l(a,s,o)}static _GetNumComponents(t,i){switch(i){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${t}: Invalid type (${i})`)}static _ValidateUri(t){return z.IsBase64(t)||t.indexOf("..")===-1}static _GetDrawMode(t,i){switch(i==null&&(i=4),i){case 0:return Re.PointListDrawMode;case 1:return Re.LineListDrawMode;case 2:return Re.LineLoopDrawMode;case 3:return Re.LineStripDrawMode;case 4:return Re.TriangleFillMode;case 5:return Re.TriangleStripDrawMode;case 6:return Re.TriangleFanDrawMode}throw new Error(`${t}: Invalid mesh primitive mode (${i})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");let t=new Array;if(this._gltf.materials){for(let i of this._gltf.materials)if(i._data)for(let r in i._data){let s=i._data[r];for(let o of s.babylonMeshes){o.computeWorldMatrix(!0);let a=s.babylonMaterial;t.push(a.forceCompilationAsync(o)),t.push(a.forceCompilationAsync(o,{useInstances:!0})),this._parent.useClipPlane&&(t.push(a.forceCompilationAsync(o,{clipPlane:!0})),t.push(a.forceCompilationAsync(o,{clipPlane:!0,useInstances:!0})))}}}return Promise.all(t).then(()=>{this._parent._endPerformanceCounter("Compile materials")})}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");let t=new Array,i=this._babylonScene.lights;for(let r of i){let s=r.getShadowGenerator();s&&t.push(s.forceCompilationAsync())}return Promise.all(t).then(()=>{this._parent._endPerformanceCounter("Compile shadow generators")})}_forEachExtensions(t){for(let i of this._extensions)i.enabled&&t(i)}_applyExtensions(t,i,r){for(let s of this._extensions)if(s.enabled){let o=`${s.name}.${i}`,a=t;a._activeLoaderExtensionFunctions=a._activeLoaderExtensionFunctions||{};let l=a._activeLoaderExtensionFunctions;if(!l[o]){l[o]=!0;try{let c=r(s);if(c)return c}finally{delete l[o]}}}return null}_extensionsOnLoading(){this._forEachExtensions(t=>t.onLoading&&t.onLoading())}_extensionsOnReady(){this._forEachExtensions(t=>t.onReady&&t.onReady())}_extensionsLoadSceneAsync(t,i){return this._applyExtensions(i,"loadScene",r=>r.loadSceneAsync&&r.loadSceneAsync(t,i))}_extensionsLoadNodeAsync(t,i,r){return this._applyExtensions(i,"loadNode",s=>s.loadNodeAsync&&s.loadNodeAsync(t,i,r))}_extensionsLoadCameraAsync(t,i,r){return this._applyExtensions(i,"loadCamera",s=>s.loadCameraAsync&&s.loadCameraAsync(t,i,r))}_extensionsLoadVertexDataAsync(t,i,r){return this._applyExtensions(i,"loadVertexData",s=>s._loadVertexDataAsync&&s._loadVertexDataAsync(t,i,r))}_extensionsLoadMeshPrimitiveAsync(t,i,r,s,o,a){return this._applyExtensions(o,"loadMeshPrimitive",l=>l._loadMeshPrimitiveAsync&&l._loadMeshPrimitiveAsync(t,i,r,s,o,a))}_extensionsLoadMaterialAsync(t,i,r,s,o){return this._applyExtensions(i,"loadMaterial",a=>a._loadMaterialAsync&&a._loadMaterialAsync(t,i,r,s,o))}_extensionsCreateMaterial(t,i,r){return this._applyExtensions(i,"createMaterial",s=>s.createMaterial&&s.createMaterial(t,i,r))}_extensionsLoadMaterialPropertiesAsync(t,i,r){return this._applyExtensions(i,"loadMaterialProperties",s=>s.loadMaterialPropertiesAsync&&s.loadMaterialPropertiesAsync(t,i,r))}_extensionsLoadTextureInfoAsync(t,i,r){return this._applyExtensions(i,"loadTextureInfo",s=>s.loadTextureInfoAsync&&s.loadTextureInfoAsync(t,i,r))}_extensionsLoadTextureAsync(t,i,r){return this._applyExtensions(i,"loadTexture",s=>s._loadTextureAsync&&s._loadTextureAsync(t,i,r))}_extensionsLoadAnimationAsync(t,i){return this._applyExtensions(i,"loadAnimation",r=>r.loadAnimationAsync&&r.loadAnimationAsync(t,i))}_extensionsLoadAnimationChannelAsync(t,i,r,s,o){return this._applyExtensions(r,"loadAnimationChannel",a=>a._loadAnimationChannelAsync&&a._loadAnimationChannelAsync(t,i,r,s,o))}_extensionsLoadSkinAsync(t,i,r){return this._applyExtensions(r,"loadSkin",s=>s._loadSkinAsync&&s._loadSkinAsync(t,i,r))}_extensionsLoadUriAsync(t,i,r){return this._applyExtensions(i,"loadUri",s=>s._loadUriAsync&&s._loadUriAsync(t,i,r))}_extensionsLoadBufferViewAsync(t,i){return this._applyExtensions(i,"loadBufferView",r=>r.loadBufferViewAsync&&r.loadBufferViewAsync(t,i))}_extensionsLoadBufferAsync(t,i,r,s){return this._applyExtensions(i,"loadBuffer",o=>o.loadBufferAsync&&o.loadBufferAsync(t,i,r,s))}static LoadExtensionAsync(t,i,r,s){if(!i.extensions)return null;let a=i.extensions[r];return a?s(`${t}/extensions/${r}`,a):null}static LoadExtraAsync(t,i,r,s){if(!i.extras)return null;let a=i.extras[r];return a?s(`${t}/extras/${r}`,a):null}isExtensionUsed(t){return!!this._gltf.extensionsUsed&&this._gltf.extensionsUsed.indexOf(t)!==-1}logOpen(t){this._parent._logOpen(t)}logClose(){this._parent._logClose()}log(t){this._parent._log(t)}startPerformanceCounter(t){this._parent._startPerformanceCounter(t)}endPerformanceCounter(t){this._parent._endPerformanceCounter(t)}}return n.DefaultSampler={index:-1},n})();Hr._CreateGLTF2Loader=n=>new ge(n);var Jw=.8,Gt=class n extends _r{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;let t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(L.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let r="";for(let s of e)r+=s;return new n(r,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,r=!0){let s=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;let o=new n(e,t,null,!1,null,null,null,void 0,!0,i,r);return t.useDelayedTextureLoading=s,o}constructor(e,t,i=null,r=!1,s=null,o=null,a=null,l=5,c=!1,u=null,h=!1,d=Jw,f=0,p,g){super(t),this.onLoadObservable=new F,this.boundingBoxPosition=m.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this._textureMatrixRefraction=new L,this._buffer=null,this.name=e,this.url=e,this._noMipmap=r,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=L.Identity(),this.coordinatesMode=Z.CUBIC_MODE;let _=null,y=null;i!==null&&!Array.isArray(i)?(_=i.extensions??null,this._noMipmap=i.noMipmap??!1,s=i.files??null,y=i.buffer??null,this._format=i.format??5,c=i.prefiltered??!1,u=i.forcedExtension??null,this._createPolynomials=i.createPolynomials??!1,this._lodScale=i.lodScale??Jw,this._lodOffset=i.lodOffset??0,this._loaderOptions=i.loaderOptions,this._useSRGBBuffer=i.useSRGBBuffer,o=i.onLoad??null,a=i.onError??null):(this._noMipmap=r,this._format=l,this._createPolynomials=h,_=i,this._loaderOptions=p,this._useSRGBBuffer=g,this._lodScale=d,this._lodOffset=f),!(!e&&!s)&&this.updateURL(e,u,o,c,a,_,this.getScene()?.useDelayedTextureLoading,s,y)}getClassName(){return"CubeTexture"}updateURL(e,t=null,i=null,r=!1,s=null,o=null,a=!1,l=null,c=null){(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,t&&(this._forcedExtension=t);let u=e.lastIndexOf("."),h=t||(u>-1?e.substring(u).toLowerCase():""),d=h.indexOf(".dds")===0,f=h.indexOf(".env")===0,p=h.indexOf(".basis")===0;if(f?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=r,r&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),l)this._files=l;else if(!p&&!f&&!d&&!o&&(o=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,o){for(let g=0;g<o.length;g++)this._files.push(e+o[g]);this._extensions=o}this._buffer=c,a?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=s):this._loadTexture(i,s)}delayLoad(e){this.delayLoadState===4&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){if(e.updateFlag===this._textureMatrix.updateFlag||(e.isIdentity()!==this._textureMatrix.isIdentity()&&this.getScene()?.markAllMaterialsAsDirty(1,s=>s.getActiveTextures().indexOf(this)!==-1),this._textureMatrix=e,!this.getScene()?.useRightHandedSystem))return;let t=k.Vector3[0],i=k.Quaternion[0],r=k.Vector3[1];this._textureMatrix.decompose(t,i,r),i.z*=-1,i.w*=-1,L.ComposeToRef(t,i,r,this._textureMatrixRefraction)}getRefractionTextureMatrix(){return this.getScene()?.useRightHandedSystem?this._textureMatrixRefraction:this._textureMatrix}_loadTexture(e=null,t=null){let i=this.getScene(),r=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);let s=()=>{this.onLoadObservable.notifyObservers(this),r&&(r.dispose(),this.getScene()?.markAllMaterialsAsDirty(1)),e&&e()},o=(a,l)=>{this._loadingError=!0,this._errorObject={message:a,exception:l},t&&t(a,l),Z.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?z.SetImmediate(()=>s()):this._texture.onLoadedObservable.add(()=>s()):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,i,this._lodScale,this._lodOffset,e,o,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,i,this._files,this._noMipmap,e,o,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer,this._buffer),this._texture?.onLoadedObservable.add(()=>this.onLoadObservable.notifyObservers(this)))}static Parse(e,t,i){let r=je.Parse(()=>{let s=!1;return e.prefiltered&&(s=e.prefiltered),new n(i+(e.url??e.name),t,e.extensions,!1,e.files||null,null,null,void 0,s,e.forcedExtension)},e,t);if(e.boundingBoxPosition&&(r.boundingBoxPosition=m.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(r.boundingBoxSize=m.FromArray(e.boundingBoxSize)),e.animations)for(let s=0;s<e.animations.length;s++){let o=e.animations[s],a=vt("BABYLON.Animation");a&&r.animations.push(a.Parse(o))}return r}clone(){let e=0,t=je.Clone(()=>{let i=new n(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=i.uniqueId,i},this);return t.uniqueId=e,t}};w([B()],Gt.prototype,"url",void 0);w([Jt()],Gt.prototype,"boundingBoxPosition",void 0);w([Jt()],Gt.prototype,"boundingBoxSize",null);w([B("rotationY")],Gt.prototype,"rotationY",null);w([B("files")],Gt.prototype,"_files",void 0);w([B("forcedExtension")],Gt.prototype,"_forcedExtension",void 0);w([B("extensions")],Gt.prototype,"_extensions",void 0);w([Yg("textureMatrix")],Gt.prototype,"_textureMatrix",void 0);w([Yg("textureMatrixRefraction")],Gt.prototype,"_textureMatrixRefraction",void 0);Z._CubeTextureParser=Gt.Parse;le("BABYLON.CubeTexture",Gt);var Gp=class n extends Gt{constructor(e,t,i,r=5,s=0,o=!1,a=!1,l=3,c=null){super("",e),this._texture=e.getEngine().createRawCubeTexture(t,i,r,s,o,a,l,c)}update(e,t,i,r,s=null){this._texture.getEngine().updateRawCubeTexture(this._texture,e,t,i,r,s)}updateRGBDAsync(e,t=null,i=.8,r=0){return o0(this._texture,e,t,i,r).then(()=>{})}clone(){return je.Clone(()=>{let e=this.getScene(),t=this._texture,i=new n(e,t._bufferViewArray,t.width,t.format,t.type,t.generateMipMaps,t.invertY,t.samplingMode,t._compression);return t.source===13&&i.updateRGBDAsync(t._bufferViewArrayArray,t._sphericalPolynomial,t._lodGenerationScale,t._lodGenerationOffset),i},this)}};var Up="EXT_lights_image_based",ix=class{constructor(e){this.name=Up,this._loader=e,this.enabled=this._loader.isExtensionUsed(Up)}dispose(){this._loader=null,delete this._lights}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._lights=t.lights}}loadSceneAsync(e,t){return ge.LoadExtensionAsync(e,t,this.name,(i,r)=>S(this,null,function*(){this._loader._allMaterialsDirtyRequired=!0;let s=new Array;s.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(`${i}`);let o=se.Get(`${i}/light`,this._lights,r.light);return s.push(this._loadLightAsync(`/extensions/${this.name}/lights/${r.light}`,o).then(a=>{this._loader.babylonScene.environmentTexture=a})),this._loader.logClose(),yield Promise.all(s).then(()=>{})}))}_loadLightAsync(e,t){if(!t._loaded){let i=new Array;this._loader.logOpen(`${e}`);let r=new Array(t.specularImages.length);for(let s=0;s<t.specularImages.length;s++){let o=t.specularImages[s];r[s]=new Array(o.length);for(let a=0;a<o.length;a++){let l=`${e}/specularImages/${s}/${a}`;this._loader.logOpen(`${l}`);let c=o[a],u=se.Get(l,this._loader.gltf.images,c);i.push(this._loader.loadImageAsync(`/images/${c}`,u).then(h=>{r[s][a]=h})),this._loader.logClose()}}this._loader.logClose(),t._loaded=Promise.all(i).then(()=>S(this,null,function*(){let s=new Gp(this._loader.babylonScene,null,t.specularImageSize);if(s.name=t.name||"environment",t._babylonTexture=s,t.intensity!=null&&(s.level=t.intensity),t.rotation){let c=Q.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(c=Q.Inverse(c)),L.FromQuaternionToRef(c,s.getReflectionTextureMatrix())}if(!t.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);let o=LT.FromArray(t.irradianceCoefficients);o.scaleInPlace(t.intensity),o.convertIrradianceToLambertianRadiance();let a=BT.FromHarmonics(o),l=(r.length-1)/Math.log2(t.specularImageSize);return yield s.updateRGBDAsync(r,a,l)}))}return t._loaded.then(()=>t._babylonTexture)}};de(Up);fe(Up,!0,n=>new ix(n));E.prototype.thinInstanceAdd=function(n,e=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return P.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(n)?n.length:1);let t=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(n))for(let i=0;i<n.length;++i)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,n[i],i===n.length-1&&e);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,n,e);return t};E.prototype.thinInstanceAddSelf=function(n=!0){return this.thinInstanceAdd(L.IdentityReadOnly,n)};E.prototype.thinInstanceRegisterAttribute=function(n,e){n===T.ColorKind&&(n=T.ColorInstanceKind),this.removeVerticesData(n),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[n]=e,this._userThinInstanceBuffersStorage.sizes[n]=e*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[n]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[n]),this._userThinInstanceBuffersStorage.vertexBuffers[n]=new T(this.getEngine(),this._userThinInstanceBuffersStorage.data[n],n,!0,!1,e,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[n])};E.prototype.thinInstanceSetMatrixAt=function(n,e,t=!0){if(!this._thinInstanceDataStorage.matrixData||n>=this._thinInstanceDataStorage.instancesCount)return!1;let i=this._thinInstanceDataStorage.matrixData;return e.copyToArray(i,n*16),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[n]=e),t&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0};E.prototype.thinInstanceSetAttributeAt=function(n,e,t,i=!0){return n===T.ColorKind&&(n=T.ColorInstanceKind),!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[n]||e>=this._thinInstanceDataStorage.instancesCount?!1:(this._thinInstanceUpdateBufferSize(n,0),this._userThinInstanceBuffersStorage.data[n].set(t,e*this._userThinInstanceBuffersStorage.strides[n]),i&&this.thinInstanceBufferUpdated(n),!0)};Object.defineProperty(E.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(n){let e=this._thinInstanceDataStorage.matrixData??this.source?._thinInstanceDataStorage.matrixData,t=e?e.length/16:0;n<=t&&(this._thinInstanceDataStorage.instancesCount=n)},enumerable:!0,configurable:!0});E.prototype._thinInstanceCreateMatrixBuffer=function(n,e,t=!0){let i=new ei(this.getEngine(),e,!t,16,!1,!0);for(let r=0;r<4;r++)this.setVerticesBuffer(i.createVertexBuffer(n+r,r*4,4));return i};E.prototype.thinInstanceSetBuffer=function(n,e,t=0,i=!0){if(t=t||16,n==="matrix")this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=e?e.length:32*t,this._thinInstanceDataStorage.matrixData=e,this._thinInstanceDataStorage.worldMatrices=null,e!==null?(this._thinInstanceDataStorage.instancesCount=e.length/t,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",e,i),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo());else if(n==="previousMatrix")this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=e,e!==null&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",e,i));else if(n==="splatIndex"&&e){this._thinInstanceInitializeUserStorage(),this._thinInstanceDataStorage.instancesCount=e.length/t,this._userThinInstanceBuffersStorage.data[n]=e,this._userThinInstanceBuffersStorage.strides[n]=t,this._userThinInstanceBuffersStorage.sizes[n]=e.length;let r=new ei(this.getEngine(),e,!0,16,!1,!0);this._thinInstanceDataStorage.matrixBuffer=r;for(let s=0;s<4;s++)this.setVerticesBuffer(r.createVertexBuffer(n+s,s*4,4))}else n===T.ColorKind&&(n=T.ColorInstanceKind),e===null?this._userThinInstanceBuffersStorage?.data[n]&&(this.removeVerticesData(n),delete this._userThinInstanceBuffersStorage.data[n],delete this._userThinInstanceBuffersStorage.strides[n],delete this._userThinInstanceBuffersStorage.sizes[n],delete this._userThinInstanceBuffersStorage.vertexBuffers[n]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[n]=e,this._userThinInstanceBuffersStorage.strides[n]=t,this._userThinInstanceBuffersStorage.sizes[n]=e.length,this._userThinInstanceBuffersStorage.vertexBuffers[n]=new T(this.getEngine(),e,n,!i,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[n]))};E.prototype.thinInstanceBufferUpdated=function(n){n==="matrix"?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.matrixBuffer&&!this._thinInstanceDataStorage.matrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(n),this._thinInstanceDataStorage.matrixBuffer?.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount)):n==="previousMatrix"?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.previousMatrixBuffer&&!this._thinInstanceDataStorage.previousMatrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(n),this._thinInstanceDataStorage.previousMatrixBuffer?.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount)):n==="splatIndex"?this._thinInstanceDataStorage.matrixBuffer?.updateDirectly(this._userThinInstanceBuffersStorage.data[n],0,this._thinInstanceDataStorage.instancesCount):(n===T.ColorKind&&(n=T.ColorInstanceKind),this._userThinInstanceBuffersStorage?.vertexBuffers[n]&&(this.thinInstanceAllowAutomaticStaticBufferRecreation&&!this._userThinInstanceBuffersStorage.vertexBuffers[n].isUpdatable()&&this._thinInstanceRecreateBuffer(n),this._userThinInstanceBuffersStorage.vertexBuffers[n].updateDirectly(this._userThinInstanceBuffersStorage.data[n],0)))};E.prototype.thinInstancePartialBufferUpdate=function(n,e,t){n==="matrix"?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(e,t):(n===T.ColorKind&&(n=T.ColorInstanceKind),this._userThinInstanceBuffersStorage?.vertexBuffers[n]&&this._userThinInstanceBuffersStorage.vertexBuffers[n].updateDirectly(e,t))};E.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];let n=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=[];for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e)this._thinInstanceDataStorage.worldMatrices[e]=L.FromArray(n,e*16)}return this._thinInstanceDataStorage.worldMatrices};E.prototype.thinInstanceRefreshBoundingInfo=function(n=!1,e=!1,t=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;let i=this._thinInstanceDataStorage.boundingVectors;if(n||!this.rawBoundingInfo){i.length=0,this.refreshBoundingInfo(e,t);let o=this.getBoundingInfo();this.rawBoundingInfo=new es(o.minimum,o.maximum)}let r=this.getBoundingInfo(),s=this._thinInstanceDataStorage.matrixData;if(i.length===0)for(let o=0;o<r.boundingBox.vectors.length;++o)i.push(r.boundingBox.vectors[o].clone());k.Vector3[0].setAll(Number.POSITIVE_INFINITY),k.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let o=0;o<this._thinInstanceDataStorage.instancesCount;++o){L.FromArrayToRef(s,o*16,k.Matrix[0]);for(let a=0;a<i.length;++a)m.TransformCoordinatesToRef(i[a],k.Matrix[0],k.Vector3[2]),k.Vector3[0].minimizeInPlace(k.Vector3[2]),k.Vector3[1].maximizeInPlace(k.Vector3[2])}r.reConstruct(k.Vector3[0],k.Vector3[1]),this._updateBoundingInfo()};E.prototype._thinInstanceRecreateBuffer=function(n,e=!0){n==="matrix"?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",this._thinInstanceDataStorage.matrixData,e)):n==="previousMatrix"?this._scene.needsPreviousWorldMatrices&&(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.previousMatrixData??this._thinInstanceDataStorage.matrixData,e)):(n===T.ColorKind&&(n=T.ColorInstanceKind),this._userThinInstanceBuffersStorage.vertexBuffers[n]?.dispose(),this._userThinInstanceBuffersStorage.vertexBuffers[n]=new T(this.getEngine(),this._userThinInstanceBuffersStorage.data[n],n,!e,!1,this._userThinInstanceBuffersStorage.strides[n],!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[n]))};E.prototype._thinInstanceUpdateBufferSize=function(n,e=1){n===T.ColorKind&&(n=T.ColorInstanceKind);let t=n==="matrix";if(!t&&(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.strides[n]))return;let i=t?16:this._userThinInstanceBuffersStorage.strides[n],r=t?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[n],s=t?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[n],o=(this._thinInstanceDataStorage.instancesCount+e)*i,a=r;for(;a<o;)a*=2;if(!s||r!=a){if(!s)s=new Float32Array(a);else{let l=new Float32Array(a);l.set(s,0),s=l}t?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",s,!1),this._thinInstanceDataStorage.matrixData=s,this._thinInstanceDataStorage.matrixBufferSize=a,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",s,!1))):(this._userThinInstanceBuffersStorage.vertexBuffers[n]?.dispose(),this._userThinInstanceBuffersStorage.data[n]=s,this._userThinInstanceBuffersStorage.sizes[n]=a,this._userThinInstanceBuffersStorage.vertexBuffers[n]=new T(this.getEngine(),s,n,!0,!1,i,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[n]))}};E.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})};E.prototype._disposeThinInstanceSpecificData=function(){this._thinInstanceDataStorage?.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null),this._thinInstanceDataStorage?.previousMatrixBuffer&&(this._thinInstanceDataStorage.previousMatrixBuffer.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null)};var zp="EXT_mesh_gpu_instancing",nx=class{constructor(e){this.name=zp,this._loader=e,this.enabled=this._loader.isExtensionUsed(zp)}dispose(){this._loader=null}loadNodeAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){this._loader._disableInstancedMesh++;let o=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,i);if(this._loader._disableInstancedMesh--,!t._primitiveBabylonMeshes)return yield o;let a=new Array,l=0,c=u=>{if(s.attributes[u]==null){a.push(Promise.resolve(null));return}let h=se.Get(`${r}/attributes/${u}`,this._loader.gltf.accessors,s.attributes[u]);if(a.push(this._loader._loadFloatAccessorAsync(`/accessors/${h.bufferView}`,h)),l===0)l=h.count;else if(l!==h.count)throw new Error(`${r}/attributes: Instance buffer accessors do not have the same count.`)};return c("TRANSLATION"),c("ROTATION"),c("SCALE"),c("_COLOR_0"),yield o.then(u=>S(this,null,function*(){let[h,d,f,p]=yield Promise.all(a),g=new Float32Array(l*16);k.Vector3[0].copyFromFloats(0,0,0),k.Quaternion[0].copyFromFloats(0,0,0,1),k.Vector3[1].copyFromFloats(1,1,1);for(let _=0;_<l;++_)h&&m.FromArrayToRef(h,_*3,k.Vector3[0]),d&&Q.FromArrayToRef(d,_*4,k.Quaternion[0]),f&&m.FromArrayToRef(f,_*3,k.Vector3[1]),L.ComposeToRef(k.Vector3[1],k.Quaternion[0],k.Vector3[0],k.Matrix[0]),k.Matrix[0].copyToArray(g,_*16);for(let _ of t._primitiveBabylonMeshes)_.thinInstanceSetBuffer("matrix",g,16,!0),p&&(p.length===l*3?_.thinInstanceSetBuffer("color",p,3,!0):p.length===l*4?_.thinInstanceSetBuffer("color",p,4,!0):P.Warn("Unexpected size of _COLOR_0 attribute for mesh "+_.name));return u}))}))}};de(zp);fe(zp,!0,n=>new nx(n));var rx=0,Hp=null,Ll=class n{static get Default(){return n._Default||(n._Default=new n),n._Default}constructor(){let e=n.Configuration.decoder;this._decoderModulePromise=z.LoadBabylonScriptAsync(e.url).then(()=>MeshoptDecoder.ready)}dispose(){delete this._decoderModulePromise}decodeGltfBufferAsync(e,t,i,r,s){return S(this,null,function*(){yield this._decoderModulePromise,rx===0&&(MeshoptDecoder.useWorkers(1),rx=1);let o=yield MeshoptDecoder.decodeGltfBufferAsync(t,i,e,r,s);return Hp!==null&&clearTimeout(Hp),Hp=setTimeout(()=>{MeshoptDecoder.useWorkers(0),rx=0,Hp=null},1e3),o})}};Ll.Configuration={decoder:{url:`${z._DefaultCdnUrl}/meshopt_decoder.js`}};Ll._Default=null;var Wp="EXT_meshopt_compression",sx=class{constructor(e){this.name=Wp,this.enabled=e.isExtensionUsed(Wp),this._loader=e}dispose(){this._loader=null}loadBufferViewAsync(e,t){return ge.LoadExtensionAsync(e,t,this.name,(i,r)=>S(this,null,function*(){let s=t;if(s._meshOptData)return yield s._meshOptData;let o=se.Get(`${e}/buffer`,this._loader.gltf.buffers,r.buffer);return s._meshOptData=this._loader.loadBufferAsync(`/buffers/${o.index}`,o,r.byteOffset||0,r.byteLength).then(a=>S(this,null,function*(){return yield Ll.Default.decodeGltfBufferAsync(a,r.count,r.byteStride,r.mode,r.filter)})),yield s._meshOptData}))}};de(Wp);fe(Wp,!0,n=>new sx(n));var $p="EXT_texture_webp",ox=class{constructor(e){this.name=$p,this._loader=e,this.enabled=e.isExtensionUsed($p)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){let o=t.sampler==null?ge.DefaultSampler:se.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=se.Get(`${r}/source`,this._loader.gltf.images,s.source);return yield this._loader._createTextureAsync(e,o,a,l=>{i(l)},void 0,!t._textureInfo.nonColorData)}))}};de($p);fe($p,!0,n=>new ox(n));var jp="EXT_texture_avif",ax=class{constructor(e){this.name=jp,this._loader=e,this.enabled=e.isExtensionUsed(jp)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){let o=t.sampler==null?ge.DefaultSampler:se.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=se.Get(`${r}/source`,this._loader.gltf.images,s.source);return yield this._loader._createTextureAsync(e,o,a,l=>{i(l)},void 0,!t._textureInfo.nonColorData)}))}};de(jp);fe(jp,!0,n=>new ax(n));var qp="EXT_lights_ies",lx=class{constructor(e){this.name=qp,this._loader=e,this.enabled=this._loader.isExtensionUsed(qp)}dispose(){this._loader=null,delete this._lights}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._lights=t.lights,se.Assign(this._lights)}}loadNodeAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){this._loader._allMaterialsDirtyRequired=!0;let o,a,l=yield this._loader.loadNodeAsync(e,t,u=>{a=se.Get(r,this._lights,s.light);let h=a.name||u.name;this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,o=new Ms(h,m.Zero(),m.Backward(),0,1,this._loader.babylonScene),o.angle=Math.PI/2,o.innerAngle=0,o._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,a._babylonLight=o,o.falloffType=Yt.FALLOFF_GLTF,o.diffuse=s.color?U.FromArray(s.color):U.White(),o.intensity=s.multiplier||1,o.range=Number.MAX_VALUE,o.parent=u,this._loader._babylonLights.push(o),ge.AddPointerMetadata(o,r),i(u)}),c;if(a.uri)c=yield this._loader.loadUriAsync(e,a,a.uri);else{let u=se.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,a.bufferView);c=yield this._loader.loadBufferViewAsync(`/bufferViews/${u.index}`,u)}return o.iesProfileTexture=new Z(name+"_iesProfile",this._loader.babylonScene,!0,!1,void 0,null,null,c,!0,void 0,void 0,void 0,void 0,".ies"),l}))}};de(qp);fe(qp,!0,n=>new lx(n));function Yp(n,e,t,i,r){let s=n,o=null,a=null,l=null;try{o=new s.Decoder,a=new s.DecoderBuffer,a.Init(e,e.byteLength);let c,u=o.GetEncodedGeometryType(a);switch(u){case s.TRIANGULAR_MESH:{let f=new s.Mesh;if(c=o.DecodeBufferToMesh(a,f),!c.ok()||f.ptr===0)throw new Error(c.error_msg());let g=f.num_faces()*3,_=g*4,y=s._malloc(_);try{o.GetTrianglesUInt32Array(f,_,y);let b=new Uint32Array(g);b.set(new Uint32Array(s.HEAPF32.buffer,y,g)),i(b)}finally{s._free(y)}l=f;break}case s.POINT_CLOUD:{let f=new s.PointCloud;if(c=o.DecodeBufferToPointCloud(a,f),!c.ok()||!f.ptr)throw new Error(c.error_msg());l=f;break}default:throw new Error(`Invalid geometry type ${u}`)}let h=l.num_points(),d=(f,p,g,_)=>{let y=_.data_type(),b=_.num_components(),A=_.normalized(),I=_.byte_stride(),v=_.byte_offset(),C={[s.DT_FLOAT32]:{typedArrayConstructor:Float32Array,heap:s.HEAPF32},[s.DT_INT8]:{typedArrayConstructor:Int8Array,heap:s.HEAP8},[s.DT_INT16]:{typedArrayConstructor:Int16Array,heap:s.HEAP16},[s.DT_INT32]:{typedArrayConstructor:Int32Array,heap:s.HEAP32},[s.DT_UINT8]:{typedArrayConstructor:Uint8Array,heap:s.HEAPU8},[s.DT_UINT16]:{typedArrayConstructor:Uint16Array,heap:s.HEAPU16},[s.DT_UINT32]:{typedArrayConstructor:Uint32Array,heap:s.HEAPU32}}[y];if(!C)throw new Error(`Invalid data type ${y}`);let R=h*b,M=R*C.typedArrayConstructor.BYTES_PER_ELEMENT,D=s._malloc(M);try{f.GetAttributeDataArrayForAllPoints(p,_,y,M,D);let W=new C.typedArrayConstructor(C.heap.buffer,D,R);r(g,W.slice(),b,v,I,A)}finally{s._free(D)}};if(t)for(let f in t){let p=t[f],g=o.GetAttributeByUniqueId(l,p);d(o,l,f,g)}else{let f={position:s.POSITION,normal:s.NORMAL,color:s.COLOR,uv:s.TEX_COORD};for(let p in f){let g=o.GetAttributeId(l,f[p]);if(g!==-1){let _=o.GetAttribute(l,g);d(o,l,p,_)}}}return h}finally{l&&s.destroy(l),a&&s.destroy(a),o&&s.destroy(o)}}function eM(){let n;onmessage=e=>{let t=e.data;switch(t.id){case"init":{t.url&&importScripts(t.url);let i=t.wasmBinary?{wasmBinary:t.wasmBinary}:{};n=DracoDecoderModule(i),postMessage({id:"initDone"});break}case"decodeMesh":{if(!n)throw new Error("Draco decoder module is not available");n.then(i=>{let r=Yp(i,t.dataView,t.attributes,s=>{postMessage({id:"indices",data:s},[s.buffer])},(s,o,a,l,c,u)=>{postMessage({id:"attribute",kind:s,data:o,size:a,byteOffset:l,byteStride:c,normalized:u},[o.buffer])});postMessage({id:"decodeMeshDone",totalVertices:r})});break}}}}function tM(n,e,t){return S(this,null,function*(){return yield new Promise((i,r)=>{let s=a=>{n.removeEventListener("error",s),n.removeEventListener("message",o),r(a)},o=a=>{a.data.id==="initDone"&&(n.removeEventListener("error",s),n.removeEventListener("message",o),i(n))};if(n.addEventListener("error",s),n.addEventListener("message",o),!e)n.postMessage({id:"init",url:t});else{let a=e.slice(0);n.postMessage({id:"init",url:t,wasmBinary:a},[a])}})})}function hk(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)}function iM(n){return!!(n.wasmUrl&&(n.wasmBinary||n.wasmBinaryUrl)&&typeof WebAssembly=="object"||n.fallbackUrl)}var Kp=class{constructor(e){if(e.workerPool){this._workerPoolPromise=Promise.resolve(e.workerPool);return}let t=e.wasmBinary,i=e.numWorkers??hk(),r=i&&typeof Worker=="function"&&typeof URL=="function",s=r||!e.jsModule,o=e.wasmUrl&&e.wasmBinaryUrl&&typeof WebAssembly=="object"?{url:s?z.GetBabylonScriptURL(e.wasmUrl,!0):"",wasmBinaryPromise:t?Promise.resolve(t):z.LoadFileAsync(z.GetBabylonScriptURL(e.wasmBinaryUrl,!0))}:{url:s?z.GetBabylonScriptURL(e.fallbackUrl):"",wasmBinaryPromise:Promise.resolve(void 0)};r?this._workerPoolPromise=o.wasmBinaryPromise.then(a=>{let l=this._getWorkerContent(),c=URL.createObjectURL(new Blob([l],{type:"application/javascript"}));return new l0(i,()=>{let u=new Worker(c);return tM(u,a,o.url)})}):this._modulePromise=o.wasmBinaryPromise.then(a=>S(this,null,function*(){if(!this._isModuleAvailable()&&!e.jsModule){if(!o.url)throw new Error("Draco codec module is not available");yield z.LoadBabylonScriptAsync(o.url)}return yield this._createModuleAsync(a,e.jsModule)}))}whenReadyAsync(){return S(this,null,function*(){if(this._workerPoolPromise){yield this._workerPoolPromise;return}if(this._modulePromise){yield this._modulePromise;return}})}dispose(){this._workerPoolPromise&&this._workerPoolPromise.then(e=>{e.dispose()}),delete this._workerPoolPromise,delete this._modulePromise}};var Zo=class n extends Kp{static get DefaultAvailable(){return iM(n.DefaultConfiguration)}static get Default(){return n._Default??(n._Default=new n),n._Default}static ResetDefault(e){n._Default&&(e||n._Default.dispose(),n._Default=null)}_isModuleAvailable(){return typeof DracoDecoderModule<"u"}_createModuleAsync(e,t){return S(this,null,function*(){return{module:yield(t||DracoDecoderModule)({wasmBinary:e})}})}_getWorkerContent(){return`${Yp}(${eM})()`}constructor(e=n.DefaultConfiguration){super(e)}decodeMeshToMeshDataAsync(e,t,i){let r=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e.buffer,e.byteOffset,e.byteLength),s=(o,a)=>i&&i[o]!==void 0?(a!==i[o]&&P.Warn(`Normalized flag from Draco data (${a}) does not match normalized flag from glTF accessor (${i[o]}). Using flag from glTF accessor.`),i[o]):a;if(this._workerPoolPromise)return this._workerPoolPromise.then(o=>S(this,null,function*(){return yield new Promise((a,l)=>{o.push((c,u)=>{let h=null,d=[],f=_=>{c.removeEventListener("error",f),c.removeEventListener("message",p),l(_),u()},p=_=>{let y=_.data;switch(y.id){case"indices":{h=y.data;break}case"attribute":{d.push({kind:y.kind,data:y.data,size:y.size,byteOffset:y.byteOffset,byteStride:y.byteStride,normalized:s(y.kind,y.normalized)});break}case"decodeMeshDone":{c.removeEventListener("error",f),c.removeEventListener("message",p),a({indices:h,attributes:d,totalVertices:y.totalVertices}),u();break}}};c.addEventListener("error",f),c.addEventListener("message",p);let g=r.slice();c.postMessage({id:"decodeMesh",dataView:g,attributes:t},[g.buffer])})})}));if(this._modulePromise)return this._modulePromise.then(o=>{let a=null,l=[],c=Yp(o.module,r,t,u=>{a=u},(u,h,d,f,p,g)=>{l.push({kind:u,data:h,size:d,byteOffset:f,byteStride:p,normalized:g})});return{indices:a,attributes:l,totalVertices:c}});throw new Error("Draco decoder module is not available")}decodeMeshToGeometryAsync(e,t,i,r){return S(this,null,function*(){let s=yield this.decodeMeshToMeshDataAsync(i,r),o=new Lt(e,t);s.indices&&o.setIndices(s.indices);for(let a of s.attributes)o.setVerticesBuffer(new T(t.getEngine(),a.data,a.kind,!1,void 0,a.byteStride,void 0,a.byteOffset,a.size,void 0,a.normalized,!0),s.totalVertices);return o})}_decodeMeshToGeometryForGltfAsync(e,t,i,r,s,o){return S(this,null,function*(){let a=yield this.decodeMeshToMeshDataAsync(i,r,s),l=new Lt(e,t);o&&(l._boundingInfo=o,l.useBoundingInfoFromGeometry=!0),a.indices&&l.setIndices(a.indices);for(let c of a.attributes)l.setVerticesBuffer(new T(t.getEngine(),c.data,c.kind,!1,void 0,c.byteStride,void 0,c.byteOffset,c.size,void 0,c.normalized,!0),a.totalVertices);return l})}};Zo.DefaultConfiguration={wasmUrl:`${z._DefaultCdnUrl}/draco_wasm_wrapper_gltf.js`,wasmBinaryUrl:`${z._DefaultCdnUrl}/draco_decoder_gltf.wasm`,fallbackUrl:`${z._DefaultCdnUrl}/draco_decoder_gltf.js`};Zo._Default=null;var Xp="KHR_draco_mesh_compression",cx=class{constructor(e){this.name=Xp,this.useNormalizedFlagFromAccessor=!0,this._loader=e,this.enabled=Zo.DefaultAvailable&&this._loader.isExtensionUsed(Xp)}dispose(){delete this.dracoDecoder,this._loader=null}_loadVertexDataAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){if(t.mode!=null&&t.mode!==4&&t.mode!==5)throw new Error(`${e}: Unsupported mode ${t.mode}`);let o={},a={},l=(u,h)=>{let d=s.attributes[u];if(d!=null&&(i._delayInfo=i._delayInfo||[],i._delayInfo.indexOf(h)===-1&&i._delayInfo.push(h),o[h]=d,this.useNormalizedFlagFromAccessor)){let f=se.TryGet(this._loader.gltf.accessors,t.attributes[u]);f&&(a[h]=f.normalized||!1)}};l("POSITION",T.PositionKind),l("NORMAL",T.NormalKind),l("TANGENT",T.TangentKind),l("TEXCOORD_0",T.UVKind),l("TEXCOORD_1",T.UV2Kind),l("TEXCOORD_2",T.UV3Kind),l("TEXCOORD_3",T.UV4Kind),l("TEXCOORD_4",T.UV5Kind),l("TEXCOORD_5",T.UV6Kind),l("JOINTS_0",T.MatricesIndicesKind),l("WEIGHTS_0",T.MatricesWeightsKind),l("COLOR_0",T.ColorKind);let c=se.Get(r,this._loader.gltf.bufferViews,s.bufferView);return c._dracoBabylonGeometry||(c._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${c.index}`,c).then(u=>S(this,null,function*(){let h=this.dracoDecoder||Zo.Default,d=se.TryGet(this._loader.gltf.accessors,t.attributes.POSITION),f=!this._loader.parent.alwaysComputeBoundingBox&&!i.skeleton&&d?tx(d):null;return yield h._decodeMeshToGeometryForGltfAsync(i.name,this._loader.babylonScene,u,o,a,f).catch(p=>{throw new Error(`${e}: ${p.message}`)})}))),yield c._dracoBabylonGeometry}))}};de(Xp);fe(Xp,!0,n=>new cx(n));var Zp="KHR_lights_punctual",ux=class{constructor(e){this.name=Zp,this._loader=e,this.enabled=this._loader.isExtensionUsed(Zp)}dispose(){this._loader=null,delete this._lights}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._lights=t.lights,se.Assign(this._lights)}}loadNodeAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){return this._loader._allMaterialsDirtyRequired=!0,yield this._loader.loadNodeAsync(e,t,o=>{let a,l=se.Get(r,this._lights,s.light),c=l.name||o.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,l.type){case"directional":{let u=new Fa(c,m.Backward(),this._loader.babylonScene);u.position.setAll(0),a=u;break}case"point":{a=new In(c,m.Zero(),this._loader.babylonScene);break}case"spot":{let u=new Ms(c,m.Zero(),m.Backward(),0,1,this._loader.babylonScene);u.angle=(l.spot&&l.spot.outerConeAngle||Math.PI/4)*2,u.innerAngle=(l.spot&&l.spot.innerConeAngle||0)*2,a=u;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${r}: Invalid light type (${l.type})`)}a._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,l._babylonLight=a,a.falloffType=Yt.FALLOFF_GLTF,a.diffuse=l.color?U.FromArray(l.color):U.White(),a.intensity=l.intensity==null?1:l.intensity,a.range=l.range==null?Number.MAX_VALUE:l.range,a.parent=o,this._loader._babylonLights.push(a),ge.AddPointerMetadata(a,r),i(o)})}))}};de(Zp);fe(Zp,!0,n=>new ux(n));function nM(){return S(this,null,function*(){let n=new Uint16Array(16384),e=new Uint16Array(4096*4),t=yield z.LoadFileAsync(z.GetAssetUrl("https://assets.babylonjs.com/core/areaLights/areaLightsLTC.bin")),i=new Uint16Array(t),r=i.length/8;for(let s=0;s<r;s++)n[s*4]=i[s*8],n[s*4+1]=i[s*8+1],n[s*4+2]=i[s*8+2],n[s*4+3]=i[s*8+3],e[s*4]=i[s*8+4],e[s*4+1]=i[s*8+5],e[s*4+2]=i[s*8+6],e[s*4+3]=i[s*8+7];return[n,e]})}function dk(n){let e=n.useDelayedTextureLoading;n.useDelayedTextureLoading=!1;let t=n._blockEntityCollection;n._blockEntityCollection=!1,n._ltcTextures={LTC1:_i.CreateRGBATexture(null,64,64,n.getEngine(),!1,!1,2,2,0,!1,!0),LTC2:_i.CreateRGBATexture(null,64,64,n.getEngine(),!1,!1,2,2,0,!1,!0)},n._blockEntityCollection=t,n._ltcTextures.LTC1.wrapU=Z.CLAMP_ADDRESSMODE,n._ltcTextures.LTC1.wrapV=Z.CLAMP_ADDRESSMODE,n._ltcTextures.LTC2.wrapU=Z.CLAMP_ADDRESSMODE,n._ltcTextures.LTC2.wrapV=Z.CLAMP_ADDRESSMODE,n.useDelayedTextureLoading=e,nM().then(i=>{n._ltcTextures&&((n._ltcTextures?.LTC1).update(i[0]),(n._ltcTextures?.LTC2).update(i[1]),n.onDisposeObservable.addOnce(()=>{n._ltcTextures?.LTC1.dispose(),n._ltcTextures?.LTC2.dispose()}))}).catch(i=>{P.Error(`Area Light fail to get LTC textures data. Error: ${i}`)})}var Qp=class extends Yt{constructor(e,t,i){super(e,i),this.position=t,this._scene._ltcTextures||dk(this._scene)}transferTexturesToEffect(e){return this._scene._ltcTextures&&(e.setTexture("areaLightsLTC1Sampler",this._scene._ltcTextures.LTC1),e.setTexture("areaLightsLTC2Sampler",this._scene._ltcTextures.LTC2)),this}prepareLightSpecificDefines(e,t){e["AREALIGHT"+t]=!0,e.AREALIGHTUSED=!0}_isReady(){return this._scene._ltcTextures?this._scene._ltcTextures.LTC1.isReady()&&this._scene._ltcTextures.LTC2.isReady():!1}};Ut.AddNodeConstructor("Light_Type_4",(n,e)=>()=>new ys(n,m.Zero(),1,1,e));var ys=class extends Qp{get width(){return this._width.x}set width(e){this._width.x=e}get height(){return this._height.y}set height(e){this._height.y=e}constructor(e,t,i,r,s){super(e,t,s),this._width=new m(i,0,0),this._height=new m(0,r,0),this._pointTransformedPosition=m.Zero(),this._pointTransformedWidth=m.Zero(),this._pointTransformedHeight=m.Zero()}getClassName(){return"RectAreaLight"}getTypeID(){return Yt.LIGHTTYPEID_RECT_AREALIGHT}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightWidth",4),this._uniformBuffer.addUniform("vLightHeight",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeTransformedInformation(){return this.parent&&this.parent.getWorldMatrix?(m.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this._pointTransformedPosition),m.TransformNormalToRef(this._width,this.parent.getWorldMatrix(),this._pointTransformedWidth),m.TransformNormalToRef(this._height,this.parent.getWorldMatrix(),this._pointTransformedHeight),!0):!1}transferToEffect(e,t){let i=this._scene.floatingOriginOffset;return this._computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this._pointTransformedPosition.x-i.x,this._pointTransformedPosition.y-i.y,this._pointTransformedPosition.z-i.z,0,t),this._uniformBuffer.updateFloat4("vLightWidth",this._pointTransformedWidth.x/2,this._pointTransformedWidth.y/2,this._pointTransformedWidth.z/2,0,t),this._uniformBuffer.updateFloat4("vLightHeight",this._pointTransformedHeight.x/2,this._pointTransformedHeight.y/2,this._pointTransformedHeight.z/2,0,t)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x-i.x,this.position.y-i.y,this.position.z-i.z,0,t),this._uniformBuffer.updateFloat4("vLightWidth",this._width.x/2,this._width.y/2,this._width.z/2,0,t),this._uniformBuffer.updateFloat4("vLightHeight",this._height.x/2,this._height.y/2,this._height.z/2,0,t)),this}transferToNodeMaterialEffect(e,t){let i=this._scene.floatingOriginOffset;return this._computeTransformedInformation()?e.setFloat3(t,this._pointTransformedPosition.x-i.x,this._pointTransformedPosition.y-i.y,this._pointTransformedPosition.z-i.z):e.setFloat3(t,this.position.x-i.x,this.position.y-i.y,this.position.z-i.z),this}};w([B()],ys.prototype,"width",null);w([B()],ys.prototype,"height",null);le("BABYLON.RectAreaLight",ys);var Jp="EXT_lights_area",hx=class{constructor(e){this.name=Jp,this._loader=e,this.enabled=this._loader.isExtensionUsed(Jp)}dispose(){this._loader=null,delete this._lights}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._lights=t.lights,se.Assign(this._lights)}}loadNodeAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){return this._loader._allMaterialsDirtyRequired=!0,yield this._loader.loadNodeAsync(e,t,o=>{let a,l=se.Get(r,this._lights,s.light),c=l.name||o.name;this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer;let u=l.size!==void 0?l.size:1;switch(l.type){case"rect":{let d=l.rect?.aspect!==void 0?l.rect.aspect*u:u,f=u;a=new ys(c,m.Zero(),d,f,this._loader.babylonScene);break}case"disk":{let d=Math.sqrt(u*u*.25*Math.PI);a=new ys(c,m.Zero(),d,d,this._loader.babylonScene);break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${r}: Invalid area light type (${l.type})`)}a._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,l._babylonLight=a,a.falloffType=Yt.FALLOFF_GLTF,a.diffuse=l.color?U.FromArray(l.color):U.White(),a.intensity=l.intensity==null?1:l.intensity;let h=new vi(`${c}_orientation`,this._loader.babylonScene);h.rotationQuaternion=Q.RotationAxis(m.Up(),Math.PI),h.parent=o,a.parent=h,this._loader._babylonLights.push(a),ge.AddPointerMetadata(a,r),i(o)})}))}};de(Jp);fe(Jp,!0,n=>new hx(n));var em="KHR_materials_pbrSpecularGlossiness",dx=class{constructor(e){this.name=em,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(em)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){let o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),o.push(this._loadSpecularGlossinessPropertiesAsync(r,s,i)),this._loader.loadMaterialAlphaProperties(e,t,i),yield Promise.all(o).then(()=>{})}))}_loadSpecularGlossinessPropertiesAsync(e,t,i){if(!(i instanceof Va))throw new Error(`${e}: Material type not supported`);let r=new Array;return i.metallic=null,i.roughness=null,t.diffuseFactor?(i.albedoColor=U.FromArray(t.diffuseFactor),i.alpha=t.diffuseFactor[3]):i.albedoColor=U.White(),i.reflectivityColor=t.specularFactor?U.FromArray(t.specularFactor):U.White(),i.microSurface=t.glossinessFactor==null?1:t.glossinessFactor,t.diffuseTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTexture`,t.diffuseTexture,s=>{s.name=`${i.name} (Diffuse)`,i.albedoTexture=s})),t.specularGlossinessTexture&&(r.push(this._loader.loadTextureInfoAsync(`${e}/specularGlossinessTexture`,t.specularGlossinessTexture,s=>{s.name=`${i.name} (Specular Glossiness)`,i.reflectivityTexture=s,i.reflectivityTexture.hasAlpha=!0})),i.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(r).then(()=>{})}};de(em);fe(em,!0,n=>new dx(n));var tm="KHR_materials_unlit",fx=class{constructor(e){this.name=tm,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(tm)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,()=>S(this,null,function*(){return yield this._loadUnlitPropertiesAsync(e,t,i)}))}_loadUnlitPropertiesAsync(e,t,i){let r=this._loader._getOrCreateMaterialAdapter(i),s=new Array,o=t.pbrMetallicRoughness;return o&&(o.baseColorFactor&&(r.baseColor=U.FromArray(o.baseColorFactor),r.geometryOpacity=o.baseColorFactor[3]),o.baseColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/baseColorTexture`,o.baseColorTexture,a=>{a.name=`${i.name} (Base Color)`,r.baseColorTexture=a}))),r.isUnlit=!0,t.doubleSided&&(r.backFaceCulling=!1,r.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,t,i),Promise.all(s).then(()=>{})}};de(tm);fe(tm,!0,n=>new fx(n));var im="KHR_materials_clearcoat",px=class{constructor(e){this.name=im,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(im)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){let o=new Array;o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadClearCoatPropertiesAsync(r,s,i)),yield Promise.all(o)}))}_loadClearCoatPropertiesAsync(e,t,i){let r=this._loader._getOrCreateMaterialAdapter(i),s=new Array;return r.configureCoat(),r.coatWeight=t.clearcoatFactor!==void 0?t.clearcoatFactor:0,r.coatRoughness=t.clearcoatRoughnessFactor!==void 0?t.clearcoatRoughnessFactor:0,t.clearcoatTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,t.clearcoatTexture,o=>{o.name=`${i.name} (ClearCoat)`,r.coatWeightTexture=o})),t.clearcoatRoughnessTexture&&(t.clearcoatRoughnessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,t.clearcoatRoughnessTexture,o=>{o.name=`${i.name} (ClearCoat Roughness)`,r.coatRoughnessTexture=o}))),t.clearcoatNormalTexture&&(t.clearcoatNormalTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,t.clearcoatNormalTexture,o=>{o.name=`${i.name} (ClearCoat Normal)`,r.geometryCoatNormalTexture=o,t.clearcoatNormalTexture?.scale!=null&&(r.geometryCoatNormalTextureScale=t.clearcoatNormalTexture.scale)})),r.setNormalMapInversions(!i.getScene().useRightHandedSystem,i.getScene().useRightHandedSystem)),Promise.all(s).then(()=>{})}};de(im);fe(im,!0,n=>new px(n));var nm="KHR_materials_coat",mx=class{constructor(e){this.name=nm,this.order=191,this.useOpenPBR=!1,this._loader=e,this.enabled=this._loader.isExtensionUsed(nm)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){let o=new Array;o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),t.extensions&&t.extensions.KHR_materials_openpbr&&(this.useOpenPBR=!0),o.push(this._loadCoatPropertiesAsync(r,s,i)),yield Promise.all(o)}))}_loadCoatPropertiesAsync(e,t,i){let r=this._loader._getOrCreateMaterialAdapter(i),s=new Array;r.configureCoat(),r.coatWeight=t.coatFactor!==void 0?t.coatFactor:0,r.coatRoughness=t.coatRoughnessFactor!==void 0?t.coatRoughnessFactor:0,t.coatTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/coatTexture`,t.coatTexture,c=>{c.name=`${i.name} (Coat)`,r.coatWeightTexture=c})),t.coatRoughnessTexture&&(t.coatRoughnessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/coatRoughnessTexture`,t.coatRoughnessTexture,c=>{c.name=`${i.name} (Coat Roughness)`,r.coatRoughnessTexture=c}))),t.coatNormalTexture&&(t.coatNormalTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/coatNormalTexture`,t.coatNormalTexture,c=>{c.name=`${i.name} (Coat Normal)`,r.geometryCoatNormalTexture=c,t.coatNormalTexture?.scale!=null&&(r.geometryCoatNormalTextureScale=t.coatNormalTexture.scale)})),r.setNormalMapInversions(!i.getScene().useRightHandedSystem,i.getScene().useRightHandedSystem)),r.coatDarkening=t.coatDarkeningFactor!==void 0?t.coatDarkeningFactor:1,r.coatIor=t.coatIor!==void 0?t.coatIor:1.5;let o=U.White();t.coatColorFactor!==void 0&&o.fromArray(t.coatColorFactor),r.coatColor=o,t.coatColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/coatColorTexture`,t.coatColorTexture,c=>{c.name=`${i.name} (Coat Color)`,r.coatColorTexture=c}));let a=t.coatAnisotropyStrength??0,l=t.coatAnisotropyRotation??0;return r.coatRoughnessAnisotropy=a,r.geometryCoatTangentAngle=l,this.useOpenPBR||r.configureGltfStyleAnisotropy(!0),t.coatAnisotropyTexture&&(t.coatAnisotropyTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/coatAnisotropyTexture`,t.coatAnisotropyTexture,c=>{c.name=`${i.name} (Coat Anisotropy)`,r.geometryCoatTangentTexture=c}))),Promise.all(s).then(()=>{})}};de(nm);fe(nm,!0,n=>new mx(n));var rm="KHR_materials_iridescence",gx=class{constructor(e){this.name=rm,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(rm)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadIridescencePropertiesAsync(r,s,i)),yield Promise.all(o).then(()=>{})}))}_loadIridescencePropertiesAsync(e,t,i){let r=this._loader._getOrCreateMaterialAdapter(i),s=new Array;return r.thinFilmWeight=t.iridescenceFactor??0,r.thinFilmIor=t.iridescenceIor??t.iridescenceIOR??1.3,r.thinFilmThicknessMinimum=t.iridescenceThicknessMinimum??100,r.thinFilmThicknessMaximum=t.iridescenceThicknessMaximum??400,t.iridescenceTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,t.iridescenceTexture,o=>{o.name=`${i.name} (Iridescence)`,r.thinFilmWeightTexture=o})),t.iridescenceThicknessTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,t.iridescenceThicknessTexture,o=>{o.name=`${i.name} (Iridescence Thickness)`,r.thinFilmThicknessTexture=o})),Promise.all(s).then(()=>{})}};de(rm);fe(rm,!0,n=>new gx(n));var sm="KHR_materials_anisotropy",_x=class{constructor(e){this.name=sm,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(sm)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){let o=new Array;o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadAnisotropyPropertiesAsync(r,s,i)),yield Promise.all(o)}))}_loadAnisotropyPropertiesAsync(e,t,i){return S(this,null,function*(){let r=this._loader._getOrCreateMaterialAdapter(i),s=new Array,o=t.anisotropyStrength??0,a=t.anisotropyRotation??0;r.specularRoughnessAnisotropy=o,r.geometryTangentAngle=a;let l=t.extensions??{};(!l.EXT_materials_anisotropy_openpbr||!l.EXT_materials_anisotropy_openpbr.openPbrAnisotropyEnabled)&&r.configureGltfStyleAnisotropy(!0),t.anisotropyTexture&&(t.anisotropyTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/anisotropyTexture`,t.anisotropyTexture,c=>{c.name=`${i.name} (Anisotropy Intensity)`,r.geometryTangentTexture=c}))),yield Promise.all(s)})}};de(sm);fe(sm,!0,n=>new _x(n));var om="KHR_materials_emissive_strength",yx=class{constructor(e){this.name=om,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(om)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){return yield this._loader.loadMaterialPropertiesAsync(e,t,i),this._loadEmissiveProperties(r,s,i),yield Promise.resolve()}))}_loadEmissiveProperties(e,t,i){if(t.emissiveStrength!==void 0){let r=this._loader._getOrCreateMaterialAdapter(i);r.emissionLuminance=t.emissiveStrength}}};de(om);fe(om,!0,n=>new yx(n));var am="KHR_materials_sheen",vx=class{constructor(e){this.name=am,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(am)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadSheenPropertiesAsync(r,s,i)),yield Promise.all(o).then(()=>{})}))}_loadSheenPropertiesAsync(e,t,i){let r=this._loader._getOrCreateMaterialAdapter(i),s=new Array;r.configureFuzz();let o=t.sheenColorFactor!==void 0?U.FromArray(t.sheenColorFactor):U.Black(),a=t.sheenRoughnessFactor!==void 0?t.sheenRoughnessFactor:0;return r.fuzzWeight=1,r.fuzzColor=o,r.fuzzRoughness=a,t.sheenColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,t.sheenColorTexture,l=>{l.name=`${i.name} (Sheen Color)`,r.fuzzColorTexture=l})),t.sheenRoughnessTexture&&(t.sheenRoughnessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,t.sheenRoughnessTexture,l=>{l.name=`${i.name} (Sheen Roughness)`,r.fuzzRoughnessTexture=l}))),Promise.all(s).then(()=>{})}};de(am);fe(am,!0,n=>new vx(n));var lm="KHR_materials_fuzz",bx=class{constructor(e){this.name=lm,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(lm)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadFuzzPropertiesAsync(r,s,i)),yield Promise.all(o).then(()=>{})}))}_loadFuzzPropertiesAsync(e,t,i){let r=this._loader._getOrCreateMaterialAdapter(i),s=new Array;return r.configureFuzz(),r.fuzzWeight=t.fuzzFactor!==void 0?t.fuzzFactor:0,r.fuzzColor=t.fuzzColorFactor!==void 0?U.FromArray(t.fuzzColorFactor):U.White(),r.fuzzRoughness=t.fuzzRoughnessFactor!==void 0?t.fuzzRoughnessFactor:.5,t.fuzzTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/fuzzTexture`,t.fuzzTexture,o=>{o.name=`${i.name} (Fuzz)`,r.fuzzWeightTexture=o})),t.fuzzColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/fuzzColorTexture`,t.fuzzColorTexture,o=>{o.name=`${i.name} (Fuzz Color)`,r.fuzzColorTexture=o})),t.fuzzRoughnessTexture&&(t.fuzzRoughnessTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/fuzzRoughnessTexture`,t.fuzzRoughnessTexture,o=>{o.name=`${i.name} (Fuzz Roughness)`,r.fuzzRoughnessTexture=o}))),Promise.all(s).then(()=>{})}};de(lm);fe(lm,!0,n=>new bx(n));var cm="KHR_materials_specular",xx=class{constructor(e){this.name=cm,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(cm)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){let o=new Array;o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadSpecularPropertiesAsync(r,s,i));let a=this._loader._getOrCreateMaterialAdapter(i);return s.extensions&&s.extensions.EXT_materials_specular_edge_color&&s.extensions.EXT_materials_specular_edge_color.specularEdgeColorEnabled&&a.enableSpecularEdgeColor(!0),yield Promise.all(o).then(()=>{})}))}_loadSpecularPropertiesAsync(e,t,i){let r=this._loader._getOrCreateMaterialAdapter(i),s=new Array;return r.specularWeight=t.specularFactor??1,r.specularColor=t.specularColorFactor!==void 0?U.FromArray(t.specularColorFactor):new U(1,1,1),t.specularTexture&&(t.specularTexture.nonColorData=!0,s.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,t.specularTexture,o=>{o.name=`${i.name} (Specular)`,r.specularWeightTexture=o}))),t.specularColorTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,t.specularColorTexture,o=>{o.name=`${i.name} (Specular Color)`,r.specularColorTexture=o})),Promise.all(s).then(()=>{})}};de(cm);fe(cm,!0,n=>new xx(n));var um="KHR_materials_ior",fk=(()=>{class n{constructor(t){this.name=um,this.order=180,this._loader=t,this.enabled=this._loader.isExtensionUsed(um)}dispose(){this._loader=null}loadMaterialPropertiesAsync(t,i,r){return ge.LoadExtensionAsync(t,i,this.name,(s,o)=>S(this,null,function*(){let a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(t,i,r)),a.push(this._loadIorPropertiesAsync(s,o,r)),yield Promise.all(a).then(()=>{})}))}_loadIorPropertiesAsync(t,i,r){let s=this._loader._getOrCreateMaterialAdapter(r),o=i.ior!==void 0?i.ior:n._DEFAULT_IOR;return s.specularIor=o,Promise.resolve()}}return n._DEFAULT_IOR=1.5,n})();de(um);fe(um,!0,n=>new fk(n));var xi="KHR_materials_variants",Cx=class n{constructor(e){this.name=xi,this._loader=e,this.enabled=this._loader.isExtensionUsed(xi)&&!this._loader.parent.skipMaterials}dispose(){this._loader=null}static GetAvailableVariants(e){let t=this._GetExtensionMetadata(e);return t?Object.keys(t.variants):[]}getAvailableVariants(e){return n.GetAvailableVariants(e)}static SelectVariant(e,t){let i=this._GetExtensionMetadata(e);if(!i)throw new Error(`Cannot select variant on a glTF mesh that does not have the ${xi} extension`);let r=s=>{let o=i.variants[s];if(o)for(let a of o)a.mesh.material=a.material};if(t instanceof Array)for(let s of t)r(s);else r(t);i.lastSelected=t}selectVariant(e,t){n.SelectVariant(e,t)}static Reset(e){let t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot reset on a glTF mesh that does not have the ${xi} extension`);for(let i of t.original)i.mesh.material=i.material;t.lastSelected=null}reset(e){n.Reset(e)}static GetLastSelectedVariant(e){let t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${xi} extension`);return t.lastSelected}getLastSelectedVariant(e){return n.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){return e?._internalMetadata?.gltf?.[xi]||null}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._variants=t.variants}}onReady(){let e=this._loader.rootBabylonMesh;if(e){let t=this._loader.parent.extensionOptions[xi];t?.defaultVariant&&n.SelectVariant(e,t.defaultVariant),t?.onLoaded?.({get variants(){return n.GetAvailableVariants(e)},get selectedVariant(){let i=n.GetLastSelectedVariant(e);return i?Array.isArray(i)?i[0]:i:n.GetAvailableVariants(e)[0]},set selectedVariant(i){n.SelectVariant(e,i)}})}}_loadMeshPrimitiveAsync(e,t,i,r,s,o){return ge.LoadExtensionAsync(e,s,this.name,(a,l)=>S(this,null,function*(){let c=new Array;return c.push(this._loader._loadMeshPrimitiveAsync(e,t,i,r,s,u=>{if(o(u),u instanceof E){let h=ge._GetDrawMode(e,s.mode),d=this._loader.rootBabylonMesh,f=d?d._internalMetadata=d._internalMetadata||{}:{},p=f.gltf=f.gltf||{},g=p[xi]=p[xi]||{lastSelected:null,original:[],variants:{}};g.original.push({mesh:u,material:u.material});for(let _=0;_<l.mappings.length;++_){let y=l.mappings[_],b=se.Get(`${a}/mappings/${_}/material`,this._loader.gltf.materials,y.material);c.push(this._loader._loadMaterialAsync(`#/materials/${y.material}`,b,u,h,A=>{for(let I=0;I<y.variants.length;++I){let v=y.variants[I],x=se.Get(`/extensions/${xi}/variants/${v}`,this._variants,v);g.variants[x.name]=g.variants[x.name]||[],g.variants[x.name].push({mesh:u,material:A}),u.onClonedObservable.add(C=>{let R=C,M=null,D=R;do{if(D=D.parent,!D)return;M=n._GetExtensionMetadata(D)}while(M===null);if(d&&M===n._GetExtensionMetadata(d)){D._internalMetadata={};for(let W in d._internalMetadata)D._internalMetadata[W]=d._internalMetadata[W];D._internalMetadata.gltf=[];for(let W in d._internalMetadata.gltf)D._internalMetadata.gltf[W]=d._internalMetadata.gltf[W];D._internalMetadata.gltf[xi]={lastSelected:null,original:[],variants:{}};for(let W of M.original)D._internalMetadata.gltf[xi].original.push({mesh:W.mesh,material:W.material});for(let W in M.variants)if(Object.prototype.hasOwnProperty.call(M.variants,W)){D._internalMetadata.gltf[xi].variants[W]=[];for(let ee of M.variants[W])D._internalMetadata.gltf[xi].variants[W].push({mesh:ee.mesh,material:ee.material})}M=D._internalMetadata.gltf[xi]}for(let W of M.original)W.mesh===u&&(W.mesh=R);for(let W of M.variants[x.name])W.mesh===u&&(W.mesh=R)})}}))}}})),yield Promise.all(c).then(([u])=>u)}))}};de(xi);fe(xi,!0,n=>new Cx(n));var Tx=class n{static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:ts.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}constructor(e,t){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options=Y(Y({},n._GetDefaultOptions()),e),this._scene=t,this._scene._transmissionHelper=this,this.onErrorObservable=new F,this._scene.onDisposeObservable.addOnce(()=>{this.dispose()}),this._parseScene(),this._setupRenderTargets()}updateOptions(e){if(!Object.keys(e).filter(s=>this._options[s]!==e[s]).length)return;let i=Y(Y({},this._options),e),r=this._options;this._options=i,i.renderSize!==r.renderSize||i.renderTargetTextureType!==r.renderTargetTextureType||i.generateMipmaps!==r.generateMipmaps||!this._opaqueRenderTarget?this._setupRenderTargets():(this._opaqueRenderTarget.samples=i.samples,this._opaqueRenderTarget.lodGenerationScale=i.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=i.lodGenerationOffset)}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return!!e?.subSurface?.isRefractionEnabled}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),z.SetImmediate(()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,this._transparentMeshesCache.indexOf(e)===-1&&this._transparentMeshesCache.push(e)):this._opaqueMeshesCache.indexOf(e)===-1&&this._opaqueMeshesCache.push(e)})}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let t=this._transparentMeshesCache.indexOf(e);t!==-1&&this._transparentMeshesCache.splice(t,1),t=this._opaqueMeshesCache.indexOf(e),t!==-1&&this._opaqueMeshesCache.splice(t,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){let t=this._transparentMeshesCache.indexOf(e),i=this._opaqueMeshesCache.indexOf(e);if(this._shouldRenderAsTransmission(e.material)){if(e.material){let s=e.material.subSurface;s&&(s.refractionTexture=this._opaqueRenderTarget)}i!==-1?(this._opaqueMeshesCache.splice(i,1),this._transparentMeshesCache.push(e)):t===-1&&this._transparentMeshesCache.push(e)}else t!==-1?(this._transparentMeshesCache.splice(t,1),this._opaqueMeshesCache.push(e)):i===-1&&this._opaqueMeshesCache.push(e)}_isRenderTargetValid(){return this._opaqueRenderTarget?.getInternalTexture()!==null}_setupRenderTargets(){this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new hi("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=this._options.clearColor?.clone()??this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples,this._opaqueRenderTarget.renderSprites=!0,this._opaqueRenderTarget.renderParticles=!0,this._opaqueRenderTarget.disableImageProcessing=!0;let e;this._opaqueRenderTarget.onBeforeBindObservable.add(t=>{e=this._scene.environmentIntensity,this._scene.environmentIntensity=1,this._options.clearColor?t.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(t.clearColor,this._scene.getEngine().useExactSrgbConversions)}),this._opaqueRenderTarget.onAfterUnbindObservable.add(()=>{this._scene.environmentIntensity=e});for(let t of this._transparentMeshesCache)this._shouldRenderAsTransmission(t.material)&&(t.material.refractionTexture=this._opaqueRenderTarget)}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}},hm="KHR_materials_transmission",Sx=class{constructor(e){this.name=hm,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(hm),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadTransparentPropertiesAsync(r,t,i,s)),yield Promise.all(o).then(()=>{})}))}_loadTransparentPropertiesAsync(e,t,i,r){let s=this._loader._getOrCreateMaterialAdapter(i),o=r.transmissionFactor!==void 0?r.transmissionFactor:0;if(o===0)return Promise.resolve();if(s.configureTransmission(),s.transmissionWeight=o,o>0){let l=i.getScene();l._transmissionHelper?l._transmissionHelper?._isRenderTargetValid()||l._transmissionHelper?._setupRenderTargets():new Tx({},i.getScene())}let a=Promise.resolve(null);return r.transmissionTexture&&(r.transmissionTexture.nonColorData=!0,a=this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,r.transmissionTexture,l=>{l.name=`${i.name} (Transmission)`,s.transmissionWeightTexture=l})),a.then(()=>{})}};de(hm);fe(hm,!0,n=>new Sx(n));var dm="KHR_materials_diffuse_transmission",Ix=class{constructor(e){this.name=dm,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(dm),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadTranslucentPropertiesAsync(r,t,i,s)),yield Promise.all(o).then(()=>{})}))}_loadTranslucentPropertiesAsync(e,t,i,r){let s=this._loader._getOrCreateMaterialAdapter(i);s.configureSubsurface(),s.subsurfaceWeight=r.diffuseTransmissionFactor??0,s.subsurfaceColor=r.diffuseTransmissionColorFactor!==void 0?U.FromArray(r.diffuseTransmissionColorFactor):U.White();let o=new Array;return r.diffuseTransmissionTexture&&(r.diffuseTransmissionTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTransmissionTexture`,r.diffuseTransmissionTexture).then(a=>{a.name=`${i.name} (Diffuse Transmission)`,s.subsurfaceWeightTexture=a}))),r.diffuseTransmissionColorTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTransmissionColorTexture`,r.diffuseTransmissionColorTexture).then(a=>{a.name=`${i.name} (Diffuse Transmission Color)`,s.subsurfaceColorTexture=a})),Promise.all(o).then(()=>{})}};de(dm);fe(dm,!0,n=>new Ix(n));var fm="KHR_materials_volume",Ax=class{constructor(e){this.name=fm,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(fm),this.enabled&&this._loader._disableInstancedMesh++}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadVolumePropertiesAsync(r,t,i,s)),yield Promise.all(o).then(()=>{})}))}_loadVolumePropertiesAsync(e,t,i,r){let s=this._loader._getOrCreateMaterialAdapter(i);if(s.transmissionWeight===0&&s.subsurfaceWeight===0||!r.thicknessFactor)return Promise.resolve();s.transmissionDepth=r.attenuationDistance!==void 0?r.attenuationDistance:Number.MAX_VALUE,s.transmissionColor=r.attenuationColor!==void 0&&r.attenuationColor.length==3?U.FromArray(r.attenuationColor):U.White(),s.volumeThickness=r.thicknessFactor??0;let o=new Array;return r.thicknessTexture&&(r.thicknessTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/thicknessTexture`,r.thicknessTexture,a=>{a.name=`${i.name} (Thickness)`,s.volumeThicknessTexture=a}))),Promise.all(o).then(()=>{})}};de(fm);fe(fm,!0,n=>new Ax(n));var pm="KHR_materials_dispersion",Ex=class{constructor(e){this.name=pm,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(pm)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadDispersionPropertiesAsync(r,t,i,s)),yield Promise.all(o).then(()=>{})}))}_loadDispersionPropertiesAsync(e,t,i,r){let s=this._loader._getOrCreateMaterialAdapter(i);return s.transmissionWeight>0||!r.dispersion||(s.transmissionDispersionAbbeNumber=20/r.dispersion),Promise.resolve()}};de(pm);fe(pm,!0,n=>new Ex(n));var mm="KHR_materials_diffuse_roughness",wx=class{constructor(e){this.name=mm,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(mm)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadDiffuseRoughnessPropertiesAsync(r,s,i)),yield Promise.all(o).then(()=>{})}))}_loadDiffuseRoughnessPropertiesAsync(e,t,i){let r=this._loader._getOrCreateMaterialAdapter(i),s=new Array;return r.baseDiffuseRoughness=t.diffuseRoughnessFactor??0,t.diffuseRoughnessTexture&&s.push(this._loader.loadTextureInfoAsync(`${e}/diffuseRoughnessTexture`,t.diffuseRoughnessTexture,o=>{o.name=`${i.name} (Diffuse Roughness)`,r.baseDiffuseRoughnessTexture=o})),Promise.all(s).then(()=>{})}};de(mm);fe(mm,!0,n=>new wx(n));var gm="KHR_mesh_quantization",Mx=class{constructor(e){this.name=gm,this.enabled=e.isExtensionUsed(gm)}dispose(){}};de(gm);fe(gm,!0,n=>new Mx(n));var _m="KHR_texture_basisu",Dx=class{constructor(e){this.name=_m,this._loader=e,this.enabled=e.isExtensionUsed(_m)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){let o=t.sampler==null?ge.DefaultSampler:se.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=se.Get(`${r}/source`,this._loader.gltf.images,s.source);return yield this._loader._createTextureAsync(e,o,a,l=>{i(l)},t._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!t._textureInfo.nonColorData)}))}};de(_m);fe(_m,!0,n=>new Dx(n));var ym="KHR_texture_transform",Rx=class{constructor(e){this.name=ym,this._loader=e,this.enabled=this._loader.isExtensionUsed(ym)}dispose(){this._loader=null}loadTextureInfoAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){return yield this._loader.loadTextureInfoAsync(e,t,o=>{if(!(o instanceof Z))throw new Error(`${r}: Texture type not supported`);s.offset&&(o.uOffset=s.offset[0],o.vOffset=s.offset[1]),o.uRotationCenter=0,o.vRotationCenter=0,s.rotation&&(o.wAng=-s.rotation),s.scale&&(o.uScale=s.scale[0],o.vScale=s.scale[1]),s.texCoord!=null&&(o.coordinatesIndex=s.texCoord),i(o)})}))}};de(ym);fe(ym,!0,n=>new Rx(n));var vm="KHR_xmp_json_ld",Px=class{constructor(e){this.name=vm,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(vm)}dispose(){this._loader=null}onLoading(){if(this._loader.rootBabylonMesh===null)return;let e=this._loader.gltf.extensions?.KHR_xmp_json_ld,t=this._loader.gltf.asset?.extensions?.KHR_xmp_json_ld;if(e&&t){let i=+t.packet;e.packets&&i<e.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=e.packets[i])}}};de(vm);fe(vm,!0,n=>new Px(n));function vs(n,e,t,i){return U.FromArray(e,t).scale(i)}function pk(n,e,t,i){return e[t+3]*i}function nt(n,e,t,i){return e[t]*i}function Nx(n,e,t,i){return-e[t]*i}function bm(n,e,t,i){return e[t+1]*i}function rM(n,e,t,i){return e[t]*i*2}function ai(n){return{scale:[new it(H.ANIMATIONTYPE_FLOAT,`${n}.uScale`,nt,()=>2),new it(H.ANIMATIONTYPE_FLOAT,`${n}.vScale`,bm,()=>2)],offset:[new it(H.ANIMATIONTYPE_FLOAT,`${n}.uOffset`,nt,()=>2),new it(H.ANIMATIONTYPE_FLOAT,`${n}.vOffset`,bm,()=>2)],rotation:[new it(H.ANIMATIONTYPE_FLOAT,`${n}.wAng`,Nx,()=>1)]}}var ur=class extends wc{buildAnimations(e,t,i,r){return[{babylonAnimatable:e._babylonCamera,babylonAnimation:this._buildAnimation(t,i,r)}]}},it=class extends wc{buildAnimations(e,t,i,r){let s=[];for(let o in e._data)s.push({babylonAnimatable:e._data[o].babylonMaterial,babylonAnimation:this._buildAnimation(t,i,r)});return s}},wn=class extends wc{buildAnimations(e,t,i,r){return[{babylonAnimatable:e._babylonLight,babylonAnimation:this._buildAnimation(t,i,r)}]}},Ox=class extends wc{buildAnimations(e,t,i,r){return e._primitiveBabylonMeshes?e._primitiveBabylonMeshes.map(s=>({babylonAnimatable:s,babylonAnimation:this._buildAnimation(t,i,r)})):[]}};ie("/cameras/{}/orthographic/xmag",[new ur(H.ANIMATIONTYPE_FLOAT,"orthoLeft",Nx,()=>1),new ur(H.ANIMATIONTYPE_FLOAT,"orthoRight",bm,()=>1)]);ie("/cameras/{}/orthographic/ymag",[new ur(H.ANIMATIONTYPE_FLOAT,"orthoBottom",Nx,()=>1),new ur(H.ANIMATIONTYPE_FLOAT,"orthoTop",bm,()=>1)]);ie("/cameras/{}/orthographic/zfar",[new ur(H.ANIMATIONTYPE_FLOAT,"maxZ",nt,()=>1)]);ie("/cameras/{}/orthographic/znear",[new ur(H.ANIMATIONTYPE_FLOAT,"minZ",nt,()=>1)]);ie("/cameras/{}/perspective/yfov",[new ur(H.ANIMATIONTYPE_FLOAT,"fov",nt,()=>1)]);ie("/cameras/{}/perspective/zfar",[new ur(H.ANIMATIONTYPE_FLOAT,"maxZ",nt,()=>1)]);ie("/cameras/{}/perspective/znear",[new ur(H.ANIMATIONTYPE_FLOAT,"minZ",nt,()=>1)]);ie("/materials/{}/pbrMetallicRoughness/baseColorFactor",[new it(H.ANIMATIONTYPE_COLOR3,"albedoColor",vs,()=>4),new it(H.ANIMATIONTYPE_FLOAT,"alpha",pk,()=>4)]);ie("/materials/{}/pbrMetallicRoughness/metallicFactor",[new it(H.ANIMATIONTYPE_FLOAT,"metallic",nt,()=>1)]);ie("/materials/{}/pbrMetallicRoughness/metallicFactor",[new it(H.ANIMATIONTYPE_FLOAT,"roughness",nt,()=>1)]);var Fx=ai("albedoTexture");ie("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/scale",Fx.scale);ie("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/offset",Fx.offset);ie("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/rotation",Fx.rotation);var Lx=ai("metallicTexture");ie("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/scale",Lx.scale);ie("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/offset",Lx.offset);ie("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/rotation",Lx.rotation);ie("/materials/{}/emissiveFactor",[new it(H.ANIMATIONTYPE_COLOR3,"emissiveColor",vs,()=>3)]);var Bx=ai("bumpTexture");ie("/materials/{}/normalTexture/scale",[new it(H.ANIMATIONTYPE_FLOAT,"bumpTexture.level",nt,()=>1)]);ie("/materials/{}/normalTexture/extensions/KHR_texture_transform/scale",Bx.scale);ie("/materials/{}/normalTexture/extensions/KHR_texture_transform/offset",Bx.offset);ie("/materials/{}/normalTexture/extensions/KHR_texture_transform/rotation",Bx.rotation);ie("/materials/{}/occlusionTexture/strength",[new it(H.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",nt,()=>1)]);var kx=ai("ambientTexture");ie("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/scale",kx.scale);ie("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/offset",kx.offset);ie("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/rotation",kx.rotation);var Vx=ai("emissiveTexture");ie("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/scale",Vx.scale);ie("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/offset",Vx.offset);ie("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/rotation",Vx.rotation);ie("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyStrength",[new it(H.ANIMATIONTYPE_FLOAT,"anisotropy.intensity",nt,()=>1)]);ie("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyRotation",[new it(H.ANIMATIONTYPE_FLOAT,"anisotropy.angle",nt,()=>1)]);var Gx=ai("anisotropy.texture");ie("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/scale",Gx.scale);ie("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/offset",Gx.offset);ie("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/rotation",Gx.rotation);ie("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatFactor",[new it(H.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",nt,()=>1)]);ie("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessFactor",[new it(H.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",nt,()=>1)]);var Ux=ai("clearCoat.texture");ie("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/scale",Ux.scale);ie("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/offset",Ux.offset);ie("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/rotation",Ux.rotation);var zx=ai("clearCoat.bumpTexture");ie("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/scale",[new it(H.ANIMATIONTYPE_FLOAT,"clearCoat.bumpTexture.level",nt,()=>1)]);ie("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/scale",zx.scale);ie("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/offset",zx.offset);ie("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/rotation",zx.rotation);var Hx=ai("clearCoat.textureRoughness");ie("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/scale",Hx.scale);ie("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/offset",Hx.offset);ie("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/rotation",Hx.rotation);ie("/materials/{}/extensions/KHR_materials_dispersion/dispersionFactor",[new it(H.ANIMATIONTYPE_FLOAT,"subSurface.dispersion",nt,()=>1)]);ie("/materials/{}/extensions/KHR_materials_emissive_strength/emissiveStrength",[new it(H.ANIMATIONTYPE_FLOAT,"emissiveIntensity",nt,()=>1)]);ie("/materials/{}/extensions/KHR_materials_ior/ior",[new it(H.ANIMATIONTYPE_FLOAT,"indexOfRefraction",nt,()=>1)]);ie("/materials/{}/extensions/KHR_materials_iridescence/iridescenceFactor",[new it(H.ANIMATIONTYPE_FLOAT,"iridescence.intensity",nt,()=>1)]);ie("/materials/{}/extensions/KHR_materials_iridescence/iridescenceIor",[new it(H.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",nt,()=>1)]);ie("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessMinimum",[new it(H.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",nt,()=>1)]);ie("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessMaximum",[new it(H.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",nt,()=>1)]);var Wx=ai("iridescence.texture");ie("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/scale",Wx.scale);ie("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/offset",Wx.offset);ie("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/rotation",Wx.rotation);var $x=ai("iridescence.thicknessTexture");ie("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/scale",$x.scale);ie("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/offset",$x.offset);ie("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/rotation",$x.rotation);ie("/materials/{}/extensions/KHR_materials_sheen/sheenColorFactor",[new it(H.ANIMATIONTYPE_COLOR3,"sheen.color",vs,()=>3)]);ie("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessFactor",[new it(H.ANIMATIONTYPE_FLOAT,"sheen.roughness",nt,()=>1)]);var jx=ai("sheen.texture");ie("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/scale",jx.scale);ie("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/offset",jx.offset);ie("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/rotation",jx.rotation);var qx=ai("sheen.textureRoughness");ie("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/scale",qx.scale);ie("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/offset",qx.offset);ie("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/rotation",qx.rotation);ie("/materials/{}/extensions/KHR_materials_specular/specularFactor",[new it(H.ANIMATIONTYPE_FLOAT,"metallicF0Factor",nt,()=>1)]);ie("/materials/{}/extensions/KHR_materials_specular/specularColorFactor",[new it(H.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",vs,()=>3)]);var Yx=ai("metallicReflectanceTexture");ie("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/scale",Yx.scale);ie("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/offset",Yx.offset);ie("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/rotation",Yx.rotation);var Kx=ai("reflectanceTexture");ie("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/scale",Kx.scale);ie("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/offset",Kx.offset);ie("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/rotation",Kx.rotation);ie("/materials/{}/extensions/KHR_materials_transmission/transmissionFactor",[new it(H.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",nt,()=>1)]);var Xx=ai("subSurface.refractionIntensityTexture");ie("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/scale",Xx.scale);ie("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/offset",Xx.offset);ie("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/rotation",Xx.rotation);ie("/materials/{}/extensions/KHR_materials_volume/attenuationColor",[new it(H.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",vs,()=>3)]);ie("/materials/{}/extensions/KHR_materials_volume/attenuationDistance",[new it(H.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",nt,()=>1)]);ie("/materials/{}/extensions/KHR_materials_volume/thicknessFactor",[new it(H.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",nt,()=>1)]);var Zx=ai("subSurface.thicknessTexture");ie("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/scale",Zx.scale);ie("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/offset",Zx.offset);ie("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/rotation",Zx.rotation);ie("/materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionFactor",[new it(H.ANIMATIONTYPE_FLOAT,"subSurface.translucencyIntensity",nt,()=>1)]);var Qx=ai("subSurface.translucencyIntensityTexture");ie("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/scale",Qx.scale);ie("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/offset",Qx.offset);ie("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/rotation",Qx.rotation);ie("/materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorFactor",[new it(H.ANIMATIONTYPE_COLOR3,"subSurface.translucencyColor",vs,()=>3)]);var Jx=ai("subSurface.translucencyColorTexture");ie("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/scale",Jx.scale);ie("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/offset",Jx.offset);ie("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/rotation",Jx.rotation);ie("/extensions/KHR_lights_punctual/lights/{}/color",[new wn(H.ANIMATIONTYPE_COLOR3,"diffuse",vs,()=>3)]);ie("/extensions/KHR_lights_punctual/lights/{}/intensity",[new wn(H.ANIMATIONTYPE_FLOAT,"intensity",nt,()=>1)]);ie("/extensions/KHR_lights_punctual/lights/{}/range",[new wn(H.ANIMATIONTYPE_FLOAT,"range",nt,()=>1)]);ie("/extensions/KHR_lights_punctual/lights/{}/spot/innerConeAngle",[new wn(H.ANIMATIONTYPE_FLOAT,"innerAngle",rM,()=>1)]);ie("/extensions/KHR_lights_punctual/lights/{}/spot/outerConeAngle",[new wn(H.ANIMATIONTYPE_FLOAT,"angle",rM,()=>1)]);ie("/extensions/EXT_lights_area/lights/{}/color",[new wn(H.ANIMATIONTYPE_COLOR3,"diffuse",vs,()=>3)]);ie("/extensions/EXT_lights_area/lights/{}/intensity",[new wn(H.ANIMATIONTYPE_FLOAT,"intensity",nt,()=>1)]);ie("/extensions/EXT_lights_area/lights/{}/size",[new wn(H.ANIMATIONTYPE_FLOAT,"radius",nt,()=>1)]);ie("/extensions/EXT_lights_area/lights/{}/rect/aspect",[new wn(H.ANIMATIONTYPE_FLOAT,"radius",nt,()=>1)]);ie("/nodes/{}/extensions/EXT_lights_ies/color",[new wn(H.ANIMATIONTYPE_COLOR3,"diffuse",vs,()=>3)]);ie("/nodes/{}/extensions/EXT_lights_ies/multiplier",[new wn(H.ANIMATIONTYPE_FLOAT,"intensity",nt,()=>1)]);ie("/nodes/{}/extensions/KHR_node_visibility/visible",[new Ox(H.ANIMATIONTYPE_FLOAT,"isVisible",nt,()=>1)]);var xm="KHR_animation_pointer",eC=class{constructor(e){this.name=xm,this._loader=e,this._pathToObjectConverter=id(this._loader.gltf)}get enabled(){return this._loader.isExtensionUsed(xm)}dispose(){this._loader=null,delete this._pathToObjectConverter}_loadAnimationChannelAsync(e,t,i,r,s){let o=r.target.extensions?.KHR_animation_pointer;if(!o||!this._pathToObjectConverter)return null;r.target.path!=="pointer"&&P.Warn(`${e}/target/path: Value (${r.target.path}) must be (pointer) when using the ${this.name} extension`),r.target.node!=null&&P.Warn(`${e}/target/node: Value (${r.target.node}) must not be present when using the ${this.name} extension`);let a=`${e}/extensions/${this.name}`,l=o.pointer;if(!l)throw new Error(`${a}: Pointer is missing`);try{let c=this._pathToObjectConverter.convert(l);if(!c.info.interpolation)throw new Error(`${a}/pointer: Interpolation is missing`);return this._loader._loadAnimationChannelFromTargetInfoAsync(e,t,i,r,{object:c.object,info:c.info.interpolation},s)}catch{return P.Warn(`${a}/pointer: Invalid pointer (${l}) skipped`),null}}};de(xm);fe(xm,!0,n=>new eC(n));var Cm=class n{constructor(e,t,i){this.frame=e,this.action=t,this.onlyOnce=i,this.isDone=!1}_clone(){return new n(this.frame,this.action,this.onlyOnce)}};var Ks=(()=>{class n{get loop(){return this._loop}set loop(t){t!==this._loop&&(this._loop=t,this.updateOptions({loop:t}))}get currentTime(){if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;if(ne.audioEngine?.audioContext&&(this.isPlaying||this.isPaused)){let t=this.isPaused?0:ne.audioEngine.audioContext.currentTime-this._startTime;return this._currentTime+t}return 0}get spatialSound(){return this._spatialSound}set spatialSound(t){if(t==this._spatialSound)return;let i=this.isPlaying;this.pause(),t?(this._spatialSound=t,this._updateSpatialParameters()):this._disableSpatialSound(),i&&this.play()}constructor(t,i,r,s=null,o){if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new F,this._spatialSound=!1,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._currentTime=0,this._position=m.Zero(),this._localDirection=new m(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=t,r=r||ye.LastCreatedScene,!!r)if(this._scene=r,n._SceneComponentInitialization(r),this._readyToPlayCallback=s,this._customAttenuationFunction=(a,l,c,u,h)=>l<c?a*(1-l/c):0,o&&(this.autoplay=o.autoplay||!1,this._loop=o.loop||!1,o.volume!==void 0&&(this._volume=o.volume),this._spatialSound=o.spatialSound??!1,this.maxDistance=o.maxDistance??100,this.useCustomAttenuation=o.useCustomAttenuation??!1,this.rolloffFactor=o.rolloffFactor||1,this.refDistance=o.refDistance||1,this.distanceModel=o.distanceModel||"linear",this._playbackRate=o.playbackRate||1,this._streaming=o.streaming??!1,this._length=o.length,this._offset=o.offset),ne.audioEngine?.canUseWebAudio&&ne.audioEngine.audioContext){this._soundGain=ne.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);let a=!0;if(i)try{typeof i=="string"?(this._urlType="String",this._url=i):i instanceof ArrayBuffer?this._urlType="ArrayBuffer":i instanceof HTMLMediaElement?this._urlType="MediaElement":i instanceof MediaStream?this._urlType="MediaStream":i instanceof AudioBuffer?this._urlType="AudioBuffer":Array.isArray(i)&&(this._urlType="Array");let l=[],c=!1;switch(this._urlType){case"MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=ne.audioEngine.audioContext.createMediaElementSource(i),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=ne.audioEngine.audioContext.createMediaStreamSource(i),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":i.byteLength>0&&(c=!0,this._soundLoaded(i));break;case"AudioBuffer":this._audioBufferLoaded(i);break;case"String":l.push(i);case"Array":l.length===0&&(l=i);for(let u=0;u<l.length;u++){let h=l[u];if(c=o&&o.skipCodecCheck||h.indexOf(".mp3",h.length-4)!==-1&&ne.audioEngine.isMP3supported||h.indexOf(".ogg",h.length-4)!==-1&&ne.audioEngine.isOGGsupported||h.indexOf(".wav",h.length-4)!==-1||h.indexOf(".m4a",h.length-4)!==-1||h.indexOf(".mp4",h.length-4)!==-1||h.indexOf("blob:")!==-1,c){this._streaming?(this._htmlAudioElement=new Audio(h),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,z.SetCorsBehavior(h,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",()=>{this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback()},{once:!0}),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(h,d=>{this._soundLoaded(d)},void 0,!0,!0,d=>{d&&P.Error("XHR "+d.status+" error on: "+h+"."),P.Error("Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)});break}}break;default:a=!1;break}a?c||(this._isReadyToPlay=!0,this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)):P.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch{P.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),ne.audioEngine&&!ne.audioEngine.WarnedWebAudioUnsupported&&(P.Error("Web Audio is not supported by your browser."),ne.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)}dispose(){ne.audioEngine?.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,this.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement),this._htmlAudioElement=null),this._streamingSource&&(this._streamingSource.disconnect(),this._streamingSource=null),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null),this._clearTimeoutsAndObservers())}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}_audioBufferLoaded(t){ne.audioEngine?.audioContext&&(this._audioBuffer=t,this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback())}_soundLoaded(t){ne.audioEngine?.audioContext&&ne.audioEngine.audioContext.decodeAudioData(t,i=>{this._audioBufferLoaded(i)},i=>{P.Error("Error while decoding audio data for: "+this.name+" / Error: "+i)})}setAudioBuffer(t){ne.audioEngine?.canUseWebAudio&&(this._audioBuffer=t,this._isReadyToPlay=!0)}updateOptions(t){t&&(this.loop=t.loop??this.loop,this.maxDistance=t.maxDistance??this.maxDistance,this.useCustomAttenuation=t.useCustomAttenuation??this.useCustomAttenuation,this.rolloffFactor=t.rolloffFactor??this.rolloffFactor,this.refDistance=t.refDistance??this.refDistance,this.distanceModel=t.distanceModel??this.distanceModel,this._playbackRate=t.playbackRate??this._playbackRate,this._length=t.length??void 0,this.spatialSound=t.spatialSound??this._spatialSound,this._setOffset(t.offset??void 0),this.setVolume(t.volume??this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),this._offset!==void 0&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),this._length!==void 0&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(this._offset|0)+this._length))))}_createSpatialParameters(){ne.audioEngine?.canUseWebAudio&&ne.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=this._soundPanner??ne.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))}_disableSpatialSound(){this._spatialSound&&(this._inputAudioNode=this._soundGain,this._soundPanner?.disconnect(),this._soundPanner=null,this._spatialSound=!1)}_updateSpatialParameters(){this._spatialSound&&(this._soundPanner?this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel):this._createSpatialParameters())}switchPanningModelToHRTF(){this._panningModel="HRTF",this._switchPanningModel()}switchPanningModelToEqualPower(){this._panningModel="equalpower",this._switchPanningModel()}_switchPanningModel(){ne.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)}connectToSoundTrackAudioNode(t){ne.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(t),this._isOutputConnected=!0)}setDirectionalCone(t,i,r){if(i<t){P.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=t,this._coneOuterAngle=i,this._coneOuterGain=r,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(t){if(t!=this._coneInnerAngle){if(this._coneOuterAngle<t){P.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=t,ne.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(t){if(t!=this._coneOuterAngle){if(t<this._coneInnerAngle){P.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=t,ne.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}}setPosition(t){t.equals(this._position)||(this._position.copyFrom(t),ne.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z))}setLocalDirectionToMesh(t){this._localDirection=t,ne.audioEngine?.canUseWebAudio&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this._soundPanner)return;let t=this._connectedTransformNode.getWorldMatrix(),i=m.TransformNormal(this._localDirection,t);i.normalize(),this._soundPanner.orientationX.value=i.x,this._soundPanner.orientationY.value=i.y,this._soundPanner.orientationZ.value=i.z}updateDistanceFromListener(){if(ne.audioEngine?.canUseWebAudio&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){let t=this._scene.audioListenerPositionProvider?this._connectedTransformNode.position.subtract(this._scene.audioListenerPositionProvider()).length():this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,t,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(t){this._customAttenuationFunction=t}play(t,i,r){if(this._isReadyToPlay&&this._scene.audioEnabled&&ne.audioEngine?.audioContext)try{this._clearTimeoutsAndObservers();let s=t?ne.audioEngine?.audioContext.currentTime+t:ne.audioEngine?.audioContext.currentTime;if((!this._soundSource||!this._streamingSource)&&this._spatialSound&&this._soundPanner&&(!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(!this._streamingSource&&this._htmlAudioElement&&(this._streamingSource=ne.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=()=>{this._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource&&(this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode)),this._htmlAudioElement){let o=()=>{if(ne.audioEngine?.unlocked){if(!this._htmlAudioElement)return;this._htmlAudioElement.currentTime=i??0;let a=this._htmlAudioElement.play();a!==void 0&&a.catch(()=>{ne.audioEngine?.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=ne.audioEngine?.onAudioUnlockedObservable.addOnce(()=>{o()}))})}else(this.loop||this.autoplay)&&(this._audioUnlockedObserver=ne.audioEngine?.onAudioUnlockedObservable.addOnce(()=>{o()}))};o()}}else{let o=()=>{if(ne.audioEngine?.audioContext){if(r=r||this._length,i!==void 0&&this._setOffset(i),this._soundSource){let a=this._soundSource;a.onended=()=>{a.disconnect()}}if(this._soundSource=ne.audioEngine?.audioContext.createBufferSource(),this._soundSource&&this._inputAudioNode){this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,i!==void 0&&(this._soundSource.loopStart=i),r!==void 0&&(this._soundSource.loopEnd=(i|0)+r),this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=()=>{this._onended()},s=t?ne.audioEngine?.audioContext.currentTime+t:ne.audioEngine.audioContext.currentTime;let a=((this.isPaused?this.currentTime:0)+(this._offset??0))%this._soundSource.buffer.duration;this._soundSource.start(s,a,this.loop?void 0:r)}}};ne.audioEngine?.audioContext.state==="suspended"?this._tryToPlayTimeout=setTimeout(()=>{ne.audioEngine?.audioContext.state==="suspended"?(ne.audioEngine.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=ne.audioEngine.onAudioUnlockedObservable.addOnce(()=>{o()}))):o()},500):o()}this._startTime=s,this.isPlaying=!0,this.isPaused=!1}catch(s){P.Error("Error while trying to play audio: "+this.name+", "+s.message)}}_onended(){this.isPlaying=!1,this._startTime=0,this._currentTime=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)}stop(t){if(this.isPlaying)if(this._clearTimeoutsAndObservers(),this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):this._streamingSource?.disconnect(),this.isPlaying=!1;else if(ne.audioEngine?.audioContext&&this._soundSource){let i=t?ne.audioEngine.audioContext.currentTime+t:void 0;this._soundSource.onended=()=>{this.isPlaying=!1,this.isPaused=!1,this._startTime=0,this._currentTime=0,this._soundSource&&(this._soundSource.onended=()=>{}),this._onended()},this._soundSource.stop(i)}else this.isPlaying=!1;else this.isPaused&&(this.isPaused=!1,this._startTime=0,this._currentTime=0)}pause(){this.isPlaying&&(this._clearTimeoutsAndObservers(),this._streaming?(this._htmlAudioElement?this._htmlAudioElement.pause():this._streamingSource?.disconnect(),this.isPlaying=!1,this.isPaused=!0):ne.audioEngine?.audioContext&&this._soundSource&&(this._soundSource.onended=()=>{},this._soundSource.stop(),this.isPlaying=!1,this.isPaused=!0,this._currentTime+=ne.audioEngine.audioContext.currentTime-this._startTime))}setVolume(t,i){ne.audioEngine?.canUseWebAudio&&this._soundGain&&(i&&ne.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(ne.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,ne.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(t,ne.audioEngine.audioContext.currentTime+i)):this._soundGain.gain.value=t),this._volume=t}setPlaybackRate(t){this._playbackRate=t,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))}getPlaybackRate(){return this._playbackRate}getVolume(){return this._volume}attachToMesh(t){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=t,this._spatialSound||(this._spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=i=>this._onRegisterAfterWorldMatrixUpdate(i),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(t){if(!t.getBoundingInfo)this.setPosition(t.absolutePosition);else{let r=t.getBoundingInfo();this.setPosition(r.boundingSphere.centerWorld)}ne.audioEngine?.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(this._streaming)return null;{let t=()=>{Cc(()=>this._isReadyToPlay,()=>{r._audioBuffer=this.getAudioBuffer(),r._isReadyToPlay=!0,r.autoplay&&r.play(0,this._offset,this._length)},void 0,300)},i={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},r=new n(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,i);return this.useCustomAttenuation&&r.setAttenuationFunction(this._customAttenuationFunction),r.setPosition(this._position),r.setPlaybackRate(this._playbackRate),t(),r}}getAudioBuffer(){return this._audioBuffer}getSoundSource(){return this._soundSource}getSoundGain(){return this._soundGain}serialize(){let t={name:this.name,url:this._url,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(t.connectedMeshId=this._connectedTransformNode.id),t.position=this._position.asArray(),t.refDistance=this.refDistance,t.distanceModel=this.distanceModel,t.isDirectional=this._isDirectional,t.localDirectionToMesh=this._localDirection.asArray(),t.coneInnerAngle=this._coneInnerAngle,t.coneOuterAngle=this._coneOuterAngle,t.coneOuterGain=this._coneOuterGain),t}static Parse(t,i,r,s){let o=t.name,a;t.url?a=r+t.url:a=r+o;let l={autoplay:t.autoplay,loop:t.loop,volume:t.volume,spatialSound:t.spatialSound,maxDistance:t.maxDistance,rolloffFactor:t.rolloffFactor,refDistance:t.refDistance,distanceModel:t.distanceModel,playbackRate:t.playbackRate},c;if(!s)c=new n(o,a,i,()=>{i.removePendingData(c)},l),i.addPendingData(c);else{let u=()=>{Cc(()=>s._isReadyToPlay,()=>{c._audioBuffer=s.getAudioBuffer(),c._isReadyToPlay=!0,c.autoplay&&c.play(0,c._offset,c._length)},void 0,300)};c=new n(o,new ArrayBuffer(0),i,null,l),u()}if(t.position){let u=m.FromArray(t.position);c.setPosition(u)}if(t.isDirectional&&(c.setDirectionalCone(t.coneInnerAngle||360,t.coneOuterAngle||360,t.coneOuterGain||0),t.localDirectionToMesh)){let u=m.FromArray(t.localDirectionToMesh);c.setLocalDirectionToMesh(u)}if(t.connectedMeshId){let u=i.getMeshById(t.connectedMeshId);u&&c.attachToMesh(u)}return t.metadata&&(c.metadata=t.metadata),c}_setOffset(t){this._offset!==t&&(this.isPaused&&(this.stop(),this.isPaused=!1),this._offset=t)}_clearTimeoutsAndObservers(){this._tryToPlayTimeout&&(clearTimeout(this._tryToPlayTimeout),this._tryToPlayTimeout=null),this._audioUnlockedObserver&&(ne.audioEngine?.onAudioUnlockedObservable.remove(this._audioUnlockedObserver),this._audioUnlockedObserver=null)}}return n._SceneComponentInitialization=e=>{throw Zt("AudioSceneComponent")},n})();le("BABYLON.Sound",Ks);var Tm=class{constructor(e,t,i){if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],t.length!==i.length)throw new Error("Sounds length does not equal weights length");this.loop=e,this._weights=i;let r=0;for(let o of i)r+=o;let s=r>0?1/r:0;for(let o=0;o<this._weights.length;o++)this._weights[o]*=s;this._sounds=t;for(let o of this._sounds)o.onEndedObservable.add(()=>{this._onended()})}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!==this._coneInnerAngle){if(this._coneOuterAngle<e){P.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e;for(let t of this._sounds)t.directionalConeInnerAngle=e}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!==this._coneOuterAngle){if(e<this._coneInnerAngle){P.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e;for(let t of this._sounds)t.directionalConeOuterAngle=e}}get volume(){return this._volume}set volume(e){if(e!==this._volume)for(let t of this._sounds)t.setVolume(e)}_onended(){this._currentIndex!==void 0&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1}pause(){this.isPlaying&&(this.isPaused=!0,this._currentIndex!==void 0&&this._sounds[this._currentIndex].pause())}stop(){this.isPlaying=!1,this._currentIndex!==void 0&&this._sounds[this._currentIndex].stop()}play(e){if(!this.isPaused){this.stop();let i=Math.random(),r=0;for(let s=0;s<this._weights.length;s++)if(r+=this._weights[s],i<=r){this._currentIndex=s;break}}let t=this._sounds[this._currentIndex??0];t.isReady()?t.play(0,this.isPaused?void 0:e):t.autoplay=!0,this.isPlaying=!0,this.isPaused=!1}};var Sm=class{constructor(e,t={}){this.id=-1,this._isInitialized=!1,e=e||ye.LastCreatedScene,e&&(this._scene=e,this.soundCollection=[],this._options=t,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1))}_initializeSoundTrackAudioGraph(){ne.audioEngine?.canUseWebAudio&&ne.audioEngine.audioContext&&(this._outputAudioNode=ne.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(ne.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)}dispose(){if(ne.audioEngine&&ne.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}}addSound(e){this._isInitialized||this._initializeSoundTrackAudioGraph(),ne.audioEngine?.canUseWebAudio&&this._outputAudioNode&&e.connectToSoundTrackAudioNode(this._outputAudioNode),e.soundTrackId!==void 0&&(e.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(e):this._scene.soundTracks&&this._scene.soundTracks[e.soundTrackId].removeSound(e)),this.soundCollection.push(e),e.soundTrackId=this.id}removeSound(e){let t=this.soundCollection.indexOf(e);t!==-1&&this.soundCollection.splice(t,1)}setVolume(e){ne.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.gain.value=e)}switchPanningModelToHRTF(){if(ne.audioEngine?.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToHRTF()}switchPanningModelToEqualPower(){if(ne.audioEngine?.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToEqualPower()}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,ne.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,ne.audioEngine.masterGain))}};var Im=[];var Am=class{constructor(e){this._mainBuses=new Set,this._sounds=new Set,this._soundsArray=null,this._nodes=new Set,this._defaultMainBus=null,this._parameterRampDuration=.01,Im.push(this),typeof e.parameterRampDuration=="number"&&(this.parameterRampDuration=e.parameterRampDuration)}get defaultMainBus(){return this._mainBuses.size===0?null:(this._defaultMainBus||(this._defaultMainBus=Array.from(this._mainBuses)[0]),this._defaultMainBus)}get parameterRampDuration(){return this._parameterRampDuration}set parameterRampDuration(e){this._parameterRampDuration=Math.max(0,e)}get sounds(){return this._soundsArray||(this._soundsArray=Array.from(this._sounds)),this._soundsArray}dispose(){Im.includes(this)&&Im.splice(Im.indexOf(this),1);let e=this._nodes.values();for(let t=e.next();!t.done;t=e.next())t.value.dispose();this._mainBuses.clear(),this._nodes.clear(),this._sounds.clear(),this._disposeSoundsArray(),this._defaultMainBus=null}unlockAsync(){return this.resumeAsync()}_addMainBus(e){this._mainBuses.add(e),this._addNode(e)}_removeMainBus(e){this._mainBuses.delete(e),this._defaultMainBus=null,this._removeNode(e)}_addNode(e){this._nodes.add(e)}_removeNode(e){this._nodes.delete(e)}_addSound(e){this._disposeSoundsArray(),this._sounds.add(e),this._addNode(e)}_removeSound(e){this._disposeSoundsArray(),this._sounds.delete(e),this._removeNode(e)}_disposeSoundsArray(){this._soundsArray&&(this._soundsArray.length=0,this._soundsArray=null)}};var sM={position:m.Zero(),rotation:m.Zero(),rotationQuaternion:new Q};function oM(n){return n.listenerEnabled||n.listenerMinUpdateTime!==void 0||n.listenerPosition!==void 0||n.listenerRotation!==void 0||n.listenerRotationQuaternion!==void 0}var Em=class{};var wm=class extends Em{constructor(){super(),this._attacherComponent=null,this._attacherComponent=new e_(this)}get isAttached(){return this._attacherComponent!==null&&this._attacherComponent.isAttached}attach(e,t=!1,i=3){this._attacherComponent||(this._attacherComponent=new e_(this)),this._attacherComponent.attach(e,t,i)}detach(){this._attacherComponent?.detach()}dispose(){this._attacherComponent?.dispose(),this._attacherComponent=null}setOptions(e){e.listenerMinUpdateTime!==void 0&&(this.minUpdateTime=e.listenerMinUpdateTime),e.listenerPosition&&(this.position=e.listenerPosition.clone()),e.listenerRotationQuaternion?this.rotationQuaternion=e.listenerRotationQuaternion.clone():e.listenerRotation?this.rotation=e.listenerRotation.clone():this.rotationQuaternion=sM.rotationQuaternion.clone(),this.update()}};var tC=L.Zero(),iC=new Q,aM=m.Zero(),lM=m.Zero();function sC(n,e,t){let i=n._audioContext.listener;return i.forwardX&&i.forwardY&&i.forwardZ&&i.positionX&&i.positionY&&i.positionZ&&i.upX&&i.upY&&i.upZ?new nC(n,e,t):new rC(n,e,t)}var Mm=class extends wm{constructor(e,t,i){super(),this._lastPosition=m.Zero(),this._lastRotation=m.Zero(),this._lastRotationQuaternion=new Q,this.position=m.Zero(),this.rotation=m.Zero(),this.rotationQuaternion=new Q,this._listener=e._audioContext.listener,this.engine=e,this._updaterComponent=new b0(this,t,i)}dispose(){super.dispose(),this._updaterComponent.dispose(),this._updaterComponent=null}get minUpdateTime(){return this._updaterComponent.minUpdateTime}set minUpdateTime(e){this._updaterComponent.minUpdateTime=e}update(){this.isAttached?this._attacherComponent?.update():(this._updatePosition(),this._updateRotation())}_updatePosition(){this._lastPosition.equalsWithEpsilon(this.position)||(this._setWebAudioPosition(this.position),this._lastPosition.copyFrom(this.position))}_updateRotation(){if(!this._lastRotationQuaternion.equalsWithEpsilon(this.rotationQuaternion))iC.copyFrom(this.rotationQuaternion),this._lastRotationQuaternion.copyFrom(this.rotationQuaternion);else if(!this._lastRotation.equalsWithEpsilon(this.rotation))Q.FromEulerAnglesToRef(this.rotation.x,this.rotation.y,this.rotation.z,iC),this._lastRotation.copyFrom(this.rotation);else return;L.FromQuaternionToRef(iC,tC),m.TransformNormalToRef(m.RightHandedForwardReadOnly,tC,aM),m.TransformNormalToRef(m.Up(),tC,lM),this._setWebAudioOrientation(aM,lM)}},nC=class extends Mm{constructor(e,t,i){super(e,t,i);let r=e._audioContext.listener;this._forwardX=new Fn(e,r.forwardX),this._forwardY=new Fn(e,r.forwardY),this._forwardZ=new Fn(e,r.forwardZ),this._positionX=new Fn(e,r.positionX),this._positionY=new Fn(e,r.positionY),this._positionZ=new Fn(e,r.positionZ),this._upX=new Fn(e,r.upX),this._upY=new Fn(e,r.upY),this._upZ=new Fn(e,r.upZ)}_setWebAudioPosition(e){this.isAttached&&(this._positionX.isRamping||this._positionY.isRamping||this._positionZ.isRamping)||(this._positionX.targetValue=e.x,this._positionY.targetValue=e.y,this._positionZ.targetValue=e.z)}_setWebAudioOrientation(e,t){this.isAttached&&(this._forwardX.isRamping||this._forwardY.isRamping||this._forwardZ.isRamping||this._upX.isRamping||this._upY.isRamping||this._upZ.isRamping)||(this._forwardX.targetValue=e.x,this._forwardY.targetValue=e.y,this._forwardZ.targetValue=e.z,this._upX.targetValue=t.x,this._upY.targetValue=t.y,this._upZ.targetValue=t.z)}},rC=class extends Mm{_setWebAudioPosition(e){this._listener.setPosition(e.x,e.y,e.z)}_setWebAudioOrientation(e,t){this._listener.setOrientation(e.x,e.y,e.z,t.x,t.y,t.z)}};var Dm=class extends x0{constructor(e){super(e,1)}};var Rm=class extends Dm{constructor(e){super(e),this._setGainNode(new GainNode(e._audioContext))}dispose(){super.dispose(),this._volume.dispose(),this._gainNode.disconnect(),this._destinationNode.disconnect()}get _inNode(){return this._gainNode}set _inNode(e){this._gainNode!==e&&this._setGainNode(e)}get volume(){return this._volume.targetValue}set volume(e){this._volume.targetValue=e}get _destinationNode(){return this.engine._audioDestination}getClassName(){return"_WebAudioMainOut"}setVolume(e,t=null){this._volume.setTargetValue(e,t)}_setGainNode(e){this._gainNode!==e&&(this._gainNode?.disconnect(),e.connect(this._destinationNode),this._volume=new Fn(this.engine,e.gain),this._gainNode=e)}};var Pm=class{constructor(e,t){this._button=null,this._enabled=!0,this._style=null,this._onStateChanged=()=>{this._button&&(this._engine.state==="running"?this._hide():this._show())},this._engine=e;let i=t||ye.LastCreatedEngine?.getInputElement()?.parentElement||document.body,r=(i?.offsetTop||0)+20;this._style=document.createElement("style"),this._style.appendChild(document.createTextNode(`.babylonUnmute{position:absolute;top:${r}px;margin-left:20px;height:40px;width:60px;background-color:rgba(51,51,51,0.7);background-image:url("data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E");background-size:80%;background-repeat:no-repeat;background-position:center;background-position-y:4px;border:none;outline:none;transition:transform 0.125s ease-out;cursor:pointer;z-index:9999;}.babylonUnmute:hover{transform:scale(1.05)}`)),document.head.appendChild(this._style),this._button=document.createElement("button"),this._button.className="babylonUnmute",this._button.id="babylonUnmuteButton",this._button.addEventListener("click",()=>{this._engine.unlockAsync()}),i.appendChild(this._button),this._engine.stateChangedObservable.add(this._onStateChanged)}dispose(){this._button?.remove(),this._button=null,this._style?.remove(),this._style=null,this._engine.stateChangedObservable.removeCallback(this._onStateChanged)}get enabled(){return this._enabled}set enabled(e){this._enabled=e,e?this._engine.state!=="running"&&this._show():this._hide()}_show(){!this._button||!this._enabled||(this._button.style.display="block")}_hide(){this._button&&(this._button.style.display="none")}};var mk={aac:"audio/aac",ac3:"audio/ac3",flac:"audio/flac",m4a:"audio/mp4",mp3:'audio/mpeg; codecs="mp3"',mp4:"audio/mp4",ogg:'audio/ogg; codecs="vorbis"',wav:"audio/wav",webm:'audio/webm; codecs="vorbis"'},Om=class extends Am{constructor(e={}){super(e),this._audioContextStarted=!1,this._destinationNode=null,this._invalidFormats=new Set,this._isUpdating=!1,this._listener=null,this._listenerAutoUpdate=!0,this._listenerMinUpdateTime=0,this._pauseCalled=!1,this._resumeOnInteraction=!0,this._resumeOnPause=!0,this._resumeOnPauseRetryInterval=1e3,this._resumeOnPauseTimerId=null,this._resumePromise=null,this._silentHtmlAudio=null,this._unmuteUI=null,this._updateObservable=null,this._validFormats=new Set,this._volume=1,this._isUsingOfflineAudioContext=!1,this.isReadyPromise=new Promise(t=>{this._resolveIsReadyPromise=t}),this.stateChangedObservable=new F,this.userGestureObservable=new F,this._initAudioContextAsync=()=>S(this,null,function*(){this._audioContext.addEventListener("statechange",this._onAudioContextStateChange),this._mainOut=new Rm(this),this._mainOut.volume=this._volume,yield this.createMainBusAsync("default")}),this._onAudioContextStateChange=()=>{this.state==="running"&&(clearInterval(this._resumeOnPauseTimerId),this._audioContextStarted=!0,this._resumePromise=null),(this.state==="suspended"||this.state==="interrupted")&&this._audioContextStarted&&this._resumeOnPause&&!this._pauseCalled&&(clearInterval(this._resumeOnPauseTimerId),this._resumeOnPauseTimerId=setInterval(()=>{this.resumeAsync()},this._resumeOnPauseRetryInterval)),this.stateChangedObservable.notifyObservers(this.state)},this._onUserGestureAsync=()=>S(this,null,function*(){if(this._resumeOnInteraction&&(yield this._audioContext.resume()),!this._silentHtmlAudio){this._silentHtmlAudio=document.createElement("audio");let t=this._silentHtmlAudio;t.controls=!1,t.preload="auto",t.loop=!0,t.src="data:audio/wav;base64,UklGRjAAAABXQVZFZm10IBAAAAABAAEAgLsAAAB3AQACABAAZGF0YQwAAAAAAAEA/v8CAP//AQA=",t.play()}this.userGestureObservable.notifyObservers()}),this._startUpdating=()=>{if(!this._isUpdating)if(this._isUpdating=!0,this.state==="running")this._update();else{let t=()=>{this.state==="running"&&(this._update(),this.stateChangedObservable.removeCallback(t))};this.stateChangedObservable.add(t)}},this._update=()=>{this._updateObservable?.hasObservers()?(this._updateObservable.notifyObservers(),requestAnimationFrame(this._update)):this._isUpdating=!1},typeof e.listenerAutoUpdate=="boolean"&&(this._listenerAutoUpdate=e.listenerAutoUpdate),typeof e.listenerMinUpdateTime=="number"&&(this._listenerMinUpdateTime=e.listenerMinUpdateTime),this._volume=e.volume??1,e.audioContext?(this._isUsingOfflineAudioContext=e.audioContext instanceof OfflineAudioContext,this._audioContext=e.audioContext):this._audioContext=new AudioContext,e.disableDefaultUI||(this._unmuteUI=new Pm(this,e.defaultUIParentElement))}_initAsync(e){return S(this,null,function*(){this._resumeOnInteraction=typeof e.resumeOnInteraction=="boolean"?e.resumeOnInteraction:!0,this._resumeOnPause=typeof e.resumeOnPause=="boolean"?e.resumeOnPause:!0,this._resumeOnPauseRetryInterval=e.resumeOnPauseRetryInterval??1e3,document.addEventListener("click",this._onUserGestureAsync),yield this._initAudioContextAsync(),oM(e)&&(this._listener=sC(this,this._listenerAutoUpdate,this._listenerMinUpdateTime),this._listener.setOptions(e)),this._resolveIsReadyPromise()})}get currentTime(){return this._audioContext.currentTime??0}get _inNode(){return this._audioContext.destination}get mainOut(){return this._mainOut}get listener(){return this._listener??(this._listener=sC(this,this._listenerAutoUpdate,this._listenerMinUpdateTime))}get state(){return this._isUsingOfflineAudioContext?"running":this._audioContext.state}get volume(){return this._volume}set volume(e){this._volume!==e&&(this._volume=e,this._mainOut&&(this._mainOut.volume=e))}get _audioDestination(){return this._destinationNode?this._destinationNode:this._destinationNode=this._audioContext.destination}set _audioDestination(e){this._destinationNode=e}get _unmuteUIEnabled(){return this._unmuteUI?this._unmuteUI.enabled:!1}set _unmuteUIEnabled(e){this._unmuteUI&&(this._unmuteUI.enabled=e)}createBusAsync(i){return S(this,arguments,function*(e,t={}){let r=yield import("./chunk-RBRW3HDK.js"),s=new r._WebAudioBus(e,this,t);return yield s._initAsync(t),s})}createMainBusAsync(i){return S(this,arguments,function*(e,t={}){let r=yield import("./chunk-B6B52PFK.js"),s=new r._WebAudioMainBus(e,this);return yield s._initAsync(t),s})}createMicrophoneSoundSourceAsync(e,t){return S(this,null,function*(){let i;try{i=yield navigator.mediaDevices.getUserMedia({audio:!0})}catch(r){throw new Error("Unable to access microphone: "+r)}return yield this.createSoundSourceAsync(e,new MediaStreamAudioSourceNode(this._audioContext,{mediaStream:i}),Y({outBusAutoDefault:!1},t))})}createSoundAsync(r,s){return S(this,arguments,function*(e,t,i={}){let o=yield import("./chunk-PV5JN4D3.js"),a=new o._WebAudioStaticSound(e,this,i);return yield a._initAsync(t,i),a})}createSoundBufferAsync(i){return S(this,arguments,function*(e,t={}){let r=yield import("./chunk-PV5JN4D3.js"),s=new r._WebAudioStaticSoundBuffer(this);return yield s._initAsync(e,t),s})}createSoundSourceAsync(r,s){return S(this,arguments,function*(e,t,i={}){let o=yield import("./chunk-ODOERIEW.js"),a=new o._WebAudioSoundSource(e,t,this,i);return yield a._initAsync(i),a})}createStreamingSoundAsync(r,s){return S(this,arguments,function*(e,t,i={}){let o=yield import("./chunk-XHLOPVK5.js"),a=new o._WebAudioStreamingSound(e,this,i);return yield a._initAsync(t,i),a})}dispose(){super.dispose(),this._listener?.dispose(),this._listener=null,this._audioContext.state!=="closed"&&!this._isUsingOfflineAudioContext&&this._audioContext.close(),document.removeEventListener("click",this._onUserGestureAsync),this._audioContext.removeEventListener("statechange",this._onAudioContextStateChange),this._silentHtmlAudio?.remove(),this._updateObservable?.clear(),this._updateObservable=null,this._unmuteUI?.dispose(),this._unmuteUI=null,this.stateChangedObservable.clear()}flagInvalidFormat(e){this._invalidFormats.add(e)}isFormatValid(e){if(this._validFormats.has(e))return!0;if(this._invalidFormats.has(e))return!1;let t=mk[e];return t===void 0?!1:new Audio().canPlayType(t)===""?(this._invalidFormats.add(e),!1):(this._validFormats.add(e),!0)}pauseAsync(){return S(this,null,function*(){yield this._audioContext.suspend(),this._pauseCalled=!0})}resumeAsync(){return this._pauseCalled=!1,this._resumePromise?this._resumePromise:(this._resumePromise=this._audioContext.resume(),this._resumePromise)}setVolume(e,t=null){if(this._mainOut)this._mainOut.setVolume(e,t);else throw new Error("Main output not initialized yet.")}_addMainBus(e){super._addMainBus(e)}_removeMainBus(e){super._removeMainBus(e)}_addNode(e){super._addNode(e)}_removeNode(e){super._removeNode(e)}_addSound(e){super._addSound(e)}_removeSound(e){super._removeSound(e)}_addUpdateObserver(e){this._updateObservable||(this._updateObservable=new F),this._updateObservable.add(e),this._startUpdating()}_removeUpdateObserver(e){this._updateObservable&&this._updateObservable.removeCallback(e)}};ne.AudioEngineFactory=(n,e,t)=>new oC(n,e,t);var oC=class{get masterGain(){return this._masterGain}set masterGain(e){this._masterGain=this._v2.mainOut._inNode=e}get useCustomUnlockedButton(){return this._useCustomUnlockedButton}set useCustomUnlockedButton(e){this._useCustomUnlockedButton=e,this._v2._unmuteUIEnabled=!e}get audioContext(){return this._v2.state==="running"&&this._triggerRunningStateAsync(),this._v2._audioContext}constructor(e=null,t=null,i=null){this._audioContext=null,this._tryToRun=!1,this._useCustomUnlockedButton=!1,this.canUseWebAudio=!0,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!1,this.onAudioUnlockedObservable=new F,this.onAudioLockedObservable=new F;let r=new Om({audioContext:t||void 0,defaultUIParentElement:e?.parentElement?e.parentElement:void 0});r._unmuteUIEnabled=!1,this._masterGain=new GainNode(r._audioContext),r._audioDestination=i,r.stateChangedObservable.add(s=>{s==="running"?(this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)):(this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this))}),r._initAsync({resumeOnInteraction:!1}).then(()=>{let s=r.defaultMainBus._outNode;s&&(s.disconnect(r.mainOut._inNode),s.connect(this._masterGain)),r.mainOut._inNode=this._masterGain,r.stateChangedObservable.notifyObservers(r.state)}),this.isMP3supported=r.isFormatValid("mp3"),this.isOGGsupported=r.isFormatValid("ogg"),this._v2=r}lock(){this._v2._audioContext.suspend(),this._useCustomUnlockedButton||(this._v2._unmuteUIEnabled=!0)}unlock(){if(this._audioContext?.state==="running"){this.unlocked||(this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this));return}this._triggerRunningStateAsync()}_resumeAudioContextOnStateChange(){this._audioContext?.addEventListener("statechange",()=>{this.unlocked&&this._audioContext?.state!=="running"&&this._resumeAudioContextAsync()},{once:!0,passive:!0,signal:AbortSignal.timeout(3e3)})}_resumeAudioContextAsync(){return this._v2._isUsingOfflineAudioContext?Promise.resolve():this._v2._audioContext.resume()}dispose(){this._v2.dispose(),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()}getGlobalVolume(){return this.masterGain.gain.value}setGlobalVolume(e){this.masterGain.gain.value=e}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._v2._audioContext.destination)}_triggerRunningStateAsync(){return S(this,null,function*(){this._tryToRun||(this._tryToRun=!0,yield this._resumeAudioContextAsync(),this._tryToRun=!1,this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this))})}};var Nm={},aC={};function Xs(n,e){Nm[n]=e}function cM(n,e){aC[n]=e}function Fm(n){return aC[n]?aC[n]:null}function uM(n,e,t,i){for(let r in Nm)Object.prototype.hasOwnProperty.call(Nm,r)&&Nm[r](n,e,t,i)}Xs(Oe.NAME_AUDIO,(n,e,t,i)=>{let r=[],s;if(t.sounds=t.sounds||[],n.sounds!==void 0&&n.sounds!==null)for(let o=0,a=n.sounds.length;o<a;o++){let l=n.sounds[o];ne.audioEngine?.canUseWebAudio?(l.url||(l.url=l.name),r[l.url]?t.sounds.push(Ks.Parse(l,e,i,r[l.url])):(s=Ks.Parse(l,e,i),r[l.url]=s,t.sounds.push(s))):t.sounds.push(new Ks(l.name,null,e))}r=[]});Object.defineProperty(Ce.prototype,"mainSoundTrack",{get:function(){let n=this._getComponent(Oe.NAME_AUDIO);return n||(n=new Hi(this),this._addComponent(n)),this._mainSoundTrack||(this._mainSoundTrack=new Sm(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0});Ce.prototype.getSoundByName=function(n){let e;for(e=0;e<this.mainSoundTrack.soundCollection.length;e++)if(this.mainSoundTrack.soundCollection[e].name===n)return this.mainSoundTrack.soundCollection[e];if(this.soundTracks){for(let t=0;t<this.soundTracks.length;t++)for(e=0;e<this.soundTracks[t].soundCollection.length;e++)if(this.soundTracks[t].soundCollection[e].name===n)return this.soundTracks[t].soundCollection[e]}return null};Object.defineProperty(Ce.prototype,"audioEnabled",{get:function(){let n=this._getComponent(Oe.NAME_AUDIO);return n||(n=new Hi(this),this._addComponent(n)),n.audioEnabled},set:function(n){let e=this._getComponent(Oe.NAME_AUDIO);e||(e=new Hi(this),this._addComponent(e)),n?e.enableAudio():e.disableAudio()},enumerable:!0,configurable:!0});Object.defineProperty(Ce.prototype,"headphone",{get:function(){let n=this._getComponent(Oe.NAME_AUDIO);return n||(n=new Hi(this),this._addComponent(n)),n.headphone},set:function(n){let e=this._getComponent(Oe.NAME_AUDIO);e||(e=new Hi(this),this._addComponent(e)),n?e.switchAudioModeForHeadphones():e.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0});Object.defineProperty(Ce.prototype,"audioListenerPositionProvider",{get:function(){let n=this._getComponent(Oe.NAME_AUDIO);return n||(n=new Hi(this),this._addComponent(n)),n.audioListenerPositionProvider},set:function(n){let e=this._getComponent(Oe.NAME_AUDIO);if(e||(e=new Hi(this),this._addComponent(e)),n&&typeof n!="function")throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");e.audioListenerPositionProvider=n},enumerable:!0,configurable:!0});Object.defineProperty(Ce.prototype,"audioListenerRotationProvider",{get:function(){let n=this._getComponent(Oe.NAME_AUDIO);return n||(n=new Hi(this),this._addComponent(n)),n.audioListenerRotationProvider},set:function(n){let e=this._getComponent(Oe.NAME_AUDIO);if(e||(e=new Hi(this),this._addComponent(e)),n&&typeof n!="function")throw new Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");e.audioListenerRotationProvider=n},enumerable:!0,configurable:!0});Object.defineProperty(Ce.prototype,"audioPositioningRefreshRate",{get:function(){let n=this._getComponent(Oe.NAME_AUDIO);return n||(n=new Hi(this),this._addComponent(n)),n.audioPositioningRefreshRate},set:function(n){let e=this._getComponent(Oe.NAME_AUDIO);e||(e=new Hi(this),this._addComponent(e)),e.audioPositioningRefreshRate=n},enumerable:!0,configurable:!0});var Hi=class n{get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}constructor(e){this.name=Oe.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this._cachedCameraDirection=new m,this._cachedCameraPosition=new m,this._lastCheck=0,this._invertMatrixTemp=new L,this._cameraDirectionTemp=new m,e=e||ye.LastCreatedScene,e&&(this.scene=e,e.soundTracks=[],e.sounds=[])}register(){this.scene._afterRenderStage.registerStep(Oe.STEP_AFTERRENDER_AUDIO,this,this._afterRender)}rebuild(){}serialize(e){if(e.sounds=[],this.scene.soundTracks)for(let t=0;t<this.scene.soundTracks.length;t++){let i=this.scene.soundTracks[t];for(let r=0;r<i.soundCollection.length;r++)e.sounds.push(i.soundCollection[r].serialize())}}addFromContainer(e){if(e.sounds)for(let t of e.sounds)t.play(),t.autoplay=!0,this.scene.mainSoundTrack.addSound(t)}removeFromContainer(e,t=!1){if(e.sounds)for(let i of e.sounds)i.stop(),i.autoplay=!1,this.scene.mainSoundTrack.removeSound(i),t&&i.dispose()}dispose(){let e=this.scene;if(e._mainSoundTrack&&e.mainSoundTrack.dispose(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].dispose()}disableAudio(){let e=this.scene;this._audioEnabled=!1,ne.audioEngine&&ne.audioEngine.audioContext&&ne.audioEngine.audioContext.suspend();let t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].pause();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].pause()}enableAudio(){let e=this.scene;this._audioEnabled=!0,ne.audioEngine&&ne.audioEngine.audioContext&&ne.audioEngine.audioContext.resume();let t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].isPaused&&e.mainSoundTrack.soundCollection[t].play();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].isPaused&&e.soundTracks[t].soundCollection[i].play()}switchAudioModeForHeadphones(){let e=this.scene;if(this._headphone=!0,e.mainSoundTrack.switchPanningModelToHRTF(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){let e=this.scene;if(this._headphone=!1,e.mainSoundTrack.switchPanningModelToEqualPower(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToEqualPower()}_afterRender(){let e=Xn.Now;if(this._lastCheck&&e-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=e;let t=this.scene;if(!this._audioEnabled||!t._mainSoundTrack||!t.soundTracks||t._mainSoundTrack.soundCollection.length===0&&t.soundTracks.length===1)return;let i=ne.audioEngine;if(i&&i.audioContext){let r=t.activeCamera;if(t.activeCameras&&t.activeCameras.length>0&&(r=t.activeCameras[0]),this.audioListenerPositionProvider){let o=this.audioListenerPositionProvider();i.audioContext.listener.setPosition(o.x||0,o.y||0,o.z||0)}else r?this._cachedCameraPosition.equals(r.globalPosition)||(this._cachedCameraPosition.copyFrom(r.globalPosition),i.audioContext.listener.setPosition(r.globalPosition.x,r.globalPosition.y,r.globalPosition.z)):i.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){let o=this.audioListenerRotationProvider();i.audioContext.listener.setOrientation(o.x||0,o.y||0,o.z||0,0,1,0)}else r?(r.rigCameras&&r.rigCameras.length>0&&(r=r.rigCameras[0]),r.getViewMatrix().invertToRef(this._invertMatrixTemp),m.TransformNormalToRef(n._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),!isNaN(this._cameraDirectionTemp.x)&&!isNaN(this._cameraDirectionTemp.y)&&!isNaN(this._cameraDirectionTemp.z)&&(this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),i.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0)))):i.audioContext.listener.setOrientation(0,0,0,0,1,0);let s;for(s=0;s<t.mainSoundTrack.soundCollection.length;s++){let o=t.mainSoundTrack.soundCollection[s];o.useCustomAttenuation&&o.updateDistanceFromListener()}if(t.soundTracks)for(s=0;s<t.soundTracks.length;s++)for(let o=0;o<t.soundTracks[s].soundCollection.length;o++){let a=t.soundTracks[s].soundCollection[o];a.useCustomAttenuation&&a.updateDistanceFromListener()}}}};Hi._CameraDirection=new m(0,0,-1);Ks._SceneComponentInitialization=n=>{let e=n._getComponent(Oe.NAME_AUDIO);e||(e=new Hi(n),n._addComponent(e))};var Lm="MSFT_audio_emitter",lC=class{constructor(e){this.name=Lm,this._loader=e,this.enabled=this._loader.isExtensionUsed(Lm)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,se.Assign(this._clips),se.Assign(this._emitters)}}loadSceneAsync(e,t){return ge.LoadExtensionAsync(e,t,this.name,(i,r)=>S(this,null,function*(){let s=new Array;s.push(this._loader.loadSceneAsync(e,t));for(let o of r.emitters){let a=se.Get(`${i}/emitters`,this._emitters,o);if(a.refDistance!=null||a.maxDistance!=null||a.rolloffFactor!=null||a.distanceModel!=null||a.innerAngle!=null||a.outerAngle!=null)throw new Error(`${i}: Direction or Distance properties are not allowed on emitters attached to a scene`);s.push(this._loadEmitterAsync(`${i}/emitters/${a.index}`,a))}yield Promise.all(s)}))}loadNodeAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){let o=new Array,a=yield this._loader.loadNodeAsync(r,t,l=>{for(let c of s.emitters){let u=se.Get(`${r}/emitters`,this._emitters,c);o.push(this._loadEmitterAsync(`${r}/emitters/${u.index}`,u).then(()=>{for(let h of u._babylonSounds)h.attachToMesh(l),(u.innerAngle!=null||u.outerAngle!=null)&&(h.setLocalDirectionToMesh(m.Forward()),h.setDirectionalCone(2*z.ToDegrees(u.innerAngle==null?Math.PI:u.innerAngle),2*z.ToDegrees(u.outerAngle==null?Math.PI:u.outerAngle),0))}))}i(l)});return yield Promise.all(o),a}))}loadAnimationAsync(e,t){return ge.LoadExtensionAsync(e,t,this.name,(i,r)=>S(this,null,function*(){let s=yield this._loader.loadAnimationAsync(e,t),o=new Array;se.Assign(r.events);for(let a of r.events)o.push(this._loadAnimationEventAsync(`${i}/events/${a.index}`,e,t,a,s));return yield Promise.all(o),s}))}_loadClipAsync(e,t){if(t._objectURL)return t._objectURL;let i;if(t.uri)i=this._loader.loadUriAsync(e,t,t.uri);else{let r=se.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,t.bufferView);i=this._loader.loadBufferViewAsync(`/bufferViews/${r.index}`,r)}return t._objectURL=i.then(r=>URL.createObjectURL(new Blob([r],{type:t.mimeType}))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){let i=new Array,r=t.name||`emitter${t.index}`,s={loop:!1,autoplay:!1,volume:t.volume==null?1:t.volume};for(let a=0;a<t.clips.length;a++){let l=`/extensions/${this.name}/clips`,c=se.Get(l,this._clips,t.clips[a].clip);i.push(this._loadClipAsync(`${l}/${t.clips[a].clip}`,c).then(u=>{let h=t._babylonSounds[a]=new Ks(r,u,this._loader.babylonScene,null,s);h.refDistance=t.refDistance||1,h.maxDistance=t.maxDistance||256,h.rolloffFactor=t.rolloffFactor||1,h.distanceModel=t.distanceModel||"exponential"}))}let o=Promise.all(i).then(()=>{let a=t.clips.map(c=>c.weight||1),l=new Tm(t.loop||!1,t._babylonSounds,a);t.innerAngle&&(l.directionalConeInnerAngle=2*z.ToDegrees(t.innerAngle)),t.outerAngle&&(l.directionalConeOuterAngle=2*z.ToDegrees(t.outerAngle)),t.volume&&(l.volume=t.volume),t._babylonData.sound=l});t._babylonData={loaded:o}}return t._babylonData.loaded}_getEventAction(e,t,i,r,s){switch(i){case"play":return o=>{let a=(s||0)+(o-r);t.play(a)};case"stop":return()=>{t.stop()};case"pause":return()=>{t.pause()};default:throw new Error(`${e}: Unsupported action ${i}`)}}_loadAnimationEventAsync(e,t,i,r,s){if(s.targetedAnimations.length==0)return Promise.resolve();let o=s.targetedAnimations[0],a=r.emitter,l=se.Get(`/extensions/${this.name}/emitters`,this._emitters,a);return this._loadEmitterAsync(e,l).then(()=>{let c=l._babylonData.sound;if(c){let u=new Cm(r.time,this._getEventAction(e,c,r.action,r.time,r.startOffset));o.animation.addEvent(u),s.onAnimationGroupEndObservable.add(()=>{c.stop()}),s.onAnimationGroupPauseObservable.add(()=>{c.pause()})}})}};de(Lm);fe(Lm,!0,n=>new lC(n));var Qu="MSFT_lod",cC=class{constructor(e){this.name=Qu,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new F,this.onMaterialLODsLoadedObservable=new F,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.maxLODsToLoad=this._loader.parent.extensionOptions[Qu]?.maxLODsToLoad??this.maxLODsToLoad,this.enabled=this._loader.isExtensionUsed(Qu)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){let t=Promise.all(this._nodePromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())});this._loader._completePromises.push(t)}for(let e=0;e<this._materialPromiseLODs.length;e++){let t=Promise.all(this._materialPromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())});this._loader._completePromises.push(t)}}loadSceneAsync(e,t){let i=this._loader.loadSceneAsync(e,t);return this._loadBufferLOD(this._bufferLODs,0),i}loadNodeAsync(e,t,i){return ge.LoadExtensionAsync(e,t,this.name,(r,s)=>S(this,null,function*(){let o,a=this._getLODs(r,t,this._loader.gltf.nodes,s.ids);this._loader.logOpen(`${r}`);for(let l=0;l<a.length;l++){let c=a[l];l!==0&&(this._nodeIndexLOD=l,this._nodeSignalLODs[l]=this._nodeSignalLODs[l]||new _s);let u=d=>{i(d),d.setEnabled(!1)},h=this._loader.loadNodeAsync(`/nodes/${c.index}`,c,u).then(d=>{if(l!==0){let f=a[l-1];f._babylonTransformNode&&(this._disposeTransformNode(f._babylonTransformNode),delete f._babylonTransformNode)}return d.setEnabled(!0),d});this._nodePromiseLODs[l]=this._nodePromiseLODs[l]||[],l===0?o=h:(this._nodeIndexLOD=null,this._nodePromiseLODs[l].push(h))}return this._loader.logClose(),yield o}))}_loadMaterialAsync(e,t,i,r,s){return this._nodeIndexLOD?null:ge.LoadExtensionAsync(e,t,this.name,(o,a)=>S(this,null,function*(){let l,c=this._getLODs(o,t,this._loader.gltf.materials,a.ids);this._loader.logOpen(`${o}`);for(let u=0;u<c.length;u++){let h=c[u];u!==0&&(this._materialIndexLOD=u);let d=this._loader._loadMaterialAsync(`/materials/${h.index}`,h,i,r,f=>{u===0&&s(f)}).then(f=>{if(u!==0){s(f);let p=c[u-1]._data;p[r]&&(this._disposeMaterials([p[r].babylonMaterial]),delete p[r])}return f});this._materialPromiseLODs[u]=this._materialPromiseLODs[u]||[],u===0?l=d:(this._materialIndexLOD=null,this._materialPromiseLODs[u].push(d))}return this._loader.logClose(),yield l}))}_loadUriAsync(e,t,i){if(this._nodeIndexLOD!==null){this._loader.log("deferred");let r=this._nodeIndexLOD-1;return this._nodeSignalLODs[r]=this._nodeSignalLODs[r]||new _s,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(()=>S(this,null,function*(){return yield this._loader.loadUriAsync(e,t,i)}))}else if(this._materialIndexLOD!==null){this._loader.log("deferred");let r=this._materialIndexLOD-1;return this._materialSignalLODs[r]=this._materialSignalLODs[r]||new _s,this._materialSignalLODs[r].promise.then(()=>S(this,null,function*(){return yield this._loader.loadUriAsync(e,t,i)}))}return null}loadBufferAsync(e,t,i,r){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);let s=(o,a)=>S(this,null,function*(){let l=i,c=l+r-1,u=o[a];return u?(u.start=Math.min(u.start,l),u.end=Math.max(u.end,c)):(u={start:l,end:c,loaded:new _s},o[a]=u),yield u.loaded.promise.then(h=>new Uint8Array(h.buffer,h.byteOffset+i-u.start,r))});return this._loader.log("deferred"),this._nodeIndexLOD!==null?s(this._nodeBufferLODs,this._nodeIndexLOD):this._materialIndexLOD!==null?s(this._materialBufferLODs,this._materialIndexLOD):s(this._bufferLODs,0)}return null}_loadBufferLOD(e,t){let i=e[t];i&&(this._loader.log(`Loading buffer range [${i.start}-${i.end}]`),this._loader.bin.readAsync(i.start,i.end-i.start+1).then(r=>{i.loaded.resolve(r)},r=>{i.loaded.reject(r)}))}_getLODs(e,t,i,r){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");let s=[];for(let o=r.length-1;o>=0;o--)if(s.push(se.Get(`${e}/ids/${r[o]}`,i,r[o])),s.length===this.maxLODsToLoad)return s;return s.push(t),s}_disposeTransformNode(e){let t=[],i=e.material;i&&t.push(i);for(let s of e.getChildMeshes())s.material&&t.push(s.material);e.dispose();let r=t.filter(s=>this._loader.babylonScene.meshes.every(o=>o.material!=s));this._disposeMaterials(r)}_disposeMaterials(e){let t={};for(let i of e){for(let r of i.getActiveTextures())t[r.uniqueId]=r;i.dispose()}for(let i in t)for(let r of this._loader.babylonScene.materials)r.hasTexture(t[i])&&delete t[i];for(let i in t)t[i].dispose()}};de(Qu);fe(Qu,!0,n=>new cC(n));var Bm="MSFT_minecraftMesh",uC=class{constructor(e){this.name=Bm,this._loader=e,this.enabled=this._loader.isExtensionUsed(Bm)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ge.LoadExtraAsync(e,t,this.name,(r,s)=>S(this,null,function*(){if(s){if(!this._loader._pbrMaterialImpl)throw new Error(`${r}: Material type not supported`);let o=this._loader.loadMaterialPropertiesAsync(e,t,i);return i.needAlphaBlending()&&(i.forceDepthWrite=!0,i.separateCullingPass=!0),i.backFaceCulling=i.forceDepthWrite,i.twoSidedLighting=!0,yield o}}))}};de(Bm);fe(Bm,!0,n=>new uC(n));var km="MSFT_sRGBFactors",hC=class{constructor(e){this.name=km,this._loader=e,this.enabled=this._loader.isExtensionUsed(km)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return ge.LoadExtraAsync(e,t,this.name,(r,s)=>S(this,null,function*(){if(s){let o=this._loader._getOrCreateMaterialAdapter(i),a=this._loader.loadMaterialPropertiesAsync(e,t,i),l=i.getScene().getEngine().useExactSrgbConversions;return o.baseColorTexture||o.baseColor.toLinearSpaceToRef(o.baseColor,l),o.specularColorTexture||o.specularColor.toLinearSpaceToRef(o.specularColor,l),yield a}}))}};de(km);fe(km,!0,n=>new hC(n));var dC={};function hM(n,e,t){dC[`${n}/${e}`]=t}function dM(n){switch(n){case"FlowGraphPlayAnimationBlock":return()=>S(null,null,function*(){return(yield import("./chunk-5Y6WSAFW.js")).FlowGraphPlayAnimationBlock});case"FlowGraphStopAnimationBlock":return()=>S(null,null,function*(){return(yield import("./chunk-SYUEEVYK.js")).FlowGraphStopAnimationBlock});case"FlowGraphPauseAnimationBlock":return()=>S(null,null,function*(){return(yield import("./chunk-UWYB2JGW.js")).FlowGraphPauseAnimationBlock});case"FlowGraphInterpolationBlock":return()=>S(null,null,function*(){return(yield import("./chunk-B3TBZJCT.js")).FlowGraphInterpolationBlock});case"FlowGraphSceneReadyEventBlock":return()=>S(null,null,function*(){return(yield import("./chunk-DKTEIM3F.js")).FlowGraphSceneReadyEventBlock});case"FlowGraphSceneTickEventBlock":return()=>S(null,null,function*(){return(yield import("./chunk-O5G6NIGD.js")).FlowGraphSceneTickEventBlock});case"FlowGraphSendCustomEventBlock":return()=>S(null,null,function*(){return(yield import("./chunk-APC5A5IM.js")).FlowGraphSendCustomEventBlock});case"FlowGraphReceiveCustomEventBlock":return()=>S(null,null,function*(){return(yield import("./chunk-DMXX6LKL.js")).FlowGraphReceiveCustomEventBlock});case"FlowGraphMeshPickEventBlock":return()=>S(null,null,function*(){return(yield import("./chunk-BHKU4LWE.js")).FlowGraphMeshPickEventBlock});case"FlowGraphEBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphEBlock});case"FlowGraphPIBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphPiBlock});case"FlowGraphInfBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphInfBlock});case"FlowGraphNaNBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphNaNBlock});case"FlowGraphRandomBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphRandomBlock});case"FlowGraphAddBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphAddBlock});case"FlowGraphSubtractBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphSubtractBlock});case"FlowGraphMultiplyBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphMultiplyBlock});case"FlowGraphDivideBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphDivideBlock});case"FlowGraphAbsBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphAbsBlock});case"FlowGraphSignBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphSignBlock});case"FlowGraphTruncBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphTruncBlock});case"FlowGraphFloorBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphFloorBlock});case"FlowGraphCeilBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphCeilBlock});case"FlowGraphRoundBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphRoundBlock});case"FlowGraphFractBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphFractionBlock});case"FlowGraphNegationBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphNegationBlock});case"FlowGraphModuloBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphModuloBlock});case"FlowGraphMinBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphMinBlock});case"FlowGraphMaxBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphMaxBlock});case"FlowGraphClampBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphClampBlock});case"FlowGraphSaturateBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphSaturateBlock});case"FlowGraphMathInterpolationBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphMathInterpolationBlock});case"FlowGraphEqualityBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphEqualityBlock});case"FlowGraphLessThanBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphLessThanBlock});case"FlowGraphLessThanOrEqualBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphLessThanOrEqualBlock});case"FlowGraphGreaterThanBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphGreaterThanBlock});case"FlowGraphGreaterThanOrEqualBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphGreaterThanOrEqualBlock});case"FlowGraphIsNaNBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphIsNanBlock});case"FlowGraphIsInfBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphIsInfinityBlock});case"FlowGraphDegToRadBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphDegToRadBlock});case"FlowGraphRadToDegBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphRadToDegBlock});case"FlowGraphSinBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphSinBlock});case"FlowGraphCosBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphCosBlock});case"FlowGraphTanBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphTanBlock});case"FlowGraphASinBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphAsinBlock});case"FlowGraphACosBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphAcosBlock});case"FlowGraphATanBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphAtanBlock});case"FlowGraphATan2Block":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphAtan2Block});case"FlowGraphSinhBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphSinhBlock});case"FlowGraphCoshBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphCoshBlock});case"FlowGraphTanhBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphTanhBlock});case"FlowGraphASinhBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphAsinhBlock});case"FlowGraphACoshBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphAcoshBlock});case"FlowGraphATanhBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphAtanhBlock});case"FlowGraphExponentialBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphExpBlock});case"FlowGraphLogBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphLogBlock});case"FlowGraphLog2Block":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphLog2Block});case"FlowGraphLog10Block":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphLog10Block});case"FlowGraphSquareRootBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphSquareRootBlock});case"FlowGraphPowerBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphPowerBlock});case"FlowGraphCubeRootBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphCubeRootBlock});case"FlowGraphBitwiseAndBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphBitwiseAndBlock});case"FlowGraphBitwiseOrBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphBitwiseOrBlock});case"FlowGraphBitwiseNotBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphBitwiseNotBlock});case"FlowGraphBitwiseXorBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphBitwiseXorBlock});case"FlowGraphBitwiseLeftShiftBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphBitwiseLeftShiftBlock});case"FlowGraphBitwiseRightShiftBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphBitwiseRightShiftBlock});case"FlowGraphLengthBlock":return()=>S(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphLengthBlock});case"FlowGraphNormalizeBlock":return()=>S(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphNormalizeBlock});case"FlowGraphDotBlock":return()=>S(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphDotBlock});case"FlowGraphCrossBlock":return()=>S(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphCrossBlock});case"FlowGraphRotate2DBlock":return()=>S(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphRotate2DBlock});case"FlowGraphRotate3DBlock":return()=>S(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphRotate3DBlock});case"FlowGraphTransposeBlock":return()=>S(null,null,function*(){return(yield import("./chunk-AXVMSDDC.js")).FlowGraphTransposeBlock});case"FlowGraphDeterminantBlock":return()=>S(null,null,function*(){return(yield import("./chunk-AXVMSDDC.js")).FlowGraphDeterminantBlock});case"FlowGraphInvertMatrixBlock":return()=>S(null,null,function*(){return(yield import("./chunk-AXVMSDDC.js")).FlowGraphInvertMatrixBlock});case"FlowGraphMatrixMultiplicationBlock":return()=>S(null,null,function*(){return(yield import("./chunk-AXVMSDDC.js")).FlowGraphMatrixMultiplicationBlock});case"FlowGraphBranchBlock":return()=>S(null,null,function*(){return(yield import("./chunk-NZYBIKGY.js")).FlowGraphBranchBlock});case"FlowGraphSetDelayBlock":return()=>S(null,null,function*(){return(yield import("./chunk-5JNRLMPI.js")).FlowGraphSetDelayBlock});case"FlowGraphCancelDelayBlock":return()=>S(null,null,function*(){return(yield import("./chunk-3SUJL3OR.js")).FlowGraphCancelDelayBlock});case"FlowGraphCallCounterBlock":return()=>S(null,null,function*(){return(yield import("./chunk-L2A45L5C.js")).FlowGraphCallCounterBlock});case"FlowGraphDebounceBlock":return()=>S(null,null,function*(){return(yield import("./chunk-DDQBYROT.js")).FlowGraphDebounceBlock});case"FlowGraphThrottleBlock":return()=>S(null,null,function*(){return(yield import("./chunk-AWU4CHHC.js")).FlowGraphThrottleBlock});case"FlowGraphDoNBlock":return()=>S(null,null,function*(){return(yield import("./chunk-TFFHTY5Y.js")).FlowGraphDoNBlock});case"FlowGraphFlipFlopBlock":return()=>S(null,null,function*(){return(yield import("./chunk-ERTQHUJL.js")).FlowGraphFlipFlopBlock});case"FlowGraphForLoopBlock":return()=>S(null,null,function*(){return(yield import("./chunk-Z5Q52LBM.js")).FlowGraphForLoopBlock});case"FlowGraphMultiGateBlock":return()=>S(null,null,function*(){return(yield import("./chunk-SCU2NHAE.js")).FlowGraphMultiGateBlock});case"FlowGraphSequenceBlock":return()=>S(null,null,function*(){return(yield import("./chunk-SKAZSHFG.js")).FlowGraphSequenceBlock});case"FlowGraphSwitchBlock":return()=>S(null,null,function*(){return(yield import("./chunk-MFQEQ24R.js")).FlowGraphSwitchBlock});case"FlowGraphWaitAllBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XTRXXOHV.js")).FlowGraphWaitAllBlock});case"FlowGraphWhileLoopBlock":return()=>S(null,null,function*(){return(yield import("./chunk-NUEBBE4M.js")).FlowGraphWhileLoopBlock});case"FlowGraphConsoleLogBlock":return()=>S(null,null,function*(){return(yield import("./chunk-WWQR5TRT.js")).FlowGraphConsoleLogBlock});case"FlowGraphConditionalBlock":return()=>S(null,null,function*(){return(yield import("./chunk-LIGVGKV3.js")).FlowGraphConditionalDataBlock});case"FlowGraphConstantBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XN2NZR3U.js")).FlowGraphConstantBlock});case"FlowGraphTransformCoordinatesSystemBlock":return()=>S(null,null,function*(){return(yield import("./chunk-Y3X3H66N.js")).FlowGraphTransformCoordinatesSystemBlock});case"FlowGraphGetAssetBlock":return()=>S(null,null,function*(){return(yield import("./chunk-4GDXF62J.js")).FlowGraphGetAssetBlock});case"FlowGraphGetPropertyBlock":return()=>S(null,null,function*(){return(yield import("./chunk-3UQJTCDS.js")).FlowGraphGetPropertyBlock});case"FlowGraphSetPropertyBlock":return()=>S(null,null,function*(){return(yield import("./chunk-VSH4CFZJ.js")).FlowGraphSetPropertyBlock});case"FlowGraphGetVariableBlock":return()=>S(null,null,function*(){return(yield import("./chunk-FJIILSM2.js")).FlowGraphGetVariableBlock});case"FlowGraphSetVariableBlock":return()=>S(null,null,function*(){return(yield import("./chunk-NFODLYWC.js")).FlowGraphSetVariableBlock});case"FlowGraphJsonPointerParserBlock":return()=>S(null,null,function*(){return(yield import("./chunk-ADVS33HD.js")).FlowGraphJsonPointerParserBlock});case"FlowGraphLeadingZerosBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphLeadingZerosBlock});case"FlowGraphTrailingZerosBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphTrailingZerosBlock});case"FlowGraphOneBitsCounterBlock":return()=>S(null,null,function*(){return(yield import("./chunk-XW5BD4T4.js")).FlowGraphOneBitsCounterBlock});case"FlowGraphCombineVector2Block":return()=>S(null,null,function*(){return(yield import("./chunk-YMNX5GDI.js")).FlowGraphCombineVector2Block});case"FlowGraphCombineVector3Block":return()=>S(null,null,function*(){return(yield import("./chunk-YMNX5GDI.js")).FlowGraphCombineVector3Block});case"FlowGraphCombineVector4Block":return()=>S(null,null,function*(){return(yield import("./chunk-YMNX5GDI.js")).FlowGraphCombineVector4Block});case"FlowGraphCombineMatrixBlock":return()=>S(null,null,function*(){return(yield import("./chunk-YMNX5GDI.js")).FlowGraphCombineMatrixBlock});case"FlowGraphExtractVector2Block":return()=>S(null,null,function*(){return(yield import("./chunk-YMNX5GDI.js")).FlowGraphExtractVector2Block});case"FlowGraphExtractVector3Block":return()=>S(null,null,function*(){return(yield import("./chunk-YMNX5GDI.js")).FlowGraphExtractVector3Block});case"FlowGraphExtractVector4Block":return()=>S(null,null,function*(){return(yield import("./chunk-YMNX5GDI.js")).FlowGraphExtractVector4Block});case"FlowGraphExtractMatrixBlock":return()=>S(null,null,function*(){return(yield import("./chunk-YMNX5GDI.js")).FlowGraphExtractMatrixBlock});case"FlowGraphTransformVectorBlock":return()=>S(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphTransformBlock});case"FlowGraphTransformCoordinatesBlock":return()=>S(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphTransformCoordinatesBlock});case"FlowGraphConjugateBlock":return()=>S(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphConjugateBlock});case"FlowGraphAngleBetweenBlock":return()=>S(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphAngleBetweenBlock});case"FlowGraphQuaternionFromAxisAngleBlock":return()=>S(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphQuaternionFromAxisAngleBlock});case"FlowGraphAxisAngleFromQuaternionBlock":return()=>S(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphAxisAngleFromQuaternionBlock});case"FlowGraphQuaternionFromDirectionsBlock":return()=>S(null,null,function*(){return(yield import("./chunk-B2UV4P6Z.js")).FlowGraphQuaternionFromDirectionsBlock});case"FlowGraphMatrixDecompose":return()=>S(null,null,function*(){return(yield import("./chunk-AXVMSDDC.js")).FlowGraphMatrixDecomposeBlock});case"FlowGraphMatrixCompose":return()=>S(null,null,function*(){return(yield import("./chunk-AXVMSDDC.js")).FlowGraphMatrixComposeBlock});case"FlowGraphBooleanToFloat":return()=>S(null,null,function*(){return(yield import("./chunk-UREIDWMS.js")).FlowGraphBooleanToFloat});case"FlowGraphBooleanToInt":return()=>S(null,null,function*(){return(yield import("./chunk-UREIDWMS.js")).FlowGraphBooleanToInt});case"FlowGraphFloatToBoolean":return()=>S(null,null,function*(){return(yield import("./chunk-UREIDWMS.js")).FlowGraphFloatToBoolean});case"FlowGraphIntToBoolean":return()=>S(null,null,function*(){return(yield import("./chunk-UREIDWMS.js")).FlowGraphIntToBoolean});case"FlowGraphIntToFloat":return()=>S(null,null,function*(){return(yield import("./chunk-UREIDWMS.js")).FlowGraphIntToFloat});case"FlowGraphFloatToInt":return()=>S(null,null,function*(){return(yield import("./chunk-UREIDWMS.js")).FlowGraphFloatToInt});case"FlowGraphEasingBlock":return()=>S(null,null,function*(){return(yield import("./chunk-MD3TQGGZ.js")).FlowGraphEasingBlock});case"FlowGraphBezierCurveEasing":return()=>S(null,null,function*(){return(yield import("./chunk-IO5SQJ5H.js")).FlowGraphBezierCurveEasingBlock});case"FlowGraphPointerOverEventBlock":return()=>S(null,null,function*(){return(yield import("./chunk-7IWPLIVX.js")).FlowGraphPointerOverEventBlock});case"FlowGraphPointerOutEventBlock":return()=>S(null,null,function*(){return(yield import("./chunk-7MO6QT47.js")).FlowGraphPointerOutEventBlock});case"FlowGraphContextBlock":return()=>S(null,null,function*(){return(yield import("./chunk-ZBPSPPJM.js")).FlowGraphContextBlock});case"FlowGraphArrayIndexBlock":return()=>S(null,null,function*(){return(yield import("./chunk-OM3ZAA7I.js")).FlowGraphArrayIndexBlock});case"FlowGraphCodeExecutionBlock":return()=>S(null,null,function*(){return(yield import("./chunk-AXADXAMC.js")).FlowGraphCodeExecutionBlock});case"FlowGraphIndexOfBlock":return()=>S(null,null,function*(){return(yield import("./chunk-BMUR2JGV.js")).FlowGraphIndexOfBlock});case"FlowGraphFunctionReference":return()=>S(null,null,function*(){return(yield import("./chunk-GX5IGO4H.js")).FlowGraphFunctionReferenceBlock});case"FlowGraphDataSwitchBlock":return()=>S(null,null,function*(){return(yield import("./chunk-3M5NJU3J.js")).FlowGraphDataSwitchBlock});default:if(dC[n])return dC[n];throw new Error(`Unknown block name ${n}`)}}function gk(n,e){for(let t of n)for(let i of t.dataOutputs)if(i.uniqueId===e)return i;throw new Error("Could not find data out connection with unique id "+e)}function _k(n,e){for(let t of n)if(t instanceof t_){for(let i of t.signalInputs)if(i.uniqueId===e)return i}throw new Error("Could not find signal in connection with unique id "+e)}function fM(n,e){return S(this,null,function*(){let t=yield Promise.all(n.allBlocks.map(i=>S(null,null,function*(){return yield dM(i.className)()})));return yk(n,e,t)})}function yk(n,e,t){let i=e.coordinator.createGraph(),r=[],s=e.valueParseFunction??nd;for(let o=0;o<n.allBlocks.length;o++){let a=n.allBlocks[o],l=bk(a,{scene:e.coordinator.config.scene,pathConverter:e.pathConverter,assetsContainer:e.coordinator.config.scene,valueParseFunction:s},t[o]);r.push(l),l instanceof S0&&i.addEventBlock(l)}for(let o of r){for(let a of o.dataInputs)for(let l of a.connectedPointIds){let c=gk(r,l);a.connectTo(c)}if(o instanceof t_)for(let a of o.signalOutputs)for(let l of a.connectedPointIds){let c=_k(r,l);a.connectTo(c)}}for(let o of n.executionContexts)vk(o,{graph:i,valueParseFunction:s},n.rightHanded);return i}function vk(n,e,t){let i=e.graph.createContext();n.enableLogging&&(i.enableLogging=!0),i.treatDataAsRightHanded=t||!1;let r=e.valueParseFunction??nd;i.uniqueId=n.uniqueId;let s=i.getScene();if(n._assetsContext){let o=n._assetsContext,a={meshes:o.meshes?.map(l=>s.getMeshById(l)),lights:o.lights?.map(l=>s.getLightByName(l)),cameras:o.cameras?.map(l=>s.getCameraByName(l)),materials:o.materials?.map(l=>s.getMaterialById(l)),textures:o.textures?.map(l=>s.getTextureByName(l)),animations:o.animations?.map(l=>s.animations.find(c=>c.name===l)),skeletons:o.skeletons?.map(l=>s.getSkeletonByName(l)),particleSystems:o.particleSystems?.map(l=>s.getParticleSystemById(l)),animationGroups:o.animationGroups?.map(l=>s.getAnimationGroupByName(l)),transformNodes:o.transformNodes?.map(l=>s.getTransformNodeById(l)),rootNodes:[],multiMaterials:[],morphTargetManagers:[],geometries:[],actionManagers:[],environmentTexture:null,postProcesses:[],sounds:null,effectLayers:[],layers:[],reflectionProbes:[],lensFlareSystems:[],proceduralTextures:[],getNodes:function(){throw new Error("Function not implemented.")}};i.assetsContext=a}for(let o in n._userVariables){let a=r(o,n._userVariables,i.assetsContext,s);i.userVariables[o]=a}for(let o in n._connectionValues){let a=r(o,n._connectionValues,i.assetsContext,s);i._setConnectionValueByKey(o,a)}return i}function bk(n,e,t){let i={},r=e.valueParseFunction??nd;if(n.config)for(let o in n.config)i[o]=r(o,n.config,e.assetsContainer||e.scene,e.scene);if(T0(n.className)){if(!e.pathConverter)throw new Error("Path converter is required for this block");i.pathConverter=e.pathConverter}let s=new t(i);s.uniqueId=n.uniqueId;for(let o=0;o<n.dataInputs.length;o++){let a=s.getDataInput(n.dataInputs[o].name);if(a)a.deserialize(n.dataInputs[o]);else throw new Error("Could not find data input with name "+n.dataInputs[o].name+" in block "+n.className)}for(let o=0;o<n.dataOutputs.length;o++){let a=s.getDataOutput(n.dataOutputs[o].name);if(a)a.deserialize(n.dataOutputs[o]);else throw new Error("Could not find data output with name "+n.dataOutputs[o].name+" in block "+n.className)}return s.metadata=n.metadata,s.deserialize&&s.deserialize(n),s}function fC(n){let[e,t]=n.split(":");return pC({op:e,extension:t})}function pC(n,e=!0){let t=n.extension?Vm[n.extension]?.[n.op]:xk[n.op];if(!t&&(P.Warn(`No mapping found for operation ${n.op} and extension ${n.extension||"KHR_interactivity"}`),e)){let i={},r={flows:{}};if(n.inputValueSockets){i.values={};for(let s in n.inputValueSockets)i.values[s]={name:s}}return n.outputValueSockets&&(r.values={},Object.keys(n.outputValueSockets).forEach(s=>{r.values[s]={name:s}})),{blocks:[],inputs:i,outputs:r}}return t}function Ju(n,e,t){Vm[e]||(Vm[e]={}),Vm[e][n]=t}var Vm={BABYLON:{"flow/log":{blocks:["FlowGraphConsoleLogBlock"],inputs:{values:{message:{name:"message"}}}}}},xk={"event/onStart":{blocks:["FlowGraphSceneReadyEventBlock"],outputs:{flows:{out:{name:"done"}}}},"event/onTick":{blocks:["FlowGraphSceneTickEventBlock"],inputs:{},outputs:{values:{timeSinceLastTick:{name:"deltaTime",gltfType:"number"}},flows:{out:{name:"done"}}}},"event/send":{blocks:["FlowGraphSendCustomEventBlock"],extraProcessor(n,e,t,i,r){if(e.op!=="event/send"||!n.configuration||Object.keys(n.configuration).length!==1)throw new Error("Receive event should have a single configuration object, the event itself");let o=n.configuration.event.value[0];if(typeof o!="number")throw new Error("Event id should be a number");let a=i.arrays.events[o],l=r[0];return l.config||(l.config={}),l.config.eventId=a.eventId,l.config.eventData=a.eventData,r}},"event/receive":{blocks:["FlowGraphReceiveCustomEventBlock"],outputs:{flows:{out:{name:"done"}}},validation(n,e){if(!n.configuration)return P.Error("Receive event should have a configuration object"),{valid:!1,error:"Receive event should have a configuration object"};let t=n.configuration.event;if(!t)return P.Error("Receive event should have a single configuration object, the event itself"),{valid:!1,error:"Receive event should have a single configuration object, the event itself"};let i=t.value[0];return typeof i!="number"?(P.Error("Event id should be a number"),{valid:!1,error:"Event id should be a number"}):e.events?.[i]?{valid:!0}:(P.Error(`Event with id ${i} not found`),{valid:!1,error:`Event with id ${i} not found`})},extraProcessor(n,e,t,i,r){if(e.op!=="event/receive"||!n.configuration||Object.keys(n.configuration).length!==1)throw new Error("Receive event should have a single configuration object, the event itself");let o=n.configuration.event.value[0];if(typeof o!="number")throw new Error("Event id should be a number");let a=i.arrays.events[o],l=r[0];return l.config||(l.config={}),l.config.eventId=a.eventId,l.config.eventData=a.eventData,r}},"math/E":ve("FlowGraphEBlock"),"math/Pi":ve("FlowGraphPIBlock"),"math/Inf":ve("FlowGraphInfBlock"),"math/NaN":ve("FlowGraphNaNBlock"),"math/abs":ve("FlowGraphAbsBlock"),"math/sign":ve("FlowGraphSignBlock"),"math/trunc":ve("FlowGraphTruncBlock"),"math/floor":ve("FlowGraphFloorBlock"),"math/ceil":ve("FlowGraphCeilBlock"),"math/round":{blocks:["FlowGraphRoundBlock"],configuration:{},inputs:{values:{a:{name:"a"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(n,e,t,i,r){var s;return(s=r[0]).config||(s.config={}),r[0].config.roundHalfAwayFromZero=!0,r}},"math/fract":ve("FlowGraphFractBlock"),"math/neg":ve("FlowGraphNegationBlock"),"math/add":ve("FlowGraphAddBlock",["a","b"],!0),"math/sub":ve("FlowGraphSubtractBlock",["a","b"],!0),"math/mul":{blocks:["FlowGraphMultiplyBlock"],extraProcessor(n,e,t,i,r){var s;(s=r[0]).config||(s.config={}),r[0].config.useMatrixPerComponent=!0,r[0].config.preventIntegerFloatArithmetic=!0;let o=-1;return Object.keys(n.values||{}).find(a=>n.values?.[a].type!==void 0?(o=n.values[a].type,!0):!1),o!==-1&&(r[0].config.type=i.arrays.types[o].flowGraphType),r},validation(n){return n.values?pM(n):{valid:!0}}},"math/div":ve("FlowGraphDivideBlock",["a","b"],!0),"math/rem":ve("FlowGraphModuloBlock",["a","b"]),"math/min":ve("FlowGraphMinBlock",["a","b"]),"math/max":ve("FlowGraphMaxBlock",["a","b"]),"math/clamp":ve("FlowGraphClampBlock",["a","b","c"]),"math/saturate":ve("FlowGraphSaturateBlock"),"math/mix":ve("FlowGraphMathInterpolationBlock",["a","b","c"]),"math/eq":ve("FlowGraphEqualityBlock",["a","b"]),"math/lt":ve("FlowGraphLessThanBlock",["a","b"]),"math/le":ve("FlowGraphLessThanOrEqualBlock",["a","b"]),"math/gt":ve("FlowGraphGreaterThanBlock",["a","b"]),"math/ge":ve("FlowGraphGreaterThanOrEqualBlock",["a","b"]),"math/isNaN":ve("FlowGraphIsNaNBlock"),"math/isInf":ve("FlowGraphIsInfBlock"),"math/select":{blocks:["FlowGraphConditionalBlock"],inputs:{values:{condition:{name:"condition"},a:{name:"onTrue"},b:{name:"onFalse"}}},outputs:{values:{value:{name:"output"}}}},"math/random":{blocks:["FlowGraphRandomBlock"],outputs:{values:{value:{name:"value"}}}},"math/sin":ve("FlowGraphSinBlock"),"math/cos":ve("FlowGraphCosBlock"),"math/tan":ve("FlowGraphTanBlock"),"math/asin":ve("FlowGraphASinBlock"),"math/acos":ve("FlowGraphACosBlock"),"math/atan":ve("FlowGraphATanBlock"),"math/atan2":ve("FlowGraphATan2Block",["a","b"]),"math/sinh":ve("FlowGraphSinhBlock"),"math/cosh":ve("FlowGraphCoshBlock"),"math/tanh":ve("FlowGraphTanhBlock"),"math/asinh":ve("FlowGraphASinhBlock"),"math/acosh":ve("FlowGraphACoshBlock"),"math/atanh":ve("FlowGraphATanhBlock"),"math/exp":ve("FlowGraphExponentialBlock"),"math/log":ve("FlowGraphLogBlock"),"math/log2":ve("FlowGraphLog2Block"),"math/log10":ve("FlowGraphLog10Block"),"math/sqrt":ve("FlowGraphSquareRootBlock"),"math/cbrt":ve("FlowGraphCubeRootBlock"),"math/pow":ve("FlowGraphPowerBlock",["a","b"]),"math/length":ve("FlowGraphLengthBlock"),"math/normalize":ve("FlowGraphNormalizeBlock"),"math/dot":ve("FlowGraphDotBlock",["a","b"]),"math/cross":ve("FlowGraphCrossBlock",["a","b"]),"math/rotate2D":{blocks:["FlowGraphRotate2DBlock"],inputs:{values:{a:{name:"a"},angle:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/rotate3D":{blocks:["FlowGraphRotate3DBlock"],inputs:{values:{a:{name:"a"},rotation:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/transform":{blocks:["FlowGraphTransformVectorBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/combine2":{blocks:["FlowGraphCombineVector2Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/combine3":{blocks:["FlowGraphCombineVector3Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/combine4":{blocks:["FlowGraphCombineVector4Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/extract2":{blocks:["FlowGraphExtractVector2Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"}}}},"math/extract3":{blocks:["FlowGraphExtractVector3Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"}}}},"math/extract4":{blocks:["FlowGraphExtractVector4Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"}}}},"math/transpose":ve("FlowGraphTransposeBlock"),"math/determinant":ve("FlowGraphDeterminantBlock"),"math/inverse":ve("FlowGraphInvertMatrixBlock"),"math/matMul":ve("FlowGraphMatrixMultiplicationBlock",["a","b"]),"math/matCompose":{blocks:["FlowGraphMatrixCompose"],inputs:{values:{translation:{name:"position",gltfType:"float3"},rotation:{name:"rotationQuaternion",gltfType:"float4"},scale:{name:"scaling",gltfType:"float3"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(n,e,t,i,r,s){let o=r[0].dataInputs.find(a=>a.name==="rotationQuaternion");if(!o)throw new Error("Rotation quaternion input not found");return s._connectionValues[o.uniqueId]&&(s._connectionValues[o.uniqueId].type="Quaternion"),r}},"math/matDecompose":{blocks:["FlowGraphMatrixDecompose"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{translation:{name:"position"},rotation:{name:"rotationQuaternion"},scale:{name:"scaling"}}}},"math/quatConjugate":ve("FlowGraphConjugateBlock",["a"]),"math/quatMul":{blocks:["FlowGraphMultiplyBlock"],inputs:{values:{a:{name:"a",gltfType:"vector4"},b:{name:"b",gltfType:"vector4"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(n,e,t,i,r){var s;return(s=r[0]).config||(s.config={}),r[0].config.type="Quaternion",r}},"math/quatAngleBetween":ve("FlowGraphAngleBetweenBlock",["a","b"]),"math/quatFromAxisAngle":{blocks:["FlowGraphQuaternionFromAxisAngleBlock"],inputs:{values:{axis:{name:"a",gltfType:"float3"},angle:{name:"b",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/quatToAxisAngle":ve("FlowGraphAxisAngleFromQuaternionBlock",["a"]),"math/quatFromDirections":ve("FlowGraphQuaternionFromDirectionsBlock",["a","b"]),"math/combine2x2":{blocks:["FlowGraphCombineMatrix2DBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(n,e,t,i,r){var s;return(s=r[0]).config||(s.config={}),r[0].config.inputIsColumnMajor=!0,r}},"math/extract2x2":{blocks:["FlowGraphExtractMatrix2DBlock"],inputs:{values:{a:{name:"input",gltfType:"float2x2"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"}}}},"math/combine3x3":{blocks:["FlowGraphCombineMatrix3DBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"},e:{name:"input_4",gltfType:"number"},f:{name:"input_5",gltfType:"number"},g:{name:"input_6",gltfType:"number"},h:{name:"input_7",gltfType:"number"},i:{name:"input_8",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(n,e,t,i,r){var s;return(s=r[0]).config||(s.config={}),r[0].config.inputIsColumnMajor=!0,r}},"math/extract3x3":{blocks:["FlowGraphExtractMatrix3DBlock"],inputs:{values:{a:{name:"input",gltfType:"float3x3"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"},4:{name:"output_4"},5:{name:"output_5"},6:{name:"output_6"},7:{name:"output_7"},8:{name:"output_8"}}}},"math/combine4x4":{blocks:["FlowGraphCombineMatrixBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"},e:{name:"input_4",gltfType:"number"},f:{name:"input_5",gltfType:"number"},g:{name:"input_6",gltfType:"number"},h:{name:"input_7",gltfType:"number"},i:{name:"input_8",gltfType:"number"},j:{name:"input_9",gltfType:"number"},k:{name:"input_10",gltfType:"number"},l:{name:"input_11",gltfType:"number"},m:{name:"input_12",gltfType:"number"},n:{name:"input_13",gltfType:"number"},o:{name:"input_14",gltfType:"number"},p:{name:"input_15",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(n,e,t,i,r){var s;return(s=r[0]).config||(s.config={}),r[0].config.inputIsColumnMajor=!0,r}},"math/extract4x4":{blocks:["FlowGraphExtractMatrixBlock"],configuration:{},inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"},4:{name:"output_4"},5:{name:"output_5"},6:{name:"output_6"},7:{name:"output_7"},8:{name:"output_8"},9:{name:"output_9"},10:{name:"output_10"},11:{name:"output_11"},12:{name:"output_12"},13:{name:"output_13"},14:{name:"output_14"},15:{name:"output_15"}}}},"math/not":{blocks:["FlowGraphBitwiseNotBlock"],inputs:{values:{a:{name:"a"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(n,e,t,i,r,s){var o;(o=r[0]).config||(o.config={});let a=r[0].dataInputs[0];return r[0].config.valueType=s._connectionValues[a.uniqueId]?.type??"FlowGraphInteger",r}},"math/and":{blocks:["FlowGraphBitwiseAndBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(n,e,t,i,r,s){var o;(o=r[0]).config||(o.config={});let a=r[0].dataInputs[0],l=r[0].dataInputs[1];return r[0].config.valueType=s._connectionValues[a.uniqueId]?.type??s._connectionValues[l.uniqueId]?.type??"FlowGraphInteger",r}},"math/or":{blocks:["FlowGraphBitwiseOrBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(n,e,t,i,r,s){var o;(o=r[0]).config||(o.config={});let a=r[0].dataInputs[0],l=r[0].dataInputs[1];return r[0].config.valueType=s._connectionValues[a.uniqueId]?.type??s._connectionValues[l.uniqueId]?.type??"FlowGraphInteger",r}},"math/xor":{blocks:["FlowGraphBitwiseXorBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(n,e,t,i,r,s){var o;(o=r[0]).config||(o.config={});let a=r[0].dataInputs[0],l=r[0].dataInputs[1];return r[0].config.valueType=s._connectionValues[a.uniqueId]?.type??s._connectionValues[l.uniqueId]?.type??"FlowGraphInteger",r}},"math/asr":ve("FlowGraphBitwiseRightShiftBlock",["a","b"]),"math/lsl":ve("FlowGraphBitwiseLeftShiftBlock",["a","b"]),"math/clz":ve("FlowGraphLeadingZerosBlock"),"math/ctz":ve("FlowGraphTrailingZerosBlock"),"math/popcnt":ve("FlowGraphOneBitsCounterBlock"),"math/rad":ve("FlowGraphDegToRadBlock"),"math/deg":ve("FlowGraphRadToDegBlock"),"type/boolToInt":ve("FlowGraphBooleanToInt"),"type/boolToFloat":ve("FlowGraphBooleanToFloat"),"type/intToBool":ve("FlowGraphIntToBoolean"),"type/intToFloat":ve("FlowGraphIntToFloat"),"type/floatToInt":ve("FlowGraphFloatToInt"),"type/floatToBool":ve("FlowGraphFloatToBoolean"),"flow/sequence":{blocks:["FlowGraphSequenceBlock"],extraProcessor(n,e,t,i,r){let s=r[0];return s.config||(s.config={}),s.config.outputSignalCount=Object.keys(n.flows||[]).length,s.signalOutputs.forEach((o,a)=>{o.name="out_"+a}),r}},"flow/branch":{blocks:["FlowGraphBranchBlock"],outputs:{flows:{true:{name:"onTrue"},false:{name:"onFalse"}}}},"flow/switch":{blocks:["FlowGraphSwitchBlock"],configuration:{cases:{name:"cases",inOptions:!0,defaultValue:[]}},inputs:{values:{selection:{name:"case"},default:{name:"default"}}},validation(n){if(n.configuration&&n.configuration.cases){let e=n.configuration.cases.value;if(!e.every(r=>typeof r=="number"&&/^-?\d+$/.test(r.toString())))return P.Warn("Switch cases should be integers. Using empty array instead."),n.configuration.cases.value=[],{valid:!0};let i=new Set(e);n.configuration.cases.value=Array.from(i)}return{valid:!0}},extraProcessor(n,e,t,i,r){if(e.op!=="flow/switch"||!n.flows||Object.keys(n.flows).length===0)throw new Error("Switch should have a single configuration object, the cases array");return r[0].signalOutputs.forEach(o=>{o.name!=="default"&&(o.name="out_"+o.name)}),r}},"flow/while":{blocks:["FlowGraphWhileLoopBlock"],outputs:{flows:{loopBody:{name:"executionFlow"}}}},"flow/for":{blocks:["FlowGraphForLoopBlock"],configuration:{initialIndex:{name:"initialIndex",gltfType:"number",inOptions:!0,defaultValue:0}},inputs:{values:{startIndex:{name:"startIndex",gltfType:"number"},endIndex:{name:"endIndex",gltfType:"number"}}},outputs:{values:{index:{name:"index"}},flows:{loopBody:{name:"executionFlow"}}},extraProcessor(n,e,t,i,r){let s=r[0];return s.config||(s.config={}),s.config.incrementIndexWhenLoopDone=!0,r}},"flow/doN":{blocks:["FlowGraphDoNBlock"],configuration:{},inputs:{values:{n:{name:"maxExecutions",gltfType:"number"}}},outputs:{values:{currentCount:{name:"executionCount"}}}},"flow/multiGate":{blocks:["FlowGraphMultiGateBlock"],configuration:{isRandom:{name:"isRandom",gltfType:"boolean",inOptions:!0,defaultValue:!1},isLoop:{name:"isLoop",gltfType:"boolean",inOptions:!0,defaultValue:!1}},extraProcessor(n,e,t,i,r){if(e.op!=="flow/multiGate"||!n.flows||Object.keys(n.flows).length===0)throw new Error("MultiGate should have a single configuration object, the number of output flows");let s=r[0];return s.config||(s.config={}),s.config.outputSignalCount=Object.keys(n.flows).length,s.signalOutputs.forEach((o,a)=>{o.name="out_"+a}),r}},"flow/waitAll":{blocks:["FlowGraphWaitAllBlock"],configuration:{inputFlows:{name:"inputSignalCount",gltfType:"number",inOptions:!0,defaultValue:0}},inputs:{flows:{reset:{name:"reset"},"[segment]":{name:"in_$1"}}},validation(n){return typeof n.configuration?.inputFlows?.value[0]!="number"&&(n.configuration=n.configuration||{inputFlows:{value:[0]}},n.configuration.inputFlows.value=[0]),{valid:!0}}},"flow/throttle":{blocks:["FlowGraphThrottleBlock"],outputs:{flows:{err:{name:"error"}}}},"flow/setDelay":{blocks:["FlowGraphSetDelayBlock"],outputs:{flows:{err:{name:"error"}}}},"flow/cancelDelay":{blocks:["FlowGraphCancelDelayBlock"]},"variable/get":{blocks:["FlowGraphGetVariableBlock"],validation(n){return n.configuration?.variable?.value?{valid:!0}:(P.Error("Variable get block should have a variable configuration"),{valid:!1,error:"Variable get block should have a variable configuration"})},configuration:{variable:{name:"variable",gltfType:"number",flowGraphType:"string",inOptions:!0,isVariable:!0,dataTransformer(n,e){return[e.getVariableName(n[0])]}}}},"variable/set":{blocks:["FlowGraphSetVariableBlock"],configuration:{variable:{name:"variable",gltfType:"number",flowGraphType:"string",inOptions:!0,isVariable:!0,dataTransformer(n,e){return[e.getVariableName(n[0])]}}}},"variable/setMultiple":{blocks:["FlowGraphSetVariableBlock"],configuration:{variables:{name:"variables",gltfType:"number",flowGraphType:"string",inOptions:!0,dataTransformer(n,e){return[n[0].map(t=>e.getVariableName(t))]}}},extraProcessor(n,e,t,i,r){return r[0].dataInputs.forEach(o=>{o.name=i.getVariableName(+o.name)}),r}},"variable/interpolate":{blocks:["FlowGraphInterpolationBlock","FlowGraphContextBlock","FlowGraphPlayAnimationBlock","FlowGraphBezierCurveEasing","FlowGraphGetVariableBlock"],configuration:{variable:{name:"propertyName",inOptions:!0,isVariable:!0,dataTransformer(n,e){return[e.getVariableName(n[0])]}},useSlerp:{name:"animationType",inOptions:!0,defaultValue:!1,dataTransformer:n=>n[0]===!0?["Quaternion"]:[void 0]}},inputs:{values:{value:{name:"value_1"},duration:{name:"duration_1",gltfType:"number"},p1:{name:"controlPoint1",toBlock:"FlowGraphBezierCurveEasing"},p2:{name:"controlPoint2",toBlock:"FlowGraphBezierCurveEasing"}},flows:{in:{name:"in",toBlock:"FlowGraphPlayAnimationBlock"}}},outputs:{flows:{err:{name:"error",toBlock:"FlowGraphPlayAnimationBlock"},out:{name:"out",toBlock:"FlowGraphPlayAnimationBlock"},done:{name:"done",toBlock:"FlowGraphPlayAnimationBlock"}}},interBlockConnectors:[{input:"object",output:"userVariables",inputBlockIndex:2,outputBlockIndex:1,isVariable:!0},{input:"animation",output:"animation",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0},{input:"easingFunction",output:"easingFunction",inputBlockIndex:0,outputBlockIndex:3,isVariable:!0},{input:"value_0",output:"value",inputBlockIndex:0,outputBlockIndex:4,isVariable:!0}],extraProcessor(n,e,t,i,r){var s,o;let a=r[0],l=n.configuration?.variable.value[0];if(typeof l!="number")throw P.Error("Variable index is not defined for variable interpolation block"),new Error("Variable index is not defined for variable interpolation block");let c=i.arrays.staticVariables[l];typeof a.config.animationType.value>"u"&&(i.arrays.staticVariables,a.config.animationType.value=C0(c.type));let u=r[4];return u.config||(u.config={}),(s=u.config).variable||(s.variable={}),u.config.variable.value=i.getVariableName(l),(o=r[3]).config||(o.config={}),r}},"pointer/get":{blocks:["FlowGraphGetPropertyBlock","FlowGraphJsonPointerParserBlock"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customGetFunction",output:"getFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(n,e,t,i,r){return r.forEach(s=>{s.className==="FlowGraphJsonPointerParserBlock"&&(s.config||(s.config={}),s.config.outputValue=!0)}),r}},"pointer/set":{blocks:["FlowGraphSetPropertyBlock","FlowGraphJsonPointerParserBlock"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{value:{name:"value"},"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customSetFunction",output:"setFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(n,e,t,i,r){return r.forEach(s=>{s.className==="FlowGraphJsonPointerParserBlock"&&(s.config||(s.config={}),s.config.outputValue=!0)}),r}},"pointer/interpolate":{blocks:["FlowGraphInterpolationBlock","FlowGraphJsonPointerParserBlock","FlowGraphPlayAnimationBlock","FlowGraphBezierCurveEasing"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{value:{name:"value_1"},"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"},duration:{name:"duration_1",gltfType:"number"},p1:{name:"controlPoint1",toBlock:"FlowGraphBezierCurveEasing"},p2:{name:"controlPoint2",toBlock:"FlowGraphBezierCurveEasing"}},flows:{in:{name:"in",toBlock:"FlowGraphPlayAnimationBlock"}}},outputs:{flows:{err:{name:"error",toBlock:"FlowGraphPlayAnimationBlock"},out:{name:"out",toBlock:"FlowGraphPlayAnimationBlock"},done:{name:"done",toBlock:"FlowGraphPlayAnimationBlock"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:2,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customBuildAnimation",output:"generateAnimationsFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"animation",output:"animation",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0},{input:"easingFunction",output:"easingFunction",inputBlockIndex:0,outputBlockIndex:3,isVariable:!0},{input:"value_0",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(n,e,t,i,r){return r.forEach(s=>{s.className==="FlowGraphJsonPointerParserBlock"?(s.config||(s.config={}),s.config.outputValue=!0):s.className==="FlowGraphInterpolationBlock"&&(s.config||(s.config={}),Object.keys(n.values||[]).forEach(o=>{let a=n.values?.[o];if(o==="value"&&a){let l=a.type;l!==void 0&&(s.config.animationType=i.arrays.types[l].flowGraphType)}}))}),r}},"animation/start":{blocks:["FlowGraphPlayAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"},speed:{name:"speed",gltfType:"number"},startTime:{name:"from",gltfType:"number",dataTransformer:(n,e)=>[n[0]*e._animationTargetFps]},endTime:{name:"to",gltfType:"number",dataTransformer:(n,e)=>[n[0]*e._animationTargetFps]}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(n,e,t,i,r,s,o){let a=r[r.length-1];return a.config||(a.config={}),a.config.glTF=o,r}},"animation/stop":{blocks:["FlowGraphStopAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(n,e,t,i,r,s,o){let a=r[r.length-1];return a.config||(a.config={}),a.config.glTF=o,r}},"animation/stopAt":{blocks:["FlowGraphStopAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{},inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"},stopTime:{name:"stopAtFrame",gltfType:"number",dataTransformer:(n,e)=>[n[0]*e._animationTargetFps]}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(n,e,t,i,r,s,o){let a=r[r.length-1];return a.config||(a.config={}),a.config.glTF=o,r}},"math/switch":{blocks:["FlowGraphDataSwitchBlock"],configuration:{cases:{name:"cases",inOptions:!0,defaultValue:[]}},inputs:{values:{selection:{name:"case"}}},validation(n){if(n.configuration&&n.configuration.cases){let e=n.configuration.cases.value;if(!e.every(r=>typeof r=="number"&&/^-?\d+$/.test(r.toString())))return P.Warn("Switch cases should be integers. Using empty array instead."),n.configuration.cases.value=[],{valid:!0};let i=new Set(e);n.configuration.cases.value=Array.from(i)}return{valid:!0}},extraProcessor(n,e,t,i,r){let s=r[0];return s.dataInputs.forEach(o=>{o.name!=="default"&&o.name!=="case"&&(o.name="in_"+o.name)}),s.config||(s.config={}),s.config.treatCasesAsIntegers=!0,r}},"debug/log":{blocks:["FlowGraphConsoleLogBlock"],configuration:{message:{name:"messageTemplate",inOptions:!0}}}};function ve(n,e=["a"],t){return{blocks:[n],inputs:{values:e.reduce((i,r)=>(i[r]={name:r},i),{})},outputs:{values:{value:{name:"value"}}},extraProcessor(i,r,s,o,a){var l;if(t){(l=a[0]).config||(l.config={}),a[0].config.preventIntegerFloatArithmetic=!0;let c=-1;Object.keys(i.values||{}).find(u=>i.values?.[u].type!==void 0?(c=i.values[u].type,!0):!1),c!==-1&&(a[0].config.type=o.arrays.types[c].flowGraphType)}return a},validation(i){return t?pM(i):{valid:!0}}}}function pM(n){if(n.values){let e=Object.keys(n.values).map(i=>n.values[i].type).filter(i=>i!==void 0);if(!e.every(i=>i===e[0]))return{valid:!1,error:"All inputs must be of the same type"}}return{valid:!0}}var Ck={float:{length:1,flowGraphType:"number",elementType:"number"},bool:{length:1,flowGraphType:"boolean",elementType:"boolean"},float2:{length:2,flowGraphType:"Vector2",elementType:"number"},float3:{length:3,flowGraphType:"Vector3",elementType:"number"},float4:{length:4,flowGraphType:"Vector4",elementType:"number"},float4x4:{length:16,flowGraphType:"Matrix",elementType:"number"},float2x2:{length:4,flowGraphType:"Matrix2D",elementType:"number"},float3x3:{length:9,flowGraphType:"Matrix3D",elementType:"number"},int:{length:1,flowGraphType:"FlowGraphInteger",elementType:"number"}},Gm=class{constructor(e,t,i=60){this._interactivityGraph=e,this._gltf=t,this._animationTargetFps=i,this._types=[],this._mappings=[],this._staticVariables=[],this._events=[],this._internalEventsCounter=0,this._nodes=[],this._parseTypes(),this._parseDeclarations(),this._parseVariables(),this._parseEvents(),this._parseNodes()}get arrays(){return{types:this._types,mappings:this._mappings,staticVariables:this._staticVariables,events:this._events,nodes:this._nodes}}_parseTypes(){if(this._interactivityGraph.types)for(let e of this._interactivityGraph.types)this._types.push(Ck[e.signature])}_parseDeclarations(){if(this._interactivityGraph.declarations)for(let e of this._interactivityGraph.declarations){let t=pC(e);if(!t)throw P.Error(["No mapping found for declaration",e]),new Error("Error parsing declarations");this._mappings.push({flowGraphMapping:t,fullOperationName:e.extension?e.op+":"+e.extension:e.op})}}_parseVariables(){if(this._interactivityGraph.variables)for(let e of this._interactivityGraph.variables){let t=this._parseVariable(e);this._staticVariables.push(t)}}_parseVariable(e,t){let i=this._types[e.type];if(!i)throw P.Error(["No type found for variable",e]),new Error("Error parsing variables");if(e.value&&e.value.length!==i.length)throw P.Error(["Invalid value length for variable",e,i]),new Error("Error parsing variables");let r=e.value||[];if(!r.length)switch(i.flowGraphType){case"boolean":r.push(!1);break;case"FlowGraphInteger":r.push(0);break;case"number":r.push(NaN);break;case"Vector2":r.push(NaN,NaN);break;case"Vector3":r.push(NaN,NaN,NaN);break;case"Vector4":case"Matrix2D":case"Quaternion":r.fill(NaN,0,4);break;case"Matrix":r.fill(NaN,0,16);break;case"Matrix3D":r.fill(NaN,0,9);break;default:break}return i.elementType==="number"&&typeof r[0]=="string"&&(r[0]=parseFloat(r[0])),{type:i.flowGraphType,value:t?t(r,this):r}}_parseEvents(){if(this._interactivityGraph.events)for(let e of this._interactivityGraph.events){let t={eventId:e.id||"internalEvent_"+this._internalEventsCounter++};e.values&&(t.eventData=Object.keys(e.values).map(i=>{let r=e.values?.[i];if(!r)throw P.Error(["No value found for event key",i]),new Error("Error parsing events");let s=this._types[r.type];if(!s)throw P.Error(["No type found for event value",r]),new Error("Error parsing events");let o=typeof r.value<"u"?this._parseVariable(r):void 0;return{id:i,type:s.flowGraphType,eventData:!0,value:o}})),this._events.push(t)}}_parseNodes(){if(this._interactivityGraph.nodes)for(let e of this._interactivityGraph.nodes){if(typeof e.declaration!="number")throw P.Error(["No declaration found for node",e]),new Error("Error parsing nodes");let t=this._mappings[e.declaration];if(!t)throw P.Error(["No mapping found for node",e]),new Error("Error parsing nodes");if(t.flowGraphMapping.validation){let r=t.flowGraphMapping.validation(e,this._interactivityGraph,this._gltf);if(!r.valid)throw new Error(`Error validating interactivity node ${this._interactivityGraph.declarations?.[e.declaration].op} - ${r.error}`)}let i=[];for(let r of t.flowGraphMapping.blocks){let s=this._getEmptyBlock(r,t.fullOperationName);this._parseNodeConfiguration(e,s,t.flowGraphMapping,r),i.push(s)}this._nodes.push({blocks:i,fullOperationName:t.fullOperationName})}}_getEmptyBlock(e,t){return{uniqueId:Ea(),className:e,dataInputs:[],dataOutputs:[],signalInputs:[],signalOutputs:[],config:{},type:t,metadata:{}}}_parseNodeConfiguration(e,t,i,r){let s=t.config;if(e.configuration){let o=Object.keys(e.configuration);for(let a of o){let l=e.configuration?.[a];if(!l)throw P.Error(["No value found for node configuration",a]),new Error("Error parsing node configuration");let c=i.configuration?.[a];if(c&&c.toBlock?c.toBlock===r:i.blocks.indexOf(r)===0){let h=c?.name||a;(!l||typeof l.value>"u")&&typeof c?.defaultValue<"u"?s[h]={value:c.defaultValue}:l.value.length>=0?s[h]={value:l.value.length===1?l.value[0]:l.value}:P.Warn(["Invalid value for node configuration",l]),c&&c.dataTransformer&&(s[h].value=c.dataTransformer([s[h].value],this)[0])}}}}_parseNodeConnections(e){for(let t=0;t<this._nodes.length;t++){let i=this._interactivityGraph.nodes?.[t];if(!i)throw P.Error(["No node found for interactivity node",this._nodes[t]]),new Error("Error parsing node connections");let r=this._nodes[t],s=this._mappings[i.declaration];if(!s)throw P.Error(["No mapping found for node",i]),new Error("Error parsing node connections");let o=i.flows||{},a=Object.keys(o).sort();for(let u of a){let h=o[u],d=s.flowGraphMapping.outputs?.flows?.[u],f=d?.name||u,p=this._createNewSocketConnection(f,!0);(d&&d.toBlock&&r.blocks.find(R=>R.className===d.toBlock)||r.blocks[0]).signalOutputs.push(p);let _=h.node,y=this._nodes[_];if(!y)throw P.Error(["No node found for input node id",_]),new Error("Error parsing node connections");let b=fC(y.fullOperationName);if(!b)throw P.Error(["No mapping found for input node",y]),new Error("Error parsing node connections");let A=b.inputs?.flows?.[h.socket||"in"],I=!1;if(!A)for(let R in b.inputs?.flows)R.startsWith("[")&&R.endsWith("]")&&(I=!0,A=b.inputs?.flows?.[R]);let v=A?I?A.name.replace("$1",h.socket||""):A.name:h.socket||"in",x=A&&A.toBlock&&y.blocks.find(R=>R.className===A.toBlock)||y.blocks[0],C=x.signalInputs.find(R=>R.name===v);C||(C=this._createNewSocketConnection(v),x.signalInputs.push(C)),C.connectedPointIds.push(p.uniqueId),p.connectedPointIds.push(C.uniqueId)}let l=i.values||{},c=Object.keys(l);for(let u of c){let h=l[u],d=s.flowGraphMapping.inputs?.values?.[u],f=!1;if(!d)for(let y in s.flowGraphMapping.inputs?.values)y.startsWith("[")&&y.endsWith("]")&&(f=!0,d=s.flowGraphMapping.inputs?.values?.[y]);let p=d?f?d.name.replace("$1",u):d.name:u,g=this._createNewSocketConnection(p);if((d&&d.toBlock&&r.blocks.find(y=>y.className===d.toBlock)||r.blocks[0]).dataInputs.push(g),h.value!==void 0){let y=this._parseVariable(h,d&&d.dataTransformer);e._connectionValues[g.uniqueId]=y}else if(typeof h.node<"u"){let y=h.node,b=h.socket||"value",A=this._nodes[y];if(!A)throw P.Error(["No node found for output socket reference",h]),new Error("Error parsing node connections");let I=fC(A.fullOperationName);if(!I)throw P.Error(["No mapping found for output socket reference",h]),new Error("Error parsing node connections");let v=I.outputs?.values?.[b],x=!1;if(!v)for(let D in I.outputs?.values)D.startsWith("[")&&D.endsWith("]")&&(x=!0,v=I.outputs?.values?.[D]);let C=v?x?v.name.replace("$1",b):v?.name:b,R=v&&v.toBlock&&A.blocks.find(D=>D.className===v.toBlock)||A.blocks[0],M=R.dataOutputs.find(D=>D.name===C);M||(M=this._createNewSocketConnection(C,!0),R.dataOutputs.push(M)),g.connectedPointIds.push(M.uniqueId),M.connectedPointIds.push(g.uniqueId)}else throw P.Error(["Invalid value for value connection",h]),new Error("Error parsing node connections")}if(s.flowGraphMapping.interBlockConnectors)for(let u of s.flowGraphMapping.interBlockConnectors){let h=u.input,d=u.output,f=u.isVariable;this._connectFlowGraphNodes(h,d,r.blocks[u.inputBlockIndex],r.blocks[u.outputBlockIndex],f)}if(s.flowGraphMapping.extraProcessor){let u=this._interactivityGraph.declarations?.[i.declaration];if(!u)throw P.Error(["No declaration found for extra processor",i]),new Error("Error parsing node connections");r.blocks=s.flowGraphMapping.extraProcessor(i,u,s.flowGraphMapping,this,r.blocks,e,this._gltf)}}}_createNewSocketConnection(e,t){return{uniqueId:Ea(),name:e,_connectionType:t?1:0,connectedPointIds:[]}}_connectFlowGraphNodes(e,t,i,r,s){let o=s?i.dataInputs:i.signalInputs,a=s?r.dataOutputs:r.signalOutputs,l=o.find(u=>u.name===e)||this._createNewSocketConnection(e),c=a.find(u=>u.name===t)||this._createNewSocketConnection(t,!0);o.find(u=>u.name===e)||o.push(l),a.find(u=>u.name===t)||a.push(c),l.connectedPointIds.push(c.uniqueId),c.connectedPointIds.push(l.uniqueId)}getVariableName(e){return"staticVariable_"+e}serializeToFlowGraph(){let e={uniqueId:Ea(),_userVariables:{},_connectionValues:{}};this._parseNodeConnections(e);for(let i=0;i<this._staticVariables.length;i++){let r=this._staticVariables[i];e._userVariables[this.getVariableName(i)]=r}return{rightHanded:!0,allBlocks:this._nodes.reduce((i,r)=>i.concat(r.blocks),[]),executionContexts:[e]}}};var eh="KHR_interactivity",mC=class{constructor(e){this._loader=e,this.name=eh,this.enabled=this._loader.isExtensionUsed(eh),this._pathConverter=id(this._loader.gltf),e._skipStartAnimationStep=!0;let t=e.babylonScene;t&&Tk(t)}dispose(){this._loader=null,delete this._pathConverter}onReady(){return S(this,null,function*(){if(!this._loader.babylonScene||!this._pathConverter)return;let e=this._loader.babylonScene,t=this._loader.gltf.extensions?.KHR_interactivity;if(!t)return;let i=new i_({scene:e});i.dispatchEventsSynchronously=!1;let r=t.graphs.map(s=>new Gm(s,this._loader.gltf,this._loader.parent.targetFps).serializeToFlowGraph());yield Promise.all(r.map(s=>S(this,null,function*(){return yield fM(s,{coordinator:i,pathConverter:this._pathConverter})}))),i.start()})}};function Tk(n){Zi("/extensions/KHR_interactivity/?/activeCamera/rotation",{get:()=>{if(!n.activeCamera)return new Q(NaN,NaN,NaN,NaN);let e=Q.FromRotationMatrix(n.activeCamera.getWorldMatrix()).normalize();return n.useRightHandedSystem||(e.w*=-1,e.x*=-1),e},type:"Quaternion",getTarget:()=>n.activeCamera}),Zi("/extensions/KHR_interactivity/?/activeCamera/position",{get:()=>{if(!n.activeCamera)return new m(NaN,NaN,NaN);let e=n.activeCamera.getWorldMatrix().getTranslation();return n.useRightHandedSystem||(e.x*=-1),e},type:"Vector3",getTarget:()=>n.activeCamera}),Zi("/animations/{}/extensions/KHR_interactivity/isPlaying",{get:e=>e._babylonAnimationGroup?.isPlaying??!1,type:"boolean",getTarget:e=>e._babylonAnimationGroup}),Zi("/animations/{}/extensions/KHR_interactivity/minTime",{get:e=>(e._babylonAnimationGroup?.from??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup}),Zi("/animations/{}/extensions/KHR_interactivity/maxTime",{get:e=>(e._babylonAnimationGroup?.to??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup}),Zi("/animations/{}/extensions/KHR_interactivity/playhead",{get:e=>(e._babylonAnimationGroup?.getCurrentFrame()??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup}),Zi("/animations/{}/extensions/KHR_interactivity/virtualPlayhead",{get:e=>(e._babylonAnimationGroup?.getCurrentFrame()??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup})}hM(eh,"FlowGraphGLTFDataProvider",()=>S(null,null,function*(){return(yield import("./chunk-K4FU3CPJ.js")).FlowGraphGLTFDataProvider}));de(eh);fe(eh,!0,n=>new mC(n));var Um="KHR_node_visibility";Zi("/nodes/{}/extensions/KHR_node_visibility/visible",{get:n=>{let e=n._babylonTransformNode;return e&&e.isVisible!==void 0?e.isVisible:!0},set:(n,e)=>{e._primitiveBabylonMeshes?.forEach(t=>{t.inheritVisibility=!0}),e._babylonTransformNode&&(e._babylonTransformNode.isVisible=n),e._primitiveBabylonMeshes?.forEach(t=>{t.isVisible=n})},getTarget:n=>n._babylonTransformNode,getPropertyName:[()=>"isVisible"],type:"boolean"});var gC=class{constructor(e){this.name=Um,this._loader=e,this.enabled=e.isExtensionUsed(Um)}onReady(){if(!this._loader)return;let e=this._loader.gltf.nodes;if(e)for(let t of e){let i=t._babylonTransformNode;i&&(i.inheritVisibility=!0,t.extensions&&t.extensions.KHR_node_visibility&&t.extensions.KHR_node_visibility.visible===!1&&(i.isVisible=!1))}}dispose(){delete this._loader}};de(Um);fe(Um,!0,n=>new gC(n));var th="KHR_node_selectability";Ju("event/onSelect",th,{blocks:["FlowGraphMeshPickEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(n){return["pickedMesh_"+n[0]]}}},outputs:{values:{selectedNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"},selectionPoint:{name:"pickedPoint"},selectionRayOrigin:{name:"pickOrigin"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"asset",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"pickedMesh",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(n,e,t,i,r,s,o){let a=r[r.length-1];a.config=a.config||{},a.config.glTF=o;let l=n.configuration?.nodeIndex?.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");let c="pickedMesh_"+l;return r[1].config.variable=c,s._userVariables[c]={className:"Mesh",id:o?.nodes?.[l]._babylonTransformNode?.id,uniqueId:o?.nodes?.[l]._babylonTransformNode?.uniqueId},r}});Zi("/nodes/{}/extensions/KHR_node_selectability/selectable",{get:n=>{let e=n._babylonTransformNode;return e&&e.isPickable!==void 0?e.isPickable:!0},set:(n,e)=>{e._primitiveBabylonMeshes?.forEach(t=>{t.isPickable=n})},getTarget:n=>n._babylonTransformNode,getPropertyName:[()=>"isPickable"],type:"boolean"});var _C=class{constructor(e){this.name=th,this._loader=e,this.enabled=e.isExtensionUsed(th)}onReady(){return S(this,null,function*(){this._loader.gltf.nodes?.forEach(e=>{e.extensions?.KHR_node_selectability&&e.extensions?.KHR_node_selectability.selectable===!1&&e._babylonTransformNode?.getChildMeshes().forEach(t=>{t.isPickable=!1})})})}dispose(){this._loader=null}};de(th);fe(th,!0,n=>new _C(n));var Bl="KHR_node_hoverability",mM="targetMeshPointerOver_";Ju("event/onHoverIn",Bl,{blocks:["FlowGraphPointerOverEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(n){return[mM+n[0]]}}},outputs:{values:{hoverNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"targetMesh",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"meshUnderPointer",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(n,e,t,i,r,s,o){let a=r[r.length-1];a.config=a.config||{},a.config.glTF=o;let l=n.configuration?.nodeIndex?.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");let c=mM+l;return r[1].config.variable=c,s._userVariables[c]={className:"Mesh",id:o?.nodes?.[l]._babylonTransformNode?.id,uniqueId:o?.nodes?.[l]._babylonTransformNode?.uniqueId},r}});var gM="targetMeshPointerOut_";Ju("event/onHoverOut",Bl,{blocks:["FlowGraphPointerOutEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(n){return[gM+n[0]]}}},outputs:{values:{hoverNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"targetMesh",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"meshOutOfPointer",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(n,e,t,i,r,s,o){let a=r[r.length-1];a.config=a.config||{},a.config.glTF=o;let l=n.configuration?.nodeIndex?.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");let c=gM+l;return r[1].config.variable=c,s._userVariables[c]={className:"Mesh",id:o?.nodes?.[l]._babylonTransformNode?.id,uniqueId:o?.nodes?.[l]._babylonTransformNode?.uniqueId},r}});Zi("/nodes/{}/extensions/KHR_node_hoverability/hoverable",{get:n=>{let e=n._babylonTransformNode;return e&&e.pointerOverDisableMeshTesting!==void 0?e.pointerOverDisableMeshTesting:!0},set:(n,e)=>{e._primitiveBabylonMeshes?.forEach(t=>{t.pointerOverDisableMeshTesting=!n})},getTarget:n=>n._babylonTransformNode,getPropertyName:[()=>"pointerOverDisableMeshTesting"],type:"boolean"});var yC=class{constructor(e){this.name=Bl,this._loader=e,this.enabled=e.isExtensionUsed(Bl)}onReady(){return S(this,null,function*(){this._loader.gltf.nodes?.forEach(e=>{e.extensions?.KHR_node_hoverability&&e.extensions?.KHR_node_hoverability.hoverable===!1&&e._babylonTransformNode?.getChildMeshes().forEach(t=>{t.pointerOverDisableMeshTesting=!0})})})}dispose(){this._loader=null}};de(Bl);fe(Bl,!0,n=>new yC(n));var bC="ExtrasAsMetadata",vC=class{_assignExtras(e,t){if(t.extras&&Object.keys(t.extras).length>0){let i=e.metadata=e.metadata||{},r=i.gltf=i.gltf||{};r.extras=t.extras}}constructor(e){this.name=bC,this.enabled=!0,this._loader=e}dispose(){this._loader=null}loadNodeAsync(e,t,i){return this._loader.loadNodeAsync(e,t,r=>{this._assignExtras(r,t),i(r)})}loadCameraAsync(e,t,i){return this._loader.loadCameraAsync(e,t,r=>{this._assignExtras(r,t),i(r)})}createMaterial(e,t,i){let r=this._loader.createMaterial(e,t,i);return this._assignExtras(r,t),r}};de(bC);fe(bC,!1,n=>new vC(n));var kl=class{constructor(e,t,i){this.gradient=e,this.color1=t,this.color2=i}getColorToRef(e){if(!this.color2){e.copyFrom(this.color1);return}ce.LerpToRef(this.color1,this.color2,Math.random(),e)}},zm=class{constructor(e,t){this.gradient=e,this.color=t}},Vl=class{constructor(e,t,i){this.gradient=e,this.factor1=t,this.factor2=i}getFactor(){return this.factor2===void 0||this.factor2===this.factor1?this.factor1:this.factor1+(this.factor2-this.factor1)*Math.random()}},li=class{static GetCurrentGradient(e,t,i){if(t[0].gradient>e){i(t[0],t[0],1);return}for(let s=0;s<t.length-1;s++){let o=t[s],a=t[s+1];if(e>=o.gradient&&e<=a.gradient){let l=(e-o.gradient)/(a.gradient-o.gradient);i(o,a,l);return}}let r=t.length-1;i(t[r],t[r],1)}};var Wi=(()=>{class n{get targetStopDuration(){return this._targetStopDuration}set targetStopDuration(t){this._targetStopDuration!==t&&(this._targetStopDuration=t)}get isNodeGenerated(){return!1}get noiseTexture(){return this._noiseTexture}set noiseTexture(t){this._noiseTexture!==t&&(this._noiseTexture=t,this._reset())}get _isAnimationSheetEnabled(){return this._animationSheetEnabled}set _isAnimationSheetEnabled(t){this._animationSheetEnabled!==t&&(this._animationSheetEnabled=t)}get isAnimationSheetEnabled(){return this._isAnimationSheetEnabled}set isAnimationSheetEnabled(t){this._isAnimationSheetEnabled!=t&&(this._isAnimationSheetEnabled=t,this._reset())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(t){this._useLogarithmicDepth=t&&this.getScene().getEngine().getCaps().fragmentDepthSupported}getScene(){return this._scene}_hasTargetStopDurationDependantGradient(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0}_setEngineBasedOnBlendMode(t){switch(t){case n.BLENDMODE_MULTIPLYADD:return;case n.BLENDMODE_ADD:t=1;break;case n.BLENDMODE_ONEONE:t=6;break;case n.BLENDMODE_STANDARD:t=2;break;case n.BLENDMODE_MULTIPLY:t=4;break;case n.BLENDMODE_SUBTRACT:t=3;break;default:break}this._engine.setAlphaMode(t)}getDragGradients(){return this._dragGradients}getLimitVelocityGradients(){return this._limitVelocityGradients}getColorGradients(){return this._colorGradients}getSizeGradients(){return this._sizeGradients}getColorRemapGradients(){return this._colorRemapGradients}getAlphaRemapGradients(){return this._alphaRemapGradients}getLifeTimeGradients(){return this._lifeTimeGradients}getAngularSpeedGradients(){return this._angularSpeedGradients}getVelocityGradients(){return this._velocityGradients}getStartSizeGradients(){return this._startSizeGradients}getEmitRateGradients(){return this._emitRateGradients}get direction1(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:m.Zero()}set direction1(t){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=t)}get direction2(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:m.Zero()}set direction2(t){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=t)}get minEmitBox(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:m.Zero()}set minEmitBox(t){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=t)}get maxEmitBox(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:m.Zero()}set maxEmitBox(t){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=t)}get billboardMode(){return this._billboardMode}set billboardMode(t){this._billboardMode!==t&&(this._billboardMode=t,this._reset())}get isBillboardBased(){return this._isBillboardBased}set isBillboardBased(t){this._isBillboardBased!==t&&(this._isBillboardBased=t,this._reset())}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(t){this._attachImageProcessingConfiguration(t)}_attachImageProcessingConfiguration(t){t!==this._imageProcessingConfiguration&&(!t&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=t)}_reset(){}_removeGradientAndTexture(t,i,r){if(!i)return this;let s=0;for(let o of i){if(o.gradient===t){i.splice(s,1);break}s++}return r&&r.dispose(),this}constructor(t){this.animations=[],this.renderingGroupId=0,this.emitter=m.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this._targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this.applyFog=!1,this._wasDispatched=!1,this._rootUrl="",this.noiseStrength=new m(10,10,10),this.onAnimationEnd=null,this.blendMode=n.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new me(0,0),this._animationSheetEnabled=!1,this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new m(0,0,0),this._useLogarithmicDepth=!1,this.gravity=m.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new ce(1,1,1,1),this.color2=new ce(1,1,1,1),this.colorDead=new ce(0,0,0,1),this.textureMask=new ce(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new _0,this.id=t,this.name=t}createPointEmitter(t,i){throw new Error("Method not implemented.")}createHemisphericEmitter(t=1,i=1){throw new Error("Method not implemented.")}createSphereEmitter(t=1,i=1){throw new Error("Method not implemented.")}createDirectedSphereEmitter(t=1,i=new m(0,1,0),r=new m(0,1,0)){throw new Error("Method not implemented.")}createCylinderEmitter(t=1,i=1,r=1,s=0){throw new Error("Method not implemented.")}createDirectedCylinderEmitter(t=1,i=1,r=1,s=new m(0,1,0),o=new m(0,1,0)){throw new Error("Method not implemented.")}createConeEmitter(t=1,i=Math.PI/4){throw new Error("Method not implemented.")}createDirectedConeEmitter(t=1,i=Math.PI/4,r=new m(0,1,0),s=new m(0,1,0)){throw new Error("Method not implemented.")}createBoxEmitter(t,i,r,s){throw new Error("Method not implemented.")}}return n.BLENDMODE_ONEONE=0,n.BLENDMODE_STANDARD=1,n.BLENDMODE_ADD=2,n.BLENDMODE_MULTIPLY=3,n.BLENDMODE_MULTIPLYADD=4,n.BLENDMODE_SUBTRACT=-1,n})();le("BABYLON.BaseParticleSystem",Wi);var _M=(()=>{class n{constructor(t){this.particleSystem=t,this.position=m.Zero(),this.direction=m.Zero(),this.color=new ce(0,0,0,0),this.colorStep=new ce(0,0,0,0),this.initialColor=new ce(0,0,0,0),this.colorDead=new ce(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.scale=new me(1,1),this.angle=0,this.angularSpeed=0,this.cellIndex=0,this._attachedSubEmitters=null,this._currentColor1=new ce(0,0,0,0),this._currentColor2=new ce(0,0,0,0),this._currentSize1=0,this._currentSize2=0,this._currentAngularSpeed1=0,this._currentAngularSpeed2=0,this._currentVelocity1=0,this._currentVelocity2=0,this._scaledDirection=m.Zero(),this._currentLimitVelocity1=0,this._currentLimitVelocity2=0,this._currentDrag1=0,this._currentDrag2=0,this.id=n._Count++,this.particleSystem.isAnimationSheetEnabled&&this._updateCellInfoFromSystem()}_updateCellInfoFromSystem(){this.cellIndex=this.particleSystem.startSpriteCellID}updateCellIndex(){let t=this.age,i=this.particleSystem.spriteCellChangeSpeed;this.particleSystem.spriteRandomStartCell&&(this._randomCellOffset===void 0&&(this._randomCellOffset=Math.random()*this.lifeTime),i===0?(i=1,t=this._randomCellOffset):t+=this._randomCellOffset);let r=this._initialEndSpriteCellId-this._initialStartSpriteCellId+1,s;this._initialSpriteCellLoop?s=On(t*i%this.lifeTime/this.lifeTime):s=On(t*i/this.lifeTime),this.cellIndex=this._initialStartSpriteCellId+s*r|0}_inheritParticleInfoToSubEmitter(t){if(t.particleSystem.emitter.position){let i=t.particleSystem.emitter;if(i.position.copyFrom(this.position),t.inheritDirection){let r=k.Vector3[0];this.direction.normalizeToRef(r),i.setDirection(r,0,Math.PI/2)}}else t.particleSystem.emitter.copyFrom(this.position);this.direction.scaleToRef(t.inheritedVelocityAmount/2,k.Vector3[0]),t.particleSystem._inheritedVelocityOffset.copyFrom(k.Vector3[0])}_inheritParticleInfoToSubEmitters(){if(this._attachedSubEmitters&&this._attachedSubEmitters.length>0)for(let t of this._attachedSubEmitters)this._inheritParticleInfoToSubEmitter(t)}_reset(){this.age=0,this.id=n._Count++,this._currentColorGradient=null,this._currentSizeGradient=null,this._currentAngularSpeedGradient=null,this._currentVelocityGradient=null,this._currentLimitVelocityGradient=null,this._currentDragGradient=null,this.cellIndex=this.particleSystem.startSpriteCellID,this._randomCellOffset=void 0}copyTo(t){t.position.copyFrom(this.position),this._initialDirection?t._initialDirection?t._initialDirection.copyFrom(this._initialDirection):t._initialDirection=this._initialDirection.clone():t._initialDirection=null,t.direction.copyFrom(this.direction),this._localPosition&&(t._localPosition?t._localPosition.copyFrom(this._localPosition):t._localPosition=this._localPosition.clone()),t.color.copyFrom(this.color),t.colorStep.copyFrom(this.colorStep),t.initialColor.copyFrom(this.initialColor),t.colorDead.copyFrom(this.colorDead),t.lifeTime=this.lifeTime,t.age=this.age,t._randomCellOffset=this._randomCellOffset,t.size=this.size,t.scale.copyFrom(this.scale),t.angle=this.angle,t.angularSpeed=this.angularSpeed,t.particleSystem=this.particleSystem,t.cellIndex=this.cellIndex,t.id=this.id,t._attachedSubEmitters=this._attachedSubEmitters,this._currentColorGradient&&(t._currentColorGradient=this._currentColorGradient,t._currentColor1.copyFrom(this._currentColor1),t._currentColor2.copyFrom(this._currentColor2)),this._currentSizeGradient&&(t._currentSizeGradient=this._currentSizeGradient,t._currentSize1=this._currentSize1,t._currentSize2=this._currentSize2),this._currentAngularSpeedGradient&&(t._currentAngularSpeedGradient=this._currentAngularSpeedGradient,t._currentAngularSpeed1=this._currentAngularSpeed1,t._currentAngularSpeed2=this._currentAngularSpeed2),this._currentVelocityGradient&&(t._currentVelocityGradient=this._currentVelocityGradient,t._currentVelocity1=this._currentVelocity1,t._currentVelocity2=this._currentVelocity2),this._currentLimitVelocityGradient&&(t._currentLimitVelocityGradient=this._currentLimitVelocityGradient,t._currentLimitVelocity1=this._currentLimitVelocity1,t._currentLimitVelocity2=this._currentLimitVelocity2),this._currentDragGradient&&(t._currentDragGradient=this._currentDragGradient,t._currentDrag1=this._currentDrag1,t._currentDrag2=this._currentDrag2),this.particleSystem.isAnimationSheetEnabled&&(t._initialStartSpriteCellId=this._initialStartSpriteCellId,t._initialEndSpriteCellId=this._initialEndSpriteCellId,t._initialSpriteCellLoop=this._initialSpriteCellLoop),this.particleSystem.useRampGradients&&(t.remapData&&this.remapData?t.remapData.copyFrom(this.remapData):t.remapData=new dt(0,0,0,0)),this._randomNoiseCoordinates1&&(t._randomNoiseCoordinates1?(t._randomNoiseCoordinates1.copyFrom(this._randomNoiseCoordinates1),t._randomNoiseCoordinates2.copyFrom(this._randomNoiseCoordinates2)):(t._randomNoiseCoordinates1=this._randomNoiseCoordinates1.clone(),t._randomNoiseCoordinates2=this._randomNoiseCoordinates2.clone()))}}return n._Count=0,n})();var hr=class n{constructor(){this.direction1=new m(0,1,0),this.direction2=new m(0,1,0),this.minEmitBox=new m(-.5,-.5,-.5),this.maxEmitBox=new m(.5,.5,.5)}startDirectionFunction(e,t,i,r){let s=Ae(this.direction1.x,this.direction2.x),o=Ae(this.direction1.y,this.direction2.y),a=Ae(this.direction1.z,this.direction2.z);if(r){t.x=s,t.y=o,t.z=a;return}m.TransformNormalFromFloatsToRef(s,o,a,e,t)}startPositionFunction(e,t,i,r){let s=Ae(this.minEmitBox.x,this.maxEmitBox.x),o=Ae(this.minEmitBox.y,this.maxEmitBox.y),a=Ae(this.minEmitBox.z,this.maxEmitBox.z);if(r){t.x=s,t.y=o,t.z=a;return}m.TransformCoordinatesFromFloatsToRef(s,o,a,e,t)}clone(){let e=new n;return Tt.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2),e.setVector3("minEmitBox",this.minEmitBox),e.setVector3("maxEmitBox",this.maxEmitBox)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3),e.addUniform("minEmitBox",3),e.addUniform("maxEmitBox",3)}getEffectDefines(){return"#define BOXEMITTER"}getClassName(){return"BoxParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.minEmitBox=this.minEmitBox.asArray(),e.maxEmitBox=this.maxEmitBox.asArray(),e}parse(e){m.FromArrayToRef(e.direction1,0,this.direction1),m.FromArrayToRef(e.direction2,0,this.direction2),m.FromArrayToRef(e.minEmitBox,0,this.minEmitBox),m.FromArrayToRef(e.maxEmitBox,0,this.maxEmitBox)}};function xC(n,e){let t=Ae(0,1);ce.LerpToRef(e.color1,e.color2,t,n.color)}function yM(n,e){e.colorDead.subtractToRef(n.color,e._colorDiff),e._colorDiff.scaleToRef(1/n.lifeTime,n.colorStep)}function vM(n,e){n._currentColorGradient=e._colorGradients[0],n._currentColorGradient.getColorToRef(n.color),n._currentColor1.copyFrom(n.color),e._colorGradients.length>1?e._colorGradients[1].getColorToRef(n._currentColor2):n._currentColor2.copyFrom(n.color)}function bM(n,e){let t=e._colorGradients;li.GetCurrentGradient(e._ratio,t,(i,r,s)=>{i!==n._currentColorGradient&&(n._currentColor1.copyFrom(n._currentColor2),r.getColorToRef(n._currentColor2),n._currentColorGradient=i),ce.LerpToRef(n._currentColor1,n._currentColor2,s,n.color),n.color.a<0&&(n.color.a=0)})}function CC(n,e){n.colorStep.scaleToRef(e._scaledUpdateSpeed,e._scaledColorStep),n.color.addInPlace(e._scaledColorStep),n.color.a<0&&(n.color.a=0)}function xM(n,e){li.GetCurrentGradient(e._ratio,e._angularSpeedGradients,(t,i,r)=>{t!==n._currentAngularSpeedGradient&&(n._currentAngularSpeed1=n._currentAngularSpeed2,n._currentAngularSpeed2=i.getFactor(),n._currentAngularSpeedGradient=t),n.angularSpeed=Qt(n._currentAngularSpeed1,n._currentAngularSpeed2,r)})}function CM(n,e){n.angle+=n.angularSpeed*e._scaledUpdateSpeed}function TC(n,e){e.particleEmitterType.startDirectionFunction(e._emitterWorldMatrix,n.direction,n,e.isLocal,e._emitterInverseWorldMatrix)}function TM(n,e){e.startDirectionFunction(e._emitterWorldMatrix,n.direction,n,e.isLocal)}function SM(n,e){n._currentVelocityGradient=e._velocityGradients[0],n._currentVelocity1=n._currentVelocityGradient.getFactor(),e._velocityGradients.length>1?n._currentVelocity2=e._velocityGradients[1].getFactor():n._currentVelocity2=n._currentVelocity1}function IM(n,e){n._currentLimitVelocityGradient=e._limitVelocityGradients[0],n._currentLimitVelocity1=n._currentLimitVelocityGradient.getFactor(),e._limitVelocityGradients.length>1?n._currentLimitVelocity2=e._limitVelocityGradients[1].getFactor():n._currentLimitVelocity2=n._currentLimitVelocity1}function AM(n,e){li.GetCurrentGradient(e._ratio,e._velocityGradients,(t,i,r)=>{t!==n._currentVelocityGradient&&(n._currentVelocity1=n._currentVelocity2,n._currentVelocity2=i.getFactor(),n._currentVelocityGradient=t),n._directionScale*=Qt(n._currentVelocity1,n._currentVelocity2,r)})}function EM(n,e){li.GetCurrentGradient(e._ratio,e._limitVelocityGradients,(t,i,r)=>{t!==n._currentLimitVelocityGradient&&(n._currentLimitVelocity1=n._currentLimitVelocity2,n._currentLimitVelocity2=i.getFactor(),n._currentLimitVelocityGradient=t);let s=Qt(n._currentLimitVelocity1,n._currentLimitVelocity2,r);n.direction.length()>s&&n.direction.scaleInPlace(e.limitVelocityDamping)})}function wM(n){n.direction.scaleToRef(n._directionScale,n._scaledDirection)}function SC(n,e){e.particleEmitterType.startPositionFunction(e._emitterWorldMatrix,n.position,n,e.isLocal)}function MM(n,e){e.startPositionFunction(e._emitterWorldMatrix,n.position,n,e.isLocal)}function DM(n,e){n._localPosition?n._localPosition.copyFrom(n.position):n._localPosition=n.position.clone(),m.TransformCoordinatesToRef(n._localPosition,e._emitterWorldMatrix,n.position)}function RM(n,e){e.isLocal&&n._localPosition?(n._localPosition.addInPlace(n._scaledDirection),m.TransformCoordinatesToRef(n._localPosition,e._emitterWorldMatrix,n.position)):n.position.addInPlace(n._scaledDirection)}function PM(n,e){n._currentDragGradient=e._dragGradients[0],n._currentDrag1=n._currentDragGradient.getFactor(),e._dragGradients.length>1?n._currentDrag2=e._dragGradients[1].getFactor():n._currentDrag2=n._currentDrag1}function OM(n,e){li.GetCurrentGradient(e._ratio,e._dragGradients,(t,i,r)=>{t!==n._currentDragGradient&&(n._currentDrag1=n._currentDrag2,n._currentDrag2=i.getFactor(),n._currentDragGradient=t);let s=Qt(n._currentDrag1,n._currentDrag2,r);n._scaledDirection.scaleInPlace(1-s)})}function NM(n,e){n._randomNoiseCoordinates1?(n._randomNoiseCoordinates1.copyFromFloats(Math.random(),Math.random(),Math.random()),n._randomNoiseCoordinates2.copyFromFloats(Math.random(),Math.random(),Math.random())):(n._randomNoiseCoordinates1=new m(Math.random(),Math.random(),Math.random()),n._randomNoiseCoordinates2=new m(Math.random(),Math.random(),Math.random()))}function FM(n,e){let t=e._noiseTextureData,i=e._noiseTextureSize;if(t&&i&&n._randomNoiseCoordinates1){let r=e._fetchR(n._randomNoiseCoordinates1.x,n._randomNoiseCoordinates1.y,i.width,i.height,t),s=e._fetchR(n._randomNoiseCoordinates1.z,n._randomNoiseCoordinates2.x,i.width,i.height,t),o=e._fetchR(n._randomNoiseCoordinates2.y,n._randomNoiseCoordinates2.z,i.width,i.height,t),a=k.Vector3[0],l=k.Vector3[1];a.copyFromFloats((2*r-1)*e.noiseStrength.x,(2*s-1)*e.noiseStrength.y,(2*o-1)*e.noiseStrength.z),a.scaleToRef(e._tempScaledUpdateSpeed,l),n.direction.addInPlace(l)}}function LM(n,e){e.gravity.scaleToRef(e._tempScaledUpdateSpeed,e._scaledGravity),n.direction.addInPlace(e._scaledGravity)}function IC(n,e){n.size=Ae(e.minSize,e.maxSize),n.scale.copyFromFloats(Ae(e.minScaleX,e.maxScaleX),Ae(e.minScaleY,e.maxScaleY))}function BM(n,e){n._currentSizeGradient=e._sizeGradients[0],n._currentSize1=n._currentSizeGradient.getFactor(),n.size=n._currentSize1,e._sizeGradients.length>1?n._currentSize2=e._sizeGradients[1].getFactor():n._currentSize2=n._currentSize1,n.scale.copyFromFloats(Ae(e.minScaleX,e.maxScaleX),Ae(e.minScaleY,e.maxScaleY))}function kM(n,e){let t=e._actualFrame/e.targetStopDuration;li.GetCurrentGradient(t,e._startSizeGradients,(i,r,s)=>{i!==e._currentStartSizeGradient&&(e._currentStartSize1=e._currentStartSize2,e._currentStartSize2=r.getFactor(),e._currentStartSizeGradient=i);let o=Qt(e._currentStartSize1,e._currentStartSize2,s);n.scale.scaleInPlace(o)})}function VM(n,e){li.GetCurrentGradient(e._ratio,e._sizeGradients,(t,i,r)=>{t!==n._currentSizeGradient&&(n._currentSize1=n._currentSize2,n._currentSize2=i.getFactor(),n._currentSizeGradient=t),n.size=Qt(n._currentSize1,n._currentSize2,r)})}function GM(n,e){n.remapData=new dt(0,1,0,1)}function UM(n,e){e._colorRemapGradients&&e._colorRemapGradients.length>0&&li.GetCurrentGradient(e._ratio,e._colorRemapGradients,(t,i,r)=>{let s=Qt(t.factor1,i.factor1,r),o=Qt(t.factor2,i.factor2,r);n.remapData.x=s,n.remapData.y=o-s}),e._alphaRemapGradients&&e._alphaRemapGradients.length>0&&li.GetCurrentGradient(e._ratio,e._alphaRemapGradients,(t,i,r)=>{let s=Qt(t.factor1,i.factor1,r),o=Qt(t.factor2,i.factor2,r);n.remapData.z=s,n.remapData.w=o-s})}function zM(n,e){let t=On(e._actualFrame/e.targetStopDuration);li.GetCurrentGradient(t,e._lifeTimeGradients,(i,r)=>{let s=i,o=r,a=s.getFactor(),l=o.getFactor(),c=(t-s.gradient)/(o.gradient-s.gradient);n.lifeTime=Qt(a,l,c)}),e._emitPower=Ae(e.minEmitPower,e.maxEmitPower)}function AC(n,e){n.lifeTime=Ae(e.minLifeTime,e.maxLifeTime),e._emitPower=Ae(e.minEmitPower,e.maxEmitPower)}function HM(n,e){e._emitPower===0?(n._initialDirection?n._initialDirection.copyFrom(n.direction):n._initialDirection=n.direction.clone(),n.direction.set(0,0,0)):(n._initialDirection=null,n.direction.scaleInPlace(e._emitPower)),n.direction.addInPlace(e._inheritedVelocityOffset)}function EC(n,e){n.angularSpeed=Ae(e.minAngularSpeed,e.maxAngularSpeed),n.angle=Ae(e.minInitialRotation,e.maxInitialRotation)}function WM(n,e){n._currentAngularSpeedGradient=e._angularSpeedGradients[0],n.angularSpeed=n._currentAngularSpeedGradient.getFactor(),n._currentAngularSpeed1=n.angularSpeed,e._angularSpeedGradients.length>1?n._currentAngularSpeed2=e._angularSpeedGradients[1].getFactor():n._currentAngularSpeed2=n._currentAngularSpeed1,n.angle=Ae(e.minInitialRotation,e.maxInitialRotation)}function $M(n,e){n._initialStartSpriteCellId=e.startSpriteCellID,n._initialEndSpriteCellId=e.endSpriteCellID,n._initialSpriteCellLoop=e.spriteCellLoop}function Gl(n,e){n.previousItem=e.previousItem,n.nextItem=e,e.previousItem&&(e.previousItem.nextItem=n),e.previousItem=n}function Rt(n,e){n.previousItem=e,n.nextItem=e.nextItem,e.nextItem&&(e.nextItem.previousItem=n),e.nextItem=n}function ci(n){n.previousItem&&(n.previousItem.nextItem=n.nextItem),n.nextItem&&(n.nextItem.previousItem=n.previousItem)}var jM=(()=>{class n extends Wi{get startDirectionFunction(){return this._startDirectionFunction}set startDirectionFunction(t){this._startDirectionFunction!==t&&(this._startDirectionFunction=t,t?this._directionProcessing.process=TM:this._directionProcessing.process=TC)}get startPositionFunction(){return this._startPositionFunction}set startPositionFunction(t){this._startPositionFunction!==t&&(this._startPositionFunction=t,t?this._positionCreation.process=MM:this._positionCreation.process=SC)}set onDispose(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)}get isDisposed(){return this._isDisposed}get useRampGradients(){return this._useRampGradients}set useRampGradients(t){this._useRampGradients!==t&&(this._useRampGradients=t,this._resetEffect(),t?(this._rampCreation={process:GM,previousItem:null,nextItem:null},Rt(this._rampCreation,this._colorDeadCreation),this._remapGradientProcessing={process:UM,previousItem:null,nextItem:null},Rt(this._remapGradientProcessing,this._gravityProcessing)):(ci(this._rampCreation),ci(this._remapGradientProcessing)))}get isLocal(){return this._isLocal}set isLocal(t){this._isLocal!==t&&(this._isLocal=t,t?(this._isLocalCreation={process:DM,previousItem:null,nextItem:null},Rt(this._isLocalCreation,this._positionCreation)):ci(this._isLocalCreation))}get particles(){return this._particles}get shaderLanguage(){return this._shaderLanguage}get _isAnimationSheetEnabled(){return this._animationSheetEnabled}set _isAnimationSheetEnabled(t){this._animationSheetEnabled!==t&&(this._animationSheetEnabled=t,t?(this._sheetCreation={process:$M,previousItem:null,nextItem:null},Rt(this._sheetCreation,this._colorDeadCreation)):ci(this._sheetCreation),this._reset())}getActiveCount(){return this._particles.length}getClassName(){return"ParticleSystem"}isStopping(){return this._stopped&&this.isAlive()}getCustomEffect(t=0){return this._customWrappers[t]?.effect??this._customWrappers[0].effect}_getCustomDrawWrapper(t=0){return this._customWrappers[t]??this._customWrappers[0]}setCustomEffect(t,i=0){this._customWrappers[i]=new Ti(this._engine),this._customWrappers[i].effect=t,this._customWrappers[i].drawContext&&(this._customWrappers[i].drawContext.useInstancing=this._useInstancing)}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new F),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"particles"}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get noiseTexture(){return this._noiseTexture}set noiseTexture(t){if(this.noiseTexture!==t){if(this._noiseTexture=t,!t){ci(this._noiseCreation),ci(this._noiseProcessing);return}this._noiseCreation={process:NM,previousItem:null,nextItem:null},Rt(this._noiseCreation,this._colorDeadCreation),this._noiseProcessing={process:FM,previousItem:null,nextItem:null},Rt(this._noiseProcessing,this._positionProcessing)}}constructor(t,i,r,s=null,o=!1,a=.01,l=!1){super(t),this._emitterInverseWorldMatrix=L.Identity(),this._startDirectionFunction=null,this._startPositionFunction=null,this._inheritedVelocityOffset=new m,this.onDisposeObservable=new F,this.onStoppedObservable=new F,this.onStartedObservable=new F,this._noiseTextureSize=null,this._noiseTextureData=null,this._particles=new Array,this._stockParticles=new Array,this._newPartsExcess=0,this._vertexBuffers={},this._scaledColorStep=new ce(0,0,0,0),this._colorDiff=new ce(0,0,0,0),this._scaledGravity=m.Zero(),this._currentRenderId=-1,this._useInstancing=!1,this._isDisposed=!1,this._started=!1,this._stopped=!1,this._actualFrame=0,this._currentEmitRate1=0,this._currentEmitRate2=0,this._currentStartSize1=0,this._currentStartSize2=0,this.updateInAnimate=!0,this._rawTextureWidth=256,this._useRampGradients=!1,this._updateQueueStart=null,this._startSizeCreation=null,this._createQueueStart=null,this._isLocal=!1,this.isGPU=!1,this._shaderLanguage=0,this._onBeforeDrawParticlesObservable=null,this._emitFromParticle=c=>{},this.recycleParticle=c=>{let u=this._particles.pop();u!==c&&u.copyTo(c),this._stockParticles.push(u)},this._createParticle=()=>{let c;return this._stockParticles.length!==0?(c=this._stockParticles.pop(),c._reset()):c=new _M(this),this._prepareParticle(c),c},this.paused=!1,this._shadersLoaded=!1,this._capacity=i,this._epsilon=a,!r||r.getClassName()==="Scene"?(this._scene=r||ye.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)):(this._engine=r,this.defaultProjectionMatrix=L.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)),this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._initShaderSourceAsync(),this._lifeTimeCreation={process:AC,previousItem:null,nextItem:null},this._positionCreation={process:SC,previousItem:null,nextItem:null},Rt(this._positionCreation,this._lifeTimeCreation),this._directionCreation={process:TC,previousItem:null,nextItem:null},Rt(this._directionCreation,this._positionCreation),this._emitPowerCreation={process:HM,previousItem:null,nextItem:null},Rt(this._emitPowerCreation,this._directionCreation),this._sizeCreation={process:IC,previousItem:null,nextItem:null},Rt(this._sizeCreation,this._emitPowerCreation),this._angleCreation={process:EC,previousItem:null,nextItem:null},Rt(this._angleCreation,this._sizeCreation),this._colorCreation={process:xC,previousItem:null,nextItem:null},Rt(this._colorCreation,this._angleCreation),this._colorDeadCreation={process:yM,previousItem:null,nextItem:null},Rt(this._colorDeadCreation,this._colorCreation),this._createQueueStart=this._lifeTimeCreation,l||(this._colorProcessing={process:CC,previousItem:null,nextItem:null},this._angularSpeedProcessing={process:CM,previousItem:null,nextItem:null},Rt(this._angularSpeedProcessing,this._colorProcessing),this._directionProcessing={process:wM,previousItem:null,nextItem:null},Rt(this._directionProcessing,this._angularSpeedProcessing),this._positionProcessing={process:RM,previousItem:null,nextItem:null},Rt(this._positionProcessing,this._directionProcessing),this._gravityProcessing={process:LM,previousItem:null,nextItem:null},Rt(this._gravityProcessing,this._positionProcessing),this._updateQueueStart=this._colorProcessing),this._isAnimationSheetEnabled=o,this._attachImageProcessingConfiguration(null),this._customWrappers={0:new Ti(this._engine)},this._customWrappers[0].effect=s,this._drawWrappers=[],this._useInstancing=this._engine.getCaps().instancedArrays,this._createIndexBuffer(),this._createVertexBuffers(),this.particleEmitterType=new hr,this.updateFunction=c=>{this.noiseTexture&&(this._noiseTextureSize=this.noiseTexture.getSize(),this.noiseTexture.getContent()?.then(h=>{this._noiseTextureData=h}));let u=c===this._particles;for(let h=0;h<c.length;h++){let d=c[h];this._tempScaledUpdateSpeed=this._scaledUpdateSpeed;let f=d.age;if(d.age+=this._tempScaledUpdateSpeed,d.age>d.lifeTime){let g=d.age-f,_=d.lifeTime-f;this._tempScaledUpdateSpeed=_*this._tempScaledUpdateSpeed/g,d.age=d.lifeTime}this._ratio=d.age/d.lifeTime,d._directionScale=this._tempScaledUpdateSpeed;let p=this._updateQueueStart;for(;p;)p.process(d,this),p=p.nextItem;if(this._isAnimationSheetEnabled&&!l&&d.updateCellIndex(),d._inheritParticleInfoToSubEmitters(),d.age>=d.lifeTime){if(this._emitFromParticle(d),d._attachedSubEmitters){for(let g of d._attachedSubEmitters)g.particleSystem.disposeOnStop=!0,g.particleSystem.stop();d._attachedSubEmitters=null}this.recycleParticle(d),u&&h--;continue}}}}serialize(t){throw new Error("Method not implemented.")}clone(t,i,r=!1){throw new Error("Method not implemented.")}_addFactorGradient(t,i,r,s){let o=new Vl(i,r,s);t.push(o),t.sort((a,l)=>a.gradient<l.gradient?-1:a.gradient>l.gradient?1:0)}_removeFactorGradient(t,i){if(!t)return;let r=0;for(let s of t){if(s.gradient===i){t.splice(r,1);break}r++}}_syncLifeTimeCreation(){if(this.targetStopDuration&&this._lifeTimeGradients&&this._lifeTimeGradients.length>0){this._lifeTimeCreation.process=zM;return}this._lifeTimeCreation.process=AC}_syncStartSizeCreation(){if(this._startSizeGradients&&this._startSizeGradients[0]&&this.targetStopDuration){this._startSizeCreation||(this._startSizeCreation={process:kM,previousItem:null,nextItem:null},Rt(this._startSizeCreation,this._sizeCreation));return}this._startSizeCreation&&(ci(this._startSizeCreation),this._startSizeCreation=null)}get targetStopDuration(){return this._targetStopDuration}set targetStopDuration(t){this.targetStopDuration!==t&&(this._targetStopDuration=t,this._syncLifeTimeCreation(),this._syncStartSizeCreation())}addLifeTimeGradient(t,i,r){return this._lifeTimeGradients||(this._lifeTimeGradients=[]),this._addFactorGradient(this._lifeTimeGradients,t,i,r),this._syncLifeTimeCreation(),this}removeLifeTimeGradient(t){return this._removeFactorGradient(this._lifeTimeGradients,t),this._syncLifeTimeCreation(),this}addSizeGradient(t,i,r){return this._sizeGradients||(this._sizeGradients=[]),this._sizeGradients.length===0&&(this._sizeCreation.process=BM,this._sizeGradientProcessing={process:VM,previousItem:null,nextItem:null},Gl(this._sizeGradientProcessing,this._gravityProcessing)),this._addFactorGradient(this._sizeGradients,t,i,r),this}removeSizeGradient(t){return this._removeFactorGradient(this._sizeGradients,t),this._sizeGradients?.length===0&&(ci(this._sizeGradientProcessing),this._sizeCreation.process=IC),this}addColorRemapGradient(t,i,r){return this._colorRemapGradients||(this._colorRemapGradients=[]),this._addFactorGradient(this._colorRemapGradients,t,i,r),this}removeColorRemapGradient(t){return this._removeFactorGradient(this._colorRemapGradients,t),this}addAlphaRemapGradient(t,i,r){return this._alphaRemapGradients||(this._alphaRemapGradients=[]),this._addFactorGradient(this._alphaRemapGradients,t,i,r),this}removeAlphaRemapGradient(t){return this._removeFactorGradient(this._alphaRemapGradients,t),this}addAngularSpeedGradient(t,i,r){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._angularSpeedGradients.length===0&&(this._angleCreation.process=WM,this._angularSpeedGradientProcessing={process:xM,previousItem:null,nextItem:null},Gl(this._angularSpeedGradientProcessing,this._angularSpeedProcessing)),this._addFactorGradient(this._angularSpeedGradients,t,i,r),this}removeAngularSpeedGradient(t){return this._removeFactorGradient(this._angularSpeedGradients,t),this._angularSpeedGradients?.length===0&&(this._angleCreation.process=EC,ci(this._angularSpeedGradientProcessing)),this}addVelocityGradient(t,i,r){return this._velocityGradients||(this._velocityGradients=[]),this._velocityGradients.length===0&&(this._velocityCreation={process:SM,previousItem:null,nextItem:null},Rt(this._velocityCreation,this._angleCreation),this._velocityGradientProcessing={process:AM,previousItem:null,nextItem:null},Gl(this._velocityGradientProcessing,this._directionProcessing)),this._addFactorGradient(this._velocityGradients,t,i,r),this}removeVelocityGradient(t){return this._removeFactorGradient(this._velocityGradients,t),this._velocityGradients?.length===0&&(ci(this._velocityCreation),ci(this._velocityGradientProcessing)),this}addLimitVelocityGradient(t,i,r){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._limitVelocityGradients.length===0&&(this._limitVelocityCreation={process:IM,previousItem:null,nextItem:null},Rt(this._limitVelocityCreation,this._angleCreation),this._limitVelocityGradientProcessing={process:EM,previousItem:null,nextItem:null},Rt(this._limitVelocityGradientProcessing,this._directionProcessing)),this._addFactorGradient(this._limitVelocityGradients,t,i,r),this}removeLimitVelocityGradient(t){return this._removeFactorGradient(this._limitVelocityGradients,t),this._limitVelocityGradients?.length===0&&(ci(this._limitVelocityCreation),ci(this._limitVelocityGradientProcessing)),this}addDragGradient(t,i,r){return this._dragGradients||(this._dragGradients=[]),this._dragGradients.length===0&&(this._dragCreation={process:PM,previousItem:null,nextItem:null},Gl(this._dragCreation,this._colorDeadCreation),this._dragGradientProcessing={process:OM,previousItem:null,nextItem:null},Gl(this._dragGradientProcessing,this._positionProcessing)),this._addFactorGradient(this._dragGradients,t,i,r),this}removeDragGradient(t){return this._removeFactorGradient(this._dragGradients,t),this._dragGradients?.length===0&&(ci(this._dragCreation),ci(this._dragGradientProcessing)),this}addEmitRateGradient(t,i,r){return this._emitRateGradients||(this._emitRateGradients=[]),this._addFactorGradient(this._emitRateGradients,t,i,r),this}removeEmitRateGradient(t){return this._removeFactorGradient(this._emitRateGradients,t),this}addStartSizeGradient(t,i,r){return this._startSizeGradients||(this._startSizeGradients=[]),this._addFactorGradient(this._startSizeGradients,t,i,r),this._syncStartSizeCreation(),this}removeStartSizeGradient(t){return this._removeFactorGradient(this._startSizeGradients,t),this._syncStartSizeCreation(),this}_createRampGradientTexture(){if(!this._rampGradients||!this._rampGradients.length||this._rampGradientsTexture||!this._scene)return;let t=new Uint8Array(this._rawTextureWidth*4),i=ot.Color3[0];for(let r=0;r<this._rawTextureWidth;r++){let s=r/this._rawTextureWidth;li.GetCurrentGradient(s,this._rampGradients,(o,a,l)=>{U.LerpToRef(o.color,a.color,l,i),t[r*4]=i.r*255,t[r*4+1]=i.g*255,t[r*4+2]=i.b*255,t[r*4+3]=255})}this._rampGradientsTexture=_i.CreateRGBATexture(t,this._rawTextureWidth,1,this._scene,!1,!1,1)}getRampGradients(){return this._rampGradients}forceRefreshGradients(){this._syncRampGradientTexture()}_syncRampGradientTexture(){this._rampGradients&&(this._rampGradients.sort((t,i)=>t.gradient<i.gradient?-1:t.gradient>i.gradient?1:0),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._createRampGradientTexture())}addRampGradient(t,i){this._rampGradients||(this._rampGradients=[]);let r=new zm(t,i);return this._rampGradients.push(r),this._syncRampGradientTexture(),this}removeRampGradient(t){return this._removeGradientAndTexture(t,this._rampGradients,this._rampGradientsTexture),this._rampGradientsTexture=null,this._rampGradients&&this._rampGradients.length>0&&this._createRampGradientTexture(),this}addColorGradient(t,i,r){this._colorGradients||(this._colorGradients=[]),this._colorGradients.length===0&&(this._colorCreation.process=vM,this._colorProcessing.process=bM);let s=new kl(t,i,r);return this._colorGradients.push(s),this._colorGradients.sort((o,a)=>o.gradient<a.gradient?-1:o.gradient>a.gradient?1:0),this}removeColorGradient(t){if(!this._colorGradients)return this;let i=0;for(let r of this._colorGradients){if(r.gradient===t){this._colorGradients.splice(i,1);break}i++}return this._colorGradients.length===0&&(this._colorCreation.process=xC,this._colorProcessing.process=CC),this}resetDrawCache(){if(this._drawWrappers){for(let t of this._drawWrappers)if(t)for(let i of t)i?.dispose();this._drawWrappers=[]}}_fetchR(t,i,r,s,o){t=Math.abs(t)*.5+.5,i=Math.abs(i)*.5+.5;let a=t*r%r|0,l=i*s%s|0,c=(a+l*r)*4;return o[c]/255}_reset(){this._resetEffect()}_resetEffect(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this._createVertexBuffers()}_createVertexBuffers(){this._vertexBufferSize=this._useInstancing?10:12,this._isAnimationSheetEnabled&&(this._vertexBufferSize+=1),(!this._isBillboardBased||this.billboardMode===8||this.billboardMode===9)&&(this._vertexBufferSize+=3),this._useRampGradients&&(this._vertexBufferSize+=4);let t=this._engine,i=this._vertexBufferSize*(this._useInstancing?1:4);this._vertexData=new Float32Array(this._capacity*i),this._vertexBuffer=new ei(t,this._vertexData,!0,i);let r=0,s=this._vertexBuffer.createVertexBuffer(T.PositionKind,r,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[T.PositionKind]=s,r+=3;let o=this._vertexBuffer.createVertexBuffer(T.ColorKind,r,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[T.ColorKind]=o,r+=4;let a=this._vertexBuffer.createVertexBuffer("angle",r,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.angle=a,r+=1;let l=this._vertexBuffer.createVertexBuffer("size",r,2,this._vertexBufferSize,this._useInstancing);if(this._vertexBuffers.size=l,r+=2,this._isAnimationSheetEnabled){let u=this._vertexBuffer.createVertexBuffer("cellIndex",r,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.cellIndex=u,r+=1}if(!this._isBillboardBased||this.billboardMode===8||this.billboardMode===9){let u=this._vertexBuffer.createVertexBuffer("direction",r,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.direction=u,r+=3}if(this._useRampGradients){let u=this._vertexBuffer.createVertexBuffer("remapData",r,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.remapData=u,r+=4}let c;if(this._useInstancing){let u=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new ei(t,u,!1,2),c=this._spriteBuffer.createVertexBuffer("offset",0,2)}else c=this._vertexBuffer.createVertexBuffer("offset",r,2,this._vertexBufferSize,this._useInstancing),r+=2;this._vertexBuffers.offset=c,this.resetDrawCache()}_createIndexBuffer(){if(this._useInstancing){this._linesIndexBufferUseInstancing=this._engine.createIndexBuffer(new Uint32Array([0,1,1,3,3,2,2,0,0,3]));return}let t=[],i=[],r=0;for(let s=0;s<this._capacity;s++)t.push(r),t.push(r+1),t.push(r+2),t.push(r),t.push(r+2),t.push(r+3),i.push(r,r+1,r+1,r+2,r+2,r+3,r+3,r,r,r+3),r+=4;this._indexBuffer=this._engine.createIndexBuffer(t),this._linesIndexBuffer=this._engine.createIndexBuffer(i)}getCapacity(){return this._capacity}isAlive(){return this._alive}isStarted(){return this._started}_preStart(){}start(t=this.startDelay){if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(t){this.startDelay=t,setTimeout(()=>{this.start(0)},t);return}if(this._started=!0,this._stopped=!1,this._actualFrame=0,this._preStart(),this._emitRateGradients&&(this._emitRateGradients.length>0&&(this._currentEmitRateGradient=this._emitRateGradients[0],this._currentEmitRate1=this._currentEmitRateGradient.getFactor(),this._currentEmitRate2=this._currentEmitRate1),this._emitRateGradients.length>1&&(this._currentEmitRate2=this._emitRateGradients[1].getFactor())),this._startSizeGradients&&(this._startSizeGradients.length>0&&(this._currentStartSizeGradient=this._startSizeGradients[0],this._currentStartSize1=this._currentStartSizeGradient.getFactor(),this._currentStartSize2=this._currentStartSize1),this._startSizeGradients.length>1&&(this._currentStartSize2=this._startSizeGradients[1].getFactor())),this.preWarmCycles){this.emitter?.getClassName().indexOf("Mesh")!==-1&&this.emitter.computeWorldMatrix(!0);let i=this.noiseTexture;if(i&&i.onGeneratedObservable)i.onGeneratedObservable.addOnce(()=>{setTimeout(()=>{for(let r=0;r<this.preWarmCycles;r++)this.animate(!0),i.render()})});else for(let r=0;r<this.preWarmCycles;r++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop),this.onStartedObservable.notifyObservers(this)}stop(t=!0){this._stopped||(this.onStoppedObservable.notifyObservers(this),this._stopped=!0,this._postStop(t))}_postStop(t){}reset(){this._stockParticles.length=0,this._particles.length=0}_appendParticleVertex(t,i,r,s){let o=t*this._vertexBufferSize,a=k.Vector3[0].copyFrom(this._scene?.floatingOriginOffset||m.ZeroReadOnly);if(this._vertexData[o++]=i.position.x+this.worldOffset.x-a.x,this._vertexData[o++]=i.position.y+this.worldOffset.y-a.y,this._vertexData[o++]=i.position.z+this.worldOffset.z-a.z,this._vertexData[o++]=i.color.r,this._vertexData[o++]=i.color.g,this._vertexData[o++]=i.color.b,this._vertexData[o++]=i.color.a,this._vertexData[o++]=i.angle,this._vertexData[o++]=i.scale.x*i.size,this._vertexData[o++]=i.scale.y*i.size,this._isAnimationSheetEnabled&&(this._vertexData[o++]=i.cellIndex),this._isBillboardBased)(this.billboardMode===8||this.billboardMode===9)&&(this._vertexData[o++]=i.direction.x,this._vertexData[o++]=i.direction.y,this._vertexData[o++]=i.direction.z);else if(i._initialDirection){let l=i._initialDirection;this.isLocal&&(m.TransformNormalToRef(l,this._emitterWorldMatrix,k.Vector3[0]),l=k.Vector3[0]),l.x===0&&l.z===0&&(l.x=.001),this._vertexData[o++]=l.x,this._vertexData[o++]=l.y,this._vertexData[o++]=l.z}else{let l=i.direction;this.isLocal&&(m.TransformNormalToRef(l,this._emitterWorldMatrix,k.Vector3[0]),l=k.Vector3[0]),l.x===0&&l.z===0&&(l.x=.001),this._vertexData[o++]=l.x,this._vertexData[o++]=l.y,this._vertexData[o++]=l.z}this._useRampGradients&&i.remapData&&(this._vertexData[o++]=i.remapData.x,this._vertexData[o++]=i.remapData.y,this._vertexData[o++]=i.remapData.z,this._vertexData[o++]=i.remapData.w),this._useInstancing||(this._isAnimationSheetEnabled&&(r===0?r=this._epsilon:r===1&&(r=1-this._epsilon),s===0?s=this._epsilon:s===1&&(s=1-this._epsilon)),this._vertexData[o++]=r,this._vertexData[o++]=s)}_prepareParticle(t){}_createNewOnes(t){let i;for(let r=0;r<t&&this._particles.length!==this._capacity;r++){i=this._createParticle(),this._particles.push(i);let s=this._createQueueStart;for(;s;)s.process(i,this),s=s.nextItem;i._inheritParticleInfoToSubEmitters()}}_update(t){if(this._alive=this._particles.length>0,this.emitter.position){let i=this.emitter;this._emitterWorldMatrix=i.getWorldMatrix()}else{let i=this.emitter;this._emitterWorldMatrix=L.Translation(i.x,i.y,i.z)}this._emitterWorldMatrix.invertToRef(this._emitterInverseWorldMatrix),this.updateFunction(this._particles),this._createNewOnes(t)}static _GetAttributeNamesOrOptions(t=!1,i=!1,r=!1){let s=[T.PositionKind,T.ColorKind,"angle","offset","size"];return t&&s.push("cellIndex"),i||s.push("direction"),r&&s.push("remapData"),s}static _GetEffectCreationOptions(t=!1,i=!1,r=!1){let s=["invView","view","projection","textureMask","translationPivot","eyePosition"];return Yi(s),t&&s.push("particlesInfos"),i&&s.push("logarithmicDepthConstant"),r&&(s.push("vFogInfos"),s.push("vFogColor")),s}fillDefines(t,i,r=!0){if(this._scene&&(Es(this,this._scene,t),this.applyFog&&this._scene.fogEnabled&&this._scene.fogMode!==0&&t.push("#define FOG")),this._isAnimationSheetEnabled&&t.push("#define ANIMATESHEET"),this.useLogarithmicDepth&&t.push("#define LOGARITHMICDEPTH"),i===Wi.BLENDMODE_MULTIPLY&&t.push("#define BLENDMULTIPLYMODE"),this._useRampGradients&&t.push("#define RAMPGRADIENT"),this._isBillboardBased)switch(t.push("#define BILLBOARD"),this.billboardMode){case 2:t.push("#define BILLBOARDY");break;case 8:case 9:t.push("#define BILLBOARDSTRETCHED"),this.billboardMode===9&&t.push("#define BILLBOARDSTRETCHED_LOCAL");break;case 7:t.push("#define BILLBOARDMODE_ALL");break;default:break}r&&this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),t.push(this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(t,i,r){i.push(...n._GetAttributeNamesOrOptions(this._isAnimationSheetEnabled,this._isBillboardBased&&this.billboardMode!==8&&this.billboardMode!==9,this._useRampGradients)),t.push(...n._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth,this.applyFog)),r.push("diffuseSampler","rampSampler"),this._imageProcessingConfiguration&&(YT(t,this._imageProcessingConfigurationDefines),KT(r,this._imageProcessingConfigurationDefines))}_getWrapper(t){let i=this._getCustomDrawWrapper(t);if(i?.effect)return i;let r=[];this.fillDefines(r,t);let s=this._engine._features.supportRenderPasses?this._engine.currentRenderPassId:0,o=this._drawWrappers[s];o||(o=this._drawWrappers[s]=[]);let a=o[t];a||(a=new Ti(this._engine),a.drawContext&&(a.drawContext.useInstancing=this._useInstancing),o[t]=a);let l=r.join(`
`);if(a.defines!==l){let c=[],u=[],h=[];this.fillUniformsAttributesAndSamplerNames(u,c,h),a.setEffect(this._engine.createEffect("particles",c,u,h,l,void 0,void 0,void 0,void 0,this._shaderLanguage),l)}return a}animate(t=!1){if(!this._started||this.paused)return;if(!t&&this._scene){if(!this.isReady()||this._currentRenderId===this._scene.getFrameId())return;this._currentRenderId=this._scene.getFrameId()}this._scaledUpdateSpeed=this.updateSpeed*(t?this.preWarmStepOffset:this._scene?.getAnimationRatio()||1);let i;if(this.manualEmitCount>-1)i=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0;else{let r=this._calculateEmitRate();i=r*this._scaledUpdateSpeed>>0,this._newPartsExcess+=r*this._scaledUpdateSpeed-i}if(this._newPartsExcess>1&&(i+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?i=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(i),this._stopped&&(this._alive||(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene&&this._scene._toBeDisposed.push(this))),!t){let r=0;for(let s=0;s<this._particles.length;s++){let o=this._particles[s];this._appendParticleVertices(r,o),r+=this._useInstancing?1:4}this._vertexBuffer&&this._vertexBuffer.updateDirectly(this._vertexData,0,this._particles.length)}this.manualEmitCount===0&&this.disposeOnStop&&this.stop()}_calculateEmitRate(){let t=this.emitRate;if(this._emitRateGradients&&this._emitRateGradients.length>0&&this.targetStopDuration){let i=this._actualFrame/this.targetStopDuration;li.GetCurrentGradient(i,this._emitRateGradients,(r,s,o)=>{r!==this._currentEmitRateGradient&&(this._currentEmitRate1=this._currentEmitRate2,this._currentEmitRate2=s.getFactor(),this._currentEmitRateGradient=r),t=Qt(this._currentEmitRate1,this._currentEmitRate2,o)})}return t}_appendParticleVertices(t,i){this._appendParticleVertex(t++,i,0,0),this._useInstancing||(this._appendParticleVertex(t++,i,1,0),this._appendParticleVertex(t++,i,1,1),this._appendParticleVertex(t++,i,0,1))}rebuild(){this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._createIndexBuffer(),this._spriteBuffer?._rebuild(),this._createVertexBuffers(),this.resetDrawCache()}_initShaderSourceAsync(){return S(this,null,function*(){this._engine.isWebGPU&&!n.ForceGLSL?(this._shaderLanguage=1,yield Promise.all([import("./chunk-IKAQWQYS.js"),import("./chunk-GR5YPZI2.js")])):yield Promise.all([import("./chunk-43LWPJVC.js"),import("./chunk-XSSPW2ED.js")]),this._shadersLoaded=!0})}isReady(){if(!this._shadersLoaded||!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==Wi.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper(Wi.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper(Wi.BLENDMODE_ADD).effect.isReady())return!1;return!0}_render(t){let i=this._getWrapper(t),r=i.effect,s=this._engine;s.enableEffect(i);let o=this.defaultViewMatrix??this._scene.getViewMatrix();if(r.setTexture("diffuseSampler",this.particleTexture),r.setMatrix("view",o),r.setMatrix("projection",this.defaultProjectionMatrix??this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){let l=this.particleTexture.getBaseSize();r.setFloat3("particlesInfos",this.spriteCellWidth/l.width,this.spriteCellHeight/l.height,this.spriteCellWidth/l.width)}if(r.setVector2("translationPivot",this.translationPivot),r.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._isBillboardBased&&this._scene){let l=this._scene.activeCamera;r.setVector3("eyePosition",l.globalPosition)}this._rampGradientsTexture&&((!this._rampGradients||!this._rampGradients.length)&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),r.setTexture("rampSampler",this._rampGradientsTexture));let a=r.defines;return this._scene&&(Ki(r,this,this._scene),this.applyFog&&Nn(this._scene,void 0,r)),a.indexOf("#define BILLBOARDMODE_ALL")>=0&&(o.invertToRef(k.Matrix[0]),r.setMatrix("invView",k.Matrix[0])),this._vertexArrayObject!==void 0?this._scene?.forceWireframe?s.bindBuffers(this._vertexBuffers,this._linesIndexBufferUseInstancing,r):(this._vertexArrayObject||(this._vertexArrayObject=this._engine.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,r)),this._engine.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):this._indexBuffer?s.bindBuffers(this._vertexBuffers,this._scene?.forceWireframe?this._linesIndexBuffer:this._indexBuffer,r):s.bindBuffers(this._vertexBuffers,this._scene?.forceWireframe?this._linesIndexBufferUseInstancing:null,r),this.useLogarithmicDepth&&this._scene&&Si(a,r,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(r),this._setEngineBasedOnBlendMode(t),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(r),this._useInstancing?this._scene?.forceWireframe?s.drawElementsType(6,0,10,this._particles.length):s.drawArraysType(7,0,4,this._particles.length):this._scene?.forceWireframe?s.drawElementsType(1,0,this._particles.length*10):s.drawElementsType(0,0,this._particles.length*6),this._particles.length}render(){if(!this.isReady()||!this._particles.length)return 0;let t=this._engine;t.setState&&(t.setState(!1),this.forceDepthWrite&&t.setDepthWrite(!0));let i=0;return this.blendMode===Wi.BLENDMODE_MULTIPLYADD?i=this._render(Wi.BLENDMODE_MULTIPLY)+this._render(Wi.BLENDMODE_ADD):i=this._render(this.blendMode),this._engine.unbindInstanceAttributes(),this._engine.setAlphaMode(0),i}_onDispose(t=!1,i=!1){}dispose(t=!0,i=!1,r=!1){if(this.resetDrawCache(),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._linesIndexBuffer&&(this._engine._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null),this._linesIndexBufferUseInstancing&&(this._engine._releaseBuffer(this._linesIndexBufferUseInstancing),this._linesIndexBufferUseInstancing=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),t&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),t&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._onDispose(i,r),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.clear(),this._scene){let s=this._scene.particleSystems.indexOf(this);s>-1&&this._scene.particleSystems.splice(s,1),this._scene._activeParticleSystems.dispose()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onStoppedObservable.clear(),this.onStartedObservable.clear(),this.reset(),this._isDisposed=!0}}return n.ForceGLSL=!1,n})();var Qo=class n{constructor(e){if(this.particleSystem=e,this.type=1,this.inheritDirection=!1,this.inheritedVelocityAmount=0,!e.emitter||!e.emitter.dispose){let t=vt("BABYLON.AbstractMesh");e.emitter=new t("SubemitterSystemEmitter",e.getScene()),e._disposeEmitterOnDispose=!0}}clone(){let e=this.particleSystem.emitter;if(!e)e=new m;else if(e instanceof m)e=e.clone();else if(e.getClassName().indexOf("Mesh")!==-1){let i=vt("BABYLON.Mesh");e=new i("",e.getScene()),e.isVisible=!1}let t=new n(this.particleSystem.clone(this.particleSystem.name,e));return t.particleSystem.name+="Clone",t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem._disposeEmitterOnDispose=!0,t.particleSystem.disposeOnStop=!0,t}serialize(e=!1){let t={};return t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem=this.particleSystem.serialize(e),t}static _ParseParticleSystem(e,t,i,r=!1){throw Zt("ParseParticle")}static Parse(e,t,i){let r=e.particleSystem,s=new n(n._ParseParticleSystem(r,t,i,!0));return s.type=e.type,s.inheritDirection=e.inheritDirection,s.inheritedVelocityAmount=e.inheritedVelocityAmount,s.particleSystem._isSubEmitter=!0,s}dispose(){this.particleSystem.dispose()}};var Ul=class n{get mesh(){return this._mesh}set mesh(e){this._mesh!==e&&(this._mesh=e,e?(this._indices=e.getIndices(),this._positions=e.getVerticesData(T.PositionKind),this._normals=e.getVerticesData(T.NormalKind)):(this._indices=null,this._positions=null,this._normals=null))}constructor(e=null){this._indices=null,this._positions=null,this._normals=null,this._storedNormal=m.Zero(),this._mesh=null,this.direction1=new m(0,1,0),this.direction2=new m(0,1,0),this.useMeshNormalsForDirection=!0,this.mesh=e}startDirectionFunction(e,t,i,r){if(this.useMeshNormalsForDirection&&this._normals){m.TransformNormalToRef(this._storedNormal,e,t);return}let s=Ae(this.direction1.x,this.direction2.x),o=Ae(this.direction1.y,this.direction2.y),a=Ae(this.direction1.z,this.direction2.z);if(r){t.copyFromFloats(s,o,a);return}m.TransformNormalFromFloatsToRef(s,o,a,e,t)}startPositionFunction(e,t,i,r){if(!this._indices||!this._positions)return;let s=3*(Math.random()*(this._indices.length/3)|0),o=Math.random(),a=Math.random()*(1-o),l=1-o-a,c=this._indices[s],u=this._indices[s+1],h=this._indices[s+2],d=k.Vector3[0],f=k.Vector3[1],p=k.Vector3[2],g=k.Vector3[3];m.FromArrayToRef(this._positions,c*3,d),m.FromArrayToRef(this._positions,u*3,f),m.FromArrayToRef(this._positions,h*3,p),g.x=o*d.x+a*f.x+l*p.x,g.y=o*d.y+a*f.y+l*p.y,g.z=o*d.z+a*f.z+l*p.z,r?t.copyFromFloats(g.x,g.y,g.z):m.TransformCoordinatesFromFloatsToRef(g.x,g.y,g.z,e,t),this.useMeshNormalsForDirection&&this._normals&&(m.FromArrayToRef(this._normals,c*3,d),m.FromArrayToRef(this._normals,u*3,f),m.FromArrayToRef(this._normals,h*3,p),this._storedNormal.x=o*d.x+a*f.x+l*p.x,this._storedNormal.y=o*d.y+a*f.y+l*p.y,this._storedNormal.z=o*d.z+a*f.z+l*p.z)}clone(){let e=new n(this.mesh);return Tt.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return""}getClassName(){return"MeshParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.meshId=this.mesh?.id,e.useMeshNormalsForDirection=this.useMeshNormalsForDirection,e}parse(e,t){m.FromArrayToRef(e.direction1,0,this.direction1),m.FromArrayToRef(e.direction2,0,this.direction2),e.meshId&&t&&(this.mesh=t.getLastMeshById(e.meshId)),this.useMeshNormalsForDirection=e.useMeshNormalsForDirection}};var zl=()=>{},dr=class n{constructor(){this.particlePositionGenerator=zl,this.particleDestinationGenerator=zl,this.particleDirectionGenerator=zl}startDirectionFunction(e,t,i,r){let s=k.Vector3[0];if(this.particleDirectionGenerator&&this.particleDirectionGenerator!==zl)this.particleDirectionGenerator(-1,i,s);else if(this.particleDestinationGenerator&&this.particleDestinationGenerator!==zl){this.particleDestinationGenerator(-1,i,s);let o=k.Vector3[1];s.subtractToRef(i.position,o),o.scaleToRef(1/i.lifeTime,s)}else s.set(0,0,0);if(r){t.copyFrom(s);return}m.TransformNormalToRef(s,e,t)}startPositionFunction(e,t,i,r){let s=k.Vector3[0];if(this.particlePositionGenerator&&this.particlePositionGenerator!==zl?this.particlePositionGenerator(-1,i,s):s.set(0,0,0),r){t.copyFrom(s);return}m.TransformCoordinatesToRef(s,e,t)}clone(){let e=new n;return Tt.DeepCopy(this,e),e}applyToShader(e){}buildUniformLayout(e){}getEffectDefines(){return"#define CUSTOMEMITTER"}getClassName(){return"CustomParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.particlePositionGenerator=this.particlePositionGenerator,e.particleDestinationGenerator=this.particleDestinationGenerator,e}parse(e){e.particlePositionGenerator&&(this.particlePositionGenerator=e.particlePositionGenerator),e.particleDestinationGenerator&&(this.particleDestinationGenerator=e.particleDestinationGenerator)}};var Hl=class n{constructor(){this.direction1=new m(0,1,0),this.direction2=new m(0,1,0)}startDirectionFunction(e,t,i,r){let s=Ae(this.direction1.x,this.direction2.x),o=Ae(this.direction1.y,this.direction2.y),a=Ae(this.direction1.z,this.direction2.z);if(r){t.copyFromFloats(s,o,a);return}m.TransformNormalFromFloatsToRef(s,o,a,e,t)}startPositionFunction(e,t,i,r){if(r){t.copyFromFloats(0,0,0);return}m.TransformCoordinatesFromFloatsToRef(0,0,0,e,t)}clone(){let e=new n;return Tt.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define POINTEMITTER"}getClassName(){return"PointParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){m.FromArrayToRef(e.direction1,0,this.direction1),m.FromArrayToRef(e.direction2,0,this.direction2)}};var Wl=class n{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,r){let s=i.position.subtract(e.getTranslation()).normalize(),o=Ae(0,this.directionRandomizer),a=Ae(0,this.directionRandomizer),l=Ae(0,this.directionRandomizer);if(s.x+=o,s.y+=a,s.z+=l,s.normalize(),r){t.copyFrom(s);return}m.TransformNormalFromFloatsToRef(s.x,s.y,s.z,e,t)}startPositionFunction(e,t,i,r){let s=this.radius-Ae(0,this.radius*this.radiusRange),o=Ae(0,1),a=Ae(0,2*Math.PI),l=Math.acos(2*o-1),c=s*Math.cos(a)*Math.sin(l),u=s*Math.cos(l),h=s*Math.sin(a)*Math.sin(l);if(r){t.copyFromFloats(c,Math.abs(u),h);return}m.TransformCoordinatesFromFloatsToRef(c,Math.abs(u),h,e,t)}clone(){let e=new n(this.radius,this.directionRandomizer);return Tt.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define HEMISPHERICEMITTER"}getClassName(){return"HemisphericParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}};var bs=class n{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,r){let s=i.position.subtract(e.getTranslation()).normalize(),o=Ae(0,this.directionRandomizer),a=Ae(0,this.directionRandomizer),l=Ae(0,this.directionRandomizer);if(s.x+=o,s.y+=a,s.z+=l,s.normalize(),r){t.copyFrom(s);return}m.TransformNormalFromFloatsToRef(s.x,s.y,s.z,e,t)}startPositionFunction(e,t,i,r){let s=this.radius-Ae(0,this.radius*this.radiusRange),o=Ae(0,1),a=Ae(0,2*Math.PI),l=Math.acos(2*o-1),c=s*Math.cos(a)*Math.sin(l),u=s*Math.cos(l),h=s*Math.sin(a)*Math.sin(l);if(r){t.copyFromFloats(c,u,h);return}m.TransformCoordinatesFromFloatsToRef(c,u,h,e,t)}clone(){let e=new n(this.radius,this.directionRandomizer);return Tt.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define SPHEREEMITTER"}getClassName(){return"SphereParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}},$l=class n extends bs{constructor(e=1,t=new m(0,1,0),i=new m(0,1,0)){super(e),this.direction1=t,this.direction2=i}startDirectionFunction(e,t,i,r){let s=Ae(this.direction1.x,this.direction2.x),o=Ae(this.direction1.y,this.direction2.y),a=Ae(this.direction1.z,this.direction2.z);if(r){t.copyFromFloats(s,o,a);return}m.TransformNormalFromFloatsToRef(s,o,a,e,t)}clone(){let e=new n(this.radius,this.direction1,this.direction2);return Tt.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define SPHEREEMITTER
#define DIRECTEDSPHEREEMITTER`}getClassName(){return"SphereDirectedParticleEmitter"}serialize(){let e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}};var Jo=class n{constructor(e=1,t=1,i=1,r=0){this.radius=e,this.height=t,this.radiusRange=i,this.directionRandomizer=r,this._tempVector=m.Zero()}startDirectionFunction(e,t,i,r,s){i.position.subtractToRef(e.getTranslation(),this._tempVector),this._tempVector.normalize(),m.TransformNormalToRef(this._tempVector,s,this._tempVector);let o=Ae(-this.directionRandomizer/2,this.directionRandomizer/2),a=Math.atan2(this._tempVector.x,this._tempVector.z);if(a+=Ae(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this._tempVector.y=o,this._tempVector.x=Math.sin(a),this._tempVector.z=Math.cos(a),this._tempVector.normalize(),r){t.copyFrom(this._tempVector);return}m.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,e,t)}startPositionFunction(e,t,i,r){let s=Ae(-this.height/2,this.height/2),o=Ae(0,2*Math.PI),a=Ae((1-this.radiusRange)*(1-this.radiusRange),1),l=Math.sqrt(a)*this.radius,c=l*Math.cos(o),u=l*Math.sin(o);if(r){t.copyFromFloats(c,s,u);return}m.TransformCoordinatesFromFloatsToRef(c,s,u,e,t)}clone(){let e=new n(this.radius,this.directionRandomizer);return Tt.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define CYLINDEREMITTER"}getClassName(){return"CylinderParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.radius=this.radius,e.height=this.height,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.height=e.height,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}},jl=class n extends Jo{constructor(e=1,t=1,i=1,r=new m(0,1,0),s=new m(0,1,0)){super(e,t,i),this.direction1=r,this.direction2=s}startDirectionFunction(e,t,i,r){let s=Ae(this.direction1.x,this.direction2.x),o=Ae(this.direction1.y,this.direction2.y),a=Ae(this.direction1.z,this.direction2.z);if(r){t.copyFromFloats(s,o,a);return}m.TransformNormalFromFloatsToRef(s,o,a,e,t)}clone(){let e=new n(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return Tt.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define CYLINDEREMITTER
#define DIRECTEDCYLINDEREMITTER`}getClassName(){return"CylinderDirectedParticleEmitter"}serialize(){let e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),m.FromArrayToRef(e.direction1,0,this.direction1),m.FromArrayToRef(e.direction2,0,this.direction2)}};var ea=class n{get radius(){return this._radius}set radius(e){this._radius=e,this._buildHeight()}get angle(){return this._angle}set angle(e){this._angle=e,this._buildHeight()}_buildHeight(){this._angle!==0?this._height=this._radius/Math.tan(this._angle/2):this._height=1}constructor(e=1,t=Math.PI,i=0){this.directionRandomizer=i,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=t,this.radius=e}startDirectionFunction(e,t,i,r){let s=i.position.subtract(e.getTranslation()).normalize(),o=Ae(0,this.directionRandomizer),a=Ae(0,this.directionRandomizer),l=Ae(0,this.directionRandomizer);if(s.x+=o,s.y+=a,s.z+=l,s.normalize(),r){t.copyFrom(s);return}m.TransformNormalFromFloatsToRef(s.x,s.y,s.z,e,t)}startPositionFunction(e,t,i,r){let s=Ae(0,Math.PI*2),o;this.emitFromSpawnPointOnly?o=1e-4:(o=Ae(0,this.heightRange),o=1-o*o);let a=this._radius-Ae(0,this._radius*this.radiusRange);a=a*o;let l=a*Math.sin(s),c=a*Math.cos(s),u=o*this._height;if(r){t.x=l,t.y=u,t.z=c;return}m.TransformCoordinatesFromFloatsToRef(l,u,c,e,t)}clone(){let e=new n(this._radius,this._angle,this.directionRandomizer);return Tt.DeepCopy(this,e),e}applyToShader(e){e.setFloat2("radius",this._radius,this.radiusRange),e.setFloat("coneAngle",this._angle),e.setFloat2("height",this._height,this.heightRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",2),e.addUniform("coneAngle",1),e.addUniform("height",2),e.addUniform("directionRandomizer",1)}getEffectDefines(){let e="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(e+=`
#define CONEEMITTERSPAWNPOINT`),e}getClassName(){return"ConeParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.radius=this._radius,e.angle=this._angle,e.directionRandomizer=this.directionRandomizer,e.radiusRange=this.radiusRange,e.heightRange=this.heightRange,e.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,e}parse(e){this.radius=e.radius,this.angle=e.angle,this.directionRandomizer=e.directionRandomizer,this.radiusRange=e.radiusRange!==void 0?e.radiusRange:1,this.heightRange=e.radiusRange!==void 0?e.heightRange:1,this.emitFromSpawnPointOnly=e.emitFromSpawnPointOnly!==void 0?e.emitFromSpawnPointOnly:!1}},ql=class n extends ea{constructor(e=1,t=Math.PI,i=new m(0,1,0),r=new m(0,1,0)){super(e,t),this.direction1=i,this.direction2=r}startDirectionFunction(e,t,i,r){let s=Ae(this.direction1.x,this.direction2.x),o=Ae(this.direction1.y,this.direction2.y),a=Ae(this.direction1.z,this.direction2.z);if(r){t.copyFromFloats(s,o,a);return}m.TransformNormalFromFloatsToRef(s,o,a,e,t)}clone(){let e=new n(this.radius,this.angle,this.direction1,this.direction2);return Tt.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define CONEEMITTER
#define DIRECTEDCONEEMITTER`}getClassName(){return"ConeDirectedParticleEmitter"}serialize(){let e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}};function Hm(n,e){let t=new Hl;return t.direction1=n,t.direction2=e,t}function Wm(n=1,e=1){return new Wl(n,e)}function $m(n=1,e=1){return new bs(n,e)}function jm(n=1,e=new m(0,1,0),t=new m(0,1,0)){return new $l(n,e,t)}function qm(n=1,e=1,t=1,i=0){return new Jo(n,e,t,i)}function Ym(n=1,e=1,t=1,i=new m(0,1,0),r=new m(0,1,0)){return new jl(n,e,t,i,r)}function Km(n=1,e=Math.PI/4){return new ea(n,e)}function Xm(n=1,e=Math.PI/4,t=new m(0,1,0),i=new m(0,1,0)){return new ql(n,e,t,i)}var wC=m.Zero(),qM=m.Zero(),YM=m.Zero(),Zm=class{constructor(){this.strength=0,this.position=m.Zero()}_processParticle(e,t){this.position.subtractToRef(e.position,wC);let i=wC.lengthSquared()+1;wC.normalize().scaleToRef(this.strength/i,qM),qM.scaleToRef(t._tempScaledUpdateSpeed,YM),e.direction.addInPlace(YM)}serialize(){return{position:this.position.asArray(),strength:this.strength}}};var Mt=(()=>{class n extends jM{constructor(){super(...arguments),this._disposeEmitterOnDispose=!1,this.doNotSerialize=!1,this.canStart=()=>!0,this._flowMap=null,this._flowMapUpdate=null,this._source=null,this._blockReference=0,this.flowMapStrength=1,this._attractors=[],this._attractorUpdate=null,this.metadata=null,this._emitFromParticle=t=>{if(!this._subEmitters||this._subEmitters.length===0)return;let i=Math.floor(Math.random()*this._subEmitters.length);for(let r of this._subEmitters[i])if(r.type===1){let s=r.clone();t._inheritParticleInfoToSubEmitter(s),s.particleSystem._rootParticleSystem=this,this.activeSubSystems.push(s.particleSystem),s.particleSystem.start()}}}createPointEmitter(t,i){let r=Hm(t,i);return this.particleEmitterType=r,r}get source(){return this._source}get isNodeGenerated(){return this._source!==null}get flowMap(){return this._flowMap}set flowMap(t){this._flowMap!==t&&(this._flowMap=t,this._flowMapUpdate&&(ci(this._flowMapUpdate),this._flowMapUpdate=null),t&&(this._flowMapUpdate={process:i=>{let r=this.getScene()?.getTransformMatrix();this._flowMap._processParticle(i,this.flowMapStrength*this._tempScaledUpdateSpeed,r)},previousItem:null,nextItem:null},Rt(this._flowMapUpdate,this._directionProcessing)))}get attractors(){return this._attractors.slice(0)}addAttractor(t){this._attractors.push(t),this._attractors.length===1&&(this._attractorUpdate={process:i=>{for(let r of this._attractors)r._processParticle(i,this)},previousItem:null,nextItem:null},Rt(this._attractorUpdate,this._directionProcessing))}removeAttractor(t){let i=this._attractors.indexOf(t);i!==-1&&this._attractors.splice(i,1),this._attractors.length===0&&ci(this._attractorUpdate)}start(t=this.startDelay){this.canStart()&&super.start(t)}createHemisphericEmitter(t=1,i=1){let r=Wm(t,i);return this.particleEmitterType=r,r}createSphereEmitter(t=1,i=1){let r=$m(t,i);return this.particleEmitterType=r,r}createDirectedSphereEmitter(t=1,i=new m(0,1,0),r=new m(0,1,0)){let s=jm(t,i,r);return this.particleEmitterType=s,s}createCylinderEmitter(t=1,i=1,r=1,s=0){let o=qm(t,i,r,s);return this.particleEmitterType=o,o}createDirectedCylinderEmitter(t=1,i=1,r=1,s=new m(0,1,0),o=new m(0,1,0)){let a=Ym(t,i,r,s,o);return this.particleEmitterType=a,a}createConeEmitter(t=1,i=Math.PI/4){let r=Km(t,i);return this.particleEmitterType=r,r}createDirectedConeEmitter(t=1,i=Math.PI/4,r=new m(0,1,0),s=new m(0,1,0)){let o=Xm(t,i,r,s);return this.particleEmitterType=o,o}createBoxEmitter(t,i,r,s){let o=new hr;return this.particleEmitterType=o,this.direction1=t,this.direction2=i,this.minEmitBox=r,this.maxEmitBox=s,o}_prepareSubEmitterInternalArray(){if(this._subEmitters=new Array,this.subEmitters)for(let t of this.subEmitters)t instanceof n?this._subEmitters.push([new Qo(t)]):t instanceof Qo?this._subEmitters.push([t]):t instanceof Array&&this._subEmitters.push(t)}_stopSubEmitters(){if(this.activeSubSystems){for(let t of this.activeSubSystems)t.stop(!0);this.activeSubSystems=[]}}_removeFromRoot(){if(!this._rootParticleSystem)return;let t=this._rootParticleSystem.activeSubSystems.indexOf(this);t!==-1&&this._rootParticleSystem.activeSubSystems.splice(t,1),this._rootParticleSystem=null}_preStart(){this._prepareSubEmitterInternalArray(),this._subEmitters&&this._subEmitters.length!=0&&(this.activeSubSystems=[])}_postStop(t){t&&this._stopSubEmitters()}_prepareParticle(t){if(this._subEmitters&&this._subEmitters.length>0){let i=this._subEmitters[Math.floor(Math.random()*this._subEmitters.length)];t._attachedSubEmitters=[];for(let r of i)if(r.type===0){let s=r.clone();t._attachedSubEmitters.push(s),s.particleSystem.start()}}}_onDispose(t=!1,i=!1){if(this._removeFromRoot(),this.subEmitters&&!this._subEmitters&&this._prepareSubEmitterInternalArray(),t&&this.particles){for(let r of this.particles)if(r._attachedSubEmitters)for(let s=r._attachedSubEmitters.length-1;s>=0;s-=1)r._attachedSubEmitters[s].dispose()}if(i&&this.activeSubSystems)for(let r=this.activeSubSystems.length-1;r>=0;r-=1)this.activeSubSystems[r].dispose();if(this._subEmitters&&this._subEmitters.length){for(let r=0;r<this._subEmitters.length;r++)for(let s of this._subEmitters[r])s.dispose();this._subEmitters=[],this.subEmitters=[]}this._disposeEmitterOnDispose&&this.emitter&&this.emitter.dispose&&this.emitter.dispose(!0)}static _Parse(t,i,r,s){let o;r instanceof ne?o=null:o=r;let a=vt("BABYLON.Texture");if(a&&o&&(t.texture?i.particleTexture=a.Parse(t.texture,o,s):t.textureName&&(i.particleTexture=new a(s+t.textureName,o,!1,t.invertY!==void 0?t.invertY:!0),i.particleTexture.name=t.textureName)),!t.emitterId&&t.emitterId!==0&&t.emitter===void 0?i.emitter=m.Zero():t.emitterId&&o?i.emitter=o.getLastMeshById(t.emitterId):i.emitter=m.FromArray(t.emitter),i.isLocal=!!t.isLocal,t.renderingGroupId!==void 0&&(i.renderingGroupId=t.renderingGroupId),t.isBillboardBased!==void 0&&(i.isBillboardBased=t.isBillboardBased),t.billboardMode!==void 0&&(i.billboardMode=t.billboardMode),t.useLogarithmicDepth!==void 0&&(i.useLogarithmicDepth=t.useLogarithmicDepth),t.animations){for(let c=0;c<t.animations.length;c++){let u=t.animations[c],h=vt("BABYLON.Animation");h&&i.animations.push(h.Parse(u))}i.beginAnimationOnStart=t.beginAnimationOnStart,i.beginAnimationFrom=t.beginAnimationFrom,i.beginAnimationTo=t.beginAnimationTo,i.beginAnimationLoop=t.beginAnimationLoop}if(t.autoAnimate&&o&&o.beginAnimation(i,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),i.startDelay=t.startDelay|0,i.minAngularSpeed=t.minAngularSpeed,i.maxAngularSpeed=t.maxAngularSpeed,i.minSize=t.minSize,i.maxSize=t.maxSize,t.minScaleX&&(i.minScaleX=t.minScaleX,i.maxScaleX=t.maxScaleX,i.minScaleY=t.minScaleY,i.maxScaleY=t.maxScaleY),t.preWarmCycles!==void 0&&(i.preWarmCycles=t.preWarmCycles,i.preWarmStepOffset=t.preWarmStepOffset),t.minInitialRotation!==void 0&&(i.minInitialRotation=t.minInitialRotation,i.maxInitialRotation=t.maxInitialRotation),i.minLifeTime=t.minLifeTime,i.maxLifeTime=t.maxLifeTime,i.minEmitPower=t.minEmitPower,i.maxEmitPower=t.maxEmitPower,i.emitRate=t.emitRate,i.gravity=m.FromArray(t.gravity),t.noiseStrength&&(i.noiseStrength=m.FromArray(t.noiseStrength)),i.color1=ce.FromArray(t.color1),i.color2=ce.FromArray(t.color2),i.colorDead=ce.FromArray(t.colorDead),i.updateSpeed=t.updateSpeed,i.targetStopDuration=t.targetStopDuration,i.blendMode=t.blendMode,t.colorGradients)for(let c of t.colorGradients)i.addColorGradient(c.gradient,ce.FromArray(c.color1),c.color2?ce.FromArray(c.color2):void 0);if(t.rampGradients){for(let c of t.rampGradients)i.addRampGradient(c.gradient,U.FromArray(c.color));i.useRampGradients=t.useRampGradients}if(t.colorRemapGradients)for(let c of t.colorRemapGradients)i.addColorRemapGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.alphaRemapGradients)for(let c of t.alphaRemapGradients)i.addAlphaRemapGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.sizeGradients)for(let c of t.sizeGradients)i.addSizeGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.angularSpeedGradients)for(let c of t.angularSpeedGradients)i.addAngularSpeedGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.velocityGradients)for(let c of t.velocityGradients)i.addVelocityGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.dragGradients)for(let c of t.dragGradients)i.addDragGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.emitRateGradients)for(let c of t.emitRateGradients)i.addEmitRateGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.startSizeGradients)for(let c of t.startSizeGradients)i.addStartSizeGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.lifeTimeGradients)for(let c of t.lifeTimeGradients)i.addLifeTimeGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.limitVelocityGradients){for(let c of t.limitVelocityGradients)i.addLimitVelocityGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);i.limitVelocityDamping=t.limitVelocityDamping}if(t.noiseTexture&&o){let c=vt("BABYLON.ProceduralTexture");i.noiseTexture=c.Parse(t.noiseTexture,o,s)}let l;if(t.particleEmitterType){switch(t.particleEmitterType.type){case"SphereParticleEmitter":l=new bs;break;case"SphereDirectedParticleEmitter":l=new $l;break;case"ConeEmitter":case"ConeParticleEmitter":l=new ea;break;case"ConeDirectedParticleEmitter":l=new ql;break;case"CylinderParticleEmitter":l=new Jo;break;case"CylinderDirectedParticleEmitter":l=new jl;break;case"HemisphericParticleEmitter":l=new Wl;break;case"PointParticleEmitter":l=new Hl;break;case"MeshParticleEmitter":l=new Ul;break;case"CustomParticleEmitter":l=new dr;break;case"BoxEmitter":case"BoxParticleEmitter":default:l=new hr;break}l.parse(t.particleEmitterType,o)}else l=new hr,l.parse(t,o);i.particleEmitterType=l,i.startSpriteCellID=t.startSpriteCellID,i.endSpriteCellID=t.endSpriteCellID,i.spriteCellLoop=t.spriteCellLoop??!0,i.spriteCellWidth=t.spriteCellWidth,i.spriteCellHeight=t.spriteCellHeight,i.spriteCellChangeSpeed=t.spriteCellChangeSpeed,i.spriteRandomStartCell=t.spriteRandomStartCell,i.disposeOnStop=t.disposeOnStop??!1,i.manualEmitCount=t.manualEmitCount??-1}static Parse(t,i,r,s=!1,o){let a=t.name,l=null,c=null,u,h;if(i instanceof ne?u=i:(h=i,u=h.getEngine()),t.customShader&&u.createEffectForParticles){c=t.customShader;let f=c.shaderOptions.defines.length>0?c.shaderOptions.defines.join(`
`):"";l=u.createEffectForParticles(c.shaderPath.fragmentElement,c.shaderOptions.uniforms,c.shaderOptions.samplers,f)}let d=new n(a,o||t.capacity,i,l,t.isAnimationSheetEnabled);if(d.customShader=c,d._rootUrl=r,t.id&&(d.id=t.id),t.subEmitters){d.subEmitters=[];for(let f of t.subEmitters){let p=[];for(let g of f)p.push(Qo.Parse(g,i,r));d.subEmitters.push(p)}}if(t.attractors)for(let f of t.attractors){let p=new Zm;p.position=m.FromArray(f.position),p.strength=f.strength,d.addAttractor(p)}return n._Parse(t,d,i,r),t.textureMask&&(d.textureMask=ce.FromArray(t.textureMask)),t.worldOffset&&(d.worldOffset=m.FromArray(t.worldOffset)),t.preventAutoStart&&(d.preventAutoStart=t.preventAutoStart),t.metadata&&(d.metadata=t.metadata),!s&&!d.preventAutoStart&&d.start(),d}serialize(t=!1){let i={};if(n._Serialize(i,this,t),i.textureMask=this.textureMask.asArray(),i.customShader=this.customShader,i.preventAutoStart=this.preventAutoStart,i.worldOffset=this.worldOffset.asArray(),this.metadata&&(i.metadata=this.metadata),this.subEmitters){i.subEmitters=[],this._subEmitters||this._prepareSubEmitterInternalArray();for(let r of this._subEmitters){let s=[];for(let o of r)o.particleSystem.doNotSerialize||s.push(o.serialize(t));i.subEmitters.push(s)}}if(this._attractors&&this._attractors.length){i.attractors=[];for(let r of this._attractors)i.attractors.push(r.serialize())}return i}static _Serialize(t,i,r){if(t.name=i.name,t.id=i.id,t.capacity=i.getCapacity(),t.disposeOnStop=i.disposeOnStop,t.manualEmitCount=i.manualEmitCount,i.emitter.position){let y=i.emitter;t.emitterId=y.id}else{let y=i.emitter;t.emitter=y.asArray()}i.particleEmitterType&&(t.particleEmitterType=i.particleEmitterType.serialize()),i.particleTexture&&(r?t.texture=i.particleTexture.serialize():(t.textureName=i.particleTexture.name,t.invertY=!!i.particleTexture._invertY)),t.isLocal=i.isLocal,je.AppendSerializedAnimations(i,t),t.beginAnimationOnStart=i.beginAnimationOnStart,t.beginAnimationFrom=i.beginAnimationFrom,t.beginAnimationTo=i.beginAnimationTo,t.beginAnimationLoop=i.beginAnimationLoop,t.startDelay=i.startDelay,t.renderingGroupId=i.renderingGroupId,t.isBillboardBased=i.isBillboardBased,t.billboardMode=i.billboardMode,t.minAngularSpeed=i.minAngularSpeed,t.maxAngularSpeed=i.maxAngularSpeed,t.minSize=i.minSize,t.maxSize=i.maxSize,t.minScaleX=i.minScaleX,t.maxScaleX=i.maxScaleX,t.minScaleY=i.minScaleY,t.maxScaleY=i.maxScaleY,t.minEmitPower=i.minEmitPower,t.maxEmitPower=i.maxEmitPower,t.minLifeTime=i.minLifeTime,t.maxLifeTime=i.maxLifeTime,t.emitRate=i.emitRate,t.gravity=i.gravity.asArray(),t.noiseStrength=i.noiseStrength.asArray(),t.color1=i.color1.asArray(),t.color2=i.color2.asArray(),t.colorDead=i.colorDead.asArray(),t.updateSpeed=i.updateSpeed,t.targetStopDuration=i.targetStopDuration,t.blendMode=i.blendMode,t.preWarmCycles=i.preWarmCycles,t.preWarmStepOffset=i.preWarmStepOffset,t.minInitialRotation=i.minInitialRotation,t.maxInitialRotation=i.maxInitialRotation,t.startSpriteCellID=i.startSpriteCellID,t.spriteCellLoop=i.spriteCellLoop,t.endSpriteCellID=i.endSpriteCellID,t.spriteCellChangeSpeed=i.spriteCellChangeSpeed,t.spriteCellWidth=i.spriteCellWidth,t.spriteCellHeight=i.spriteCellHeight,t.spriteRandomStartCell=i.spriteRandomStartCell,t.isAnimationSheetEnabled=i.isAnimationSheetEnabled,t.useLogarithmicDepth=i.useLogarithmicDepth;let s=i.getColorGradients();if(s){t.colorGradients=[];for(let y of s){let b={gradient:y.gradient,color1:y.color1.asArray()};y.color2?b.color2=y.color2.asArray():b.color2=y.color1.asArray(),t.colorGradients.push(b)}}let o=i.getRampGradients();if(o){t.rampGradients=[];for(let y of o){let b={gradient:y.gradient,color:y.color.asArray()};t.rampGradients.push(b)}t.useRampGradients=i.useRampGradients}let a=i.getColorRemapGradients();if(a){t.colorRemapGradients=[];for(let y of a){let b={gradient:y.gradient,factor1:y.factor1};y.factor2!==void 0?b.factor2=y.factor2:b.factor2=y.factor1,t.colorRemapGradients.push(b)}}let l=i.getAlphaRemapGradients();if(l){t.alphaRemapGradients=[];for(let y of l){let b={gradient:y.gradient,factor1:y.factor1};y.factor2!==void 0?b.factor2=y.factor2:b.factor2=y.factor1,t.alphaRemapGradients.push(b)}}let c=i.getSizeGradients();if(c){t.sizeGradients=[];for(let y of c){let b={gradient:y.gradient,factor1:y.factor1};y.factor2!==void 0?b.factor2=y.factor2:b.factor2=y.factor1,t.sizeGradients.push(b)}}let u=i.getAngularSpeedGradients();if(u){t.angularSpeedGradients=[];for(let y of u){let b={gradient:y.gradient,factor1:y.factor1};y.factor2!==void 0?b.factor2=y.factor2:b.factor2=y.factor1,t.angularSpeedGradients.push(b)}}let h=i.getVelocityGradients();if(h){t.velocityGradients=[];for(let y of h){let b={gradient:y.gradient,factor1:y.factor1};y.factor2!==void 0?b.factor2=y.factor2:b.factor2=y.factor1,t.velocityGradients.push(b)}}let d=i.getDragGradients();if(d){t.dragGradients=[];for(let y of d){let b={gradient:y.gradient,factor1:y.factor1};y.factor2!==void 0?b.factor2=y.factor2:b.factor2=y.factor1,t.dragGradients.push(b)}}let f=i.getEmitRateGradients();if(f){t.emitRateGradients=[];for(let y of f){let b={gradient:y.gradient,factor1:y.factor1};y.factor2!==void 0?b.factor2=y.factor2:b.factor2=y.factor1,t.emitRateGradients.push(b)}}let p=i.getStartSizeGradients();if(p){t.startSizeGradients=[];for(let y of p){let b={gradient:y.gradient,factor1:y.factor1};y.factor2!==void 0?b.factor2=y.factor2:b.factor2=y.factor1,t.startSizeGradients.push(b)}}let g=i.getLifeTimeGradients();if(g){t.lifeTimeGradients=[];for(let y of g){let b={gradient:y.gradient,factor1:y.factor1};y.factor2!==void 0?b.factor2=y.factor2:b.factor2=y.factor1,t.lifeTimeGradients.push(b)}}let _=i.getLimitVelocityGradients();if(_){t.limitVelocityGradients=[];for(let y of _){let b={gradient:y.gradient,factor1:y.factor1};y.factor2!==void 0?b.factor2=y.factor2:b.factor2=y.factor1,t.limitVelocityGradients.push(b)}t.limitVelocityDamping=i.limitVelocityDamping}i.noiseTexture&&(t.noiseTexture=i.noiseTexture.serialize())}clone(t,i,r=!1){let s=Y({},this._customWrappers),o=null,a=this._engine;if(a.createEffectForParticles&&this.customShader!=null){o=this.customShader;let u=o.shaderOptions.defines.length>0?o.shaderOptions.defines.join(`
`):"",h=a.createEffectForParticles(o.shaderPath.fragmentElement,o.shaderOptions.uniforms,o.shaderOptions.samplers,u);s[0]?s[0].effect=h:this.setCustomEffect(h,0)}let l=this.serialize(r),c=n.Parse(l,this._scene||this._engine,this._rootUrl);return c.name=t,c.customShader=o,c._customWrappers=s,i===void 0&&(i=this.emitter),this.noiseTexture&&(c.noiseTexture=this.noiseTexture.clone()),c.emitter=i,this.preventAutoStart||c.start(),c}}return n.BILLBOARDMODE_Y=2,n.BILLBOARDMODE_ALL=7,n.BILLBOARDMODE_STRETCHED=8,n.BILLBOARDMODE_STRETCHED_LOCAL=9,n})();Qo._ParseParticleSystem=Mt.Parse;di.prototype.createTransformFeedback=function(){let n=this._gl.createTransformFeedback();if(!n)throw new Error("Unable to create Transform Feedback");return n};di.prototype.deleteTransformFeedback=function(n){this._gl.deleteTransformFeedback(n)};di.prototype.bindTransformFeedback=function(n){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,n)};di.prototype.beginTransformFeedback=function(n=!0){this._gl.beginTransformFeedback(n?this._gl.POINTS:this._gl.TRIANGLES)};di.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()};di.prototype.setTranformFeedbackVaryings=function(n,e){this._gl.transformFeedbackVaryings(n,e,this._gl.INTERLEAVED_ATTRIBS)};di.prototype.bindTransformFeedbackBuffer=function(n){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,n?n.underlyingResource:null)};di.prototype.readTransformFeedbackBuffer=function(n){this._gl.getBufferSubData(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,n)};var KM="clipPlaneFragmentDeclaration2",Ik=`#ifdef CLIPPLANE
in float fClipDistance;
#endif
#ifdef CLIPPLANE2
in float fClipDistance2;
#endif
#ifdef CLIPPLANE3
in float fClipDistance3;
#endif
#ifdef CLIPPLANE4
in float fClipDistance4;
#endif
#ifdef CLIPPLANE5
in float fClipDistance5;
#endif
#ifdef CLIPPLANE6
in float fClipDistance6;
#endif
`;ht.IncludesShadersStore[KM]||(ht.IncludesShadersStore[KM]=Ik);var XM="gpuRenderParticlesPixelShader",Ak=`precision highp float;
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform sampler2D diffuseSampler;varying vec2 vUV;varying vec4 vColor;
#include<clipPlaneFragmentDeclaration2> 
#include<imageProcessingDeclaration>
#include<logDepthDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#include<fogFragmentDeclaration>
void main() {
#include<clipPlaneFragment> 
vec4 textureColor=texture2D(diffuseSampler,vUV);gl_FragColor=textureColor*vColor;
#ifdef BLENDMULTIPLYMODE
float alpha=vColor.a*textureColor.a;gl_FragColor.rgb=gl_FragColor.rgb*alpha+vec3(1.0)*(1.0-alpha);
#endif 
#include<logDepthFragment>
#include<fogFragment>(color,gl_FragColor)
#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);
#else
#ifdef IMAGEPROCESSING
gl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);gl_FragColor=applyImageProcessing(gl_FragColor);
#endif
#endif
}
`;ht.ShadersStore[XM]||(ht.ShadersStore[XM]=Ak);var ZM="clipPlaneVertexDeclaration2",Ek=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;out float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;out float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;out float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;out float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;out float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;out float fClipDistance6;
#endif
`;ht.IncludesShadersStore[ZM]||(ht.IncludesShadersStore[ZM]=Ek);var QM="gpuRenderParticlesVertexShader",wk=`precision highp float;uniform mat4 view;uniform mat4 projection;uniform vec2 translationPivot;uniform vec3 worldOffset;
#ifdef LOCAL
uniform mat4 emitterWM;
#endif
attribute vec3 position;attribute float age;attribute float life;attribute vec3 size;
#ifndef BILLBOARD
attribute vec3 initialDirection;
#endif
#ifdef BILLBOARDSTRETCHED
attribute vec3 direction;
#endif
attribute float angle;
#ifdef ANIMATESHEET
attribute float cellIndex;
#endif
attribute vec2 offset;attribute vec2 uv;varying vec2 vUV;varying vec4 vColor;varying vec3 vPositionW;
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform mat4 invView;
#endif
#include<clipPlaneVertexDeclaration2>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#ifdef COLORGRADIENTS
uniform sampler2D colorGradientSampler;
#else
uniform vec4 colorDead;attribute vec4 color;
#endif
#ifdef ANIMATESHEET
uniform vec3 sheetInfos;
#endif
#ifdef BILLBOARD
uniform vec3 eyePosition;
#endif
vec3 rotate(vec3 yaxis,vec3 rotatedCorner) {vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));vec3 zaxis=normalize(cross(yaxis,xaxis));vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;
#ifdef LOCAL
return ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;
#else
return (position+worldOffset)+alignedCorner;
#endif
}
#ifdef BILLBOARDSTRETCHED
vec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {vec3 normalizedToCamera=normalize(toCamera);vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;
#ifdef LOCAL
return ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;
#else
return (position+worldOffset)+alignedCorner;
#endif
}
#endif
void main() {
#ifdef ANIMATESHEET
float rowOffset=floor(cellIndex/sheetInfos.z);float columnOffset=cellIndex-rowOffset*sheetInfos.z;vec2 uvScale=sheetInfos.xy;vec2 uvOffset=vec2(uv.x ,1.0-uv.y);vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;
#else
vUV=uv;
#endif
float ratio=min(1.0,age/life);
#ifdef COLORGRADIENTS
vColor=texture2D(colorGradientSampler,vec2(ratio,0));
#else
vColor=color*vec4(1.0-ratio)+colorDead*vec4(ratio);
#endif
vec2 cornerPos=(offset-translationPivot)*size.yz*size.x;
#ifdef BILLBOARD
vec4 rotatedCorner;rotatedCorner.w=0.;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=(position+worldOffset)-eyePosition;yaxis.y=0.;vPositionW=rotate(normalize(yaxis),rotatedCorner.xyz);vec4 viewPosition=(view*vec4(vPositionW,1.0));
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 toCamera=(position+worldOffset)-eyePosition;vPositionW=rotateAlign(toCamera,rotatedCorner.xyz);vec4 viewPosition=(view*vec4(vPositionW,1.0));
#else
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;
#ifdef LOCAL
vec4 viewPosition=view*vec4(((emitterWM*vec4(position,1.0)).xyz+worldOffset),1.0)+rotatedCorner;
#else
vec4 viewPosition=view*vec4((position+worldOffset),1.0)+rotatedCorner;
#endif
vPositionW=(invView*viewPosition).xyz;
#endif
#else
vec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=0.;rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.xz+=translationPivot;vec3 yaxis=normalize(initialDirection);vPositionW=rotate(yaxis,rotatedCorner);vec4 viewPosition=view*vec4(vPositionW,1.0);
#endif
gl_Position=projection*viewPosition;
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6) || defined(FOG)
vec4 worldPos=vec4(vPositionW,1.0);
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
}`;ht.ShadersStore[QM]||(ht.ShadersStore[QM]=wk);var ta=class n extends Wi{static get IsSupported(){if(!ye.LastCreatedEngine)return!1;let e=ye.LastCreatedEngine.getCaps();return e.supportTransformFeedbacks||e.supportComputeShaders}_createIndexBuffer(){this._linesIndexBufferUseInstancing=this._engine.createIndexBuffer(new Uint32Array([0,1,1,3,3,2,2,0,0,3]),void 0,"GPUParticleSystemLinesIndexBuffer")}getCapacity(){return this._capacity}get maxActiveParticleCount(){return this._maxActiveParticleCount}set maxActiveParticleCount(e){this._maxActiveParticleCount=Math.min(e,this._capacity)}get activeParticleCount(){return this.maxActiveParticleCount}set activeParticleCount(e){this.maxActiveParticleCount=e}createPointEmitter(e,t){let i=Hm(e,t);return this.particleEmitterType=i,i}createHemisphericEmitter(e=1,t=1){let i=Wm(e,t);return this.particleEmitterType=i,i}createSphereEmitter(e=1,t=1){let i=$m(e,t);return this.particleEmitterType=i,i}createDirectedSphereEmitter(e=1,t=new m(0,1,0),i=new m(0,1,0)){let r=jm(e,t,i);return this.particleEmitterType=r,r}createCylinderEmitter(e=1,t=1,i=1,r=0){let s=qm(e,t,i,r);return this.particleEmitterType=s,s}createDirectedCylinderEmitter(e=1,t=1,i=1,r=new m(0,1,0),s=new m(0,1,0)){let o=Ym(e,t,i,r,s);return this.particleEmitterType=o,o}createConeEmitter(e=1,t=Math.PI/4){let i=Km(e,t);return this.particleEmitterType=i,i}createDirectedConeEmitter(e=1,t=Math.PI/4,i=new m(0,1,0),r=new m(0,1,0)){let s=Xm(e,t,i,r);return this.particleEmitterType=s,s}createBoxEmitter(e,t,i,r){let s=new hr;return this.particleEmitterType=s,this.direction1=e,this.direction2=t,this.minEmitBox=i,this.maxEmitBox=r,s}get flowMap(){return this._flowMap}set flowMap(e){this._flowMap!==e&&(this._flowMap=e)}isReady(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||this._flowMap&&!this._flowMap.isReady()||!this.particleTexture||!this.particleTexture.isReady()||this._rebuildingAfterContextLost)return!1;if(this.blendMode!==Mt.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper(Mt.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper(Mt.BLENDMODE_ADD).effect.isReady())return!1;return this._platform.isUpdateBufferCreated()?this._platform.isUpdateBufferReady():(this._recreateUpdateEffect(),!1)}isStarted(){return this._started}isStopped(){return this._stopped}isStopping(){return!1}getActiveCount(){return this._currentActiveCount}start(e=this.startDelay){if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e){setTimeout(()=>{this.start(0)},e);return}this._started=!0,this._stopped=!1,this._actualFrame=0,this._preWarmDone=!1,this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)}stop(){this._stopped||(this.onStoppedObservable.notifyObservers(this),this._stopped=!0)}reset(){this._releaseBuffers(),this._platform.releaseVertexBuffers(),this._currentActiveCount=0,this._targetIndex=0}getClassName(){return"GPUParticleSystem"}getCustomEffect(e=0){return this._customWrappers[e]?.effect??this._customWrappers[0].effect}_getCustomDrawWrapper(e=0){return this._customWrappers[e]??this._customWrappers[0]}setCustomEffect(e,t=0){this._customWrappers[t]=new Ti(this._engine),this._customWrappers[t].effect=e}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new F),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"gpuRenderParticles"}get vertexBuffers(){return this._renderVertexBuffers[this._targetIndex^1]}get indexBuffer(){return null}_removeGradientAndTexture(e,t,i){return super._removeGradientAndTexture(e,t,i),this._releaseBuffers(),this}addColorGradient(e,t){this._colorGradients||(this._colorGradients=[]);let i=new kl(e,t);return this._colorGradients.push(i),this._refreshColorGradient(!0),this._releaseBuffers(),this}_refreshColorGradient(e=!1){this._colorGradients&&(e&&this._colorGradients.sort((t,i)=>t.gradient<i.gradient?-1:t.gradient>i.gradient?1:0),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null))}forceRefreshGradients(){this._refreshColorGradient(),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture"),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture"),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture"),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture"),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture"),this.reset()}removeColorGradient(e){return this._removeGradientAndTexture(e,this._colorGradients,this._colorGradientsTexture),this._colorGradientsTexture=null,this}resetDrawCache(){for(let e in this._drawWrappers)this._drawWrappers[e].drawContext?.reset()}_addFactorGradient(e,t,i){let r=new Vl(t,i);e.push(r),this._releaseBuffers()}addSizeGradient(e,t){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture",!0),this._releaseBuffers(),this}removeSizeGradient(e){return this._removeGradientAndTexture(e,this._sizeGradients,this._sizeGradientsTexture),this._sizeGradientsTexture=null,this}_refreshFactorGradient(e,t,i=!1){if(!e)return;i&&e.sort((s,o)=>s.gradient<o.gradient?-1:s.gradient>o.gradient?1:0);let r=this;r[t]&&(r[t].dispose(),r[t]=null)}addAngularSpeedGradient(e,t){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture",!0),this._releaseBuffers(),this}removeAngularSpeedGradient(e){return this._removeGradientAndTexture(e,this._angularSpeedGradients,this._angularSpeedGradientsTexture),this._angularSpeedGradientsTexture=null,this}addVelocityGradient(e,t){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture",!0),this._releaseBuffers(),this}removeVelocityGradient(e){return this._removeGradientAndTexture(e,this._velocityGradients,this._velocityGradientsTexture),this._velocityGradientsTexture=null,this}addLimitVelocityGradient(e,t){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture",!0),this._releaseBuffers(),this}removeLimitVelocityGradient(e){return this._removeGradientAndTexture(e,this._limitVelocityGradients,this._limitVelocityGradientsTexture),this._limitVelocityGradientsTexture=null,this}addDragGradient(e,t){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture",!0),this._releaseBuffers(),this}removeDragGradient(e){return this._removeGradientAndTexture(e,this._dragGradients,this._dragGradientsTexture),this._dragGradientsTexture=null,this}addEmitRateGradient(){return this}removeEmitRateGradient(){return this}addStartSizeGradient(){return this}removeStartSizeGradient(){return this}addColorRemapGradient(){return this}removeColorRemapGradient(){return this}addAlphaRemapGradient(){return this}removeAlphaRemapGradient(){return this}addRampGradient(){return this}removeRampGradient(){return this}getRampGradients(){return null}get useRampGradients(){return!1}set useRampGradients(e){}addLifeTimeGradient(){return this}removeLifeTimeGradient(){return this}constructor(e,t,i,r=null,s=!1){if(super(e),this.layerMask=268435455,this._accumulatedCount=0,this._renderVertexBuffers=[],this._targetIndex=0,this._currentRenderId=-1,this._currentRenderingCameraUniqueId=-1,this._started=!1,this._stopped=!1,this._timeDelta=0,this.updateInAnimate=!1,this._actualFrame=0,this._rawTextureWidth=256,this._rebuildingAfterContextLost=!1,this.doNotSerialize=!1,this.onDisposeObservable=new F,this.onStoppedObservable=new F,this.onStartedObservable=new F,this.forceDepthWrite=!1,this._preWarmDone=!1,this.isLocal=!1,this.isGPU=!0,this.metadata=null,this._flowMap=null,this.flowMapStrength=1,this._onBeforeDrawParticlesObservable=null,!i||i.getClassName()==="Scene"?(this._scene=i||ye.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)):(this._engine=i,this.defaultProjectionMatrix=L.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)),this._engine.getCaps().supportComputeShaders){if(!vt("BABYLON.ComputeShaderParticleSystem"))throw new Error("The ComputeShaderParticleSystem class is not available! Make sure you have imported it.");this._platform=new(vt("BABYLON.ComputeShaderParticleSystem"))(this,this._engine)}else{if(!vt("BABYLON.WebGL2ParticleSystem"))throw new Error("The WebGL2ParticleSystem class is not available! Make sure you have imported it.");this._platform=new(vt("BABYLON.WebGL2ParticleSystem"))(this,this._engine)}this._customWrappers={0:new Ti(this._engine)},this._customWrappers[0].effect=r,this._drawWrappers={0:new Ti(this._engine)},this._drawWrappers[0].drawContext&&(this._drawWrappers[0].drawContext.useInstancing=!0),this._createIndexBuffer(),this._attachImageProcessingConfiguration(null),t=t??{},t.randomTextureSize||delete t.randomTextureSize;let o=Y({capacity:5e4,randomTextureSize:this._engine.getCaps().maxTextureSize},t),a=t;isFinite(a)&&(o.capacity=a),this._capacity=o.capacity,this._maxActiveParticleCount=o.capacity,this._currentActiveCount=0,this._isAnimationSheetEnabled=s,this.particleEmitterType=new hr;let l=Math.min(this._engine.getCaps().maxTextureSize,o.randomTextureSize),c=[];for(let u=0;u<l;++u)c.push(Math.random()),c.push(Math.random()),c.push(Math.random()),c.push(Math.random());this._randomTexture=new _i(new Float32Array(c),l,1,5,i,!1,!1,1,1),this._randomTexture.name="GPUParticleSystem_random1",this._randomTexture.wrapU=1,this._randomTexture.wrapV=1,c=[];for(let u=0;u<l;++u)c.push(Math.random()),c.push(Math.random()),c.push(Math.random()),c.push(Math.random());this._randomTexture2=new _i(new Float32Array(c),l,1,5,i,!1,!1,1,1),this._randomTexture2.name="GPUParticleSystem_random2",this._randomTexture2.wrapU=1,this._randomTexture2.wrapV=1,this._randomTextureSize=l}_reset(){this._releaseBuffers()}_createVertexBuffers(e,t,i){let r={};r.position=t.createVertexBuffer("position",0,3,this._attributesStrideSize,!0);let s=3;r.age=t.createVertexBuffer("age",s,1,this._attributesStrideSize,!0),s+=1,r.size=t.createVertexBuffer("size",s,3,this._attributesStrideSize,!0),s+=3,r.life=t.createVertexBuffer("life",s,1,this._attributesStrideSize,!0),s+=1,s+=4,this.billboardMode===Mt.BILLBOARDMODE_STRETCHED&&(r.direction=t.createVertexBuffer("direction",s,3,this._attributesStrideSize,!0)),s+=3,this._platform.alignDataInBuffer&&(s+=1),this.particleEmitterType instanceof dr&&(s+=3,this._platform.alignDataInBuffer&&(s+=1)),this._colorGradientsTexture||(r.color=t.createVertexBuffer("color",s,4,this._attributesStrideSize,!0),s+=4),this._isBillboardBased||(r.initialDirection=t.createVertexBuffer("initialDirection",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1)),this.noiseTexture&&(r.noiseCoordinates1=t.createVertexBuffer("noiseCoordinates1",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1),r.noiseCoordinates2=t.createVertexBuffer("noiseCoordinates2",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1)),r.angle=t.createVertexBuffer("angle",s,1,this._attributesStrideSize,!0),this._angularSpeedGradientsTexture?s++:s+=2,this._isAnimationSheetEnabled&&(r.cellIndex=t.createVertexBuffer("cellIndex",s,1,this._attributesStrideSize,!0),s+=1,this.spriteRandomStartCell&&(r.cellStartOffset=t.createVertexBuffer("cellStartOffset",s,1,this._attributesStrideSize,!0),s+=1)),r.offset=i.createVertexBuffer("offset",0,2),r.uv=i.createVertexBuffer("uv",2,2),this._renderVertexBuffers.push(r),this._platform.createVertexBuffers(e,r),this.resetDrawCache()}_initialize(e=!1){if(this._buffer0&&!e)return;let t=this._engine,i=[];this._attributesStrideSize=21,this._targetIndex=0,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1),this.particleEmitterType instanceof dr&&(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this.isBillboardBased||(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this._colorGradientsTexture&&(this._attributesStrideSize-=4),this._angularSpeedGradientsTexture&&(this._attributesStrideSize-=1),this._isAnimationSheetEnabled&&(this._attributesStrideSize+=1,this.spriteRandomStartCell&&(this._attributesStrideSize+=1)),this.noiseTexture&&(this._attributesStrideSize+=6,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=2)),this._platform.alignDataInBuffer&&(this._attributesStrideSize+=3-(this._attributesStrideSize+3&3));let r=this.particleEmitterType instanceof dr,s=k.Vector3[0],o=0;for(let u=0;u<this._capacity;u++)if(i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),r?(this.particleEmitterType.particleDestinationGenerator(u,null,s),i.push(s.x),i.push(s.y),i.push(s.z)):(i.push(0),i.push(0),i.push(0)),this._platform.alignDataInBuffer&&i.push(0),o+=16,r&&(this.particleEmitterType.particlePositionGenerator(u,null,s),i.push(s.x),i.push(s.y),i.push(s.z),this._platform.alignDataInBuffer&&i.push(0),o+=4),this._colorGradientsTexture||(i.push(0),i.push(0),i.push(0),i.push(0),o+=4),this.isBillboardBased||(i.push(0),i.push(0),i.push(0),this._platform.alignDataInBuffer&&i.push(0),o+=4),this.noiseTexture&&(i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),o+=8),i.push(0),o+=1,this._angularSpeedGradientsTexture||(i.push(0),o+=1),this._isAnimationSheetEnabled&&(i.push(0),o+=1,this.spriteRandomStartCell&&(i.push(0),o+=1)),this._platform.alignDataInBuffer){let h=3-(o+3&3);for(o+=h;h-- >0;)i.push(0)}let a=new Float32Array([.5,.5,1,1,-.5,.5,0,1,.5,-.5,1,0,-.5,-.5,0,0]),l=this._platform.createParticleBuffer(i),c=this._platform.createParticleBuffer(i);this._buffer0=new ei(t,l,!1,this._attributesStrideSize),this._buffer1=new ei(t,c,!1,this._attributesStrideSize),this._spriteBuffer=new ei(t,a,!1,4),this._renderVertexBuffers=[],this._createVertexBuffers(this._buffer0,this._buffer1,this._spriteBuffer),this._createVertexBuffers(this._buffer1,this._buffer0,this._spriteBuffer),this._sourceBuffer=this._buffer0,this._targetBuffer=this._buffer1}_recreateUpdateEffect(){this._createColorGradientTexture(),this._createSizeGradientTexture(),this._createAngularSpeedGradientTexture(),this._createVelocityGradientTexture(),this._createLimitVelocityGradientTexture(),this._createDragGradientTexture();let e=this.particleEmitterType?this.particleEmitterType.getEffectDefines():"";return this._isBillboardBased&&(e+=`
#define BILLBOARD`),this._colorGradientsTexture&&(e+=`
#define COLORGRADIENTS`),this._sizeGradientsTexture&&(e+=`
#define SIZEGRADIENTS`),this._angularSpeedGradientsTexture&&(e+=`
#define ANGULARSPEEDGRADIENTS`),this._velocityGradientsTexture&&(e+=`
#define VELOCITYGRADIENTS`),this._limitVelocityGradientsTexture&&(e+=`
#define LIMITVELOCITYGRADIENTS`),this._dragGradientsTexture&&(e+=`
#define DRAGGRADIENTS`),this._flowMap&&(e+=`
#define FLOWMAP`),this.isAnimationSheetEnabled&&(e+=`
#define ANIMATESHEET`,this.spriteRandomStartCell&&(e+=`
#define ANIMATESHEETRANDOMSTART`)),this.noiseTexture&&(e+=`
#define NOISE`),this.isLocal&&(e+=`
#define LOCAL`),this._platform.isUpdateBufferCreated()&&this._cachedUpdateDefines===e?this._platform.isUpdateBufferReady():(this._cachedUpdateDefines=e,this._updateBuffer=this._platform.createUpdateBuffer(e),this._platform.isUpdateBufferReady())}_getWrapper(e){let t=this._getCustomDrawWrapper(e);if(t?.effect)return t;let i=[];this.fillDefines(i,e);let r=this._drawWrappers[e];r||(r=new Ti(this._engine),r.drawContext&&(r.drawContext.useInstancing=!0),this._drawWrappers[e]=r);let s=i.join(`
`);if(r.defines!==s){let o=[],a=[],l=[];this.fillUniformsAttributesAndSamplerNames(a,o,l),r.setEffect(this._engine.createEffect("gpuRenderParticles",o,a,l,s),s)}return r}static _GetAttributeNamesOrOptions(e=!1,t=!1,i=!1,r=!1){let s=[T.PositionKind,"age","life","size","angle"];return e||s.push(T.ColorKind),t&&s.push("cellIndex"),i||s.push("initialDirection"),r&&s.push("direction"),s.push("offset",T.UVKind),s}static _GetEffectCreationOptions(e=!1,t=!1,i=!1){let r=["emitterWM","worldOffset","view","projection","colorDead","invView","translationPivot","eyePosition"];return Yi(r),e&&r.push("sheetInfos"),t&&r.push("logarithmicDepthConstant"),i&&(r.push("vFogInfos"),r.push("vFogColor")),r}fillDefines(e,t=0,i=!0){if(this._scene&&(Es(this,this._scene,e),this.applyFog&&this._scene.fogEnabled&&this._scene.fogMode!==Ce.FOGMODE_NONE&&e.push("#define FOG")),t===Mt.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this.isLocal&&e.push("#define LOCAL"),this.useLogarithmicDepth&&e.push("#define LOGARITHMICDEPTH"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case Mt.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case Mt.BILLBOARDMODE_STRETCHED:e.push("#define BILLBOARDSTRETCHED");break;case Mt.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL");break;default:break}this._colorGradientsTexture&&e.push("#define COLORGRADIENTS"),this.isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),i&&this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(""+this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(e,t,i){t.push(...n._GetAttributeNamesOrOptions(!!this._colorGradientsTexture,this._isAnimationSheetEnabled,this._isBillboardBased,this._isBillboardBased&&this.billboardMode===Mt.BILLBOARDMODE_STRETCHED)),e.push(...n._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth,this.applyFog)),i.push("diffuseSampler","colorGradientSampler"),this._imageProcessingConfiguration&&(gn.PrepareUniforms(e,this._imageProcessingConfigurationDefines),gn.PrepareSamplers(i,this._imageProcessingConfigurationDefines))}animate(e=!1){this._timeDelta=this.updateSpeed*(e?this.preWarmStepOffset:this._scene?.getAnimationRatio()||1),this._actualFrame+=this._timeDelta,this._stopped||this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop(),this.updateInAnimate&&this._update()}_createFactorGradientTexture(e,t){let i=this[t];if(!e||!e.length||i)return;let r=new Float32Array(this._rawTextureWidth);for(let s=0;s<this._rawTextureWidth;s++){let o=s/this._rawTextureWidth;li.GetCurrentGradient(o,e,(a,l,c)=>{r[s]=Qt(a.factor1,l.factor1,c)})}this[t]=_i.CreateRTexture(r,this._rawTextureWidth,1,this._scene||this._engine,!1,!1,1),this[t].name=t.substring(1)}_createSizeGradientTexture(){this._createFactorGradientTexture(this._sizeGradients,"_sizeGradientsTexture")}_createAngularSpeedGradientTexture(){this._createFactorGradientTexture(this._angularSpeedGradients,"_angularSpeedGradientsTexture")}_createVelocityGradientTexture(){this._createFactorGradientTexture(this._velocityGradients,"_velocityGradientsTexture")}_createLimitVelocityGradientTexture(){this._createFactorGradientTexture(this._limitVelocityGradients,"_limitVelocityGradientsTexture")}_createDragGradientTexture(){this._createFactorGradientTexture(this._dragGradients,"_dragGradientsTexture")}_createColorGradientTexture(){if(!this._colorGradients||!this._colorGradients.length||this._colorGradientsTexture)return;let e=new Uint8Array(this._rawTextureWidth*4),t=ot.Color4[0];for(let i=0;i<this._rawTextureWidth;i++){let r=i/this._rawTextureWidth;li.GetCurrentGradient(r,this._colorGradients,(s,o,a)=>{ce.LerpToRef(s.color1,o.color1,a,t),e[i*4]=t.r*255,e[i*4+1]=t.g*255,e[i*4+2]=t.b*255,e[i*4+3]=t.a*255})}this._colorGradientsTexture=_i.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1),this._colorGradientsTexture.name="colorGradients"}_render(e,t){let i=this._getWrapper(e),r=i.effect;this._engine.enableEffect(i);let s=this._scene?.getViewMatrix()||L.IdentityReadOnly;r.setMatrix("view",s),r.setMatrix("projection",this.defaultProjectionMatrix??this._scene.getProjectionMatrix()),r.setTexture("diffuseSampler",this.particleTexture),r.setVector2("translationPivot",this.translationPivot);let o=this.worldOffset.subtractToRef(this._scene?.floatingOriginOffset||m.ZeroReadOnly,k.Vector3[0]);if(r.setVector3("worldOffset",o),this.isLocal&&r.setMatrix("emitterWM",t),this._colorGradientsTexture?r.setTexture("colorGradientSampler",this._colorGradientsTexture):r.setDirectColor4("colorDead",this.colorDead),this._isAnimationSheetEnabled&&this.particleTexture){let l=this.particleTexture.getBaseSize();r.setFloat3("sheetInfos",this.spriteCellWidth/l.width,this.spriteCellHeight/l.height,l.width/this.spriteCellWidth)}if(this._isBillboardBased&&this._scene){let l=this._scene.activeCamera;r.setVector3("eyePosition",l.globalPosition)}let a=r.defines;if(this._scene&&(Ki(r,this,this._scene),this.applyFog&&Nn(this._scene,void 0,r)),a.indexOf("#define BILLBOARDMODE_ALL")>=0){let l=s.clone();l.invert(),r.setMatrix("invView",l)}return this.useLogarithmicDepth&&this._scene&&Si(a,r,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(r),this._setEngineBasedOnBlendMode(e),this._platform.bindDrawBuffers(this._targetIndex,r,this._scene?.forceWireframe?this._linesIndexBufferUseInstancing:null),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(r),this._scene?.forceWireframe?this._engine.drawElementsType(6,0,10,this._currentActiveCount):this._engine.drawArraysType(7,0,4,this._currentActiveCount),this._engine.setAlphaMode(0),this._scene?.forceWireframe&&this._engine.unbindInstanceAttributes(),this._currentActiveCount}_update(e){if(!this.emitter||!this._targetBuffer||!this._recreateUpdateEffect()||this._rebuildingAfterContextLost)return;if(!e)if(this.emitter.position)e=this.emitter.getWorldMatrix();else{let s=this.emitter;e=k.Matrix[0],L.TranslationToRef(s.x,s.y,s.z,e)}let t=this._engine,i=t.getDepthWrite();if(t.setDepthWrite(!1),this._platform.preUpdateParticleBuffer(),this._updateBuffer.setFloat("currentCount",this._currentActiveCount),this._updateBuffer.setFloat("timeDelta",this._timeDelta),this._updateBuffer.setFloat("stopFactor",this._stopped?0:1),this._updateBuffer.setInt("randomTextureSize",this._randomTextureSize),this._updateBuffer.setFloat2("lifeTime",this.minLifeTime,this.maxLifeTime),this._updateBuffer.setFloat2("emitPower",this.minEmitPower,this.maxEmitPower),this._colorGradientsTexture||(this._updateBuffer.setDirectColor4("color1",this.color1),this._updateBuffer.setDirectColor4("color2",this.color2)),this._updateBuffer.setFloat2("sizeRange",this.minSize,this.maxSize),this._updateBuffer.setFloat4("scaleRange",this.minScaleX,this.maxScaleX,this.minScaleY,this.maxScaleY),this._updateBuffer.setFloat4("angleRange",this.minAngularSpeed,this.maxAngularSpeed,this.minInitialRotation,this.maxInitialRotation),this._updateBuffer.setVector3("gravity",this.gravity),this._limitVelocityGradientsTexture&&this._updateBuffer.setFloat("limitVelocityDamping",this.limitVelocityDamping),this.particleEmitterType&&this.particleEmitterType.applyToShader(this._updateBuffer),this._isAnimationSheetEnabled&&this._updateBuffer.setFloat4("cellInfos",this.startSpriteCellID,this.endSpriteCellID,this.spriteCellChangeSpeed,this.spriteCellLoop?1:0),this.noiseTexture&&this._updateBuffer.setVector3("noiseStrength",this.noiseStrength),this._flowMap){let s=this.getScene();this._updateBuffer.setFloat("flowMapStrength",this.flowMapStrength),this._updateBuffer.setMatrix("flowMapProjection",s.getTransformMatrix())}this.isLocal||this._updateBuffer.setMatrix("emitterWM",e),this._platform.updateParticleBuffer(this._targetIndex,this._targetBuffer,this._currentActiveCount),this._targetIndex++,this._targetIndex===2&&(this._targetIndex=0);let r=this._sourceBuffer;this._sourceBuffer=this._targetBuffer,this._targetBuffer=r,t.setDepthWrite(i)}render(e=!1,t=!1){if(!this._started||!this.isReady())return 0;if(!e&&this._scene){if(!this._preWarmDone&&this.preWarmCycles){for(let o=0;o<this.preWarmCycles;o++)this.animate(!0),this.render(!0,!0);this._preWarmDone=!0}if(this._currentRenderId===this._scene.getRenderId()&&(!this._scene.activeCamera||this._scene.activeCamera&&this._currentRenderingCameraUniqueId===this._scene.activeCamera.uniqueId))return 0;this._currentRenderId=this._scene.getRenderId(),this._scene.activeCamera&&(this._currentRenderingCameraUniqueId=this._scene.activeCamera.uniqueId)}if(this._initialize(),this.manualEmitCount>-1?(this._accumulatedCount+=this.manualEmitCount,this.manualEmitCount=0):this._accumulatedCount+=this.emitRate*this._timeDelta,this._accumulatedCount>=1){let o=this._accumulatedCount|0;this._accumulatedCount-=o,this._currentActiveCount+=o}if(this._currentActiveCount=Math.min(this._maxActiveParticleCount,this._currentActiveCount),!this._currentActiveCount)return 0;let i;if(this.emitter.position)i=this.emitter.getWorldMatrix();else{let o=this.emitter;i=k.Matrix[0],L.TranslationToRef(o.x,o.y,o.z,i)}let r=this._engine;this.updateInAnimate||this._update(i);let s=0;return!e&&!t&&(r.setState(!1),this.forceDepthWrite&&r.setDepthWrite(!0),this.blendMode===Mt.BLENDMODE_MULTIPLYADD?s=this._render(Mt.BLENDMODE_MULTIPLY,i)+this._render(Mt.BLENDMODE_ADD,i):s=this._render(this.blendMode,i),this._engine.setAlphaMode(0)),s}rebuild(){let e=()=>{!this._recreateUpdateEffect()||!this._platform.isUpdateBufferReady()?setTimeout(e,10):(this._initialize(!0),this._rebuildingAfterContextLost=!1)};this._createIndexBuffer(),this._cachedUpdateDefines="",this._platform.contextLost(),this._rebuildingAfterContextLost=!0,e()}_releaseBuffers(){this._buffer0&&(this._buffer0.dispose(),this._buffer0=null),this._buffer1&&(this._buffer1.dispose(),this._buffer1=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._platform.releaseBuffers()}dispose(e=!0){for(let t in this._drawWrappers)this._drawWrappers[t].dispose();if(this._drawWrappers={},this._scene){let t=this._scene.particleSystems.indexOf(this);t>-1&&this._scene.particleSystems.splice(t,1)}this._releaseBuffers(),this._platform.releaseVertexBuffers();for(let t=0;t<this._renderVertexBuffers.length;++t){let i=this._renderVertexBuffers[t];for(let r in i)i[r].dispose()}this._renderVertexBuffers=[],this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null),this._sizeGradientsTexture&&(this._sizeGradientsTexture.dispose(),this._sizeGradientsTexture=null),this._angularSpeedGradientsTexture&&(this._angularSpeedGradientsTexture.dispose(),this._angularSpeedGradientsTexture=null),this._velocityGradientsTexture&&(this._velocityGradientsTexture.dispose(),this._velocityGradientsTexture=null),this._limitVelocityGradientsTexture&&(this._limitVelocityGradientsTexture.dispose(),this._limitVelocityGradientsTexture=null),this._dragGradientsTexture&&(this._dragGradientsTexture.dispose(),this._dragGradientsTexture=null),this._randomTexture&&(this._randomTexture.dispose(),this._randomTexture=null),this._randomTexture2&&(this._randomTexture2.dispose(),this._randomTexture2=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this.onStoppedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}clone(e,t,i=!1){let r=Y({},this._customWrappers),s=null,o=this._engine;if(o.createEffectForParticles&&this.customShader!=null){s=this.customShader;let c=s.shaderOptions.defines.length>0?s.shaderOptions.defines.join(`
`):"";r[0]=o.createEffectForParticles(s.shaderPath.fragmentElement,s.shaderOptions.uniforms,s.shaderOptions.samplers,c,void 0,void 0,void 0,this)}let a=this.serialize(i),l=n.Parse(a,this._scene||this._engine,this._rootUrl);return l.name=e,l.customShader=s,l._customWrappers=r,t===void 0&&(t=this.emitter),this.noiseTexture&&(l.noiseTexture=this.noiseTexture.clone()),l.emitter=t,l}serialize(e=!1){let t={};return Mt._Serialize(t,this,e),t.activeParticleCount=this.activeParticleCount,t.randomTextureSize=this._randomTextureSize,t.customShader=this.customShader,t.preventAutoStart=this.preventAutoStart,t.worldOffset=this.worldOffset.asArray(),this.metadata&&(t.metadata=this.metadata),t}static Parse(e,t,i,r=!1,s){let o=e.name,a,l;t instanceof ne?a=t:(l=t,a=l.getEngine());let c=new n(o,{capacity:s||e.capacity,randomTextureSize:e.randomTextureSize},t,null,e.isAnimationSheetEnabled);if(c._rootUrl=i,e.customShader&&a.createEffectForParticles){let u=e.customShader,h=u.shaderOptions.defines.length>0?u.shaderOptions.defines.join(`
`):"",d=a.createEffectForParticles(u.shaderPath.fragmentElement,u.shaderOptions.uniforms,u.shaderOptions.samplers,h,void 0,void 0,void 0,c);c.setCustomEffect(d,0),c.customShader=u}return e.id&&(c.id=e.id),e.activeParticleCount&&(c.activeParticleCount=e.activeParticleCount),Mt._Parse(e,c,t,i),e.worldOffset&&(c.worldOffset=m.FromArray(e.worldOffset)),e.preventAutoStart&&(c.preventAutoStart=e.preventAutoStart),e.metadata&&(c.metadata=e.metadata),!r&&!c.preventAutoStart&&c.start(),c}};Xs(Oe.NAME_PARTICLESYSTEM,(n,e,t,i)=>{let r=Fm(Oe.NAME_PARTICLESYSTEM);if(r&&n.particleSystems!==void 0&&n.particleSystems!==null)for(let s=0,o=n.particleSystems.length;s<o;s++){let a=n.particleSystems[s];t.particleSystems.push(r(a,e,i))}});cM(Oe.NAME_PARTICLESYSTEM,(n,e,t)=>n.activeParticleCount?ta.Parse(n,e,t):Mt.Parse(n,e,t));ne.prototype.createEffectForParticles=function(n,e=[],t=[],i="",r,s,o,a,l=0,c){let u=[],h=[],d=[];return a?a.fillUniformsAttributesAndSamplerNames(h,u,d):(u=Mt._GetAttributeNamesOrOptions(),h=Mt._GetEffectCreationOptions()),i.indexOf(" BILLBOARD")===-1&&(i+=`
#define BILLBOARD
`),a?.isAnimationSheetEnabled&&i.indexOf(" ANIMATESHEET")===-1&&(i+=`
#define ANIMATESHEET
`),t.indexOf("diffuseSampler")===-1&&t.push("diffuseSampler"),this.createEffect({vertex:c??a?.vertexShaderName??"particles",fragmentElement:n},u,h.concat(e),d.concat(t),i,r,s,o,void 0,l,()=>S(this,null,function*(){l===0?yield import("./chunk-43LWPJVC.js"):yield import("./chunk-IKAQWQYS.js")}))};E.prototype.getEmittedParticleSystems=function(){let n=[];for(let e=0;e<this.getScene().particleSystems.length;e++){let t=this.getScene().particleSystems[e];t.emitter===this&&n.push(t)}return n};E.prototype.getHierarchyEmittedParticleSystems=function(){let n=[],e=this.getDescendants();e.push(this);for(let t=0;t<this.getScene().particleSystems.length;t++){let i=this.getScene().particleSystems[t],r=i.emitter;r.position&&e.indexOf(r)!==-1&&n.push(i)}return n};var Qm=class{_isUbo(e){return e.addUniform!==void 0}constructor(e){this._isUbo(e)?(this.setMatrix3x3=e.updateMatrix3x3.bind(e),this.setMatrix2x2=e.updateMatrix2x2.bind(e),this.setFloat=e.updateFloat.bind(e),this.setFloat2=e.updateFloat2.bind(e),this.setFloat3=e.updateFloat3.bind(e),this.setFloat4=e.updateFloat4.bind(e),this.setFloatArray=e.updateFloatArray.bind(e),this.setArray=e.updateArray.bind(e),this.setIntArray=e.updateIntArray.bind(e),this.setMatrix=e.updateMatrix.bind(e),this.setMatrices=e.updateMatrices.bind(e),this.setVector3=e.updateVector3.bind(e),this.setVector4=e.updateVector4.bind(e),this.setColor3=e.updateColor3.bind(e),this.setColor4=e.updateColor4.bind(e),this.setDirectColor4=e.updateDirectColor4.bind(e),this.setInt=e.updateInt.bind(e),this.setInt2=e.updateInt2.bind(e),this.setInt3=e.updateInt3.bind(e),this.setInt4=e.updateInt4.bind(e)):(this.setMatrix3x3=e.setMatrix3x3.bind(e),this.setMatrix2x2=e.setMatrix2x2.bind(e),this.setFloat=e.setFloat.bind(e),this.setFloat2=e.setFloat2.bind(e),this.setFloat3=e.setFloat3.bind(e),this.setFloat4=e.setFloat4.bind(e),this.setFloatArray=e.setFloatArray.bind(e),this.setArray=e.setArray.bind(e),this.setIntArray=e.setIntArray.bind(e),this.setMatrix=e.setMatrix.bind(e),this.setMatrices=e.setMatrices.bind(e),this.setVector3=e.setVector3.bind(e),this.setVector4=e.setVector4.bind(e),this.setColor3=e.setColor3.bind(e),this.setColor4=e.setColor4.bind(e),this.setDirectColor4=e.setDirectColor4.bind(e),this.setInt=e.setInt.bind(e),this.setInt2=e.setInt2.bind(e),this.setInt3=e.setInt3.bind(e),this.setInt4=e.setInt4.bind(e))}};var JM="gpuUpdateParticlesPixelShader",Mk=`#version 300 es
void main() {discard;}
`;ht.ShadersStore[JM]||(ht.ShadersStore[JM]=Mk);var eD="gpuUpdateParticlesVertexShader",Dk=`#version 300 es
#define PI 3.14159
uniform float currentCount;uniform float timeDelta;uniform float stopFactor;
#ifndef LOCAL
uniform mat4 emitterWM;
#endif
uniform vec2 lifeTime;uniform vec2 emitPower;uniform vec2 sizeRange;uniform vec4 scaleRange;
#ifdef FLOWMAP
uniform mat4 flowMapProjection;uniform float flowMapStrength;uniform sampler2D flowMapSampler;
#endif
#ifndef COLORGRADIENTS
uniform vec4 color1;uniform vec4 color2;
#endif
uniform vec3 gravity;uniform sampler2D randomSampler;uniform sampler2D randomSampler2;uniform vec4 angleRange;
#ifdef BOXEMITTER
uniform vec3 direction1;uniform vec3 direction2;uniform vec3 minEmitBox;uniform vec3 maxEmitBox;
#endif
#ifdef POINTEMITTER
uniform vec3 direction1;uniform vec3 direction2;
#endif
#ifdef HEMISPHERICEMITTER
uniform float radius;uniform float radiusRange;uniform float directionRandomizer;
#endif
#ifdef SPHEREEMITTER
uniform float radius;uniform float radiusRange;
#ifdef DIRECTEDSPHEREEMITTER
uniform vec3 direction1;uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
#ifdef CYLINDEREMITTER
uniform float radius;uniform float height;uniform float radiusRange;
#ifdef DIRECTEDCYLINDEREMITTER
uniform vec3 direction1;uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
#ifdef CONEEMITTER
uniform vec2 radius;uniform float coneAngle;uniform vec2 height;
#ifdef DIRECTEDCONEEMITTER
uniform vec3 direction1;uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
in vec3 position;
#ifdef CUSTOMEMITTER
in vec3 initialPosition;
#endif
in float age;in float life;in vec4 seed;in vec3 size;
#ifndef COLORGRADIENTS
in vec4 color;
#endif
in vec3 direction;
#ifndef BILLBOARD
in vec3 initialDirection;
#endif
#ifdef ANGULARSPEEDGRADIENTS
in float angle;
#else
in vec2 angle;
#endif
#ifdef ANIMATESHEET
in float cellIndex;
#ifdef ANIMATESHEETRANDOMSTART
in float cellStartOffset;
#endif
#endif
#ifdef NOISE
in vec3 noiseCoordinates1;in vec3 noiseCoordinates2;
#endif
out vec3 outPosition;
#ifdef CUSTOMEMITTER
out vec3 outInitialPosition;
#endif
out float outAge;out float outLife;out vec4 outSeed;out vec3 outSize;
#ifndef COLORGRADIENTS
out vec4 outColor;
#endif
out vec3 outDirection;
#ifndef BILLBOARD
out vec3 outInitialDirection;
#endif
#ifdef ANGULARSPEEDGRADIENTS
out float outAngle;
#else
out vec2 outAngle;
#endif
#ifdef ANIMATESHEET
out float outCellIndex;
#ifdef ANIMATESHEETRANDOMSTART
out float outCellStartOffset;
#endif
#endif
#ifdef NOISE
out vec3 outNoiseCoordinates1;out vec3 outNoiseCoordinates2;
#endif
#ifdef SIZEGRADIENTS
uniform sampler2D sizeGradientSampler;
#endif 
#ifdef ANGULARSPEEDGRADIENTS
uniform sampler2D angularSpeedGradientSampler;
#endif 
#ifdef VELOCITYGRADIENTS
uniform sampler2D velocityGradientSampler;
#endif
#ifdef LIMITVELOCITYGRADIENTS
uniform sampler2D limitVelocityGradientSampler;uniform float limitVelocityDamping;
#endif
#ifdef DRAGGRADIENTS
uniform sampler2D dragGradientSampler;
#endif
#ifdef NOISE
uniform vec3 noiseStrength;uniform sampler2D noiseSampler;
#endif
#ifdef ANIMATESHEET
uniform vec4 cellInfos;
#endif
vec3 getRandomVec3(float offset) {return texture(randomSampler2,vec2(float(gl_VertexID)*offset/currentCount,0)).rgb;}
vec4 getRandomVec4(float offset) {return texture(randomSampler,vec2(float(gl_VertexID)*offset/currentCount,0));}
void main() {float newAge=age+timeDelta; 
if (newAge>=life && stopFactor != 0.) {vec3 newPosition;vec3 newDirection;vec4 randoms=getRandomVec4(seed.x);outLife=lifeTime.x+(lifeTime.y-lifeTime.x)*randoms.r;outAge=newAge-life;outSeed=seed;
#ifdef SIZEGRADIENTS 
outSize.x=texture(sizeGradientSampler,vec2(0,0)).r;
#else
outSize.x=sizeRange.x+(sizeRange.y-sizeRange.x)*randoms.g;
#endif
outSize.y=scaleRange.x+(scaleRange.y-scaleRange.x)*randoms.b;outSize.z=scaleRange.z+(scaleRange.w-scaleRange.z)*randoms.a; 
#ifndef COLORGRADIENTS
outColor=color1+(color2-color1)*randoms.b;
#endif
#ifndef ANGULARSPEEDGRADIENTS 
outAngle.y=angleRange.x+(angleRange.y-angleRange.x)*randoms.a;outAngle.x=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;
#else
outAngle=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;
#endif 
#ifdef POINTEMITTER
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);newPosition=vec3(0,0,0);newDirection=direction1+(direction2-direction1)*randoms3;
#elif defined(BOXEMITTER)
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);newPosition=minEmitBox+(maxEmitBox-minEmitBox)*randoms2;newDirection=direction1+(direction2-direction1)*randoms3; 
#elif defined(HEMISPHERICEMITTER)
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float phi=2.0*PI*randoms2.x;float theta=acos(2.0*randoms2.y-1.0);float randX=cos(phi)*sin(theta);float randY=cos(theta);float randZ=sin(phi)*sin(theta);newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,abs(randY),randZ);newDirection=newPosition+directionRandomizer*randoms3; 
#elif defined(SPHEREEMITTER)
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float phi=2.0*PI*randoms2.x;float theta=acos(2.0*randoms2.y-1.0);float randX=cos(phi)*sin(theta);float randY=cos(theta);float randZ=sin(phi)*sin(theta);newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,randY,randZ);
#ifdef DIRECTEDSPHEREEMITTER
newDirection=normalize(direction1+(direction2-direction1)*randoms3);
#else
newDirection=normalize(newPosition+directionRandomizer*randoms3);
#endif
#elif defined(CYLINDEREMITTER)
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float yPos=(randoms2.x-0.5)*height;float angle=randoms2.y*PI*2.;float inverseRadiusRangeSquared=((1.-radiusRange)*(1.-radiusRange));float positionRadius=radius*sqrt(inverseRadiusRangeSquared+(randoms2.z*(1.-inverseRadiusRangeSquared)));float xPos=positionRadius*cos(angle);float zPos=positionRadius*sin(angle);newPosition=vec3(xPos,yPos,zPos);
#ifdef DIRECTEDCYLINDEREMITTER
newDirection=direction1+(direction2-direction1)*randoms3;
#else
angle=angle+((randoms3.x-0.5)*PI)*directionRandomizer;newDirection=vec3(cos(angle),(randoms3.y-0.5)*directionRandomizer,sin(angle));newDirection=normalize(newDirection);
#endif
#elif defined(CONEEMITTER)
vec3 randoms2=getRandomVec3(seed.y);float s=2.0*PI*randoms2.x;
#ifdef CONEEMITTERSPAWNPOINT
float h=0.0001;
#else
float h=randoms2.y*height.y;h=1.-h*h; 
#endif
float lRadius=radius.x-radius.x*randoms2.z*radius.y;lRadius=lRadius*h;float randX=lRadius*sin(s);float randZ=lRadius*cos(s);float randY=h *height.x;newPosition=vec3(randX,randY,randZ); 
vec3 randoms3=getRandomVec3(seed.z);
#ifdef DIRECTEDCONEEMITTER
newDirection=direction1+(direction2-direction1)*randoms3;
#else
if (abs(cos(coneAngle))==1.0) {newDirection=vec3(0.,1.0,0.);} else {newDirection=normalize(newPosition+directionRandomizer*randoms3); }
#endif
#elif defined(CUSTOMEMITTER)
newPosition=initialPosition;outInitialPosition=initialPosition;
#else 
newPosition=vec3(0.,0.,0.);newDirection=2.0*(getRandomVec3(seed.w)-vec3(0.5,0.5,0.5));
#endif
float power=emitPower.x+(emitPower.y-emitPower.x)*randoms.a;
#ifdef LOCAL
outPosition=newPosition;
#else
outPosition=(emitterWM*vec4(newPosition,1.)).xyz;
#endif
#ifdef CUSTOMEMITTER
outDirection=direction;
#ifndef BILLBOARD 
outInitialDirection=direction;
#endif
#else
#ifdef LOCAL
vec3 initial=newDirection;
#else 
vec3 initial=(emitterWM*vec4(newDirection,0.)).xyz;
#endif
outDirection=initial*power;
#ifndef BILLBOARD 
outInitialDirection=initial;
#endif
#endif
#ifdef ANIMATESHEET 
outCellIndex=cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
outCellStartOffset=randoms.a*outLife;
#endif 
#endif
#ifdef NOISE
outNoiseCoordinates1=noiseCoordinates1;outNoiseCoordinates2=noiseCoordinates2;
#endif
} else {float directionScale=timeDelta;outAge=newAge;float ageGradient=newAge/life;
#ifdef VELOCITYGRADIENTS
directionScale*=texture(velocityGradientSampler,vec2(ageGradient,0)).r;
#endif
#ifdef DRAGGRADIENTS
directionScale*=1.0-texture(dragGradientSampler,vec2(ageGradient,0)).r;
#endif
#if defined(CUSTOMEMITTER)
outPosition=position+(direction-position)*ageGradient; 
outInitialPosition=initialPosition;
#else
outPosition=position+direction*directionScale;
#endif
outLife=life;outSeed=seed;
#ifndef COLORGRADIENTS 
outColor=color;
#endif
#ifdef SIZEGRADIENTS
outSize.x=texture(sizeGradientSampler,vec2(ageGradient,0)).r;outSize.yz=size.yz;
#else
outSize=size;
#endif 
#ifndef BILLBOARD 
outInitialDirection=initialDirection;
#endif
#ifdef CUSTOMEMITTER
outDirection=direction;
#else
vec3 updatedDirection=direction+gravity*timeDelta;
#ifdef FLOWMAP
vec4 clipSpace=(flowMapProjection*vec4(position,1.));vec3 ndcSpace=clipSpace.xyz/clipSpace.w;vec2 flowMapUV=ndcSpace.xy*0.5+0.5;vec4 flowMapValue=texture(flowMapSampler,flowMapUV);vec3 flowMapDirection=(flowMapValue.xyz*2.0-1.0)*flowMapValue.w;updatedDirection+=flowMapDirection*timeDelta*flowMapStrength;
#endif
#ifdef LIMITVELOCITYGRADIENTS
float limitVelocity=texture(limitVelocityGradientSampler,vec2(ageGradient,0)).r;float currentVelocity=length(updatedDirection);if (currentVelocity>limitVelocity) {updatedDirection=updatedDirection*limitVelocityDamping;}
#endif
outDirection=updatedDirection;
#ifdef NOISE
float fetchedR=texture(noiseSampler,vec2(noiseCoordinates1.x,noiseCoordinates1.y)*vec2(0.5)+vec2(0.5)).r;float fetchedG=texture(noiseSampler,vec2(noiseCoordinates1.z,noiseCoordinates2.x)*vec2(0.5)+vec2(0.5)).r;float fetchedB=texture(noiseSampler,vec2(noiseCoordinates2.y,noiseCoordinates2.z)*vec2(0.5)+vec2(0.5)).r;vec3 force=vec3(2.*fetchedR-1.,2.*fetchedG-1.,2.*fetchedB-1.)*noiseStrength;outDirection=outDirection+force*timeDelta;outNoiseCoordinates1=noiseCoordinates1;outNoiseCoordinates2=noiseCoordinates2;
#endif 
#endif 
#ifdef ANGULARSPEEDGRADIENTS
float angularSpeed=texture(angularSpeedGradientSampler,vec2(ageGradient,0)).r;outAngle=angle+angularSpeed*timeDelta;
#else
outAngle=vec2(angle.x+angle.y*timeDelta,angle.y);
#endif
#ifdef ANIMATESHEET 
float offsetAge=outAge;float dist=cellInfos.y-cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
outCellStartOffset=cellStartOffset;offsetAge+=cellStartOffset;
#else
float cellStartOffset=0.;
#endif 
float ratio=0.;if (cellInfos.w==1.0) {ratio=clamp(mod(cellStartOffset+cellInfos.z*offsetAge,life)/life,0.,1.0);}
else {ratio=clamp(cellStartOffset+cellInfos.z*offsetAge/life,0.,1.0);}
outCellIndex=float(int(cellInfos.x+ratio*dist));
#endif
}}`;ht.ShadersStore[eD]||(ht.ShadersStore[eD]=Dk);var MC=class{constructor(e,t){this._renderVAO=[],this._updateVAO=[],this.alignDataInBuffer=!1,this._parent=e,this._engine=t,this._updateEffectOptions={attributes:["position","initialPosition","age","life","seed","size","color","direction","initialDirection","angle","cellIndex","cellStartOffset","noiseCoordinates1","noiseCoordinates2"],uniformsNames:["currentCount","timeDelta","emitterWM","lifeTime","color1","color2","sizeRange","scaleRange","gravity","emitPower","direction1","direction2","minEmitBox","maxEmitBox","radius","directionRandomizer","height","coneAngle","stopFactor","angleRange","radiusRange","cellInfos","noiseStrength","limitVelocityDamping","flowMapProjection","flowMapStrength"],uniformBuffersNames:[],samplers:["randomSampler","randomSampler2","sizeGradientSampler","angularSpeedGradientSampler","velocityGradientSampler","limitVelocityGradientSampler","noiseSampler","dragGradientSampler","flowMapSampler"],defines:"",fallbacks:null,onCompiled:null,onError:null,indexParameters:null,maxSimultaneousLights:0,transformFeedbackVaryings:[]}}contextLost(){this._updateEffect=void 0,this._renderVAO.length=0,this._updateVAO.length=0}isUpdateBufferCreated(){return!!this._updateEffect}isUpdateBufferReady(){return this._updateEffect?.isReady()??!1}createUpdateBuffer(e){return this._updateEffectOptions.transformFeedbackVaryings=["outPosition"],this._updateEffectOptions.transformFeedbackVaryings.push("outAge"),this._updateEffectOptions.transformFeedbackVaryings.push("outSize"),this._updateEffectOptions.transformFeedbackVaryings.push("outLife"),this._updateEffectOptions.transformFeedbackVaryings.push("outSeed"),this._updateEffectOptions.transformFeedbackVaryings.push("outDirection"),this._parent.particleEmitterType instanceof dr&&this._updateEffectOptions.transformFeedbackVaryings.push("outInitialPosition"),this._parent._colorGradientsTexture||this._updateEffectOptions.transformFeedbackVaryings.push("outColor"),this._parent._isBillboardBased||this._updateEffectOptions.transformFeedbackVaryings.push("outInitialDirection"),this._parent.noiseTexture&&(this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates1"),this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates2")),this._updateEffectOptions.transformFeedbackVaryings.push("outAngle"),this._parent.isAnimationSheetEnabled&&(this._updateEffectOptions.transformFeedbackVaryings.push("outCellIndex"),this._parent.spriteRandomStartCell&&this._updateEffectOptions.transformFeedbackVaryings.push("outCellStartOffset")),this._updateEffectOptions.defines=e,this._updateEffect=this._engine.createEffect("gpuUpdateParticles",this._updateEffectOptions,this._engine),new Qm(this._updateEffect)}createVertexBuffers(e,t){this._updateVAO.push(this._createUpdateVAO(e)),this._renderVAO.push(this._engine.recordVertexArrayObject(t,null,this._parent._getWrapper(this._parent.blendMode).effect)),this._engine.bindArrayBuffer(null),this._renderVertexBuffers=t}createParticleBuffer(e){return e}bindDrawBuffers(e,t,i){i?this._engine.bindBuffers(this._renderVertexBuffers,i,t):this._engine.bindVertexArrayObject(this._renderVAO[e],null)}preUpdateParticleBuffer(){let e=this._engine;if(this._engine.enableEffect(this._updateEffect),!e.setState)throw new Error("GPU particles cannot work without a full Engine. ThinEngine is not supported")}updateParticleBuffer(e,t,i){this._updateEffect.setTexture("randomSampler",this._parent._randomTexture),this._updateEffect.setTexture("randomSampler2",this._parent._randomTexture2),this._parent._flowMap&&this._updateEffect.setTexture("flowMapSampler",this._parent._flowMap),this._parent._sizeGradientsTexture&&this._updateEffect.setTexture("sizeGradientSampler",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateEffect.setTexture("angularSpeedGradientSampler",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateEffect.setTexture("velocityGradientSampler",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateEffect.setTexture("limitVelocityGradientSampler",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateEffect.setTexture("dragGradientSampler",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateEffect.setTexture("noiseSampler",this._parent.noiseTexture),this._engine.bindVertexArrayObject(this._updateVAO[e],null);let r=this._engine;r.bindTransformFeedbackBuffer(t.getBuffer()),r.setRasterizerState(!1),r.beginTransformFeedback(!0),r.drawArraysType(3,0,i),r.endTransformFeedback(),r.setRasterizerState(!0),r.bindTransformFeedbackBuffer(null)}releaseBuffers(){}releaseVertexBuffers(){for(let e=0;e<this._updateVAO.length;e++)this._engine.releaseVertexArrayObject(this._updateVAO[e]);this._updateVAO.length=0;for(let e=0;e<this._renderVAO.length;e++)this._engine.releaseVertexArrayObject(this._renderVAO[e]);this._renderVAO.length=0}_createUpdateVAO(e){let t={};t.position=e.createVertexBuffer("position",0,3);let i=3;t.age=e.createVertexBuffer("age",i,1),i+=1,t.size=e.createVertexBuffer("size",i,3),i+=3,t.life=e.createVertexBuffer("life",i,1),i+=1,t.seed=e.createVertexBuffer("seed",i,4),i+=4,t.direction=e.createVertexBuffer("direction",i,3),i+=3,this._parent.particleEmitterType instanceof dr&&(t.initialPosition=e.createVertexBuffer("initialPosition",i,3),i+=3),this._parent._colorGradientsTexture||(t.color=e.createVertexBuffer("color",i,4),i+=4),this._parent._isBillboardBased||(t.initialDirection=e.createVertexBuffer("initialDirection",i,3),i+=3),this._parent.noiseTexture&&(t.noiseCoordinates1=e.createVertexBuffer("noiseCoordinates1",i,3),i+=3,t.noiseCoordinates2=e.createVertexBuffer("noiseCoordinates2",i,3),i+=3),this._parent._angularSpeedGradientsTexture?(t.angle=e.createVertexBuffer("angle",i,1),i+=1):(t.angle=e.createVertexBuffer("angle",i,2),i+=2),this._parent._isAnimationSheetEnabled&&(t.cellIndex=e.createVertexBuffer("cellIndex",i,1),i+=1,this._parent.spriteRandomStartCell&&(t.cellStartOffset=e.createVertexBuffer("cellStartOffset",i,1),i+=1));let r=this._engine.recordVertexArrayObject(t,null,this._updateEffect);return this._engine.bindArrayBuffer(null),r}};le("BABYLON.WebGL2ParticleSystem",MC);var Jm=class{constructor(e,t={}){this._lodGenerationOffset=0,this._lodGenerationScale=.8,this.quality=4096,this.hdrScale=1,this._engine=e,this.hdrScale=t.hdrScale||this.hdrScale,this.quality=t.quality||this.quality}_createRenderTarget(e){let t=0;this._engine.getCaps().textureHalfFloatRender?t=2:this._engine.getCaps().textureFloatRender&&(t=1);let i=this._engine.createRenderTargetCubeTexture(e,{format:5,type:t,createMipMaps:!0,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:1,label:"HDR_Radiance_Filtering_Target"});return this._engine.updateTextureWrappingMode(i.texture,0,0,0),this._engine.updateTextureSamplingMode(3,i.texture,!0),i}_prefilterInternal(e){let t=e.getSize().width,i=Tc(t)+1,r=this._effectWrapper.effect,s=this._createRenderTarget(t);this._effectRenderer.saveStates(),this._effectRenderer.setViewport();let o=e.getInternalTexture();o&&this._engine.updateTextureSamplingMode(3,o,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let a=[[new m(0,0,-1),new m(0,-1,0),new m(1,0,0)],[new m(0,0,1),new m(0,-1,0),new m(-1,0,0)],[new m(1,0,0),new m(0,0,1),new m(0,1,0)],[new m(1,0,0),new m(0,0,-1),new m(0,-1,0)],[new m(1,0,0),new m(0,-1,0),new m(0,0,1)],[new m(-1,0,0),new m(0,-1,0),new m(0,0,-1)]];r.setFloat("hdrScale",this.hdrScale),r.setFloat2("vFilteringInfo",e.getSize().width,i),r.setTexture("inputTexture",e);for(let u=0;u<6;u++){r.setVector3("up",a[u][0]),r.setVector3("right",a[u][1]),r.setVector3("front",a[u][2]);for(let h=0;h<i;h++){this._engine.bindFramebuffer(s,u,void 0,void 0,!0,h),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let d=Math.pow(2,(h-this._lodGenerationOffset)/this._lodGenerationScale)/t;h===0&&(d=0),r.setFloat("alphaG",d),this._effectRenderer.draw()}}this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),this._engine._releaseTexture(e._texture);let l=s.texture.type,c=s.texture.format;return s._swapAndDie(e._texture),e._texture.type=l,e._texture.format=c,e.gammaSpace=!1,e.lodGenerationOffset=this._lodGenerationOffset,e.lodGenerationScale=this._lodGenerationScale,e._prefiltered=!0,e}_createEffect(e,t){let i=[];e.gammaSpace&&i.push("#define GAMMA_INPUT"),i.push("#define NUM_SAMPLES "+this.quality+"u");let r=this._engine.isWebGPU;return new Ic({engine:this._engine,name:"hdrFiltering",vertexShader:"hdrFiltering",fragmentShader:"hdrFiltering",samplerNames:["inputTexture"],uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale","alphaG"],useShaderStore:!0,defines:i,onCompiled:t,shaderLanguage:r?1:0,extraInitializationsAsync:()=>S(this,null,function*(){r?yield Promise.all([import("./chunk-4YIRUL2W.js"),import("./chunk-QDABGQWM.js")]):yield Promise.all([import("./chunk-SQOHTBS2.js"),import("./chunk-EBILOJZH.js")])})})}isReady(e){return e.isReady()&&this._effectWrapper.effect.isReady()}prefilter(e){return S(this,null,function*(){if(!this._engine._features.allowTexturePrefiltering)throw new Error("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead.");this._effectRenderer=new Oh(this._engine),this._effectWrapper=this._createEffect(e),yield this._effectWrapper.effect.whenCompiledAsync(),this._prefilterInternal(e),this._effectRenderer.dispose(),this._effectWrapper.dispose()})}};var eg=class{constructor(e){this.name=Oe.NAME_PROCEDURALTEXTURE,this.scene=e}register(){this.scene._beforeClearStage.registerStep(Oe.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)}rebuild(){}dispose(){}_beforeClear(){if(this.scene.proceduralTexturesEnabled){z.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(let e=0;e<this.scene.proceduralTextures.length;e++){let t=this.scene.proceduralTextures[e];t._shouldRender()&&t.render()}z.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}}};var Oi=class n extends Z{get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i,r,s=null,o=!0,a=!1,l=0){super(null,r,!o),this.isEnabled=!0,this.autoClear=!0,this.onGeneratedObservable=new F,this.onBeforeGenerationObservable=new F,this.nodeMaterialSource=null,this.defines="",this._textures={},this._currentRefreshId=-1,this._frameId=-1,this._refreshRate=1,this._vertexBuffers={},this._uniforms=new Array,this._samplers=new Array,this._floats={},this._ints={},this._floatsArrays={},this._colors3={},this._colors4={},this._vectors2={},this._vectors3={},this._vectors4={},this._matrices={},this._fallbackTextureUsed=!1,this._cachedDefines=null,this._contentUpdateId=-1,this._rtWrapper=null,s!==null&&!(s instanceof Z)?(this._options=s,this._fallbackTexture=s.fallbackTexture??null):(this._options={},this._fallbackTexture=s),this._shaderLanguage=this._options.shaderLanguage??0,r=this.getScene()||ye.LastCreatedScene;let c=r._getComponent(Oe.NAME_PROCEDURALTEXTURE);c||(c=new eg(r),r._addComponent(c)),r.proceduralTextures.push(this),this._fullEngine=r.getEngine(),this.name=e,this.isRenderTarget=!0,this._size=t,this._textureType=l,this._generateMipMaps=o,this._drawWrapper=new Ti(this._fullEngine),this.setFragment(i);let u=this._createRtWrapper(a,t,o,l);this._texture=u.texture;let h=[];h.push(1,1),h.push(-1,1),h.push(-1,-1),h.push(1,-1),this._vertexBuffers[T.PositionKind]=new T(this._fullEngine,h,T.PositionKind,!1,!1,2),this._createIndexBuffer()}_createRtWrapper(e,t,i,r){return e?(this._rtWrapper=this._fullEngine.createRenderTargetCubeTexture(t,Y({generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:r},this._options)),this.setFloat("face",0)):(this._rtWrapper=this._fullEngine.createRenderTargetTexture(t,Y({generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:r},this._options)),this._rtWrapper.is3D&&(this.setFloat("layer",0),this.setInt("layerNum",0))),this._rtWrapper}getEffect(){return this._drawWrapper.effect}_setEffect(e){this._drawWrapper.effect=e}getContent(){return this._contentData&&this._frameId===this._contentUpdateId?this._contentData:(this._contentData?this._contentData.then(e=>{this._contentData=this.readPixels(0,0,e),this._contentUpdateId=this._frameId}):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId),this._contentData)}_createIndexBuffer(){let e=this._fullEngine,t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){let e=this._vertexBuffers[T.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===hi.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=hi.REFRESHRATE_RENDER_ONCE)}reset(){this._drawWrapper.effect?.dispose(),this._drawWrapper.effect=null,this._cachedDefines=null}_getDefines(){return this.defines}executeWhenReady(e){if(this.isReady()){e(this);return}let t=this.getEffect();t&&t.executeWhenCompiled(()=>{e(this)})}isReady(){let e=this._fullEngine;if(this.nodeMaterialSource)return this._drawWrapper.effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;if(!this._texture)return!1;let t=this._getDefines();if(this._drawWrapper.effect&&t===this._cachedDefines&&this._drawWrapper.effect.isReady())return!0;let i={vertex:"procedural",fragmentElement:this._fragment.fragmentElement,fragmentSource:this._fragment.fragmentSource,fragment:typeof this._fragment=="string"?this._fragment:void 0};return this._cachedDefines!==t&&(this._cachedDefines=t,this._drawWrapper.effect=e.createEffect(i,[T.PositionKind],this._uniforms,this._samplers,t,void 0,void 0,()=>{this._rtWrapper?.dispose(),this._rtWrapper=this._texture=null,this._fallbackTexture&&(this._texture=this._fallbackTexture._texture,this._texture&&this._texture.incrementReferences()),this._fallbackTextureUsed=!0},void 0,this._shaderLanguage,()=>S(this,null,function*(){this._options.extraInitializationsAsync?this.shaderLanguage===1?yield Promise.all([import("./chunk-SKLIFPAC.js"),this._options.extraInitializationsAsync()]):yield Promise.all([import("./chunk-MCV5RKKF.js"),this._options.extraInitializationsAsync()]):this.shaderLanguage===1?yield import("./chunk-SKLIFPAC.js"):yield import("./chunk-MCV5RKKF.js")}))),this._drawWrapper.effect.isReady()}resetRefreshCounter(){this._currentRefreshId=-1}setFragment(e){this._fragment=e}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}_shouldRender(){return!this.isEnabled||!this.isReady()||!this._texture?(this._texture&&(this._texture.isReady=!1),!1):this._fallbackTextureUsed?!1:this._currentRefreshId===-1?(this._currentRefreshId=1,this._frameId++,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this._size}resize(e,t){if(this._fallbackTextureUsed||!this._rtWrapper||!this._texture)return;let i=this._texture.isCube;this._rtWrapper.dispose();let r=this._createRtWrapper(i,e,t,this._textureType);this._texture=r.texture,this._size=e,this._generateMipMaps=t}_checkUniform(e){this._uniforms.indexOf(e)===-1&&this._uniforms.push(e)}setTexture(e,t){return this._samplers.indexOf(e)===-1&&this._samplers.push(e),this._textures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}render(e){let t=this.getScene();if(!t)return;let i=this._fullEngine;if(i.enableEffect(this._drawWrapper),this.onBeforeGenerationObservable.notifyObservers(this),i.setState(!1),!this.nodeMaterialSource){for(let s in this._textures)this._drawWrapper.effect.setTexture(s,this._textures[s]);for(let s in this._ints)this._drawWrapper.effect.setInt(s,this._ints[s]);for(let s in this._floats)this._drawWrapper.effect.setFloat(s,this._floats[s]);for(let s in this._floatsArrays)this._drawWrapper.effect.setArray(s,this._floatsArrays[s]);for(let s in this._colors3)this._drawWrapper.effect.setColor3(s,this._colors3[s]);for(let s in this._colors4){let o=this._colors4[s];this._drawWrapper.effect.setFloat4(s,o.r,o.g,o.b,o.a)}for(let s in this._vectors2)this._drawWrapper.effect.setVector2(s,this._vectors2[s]);for(let s in this._vectors3)this._drawWrapper.effect.setVector3(s,this._vectors3[s]);for(let s in this._vectors4)this._drawWrapper.effect.setVector4(s,this._vectors4[s]);for(let s in this._matrices)this._drawWrapper.effect.setMatrix(s,this._matrices[s])}if(!this._texture||!this._rtWrapper)return;i._debugPushGroup?.(`procedural texture generation for ${this.name}`,1);let r=i.currentViewport;if(this.isCube)for(let s=0;s<6;s++)i.bindFramebuffer(this._rtWrapper,s,void 0,void 0,!0),i.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._drawWrapper.effect.setFloat("face",s),this.autoClear&&i.clear(t.clearColor,!0,!1,!1),i.drawElementsType(Re.TriangleFillMode,0,6),i.unBindFramebuffer(this._rtWrapper,!0);else{let s=1;this._rtWrapper.is3D?s=this._rtWrapper.depth:this._rtWrapper.is2DArray&&(s=this._rtWrapper.layers);for(let o=0;o<s;o++){if(i.bindFramebuffer(this._rtWrapper,0,void 0,void 0,!0,0,o),i.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._rtWrapper.is3D||this._rtWrapper.is2DArray){this._drawWrapper.effect?.setFloat("layer",s!==1?o/(s-1):0),this._drawWrapper.effect?.setInt("layerNum",o);for(let a in this._textures)this._drawWrapper.effect.setTexture(a,this._textures[a])}this.autoClear&&i.clear(t.clearColor,!0,!1,!1),i.drawElementsType(Re.TriangleFillMode,0,6),i.unBindFramebuffer(this._rtWrapper,!this._generateMipMaps)}}r&&i.setViewport(r),this.isCube&&i.generateMipMapsForCubemap(this._texture,!0),i._debugPopGroup?.(1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}clone(){let e=this.getSize(),t=new n(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t}dispose(){let e=this.getScene();if(!e)return;let t=e.proceduralTextures.indexOf(this);t>=0&&e.proceduralTextures.splice(t,1);let i=this._vertexBuffers[T.PositionKind];i&&(i.dispose(),this._vertexBuffers[T.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),super.dispose()}};w([B()],Oi.prototype,"isEnabled",void 0);w([B()],Oi.prototype,"autoClear",void 0);w([B()],Oi.prototype,"_generateMipMaps",void 0);w([B()],Oi.prototype,"_size",void 0);w([B()],Oi.prototype,"refreshRate",null);le("BABYLON.ProceduralTexture",Oi);var tD=(()=>{class n{get isSupported(){let t=ye.LastCreatedEngine;return t?t.getCaps().texelFetch:!1}get iblSource(){return this._iblSource}set iblSource(t){this._iblSource!==t&&(this._disposeTextures(),this._iblSource=t,t&&(t.isCube?t.isReadyOrNotBlocking()?this._recreateAssetsFromNewIbl():t.onLoadObservable.addOnce(this._recreateAssetsFromNewIbl.bind(this,t)):t.isReadyOrNotBlocking()?this._recreateAssetsFromNewIbl():t.onLoadObservable.addOnce(this._recreateAssetsFromNewIbl.bind(this,t))))}_recreateAssetsFromNewIbl(){this._debugPass&&this._debugPass.dispose(),this._createTextures(),this._debugPass&&this._createDebugPass()}getIcdfTexture(){return this._icdfPT?this._icdfPT:this._dummyTexture}setDebugDisplayParams(t,i,r,s){this._debugSizeParams.set(t,i,r,s)}get debugPassName(){return this._debugPassName}getDebugPassPP(){return this._debugPass||this._createDebugPass(),this._debugPass}constructor(t){if(this._cachedDominantDirection=null,this.debugEnabled=!1,this._debugSizeParams=new dt(0,0,1,1),this._debugPassName="CDF Debug",this.onGeneratedObservable=new F,t?n._IsScene(t)?this._scene=t:this._engine=t:this._scene=ye.LastCreatedScene,this._scene&&(this._engine=this._scene.getEngine()),!this.isSupported){P.Warn("CDF renderer is not supported by the current engine.");return}let i=new Uint16Array([0,0,0,255]);this._dummyTexture=new _i(i,1,1,di.TEXTUREFORMAT_RGBA,t,!1,!1,void 0,2),this._scene&&n._SceneComponentInitialization(this._scene)}_createTextures(){let t=this._iblSource?{width:this._iblSource.getSize().width,height:this._iblSource.getSize().height}:{width:1,height:1};this._iblSource||(this._iblSource=_i.CreateRTexture(new Uint8Array([255]),1,1,this._engine,!1,!1,1,0),this._iblSource.name="Placeholder IBL Source"),this._iblSource.isCube&&(t.width*=4,t.height*=2,t.width=1<<Math.floor(Math.log2(t.width)),t.height=1<<Math.floor(Math.log2(t.height)));let i=this._engine.isWebGPU,r={generateDepthBuffer:!1,generateMipMaps:!1,format:6,type:1,samplingMode:1,shaderLanguage:i?1:0,gammaSpace:!1,extraInitializationsAsync:()=>S(this,null,function*(){i?yield Promise.all([import("./chunk-V6HF3R5R.js"),import("./chunk-UCM4KK46.js"),import("./chunk-5UAGYI7V.js")]):yield Promise.all([import("./chunk-SKXMV3TQ.js"),import("./chunk-MWR3OPZG.js"),import("./chunk-HD7TPKO2.js")])})},s={generateDepthBuffer:!1,generateMipMaps:!1,format:5,type:2,samplingMode:1,shaderLanguage:i?1:0,gammaSpace:!1,extraInitializationsAsync:()=>S(this,null,function*(){i?yield Promise.all([import("./chunk-ZZIUWVKI.js"),import("./chunk-FDTNVJKJ.js")]):yield Promise.all([import("./chunk-AHSE56XH.js"),import("./chunk-62HKT4CP.js")])})};this._cdfyPT=new Oi("cdfyTexture",{width:t.width,height:t.height+1},"iblCdfy",this._scene,r,!1,!1),this._cdfyPT.autoClear=!1,this._cdfyPT.setTexture("iblSource",this._iblSource),this._cdfyPT.setInt("iblHeight",t.height),this._cdfyPT.wrapV=0,this._cdfyPT.refreshRate=0,this._iblSource.isCube&&(this._cdfyPT.defines=`#define IBL_USE_CUBE_MAP
`),this._cdfxPT=new Oi("cdfxTexture",{width:t.width+1,height:1},"iblCdfx",this._scene,r,!1,!1),this._cdfxPT.autoClear=!1,this._cdfxPT.setTexture("cdfy",this._cdfyPT),this._cdfxPT.refreshRate=0,this._cdfxPT.wrapU=0,this._scaledLuminancePT=new Oi("iblScaledLuminance",{width:t.width,height:t.height},"iblScaledLuminance",this._scene,lt(Y({},r),{samplingMode:3,generateMipMaps:!0}),!0,!1),this._scaledLuminancePT.autoClear=!1,this._scaledLuminancePT.setTexture("iblSource",this._iblSource),this._scaledLuminancePT.setInt("iblHeight",t.height),this._scaledLuminancePT.setInt("iblWidth",t.width),this._scaledLuminancePT.refreshRate=0,this._iblSource.isCube&&(this._scaledLuminancePT.defines=`#define IBL_USE_CUBE_MAP
`),this._icdfPT=new Oi("icdfTexture",{width:t.width,height:t.height},"iblIcdf",this._scene,s,!1,!1),this._icdfPT.autoClear=!1,this._icdfPT.setTexture("cdfy",this._cdfyPT),this._icdfPT.setTexture("cdfx",this._cdfxPT),this._icdfPT.setTexture("iblSource",this._iblSource),this._icdfPT.setTexture("scaledLuminanceSampler",this._scaledLuminancePT),this._icdfPT.refreshRate=0,this._icdfPT.wrapV=0,this._icdfPT.wrapU=0,this._iblSource.isCube&&(this._icdfPT.defines=`#define IBL_USE_CUBE_MAP
`),this._icdfPT.onGeneratedObservable.addOnce(()=>{this.onGeneratedObservable.notifyObservers()}),this._dominantDirectionPT=new Oi("iblDominantDirection",{width:1,height:1},"iblDominantDirection",this._scene,s,!1,!1),this._dominantDirectionPT.autoClear=!1,this._dominantDirectionPT.setTexture("icdfSampler",this._icdfPT),this._dominantDirectionPT.refreshRate=0,this._dominantDirectionPT.defines=`#define NUM_SAMPLES 32u
`}_disposeTextures(){this._cdfyPT?.dispose(),this._cdfxPT?.dispose(),this._icdfPT?.dispose(),this._scaledLuminancePT?.dispose(),this._dominantDirectionPT?.dispose()}_createDebugPass(){this._debugPass&&this._debugPass.dispose();let t=this._engine.isWebGPU,i={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),samplingMode:Z.BILINEAR_SAMPLINGMODE,engine:this._engine,textureType:0,uniforms:["sizeParams"],samplers:["cdfy","icdf","cdfx","iblSource"],defines:this._iblSource?.isCube?`#define IBL_USE_CUBE_MAP
`:"",shaderLanguage:t?1:0,extraInitializations:(s,o)=>{s?o.push(import("./chunk-ZZMYUWSB.js")):o.push(import("./chunk-GNHWGRHD.js"))}};this._debugPass=new yr(this._debugPassName,"iblCdfDebug",i);let r=this._debugPass.getEffect();r&&(r.defines=this._iblSource?.isCube?`#define IBL_USE_CUBE_MAP
`:""),this._iblSource?.isCube&&this._debugPass.updateEffect(`#define IBL_USE_CUBE_MAP
`),this._debugPass.onApplyObservable.add(s=>{s.setTexture("cdfy",this._cdfyPT),s.setTexture("icdf",this._icdfPT),s.setTexture("cdfx",this._cdfxPT),s.setTexture("iblSource",this._iblSource),s.setFloat4("sizeParams",this._debugSizeParams.x,this._debugSizeParams.y,this._debugSizeParams.z,this._debugSizeParams.w)})}isReady(){return this._iblSource&&this._iblSource.name!=="Placeholder IBL Source"&&this._iblSource.isReady()&&this._cdfyPT&&this._cdfyPT.isReady()&&this._icdfPT&&this._icdfPT.isReady()&&this._cdfxPT&&this._cdfxPT.isReady()&&this._scaledLuminancePT&&this._scaledLuminancePT.isReady()}renderWhenReady(){return this._cachedDominantDirection=null,new Promise((i,r)=>{Cc(()=>!!this._icdfPT,()=>i(void 0),()=>r(new Error("Waiting for _icdfPT creation failed")))}).then(()=>{this._icdfPT.onGeneratedObservable.addOnce(()=>{this.onGeneratedObservable.notifyObservers()});let i=[],r=[this._cdfyPT,this._cdfxPT,this._scaledLuminancePT,this._icdfPT];for(let s of r)i.push(new Promise(o=>{s.isReady()?o():s.getEffect().executeWhenCompiled(()=>{o()})}));return Promise.all(i).then(()=>{for(let s of r)s.render()})})}findDominantDirection(){return this._cachedDominantDirection?Promise.resolve(this._cachedDominantDirection):new Promise(t=>{this._dominantDirectionPT.onGeneratedObservable.addOnce(()=>{let i=new Float32Array(4);this._dominantDirectionPT.readPixels(0,0,i,!0).then(()=>{let r=new m(i[0],i[1],i[2]);this._cachedDominantDirection=r,t(r)})}),this.isReady()?this._dominantDirectionPT.isReady()?this._dominantDirectionPT.render():this._dominantDirectionPT.getEffect().executeWhenCompiled(()=>{this._dominantDirectionPT.render()}):this.onGeneratedObservable.addOnce(()=>{this._dominantDirectionPT.isReady()?this._dominantDirectionPT.render():this._dominantDirectionPT.getEffect().executeWhenCompiled(()=>{this._dominantDirectionPT.render()})})})}dispose(){this._disposeTextures(),this._dummyTexture.dispose(),this._debugPass&&this._debugPass.dispose(),this.onGeneratedObservable.clear()}static _IsScene(t){return t.getClassName()==="Scene"}}return n._SceneComponentInitialization=e=>{throw Zt("IblCdfGeneratorSceneComponentSceneComponent")},n})();var tg=class{constructor(e,t={}){this.quality=4096,this.hdrScale=1,this.useCdf=!1,this._engine=e,this.hdrScale=t.hdrScale||this.hdrScale,this.quality=t.quality||this.quality,this.useCdf=t.useCdf||this.useCdf}_createRenderTarget(e){let t=0;this._engine.getCaps().textureHalfFloatRender?t=2:this._engine.getCaps().textureFloatRender&&(t=1);let i=this._engine.createRenderTargetCubeTexture(e,{format:5,type:t,createMipMaps:!1,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:2,label:"HDR_Irradiance_Filtering_Target"});return this._engine.updateTextureWrappingMode(i.texture,0,0,0),i}_prefilterInternal(e){let t=e.getSize().width,i=Tc(t),r=this._effectWrapper.effect,s=Math.max(32,1<<Tc(t>>3)),o=this._createRenderTarget(s);this._effectRenderer.saveStates(),this._effectRenderer.setViewport(),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let a=[[new m(0,0,-1),new m(0,-1,0),new m(1,0,0)],[new m(0,0,1),new m(0,-1,0),new m(-1,0,0)],[new m(1,0,0),new m(0,0,1),new m(0,1,0)],[new m(1,0,0),new m(0,0,-1),new m(0,-1,0)],[new m(1,0,0),new m(0,-1,0),new m(0,0,1)],[new m(-1,0,0),new m(0,-1,0),new m(0,0,-1)]];r.setFloat("hdrScale",this.hdrScale),r.setFloat2("vFilteringInfo",e.getSize().width,i),r.setTexture("inputTexture",e),this._cdfGenerator&&r.setTexture("icdfTexture",this._cdfGenerator.getIcdfTexture());for(let c=0;c<6;c++)r.setVector3("up",a[c][0]),r.setVector3("right",a[c][1]),r.setVector3("front",a[c][2]),this._engine.bindFramebuffer(o,c,void 0,void 0,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper),this._effectRenderer.draw();this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),r.setTexture("inputTexture",null),r.setTexture("icdfTexture",null);let l=new _r(e.getScene(),o.texture);return l.name=e.name+"_irradiance",l.displayName=e.name+"_irradiance",l.gammaSpace=!1,l}_createEffect(e,t){let i=[];e.gammaSpace&&i.push("#define GAMMA_INPUT"),i.push("#define NUM_SAMPLES "+this.quality+"u");let r=this._engine.isWebGPU,s=["inputTexture"];return this._cdfGenerator&&(s.push("icdfTexture"),i.push("#define IBL_CDF_FILTERING")),new Ic({engine:this._engine,name:"HDRIrradianceFiltering",vertexShader:"hdrIrradianceFiltering",fragmentShader:"hdrIrradianceFiltering",samplerNames:s,uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale"],useShaderStore:!0,defines:i,onCompiled:t,shaderLanguage:r?1:0,extraInitializationsAsync:()=>S(this,null,function*(){r?yield Promise.all([import("./chunk-ZKOVZTXT.js"),import("./chunk-ZP3VQY2Y.js")]):yield Promise.all([import("./chunk-ED5YMWIJ.js"),import("./chunk-QUZL4AUJ.js")])})})}isReady(e){return e.isReady()&&this._effectWrapper.effect.isReady()}prefilter(e){return S(this,null,function*(){if(!this._engine._features.allowTexturePrefiltering)throw new Error("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead.");this.useCdf&&(this._cdfGenerator=new tD(this._engine),this._cdfGenerator.iblSource=e,yield this._cdfGenerator.renderWhenReady()),this._effectRenderer=new Oh(this._engine),this._effectWrapper=this._createEffect(e),yield this._effectWrapper.effect.whenCompiledAsync();let t=this._prefilterInternal(e);return this.useCdf&&(yield this._cdfGenerator.findDominantDirection().then(i=>{t._dominantDirection=i})),this._effectRenderer.dispose(),this._effectWrapper.dispose(),this._cdfGenerator?.dispose(),t})}};var iD=(()=>{class n extends _r{set isBlocking(t){this._isBlocking=t}get isBlocking(){return this._isBlocking}set rotationY(t){this._rotationY=t,this.setReflectionTextureMatrix(L.RotationY(this._rotationY))}get rotationY(){return this._rotationY}set boundingBoxSize(t){if(this._boundingBoxSize&&this._boundingBoxSize.equals(t))return;this._boundingBoxSize=t;let i=this.getScene();i&&i.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}constructor(t,i,r,s=!1,o=!0,a=!1,l=!1,c=null,u=null,h=!1,d=!1,f=!1){super(i),this._generateHarmonics=!0,this._onError=null,this._isBlocking=!0,this._rotationY=0,this.boundingBoxPosition=m.Zero(),this.onLoadObservable=new F,t&&(this._coordinatesMode=Z.CUBIC_MODE,this.name=t,this.url=t,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=L.Identity(),this._prefilterOnLoad=l,this._prefilterIrradianceOnLoad=d,this._prefilterUsingCdf=f,this._onLoad=()=>{this.onLoadObservable.notifyObservers(this),c&&c()},this._onError=u,this.gammaSpace=a,this._noMipmap=s,this._size=r,this._supersample=h||f,this._generateHarmonics=o,this._texture=this._getFromCache(t,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?this._texture.isReady?z.SetImmediate(()=>this._onLoad()):this._texture.onLoadedObservable.add(this._onLoad):this.getScene()?.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture())}getClassName(){return"EnvCubeTexture"}_loadTexture(){let t=this._getEngine(),i=t.getCaps(),r=0;i.textureFloat&&i.textureFloatLinearFiltering?r=1:i.textureHalfFloat&&i.textureHalfFloatLinearFiltering&&(r=2);let s=o=>S(this,null,function*(){this.lodGenerationOffset=0,this.lodGenerationScale=.8;let a=yield this._getCubeMapTextureDataAsync(o,this._size,this._supersample);if(this._generateHarmonics){let h=kT.ConvertCubeMapToSphericalPolynomial(a);this.sphericalPolynomial=h}let l=[],c=null,u=null;for(let h=0;h<6;h++){r===2?u=new Uint16Array(this._size*this._size*3):r===0&&(c=new Uint8Array(this._size*this._size*3));let d=a[n._FacesMapping[h]];if(this.gammaSpace||u||c){for(let f=0;f<this._size*this._size;f++)if(this.gammaSpace&&(d[f*3+0]=Math.pow(d[f*3+0],Dh),d[f*3+1]=Math.pow(d[f*3+1],Dh),d[f*3+2]=Math.pow(d[f*3+2],Dh)),u&&(u[f*3+0]=Nh(d[f*3+0]),u[f*3+1]=Nh(d[f*3+1]),u[f*3+2]=Nh(d[f*3+2])),c){let p=Math.max(d[f*3+0]*255,0),g=Math.max(d[f*3+1]*255,0),_=Math.max(d[f*3+2]*255,0),y=Math.max(Math.max(p,g),_);if(y>255){let b=255/y;p*=b,g*=b,_*=b}c[f*3+0]=p,c[f*3+1]=g,c[f*3+2]=_}}u?l.push(u):c?l.push(c):l.push(d)}return l});if(t._features.allowTexturePrefiltering&&(this._prefilterOnLoad||this._prefilterIrradianceOnLoad)){let o=this._onLoad,a=new Jm(t);this._onLoad=()=>{let l=Promise.resolve(null),c=Promise.resolve();this._prefilterIrradianceOnLoad&&(l=new tg(t,{useCdf:this._prefilterUsingCdf}).prefilter(this)),this._prefilterOnLoad&&(c=a.prefilter(this)),Promise.all([l,c]).then(u=>{let h=u[0];if(this._prefilterIrradianceOnLoad&&h){this.irradianceTexture=h;let d=this.getScene();d&&d.markAllMaterialsAsDirty(1)}o&&o()})}}this._texture=t.createRawCubeTextureFromUrl(this.url,this.getScene(),this._size,4,r,this._noMipmap,s,null,this._onLoad,this._onError)}delayLoad(){this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this._loadTexture())}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(t){this._textureMatrix=t,t.updateFlag!==this._textureMatrix.updateFlag&&t.isIdentity()!==this._textureMatrix.isIdentity()&&this.getScene()?.markAllMaterialsAsDirty(1,i=>i.getActiveTextures().indexOf(this)!==-1)}dispose(){this.onLoadObservable.clear(),super.dispose()}serialize(){if(!this.name)return null;let t={};return t.name=this.name,t.hasAlpha=this.hasAlpha,t.isCube=!0,t.level=this.level,t.size=this._size,t.coordinatesMode=this.coordinatesMode,t.useInGammaSpace=this.gammaSpace,t.generateHarmonics=this._generateHarmonics,t.noMipmap=this._noMipmap,t.isBlocking=this._isBlocking,t.rotationY=this._rotationY,t}clone(){let t=this._instantiateClone();return t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t.coordinatesIndex=this.coordinatesIndex,t.coordinatesMode=this.coordinatesMode,t}static _Parse(t,i){i.name=t.name,i.hasAlpha=t.hasAlpha,i.level=t.level,i.coordinatesMode=t.coordinatesMode,i.isBlocking=t.isBlocking,t.boundingBoxPosition&&(i.boundingBoxPosition=m.FromArray(t.boundingBoxPosition)),t.boundingBoxSize&&(i.boundingBoxSize=m.FromArray(t.boundingBoxSize)),t.rotationY&&(i.rotationY=t.rotationY)}}return n._FacesMapping=["right","left","up","down","front","back"],n})();var ih=class n extends iD{constructor(e,t,i,r=!1,s=!0,o=!1,a=!1,l=null,c=null,u=!1,h=!1,d=!1){super(e,t,i,r,s,o,a,l,c,u,h,d)}getClassName(){return"HDRCubeTexture"}_getCubeMapTextureDataAsync(e,t,i){return S(this,null,function*(){return a0(e,t,i)})}_instantiateClone(){return new n(this.url,this.getScene()||this._getEngine(),this._size,this._noMipmap,this._generateHarmonics,this.gammaSpace)}serialize(){let e=super.serialize();return e?(e.customType="BABYLON.HDRCubeTexture",e):null}static Parse(e,t,i){if(!e.name||e.isRenderTarget)return null;let r=new n(i+e.name,t,e.size,e.noMipmap,e.generateHarmonics,e.useInGammaSpace);return this._Parse(e,r),r}};le("BABYLON.HDRCubeTexture",ih);var bt=(()=>{class n{constructor(t,i){this.triggerOptions=t,this.onBeforeExecuteObservable=new F,t.parameter?(this.trigger=t.trigger,this._triggerParameter=t.parameter):t.trigger?this.trigger=t.trigger:this.trigger=t,this._nextActiveAction=this,this._condition=i}_prepare(){}getTriggerParameter(){return this._triggerParameter}setTriggerParameter(t){this._triggerParameter=t}_evaluateConditionForCurrentFrame(){let t=this._condition;if(!t)return!0;let i=this._actionManager.getScene().getRenderId();return t._evaluationId!==i&&(t._evaluationId=i,t._currentResult=t.isValid()),t._currentResult}_executeCurrent(t){this._evaluateConditionForCurrentFrame()&&(this.onBeforeExecuteObservable.notifyObservers(this),this._nextActiveAction.execute(t),this.skipToNextActiveAction())}execute(t){}skipToNextActiveAction(){this._nextActiveAction._child?(this._nextActiveAction._child._actionManager||(this._nextActiveAction._child._actionManager=this._actionManager),this._nextActiveAction=this._nextActiveAction._child):this._nextActiveAction=this}then(t){return this._child=t,t._actionManager=this._actionManager,t._prepare(),t}_getProperty(t){return this._actionManager._getProperty(t)}_getEffectiveTarget(t,i){return this._actionManager._getEffectiveTarget(t,i)}serialize(t){return null}_serialize(t,i){let r={type:1,children:[],name:t.name,properties:t.properties||[]};if(this._child&&this._child.serialize(r),this._condition){let s=this._condition.serialize();return s.children.push(r),i&&i.children.push(s),s}return i&&i.children.push(r),r}}return n._SerializeValueAsString=e=>typeof e=="number"?e.toString():typeof e=="boolean"?e?"true":"false":e instanceof me?e.x+", "+e.y:e instanceof m?e.x+", "+e.y+", "+e.z:e instanceof U?e.r+", "+e.g+", "+e.b:e instanceof ce?e.r+", "+e.g+", "+e.b+", "+e.a:e,n._GetTargetProperty=e=>({name:"target",targetType:e._isMesh?"MeshProperties":e._isLight?"LightProperties":e._isCamera?"CameraProperties":e._isMaterial?"MaterialProperties":"SceneProperties",value:e._isScene?"Scene":e.name}),n})();le("BABYLON.Action",bt);var Zs=class{constructor(e){this._actionManager=e}isValid(){return!0}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(){}_serialize(e){return{type:2,children:[],name:e.name,properties:e.properties}}},PC=(()=>{class n extends Zs{static get IsEqual(){return n._IsEqual}static get IsDifferent(){return n._IsDifferent}static get IsGreater(){return n._IsGreater}static get IsLesser(){return n._IsLesser}constructor(t,i,r,s,o=n.IsEqual){super(t),this.propertyPath=r,this.value=s,this.operator=o,this._target=i,this._effectiveTarget=this._getEffectiveTarget(i,this.propertyPath),this._property=this._getProperty(this.propertyPath)}isValid(){switch(this.operator){case n.IsGreater:return this._effectiveTarget[this._property]>this.value;case n.IsLesser:return this._effectiveTarget[this._property]<this.value;case n.IsEqual:case n.IsDifferent:{let t;return this.value.equals?t=this.value.equals(this._effectiveTarget[this._property]):t=this.value===this._effectiveTarget[this._property],this.operator===n.IsEqual?t:!t}}return!1}serialize(){return this._serialize({name:"ValueCondition",properties:[bt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:bt._SerializeValueAsString(this.value)},{name:"operator",value:n.GetOperatorName(this.operator)}]})}static GetOperatorName(t){switch(t){case n._IsEqual:return"IsEqual";case n._IsDifferent:return"IsDifferent";case n._IsGreater:return"IsGreater";case n._IsLesser:return"IsLesser";default:return""}}}return n._IsEqual=0,n._IsDifferent=1,n._IsGreater=2,n._IsLesser=3,n})(),DC=class extends Zs{constructor(e,t){super(e),this.predicate=t}isValid(){return this.predicate()}},RC=class extends Zs{constructor(e,t,i){super(e),this.value=i,this._target=t}isValid(){return this._target.state===this.value}serialize(){return this._serialize({name:"StateCondition",properties:[bt._GetTargetProperty(this._target),{name:"value",value:this.value}]})}};le("BABYLON.ValueCondition",PC);le("BABYLON.PredicateCondition",DC);le("BABYLON.StateCondition",RC);var OC=class extends bt{constructor(e,t,i,r){super(e,r),this.propertyPath=i,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]}serialize(e){return super._serialize({name:"SwitchBooleanAction",properties:[bt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath}]},e)}},NC=class extends bt{constructor(e,t,i,r){super(e,r),this.value=i,this._target=t}execute(){this._target.state=this.value}serialize(e){return super._serialize({name:"SetStateAction",properties:[bt._GetTargetProperty(this._target),{name:"value",value:this.value}]},e)}},FC=class extends bt{constructor(e,t,i,r,s){super(e,s),this.propertyPath=i,this.value=r,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"SetValueAction",properties:[bt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:bt._SerializeValueAsString(this.value)}]},e)}},LC=class extends bt{constructor(e,t,i,r,s){super(e,s),this.propertyPath=i,this.value=r,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath),typeof this._effectiveTarget[this._property]!="number"&&P.Warn("Warning: IncrementValueAction can only be used with number values")}execute(){this._effectiveTarget[this._property]+=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"IncrementValueAction",properties:[bt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:bt._SerializeValueAsString(this.value)}]},e)}},BC=class extends bt{constructor(e,t,i,r,s,o){super(e,o),this.from=i,this.to=r,this.loop=s,this._target=t}_prepare(){}execute(){this._actionManager.getScene().beginAnimation(this._target,this.from,this.to,this.loop)}serialize(e){return super._serialize({name:"PlayAnimationAction",properties:[bt._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:bt._SerializeValueAsString(this.loop)||!1}]},e)}},kC=class extends bt{constructor(e,t,i){super(e,i),this._target=t}_prepare(){}execute(){this._actionManager.getScene().stopAnimation(this._target)}serialize(e){return super._serialize({name:"StopAnimationAction",properties:[bt._GetTargetProperty(this._target)]},e)}},nh=class extends bt{constructor(e=0,t){super(e,t)}execute(){}serialize(e){return super._serialize({name:"DoNothingAction",properties:[]},e)}},VC=class extends bt{constructor(e,t,i,r=!0){super(e,i),this.children=t,this.enableChildrenConditions=r}_prepare(){for(let e=0;e<this.children.length;e++)this.children[e]._actionManager=this._actionManager,this.children[e]._prepare()}execute(e){for(let t of this.children)(!this.enableChildrenConditions||t._evaluateConditionForCurrentFrame())&&t.execute(e)}serialize(e){let t=super._serialize({name:"CombineAction",properties:[],combine:[]},e);for(let i=0;i<this.children.length;i++)t.combine.push(this.children[i].serialize(null));return t}},ia=class extends bt{constructor(e,t,i){super(e,i),this.func=t}execute(e){this.func(e)}},ig=class extends bt{constructor(e,t,i,r){super(e,r),this._target=t,this._parent=i}_prepare(){}execute(){if(this._target.parent===this._parent)return;let e=this._parent.getWorldMatrix().clone();e.invert(),this._target.position=m.TransformCoordinates(this._target.position,e),this._target.parent=this._parent}serialize(e){return super._serialize({name:"SetParentAction",properties:[bt._GetTargetProperty(this._target),bt._GetTargetProperty(this._parent)]},e)}};le("BABYLON.SetParentAction",ig);le("BABYLON.ExecuteCodeAction",ia);le("BABYLON.DoNothingAction",nh);le("BABYLON.StopAnimationAction",kC);le("BABYLON.PlayAnimationAction",BC);le("BABYLON.IncrementValueAction",LC);le("BABYLON.SetValueAction",FC);le("BABYLON.SetStateAction",NC);le("BABYLON.SetParentAction",ig);le("BABYLON.SwitchBooleanAction",OC);le("BABYLON.CombineAction",VC);var xs=(()=>{class n extends ZT{constructor(t){super(),t=t||ye.LastCreatedScene,t&&(this._scene=t,t.actionManagers.push(this))}dispose(){let t=this._scene.actionManagers.indexOf(this);for(let r=0;r<this.actions.length;r++){let s=this.actions[r];n.Triggers[s.trigger]--,n.Triggers[s.trigger]===0&&delete n.Triggers[s.trigger]}this.actions.length=0,t>-1&&this._scene.actionManagers.splice(t,1);let i=this._scene.meshes.filter(r=>r.actionManager===this);for(let r of i)r.actionManager=null}getScene(){return this._scene}hasSpecificTriggers(t){for(let i=0;i<this.actions.length;i++){let r=this.actions[i];if(t.indexOf(r.trigger)>-1)return!0}return!1}hasSpecificTriggers2(t,i){for(let r=0;r<this.actions.length;r++){let s=this.actions[r];if(t==s.trigger||i==s.trigger)return!0}return!1}hasSpecificTrigger(t,i){for(let r=0;r<this.actions.length;r++){let s=this.actions[r];if(s.trigger===t)if(i){if(i(s.getTriggerParameter()))return!0}else return!0}return!1}get hasPointerTriggers(){for(let t=0;t<this.actions.length;t++){let i=this.actions[t];if(i.trigger>=n.OnPickTrigger&&i.trigger<=n.OnPointerOutTrigger&&i._evaluateConditionForCurrentFrame())return!0}return!1}get hasPickTriggers(){for(let t=0;t<this.actions.length;t++){let i=this.actions[t];if(i.trigger>=n.OnPickTrigger&&i.trigger<=n.OnPickUpTrigger&&i._evaluateConditionForCurrentFrame())return!0}return!1}registerAction(t){return t.trigger===n.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(P.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(t),this.getScene()._registeredActions++,n.Triggers[t.trigger]?n.Triggers[t.trigger]++:n.Triggers[t.trigger]=1,t._actionManager=this,t._prepare(),t)}unregisterAction(t){let i=this.actions.indexOf(t);return i!==-1?(this.actions.splice(i,1),n.Triggers[t.trigger]-=1,n.Triggers[t.trigger]===0&&delete n.Triggers[t.trigger],t._actionManager=null,this.getScene()._registeredActions--,!0):!1}processTrigger(t,i){for(let r=0;r<this.actions.length;r++){let s=this.actions[r];if(s.trigger===t){if(i&&(t===n.OnKeyUpTrigger||t===n.OnKeyDownTrigger)){let o=s.getTriggerParameter();if(typeof o=="function"){if(!o(i))continue}else if(o&&o!==i.sourceEvent.keyCode){if(!o.toLowerCase)continue;let a=o.toLowerCase();if(a!==i.sourceEvent.key){let l=i.sourceEvent.charCode?i.sourceEvent.charCode:i.sourceEvent.keyCode;if(String.fromCharCode(l).toLowerCase()!==a)continue}}}s._executeCurrent(i)}}}_getEffectiveTarget(t,i){let r=i.split(".");for(let s=0;s<r.length-1;s++)t=t[r[s]];return t}_getProperty(t){let i=t.split(".");return i[i.length-1]}serialize(t){let i={children:[],name:t,type:3,properties:[]};for(let r=0;r<this.actions.length;r++){let s={type:0,children:[],name:n.GetTriggerName(this.actions[r].trigger),properties:[]},o=this.actions[r].triggerOptions;if(o&&typeof o!="number")if(o.parameter instanceof Node)s.properties.push(bt._GetTargetProperty(o.parameter));else if(typeof o.parameter=="object"){let a={};Tt.DeepCopy(o.parameter,a,["mesh"]),o.parameter&&o.parameter.mesh&&(a._meshId=o.parameter.mesh.id),s.properties.push({name:"parameter",targetType:null,value:a})}else s.properties.push({name:"parameter",targetType:null,value:o.parameter});this.actions[r].serialize(s),i.children.push(s)}return i}static Parse(t,i,r){let s=new n(r);i===null?r.actionManager=s:i.actionManager=s;let o=(c,u)=>{let h=vt("BABYLON."+c);return h&&new h(...u)},a=(c,u,h,d)=>{if(d===null){let _=parseFloat(u);return u==="true"||u==="false"?u==="true":isNaN(_)?u:_}let f=d.split("."),p=u.split(",");for(let _=0;_<f.length;_++)h=h[f[_]];if(typeof h=="boolean")return p[0]==="true";if(typeof h=="string")return p[0];let g=[];for(let _=0;_<p.length;_++)g.push(parseFloat(p[_]));return h instanceof m?m.FromArray(g):h instanceof dt?dt.FromArray(g):h instanceof U?U.FromArray(g):h instanceof ce?ce.FromArray(g):parseFloat(p[0])},l=(c,u,h,d,f=null)=>{if(c.detached)return;let p=[],g=null,_=null,y=c.combine&&c.combine.length>0;if(c.type===2?p.push(s):p.push(u),y){let A=[];for(let I=0;I<c.combine.length;I++)l(c.combine[I],n.NothingTrigger,h,d,A);p.push(A)}else for(let A=0;A<c.properties.length;A++){let I=c.properties[A].value,v=c.properties[A].name,x=c.properties[A].targetType;v==="target"?x==="SceneProperties"?I=g=r:x==="MaterialProperties"?I=g=r.getMaterialByName(I):I=g=r.getNodeByName(I):v==="parent"?I=r.getNodeByName(I):v==="sound"?r.getSoundByName&&(I=r.getSoundByName(I)):v!=="propertyPath"?c.type===2&&v==="operator"?I=PC[I]:I=a(v,I,g,v==="value"?_:null):_=I,p.push(I)}if(f===null?p.push(h):p.push(null),c.name==="InterpolateValueAction"){let A=p[p.length-2];p[p.length-1]=A,p[p.length-2]=h}let b=o(c.name,p);if(b instanceof Zs&&h!==null){let A=new nh(u,h);d?d.then(A):s.registerAction(A),d=A}f===null?b instanceof Zs?(h=b,b=d):(h=null,d?d.then(b):s.registerAction(b)):f.push(b);for(let A=0;A<c.children.length;A++)l(c.children[A],u,h,b,null)};for(let c=0;c<t.children.length;c++){let u,h=t.children[c];if(h.properties.length>0){let d=h.properties[0].value,f=h.properties[0].targetType===null?d:r.getMeshByName(d);f._meshId&&(f.mesh=r.getMeshById(f._meshId)),u={trigger:n[h.name],parameter:f}}else u=n[h.name];for(let d=0;d<h.children.length;d++)h.detached||l(h.children[d],u,null,null)}}static GetTriggerName(t){switch(t){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnDoublePickTrigger";case 7:return"OnPickUpTrigger";case 8:return"OnLongPressTrigger";case 9:return"OnPointerOverTrigger";case 10:return"OnPointerOutTrigger";case 11:return"OnEveryFrameTrigger";case 12:return"OnIntersectionEnterTrigger";case 13:return"OnIntersectionExitTrigger";case 14:return"OnKeyDownTrigger";case 15:return"OnKeyUpTrigger";case 16:return"OnPickOutTrigger";default:return""}}}return n.NothingTrigger=0,n.OnPickTrigger=1,n.OnLeftPickTrigger=2,n.OnRightPickTrigger=3,n.OnCenterPickTrigger=4,n.OnPickDownTrigger=5,n.OnDoublePickTrigger=6,n.OnPickUpTrigger=7,n.OnPickOutTrigger=16,n.OnLongPressTrigger=8,n.OnPointerOverTrigger=9,n.OnPointerOutTrigger=10,n.OnEveryFrameTrigger=11,n.OnIntersectionEnterTrigger=12,n.OnIntersectionExitTrigger=13,n.OnKeyDownTrigger=14,n.OnKeyUpTrigger=15,n})();var Ze=class{constructor(e,t){this.type=e,this.jointData=t,t.nativeParams=t.nativeParams||{}}get physicsJoint(){return this._physicsJoint}set physicsJoint(e){this._physicsJoint=e}set physicsPlugin(e){this._physicsPlugin=e}executeNativeFunction(e){e(this._physicsPlugin.world,this._physicsJoint)}};Ze.DistanceJoint=0;Ze.HingeJoint=1;Ze.BallAndSocketJoint=2;Ze.WheelJoint=3;Ze.SliderJoint=4;Ze.PrismaticJoint=5;Ze.UniversalJoint=6;Ze.Hinge2Joint=Ze.WheelJoint;Ze.PointToPointJoint=8;Ze.SpringJoint=9;Ze.LockJoint=10;E._PhysicsImpostorParser=function(n,e,t){return new Te(e,t.physicsImpostor,{mass:t.physicsMass,friction:t.physicsFriction,restitution:t.physicsRestitution},n)};var Te=class n{get isDisposed(){return this._isDisposed}get mass(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0}set mass(e){this.setMass(e)}get friction(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0}set friction(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,e)}get restitution(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0}set restitution(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,e)}get pressure(){if(!this._physicsEngine)return 0;let e=this._physicsEngine.getPhysicsPlugin();return e.setBodyPressure?e.getBodyPressure(this):0}set pressure(e){if(!this._physicsEngine)return;let t=this._physicsEngine.getPhysicsPlugin();t.setBodyPressure&&t.setBodyPressure(this,e)}get stiffness(){if(!this._physicsEngine)return 0;let e=this._physicsEngine.getPhysicsPlugin();return e.getBodyStiffness?e.getBodyStiffness(this):0}set stiffness(e){if(!this._physicsEngine)return;let t=this._physicsEngine.getPhysicsPlugin();t.setBodyStiffness&&t.setBodyStiffness(this,e)}get velocityIterations(){if(!this._physicsEngine)return 0;let e=this._physicsEngine.getPhysicsPlugin();return e.getBodyVelocityIterations?e.getBodyVelocityIterations(this):0}set velocityIterations(e){if(!this._physicsEngine)return;let t=this._physicsEngine.getPhysicsPlugin();t.setBodyVelocityIterations&&t.setBodyVelocityIterations(this,e)}get positionIterations(){if(!this._physicsEngine)return 0;let e=this._physicsEngine.getPhysicsPlugin();return e.getBodyPositionIterations?e.getBodyPositionIterations(this):0}set positionIterations(e){if(!this._physicsEngine)return;let t=this._physicsEngine.getPhysicsPlugin();t.setBodyPositionIterations&&t.setBodyPositionIterations(this,e)}constructor(e,t,i={mass:0},r){if(this.object=e,this.type=t,this._options=i,this._scene=r,this._pluginData={},this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=new Array,this._onAfterPhysicsStepCallbacks=new Array,this._onPhysicsCollideCallbacks=[],this._deltaPosition=m.Zero(),this._isDisposed=!1,this.soft=!1,this.segments=0,this._tmpQuat=new Q,this._tmpQuat2=new Q,this.beforeStep=()=>{if(this._physicsEngine){this.object.translate(this._deltaPosition,-1),this._deltaRotationConjugated&&this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotationConjugated,this.object.rotationQuaternion),this.object.computeWorldMatrix(!1),this.object.parent&&this.object.rotationQuaternion?(this.getParentsRotation(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this._tmpQuat)):this._tmpQuat.copyFrom(this.object.rotationQuaternion||new Q),this._options.disableBidirectionalTransformation||this.object.rotationQuaternion&&this._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(this,this.object.getAbsolutePosition(),this._tmpQuat);for(let s of this._onBeforePhysicsStepCallbacks)s(this)}},this.afterStep=()=>{if(this._physicsEngine){for(let s of this._onAfterPhysicsStepCallbacks)s(this);this._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(this),this.object.parent&&this.object.rotationQuaternion&&(this.getParentsRotation(),this._tmpQuat.conjugateInPlace(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this.object.rotationQuaternion)),this.object.setAbsolutePosition(this.object.position),this._deltaRotation?(this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotation,this.object.rotationQuaternion),this._deltaPosition.applyRotationQuaternionToRef(this._deltaRotation,n._TmpVecs[0]),this.object.translate(n._TmpVecs[0],1)):this.object.translate(this._deltaPosition,1),this.object.computeWorldMatrix(!0)}},this.onCollideEvent=null,this.onCollide=s=>{if(!this._onPhysicsCollideCallbacks.length&&!this.onCollideEvent||!this._physicsEngine)return;let o=this._physicsEngine.getImpostorWithPhysicsBody(s.body);if(o){this.onCollideEvent&&this.onCollideEvent(this,o);let a=this._onPhysicsCollideCallbacks.filter(l=>l.otherImpostors.indexOf(o)!==-1);for(let l of a)l.callback(this,o,s.point,s.distance,s.impulse,s.normal)}},!this.object){P.Error("No object was provided. A physics object is obligatory");return}this.object.parent&&i.mass!==0&&P.Warn("A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),this._scene&&(this.type>100&&(this.soft=!0),this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=Q.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new Q),this._options.mass=i.mass===void 0?0:i.mass,this._options.friction=i.friction===void 0?.2:i.friction,this._options.restitution=i.restitution===void 0?.2:i.restitution,this.soft&&(this._options.mass=this._options.mass>0?this._options.mass:1,this._options.pressure=i.pressure===void 0?200:i.pressure,this._options.stiffness=i.stiffness===void 0?1:i.stiffness,this._options.velocityIterations=i.velocityIterations===void 0?20:i.velocityIterations,this._options.positionIterations=i.positionIterations===void 0?20:i.positionIterations,this._options.fixedPoints=i.fixedPoints===void 0?0:i.fixedPoints,this._options.margin=i.margin===void 0?0:i.margin,this._options.damping=i.damping===void 0?0:i.damping,this._options.path=i.path===void 0?null:i.path,this._options.shape=i.shape===void 0?null:i.shape),this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&P.Warn("You must affect impostors to children before affecting impostor to parent.")):P.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))}_init(){this._physicsEngine&&(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),!this._isDisposed&&(!this.parent||this._options.ignoreParent)&&this._physicsEngine.addImpostor(this))}_getPhysicsParent(){return this.object.parent instanceof _n?this.object.parent.physicsImpostor:null}isBodyInitRequired(){return this._bodyUpdateRequired||!this._physicsBody&&(!this._parent||!!this._options.ignoreParent)}setScalingUpdated(){this.forceUpdate()}forceUpdate(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()}get physicsBody(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody}get parent(){return!this._options.ignoreParent&&this._parent?this._parent:null}set parent(e){this._parent=e}set physicsBody(e){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=e,this.resetUpdateFlags()}resetUpdateFlags(){this._bodyUpdateRequired=!1}getObjectExtents(){if(this.object.getBoundingInfo){let e=this.object.rotationQuaternion,t=this.object.scaling.clone();this.object.rotationQuaternion=n.IDENTITY_QUATERNION;let i=this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);i&&i.decompose(t,void 0,void 0);let s=this.object.getBoundingInfo().boundingBox.extendSize.scale(2).multiplyInPlace(t);return s.x=Math.abs(s.x),s.y=Math.abs(s.y),s.z=Math.abs(s.z),this.object.rotationQuaternion=e,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),s}else return n.DEFAULT_OBJECT_SIZE}getObjectCenter(){return this.object.getBoundingInfo?this.object.getBoundingInfo().boundingBox.centerWorld:this.object.position}getParam(e){return this._options[e]}setParam(e,t){this._options[e]=t,this._bodyUpdateRequired=!0}setMass(e){this.getParam("mass")!==e&&this.setParam("mass",e),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,e)}getLinearVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):m.Zero()}setLinearVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,e)}getAngularVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):m.Zero()}setAngularVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,e)}executeNativeFunction(e){this._physicsEngine&&e(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)}registerBeforePhysicsStep(e){this._onBeforePhysicsStepCallbacks.push(e)}unregisterBeforePhysicsStep(e){let t=this._onBeforePhysicsStepCallbacks.indexOf(e);t>-1?this._onBeforePhysicsStepCallbacks.splice(t,1):P.Warn("Function to remove was not found")}registerAfterPhysicsStep(e){this._onAfterPhysicsStepCallbacks.push(e)}unregisterAfterPhysicsStep(e){let t=this._onAfterPhysicsStepCallbacks.indexOf(e);t>-1?this._onAfterPhysicsStepCallbacks.splice(t,1):P.Warn("Function to remove was not found")}registerOnPhysicsCollide(e,t){let i=e instanceof Array?e:[e];this._onPhysicsCollideCallbacks.push({callback:t,otherImpostors:i})}unregisterOnPhysicsCollide(e,t){let i=e instanceof Array?e:[e],r=-1;this._onPhysicsCollideCallbacks.some((o,a)=>{if(o.callback===t&&o.otherImpostors.length===i.length){let l=o.otherImpostors.every(c=>i.indexOf(c)>-1);return l&&(r=a),l}return!1})?this._onPhysicsCollideCallbacks.splice(r,1):P.Warn("Function to remove was not found")}getParentsRotation(){let e=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);e;)e.rotationQuaternion?this._tmpQuat2.copyFrom(e.rotationQuaternion):Q.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),e=e.parent;return this._tmpQuat}applyForce(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,e,t),this}applyImpulse(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,e,t),this}createJoint(e,t,i){let r=new Ze(t,i);return this.addJoint(e,r),this}addJoint(e,t){return this._joints.push({otherImpostor:e,joint:t}),this._physicsEngine&&this._physicsEngine.addJoint(this,e,t),this}addAnchor(e,t,i,r,s){if(!this._physicsEngine)return this;let o=this._physicsEngine.getPhysicsPlugin();return o.appendAnchor?(this._physicsEngine&&o.appendAnchor(this,e,t,i,r,s),this):this}addHook(e,t,i,r){if(!this._physicsEngine)return this;let s=this._physicsEngine.getPhysicsPlugin();return s.appendAnchor?(this._physicsEngine&&s.appendHook(this,e,t,i,r),this):this}sleep(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this}wakeUp(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this}clone(e){return e?new n(e,this.type,this._options,this._scene):null}dispose(){if(this._physicsEngine){for(let e of this._joints)this._physicsEngine&&this._physicsEngine.removeJoint(this,e.otherImpostor,e.joint);this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0}}setDeltaPosition(e){this._deltaPosition.copyFrom(e)}setDeltaRotation(e){this._deltaRotation||(this._deltaRotation=new Q),this._deltaRotation.copyFrom(e),this._deltaRotationConjugated=this._deltaRotation.conjugate()}getBoxSizeToRef(e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,e),this}getRadius(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0}syncBoneWithImpostor(e,t,i,r,s){let o=n._TmpVecs[0],a=this.object;if(a.rotationQuaternion)if(s){let l=n._TmpQuat;a.rotationQuaternion.multiplyToRef(s,l),e.setRotationQuaternion(l,1,t)}else e.setRotationQuaternion(a.rotationQuaternion,1,t);o.x=0,o.y=0,o.z=0,i&&(o.x=i.x,o.y=i.y,o.z=i.z,e.getDirectionToRef(o,t,o),r==null&&(r=i.length()),o.x*=r,o.y*=r,o.z*=r),e.getParent()?(o.addInPlace(a.getAbsolutePosition()),e.setAbsolutePosition(o,t)):(t.setAbsolutePosition(a.getAbsolutePosition()),t.position.x-=o.x,t.position.y-=o.y,t.position.z-=o.z)}syncImpostorWithBone(e,t,i,r,s,o){let a=this.object;if(a.rotationQuaternion)if(s){let u=n._TmpQuat;e.getRotationQuaternionToRef(1,t,u),u.multiplyToRef(s,a.rotationQuaternion)}else e.getRotationQuaternionToRef(1,t,a.rotationQuaternion);let l=n._TmpVecs[0],c=n._TmpVecs[1];o||(o=n._TmpVecs[2],o.x=0,o.y=1,o.z=0),e.getDirectionToRef(o,t,c),e.getAbsolutePositionToRef(t,l),r==null&&i&&(r=i.length()),r!=null&&(l.x+=c.x*r,l.y+=c.y*r,l.z+=c.z*r),a.setAbsolutePosition(l)}};Te.DEFAULT_OBJECT_SIZE=new m(1,1,1);Te.IDENTITY_QUATERNION=Q.Identity();Te._TmpVecs=Rh(3,m.Zero);Te._TmpQuat=Q.Identity();Te.NoImpostor=0;Te.SphereImpostor=1;Te.BoxImpostor=2;Te.PlaneImpostor=3;Te.MeshImpostor=4;Te.CapsuleImpostor=6;Te.CylinderImpostor=7;Te.ParticleImpostor=8;Te.HeightmapImpostor=9;Te.ConvexHullImpostor=10;Te.CustomImpostor=100;Te.RopeImpostor=101;Te.ClothImpostor=102;Te.SoftbodyImpostor=103;var ng=class{constructor(){this._hasHit=!1,this._hitNormal=m.Zero(),this._hitPoint=m.Zero(),this._triangleIndex=-1}get hitPoint(){return this._hitPoint}get hitNormal(){return this._hitNormal}get hasHit(){return this._hasHit}get triangleIndex(){return this._triangleIndex}setHitData(e,t,i){this._hasHit=!0,this._hitNormal.set(e.x,e.y,e.z),this._hitPoint.set(t.x,t.y,t.z),this._triangleIndex=i??-1}reset(){this._hasHit=!1,this._hitNormal.setAll(0),this._hitPoint.setAll(0),this._triangleIndex=-1,this.body=void 0,this.bodyIndex=void 0,this.shape=void 0}};var Qs=class extends ng{constructor(){super(...arguments),this._hitDistance=0,this._rayFromWorld=m.Zero(),this._rayToWorld=m.Zero()}get hitDistance(){return this._hitDistance}get hitNormalWorld(){return this._hitNormal}get hitPointWorld(){return this._hitPoint}get rayFromWorld(){return this._rayFromWorld}get rayToWorld(){return this._rayToWorld}setHitDistance(e){this._hitDistance=e}calculateHitDistance(){this._hitDistance=m.Distance(this._rayFromWorld,this._hitPoint)}reset(e=m.Zero(),t=m.Zero()){super.reset(),this._rayFromWorld.copyFrom(e),this._rayToWorld.copyFrom(t),this._hitDistance=0}};var rg=class n{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw Zt("CannonJSPlugin")}constructor(e,t=n.DefaultPluginFactory()){if(this._physicsPlugin=t,this._impostors=[],this._joints=[],this._subTimeStep=0,this._uniqueIdCounter=0,!this._physicsPlugin.isSupported())throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");e=e||new m(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){for(let e of this._impostors)e.dispose();this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}addImpostor(e){this._impostors.push(e),e.uniqueId=this._uniqueIdCounter++,e.parent||this._physicsPlugin.generatePhysicsBody(e)}removeImpostor(e){let t=this._impostors.indexOf(e);t>-1&&this._impostors.splice(t,1).length&&this.getPhysicsPlugin().removePhysicsBody(e)}addJoint(e,t,i){let r={mainImpostor:e,connectedImpostor:t,joint:i};i.physicsPlugin=this._physicsPlugin,this._joints.push(r),this._physicsPlugin.generateJoint(r)}removeJoint(e,t,i){let r=this._joints.filter(function(s){return s.connectedImpostor===t&&s.joint===i&&s.mainImpostor===e});r.length&&this._physicsPlugin.removeJoint(r[0])}_step(e){for(let t of this._impostors)t.isBodyInitRequired()&&this._physicsPlugin.generatePhysicsBody(t);e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._impostors)}getPhysicsPlugin(){return this._physicsPlugin}getImpostors(){return this._impostors}getImpostorForPhysicsObject(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].object===e)return this._impostors[t];return null}getImpostorWithPhysicsBody(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].physicsBody===e)return this._impostors[t];return null}raycast(e,t){return this._physicsPlugin.raycast(e,t)}raycastToRef(e,t,i){return this._physicsPlugin.raycastToRef(e,t,i)}};var Yl=class{constructor(e=!0,t=10,i=CANNON){if(this._useDeltaForWorldStep=e,this.name="CannonJSPlugin",this._physicsMaterials=[],this._fixedTimeStep=1/60,this._physicsBodiesToRemoveAfterStep=new Array,this._firstFrame=!0,this._tmpQuaternion=new Q,this._minus90X=new Q(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new Q(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=m.Zero(),this._tmpDeltaPosition=m.Zero(),this._tmpUnityRotation=new Q,this.BJSCANNON=i,!this.isSupported()){P.Error("CannonJS is not available. Please make sure you included the js file.");return}this._extendNamespace(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=t,this._cannonRaycastResult=new this.BJSCANNON.RaycastResult,this._raycastResult=new Qs}getPluginVersion(){return 1}setGravity(e){let t=e;this.world.gravity.set(t.x,t.y,t.z)}setTimeStep(e){this._fixedTimeStep=e}getTimeStep(){return this._fixedTimeStep}executeStep(e,t){if(this._firstFrame){this._firstFrame=!1;for(let i of t)i.type==Te.HeightmapImpostor||i.type===Te.PlaneImpostor||i.beforeStep()}this.world.step(this._useDeltaForWorldStep?e:this._fixedTimeStep),this._removeMarkedPhysicsBodiesFromWorld()}_removeMarkedPhysicsBodiesFromWorld(){if(this._physicsBodiesToRemoveAfterStep.length>0){for(let e of this._physicsBodiesToRemoveAfterStep)typeof this.world.removeBody=="function"?this.world.removeBody(e):this.world.remove(e);this._physicsBodiesToRemoveAfterStep.length=0}}applyImpulse(e,t,i){let r=new this.BJSCANNON.Vec3(i.x,i.y,i.z),s=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyImpulse(s,r)}applyForce(e,t,i){let r=new this.BJSCANNON.Vec3(i.x,i.y,i.z),s=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyForce(s,r)}generatePhysicsBody(e){if(this._removeMarkedPhysicsBodiesFromWorld(),e.parent){e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());return}if(e.isBodyInitRequired()){let t=this._createShape(e);if(!t){P.Warn("It was not possible to create a physics body for this object.");return}let i=e.physicsBody;i&&this.removePhysicsBody(e);let r=this._addMaterial("mat-"+e.uniqueId,e.getParam("friction"),e.getParam("restitution")),s={mass:e.getParam("mass"),material:r},o=e.getParam("nativeOptions");for(let a in o)Object.prototype.hasOwnProperty.call(o,a)&&(s[a]=o[a]);if(e.physicsBody=new this.BJSCANNON.Body(s),e.physicsBody.addEventListener("collide",e.onCollide),this.world.addEventListener("preStep",e.beforeStep),this.world.addEventListener("postStep",e.afterStep),e.physicsBody.addShape(t),typeof this.world.addBody=="function"?this.world.addBody(e.physicsBody):this.world.add(e.physicsBody),i){let a=["force","torque","velocity","angularVelocity"];for(let l of a){let c=i[l];e.physicsBody[l].set(c.x,c.y,c.z)}}this._processChildMeshes(e)}this._updatePhysicsBodyTransformation(e)}_processChildMeshes(e){let t=e.object.getChildMeshes?e.object.getChildMeshes(!0):[],i=e.object.rotationQuaternion;if(i?i.conjugateToRef(this._tmpQuaternion):this._tmpQuaternion.set(0,0,0,1),t.length){let r=o=>{if(!o.rotationQuaternion)return;let a=o.getPhysicsImpostor();if(a&&a.parent!==e&&o.parent){let u=o.getAbsolutePosition().subtract(o.parent.getAbsolutePosition()),h=o.rotationQuaternion.multiply(this._tmpQuaternion);a.physicsBody&&(this.removePhysicsBody(a),a.physicsBody=null),a.parent=e,a.resetUpdateFlags(),e.physicsBody.addShape(this._createShape(a),new this.BJSCANNON.Vec3(u.x,u.y,u.z),new this.BJSCANNON.Quaternion(h.x,h.y,h.z,h.w)),e.physicsBody.mass+=a.getParam("mass")}let l=o.getChildMeshes(!0).filter(c=>!!c.physicsImpostor);for(let c of l)r(c)},s=t.filter(o=>!!o.physicsImpostor);for(let o of s)r(o)}}removePhysicsBody(e){e.physicsBody.removeEventListener("collide",e.onCollide),this.world.removeEventListener("preStep",e.beforeStep),this.world.removeEventListener("postStep",e.afterStep),this._physicsBodiesToRemoveAfterStep.indexOf(e.physicsBody)===-1&&this._physicsBodiesToRemoveAfterStep.push(e.physicsBody)}generateJoint(e){let t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;let r,s=e.joint.jointData,o={pivotA:s.mainPivot?new this.BJSCANNON.Vec3().set(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z):null,pivotB:s.connectedPivot?new this.BJSCANNON.Vec3().set(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z):null,axisA:s.mainAxis?new this.BJSCANNON.Vec3().set(s.mainAxis.x,s.mainAxis.y,s.mainAxis.z):null,axisB:s.connectedAxis?new this.BJSCANNON.Vec3().set(s.connectedAxis.x,s.connectedAxis.y,s.connectedAxis.z):null,maxForce:s.nativeParams.maxForce,collideConnected:!!s.collision};switch(e.joint.type){case Ze.HingeJoint:case Ze.Hinge2Joint:r=new this.BJSCANNON.HingeConstraint(t,i,o);break;case Ze.DistanceJoint:r=new this.BJSCANNON.DistanceConstraint(t,i,s.maxDistance||2);break;case Ze.SpringJoint:{let a=s;r=new this.BJSCANNON.Spring(t,i,{restLength:a.length,stiffness:a.stiffness,damping:a.damping,localAnchorA:o.pivotA,localAnchorB:o.pivotB});break}case Ze.LockJoint:r=new this.BJSCANNON.LockConstraint(t,i,o);break;case Ze.PointToPointJoint:case Ze.BallAndSocketJoint:default:r=new this.BJSCANNON.PointToPointConstraint(t,o.pivotA,i,o.pivotB,o.maxForce);break}r.collideConnected=!!s.collision,e.joint.physicsJoint=r,e.joint.type!==Ze.SpringJoint?this.world.addConstraint(r):(e.joint.jointData.forceApplicationCallback=e.joint.jointData.forceApplicationCallback||function(){r.applyForce()},e.mainImpostor.registerAfterPhysicsStep(e.joint.jointData.forceApplicationCallback))}removeJoint(e){e.joint.type!==Ze.SpringJoint?this.world.removeConstraint(e.joint.physicsJoint):e.mainImpostor.unregisterAfterPhysicsStep(e.joint.jointData.forceApplicationCallback)}_addMaterial(e,t,i){let r,s;for(r=0;r<this._physicsMaterials.length;r++)if(s=this._physicsMaterials[r],s.friction===t&&s.restitution===i)return s;let o=new this.BJSCANNON.Material(e);return o.friction=t,o.restitution=i,this._physicsMaterials.push(o),o}_checkWithEpsilon(e){return e<tt?tt:e}_createShape(e){let t=e.object,i,r=e.getObjectExtents();switch(e.type){case Te.SphereImpostor:{let s=r.x,o=r.y,a=r.z;i=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(s),this._checkWithEpsilon(o),this._checkWithEpsilon(a))/2);break}case Te.CylinderImpostor:{let s=e.getParam("nativeOptions");s||(s={});let o=s.radiusTop!==void 0?s.radiusTop:this._checkWithEpsilon(r.x)/2,a=s.radiusBottom!==void 0?s.radiusBottom:this._checkWithEpsilon(r.x)/2,l=s.height!==void 0?s.height:this._checkWithEpsilon(r.y),c=s.numSegments!==void 0?s.numSegments:16;i=new this.BJSCANNON.Cylinder(o,a,l,c);let u=new this.BJSCANNON.Quaternion;u.setFromAxisAngle(new this.BJSCANNON.Vec3(1,0,0),-Math.PI/2);let h=new this.BJSCANNON.Vec3(0,0,0);i.transformAllPoints(h,u);break}case Te.BoxImpostor:{let s=r.scale(.5);i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(s.x),this._checkWithEpsilon(s.y),this._checkWithEpsilon(s.z)));break}case Te.PlaneImpostor:P.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),i=new this.BJSCANNON.Plane;break;case Te.MeshImpostor:{let s=t.getVerticesData?t.getVerticesData(T.PositionKind):[],o=t.getIndices?t.getIndices():[];if(!s){P.Warn("Tried to create a MeshImpostor for an object without vertices. This will fail.");return}let a=t.position.clone(),l=t.rotation&&t.rotation.clone(),c=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace();let u=t.computeWorldMatrix(!0),h=[],d;for(d=0;d<s.length;d+=3)m.TransformCoordinates(m.FromArray(s,d),u).toArray(h,d);P.Warn("MeshImpostor only collides against spheres."),i=new this.BJSCANNON.Trimesh(h,o),t.position.copyFrom(a),l&&t.rotation&&t.rotation.copyFrom(l),c&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(c);break}case Te.HeightmapImpostor:{let s=t.position.clone(),o=t.rotation&&t.rotation.clone(),a=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace(),t.rotationQuaternion&&t.rotationQuaternion.multiplyInPlace(this._minus90X),i=this._createHeightmap(t),t.position.copyFrom(s),o&&t.rotation&&t.rotation.copyFrom(o),a&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(a),t.computeWorldMatrix(!0);break}case Te.ParticleImpostor:i=new this.BJSCANNON.Particle;break;case Te.NoImpostor:i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(0,0,0));break}return i}_createHeightmap(e,t){let i=e.getVerticesData(T.PositionKind),r=e.computeWorldMatrix(!0),s=[],o;for(o=0;o<i.length;o+=3)m.TransformCoordinates(m.FromArray(i,o),r).toArray(s,o);i=s;let a=new Array,l=t||~~(Math.sqrt(i.length/3)-1),c=e.getBoundingInfo(),u=Math.min(c.boundingBox.extendSizeWorld.x,c.boundingBox.extendSizeWorld.y),h=c.boundingBox.extendSizeWorld.z,d=u*2/l;for(let p=0;p<i.length;p=p+3){let g=Math.round(i[p+0]/d+l/2),_=Math.round((i[p+1]/d-l/2)*-1),y=-i[p+2]+h;a[g]||(a[g]=[]),a[g][_]||(a[g][_]=y),a[g][_]=Math.max(y,a[g][_])}for(let p=0;p<=l;++p){if(!a[p]){let g=1;for(;!a[(p+g)%l];)g++;a[p]=a[(p+g)%l].slice()}for(let g=0;g<=l;++g)if(!a[p][g]){let _=1,y;for(;y===void 0;)y=a[p][(g+_++)%l];a[p][g]=y}}let f=new this.BJSCANNON.Heightfield(a,{elementSize:d});return f.minY=h,f}_updatePhysicsBodyTransformation(e){let t=e.object;if(t.computeWorldMatrix&&t.computeWorldMatrix(!0),!t.getBoundingInfo())return;let i=e.getObjectCenter();this._tmpDeltaPosition.copyFrom(t.getAbsolutePivotPoint().subtract(i)),this._tmpDeltaPosition.divideInPlace(e.object.scaling),this._tmpPosition.copyFrom(i);let r=t.rotationQuaternion;if(r){if((e.type===Te.PlaneImpostor||e.type===Te.HeightmapImpostor)&&(r=r.multiply(this._minus90X),e.setDeltaRotation(this._plus90X)),e.type===Te.HeightmapImpostor){let s=t,o=s.getBoundingInfo(),a=s.rotationQuaternion;s.rotationQuaternion=this._tmpUnityRotation,s.computeWorldMatrix(!0);let l=i.clone(),c=s.getPivotMatrix();c?c=c.clone():c=L.Identity();let u=L.Translation(o.boundingBox.extendSizeWorld.x,0,-o.boundingBox.extendSizeWorld.z);s.setPreTransformMatrix(u),s.computeWorldMatrix(!0),o=s.getBoundingInfo();let h=o.boundingBox.centerWorld.subtract(i).subtract(s.position).negate();this._tmpPosition.copyFromFloats(h.x,h.y-o.boundingBox.extendSizeWorld.y,h.z),this._tmpDeltaPosition.copyFrom(o.boundingBox.centerWorld.subtract(l)),this._tmpDeltaPosition.y+=o.boundingBox.extendSizeWorld.y,s.rotationQuaternion=a,s.setPreTransformMatrix(c),s.computeWorldMatrix(!0)}else e.type===Te.MeshImpostor&&this._tmpDeltaPosition.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpDeltaPosition),e.physicsBody.position.set(this._tmpPosition.x,this._tmpPosition.y,this._tmpPosition.z),e.physicsBody.quaternion.set(r.x,r.y,r.z,r.w)}}setTransformationFromPhysicsBody(e){if(e.object.position.set(e.physicsBody.position.x,e.physicsBody.position.y,e.physicsBody.position.z),e.object.rotationQuaternion){let t=e.physicsBody.quaternion;e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}setPhysicsBodyTransformation(e,t,i){e.physicsBody.position.set(t.x,t.y,t.z),e.physicsBody.quaternion.set(i.x,i.y,i.z,i.w)}isSupported(){return this.BJSCANNON!==void 0}setLinearVelocity(e,t){e.physicsBody.velocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){let t=e.physicsBody.velocity;return t?new m(t.x,t.y,t.z):null}getAngularVelocity(e){let t=e.physicsBody.angularVelocity;return t?new m(t.x,t.y,t.z):null}setBodyMass(e,t){e.physicsBody.mass=t,e.physicsBody.updateMassProperties()}getBodyMass(e){return e.physicsBody.mass}getBodyFriction(e){return e.physicsBody.material.friction}setBodyFriction(e,t){e.physicsBody.material.friction=t}getBodyRestitution(e){return e.physicsBody.material.restitution}setBodyRestitution(e,t){e.physicsBody.material.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.wakeUp()}updateDistanceJoint(e,t){e.physicsJoint.distance=t}setMotor(e,t,i,r){r||(e.physicsJoint.enableMotor(),e.physicsJoint.setMotorSpeed(t),i&&this.setLimit(e,i))}setLimit(e,t,i){e.physicsJoint.motorEquation.maxForce=i,e.physicsJoint.motorEquation.minForce=t===void 0?-t:t}syncMeshWithImpostor(e,t){let i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.quaternion.x,e.rotationQuaternion.y=i.quaternion.y,e.rotationQuaternion.z=i.quaternion.z,e.rotationQuaternion.w=i.quaternion.w)}getRadius(e){return e.physicsBody.shapes[0].boundingSphereRadius}getBoxSizeToRef(e,t){let i=e.physicsBody.shapes[0];t.x=i.halfExtents.x*2,t.y=i.halfExtents.y*2,t.z=i.halfExtents.z*2}dispose(){}_extendNamespace(){let e=new this.BJSCANNON.Vec3,t=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(i,r,s){if(s=s||10,r=r||0,r===0)this.internalStep(i),this.time+=i;else{let o=Math.floor((this.time+r)/i)-Math.floor(this.time/i);o=Math.min(o,s)||1;let a=performance.now();for(let d=0;d!==o&&(this.internalStep(i),!(performance.now()-a>i*1e3));d++);this.time+=r;let c=this.time%i/i,u=e,h=this.bodies;for(let d=0;d!==h.length;d++){let f=h[d];f.type!==t.Body.STATIC&&f.sleepState!==t.Body.SLEEPING?(f.position.vsub(f.previousPosition,u),u.scale(c,u),f.position.vadd(u,f.interpolatedPosition)):(f.interpolatedPosition.set(f.position.x,f.position.y,f.position.z),f.interpolatedQuaternion.set(f.quaternion.x,f.quaternion.y,f.quaternion.z,f.quaternion.w))}}}}raycast(e,t){return this._raycastResult.reset(e,t),this.raycastToRef(e,t,this._raycastResult),this._raycastResult}raycastToRef(e,t,i){this._cannonRaycastResult.reset(),this.world.raycastClosest(e,t,{},this._cannonRaycastResult),i.reset(e,t),this._cannonRaycastResult.hasHit&&(i.setHitData({x:this._cannonRaycastResult.hitNormalWorld.x,y:this._cannonRaycastResult.hitNormalWorld.y,z:this._cannonRaycastResult.hitNormalWorld.z},{x:this._cannonRaycastResult.hitPointWorld.x,y:this._cannonRaycastResult.hitPointWorld.y,z:this._cannonRaycastResult.hitPointWorld.z}),i.setHitDistance(this._cannonRaycastResult.distance))}};rg.DefaultPluginFactory=()=>new Yl;var rh=class{constructor(e=!0,t,i=OIMO){this._useDeltaForWorldStep=e,this.name="OimoJSPlugin",this._fixedTimeStep=1/60,this._tmpImpostorsArray=[],this._tmpPositionVector=m.Zero(),this.BJSOIMO=i,this.world=new this.BJSOIMO.World({iterations:t}),this.world.clear(),this._raycastResult=new Qs}getPluginVersion(){return 1}setGravity(e){this.world.gravity.set(e.x,e.y,e.z)}setTimeStep(e){this.world.timeStep=e}getTimeStep(){return this.world.timeStep}executeStep(e,t){for(let r of t)r.beforeStep();this.world.timeStep=this._useDeltaForWorldStep?e:this._fixedTimeStep,this.world.step();for(let r of t)r.afterStep(),this._tmpImpostorsArray[r.uniqueId]=r;let i=this.world.contacts;for(;i!==null;){if(i.touching&&!i.body1.sleeping&&!i.body2.sleeping){i=i.next;continue}let r=this._tmpImpostorsArray[+i.body1.name],s=this._tmpImpostorsArray[+i.body2.name];if(!r||!s){i=i.next;continue}r.onCollide({body:s.physicsBody,point:null,distance:0,impulse:0,normal:null}),s.onCollide({body:r.physicsBody,point:null,distance:0,impulse:0,normal:null}),i=i.next}}applyImpulse(e,t,i){let r=e.physicsBody.mass;e.physicsBody.applyImpulse(i.scale(this.world.invScale),t.scale(this.world.invScale*r))}applyForce(e,t,i){P.Warn("Oimo doesn't support applying force. Using impulse instead."),this.applyImpulse(e,t,i)}generatePhysicsBody(e){if(e.parent){e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());return}if(e.isBodyInitRequired()){let t={name:e.uniqueId,config:[e.getParam("mass")||.001,e.getParam("friction"),e.getParam("restitution")],size:[],type:[],pos:[],posShape:[],rot:[],rotShape:[],move:e.getParam("mass")!==0,density:e.getParam("mass"),friction:e.getParam("friction"),restitution:e.getParam("restitution"),world:this.world},i=[e];(a=>{if(!a.getChildMeshes)return;let l=a.getChildMeshes();for(let c of l)c.physicsImpostor&&i.push(c.physicsImpostor)})(e.object);let s=a=>Math.max(a,tt),o=new Q;for(let a of i){if(!a.object.rotationQuaternion)continue;let l=a.object.rotationQuaternion;o.copyFrom(l),a.object.rotationQuaternion.set(0,0,0,1),a.object.computeWorldMatrix(!0);let c=o.toEulerAngles(),u=a.getObjectExtents(),h=57.29577951308232;if(a===e){let d=e.getObjectCenter();e.object.getAbsolutePivotPoint().subtractToRef(d,this._tmpPositionVector),this._tmpPositionVector.divideInPlace(e.object.scaling),t.pos.push(d.x),t.pos.push(d.y),t.pos.push(d.z),t.posShape.push(0,0,0),t.rotShape.push(0,0,0)}else{let d=a.object.position.clone();t.posShape.push(d.x),t.posShape.push(d.y),t.posShape.push(d.z),t.rotShape.push(c.x*h,c.y*h,c.z*h)}switch(a.object.rotationQuaternion.copyFrom(o),a.type){case Te.ParticleImpostor:P.Warn("No Particle support in OIMO.js. using SphereImpostor instead");case Te.SphereImpostor:{let d=u.x,f=u.y,p=u.z,g=Math.max(s(d),s(f),s(p))/2;t.type.push("sphere"),t.size.push(g),t.size.push(g),t.size.push(g);break}case Te.CylinderImpostor:{let d=s(u.x)/2,f=s(u.y);t.type.push("cylinder"),t.size.push(d),t.size.push(f),t.size.push(f);break}case Te.PlaneImpostor:case Te.BoxImpostor:default:{let d=s(u.x),f=s(u.y),p=s(u.z);t.type.push("box"),t.size.push(d),t.size.push(f),t.size.push(p);break}}a.object.rotationQuaternion=l}e.physicsBody=this.world.add(t),e.physicsBody.resetQuaternion(o),e.physicsBody.updatePosition(0)}else this._tmpPositionVector.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpPositionVector)}removePhysicsBody(e){this.world.removeRigidBody(e.physicsBody)}generateJoint(e){let t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;let r=e.joint.jointData,s=r.nativeParams||{},o,a={body1:t,body2:i,axe1:s.axe1||(r.mainAxis?r.mainAxis.asArray():null),axe2:s.axe2||(r.connectedAxis?r.connectedAxis.asArray():null),pos1:s.pos1||(r.mainPivot?r.mainPivot.asArray():null),pos2:s.pos2||(r.connectedPivot?r.connectedPivot.asArray():null),min:s.min,max:s.max,collision:s.collision||r.collision,spring:s.spring,world:this.world};switch(e.joint.type){case Ze.BallAndSocketJoint:o="jointBall";break;case Ze.SpringJoint:{P.Warn("OIMO.js doesn't support Spring Constraint. Simulating using DistanceJoint instead");let l=r;a.min=l.length||a.min,a.max=Math.max(a.min,a.max)}case Ze.DistanceJoint:o="jointDistance",a.max=r.maxDistance;break;case Ze.PrismaticJoint:o="jointPrisme";break;case Ze.SliderJoint:o="jointSlide";break;case Ze.WheelJoint:o="jointWheel";break;case Ze.HingeJoint:default:o="jointHinge";break}a.type=o,e.joint.physicsJoint=this.world.add(a)}removeJoint(e){try{this.world.removeJoint(e.joint.physicsJoint)}catch(t){P.Warn(t)}}isSupported(){return this.BJSOIMO!==void 0}setTransformationFromPhysicsBody(e){if(!e.physicsBody.sleeping){if(e.physicsBody.shapes.next){let t=e.physicsBody.shapes;for(;t.next;)t=t.next;e.object.position.set(t.position.x,t.position.y,t.position.z)}else{let t=e.physicsBody.getPosition();e.object.position.set(t.x,t.y,t.z)}if(e.object.rotationQuaternion){let t=e.physicsBody.getQuaternion();e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}}setPhysicsBodyTransformation(e,t,i){let r=e.physicsBody;e.physicsBody.shapes.next||(r.position.set(t.x,t.y,t.z),r.orientation.set(i.x,i.y,i.z,i.w),r.syncShapes(),r.awake())}setLinearVelocity(e,t){e.physicsBody.linearVelocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){let t=e.physicsBody.linearVelocity;return t?new m(t.x,t.y,t.z):null}getAngularVelocity(e){let t=e.physicsBody.angularVelocity;return t?new m(t.x,t.y,t.z):null}setBodyMass(e,t){let i=t===0;e.physicsBody.shapes.density=i?1:t,e.physicsBody.setupMass(i?2:1)}getBodyMass(e){return e.physicsBody.shapes.density}getBodyFriction(e){return e.physicsBody.shapes.friction}setBodyFriction(e,t){e.physicsBody.shapes.friction=t}getBodyRestitution(e){return e.physicsBody.shapes.restitution}setBodyRestitution(e,t){e.physicsBody.shapes.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.awake()}updateDistanceJoint(e,t,i){e.physicsJoint.limitMotor.upperLimit=t,i!==void 0&&(e.physicsJoint.limitMotor.lowerLimit=i)}setMotor(e,t,i,r){i!==void 0?P.Warn("OimoJS plugin currently has unexpected behavior when using setMotor with force parameter"):i=1e6,t*=-1;let s=r?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;s&&s.setMotor(t,i)}setLimit(e,t,i,r){let s=r?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;s&&s.setLimit(t,i===void 0?-t:i)}syncMeshWithImpostor(e,t){let i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.orientation.x,e.rotationQuaternion.y=i.orientation.y,e.rotationQuaternion.z=i.orientation.z,e.rotationQuaternion.w=i.orientation.w)}getRadius(e){return e.physicsBody.shapes.radius}getBoxSizeToRef(e,t){let i=e.physicsBody.shapes;t.x=i.halfWidth*2,t.y=i.halfHeight*2,t.z=i.halfDepth*2}dispose(){this.world.clear()}raycast(e,t){return P.Warn("raycast is not currently supported by the Oimo physics plugin"),this._raycastResult.reset(e,t),this._raycastResult}raycastToRef(e,t,i){P.Warn("raycast is not currently supported by the Oimo physics plugin"),i.reset(e,t)}};function nD(n){let e=n.pathArray,t=n.closeArray||!1,i=n.closePath||!1,r=n.invertUV||!1,s=Math.floor(e[0].length/2),o=n.offset||s;o=o>s?s:Math.floor(o);let a=n.sideOrientation===0?0:n.sideOrientation||K.DEFAULTSIDE,l=n.uvs,c=n.colors,u=[],h=[],d=[],f=[],p=[],g=[],_=[],y=[],b,A=[],I=[],v,x,C;if(e.length<2){let _e=[],$e=[];for(x=0;x<e[0].length-o;x++)_e.push(e[0][x]),$e.push(e[0][x+o]);e=[_e,$e]}let R=0,M=i?1:0,D=t?1:0,W,ee;b=e[0].length;let ae,J;for(v=0;v<e.length+D;v++){for(_[v]=0,p[v]=[0],W=v===e.length?e[0]:e[v],ee=W.length,b=b<ee?b:ee,C=0;C<ee;)u.push(W[C].x,W[C].y,W[C].z),C>0&&(ae=W[C].subtract(W[C-1]).length(),J=ae+_[v],p[v].push(J),_[v]=J),C++;i&&(C--,u.push(W[0].x,W[0].y,W[0].z),ae=W[C].subtract(W[0]).length(),J=ae+_[v],p[v].push(J),_[v]=J),A[v]=ee+M,I[v]=R,R+=ee+M}let he,oe,pe=null,be=null;for(x=0;x<b+M;x++)for(y[x]=0,g[x]=[0],v=0;v<e.length-1+D;v++)he=e[v],oe=v===e.length-1?e[0]:e[v+1],x===b?(pe=he[0],be=oe[0]):(pe=he[x],be=oe[x]),ae=be.subtract(pe).length(),J=ae+y[x],g[x].push(J),y[x]=J;let $,j;if(l)for(v=0;v<l.length;v++)f.push(l[v].x,Me?1-l[v].y:l[v].y);else for(v=0;v<e.length+D;v++)for(x=0;x<b+M;x++)$=_[v]!=0?p[v][x]/_[v]:0,j=y[x]!=0?g[x][v]/y[x]:0,r?f.push(j,$):f.push($,Me?1-j:j);v=0;let N=0,G=A[v]-1,V=A[v+1]-1,q=G<V?G:V,xe=I[1]-I[0],re=A.length-1;for(;N<=q&&v<re;)h.push(N,N+xe,N+1),h.push(N+xe+1,N+1,N+xe),N+=1,N===q&&(v++,xe=I[v+1]-I[v],G=A[v]-1,V=A[v+1]-1,N=I[v],q=G<V?G+N:V+N);if(K.ComputeNormals(u,h,d),i){let _e=0,$e=0;for(v=0;v<e.length;v++){_e=I[v]*3,v+1<e.length?$e=(I[v+1]-1)*3:$e=d.length-3,d[_e]=(d[_e]+d[$e])*.5,d[_e+1]=(d[_e+1]+d[$e+1])*.5,d[_e+2]=(d[_e+2]+d[$e+2])*.5;let Se=Math.sqrt(d[_e]*d[_e]+d[_e+1]*d[_e+1]+d[_e+2]*d[_e+2]);d[_e]/=Se,d[_e+1]/=Se,d[_e+2]/=Se,d[$e]=d[_e],d[$e+1]=d[_e+1],d[$e+2]=d[_e+2]}}if(t){let _e=I[0]*3,$e=I[e.length]*3;for(x=0;x<b+M;x++){d[_e]=(d[_e]+d[$e])*.5,d[_e+1]=(d[_e+1]+d[$e+1])*.5,d[_e+2]=(d[_e+2]+d[$e+2])*.5;let Se=Math.sqrt(d[_e]*d[_e]+d[_e+1]*d[_e+1]+d[_e+2]*d[_e+2]);d[_e]/=Se,d[_e+1]/=Se,d[_e+2]/=Se,d[$e]=d[_e],d[$e+1]=d[_e+1],d[$e+2]=d[_e+2],_e+=3,$e+=3}}K._ComputeSides(a,u,h,d,f,n.frontUVs,n.backUVs);let Ie=null;if(c){Ie=new Float32Array(c.length*4);for(let _e=0;_e<c.length;_e++)Ie[_e*4]=c[_e].r,Ie[_e*4+1]=c[_e].g,Ie[_e*4+2]=c[_e].b,Ie[_e*4+3]=c[_e].a}let Je=new K,jt=new Float32Array(u),Ct=new Float32Array(d),qt=new Float32Array(f);return Je.indices=h,Je.positions=jt,Je.normals=Ct,Je.uvs=qt,Ie&&Je.set(Ie,T.ColorKind),i&&(Je._idx=I),Je}function fr(n,e,t=null){let i=e.pathArray,r=e.closeArray,s=e.closePath,o=E._GetDefaultSideOrientation(e.sideOrientation),a=e.instance,l=e.updatable;if(a){let c=k.Vector3[0].setAll(Number.MAX_VALUE),u=k.Vector3[1].setAll(-Number.MAX_VALUE),h=f=>{let p=i[0].length,g=a,_=0,y=g._originalBuilderSideOrientation===E.DOUBLESIDE?2:1;for(let b=1;b<=y;++b)for(let A=0;A<i.length;++A){let I=i[A],v=I.length;p=p<v?p:v;for(let x=0;x<p;++x){let C=I[x];f[_]=C.x,f[_+1]=C.y,f[_+2]=C.z,c.minimizeInPlaceFromFloats(C.x,C.y,C.z),u.maximizeInPlaceFromFloats(C.x,C.y,C.z),_+=3}if(g._creationDataStorage&&g._creationDataStorage.closePath){let x=I[0];f[_]=x.x,f[_+1]=x.y,f[_+2]=x.z,_+=3}}},d=a.getVerticesData(T.PositionKind);if(h(d),a.hasBoundingInfo?a.getBoundingInfo().reConstruct(c,u,a._worldMatrix):a.buildBoundingInfo(c,u,a._worldMatrix),a.updateVerticesData(T.PositionKind,d,!1,!1),e.colors){let f=a.getVerticesData(T.ColorKind);for(let p=0,g=0;p<e.colors.length;p++,g+=4){let _=e.colors[p];f[g]=_.r,f[g+1]=_.g,f[g+2]=_.b,f[g+3]=_.a}a.updateVerticesData(T.ColorKind,f,!1,!1)}if(e.uvs){let f=a.getVerticesData(T.UVKind);for(let p=0;p<e.uvs.length;p++)f[p*2]=e.uvs[p].x,f[p*2+1]=Me?1-e.uvs[p].y:e.uvs[p].y;a.updateVerticesData(T.UVKind,f,!1,!1)}if(!a.areNormalsFrozen||a.isFacetDataEnabled){let f=a.getIndices(),p=a.getVerticesData(T.NormalKind),g=a.isFacetDataEnabled?a.getFacetDataParameters():null;if(K.ComputeNormals(d,f,p,g),a._creationDataStorage&&a._creationDataStorage.closePath){let _=0,y=0;for(let b=0;b<i.length;b++)_=a._creationDataStorage.idx[b]*3,b+1<i.length?y=(a._creationDataStorage.idx[b+1]-1)*3:y=p.length-3,p[_]=(p[_]+p[y])*.5,p[_+1]=(p[_+1]+p[y+1])*.5,p[_+2]=(p[_+2]+p[y+2])*.5,p[y]=p[_],p[y+1]=p[_+1],p[y+2]=p[_+2]}a.areNormalsFrozen||a.updateVerticesData(T.NormalKind,p,!1,!1)}return a}else{let c=new E(n,t);c._originalBuilderSideOrientation=o,c._creationDataStorage=new Pl;let u=nD(e);return s&&(c._creationDataStorage.idx=u._idx),c._creationDataStorage.closePath=s,c._creationDataStorage.closeArray=r,u.applyToMesh(c,l),c}}K.CreateRibbon=nD;E.CreateRibbon=(n,e,t=!1,i,r,s,o=!1,a,l)=>fr(n,{pathArray:e,closeArray:t,closePath:i,offset:r,updatable:o,sideOrientation:a,instance:l},s);function sh(n,e,t=null){let i=e.path,r=e.shape,s=e.scale||1,o=e.rotation||0,a=e.cap===0?0:e.cap||E.NO_CAP,l=e.updatable,c=E._GetDefaultSideOrientation(e.sideOrientation),u=e.instance||null,h=e.invertUV||!1,d=e.closeShape||!1,f=e.closePath||!1,p=e.capFunction||null;return rD(n,r,i,s,o,null,null,f,d,a,!1,t,!!l,c,u,h,e.frontUVs||null,e.backUVs||null,e.firstNormal||null,!!e.adjustFrame,p)}function GC(n,e,t=null){let i=e.path,r=e.shape,s=e.scaleFunction||(()=>1),o=e.rotationFunction||(()=>0),a=e.closePath||e.ribbonCloseArray||!1,l=e.closeShape||e.ribbonClosePath||!1,c=e.cap===0?0:e.cap||E.NO_CAP,u=e.updatable,h=e.firstNormal||null,d=e.adjustFrame||!1,f=E._GetDefaultSideOrientation(e.sideOrientation),p=e.instance,g=e.invertUV||!1,_=e.capFunction||null;return rD(n,r,i,null,null,s,o,a,l,c,!0,t,!!u,f,p||null,g,e.frontUVs||null,e.backUVs||null,h,d,_||null)}function rD(n,e,t,i,r,s,o,a,l,c,u,h,d,f,p,g,_,y,b,A,I){let v=(D,W,ee,ae,J,he,oe,pe,be,$,j)=>{let N=ee.getTangents(),G=ee.getNormals(),V=ee.getBinormals(),q=ee.getDistances();if(j){for(let Se=0;Se<N.length;Se++)if(N[Se].x==0&&N[Se].y==0&&N[Se].z==0&&N[Se].copyFrom(N[Se-1]),G[Se].x==0&&G[Se].y==0&&G[Se].z==0&&G[Se].copyFrom(G[Se-1]),V[Se].x==0&&V[Se].y==0&&V[Se].z==0&&V[Se].copyFrom(V[Se-1]),Se>0){let yi=N[Se-1];m.Dot(yi,N[Se])<0&&N[Se].scaleInPlace(-1),yi=G[Se-1],m.Dot(yi,G[Se])<0&&G[Se].scaleInPlace(-1),yi=V[Se-1],m.Dot(yi,V[Se])<0&&V[Se].scaleInPlace(-1)}}let xe=0,re=()=>J!==null?J:1,Je=$&&pe?pe:()=>he!==null?he:0,jt=$&&oe?oe:re,Ct=be===E.NO_CAP||be===E.CAP_END?0:2,qt=k.Matrix[0];for(let Se=0;Se<W.length;Se++){let yi=[],Pn=Je(Se,q[Se]),qi=jt(Se,q[Se]);L.RotationAxisToRef(N[Se],xe,qt);for(let Yn=0;Yn<D.length;Yn++){let ya=N[Se].scale(D[Yn].z).add(G[Se].scale(D[Yn].x)).add(V[Se].scale(D[Yn].y)),mr=m.Zero();m.TransformCoordinatesToRef(ya,qt,mr),mr.scaleInPlace(qi).addInPlace(W[Se]),yi[Yn]=mr}ae[Ct]=yi,xe+=Pn,Ct++}let $e=I||(Se=>{let yi=Array(),Pn=m.Zero(),qi;for(qi=0;qi<Se.length;qi++)Pn.addInPlace(Se[qi]);for(Pn.scaleInPlace(1/Se.length),qi=0;qi<Se.length;qi++)yi.push(Pn);return yi});switch(be){case E.NO_CAP:break;case E.CAP_START:ae[0]=$e(ae[2]),ae[1]=ae[2];break;case E.CAP_END:ae[Ct]=ae[Ct-1],ae[Ct+1]=$e(ae[Ct-1]);break;case E.CAP_ALL:ae[0]=$e(ae[2]),ae[1]=ae[2],ae[Ct]=ae[Ct-1],ae[Ct+1]=$e(ae[Ct-1]);break;default:break}return ae},x,C;if(p){let D=p._creationDataStorage;return x=b?D.path3D.update(t,b):D.path3D.update(t),C=v(e,t,D.path3D,D.pathArray,i,r,s,o,D.cap,u,A),p=fr("",{pathArray:C,closeArray:!1,closePath:!1,offset:0,updatable:!1,sideOrientation:0,instance:p},h||void 0),p}x=b?new Sc(t,b):new Sc(t);let R=new Array;c=c<0||c>3?0:c,C=v(e,t,x,R,i,r,s,o,c,u,A);let M=fr(n,{pathArray:C,closeArray:a,closePath:l,updatable:d,sideOrientation:f,invertUV:g,frontUVs:_||void 0,backUVs:y||void 0},h);return M._creationDataStorage.pathArray=C,M._creationDataStorage.path3D=x,M._creationDataStorage.cap=c,M}E.ExtrudeShape=(n,e,t,i,r,s,o=null,a,l,c)=>{let u={shape:e,path:t,scale:i,rotation:r,cap:s===0?0:s||E.NO_CAP,sideOrientation:l,instance:c,updatable:a};return sh(n,u,o)};E.ExtrudeShapeCustom=(n,e,t,i,r,s,o,a,l,c,u,h)=>{let d={shape:e,path:t,scaleFunction:i,rotationFunction:r,ribbonCloseArray:s,ribbonClosePath:o,cap:a===0?0:a||E.NO_CAP,sideOrientation:u,instance:h,updatable:c};return GC(n,d,l)};E._LinesMeshParser=(n,e)=>sg.Parse(n,e);var sg=(()=>{class n extends E{_isShaderMaterial(t){return t?t.getClassName()==="ShaderMaterial":!1}constructor(t,i=null,r=null,s=null,o,a,l,c){super(t,i,r,s,o),this.useVertexColor=a,this.useVertexAlpha=l,this.color=new U(1,1,1),this.alpha=1,this._shaderLanguage=0,this._ownsMaterial=!1,s&&(this.color=s.color.clone(),this.alpha=s.alpha,this.useVertexColor=s.useVertexColor,this.useVertexAlpha=s.useVertexAlpha),this.intersectionThreshold=.1;let u=[],h={attributes:[T.PositionKind],uniforms:["world","viewProjection"],needAlphaBlending:!0,defines:u,useClipPlane:null,shaderLanguage:0};if(this.useVertexAlpha?h.defines.push("#define VERTEXALPHA"):h.needAlphaBlending=!1,this.useVertexColor?(h.defines.push("#define VERTEXCOLOR"),h.attributes.push(T.ColorKind)):(h.uniforms.push("color"),this._color4=new ce),c)this.material=c;else{this.getScene().getEngine().isWebGPU&&!n.ForceGLSL&&(this._shaderLanguage=1),h.shaderLanguage=this._shaderLanguage,h.extraInitializationsAsync=()=>S(this,null,function*(){this._shaderLanguage===1?yield Promise.all([import("./chunk-IHOWICLF.js"),import("./chunk-M4ELAMMT.js")]):yield Promise.all([import("./chunk-QCDD62GO.js"),import("./chunk-A3CDPD47.js")])});let f=new un("colorShader",this.getScene(),"color",h,!1);f.doNotSerialize=!0,this._ownsMaterial=!0,this._setInternalMaterial(f)}}getClassName(){return"LinesMesh"}get material(){return this._internalAbstractMeshDataInfo._material}set material(t){let i=this.material;if(i===t)return;let r=i&&this._ownsMaterial;this._ownsMaterial=!1,this._setInternalMaterial(t),r&&i?.dispose()}_setInternalMaterial(t){this._setMaterial(t),this.material&&(this.material.fillMode=Re.LineListDrawMode,this.material.disableLighting=!0)}get checkCollisions(){return!1}set checkCollisions(t){}_bind(t,i){if(!this._geometry)return this;let r=this.isUnIndexed?null:this._geometry.getIndexBuffer();if(!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(i,r):this._geometry._bind(i,r,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),!this.useVertexColor&&this._isShaderMaterial(this.material)){let{r:s,g:o,b:a}=this.color;this._color4.set(s,o,a,this.alpha),this.material.setColor4("color",this._color4)}return this}_draw(t,i,r){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;let s=this.getScene().getEngine();return this._unIndexed?s.drawArraysType(Re.LineListDrawMode,t.verticesStart,t.verticesCount,r):s.drawElementsType(Re.LineListDrawMode,t.indexStart,t.indexCount,r),this}dispose(t,i=!1,r){r||(this._ownsMaterial?this.material?.dispose(!1,!1,!0):i&&this.material?.dispose(!1,!1,!0)),super.dispose(t)}clone(t,i=null,r){if(i&&i._addToSceneRootNodes===void 0){let s=i;return s.source=this,new n(t,this.getScene(),s.parent,s.source,s.doNotCloneChildren)}return new n(t,this.getScene(),i,this,r)}createInstance(t){let i=new UC(t,this);if(this.instancedBuffers){i.instancedBuffers={};for(let r in this.instancedBuffers)i.instancedBuffers[r]=this.instancedBuffers[r]}return i}serialize(t){super.serialize(t),t.color=this.color.asArray(),t.alpha=this.alpha}static Parse(t,i){let r=new n(t.name,i);return r.color=U.FromArray(t.color),r.alpha=t.alpha,r}}return n.ForceGLSL=!1,n})(),UC=class extends ps{constructor(e,t){super(e,t),this.intersectionThreshold=t.intersectionThreshold}getClassName(){return"InstancedLinesMesh"}};function sD(n){let e=[],t=[],i=n.lines,r=n.colors,s=[],o=0;for(let l=0;l<i.length;l++){let c=i[l];for(let u=0;u<c.length;u++){let{x:h,y:d,z:f}=c[u];if(t.push(h,d,f),r){let p=r[l],{r:g,g:_,b:y,a:b}=p[u];s.push(g,_,y,b)}u>0&&(e.push(o-1),e.push(o)),o++}}let a=new K;return a.indices=e,a.positions=t,r&&(a.colors=s),a}function oD(n){let e=n.dashSize||3,t=n.gapSize||1,i=n.dashNb||200,r=n.points,s=[],o=[],a=m.Zero(),l=0,c=0,u=0,h=0,d=0,f=0,p=0;for(p=0;p<r.length-1;p++)r[p+1].subtractToRef(r[p],a),l+=a.length();for(u=l/i,h=e*u/(e+t),p=0;p<r.length-1;p++){r[p+1].subtractToRef(r[p],a),c=Math.floor(a.length()/u),a.normalize();for(let _=0;_<c;_++)d=u*_,s.push(r[p].x+d*a.x,r[p].y+d*a.y,r[p].z+d*a.z),s.push(r[p].x+(d+h)*a.x,r[p].y+(d+h)*a.y,r[p].z+(d+h)*a.z),o.push(f,f+1),f+=2}let g=new K;return g.positions=s,g.indices=o,g}function zC(n,e,t=null){let i=e.instance,r=e.lines,s=e.colors;if(i){let c=i.getVerticesData(T.PositionKind),u,h;s&&(u=i.getVerticesData(T.ColorKind));let d=0,f=0;for(let p=0;p<r.length;p++){let g=r[p];for(let _=0;_<g.length;_++)c[d]=g[_].x,c[d+1]=g[_].y,c[d+2]=g[_].z,s&&u&&(h=s[p],u[f]=h[_].r,u[f+1]=h[_].g,u[f+2]=h[_].b,u[f+3]=h[_].a,f+=4),d+=3}return i.updateVerticesData(T.PositionKind,c,!1,!1),s&&u&&i.updateVerticesData(T.ColorKind,u,!1,!1),i.refreshBoundingInfo(),i}let o=!!s,a=new sg(n,t,null,void 0,void 0,o,e.useVertexAlpha,e.material);return sD(e).applyToMesh(a,e.updatable),a}function na(n,e,t=null){let i=e.colors?[e.colors]:null;return zC(n,{lines:[e.points],updatable:e.updatable,instance:e.instance,colors:i,useVertexAlpha:e.useVertexAlpha,material:e.material},t)}function HC(n,e,t=null){let i=e.points,r=e.instance,s=e.gapSize||1,o=e.dashSize||3;if(r){let c=u=>{let h=m.Zero(),d=u.length/6,f=0,p=0,g=0,_=0,y=0,b=0,A=0,I=0;for(A=0;A<i.length-1;A++)i[A+1].subtractToRef(i[A],h),f+=h.length();g=f/d;let v=r._creationDataStorage.dashSize,x=r._creationDataStorage.gapSize;for(_=v*g/(v+x),A=0;A<i.length-1;A++)for(i[A+1].subtractToRef(i[A],h),p=Math.floor(h.length()/g),h.normalize(),I=0;I<p&&b<u.length;)y=g*I,u[b]=i[A].x+y*h.x,u[b+1]=i[A].y+y*h.y,u[b+2]=i[A].z+y*h.z,u[b+3]=i[A].x+(y+_)*h.x,u[b+4]=i[A].y+(y+_)*h.y,u[b+5]=i[A].z+(y+_)*h.z,b+=6,I++;for(;b<u.length;)u[b]=i[A].x,u[b+1]=i[A].y,u[b+2]=i[A].z,b+=3};return(e.dashNb||e.dashSize||e.gapSize||e.useVertexAlpha||e.material)&&P.Warn("You have used an option other than points with the instance option. Please be aware that these other options will be ignored."),r.updateMeshPositions(c,!1),r}let a=new sg(n,t,null,void 0,void 0,void 0,e.useVertexAlpha,e.material);return oD(e).applyToMesh(a,e.updatable),a._creationDataStorage=new Pl,a._creationDataStorage.dashSize=o,a._creationDataStorage.gapSize=s,a}K.CreateLineSystem=sD;K.CreateDashedLines=oD;E.CreateLines=(n,e,t=null,i=!1,r=null)=>na(n,{points:e,updatable:i,instance:r},t);E.CreateDashedLines=(n,e,t,i,r,s=null,o,a)=>HC(n,{points:e,dashSize:t,gapSize:i,dashNb:r,updatable:o,instance:a},s);var WC=(()=>{class n{constructor(t=!0,i=Ammo,r=null){if(this._useDeltaForWorldStep=t,this.bjsAMMO={},this.name="AmmoJSPlugin",this._timeStep=1/60,this._fixedTimeStep=1/60,this._maxSteps=5,this._tmpQuaternion=new Q,this._tmpContactCallbackResult=!1,this._tmpContactPoint=new m,this._tmpContactNormal=new m,this._tmpVec3=new m,this._tmpMatrix=new L,typeof i=="function"){P.Error("AmmoJS is not ready. Please make sure you await Ammo() before using the plugin.");return}else this.bjsAMMO=i;if(!this.isSupported()){P.Error("AmmoJS is not available. Please make sure you included the js file.");return}this._collisionConfiguration=new this.bjsAMMO.btSoftBodyRigidBodyCollisionConfiguration,this._dispatcher=new this.bjsAMMO.btCollisionDispatcher(this._collisionConfiguration),this._overlappingPairCache=r||new this.bjsAMMO.btDbvtBroadphase,this._solver=new this.bjsAMMO.btSequentialImpulseConstraintSolver,this._softBodySolver=new this.bjsAMMO.btDefaultSoftBodySolver,this.world=new this.bjsAMMO.btSoftRigidDynamicsWorld(this._dispatcher,this._overlappingPairCache,this._solver,this._collisionConfiguration,this._softBodySolver),this._tmpAmmoConcreteContactResultCallback=new this.bjsAMMO.ConcreteContactResultCallback,this._tmpAmmoConcreteContactResultCallback.addSingleResult=s=>{s=this.bjsAMMO.wrapPointer(s,this.bjsAMMO.btManifoldPoint);let o=s.getPositionWorldOnA(),a=s.m_normalWorldOnB;this._tmpContactPoint.x=o.x(),this._tmpContactPoint.y=o.y(),this._tmpContactPoint.z=o.z(),this._tmpContactNormal.x=a.x(),this._tmpContactNormal.y=a.y(),this._tmpContactNormal.z=a.z(),this._tmpContactImpulse=s.getAppliedImpulse(),this._tmpContactDistance=s.getDistance(),this._tmpContactCallbackResult=!0},this._raycastResult=new Qs,this._tmpAmmoTransform=new this.bjsAMMO.btTransform,this._tmpAmmoTransform.setIdentity(),this._tmpAmmoQuaternion=new this.bjsAMMO.btQuaternion(0,0,0,1),this._tmpAmmoVectorA=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorB=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorC=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorD=new this.bjsAMMO.btVector3(0,0,0)}getPluginVersion(){return 1}setGravity(t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),this.world.setGravity(this._tmpAmmoVectorA),this.world.getWorldInfo().set_m_gravity(this._tmpAmmoVectorA)}setTimeStep(t){this._timeStep=t}setFixedTimeStep(t){this._fixedTimeStep=t}setMaxSteps(t){this._maxSteps=t}getTimeStep(){return this._timeStep}_isImpostorInContact(t){return this._tmpContactCallbackResult=!1,this.world.contactTest(t.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_isImpostorPairInContact(t,i){return this._tmpContactCallbackResult=!1,this.world.contactPairTest(t.physicsBody,i.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_stepSimulation(t=1/60,i=10,r=1/60){if(i==0)this.world.stepSimulation(t,0);else for(;i>0&&t>0;)t-r<r?(this.world.stepSimulation(t,0),t=0):(t-=r,this.world.stepSimulation(r,0)),i--}executeStep(t,i){for(let r of i)r.soft||r.beforeStep();this._stepSimulation(this._useDeltaForWorldStep?t:this._timeStep,this._maxSteps,this._fixedTimeStep);for(let r of i)if(r.soft?this._afterSoftStep(r):r.afterStep(),r._onPhysicsCollideCallbacks.length>0&&this._isImpostorInContact(r))for(let s of r._onPhysicsCollideCallbacks)for(let o of s.otherImpostors)(r.physicsBody.isActive()||o.physicsBody.isActive())&&this._isImpostorPairInContact(r,o)&&(r.onCollide({body:o.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}),o.onCollide({body:r.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}))}_afterSoftStep(t){t.type===Te.RopeImpostor?this._ropeStep(t):this._softbodyOrClothStep(t)}_ropeStep(t){let i=t.physicsBody.get_m_nodes(),r=i.size(),s,o,a,l,c,u=[];for(let f=0;f<r;f++)s=i.at(f),o=s.get_m_x(),a=o.x(),l=o.y(),c=o.z(),u.push(new m(a,l,c));let h=t.object,d=t.getParam("shape");t._isFromLine?t.object=na("lines",{points:u,instance:h}):t.object=sh("ext",{shape:d,path:u,instance:h})}_softbodyOrClothStep(t){let i=t.type===Te.ClothImpostor?1:-1,r=t.object,s=r.getVerticesData(T.PositionKind);s||(s=[]);let o=r.getVerticesData(T.NormalKind);o||(o=[]);let a=s.length/3,l=t.physicsBody.get_m_nodes(),c,u,h,d,f,p,g,_;for(let b=0;b<a;b++){c=l.at(b),u=c.get_m_x(),h=u.x(),d=u.y(),f=u.z()*i;let A=c.get_m_n();p=A.x(),g=A.y(),_=A.z()*i,s[3*b]=h,s[3*b+1]=d,s[3*b+2]=f,o[3*b]=p,o[3*b+1]=g,o[3*b+2]=_}let y=new K;y.positions=s,y.normals=o,y.uvs=r.getVerticesData(T.UVKind),y.colors=r.getVerticesData(T.ColorKind),r&&r.getIndices&&(y.indices=r.getIndices()),y.applyToMesh(r)}applyImpulse(t,i,r){if(t.soft)P.Warn("Cannot be applied to a soft body");else{t.physicsBody.activate();let s=this._tmpAmmoVectorA,o=this._tmpAmmoVectorB;t.object&&t.object.getWorldMatrix&&r.subtractInPlace(t.object.getWorldMatrix().getTranslation()),s.setValue(r.x,r.y,r.z),o.setValue(i.x,i.y,i.z),t.physicsBody.applyImpulse(o,s)}}applyForce(t,i,r){if(t.soft)P.Warn("Cannot be applied to a soft body");else{t.physicsBody.activate();let s=this._tmpAmmoVectorA,o=this._tmpAmmoVectorB;if(t.object&&t.object.getWorldMatrix){let a=t.object.getWorldMatrix().getTranslation();s.setValue(r.x-a.x,r.y-a.y,r.z-a.z)}else s.setValue(r.x,r.y,r.z);o.setValue(i.x,i.y,i.z),t.physicsBody.applyForce(o,s)}}generatePhysicsBody(t){if(t._pluginData.toDispose=[],t.parent){t.physicsBody&&(this.removePhysicsBody(t),t.forceUpdate());return}if(t.isBodyInitRequired()){let i=this._createShape(t),r=t.getParam("mass");if(t._pluginData.mass=r,t.soft)i.get_m_cfg().set_collisions(17),i.get_m_cfg().set_kDP(t.getParam("damping")),this.bjsAMMO.castObject(i,this.bjsAMMO.btCollisionObject).getCollisionShape().setMargin(t.getParam("margin")),i.setActivationState(n._DISABLE_DEACTIVATION_FLAG),this.world.addSoftBody(i,1,-1),t.physicsBody=i,t._pluginData.toDispose.push(i),this.setBodyPressure(t,0),t.type===Te.SoftbodyImpostor&&this.setBodyPressure(t,t.getParam("pressure")),this.setBodyStiffness(t,t.getParam("stiffness")),this.setBodyVelocityIterations(t,t.getParam("velocityIterations")),this.setBodyPositionIterations(t,t.getParam("positionIterations"));else{let s=new this.bjsAMMO.btVector3(0,0,0),o=new this.bjsAMMO.btTransform;t.object.computeWorldMatrix(!0),o.setIdentity(),r!==0&&i.calculateLocalInertia(r,s),this._tmpAmmoVectorA.setValue(t.object.position.x,t.object.position.y,t.object.position.z),this._tmpAmmoQuaternion.setValue(t.object.rotationQuaternion.x,t.object.rotationQuaternion.y,t.object.rotationQuaternion.z,t.object.rotationQuaternion.w),o.setOrigin(this._tmpAmmoVectorA),o.setRotation(this._tmpAmmoQuaternion);let a=new this.bjsAMMO.btDefaultMotionState(o),l=new this.bjsAMMO.btRigidBodyConstructionInfo(r,a,i,s),c=new this.bjsAMMO.btRigidBody(l);if(r===0&&(c.setCollisionFlags(c.getCollisionFlags()|n._KINEMATIC_FLAG),c.setActivationState(n._DISABLE_DEACTIVATION_FLAG)),t.type==Te.NoImpostor&&!i.getChildShape&&c.setCollisionFlags(c.getCollisionFlags()|n._DISABLE_COLLISION_FLAG),t.type!==Te.MeshImpostor&&t.type!==Te.NoImpostor){let d=t.object.getBoundingInfo();this._tmpVec3.copyFrom(t.object.getAbsolutePosition()),this._tmpVec3.subtractInPlace(d.boundingBox.centerWorld),this._tmpVec3.x/=t.object.scaling.x,this._tmpVec3.y/=t.object.scaling.y,this._tmpVec3.z/=t.object.scaling.z,t.setDeltaPosition(this._tmpVec3)}let u=t.getParam("group"),h=t.getParam("mask");u&&h?this.world.addRigidBody(c,u,h):this.world.addRigidBody(c),t.physicsBody=c,t._pluginData.toDispose=t._pluginData.toDispose.concat([c,l,a,o,s,i])}this.setBodyRestitution(t,t.getParam("restitution")),this.setBodyFriction(t,t.getParam("friction"))}}removePhysicsBody(t){if(this.world&&(t.soft?this.world.removeSoftBody(t.physicsBody):this.world.removeRigidBody(t.physicsBody),t._pluginData)){for(let i of t._pluginData.toDispose)this.bjsAMMO.destroy(i);t._pluginData.toDispose=[]}}generateJoint(t){let i=t.mainImpostor.physicsBody,r=t.connectedImpostor.physicsBody;if(!i||!r||t.joint.physicsJoint)return;let s=t.joint.jointData;s.mainPivot||(s.mainPivot=new m(0,0,0)),s.connectedPivot||(s.connectedPivot=new m(0,0,0));let o;switch(t.joint.type){case Ze.DistanceJoint:{let a=s.maxDistance;a&&(s.mainPivot=new m(0,-a/2,0),s.connectedPivot=new m(0,a/2,0));let l=this._tmpAmmoVectorA;l.setValue(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z);let c=this._tmpAmmoVectorB;c.setValue(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z),o=new this.bjsAMMO.btPoint2PointConstraint(i,r,l,c);break}case Ze.HingeJoint:{s.mainAxis||(s.mainAxis=new m(0,0,0)),s.connectedAxis||(s.connectedAxis=new m(0,0,0));let a=this._tmpAmmoVectorA;a.setValue(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z);let l=this._tmpAmmoVectorB;l.setValue(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z);let c=this._tmpAmmoVectorC;c.setValue(s.mainAxis.x,s.mainAxis.y,s.mainAxis.z);let u=this._tmpAmmoVectorD;u.setValue(s.connectedAxis.x,s.connectedAxis.y,s.connectedAxis.z),o=new this.bjsAMMO.btHingeConstraint(i,r,a,l,c,u);break}case Ze.BallAndSocketJoint:{let a=this._tmpAmmoVectorA;a.setValue(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z);let l=this._tmpAmmoVectorB;l.setValue(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z),o=new this.bjsAMMO.btPoint2PointConstraint(i,r,a,l);break}default:{P.Warn("JointType not currently supported by the Ammo plugin, falling back to PhysicsJoint.BallAndSocketJoint");let a=this._tmpAmmoVectorA;a.setValue(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z);let l=this._tmpAmmoVectorB;l.setValue(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z),o=new this.bjsAMMO.btPoint2PointConstraint(i,r,a,l);break}}this.world.addConstraint(o,!t.joint.jointData.collision),t.joint.physicsJoint=o}removeJoint(t){this.world&&this.world.removeConstraint(t.joint.physicsJoint),this.bjsAMMO.destroy(t.joint.physicsJoint)}_addMeshVerts(t,i,r){let s=0;if(r&&r.getIndices&&r.getWorldMatrix&&r.getChildMeshes){let o=r.getIndices();o||(o=[]);let a=r.getVerticesData(T.PositionKind);a||(a=[]);let l;if(i&&i!==r){let h;i.rotationQuaternion?h=i.rotationQuaternion:i.rotation?h=Q.FromEulerAngles(i.rotation.x,i.rotation.y,i.rotation.z):h=Q.Identity(),L.Compose(m.One(),h,i.position).invertToRef(this._tmpMatrix),l=r.computeWorldMatrix(!1).multiply(this._tmpMatrix)}else L.ScalingToRef(r.scaling.x,r.scaling.y,r.scaling.z,this._tmpMatrix),l=this._tmpMatrix;let c=o.length/3;for(let h=0;h<c;h++){let d=[];for(let f=0;f<3;f++){let p=new m(a[o[h*3+f]*3+0],a[o[h*3+f]*3+1],a[o[h*3+f]*3+2]);p=m.TransformCoordinates(p,l);let g;f==0?g=this._tmpAmmoVectorA:f==1?g=this._tmpAmmoVectorB:g=this._tmpAmmoVectorC,g.setValue(p.x,p.y,p.z),d.push(g)}t.addTriangle(d[0],d[1],d[2]),s++}let u=r.getChildMeshes();for(let h of u)s+=this._addMeshVerts(t,i,h)}return s}_softVertexData(t){let i=t.object;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let r=i.getIndices();r||(r=[]);let s=i.getVerticesData(T.PositionKind);s||(s=[]);let o=i.getVerticesData(T.NormalKind);o||(o=[]),i.computeWorldMatrix(!1);let a=[],l=[];for(let u=0;u<s.length;u+=3){let h=new m(s[u],s[u+1],s[u+2]),d=new m(o[u],o[u+1],o[u+2]);h=m.TransformCoordinates(h,i.getWorldMatrix()),d=m.TransformNormal(d,i.getWorldMatrix()),a.push(h.x,h.y,h.z),l.push(d.x,d.y,d.z)}let c=new K;return c.positions=a,c.normals=l,c.uvs=i.getVerticesData(T.UVKind),c.colors=i.getVerticesData(T.ColorKind),i&&i.getIndices&&(c.indices=i.getIndices()),c.applyToMesh(i),i.position=m.Zero(),i.rotationQuaternion=null,i.rotation=m.Zero(),i.computeWorldMatrix(!0),c}return K.ExtractFromMesh(i)}_createSoftbody(t){let i=t.object;if(i&&i.getIndices){let r=i.getIndices();r||(r=[]);let s=this._softVertexData(t),o=s.positions,a=s.normals;if(o===null||a===null)return new this.bjsAMMO.btCompoundShape;{let l=[],c=[];for(let g=0;g<o.length;g+=3){let _=new m(o[g],o[g+1],o[g+2]),y=new m(a[g],a[g+1],a[g+2]);l.push(_.x,_.y,-_.z),c.push(y.x,y.y,-y.z)}let u=new this.bjsAMMO.btSoftBodyHelpers().CreateFromTriMesh(this.world.getWorldInfo(),l,i.getIndices(),r.length/3,!0),h=o.length/3,d=u.get_m_nodes(),f,p;for(let g=0;g<h;g++)f=d.at(g),p=f.get_m_n(),p.setX(c[3*g]),p.setY(c[3*g+1]),p.setZ(c[3*g+2]);return u}}}_createCloth(t){let i=t.object;if(i&&i.getIndices){let r=i.getIndices();r||(r=[]);let s=this._softVertexData(t),o=s.positions,a=s.normals;if(o===null||a===null)return new this.bjsAMMO.btCompoundShape;{let l=o.length,c=Math.sqrt(l/3);t.segments=c;let u=c-1;return this._tmpAmmoVectorA.setValue(o[0],o[1],o[2]),this._tmpAmmoVectorB.setValue(o[3*u],o[3*u+1],o[3*u+2]),this._tmpAmmoVectorD.setValue(o[l-3],o[l-2],o[l-1]),this._tmpAmmoVectorC.setValue(o[l-3-3*u],o[l-2-3*u],o[l-1-3*u]),new this.bjsAMMO.btSoftBodyHelpers().CreatePatch(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,this._tmpAmmoVectorC,this._tmpAmmoVectorD,c,c,t.getParam("fixedPoints"),!0)}}}_createRope(t){let i,r,s=this._softVertexData(t),o=s.positions,a=s.normals;if(o===null||a===null)return new this.bjsAMMO.btCompoundShape;s.applyToMesh(t.object,!0),t._isFromLine=!0;let l=a.map(f=>f*f),c=(f,p)=>f+p;if(l.reduce(c)===0)i=o.length,r=i/3-1,this._tmpAmmoVectorA.setValue(o[0],o[1],o[2]),this._tmpAmmoVectorB.setValue(o[i-3],o[i-2],o[i-1]);else{t._isFromLine=!1;let f=t.getParam("path");if(t.getParam("shape")===null)return P.Warn("No shape available for extruded mesh"),new this.bjsAMMO.btCompoundShape;i=f.length,r=i-1,this._tmpAmmoVectorA.setValue(f[0].x,f[0].y,f[0].z),this._tmpAmmoVectorB.setValue(f[i-1].x,f[i-1].y,f[i-1].z)}t.segments=r;let h=t.getParam("fixedPoints");h=h>3?3:h;let d=new this.bjsAMMO.btSoftBodyHelpers().CreateRope(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,r-1,h);return d.get_m_cfg().set_collisions(17),d}_createCustom(t){let i=null;return this.onCreateCustomShape&&(i=this.onCreateCustomShape(t)),i==null&&(i=new this.bjsAMMO.btCompoundShape),i}_addHullVerts(t,i,r){let s=0;if(r&&r.getIndices&&r.getWorldMatrix&&r.getChildMeshes){let o=r.getIndices();o||(o=[]);let a=r.getVerticesData(T.PositionKind);a||(a=[]),r.computeWorldMatrix(!1);let l=o.length/3;for(let u=0;u<l;u++){let h=[];for(let d=0;d<3;d++){let f=new m(a[o[u*3+d]*3+0],a[o[u*3+d]*3+1],a[o[u*3+d]*3+2]);L.ScalingToRef(r.scaling.x,r.scaling.y,r.scaling.z,this._tmpMatrix),f=m.TransformCoordinates(f,this._tmpMatrix);let p;d==0?p=this._tmpAmmoVectorA:d==1?p=this._tmpAmmoVectorB:p=this._tmpAmmoVectorC,p.setValue(f.x,f.y,f.z),h.push(p)}t.addPoint(h[0],!0),t.addPoint(h[1],!0),t.addPoint(h[2],!0),s++}let c=r.getChildMeshes();for(let u of c)s+=this._addHullVerts(t,i,u)}return s}_createShape(t,i=!1){let r=t.object,s,o=t.getObjectExtents();if(!i){let a=t.object.getChildMeshes?t.object.getChildMeshes(!0):[];s=new this.bjsAMMO.btCompoundShape;let l=0;for(let c of a){let u=c.getPhysicsImpostor();if(u){if(u.type==Te.MeshImpostor)throw"A child MeshImpostor is not supported. Only primitive impostors are supported as children (eg. box or sphere)";let h=this._createShape(u),d=c.parent.getWorldMatrix().clone(),f=new m;d.decompose(f),this._tmpAmmoTransform.getOrigin().setValue(c.position.x*f.x,c.position.y*f.y,c.position.z*f.z),this._tmpAmmoQuaternion.setValue(c.rotationQuaternion.x,c.rotationQuaternion.y,c.rotationQuaternion.z,c.rotationQuaternion.w),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),s.addChildShape(this._tmpAmmoTransform,h),u.dispose(),l++}}if(l>0){if(t.type!=Te.NoImpostor){let c=this._createShape(t,!0);c&&(this._tmpAmmoTransform.getOrigin().setValue(0,0,0),this._tmpAmmoQuaternion.setValue(0,0,0,1),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),s.addChildShape(this._tmpAmmoTransform,c))}return s}else this.bjsAMMO.destroy(s),s=null}switch(t.type){case Te.SphereImpostor:if(jg(o.x,o.y,1e-4)&&jg(o.x,o.z,1e-4))s=new this.bjsAMMO.btSphereShape(o.x/2);else{this._tmpAmmoVectorA.setValue(0,0,0);let a=[this._tmpAmmoVectorA],l=[1];s=new this.bjsAMMO.btMultiSphereShape(a,l,1),this._tmpAmmoVectorA.setValue(o.x/2,o.y/2,o.z/2),s.setLocalScaling(this._tmpAmmoVectorA)}break;case Te.CapsuleImpostor:{let a=o.x/2;s=new this.bjsAMMO.btCapsuleShape(a,o.y-a*2)}break;case Te.CylinderImpostor:this._tmpAmmoVectorA.setValue(o.x/2,o.y/2,o.z/2),s=new this.bjsAMMO.btCylinderShape(this._tmpAmmoVectorA);break;case Te.PlaneImpostor:case Te.BoxImpostor:this._tmpAmmoVectorA.setValue(o.x/2,o.y/2,o.z/2),s=new this.bjsAMMO.btBoxShape(this._tmpAmmoVectorA);break;case Te.MeshImpostor:if(t.getParam("mass")==0){if(this.onCreateCustomMeshImpostor)s=this.onCreateCustomMeshImpostor(t);else{let a=new this.bjsAMMO.btTriangleMesh;t._pluginData.toDispose.push(a),this._addMeshVerts(a,r,r)==0?s=new this.bjsAMMO.btCompoundShape:s=new this.bjsAMMO.btBvhTriangleMeshShape(a)}break}case Te.ConvexHullImpostor:{if(this.onCreateCustomConvexHullImpostor)s=this.onCreateCustomConvexHullImpostor(t);else{let a=new this.bjsAMMO.btConvexHullShape;this._addHullVerts(a,r,r)==0?(t._pluginData.toDispose.push(a),s=new this.bjsAMMO.btCompoundShape):s=a}break}case Te.NoImpostor:s=new this.bjsAMMO.btSphereShape(o.x/2);break;case Te.CustomImpostor:s=this._createCustom(t);break;case Te.SoftbodyImpostor:s=this._createSoftbody(t);break;case Te.ClothImpostor:s=this._createCloth(t);break;case Te.RopeImpostor:s=this._createRope(t);break;default:P.Warn("The impostor type is not currently supported by the ammo plugin.");break}return s}setTransformationFromPhysicsBody(t){t.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),t.object.position.set(this._tmpAmmoTransform.getOrigin().x(),this._tmpAmmoTransform.getOrigin().y(),this._tmpAmmoTransform.getOrigin().z()),t.object.rotationQuaternion?t.object.rotationQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()):t.object.rotation&&(this._tmpQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()),this._tmpQuaternion.toEulerAnglesToRef(t.object.rotation))}setPhysicsBodyTransformation(t,i,r){let s=t.physicsBody.getWorldTransform();if(Math.abs(s.getOrigin().x()-i.x)>tt||Math.abs(s.getOrigin().y()-i.y)>tt||Math.abs(s.getOrigin().z()-i.z)>tt||Math.abs(s.getRotation().x()-r.x)>tt||Math.abs(s.getRotation().y()-r.y)>tt||Math.abs(s.getRotation().z()-r.z)>tt||Math.abs(s.getRotation().w()-r.w)>tt)if(this._tmpAmmoVectorA.setValue(i.x,i.y,i.z),s.setOrigin(this._tmpAmmoVectorA),this._tmpAmmoQuaternion.setValue(r.x,r.y,r.z,r.w),s.setRotation(this._tmpAmmoQuaternion),t.physicsBody.setWorldTransform(s),t.mass==0){let o=t.physicsBody.getMotionState();o&&o.setWorldTransform(s)}else t.physicsBody.activate()}isSupported(){return this.bjsAMMO!==void 0}setLinearVelocity(t,i){this._tmpAmmoVectorA.setValue(i.x,i.y,i.z),t.soft?t.physicsBody.linearVelocity(this._tmpAmmoVectorA):t.physicsBody.setLinearVelocity(this._tmpAmmoVectorA)}setAngularVelocity(t,i){this._tmpAmmoVectorA.setValue(i.x,i.y,i.z),t.soft?t.physicsBody.angularVelocity(this._tmpAmmoVectorA):t.physicsBody.setAngularVelocity(this._tmpAmmoVectorA)}getLinearVelocity(t){let i;if(t.soft?i=t.physicsBody.linearVelocity():i=t.physicsBody.getLinearVelocity(),!i)return null;let r=new m(i.x(),i.y(),i.z());return this.bjsAMMO.destroy(i),r}getAngularVelocity(t){let i;if(t.soft?i=t.physicsBody.angularVelocity():i=t.physicsBody.getAngularVelocity(),!i)return null;let r=new m(i.x(),i.y(),i.z());return this.bjsAMMO.destroy(i),r}setBodyMass(t,i){t.soft?t.physicsBody.setTotalMass(i,!1):t.physicsBody.setMassProps(i),t._pluginData.mass=i}getBodyMass(t){return t._pluginData.mass||0}getBodyFriction(t){return t._pluginData.friction||0}setBodyFriction(t,i){t.soft?t.physicsBody.get_m_cfg().set_kDF(i):t.physicsBody.setFriction(i),t._pluginData.friction=i}getBodyRestitution(t){return t._pluginData.restitution||0}setBodyRestitution(t,i){t.physicsBody.setRestitution(i),t._pluginData.restitution=i}getBodyPressure(t){return t.soft?t._pluginData.pressure||0:(P.Warn("Pressure is not a property of a rigid body"),0)}setBodyPressure(t,i){t.soft?t.type===Te.SoftbodyImpostor?(t.physicsBody.get_m_cfg().set_kPR(i),t._pluginData.pressure=i):(t.physicsBody.get_m_cfg().set_kPR(0),t._pluginData.pressure=0):P.Warn("Pressure can only be applied to a softbody")}getBodyStiffness(t){return t.soft?t._pluginData.stiffness||0:(P.Warn("Stiffness is not a property of a rigid body"),0)}setBodyStiffness(t,i){t.soft?(i=i<0?0:i,i=i>1?1:i,t.physicsBody.get_m_materials().at(0).set_m_kLST(i),t._pluginData.stiffness=i):P.Warn("Stiffness cannot be applied to a rigid body")}getBodyVelocityIterations(t){return t.soft?t._pluginData.velocityIterations||0:(P.Warn("Velocity iterations is not a property of a rigid body"),0)}setBodyVelocityIterations(t,i){t.soft?(i=i<0?0:i,t.physicsBody.get_m_cfg().set_viterations(i),t._pluginData.velocityIterations=i):P.Warn("Velocity iterations cannot be applied to a rigid body")}getBodyPositionIterations(t){return t.soft?t._pluginData.positionIterations||0:(P.Warn("Position iterations is not a property of a rigid body"),0)}setBodyPositionIterations(t,i){t.soft?(i=i<0?0:i,t.physicsBody.get_m_cfg().set_piterations(i),t._pluginData.positionIterations=i):P.Warn("Position iterations cannot be applied to a rigid body")}appendAnchor(t,i,r,s,o=1,a=!1){let l=t.segments,c=Math.round((l-1)*r),u=Math.round((l-1)*s),h=l-1-u,d=c+l*h;t.physicsBody.appendAnchor(d,i.physicsBody,a,o)}appendHook(t,i,r,s=1,o=!1){let a=Math.round(t.segments*r);t.physicsBody.appendAnchor(a,i.physicsBody,o,s)}sleepBody(t){t.physicsBody.forceActivationState(0)}wakeUpBody(t){t.physicsBody.activate()}updateDistanceJoint(){P.Warn("updateDistanceJoint is not currently supported by the Ammo physics plugin")}setMotor(t,i,r){t.physicsJoint.enableAngularMotor(!0,i,r)}setLimit(){P.Warn("setLimit is not currently supported by the Ammo physics plugin")}syncMeshWithImpostor(t,i){i.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),t.position.x=this._tmpAmmoTransform.getOrigin().x(),t.position.y=this._tmpAmmoTransform.getOrigin().y(),t.position.z=this._tmpAmmoTransform.getOrigin().z(),t.rotationQuaternion&&(t.rotationQuaternion.x=this._tmpAmmoTransform.getRotation().x(),t.rotationQuaternion.y=this._tmpAmmoTransform.getRotation().y(),t.rotationQuaternion.z=this._tmpAmmoTransform.getRotation().z(),t.rotationQuaternion.w=this._tmpAmmoTransform.getRotation().w())}getRadius(t){return t.getObjectExtents().x/2}getBoxSizeToRef(t,i){let r=t.getObjectExtents();i.x=r.x,i.y=r.y,i.z=r.z}dispose(){this.bjsAMMO.destroy(this.world),this.bjsAMMO.destroy(this._softBodySolver),this.bjsAMMO.destroy(this._solver),this.bjsAMMO.destroy(this._overlappingPairCache),this.bjsAMMO.destroy(this._dispatcher),this.bjsAMMO.destroy(this._collisionConfiguration),this.bjsAMMO.destroy(this._tmpAmmoVectorA),this.bjsAMMO.destroy(this._tmpAmmoVectorB),this.bjsAMMO.destroy(this._tmpAmmoVectorC),this.bjsAMMO.destroy(this._tmpAmmoVectorD),this.bjsAMMO.destroy(this._tmpAmmoTransform),this.bjsAMMO.destroy(this._tmpAmmoQuaternion),this.bjsAMMO.destroy(this._tmpAmmoConcreteContactResultCallback),this.world=null}raycast(t,i){return this.raycastToRef(t,i,this._raycastResult),this._raycastResult}raycastToRef(t,i,r){this._tmpAmmoVectorRCA=new this.bjsAMMO.btVector3(t.x,t.y,t.z),this._tmpAmmoVectorRCB=new this.bjsAMMO.btVector3(i.x,i.y,i.z);let s=new this.bjsAMMO.ClosestRayResultCallback(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB);this.world.rayTest(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB,s),r.reset(t,i),s.hasHit()&&(r.setHitData({x:s.get_m_hitNormalWorld().x(),y:s.get_m_hitNormalWorld().y(),z:s.get_m_hitNormalWorld().z()},{x:s.get_m_hitPointWorld().x(),y:s.get_m_hitPointWorld().y(),z:s.get_m_hitPointWorld().z()}),r.calculateHitDistance()),this.bjsAMMO.destroy(s),this.bjsAMMO.destroy(this._tmpAmmoVectorRCA),this.bjsAMMO.destroy(this._tmpAmmoVectorRCB)}}return n._DISABLE_COLLISION_FLAG=4,n._KINEMATIC_FLAG=2,n._DISABLE_DEACTIVATION_FLAG=4,n})();Ce.prototype.removeReflectionProbe=function(n){if(!this.reflectionProbes)return-1;let e=this.reflectionProbes.indexOf(n);return e!==-1&&this.reflectionProbes.splice(e,1),e};Ce.prototype.addReflectionProbe=function(n){this.reflectionProbes||(this.reflectionProbes=[]),this.reflectionProbes.push(n)};var Kl=class n{constructor(e,t,i,r=!0,s=!1,o=!1){if(this.name=e,this._viewMatrix=L.Identity(),this._target=m.Zero(),this._add=m.Zero(),this._invertYAxis=!1,this.position=m.Zero(),this.metadata=null,this._parentContainer=null,this._scene=i,i.getEngine().supportsUniformBuffers){this._sceneUBOs=[];for(let u=0;u<6;++u)this._sceneUBOs.push(i.createSceneUniformBuffer(`Scene for Reflection Probe (name "${e}") face #${u}`))}this._scene.reflectionProbes||(this._scene.reflectionProbes=[]),this._scene.reflectionProbes.push(this);let a=0;if(s){let u=this._scene.getEngine().getCaps();u.textureHalfFloatRender?a=2:u.textureFloatRender&&(a=1)}this._renderTargetTexture=new hi(e,t,i,r,!0,a,!0),this._renderTargetTexture.gammaSpace=!o,this._renderTargetTexture.invertZ=i.useRightHandedSystem;let l=i.getEngine().useReverseDepthBuffer;this._renderTargetTexture.onBeforeRenderObservable.add(u=>{switch(this._sceneUBOs&&(i.setSceneUniformBuffer(this._sceneUBOs[u]),i.getSceneUniformBuffer().unbindEffect()),u){case 0:this._add.copyFromFloats(1,0,0);break;case 1:this._add.copyFromFloats(-1,0,0);break;case 2:this._add.copyFromFloats(0,this._invertYAxis?1:-1,0);break;case 3:this._add.copyFromFloats(0,this._invertYAxis?-1:1,0);break;case 4:this._add.copyFromFloats(0,0,i.useRightHandedSystem?-1:1);break;case 5:this._add.copyFromFloats(0,0,i.useRightHandedSystem?1:-1);break}this._attachedMesh&&this.position.copyFrom(this._attachedMesh.getAbsolutePosition()),this.position.addToRef(this._add,this._target);let h=i.useRightHandedSystem?L.LookAtRHToRef:L.LookAtLHToRef,d=i.useRightHandedSystem?L.PerspectiveFovRH:L.PerspectiveFovLH;h(this.position,this._target,m.Up(),this._viewMatrix),i.activeCamera&&(this._projectionMatrix=d(Math.PI/2,1,l?i.activeCamera.maxZ:i.activeCamera.minZ,l?i.activeCamera.minZ:i.activeCamera.maxZ,this._scene.getEngine().isNDCHalfZRange),i.setTransformMatrix(this._viewMatrix,this._projectionMatrix),i.activeCamera.isRigCamera&&!this._renderTargetTexture.activeCamera&&(this._renderTargetTexture.activeCamera=i.activeCamera.rigParent||null)),i._forcedViewPosition=this.position});let c;this._renderTargetTexture.onBeforeBindObservable.add(()=>{this._currentSceneUBO=i.getSceneUniformBuffer(),i.getEngine()._debugPushGroup?.(`reflection probe generation for ${e}`,1),c=this._scene.imageProcessingConfiguration.applyByPostProcess,o&&(i.imageProcessingConfiguration.applyByPostProcess=!0)}),this._renderTargetTexture.onAfterUnbindObservable.add(()=>{i.imageProcessingConfiguration.applyByPostProcess=c,i._forcedViewPosition=null,this._sceneUBOs&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(!0),i.getEngine()._debugPopGroup?.(1)})}get samples(){return this._renderTargetTexture.samples}set samples(e){this._renderTargetTexture.samples=e}get refreshRate(){return this._renderTargetTexture.refreshRate}set refreshRate(e){this._renderTargetTexture.refreshRate=e}getScene(){return this._scene}get cubeTexture(){return this._renderTargetTexture}get renderList(){return this._renderTargetTexture.renderList}set renderList(e){this._renderTargetTexture.renderList=e}attachToMesh(e){this._attachedMesh=e}setRenderingAutoClearDepthStencil(e,t){this._renderTargetTexture.setRenderingAutoClearDepthStencil(e,t)}dispose(){let e=this._scene.reflectionProbes.indexOf(this);if(e!==-1&&this._scene.reflectionProbes.splice(e,1),this._parentContainer){let t=this._parentContainer.reflectionProbes.indexOf(this);t>-1&&this._parentContainer.reflectionProbes.splice(t,1),this._parentContainer=null}if(this._renderTargetTexture&&(this._renderTargetTexture.dispose(),this._renderTargetTexture=null),this._sceneUBOs){for(let t of this._sceneUBOs)t.dispose();this._sceneUBOs=[]}}toString(e){let t="Name: "+this.name;return e&&(t+=", position: "+this.position.toString(),this._attachedMesh&&(t+=", attached mesh: "+this._attachedMesh.name)),t}getClassName(){return"ReflectionProbe"}serialize(){let e=je.Serialize(this,this._renderTargetTexture.serialize());return e.isReflectionProbe=!0,e.metadata=this.metadata,e}static Parse(e,t,i){let r=null;if(t.reflectionProbes)for(let s=0;s<t.reflectionProbes.length;s++){let o=t.reflectionProbes[s];if(o.name===e.name){r=o;break}}return r=je.Parse(()=>r||new n(e.name,e.renderTargetSize,t,e._generateMipMaps),e,t,i),r.cubeTexture._waitingRenderList=e.renderList,e._attachedMesh&&r.attachToMesh(t.getMeshById(e._attachedMesh)),e.metadata&&(r.metadata=e.metadata),r}};w([Aa()],Kl.prototype,"_attachedMesh",void 0);w([Jt()],Kl.prototype,"position",void 0);var og=class{get animationStarted(){return this._animationStarted}get fromIndex(){return this._fromIndex}get toIndex(){return this._toIndex}get loopAnimation(){return this._loopAnimation}get delay(){return Math.max(this._delay,1)}constructor(){this.width=1,this.height=1,this.angle=0,this.invertU=!1,this.invertV=!1,this.isVisible=!0,this._animationStarted=!1,this._loopAnimation=!1,this._fromIndex=0,this._toIndex=0,this._delay=0,this._direction=1,this._time=0,this._onBaseAnimationEnd=null,this.position={x:1,y:1,z:1},this.color={r:1,g:1,b:1,a:1}}playAnimation(e,t,i,r,s){this._fromIndex=e,this._toIndex=t,this._loopAnimation=i,this._delay=r||1,this._animationStarted=!0,this._onBaseAnimationEnd=s,e<t?this._direction=1:(this._direction=-1,this._toIndex=e,this._fromIndex=t),this.cellIndex=e,this._time=0}stopAnimation(){this._animationStarted=!1}_animate(e){this._animationStarted&&(this._time+=e,this._time>this._delay&&(this._time=this._time%this._delay,this.cellIndex+=this._direction,(this._direction>0&&this.cellIndex>this._toIndex||this._direction<0&&this.cellIndex<this._fromIndex)&&(this._loopAnimation?this.cellIndex=this._direction>0?this._fromIndex:this._toIndex:(this.cellIndex=this._toIndex,this._animationStarted=!1,this._onBaseAnimationEnd&&this._onBaseAnimationEnd()))))}};var ag=class n extends og{get size(){return this.width}set size(e){this.width=e,this.height=e}get manager(){return this._manager}constructor(e,t){super(),this.name=e,this.animations=new Array,this.isPickable=!1,this.useAlphaForPicking=!1,this.onDisposeObservable=new F,this._onAnimationEnd=null,this._endAnimation=()=>{this._onAnimationEnd&&this._onAnimationEnd(),this.disposeWhenFinishedAnimating&&this.dispose()},this.color=new ce(1,1,1,1),this.position=m.Zero(),this._manager=t,this._manager.sprites.push(this),this.uniqueId=this._manager.scene.getUniqueId()}getClassName(){return"Sprite"}get fromIndex(){return this._fromIndex}set fromIndex(e){this.playAnimation(e,this._toIndex,this._loopAnimation,this._delay,this._onAnimationEnd)}get toIndex(){return this._toIndex}set toIndex(e){this.playAnimation(this._fromIndex,e,this._loopAnimation,this._delay,this._onAnimationEnd)}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){this.playAnimation(this._fromIndex,this._toIndex,e,this._delay,this._onAnimationEnd)}get delay(){return Math.max(this._delay,1)}set delay(e){this.playAnimation(this._fromIndex,this._toIndex,this._loopAnimation,e,this._onAnimationEnd)}playAnimation(e,t,i,r,s=null){this._onAnimationEnd=s,super.playAnimation(e,t,i,r,this._endAnimation)}dispose(){for(let e=0;e<this._manager.sprites.length;e++)this._manager.sprites[e]==this&&this._manager.sprites.splice(e,1);this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}serialize(){let e={};return e.name=this.name,e.position=this.position.asArray(),e.color=this.color.asArray(),e.width=this.width,e.height=this.height,e.angle=this.angle,e.cellIndex=this.cellIndex,e.cellRef=this.cellRef,e.invertU=this.invertU,e.invertV=this.invertV,e.disposeWhenFinishedAnimating=this.disposeWhenFinishedAnimating,e.isPickable=this.isPickable,e.isVisible=this.isVisible,e.useAlphaForPicking=this.useAlphaForPicking,e.animationStarted=this.animationStarted,e.fromIndex=this.fromIndex,e.toIndex=this.toIndex,e.loopAnimation=this.loopAnimation,e.delay=this.delay,e}static Parse(e,t){let i=new n(e.name,t);return i.position=m.FromArray(e.position),i.color=ce.FromArray(e.color),i.width=e.width,i.height=e.height,i.angle=e.angle,i.cellIndex=e.cellIndex,i.cellRef=e.cellRef,i.invertU=e.invertU,i.invertV=e.invertV,i.disposeWhenFinishedAnimating=e.disposeWhenFinishedAnimating,i.isPickable=e.isPickable,i.isVisible=e.isVisible,i.useAlphaForPicking=e.useAlphaForPicking,i._fromIndex=e.fromIndex,i._toIndex=e.toIndex,i._loopAnimation=e.loopAnimation,i._delay=e.delay,e.animationStarted&&i.playAnimation(i.fromIndex,i.toIndex,i.loopAnimation,i.delay),i}};var lD={internalPickerForMesh:void 0},rt=class n{constructor(e,t,i=Number.MAX_VALUE,r=tt){this.origin=e,this.direction=t,this.length=i,this.epsilon=r}clone(){return new n(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,t,i=0){let r=n._TmpVector3[0].copyFromFloats(e.x-i,e.y-i,e.z-i),s=n._TmpVector3[1].copyFromFloats(t.x+i,t.y+i,t.z+i),o=0,a=Number.MAX_VALUE,l,c,u,h;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<r.x||this.origin.x>s.x)return!1}else if(l=1/this.direction.x,c=(r.x-this.origin.x)*l,u=(s.x-this.origin.x)*l,u===-1/0&&(u=1/0),c>u&&(h=c,c=u,u=h),o=Math.max(c,o),a=Math.min(u,a),o>a)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<r.y||this.origin.y>s.y)return!1}else if(l=1/this.direction.y,c=(r.y-this.origin.y)*l,u=(s.y-this.origin.y)*l,u===-1/0&&(u=1/0),c>u&&(h=c,c=u,u=h),o=Math.max(c,o),a=Math.min(u,a),o>a)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<r.z||this.origin.z>s.z)return!1}else if(l=1/this.direction.z,c=(r.z-this.origin.z)*l,u=(s.z-this.origin.z)*l,u===-1/0&&(u=1/0),c>u&&(h=c,c=u,u=h),o=Math.max(c,o),a=Math.min(u,a),o>a)return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){let i=e.center.x-this.origin.x,r=e.center.y-this.origin.y,s=e.center.z-this.origin.z,o=i*i+r*r+s*s,a=e.radius+t,l=a*a;if(o<=l)return!0;let c=i*this.direction.x+r*this.direction.y+s*this.direction.z;return c<0?!1:o-c*c<=l}intersectsTriangle(e,t,i){let r=n._TmpVector3[0],s=n._TmpVector3[1],o=n._TmpVector3[2],a=n._TmpVector3[3],l=n._TmpVector3[4];t.subtractToRef(e,r),i.subtractToRef(e,s),m.CrossToRef(this.direction,s,o);let c=m.Dot(r,o);if(c===0)return null;let u=1/c;this.origin.subtractToRef(e,a);let h=m.Dot(a,o)*u;if(h<-this.epsilon||h>1+this.epsilon)return null;m.CrossToRef(a,r,l);let d=m.Dot(this.direction,l)*u;if(d<-this.epsilon||h+d>1+this.epsilon)return null;let f=m.Dot(s,l)*u;return f>this.length||f<0?null:new m0(1-h-d,h,f)}intersectsPlane(e){let t,i=m.Dot(e.normal,this.direction);if(Math.abs(i)<999999997475243e-21)return null;{let r=m.Dot(e.normal,this.origin);return t=(-e.d-r)/i,t<0?t<-999999997475243e-21?null:0:t}}intersectsAxis(e,t=0){switch(e){case"y":{let i=(this.origin.y-t)/this.direction.y;return i>0?null:new m(this.origin.x+this.direction.x*-i,t,this.origin.z+this.direction.z*-i)}case"x":{let i=(this.origin.x-t)/this.direction.x;return i>0?null:new m(t,this.origin.y+this.direction.y*-i,this.origin.z+this.direction.z*-i)}case"z":{let i=(this.origin.z-t)/this.direction.z;return i>0?null:new m(this.origin.x+this.direction.x*-i,this.origin.y+this.direction.y*-i,t)}default:return null}}intersectsMesh(e,t,i,r=!1,s,o=!1){let a=k.Matrix[0];return e.getWorldMatrix().invertToRef(a),this._tmpRay?n.TransformToRef(this,a,this._tmpRay):this._tmpRay=n.Transform(this,a),e.intersects(this._tmpRay,t,i,r,s,o)}intersectsMeshes(e,t,i){i?i.length=0:i=[];for(let r=0;r<e.length;r++){let s=this.intersectsMesh(e[r],t);s.hit&&i.push(s)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}intersectionSegment(e,t,i){let r=this.origin,s=k.Vector3[0],o=k.Vector3[1],a=k.Vector3[2],l=k.Vector3[3];t.subtractToRef(e,s),this.direction.scaleToRef(n._Rayl,a),r.addToRef(a,o),e.subtractToRef(r,l);let c=m.Dot(s,s),u=m.Dot(s,a),h=m.Dot(a,a),d=m.Dot(s,l),f=m.Dot(a,l),p=c*h-u*u,g,_=p,y,b=p;p<n._Smallnum?(g=0,_=1,y=f,b=h):(g=u*f-h*d,y=c*f-u*d,g<0?(g=0,y=f,b=h):g>_&&(g=_,y=f+u,b=h)),y<0?(y=0,-d<0?g=0:-d>c?g=_:(g=-d,_=c)):y>b&&(y=b,-d+u<0?g=0:-d+u>c?g=_:(g=-d+u,_=c));let A=Math.abs(g)<n._Smallnum?0:g/_,I=Math.abs(y)<n._Smallnum?0:y/b,v=k.Vector3[4];a.scaleToRef(I,v);let x=k.Vector3[5];s.scaleToRef(A,x),x.addInPlace(l);let C=k.Vector3[6];return x.subtractToRef(v,C),I>0&&I<=this.length&&C.lengthSquared()<i*i?x.length():-1}update(e,t,i,r,s,o,a,l=!1){if(l){n._RayDistant||(n._RayDistant=n.Zero()),n._RayDistant.unprojectRayToRef(e,t,i,r,L.IdentityReadOnly,o,a);let c=k.Matrix[0];s.invertToRef(c),n.TransformToRef(n._RayDistant,c,this)}else this.unprojectRayToRef(e,t,i,r,s,o,a);return this}static Zero(){return new n(m.Zero(),m.Zero())}static CreateNew(e,t,i,r,s,o,a){return n.Zero().update(e,t,i,r,s,o,a)}static CreateNewFromTo(e,t,i=L.IdentityReadOnly){let r=new n(new m(0,0,0),new m(0,0,0));return n.CreateFromToToRef(e,t,r,i)}static CreateFromToToRef(e,t,i,r=L.IdentityReadOnly){i.origin.copyFrom(e);let s=t.subtractToRef(e,i.direction),o=Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z);return i.length=o,i.direction.normalize(),n.TransformToRef(i,r,i)}static Transform(e,t){let i=new n(new m(0,0,0),new m(0,0,0));return n.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){m.TransformCoordinatesToRef(e.origin,t,i.origin),m.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length,i.epsilon=e.epsilon;let r=i.direction,s=r.length();if(!(s===0||s===1)){let o=1/s;r.x*=o,r.y*=o,r.z*=o,i.length*=s}return i}unprojectRayToRef(e,t,i,r,s,o,a){let l=k.Matrix[0];s.multiplyToRef(o,l),l.multiplyToRef(a,l),l.invert();let c=ye.LastCreatedEngine,u=k.Vector3[0];u.x=e/i*2-1,u.y=-(t/r*2-1),u.z=c?.useReverseDepthBuffer?1:c?.isNDCHalfZRange?0:-1;let h=k.Vector3[1].copyFromFloats(u.x,u.y,1-1e-8),d=k.Vector3[2],f=k.Vector3[3];m.TransformCoordinatesToRef(u,l,d),m.TransformCoordinatesToRef(h,l,f),this.origin.copyFrom(d),f.subtractToRef(d,this.direction),this.direction.normalize()}};rt._TmpVector3=Rh(6,m.Zero);rt._RayDistant=rt.Zero();rt._Smallnum=1e-8;rt._Rayl=1e9;function lg(n,e,t,i,r,s=!1){let o=rt.Zero();return oh(n,e,t,i,o,r,s),o}function oh(n,e,t,i,r,s,o=!1,a=!1){let l=n.getEngine();if(!s&&!(s=n.activeCamera))return n;let c=s.viewport,u=l.getRenderHeight(),{x:h,y:d,width:f,height:p}=c.toGlobal(l.getRenderWidth(),u),g=1/l.getHardwareScalingLevel();return e=e*g-h,t=t*g-(u-d-p),r.update(e,t,f,p,i||L.IdentityReadOnly,o?L.IdentityReadOnly:s.getViewMatrix(),s.getProjectionMatrix(),a),n}function cg(n,e,t,i){let r=rt.Zero();return Xl(n,e,t,r,i),r}function Xl(n,e,t,i,r){if(!Ft)return n;let s=n.getEngine();if(!r&&!(r=n.activeCamera))throw new Error("Active camera not set");let o=r.viewport,a=s.getRenderHeight(),{x:l,y:c,width:u,height:h}=o.toGlobal(s.getRenderWidth(),a),d=L.Identity(),f=1/s.getHardwareScalingLevel();return e=e*f-l,t=t*f-(a-c-h),i.update(e,t,u,h,d,d,r.getProjectionMatrix()),n}function cD(n,e,t,i,r,s,o,a){let l=e(i,t.enableDistantPicking),c=t.intersects(l,r,o,s,i,a);return!c||!c.hit||!r&&n!=null&&c.distance>=n.distance?null:c}function $C(n,e,t,i,r,s){let o=null,a=!!(n.activeCameras&&n.activeCameras.length>1&&n.cameraToUseForPointers!==n.activeCamera),l=n.cameraToUseForPointers||n.activeCamera,c=lD.internalPickerForMesh||cD;for(let u=0;u<n.meshes.length;u++){let h=n.meshes[u];if(t){if(!t(h,-1))continue}else if(!h.isEnabled()||!h.isVisible||!h.isPickable)continue;let d=a&&h.isWorldMatrixCameraDependent(),f=h.computeWorldMatrix(d,l);if(h.hasThinInstances&&h.thinInstanceEnablePicking){let p=c(o,e,h,f,!0,!0,s);if(p){if(r)return p;let g=k.Matrix[1],_=h.thinInstanceGetWorldMatrices();for(let y=0;y<_.length;y++){if(t&&!t(h,y))continue;_[y].multiplyToRef(f,g);let A=c(o,e,h,g,i,r,s,!0);if(A&&(o=A,o.thinInstanceIndex=y,i))return o}}}else{let p=c(o,e,h,f,i,r,s);if(p&&(o=p,i))return o}}return o||new Ft}function uD(n,e,t,i){if(!Ft)return null;let r=[],s=!!(n.activeCameras&&n.activeCameras.length>1&&n.cameraToUseForPointers!==n.activeCamera),o=n.cameraToUseForPointers||n.activeCamera,a=lD.internalPickerForMesh||cD;for(let l=0;l<n.meshes.length;l++){let c=n.meshes[l];if(t){if(!t(c,-1))continue}else if(!c.isEnabled()||!c.isVisible||!c.isPickable)continue;let u=s&&c.isWorldMatrixCameraDependent(),h=c.computeWorldMatrix(u,o);if(c.hasThinInstances&&c.thinInstanceEnablePicking){if(a(null,e,c,h,!0,!0,i)){let f=k.Matrix[1],p=c.thinInstanceGetWorldMatrices();for(let g=0;g<p.length;g++){if(t&&!t(c,g))continue;p[g].multiplyToRef(h,f);let y=a(null,e,c,f,!1,!1,i,!0);y&&(y.thinInstanceIndex=g,r.push(y))}}}else{let d=a(null,e,c,h,!1,!1,i);d&&r.push(d)}}return r}function hD(n,e,t,i,r,s){if(!Ft)return null;let o=$C(n,a=>(n._tempPickingRay||(n._tempPickingRay=rt.Zero()),oh(n,e,t,a,n._tempPickingRay,s||null),n._tempPickingRay),i,r,!0);return o&&(o.ray=lg(n,e,t,L.Identity(),s||null)),o}function dD(n,e,t,i,r,s,o,a=!1){let l=$C(n,(c,u)=>(n._tempPickingRay||(n._tempPickingRay=rt.Zero()),oh(n,e,t,c,n._tempPickingRay,s||null,!1,u),n._tempPickingRay),i,r,!1,o);return l&&(l.ray=lg(n,e,t,L.Identity(),s||null)),l}function fD(n,e,t,i,r){let s=$C(n,o=>(n._pickWithRayInverseMatrix||(n._pickWithRayInverseMatrix=L.Identity()),o.invertToRef(n._pickWithRayInverseMatrix),n._cachedRayForTransform||(n._cachedRayForTransform=rt.Zero()),rt.TransformToRef(e,n._pickWithRayInverseMatrix,n._cachedRayForTransform),n._cachedRayForTransform),t,i,!1,r);return s&&(s.ray=e),s}function pD(n,e,t,i,r,s){return uD(n,o=>lg(n,e,t,o,r||null),i,s)}function mD(n,e,t,i){return uD(n,r=>(n._pickWithRayInverseMatrix||(n._pickWithRayInverseMatrix=L.Identity()),r.invertToRef(n._pickWithRayInverseMatrix),n._cachedRayForTransform||(n._cachedRayForTransform=rt.Zero()),rt.TransformToRef(e,n._pickWithRayInverseMatrix,n._cachedRayForTransform),n._cachedRayForTransform),t,i)}function aD(n,e,t=100,i,r){i||(i=n.getWorldMatrix()),e.length=t,r?e.origin.copyFrom(r):e.origin.copyFrom(n.position);let s=k.Vector3[2];s.set(0,0,n._scene.useRightHandedSystem?-1:1);let o=k.Vector3[3];return m.TransformNormalToRef(s,i,o),m.NormalizeToRef(o,e.direction),e}function gD(n,e){e&&(e.prototype.getForwardRay=function(t=100,i,r){return aD(this,new rt(m.Zero(),m.Zero(),t),t,i,r)},e.prototype.getForwardRayToRef=function(t,i=100,r,s){return aD(this,t,i,r,s)}),n&&(QT._IsPickingAvailable=!0,n.prototype.createPickingRay=function(t,i,r,s,o=!1){return lg(this,t,i,r,s,o)})}Object.defineProperty(Ce.prototype,"onNewSpriteManagerAddedObservable",{get:function(){if(!this.isDisposed&&!this._onNewSpriteManagerAddedObservable){let n=this._onNewSpriteManagerAddedObservable=new F;this.onDisposeObservable.addOnce(()=>n.clear())}return this._onNewSpriteManagerAddedObservable},enumerable:!0,configurable:!0});Object.defineProperty(Ce.prototype,"onSpriteManagerRemovedObservable",{get:function(){if(!this.isDisposed&&!this._onSpriteManagerRemovedObservable){let n=this._onSpriteManagerRemovedObservable=new F;this.onDisposeObservable.addOnce(()=>n.clear())}return this._onSpriteManagerRemovedObservable},enumerable:!0,configurable:!0});Ce.prototype._internalPickSprites=function(n,e,t,i){if(!Ft)return null;let r=null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}if(this.spriteManagers&&this.spriteManagers.length>0)for(let s=0;s<this.spriteManagers.length;s++){let o=this.spriteManagers[s];if(!o.isPickable)continue;let a=o.intersects(n,i,e,t);if(!(!a||!a.hit)&&!(!t&&r!=null&&a.distance>=r.distance)&&(r=a,t))break}return r||new Ft};Ce.prototype._internalMultiPickSprites=function(n,e,t){if(!Ft)return null;let i=[];if(!t){if(!this.activeCamera)return null;t=this.activeCamera}if(this.spriteManagers&&this.spriteManagers.length>0)for(let r=0;r<this.spriteManagers.length;r++){let s=this.spriteManagers[r];if(!s.isPickable)continue;let o=s.multiIntersects(n,t,e);o!==null&&(i=i.concat(o))}return i};Ce.prototype.pickSprite=function(n,e,t,i,r){if(!this._tempSpritePickingRay)return null;Xl(this,n,e,this._tempSpritePickingRay,r);let s=this._internalPickSprites(this._tempSpritePickingRay,t,i,r);return s&&(s.ray=cg(this,n,e,r)),s};Ce.prototype.pickSpriteWithRay=function(n,e,t,i){if(!this._tempSpritePickingRay)return null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}rt.TransformToRef(n,i.getViewMatrix(),this._tempSpritePickingRay);let r=this._internalPickSprites(this._tempSpritePickingRay,e,t,i);return r&&(r.ray=n),r};Ce.prototype.multiPickSprite=function(n,e,t,i){return Xl(this,n,e,this._tempSpritePickingRay,i),this._internalMultiPickSprites(this._tempSpritePickingRay,t,i)};Ce.prototype.multiPickSpriteWithRay=function(n,e,t){if(!this._tempSpritePickingRay)return null;if(!t){if(!this.activeCamera)return null;t=this.activeCamera}return rt.TransformToRef(n,t.getViewMatrix(),this._tempSpritePickingRay),this._internalMultiPickSprites(this._tempSpritePickingRay,e,t)};Ce.prototype.setPointerOverSprite=function(n){this._pointerOverSprite!==n&&(this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(10,Zn.CreateNewFromSprite(this._pointerOverSprite,this)),this._pointerOverSprite=n,this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(9,Zn.CreateNewFromSprite(this._pointerOverSprite,this)))};Ce.prototype.getPointerOverSprite=function(){return this._pointerOverSprite};var ug=class{constructor(e){this.name=Oe.NAME_SPRITE,this.scene=e,this.scene.spriteManagers=[],this.scene._tempSpritePickingRay=rt?rt.Zero():null,this.scene.onBeforeSpritesRenderingObservable=new F,this.scene.onAfterSpritesRenderingObservable=new F,this._spritePredicate=t=>t.actionManager?t.isPickable&&t.actionManager.hasPointerTriggers:!1}register(){this.scene._pointerMoveStage.registerStep(Oe.STEP_POINTERMOVE_SPRITE,this,this._pointerMove),this.scene._pointerDownStage.registerStep(Oe.STEP_POINTERDOWN_SPRITE,this,this._pointerDown),this.scene._pointerUpStage.registerStep(Oe.STEP_POINTERUP_SPRITE,this,this._pointerUp)}rebuild(){}dispose(){this.scene.onBeforeSpritesRenderingObservable.clear(),this.scene.onAfterSpritesRenderingObservable.clear();let e=this.scene.spriteManagers;if(e)for(;e.length;)e[0].dispose()}_pickSpriteButKeepRay(e,t,i,r,s){let o=this.scene.pickSprite(t,i,this._spritePredicate,r,s);return o&&(o.ray=e?e.ray:null),o}_pointerMove(e,t,i,r,s){let o=this.scene;return r?o.setPointerOverSprite(null):(i=this._pickSpriteButKeepRay(i,e,t,!1,o.cameraToUseForPointers||void 0),i&&i.hit&&i.pickedSprite?(o.setPointerOverSprite(i.pickedSprite),!o.doNotHandleCursors&&s&&(o._pointerOverSprite&&o._pointerOverSprite.actionManager&&o._pointerOverSprite.actionManager.hoverCursor?s.style.cursor=o._pointerOverSprite.actionManager.hoverCursor:s.style.cursor=o.hoverCursor)):o.setPointerOverSprite(null)),i}_pointerDown(e,t,i,r){let s=this.scene;if(s._pickedDownSprite=null,s.spriteManagers&&s.spriteManagers.length>0&&(i=s.pickSprite(e,t,this._spritePredicate,!1,s.cameraToUseForPointers||void 0),i&&i.hit&&i.pickedSprite&&i.pickedSprite.actionManager)){switch(s._pickedDownSprite=i.pickedSprite,r.button){case 0:i.pickedSprite.actionManager.processTrigger(2,Zn.CreateNewFromSprite(i.pickedSprite,s,r));break;case 1:i.pickedSprite.actionManager.processTrigger(4,Zn.CreateNewFromSprite(i.pickedSprite,s,r));break;case 2:i.pickedSprite.actionManager.processTrigger(3,Zn.CreateNewFromSprite(i.pickedSprite,s,r));break}i.pickedSprite.actionManager&&i.pickedSprite.actionManager.processTrigger(5,Zn.CreateNewFromSprite(i.pickedSprite,s,r))}return i}_pointerUp(e,t,i,r,s){let o=this.scene;if(o.spriteManagers&&o.spriteManagers.length>0){let a=o.pickSprite(e,t,this._spritePredicate,!1,o.cameraToUseForPointers||void 0);a&&(a.hit&&a.pickedSprite&&a.pickedSprite.actionManager&&(a.pickedSprite.actionManager.processTrigger(7,Zn.CreateNewFromSprite(a.pickedSprite,o,r)),a.pickedSprite.actionManager&&(this.scene._inputManager._isPointerSwiping()||a.pickedSprite.actionManager.processTrigger(1,Zn.CreateNewFromSprite(a.pickedSprite,o,r)),s&&a.pickedSprite.actionManager.processTrigger(6,Zn.CreateNewFromSprite(a.pickedSprite,o,r)))),o._pickedDownSprite&&o._pickedDownSprite.actionManager&&o._pickedDownSprite!==a.pickedSprite&&o._pickedDownSprite.actionManager.processTrigger(16,Zn.CreateNewFromSprite(o._pickedDownSprite,o,r)))}return i}};var _D=(()=>{class n{get fogEnabled(){return this._fogEnabled}set fogEnabled(t){this._fogEnabled!==t&&(this._fogEnabled=t,this._createEffects())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(t){let i=!!this._scene?.getEngine().getCaps().fragmentDepthSupported;t&&!i&&P.Warn("Logarithmic depth has been requested for a sprite renderer on a device that doesn't support it."),this._useLogarithmicDepth=t&&i,this._createEffects()}get capacity(){return this._capacity}get pixelPerfect(){return this._pixelPerfect}set pixelPerfect(t){this._pixelPerfect!==t&&(this._pixelPerfect=t,this._createEffects())}get shaderLanguage(){return this._shaderLanguage}constructor(t,i,r=.01,s=null,o){this.blendMode=2,this.autoResetAlpha=!0,this.disableDepthWrite=!1,this._fogEnabled=!0,this._pixelPerfect=!1,this._shaderLanguage=0,this._useVAO=!1,this._useInstancing=!1,this._vertexBuffers={},this._isDisposed=!1,this._shadersLoaded=!1,this._pixelPerfect=o?.pixelPerfect??!1,this._capacity=i,this._epsilon=r,this._engine=t,this._useInstancing=t.getCaps().instancedArrays&&t._features.supportSpriteInstancing,this._useVAO=t.getCaps().vertexArrayObject&&!t.disableVertexArrayObjects,this._scene=s,this._useInstancing||this._buildIndexBuffer(),this._vertexBufferSize=this._useInstancing?16:18,this._vertexData=new Float32Array(i*this._vertexBufferSize*(this._useInstancing?1:4)),this._buffer=new ei(t,this._vertexData,!0,this._vertexBufferSize);let a=this._buffer.createVertexBuffer(T.PositionKind,0,4,this._vertexBufferSize,this._useInstancing),l=this._buffer.createVertexBuffer("options",4,2,this._vertexBufferSize,this._useInstancing),c=6,u;if(this._useInstancing){let p=new Float32Array([this._epsilon,this._epsilon,1-this._epsilon,this._epsilon,this._epsilon,1-this._epsilon,1-this._epsilon,1-this._epsilon]);this._spriteBuffer=new ei(t,p,!1,2),u=this._spriteBuffer.createVertexBuffer("offsets",0,2)}else u=this._buffer.createVertexBuffer("offsets",c,2,this._vertexBufferSize,this._useInstancing),c+=2;let h=this._buffer.createVertexBuffer("inverts",c,2,this._vertexBufferSize,this._useInstancing),d=this._buffer.createVertexBuffer("cellInfo",c+2,4,this._vertexBufferSize,this._useInstancing),f=this._buffer.createVertexBuffer(T.ColorKind,c+6,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[T.PositionKind]=a,this._vertexBuffers.options=l,this._vertexBuffers.offsets=u,this._vertexBuffers.inverts=h,this._vertexBuffers.cellInfo=d,this._vertexBuffers[T.ColorKind]=f,this._initShaderSourceAsync()}_initShaderSourceAsync(){return S(this,null,function*(){this._engine.isWebGPU&&!n.ForceGLSL?(this._shaderLanguage=1,yield Promise.all([import("./chunk-P7ESS4KF.js"),import("./chunk-QL4QNNAQ.js")])):yield Promise.all([import("./chunk-Z5OPNG4N.js"),import("./chunk-D6ITPIEX.js")]),this._shadersLoaded=!0,this._createEffects()})}_createEffects(){if(this._isDisposed||!this._shadersLoaded)return;this._drawWrapperBase?.dispose(),this._drawWrapperDepth?.dispose(),this._drawWrapperBase=new Ti(this._engine),this._drawWrapperDepth=new Ti(this._engine,!1),this._drawWrapperBase.drawContext&&(this._drawWrapperBase.drawContext.useInstancing=this._useInstancing),this._drawWrapperDepth.drawContext&&(this._drawWrapperDepth.drawContext.useInstancing=this._useInstancing);let t="";this._pixelPerfect&&(t+=`#define PIXEL_PERFECT
`),this._scene&&this._scene.fogEnabled&&this._scene.fogMode!==0&&this._fogEnabled&&(t+=`#define FOG
`),this._useLogarithmicDepth&&(t+=`#define LOGARITHMICDEPTH
`),this._drawWrapperBase.effect=this._engine.createEffect("sprites",[T.PositionKind,"options","offsets","inverts","cellInfo",T.ColorKind],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor","logarithmicDepthConstant"],["diffuseSampler"],t,void 0,void 0,void 0,void 0,this._shaderLanguage),this._drawWrapperDepth.effect=this._drawWrapperBase.effect,this._drawWrapperBase.effect._refCount++,this._drawWrapperDepth.materialContext=this._drawWrapperBase.materialContext}render(t,i,r,s,o=null){if(!this._shadersLoaded||!this.texture||!this.texture.isReady()||!t.length)return;let a=this._drawWrapperBase,l=this._drawWrapperDepth,c=this.fogEnabled&&this._scene&&this._scene.fogEnabled&&this._scene.fogMode!==0,u=a.effect;if(!u.isReady())return;let h=this._engine,d=!!(this._scene&&this._scene.useRightHandedSystem),f=Math.min(this._capacity,t.length),p=0,g=!0,_=this._scene?.floatingOriginOffset||m.ZeroReadOnly;for(let I=0;I<f;I++){let v=t[I];if(!v||!v.isVisible)continue;g=!1,v._animate(i);let x=this.texture.getBaseSize();this._appendSpriteVertex(p++,v,0,0,x,d,o,_),this._useInstancing||(this._appendSpriteVertex(p++,v,1,0,x,d,o,_),this._appendSpriteVertex(p++,v,1,1,x,d,o,_),this._appendSpriteVertex(p++,v,0,1,x,d,o,_))}if(g)return;this._buffer.update(this._vertexData);let y=!!h.depthCullingState.cull,b=h.depthCullingState.zOffset,A=h.depthCullingState.zOffsetUnits;if(h.setState(y,b,!1,!1,void 0,void 0,A),h.enableEffect(a),u.setTexture("diffuseSampler",this.texture),u.setMatrix("view",r),u.setMatrix("projection",s),c){let I=this._scene;u.setFloat4("vFogInfos",I.fogMode,I.fogStart,I.fogEnd,I.fogDensity),u.setColor3("vFogColor",I.fogColor)}this.useLogarithmicDepth&&this._scene&&Si(a.defines,u,this._scene),this._useVAO?(this._vertexArrayObject||(this._vertexArrayObject=h.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,u)),h.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):h.bindBuffers(this._vertexBuffers,this._indexBuffer,u),h.depthCullingState.depthFunc=h.useReverseDepthBuffer?518:515,this.disableDepthWrite||(u.setBool("alphaTest",!0),h.setColorWrite(!1),h.enableEffect(l),this._useInstancing?h.drawArraysType(7,0,4,p):h.drawElementsType(0,0,p/4*6),h.enableEffect(a),h.setColorWrite(!0),u.setBool("alphaTest",!1)),h.setAlphaMode(this.blendMode),this._useInstancing?h.drawArraysType(7,0,4,p):h.drawElementsType(0,0,p/4*6),this.autoResetAlpha&&h.setAlphaMode(0),d&&this._scene.getEngine().setState(y,b,!1,!0,void 0,void 0,A),h.unbindInstanceAttributes()}_appendSpriteVertex(t,i,r,s,o,a,l,c){let u=t*this._vertexBufferSize;if(r===0?r=this._epsilon:r===1&&(r=1-this._epsilon),s===0?s=this._epsilon:s===1&&(s=1-this._epsilon),l)l(i,o);else{i.cellIndex||(i.cellIndex=0);let h=o.width/this.cellWidth,d=i.cellIndex/h>>0;i._xOffset=(i.cellIndex-d*h)*this.cellWidth/o.width,i._yOffset=d*this.cellHeight/o.height,i._xSize=this.cellWidth,i._ySize=this.cellHeight}this._vertexData[u]=i.position.x-c.x,this._vertexData[u+1]=i.position.y-c.y,this._vertexData[u+2]=i.position.z-c.z,this._vertexData[u+3]=i.angle,this._vertexData[u+4]=i.width,this._vertexData[u+5]=i.height,this._useInstancing?u-=2:(this._vertexData[u+6]=r,this._vertexData[u+7]=s),a?this._vertexData[u+8]=i.invertU?0:1:this._vertexData[u+8]=i.invertU?1:0,this._vertexData[u+9]=i.invertV?1:0,this._vertexData[u+10]=i._xOffset,this._vertexData[u+11]=i._yOffset,this._vertexData[u+12]=i._xSize/o.width,this._vertexData[u+13]=i._ySize/o.height,this._vertexData[u+14]=i.color.r,this._vertexData[u+15]=i.color.g,this._vertexData[u+16]=i.color.b,this._vertexData[u+17]=i.color.a}_buildIndexBuffer(){let t=[],i=0;for(let r=0;r<this._capacity;r++)t.push(i),t.push(i+1),t.push(i+2),t.push(i),t.push(i+2),t.push(i+3),i+=4;this._indexBuffer=this._engine.createIndexBuffer(t)}rebuild(){this._indexBuffer&&this._buildIndexBuffer(),this._useVAO&&(this._vertexArrayObject=void 0),this._buffer._rebuild();for(let t in this._vertexBuffers)this._vertexBuffers[t]._rebuild();this._spriteBuffer?._rebuild()}dispose(){this._buffer&&(this._buffer.dispose(),this._buffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this.texture&&(this.texture.dispose(),this.texture=null),this._drawWrapperBase?.dispose(),this._drawWrapperDepth?.dispose(),this._isDisposed=!0}}return n.ForceGLSL=!1,n})();var ra=class n{set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get children(){return this.sprites}get scene(){return this._scene}get capacity(){return this._spriteRenderer.capacity}get texture(){return this._spriteRenderer.texture}set texture(e){e.wrapU=Z.CLAMP_ADDRESSMODE,e.wrapV=Z.CLAMP_ADDRESSMODE,this._spriteRenderer.texture=e,this._textureContent=null}get cellWidth(){return this._spriteRenderer.cellWidth}set cellWidth(e){this._spriteRenderer.cellWidth=e}get cellHeight(){return this._spriteRenderer.cellHeight}set cellHeight(e){this._spriteRenderer.cellHeight=e}get fogEnabled(){return this._spriteRenderer.fogEnabled}set fogEnabled(e){this._spriteRenderer.fogEnabled=e}get useLogarithmicDepth(){return this._spriteRenderer.useLogarithmicDepth}set useLogarithmicDepth(e){this._spriteRenderer.useLogarithmicDepth=e}get blendMode(){return this._spriteRenderer.blendMode}set blendMode(e){this._spriteRenderer.blendMode=e}get disableDepthWrite(){return this._disableDepthWrite}set disableDepthWrite(e){this._disableDepthWrite=e,this._spriteRenderer.disableDepthWrite=e}get pixelPerfect(){return this._spriteRenderer.pixelPerfect}set pixelPerfect(e){this._spriteRenderer.pixelPerfect=e,e&&this.texture.samplingMode!==3&&this.texture.updateSamplingMode(3)}get spriteRenderer(){return this._spriteRenderer}constructor(e,t,i,r,s,o=.01,a=Z.TRILINEAR_SAMPLINGMODE,l=!1,c=null,u){this.name=e,this.sprites=[],this.renderingGroupId=0,this.layerMask=268435455,this.isPickable=!1,this.metadata=null,this._wasDispatched=!1,this.onDisposeObservable=new F,this.doNotSerialize=!1,this._disableDepthWrite=!1,this._packedAndReady=!1,this._customUpdate=(d,f)=>{d.cellRef||(d.cellIndex=0);let p=d.cellIndex;typeof p=="number"&&isFinite(p)&&Math.floor(p)===p&&(d.cellRef=this._spriteMap[d.cellIndex]),d._xOffset=this._cellData[d.cellRef].frame.x/f.width,d._yOffset=this._cellData[d.cellRef].frame.y/f.height,d._xSize=this._cellData[d.cellRef].frame.w,d._ySize=this._cellData[d.cellRef].frame.h},s||(s=ye.LastCreatedScene),s._getComponent(Oe.NAME_SPRITE)||s._addComponent(new ug(s)),this._fromPacked=l,this._scene=s;let h=this._scene.getEngine();if(this._spriteRenderer=new _D(h,i,o,s,u?.spriteRendererOptions),r.width&&r.height)this.cellWidth=r.width,this.cellHeight=r.height;else if(r!==void 0)this.cellWidth=r,this.cellHeight=r;else{this._spriteRenderer=null;return}this._scene.spriteManagers&&this._scene.spriteManagers.push(this),this.uniqueId=this.scene.getUniqueId(),t&&(this.texture=new Z(t,s,!0,!1,a)),this._fromPacked&&this._makePacked(t,c),this._scene._onNewSpriteManagerAddedObservable?.notifyObservers(this)}getClassName(){return"SpriteManager"}_makePacked(e,t){if(t!==null)try{let i;if(typeof t=="string"?i=JSON.parse(t):i=t,i.frames.length){let s={};for(let o=0;o<i.frames.length;o++){let a=i.frames[o];if(typeof Object.keys(a)[0]!="string")throw new Error("Invalid JSON Format.  Check the frame values and make sure the name is the first parameter.");let l=a[Object.keys(a)[0]];s[l]=a}i.frames=s}let r=Reflect.ownKeys(i.frames);this._spriteMap=r,this._packedAndReady=!0,this._cellData=i.frames}catch{throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON from string. Spritesheet managed with constant cell size.")}else{let i=/\./g,r;do r=i.lastIndex,i.test(e);while(i.lastIndex>0);let s=e.substring(0,r-1)+".json",o=()=>{P.Error("JSON ERROR: Unable to load JSON file."),this._fromPacked=!1,this._packedAndReady=!1},a=l=>{try{let c=JSON.parse(l),u=Reflect.ownKeys(c.frames);this._spriteMap=u,this._packedAndReady=!0,this._cellData=c.frames}catch{throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON format. Please check documentation for format specifications.")}};z.LoadFile(s,a,void 0,void 0,!1,o)}}_checkTextureAlpha(e,t,i,r,s){if(!e.useAlphaForPicking||!this.texture?.isReady())return!0;let o=this.texture.getSize();this._textureContent||(this._textureContent=new Uint8Array(o.width*o.height*4),this.texture.readPixels(0,0,this._textureContent));let a=k.Vector3[0];a.copyFrom(t.direction),a.normalize(),a.scaleInPlace(i),a.addInPlace(t.origin);let l=(a.x-r.x)/(s.x-r.x),c=1-(a.y-r.y)/(s.y-r.y),u=e._xOffset*o.width+l*e._xSize|0,h=e._yOffset*o.height+c*e._ySize|0;return this._textureContent[(u+h*o.width)*4+3]>.5}intersects(e,t,i,r){let s=Math.min(this.capacity,this.sprites.length),o=m.Zero(),a=m.Zero(),l=Number.MAX_VALUE,c=null,u=k.Vector3[0],h=k.Vector3[1],d=t.getViewMatrix(),f=e,p=e;for(let g=0;g<s;g++){let _=this.sprites[g];if(_){if(i){if(!i(_))continue}else if(!_.isPickable)continue;if(m.TransformCoordinatesToRef(_.position,d,h),_.angle?(L.TranslationToRef(-h.x,-h.y,0,k.Matrix[1]),L.TranslationToRef(h.x,h.y,0,k.Matrix[2]),L.RotationZToRef(-_.angle,k.Matrix[3]),k.Matrix[1].multiplyToRef(k.Matrix[3],k.Matrix[4]),k.Matrix[4].multiplyToRef(k.Matrix[2],k.Matrix[0]),f=e.clone(),m.TransformCoordinatesToRef(e.origin,k.Matrix[0],f.origin),m.TransformNormalToRef(e.direction,k.Matrix[0],f.direction)):f=e,o.copyFromFloats(h.x-_.width/2,h.y-_.height/2,h.z),a.copyFromFloats(h.x+_.width/2,h.y+_.height/2,h.z),f.intersectsBoxMinMax(o,a)){let y=m.Distance(h,f.origin);if(l>y){if(!this._checkTextureAlpha(_,f,y,o,a))continue;if(p=f,l=y,c=_,r)break}}}}if(c){let g=new Ft;d.invertToRef(k.Matrix[0]),g.hit=!0,g.pickedSprite=c,g.distance=l;let _=k.Vector3[2];return _.copyFrom(p.direction),_.normalize(),_.scaleInPlace(l),p.origin.addToRef(_,u),g.pickedPoint=m.TransformCoordinates(u,k.Matrix[0]),g}return null}multiIntersects(e,t,i){let r=Math.min(this.capacity,this.sprites.length),s=m.Zero(),o=m.Zero(),a,l=[],c=k.Vector3[0].copyFromFloats(0,0,0),u=k.Vector3[1].copyFromFloats(0,0,0),h=t.getViewMatrix();for(let d=0;d<r;d++){let f=this.sprites[d];if(f){if(i){if(!i(f))continue}else if(!f.isPickable)continue;if(m.TransformCoordinatesToRef(f.position,h,u),s.copyFromFloats(u.x-f.width/2,u.y-f.height/2,u.z),o.copyFromFloats(u.x+f.width/2,u.y+f.height/2,u.z),e.intersectsBoxMinMax(s,o)){if(a=m.Distance(u,e.origin),!this._checkTextureAlpha(f,e,a,s,o))continue;let p=new Ft;l.push(p),h.invertToRef(k.Matrix[0]),p.hit=!0,p.pickedSprite=f,p.distance=a;let g=k.Vector3[2];g.copyFrom(e.direction),g.normalize(),g.scaleInPlace(a),e.origin.addToRef(g,c),p.pickedPoint=m.TransformCoordinates(c,k.Matrix[0])}}}return l}render(){if(this._fromPacked&&(!this._packedAndReady||!this._spriteMap||!this._cellData))return;let t=this._scene.getEngine().getDeltaTime();this._packedAndReady?this._spriteRenderer.render(this.sprites,t,this._scene.getViewMatrix(),this._scene.getProjectionMatrix(),this._customUpdate):this._spriteRenderer.render(this.sprites,t,this._scene.getViewMatrix(),this._scene.getProjectionMatrix())}rebuild(){this._spriteRenderer?.rebuild()}dispose(){if(this._spriteRenderer&&(this._spriteRenderer.dispose(),this._spriteRenderer=null),this._textureContent=null,this._scene.spriteManagers){let e=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(e,1),this._scene._onSpriteManagerRemovedObservable?.notifyObservers(this)}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null}serialize(e=!1){let t={};t.name=this.name,t.capacity=this.capacity,t.cellWidth=this.cellWidth,t.cellHeight=this.cellHeight,t.fogEnabled=this.fogEnabled,t.blendMode=this.blendMode,t.disableDepthWrite=this.disableDepthWrite,t.pixelPerfect=this.pixelPerfect,t.useLogarithmicDepth=this.useLogarithmicDepth,this.texture&&(e?t.texture=this.texture.serialize():(t.textureUrl=this.texture.name,t.invertY=this.texture._invertY)),t.sprites=[];for(let i of this.sprites)t.sprites.push(i.serialize());return t.metadata=this.metadata,t}static Parse(e,t,i){let r=new n(e.name,"",e.capacity,{width:e.cellWidth,height:e.cellHeight},t);e.fogEnabled!==void 0&&(r.fogEnabled=e.fogEnabled),e.blendMode!==void 0&&(r.blendMode=e.blendMode),e.disableDepthWrite!==void 0&&(r.disableDepthWrite=e.disableDepthWrite),e.pixelPerfect!==void 0&&(r.pixelPerfect=e.pixelPerfect),e.useLogarithmicDepth!==void 0&&(r.useLogarithmicDepth=e.useLogarithmicDepth),e.metadata!==void 0&&(r.metadata=e.metadata),e.texture?r.texture=Z.Parse(e.texture,t,i):e.textureName&&(r.texture=new Z(i+e.textureUrl,t,!1,e.invertY!==void 0?e.invertY:!0));for(let s of e.sprites)ag.Parse(s,r);return r}static ParseFromFileAsync(e,t,i,r=""){return S(this,null,function*(){return yield new Promise((s,o)=>{let a=new gr;a.addEventListener("readystatechange",()=>{if(a.readyState==4)if(a.status==200){let l=JSON.parse(a.responseText),c=n.Parse(l,i||ye.LastCreatedScene,r);e&&(c.name=e),s(c)}else o("Unable to load the sprite manager")}),a.open("GET",t),a.send()})})}static ParseFromSnippetAsync(e,t,i=""){return e==="_BLANK"?Promise.resolve(new n("Default sprite manager","//playground.babylonjs.com/textures/player.png",500,64,t)):new Promise((r,s)=>{let o=new gr;o.addEventListener("readystatechange",()=>{if(o.readyState==4)if(o.status==200){let a=JSON.parse(JSON.parse(o.responseText).jsonPayload),l=JSON.parse(a.spriteManager),c=n.Parse(l,t||ye.LastCreatedScene,i);c.snippetId=e,r(c)}else s("Unable to load the snippet "+e)}),o.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),o.send()})}};ra.SnippetUrl="https://snippet.babylonjs.com";ra.CreateFromSnippetAsync=ra.ParseFromSnippetAsync;var Jl=class{};Jl.LoaderInjectedPhysicsEngine=void 0;var Zl={},Js={},ec={},yD=(n,e,t,i)=>{if(!e.materials)return null;for(let r=0,s=e.materials.length;r<s;r++){let o=e.materials[r];if(n(o))return{parsedMaterial:o,material:Re.Parse(o,t,i)}}return null},Rk=(n,e,t)=>{for(let i in e)if(n.name===e[i])return t.push(n.id),!0;return n.parentId!==void 0&&t.indexOf(n.parentId)!==-1?(t.push(n.id),!0):!1},Ql=(n,e)=>n+" of "+(e?e.file+" from "+e.name+" version: "+e.version+", exporter version: "+e.exporter_version:"unknown"),bD=(n,e)=>{let t=e;if(e._waitingData.lods){if(e._waitingData.lods.ids&&e._waitingData.lods.ids.length>0){let i=e._waitingData.lods.ids,r=t.isEnabled(!1);if(e._waitingData.lods.distances){let s=e._waitingData.lods.distances;if(s.length>=i.length){let o=s.length>i.length?s[s.length-1]:0;t.setEnabled(!1);for(let a=0;a<i.length;a++){let l=i[a],c=n.getMeshById(l);c!=null&&t.addLODLevel(s[a],c)}o>0&&t.addLODLevel(o,null),r===!0&&t.setEnabled(!0)}else z.Warn("Invalid level of detail distances for "+e.name)}}e._waitingData.lods=null}},hg=(n,e,t)=>{if(typeof n!="number"){let r=t.getLastEntryById(n);return r&&e!==void 0&&e!==null?r.instances[parseInt(e)]:r}let i=Zl[n];return i&&e!==void 0&&e!==null?i.instances[parseInt(e)]:i},dg=(n,e)=>typeof n!="number"?e.getLastMaterialById(n,!0):Js[n];var vD=(n,e,t,i,r=!1)=>{let s=new Ol(n),o="importScene has failed JSON parse";try{var a=typeof e=="object"?e:JSON.parse(e);o="";let l=Nt.loggingLevel===3,c,u;if(a.environmentTexture!==void 0&&a.environmentTexture!==null){let d=a.isPBR!==void 0?a.isPBR:!0;if(a.environmentTextureType&&a.environmentTextureType==="BABYLON.HDRCubeTexture"){let f=a.environmentTextureSize?a.environmentTextureSize:128,p=new ih((a.environmentTexture.match(/https?:\/\//g)?"":t)+a.environmentTexture,n,f,!0,!d,void 0,a.environmentTexturePrefilterOnLoad);a.environmentTextureRotationY&&(p.rotationY=a.environmentTextureRotationY),n.environmentTexture=p}else if(typeof a.environmentTexture=="object"){let f=Gt.Parse(a.environmentTexture,n,t);n.environmentTexture=f}else if(a.environmentTexture.endsWith(".env")){let f=new Gt((a.environmentTexture.match(/https?:\/\//g)?"":t)+a.environmentTexture,n,a.environmentTextureForcedExtension);a.environmentTextureRotationY&&(f.rotationY=a.environmentTextureRotationY),n.environmentTexture=f}else{let f=Gt.CreateFromPrefilteredData((a.environmentTexture.match(/https?:\/\//g)?"":t)+a.environmentTexture,n,a.environmentTextureForcedExtension);a.environmentTextureRotationY&&(f.rotationY=a.environmentTextureRotationY),n.environmentTexture=f}if(a.createDefaultSkybox===!0){let f=n.activeCamera!==void 0&&n.activeCamera!==null?(n.activeCamera.maxZ-n.activeCamera.minZ)/2:1e3,p=a.skyboxBlurLevel||0;n.createDefaultSkybox(n.environmentTexture,d,f,p)}s.environmentTexture=n.environmentTexture}if(a.environmentIntensity!==void 0&&a.environmentIntensity!==null&&(n.environmentIntensity=a.environmentIntensity),a.iblIntensity!==void 0&&a.iblIntensity!==null&&(n.iblIntensity=a.iblIntensity),a.lights!==void 0&&a.lights!==null)for(c=0,u=a.lights.length;c<u;c++){let d=a.lights[c],f=Yt.Parse(d,n);f&&(Zl[d.uniqueId]=f,s.lights.push(f),f._parentContainer=s,o+=c===0?`
	Lights:`:"",o+=`
		`+f.toString(l))}if(a.reflectionProbes!==void 0&&a.reflectionProbes!==null)for(c=0,u=a.reflectionProbes.length;c<u;c++){let d=a.reflectionProbes[c],f=Kl.Parse(d,n,t);f&&(s.reflectionProbes.push(f),f._parentContainer=s,o+=c===0?`
	Reflection Probes:`:"",o+=`
		`+f.toString(l))}if(a.animations!==void 0&&a.animations!==null)for(c=0,u=a.animations.length;c<u;c++){let d=a.animations[c],f=vt("BABYLON.Animation");if(f){let p=f.Parse(d);n.animations.push(p),s.animations.push(p),o+=c===0?`
	Animations:`:"",o+=`
		`+p.toString(l)}}if(a.materials!==void 0&&a.materials!==null)for(c=0,u=a.materials.length;c<u;c++){let d=a.materials[c],f=Re.Parse(d,n,t);if(f){Js[d.uniqueId||d.id]=f,s.materials.push(f),f._parentContainer=s,o+=c===0?`
	Materials:`:"",o+=`
		`+f.toString(l);let p=f.getActiveTextures();for(let g of p)s.textures.indexOf(g)==-1&&(s.textures.push(g),g._parentContainer=s)}}if(a.multiMaterials!==void 0&&a.multiMaterials!==null)for(c=0,u=a.multiMaterials.length;c<u;c++){let d=a.multiMaterials[c],f=cr.ParseMultiMaterial(d,n);Js[d.uniqueId||d.id]=f,s.multiMaterials.push(f),f._parentContainer=s,o+=c===0?`
	MultiMaterials:`:"",o+=`
		`+f.toString(l);let p=f.getActiveTextures();for(let g of p)s.textures.indexOf(g)==-1&&(s.textures.push(g),g._parentContainer=s)}if(a.morphTargetManagers!==void 0&&a.morphTargetManagers!==null)for(let d of a.morphTargetManagers){let f=Xu.Parse(d,n);ec[d.id]=f,s.morphTargetManagers.push(f),f._parentContainer=s}if(a.skeletons!==void 0&&a.skeletons!==null)for(c=0,u=a.skeletons.length;c<u;c++){let d=a.skeletons[c],f=Wr.Parse(d,n);s.skeletons.push(f),f._parentContainer=s,o+=c===0?`
	Skeletons:`:"",o+=`
		`+f.toString(l)}let h=a.geometries;if(h!=null){let d=new Array,f=h.vertexData;if(f!=null)for(c=0,u=f.length;c<u;c++){let p=f[c];d.push(Lt.Parse(p,n,t))}for(let p of d)p&&(s.geometries.push(p),p._parentContainer=s)}if(a.transformNodes!==void 0&&a.transformNodes!==null)for(c=0,u=a.transformNodes.length;c<u;c++){let d=a.transformNodes[c],f=vi.Parse(d,n,t);Zl[d.uniqueId]=f,s.transformNodes.push(f),f._parentContainer=s}if(a.meshes!==void 0&&a.meshes!==null)for(c=0,u=a.meshes.length;c<u;c++){let d=a.meshes[c],f=E.Parse(d,n,t);if(Zl[d.uniqueId]=f,s.meshes.push(f),f._parentContainer=s,f.hasInstances)for(let p of f.instances)s.meshes.push(p),p._parentContainer=s;o+=c===0?`
	Meshes:`:"",o+=`
		`+f.toString(l)}if(a.cameras!==void 0&&a.cameras!==null)for(c=0,u=a.cameras.length;c<u;c++){let d=a.cameras[c],f=Fe.Parse(d,n);Zl[d.uniqueId]=f,s.cameras.push(f),f._parentContainer=s,o+=c===0?`
	Cameras:`:"",o+=`
		`+f.toString(l)}if(a.postProcesses!==void 0&&a.postProcesses!==null)for(c=0,u=a.postProcesses.length;c<u;c++){let d=a.postProcesses[c],f=yr.Parse(d,n,t);f&&(s.postProcesses.push(f),f._parentContainer=s,o+=c===0?`
Postprocesses:`:"",o+=`
		`+f.toString())}if(a.animationGroups!==void 0&&a.animationGroups!==null&&a.animationGroups.length){let d=new Map;for(let f=0;f<n.meshes.length;f++)d.has(n.meshes[f].id)||d.set(n.meshes[f].id,n.meshes[f]);for(let f=0;f<n.transformNodes.length;f++)d.has(n.transformNodes[f].id)||d.set(n.transformNodes[f].id,n.transformNodes[f]);for(let f=0;f<n.lights.length;f++)d.has(n.lights[f].id)||d.set(n.lights[f].id,n.lights[f]);for(let f=0;f<n.cameras.length;f++)d.has(n.cameras[f].id)||d.set(n.cameras[f].id,n.cameras[f]);for(let f=0;f<n.skeletons.length;f++){let p=n.skeletons[f];for(let g=0;g<p.bones.length;g++)d.has(p.bones[g].id)||d.set(p.bones[g].id,p.bones[g])}for(c=0,u=a.animationGroups.length;c<u;c++){let f=a.animationGroups[c],p=v0.Parse(f,n,d);s.animationGroups.push(p),p._parentContainer=s,o+=c===0?`
	AnimationGroups:`:"",o+=`
		`+p.toString(l)}}if(a.spriteManagers)for(let d=0,f=a.spriteManagers.length;d<f;d++){let p=a.spriteManagers[d],g=ra.Parse(p,n,t);o+=`
		SpriteManager `+g.name}for(c=0,u=n.cameras.length;c<u;c++){let d=n.cameras[c];d._waitingParentId!==null&&(d.parent=hg(d._waitingParentId,d._waitingParentInstanceIndex,n),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(c=0,u=n.lights.length;c<u;c++){let d=n.lights[c];d&&d._waitingParentId!==null&&(d.parent=hg(d._waitingParentId,d._waitingParentInstanceIndex,n),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(c=0,u=n.transformNodes.length;c<u;c++){let d=n.transformNodes[c];d._waitingParentId!==null&&(d.parent=hg(d._waitingParentId,d._waitingParentInstanceIndex,n),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(c=0,u=n.meshes.length;c<u;c++){let d=n.meshes[c];d._waitingParentId!==null&&(d.parent=hg(d._waitingParentId,d._waitingParentInstanceIndex,n),d._waitingParentId=null,d._waitingParentInstanceIndex=null),d._waitingData.lods&&bD(n,d)}for(let d of n.multiMaterials){for(let f of d._waitingSubMaterialsUniqueIds)d.subMaterials.push(dg(f,n));d._waitingSubMaterialsUniqueIds=[]}for(let d of n.meshes)d._waitingMaterialId!==null&&(d.material=dg(d._waitingMaterialId,n),d._waitingMaterialId=null);for(let d of n.meshes)d._waitingMorphTargetManagerId!==null&&(d.morphTargetManager=ec[d._waitingMorphTargetManagerId],d._waitingMorphTargetManagerId=null);for(c=0,u=n.skeletons.length;c<u;c++){let d=n.skeletons[c];if(d._hasWaitingData){if(d.bones!=null){for(let f of d.bones)if(f._waitingTransformNodeId){let p=n.getLastEntryById(f._waitingTransformNodeId);p&&f.linkTransformNode(p),f._waitingTransformNodeId=null}}d._hasWaitingData=null}}for(c=0,u=n.meshes.length;c<u;c++){let d=n.meshes[c];d._waitingData.freezeWorldMatrix?(d.freezeWorldMatrix(),d._waitingData.freezeWorldMatrix=null):d.computeWorldMatrix(!0)}for(c=0,u=n.lights.length;c<u;c++){let d=n.lights[c];if(d._excludedMeshesIds.length>0){for(let f=0;f<d._excludedMeshesIds.length;f++){let p=n.getMeshById(d._excludedMeshesIds[f]);p&&d.excludedMeshes.push(p)}d._excludedMeshesIds=[]}if(d._includedOnlyMeshesIds.length>0){for(let f=0;f<d._includedOnlyMeshesIds.length;f++){let p=n.getMeshById(d._includedOnlyMeshesIds[f]);p&&d.includedOnlyMeshes.push(p)}d._includedOnlyMeshesIds=[]}}for(let d of n.geometries)d._loadedUniqueId="";for(uM(a,n,s,t),c=0,u=n.meshes.length;c<u;c++){let d=n.meshes[c];d._waitingData.actions&&(xs.Parse(d._waitingData.actions,d,n),d._waitingData.actions=null)}a.actions!==void 0&&a.actions!==null&&xs.Parse(a.actions,null,n)}catch(l){let c=Ql("loadAssets",a?a.producer:"Unknown")+o;if(i)i(c,l);else throw P.Log(c),l}finally{Zl={},Js={},ec={},r||s.removeAllFromScene(),o!==null&&Nt.loggingLevel!==0&&P.Log(Ql("loadAssets",a?a.producer:"Unknown")+(Nt.loggingLevel!==1?o:""))}return s};Wu({name:"babylon.js",extensions:".babylon",canDirectLoad:n=>n.indexOf("babylon")!==-1,importMesh:(n,e,t,i,r,s,o,a)=>{let l="importMesh has failed JSON parse";try{var c=JSON.parse(t);l="";let u=Nt.loggingLevel===3;n?Array.isArray(n)||(n=[n]):n=null;let h=[],d=new Map,f=[];if(c.transformNodes!==void 0&&c.transformNodes!==null)for(let p=0,g=c.transformNodes.length;p<g;p++){let _=c.transformNodes[p],y=vi.Parse(_,e,i);f.push(y),d.set(y._waitingParsedUniqueId,y),y._waitingParsedUniqueId=null}if(c.meshes!==void 0&&c.meshes!==null){let p=[],g=[],_=[],y=[];for(let A=0,I=c.meshes.length;A<I;A++){let v=c.meshes[A];if(n===null||Rk(v,n,h)){if(n!==null&&delete n[n.indexOf(v.name)],v.geometryId!==void 0&&v.geometryId!==null&&c.geometries!==void 0&&c.geometries!==null){let C=!1,R=["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"];for(let M of R){if(!c.geometries[M]||!Array.isArray(c.geometries[M]))continue;let D=c.geometries[M];for(let W of D)if(W.id===v.geometryId){switch(M){case"vertexData":Lt.Parse(W,e,i);break}C=!0;break}if(C)break}C===!1&&P.Warn("Geometry not found for mesh "+v.id)}if(v.materialUniqueId||v.materialId){let C=v.materialUniqueId?_:g,R=C.indexOf(v.materialUniqueId||v.materialId)!==-1;if(R===!1&&c.multiMaterials!==void 0&&c.multiMaterials!==null){let M=(D,W)=>{C.push(D);let ee=yD(W,c,e,i);ee&&ee.material&&(Js[ee.parsedMaterial.uniqueId||ee.parsedMaterial.id]=ee.material,l+=`
	Material `+ee.material.toString(u))};for(let D=0,W=c.multiMaterials.length;D<W;D++){let ee=c.multiMaterials[D];if(v.materialUniqueId&&ee.uniqueId===v.materialUniqueId||ee.id===v.materialId){if(ee.materialsUniqueIds)for(let J of ee.materialsUniqueIds)M(J,he=>he.uniqueId===J);else for(let J of ee.materials)M(J,he=>he.id===J);C.push(ee.uniqueId||ee.id);let ae=cr.ParseMultiMaterial(ee,e);Js[ee.uniqueId||ee.id]=ae,ae&&(R=!0,l+=`
	Multi-Material `+ae.toString(u));break}}}if(R===!1){C.push(v.materialUniqueId||v.materialId);let M=yD(D=>v.materialUniqueId&&D.uniqueId===v.materialUniqueId||D.id===v.materialId,c,e,i);!M||!M.material?P.Warn("Material not found for mesh "+v.id):(Js[M.parsedMaterial.uniqueId||M.parsedMaterial.id]=M.material,l+=`
	Material `+M.material.toString(u))}}if(v.skeletonId!==null&&v.skeletonId!==void 0&&c.skeletonId!==-1&&c.skeletons!==void 0&&c.skeletons!==null&&!(p.indexOf(v.skeletonId)>-1))for(let R=0,M=c.skeletons.length;R<M;R++){let D=c.skeletons[R];if(D.id===v.skeletonId){let W=Wr.Parse(D,e);o.push(W),p.push(D.id),l+=`
	Skeleton `+W.toString(u)}}if(v.morphTargetManagerId>-1&&c.morphTargetManagers!==void 0&&c.morphTargetManagers!==null&&!(y.indexOf(v.morphTargetManagerId)>-1))for(let R=0;R<c.morphTargetManagers.length;R++){let M=c.morphTargetManagers[R];if(M.id===v.morphTargetManagerId){let D=Xu.Parse(M,e);ec[M.id]=D,y.push(M.id),l+=`
Morph target manager`+D.toString()}}let x=E.Parse(v,e,i);r.push(x),d.set(x._waitingParsedUniqueId,x),x._waitingParsedUniqueId=null,l+=`
	Mesh `+x.toString(u)}}for(let A of e.multiMaterials){for(let I of A._waitingSubMaterialsUniqueIds)A.subMaterials.push(dg(I,e));A._waitingSubMaterialsUniqueIds=[]}for(let A of e.meshes)A._waitingMaterialId!==null&&(A.material=dg(A._waitingMaterialId,e),A._waitingMaterialId=null);for(let A of e.meshes)A._waitingMorphTargetManagerId!==null&&(A.morphTargetManager=ec[A._waitingMorphTargetManagerId],A._waitingMorphTargetManagerId=null);for(let A=0,I=e.transformNodes.length;A<I;A++){let v=e.transformNodes[A];if(v._waitingParentId!==null){let x=d.get(parseInt(v._waitingParentId))||null;x===null&&(x=e.getLastEntryById(v._waitingParentId));let C=x;v._waitingParentInstanceIndex&&(C=x.instances[parseInt(v._waitingParentInstanceIndex)],v._waitingParentInstanceIndex=null),v.parent=C,v._waitingParentId=null}}let b;for(let A=0,I=e.meshes.length;A<I;A++){if(b=e.meshes[A],b._waitingParentId){let v=d.get(parseInt(b._waitingParentId))||null;v===null&&(v=e.getLastEntryById(b._waitingParentId));let x=v;b._waitingParentInstanceIndex&&(x=v.instances[parseInt(b._waitingParentInstanceIndex)],b._waitingParentInstanceIndex=null),b.parent=x,b._waitingParentId=null}b._waitingData.lods&&bD(e,b)}for(let A of f)A.getChildMeshes(!1).length||A.dispose();for(let A=0,I=e.skeletons.length;A<I;A++){let v=e.skeletons[A];if(v._hasWaitingData){if(v.bones!=null){for(let x of v.bones)if(x._waitingTransformNodeId){let C=e.getLastEntryById(x._waitingTransformNodeId);C&&x.linkTransformNode(C),x._waitingTransformNodeId=null}}v._hasWaitingData=null}}for(let A=0,I=e.meshes.length;A<I;A++)b=e.meshes[A],b._waitingData.freezeWorldMatrix?(b.freezeWorldMatrix(),b._waitingData.freezeWorldMatrix=null):b.computeWorldMatrix(!0)}if(c.particleSystems!==void 0&&c.particleSystems!==null){let p=Fm(Oe.NAME_PARTICLESYSTEM);if(p)for(let g=0,_=c.particleSystems.length;g<_;g++){let y=c.particleSystems[g];h.indexOf(y.emitterId)!==-1&&s.push(p(y,e,i))}}for(let p of e.geometries)p._loadedUniqueId="";return!0}catch(u){let h=Ql("importMesh",c?c.producer:"Unknown")+l;if(a)a(h,u);else throw P.Log(h),u}finally{l!==null&&Nt.loggingLevel!==0&&P.Log(Ql("importMesh",c?c.producer:"Unknown")+(Nt.loggingLevel!==1?l:"")),Js={},ec={}}return!1},load:(n,e,t,i)=>{let r="importScene has failed JSON parse";try{var s=JSON.parse(e);switch(r="",s.useDelayedTextureLoading!==void 0&&s.useDelayedTextureLoading!==null&&(n.useDelayedTextureLoading=s.useDelayedTextureLoading&&!Nt.ForceFullSceneLoadingForIncremental),s.autoClear!==void 0&&s.autoClear!==null&&(n.autoClear=s.autoClear),s.clearColor!==void 0&&s.clearColor!==null&&(n.clearColor=ce.FromArray(s.clearColor)),s.ambientColor!==void 0&&s.ambientColor!==null&&(n.ambientColor=U.FromArray(s.ambientColor)),s.gravity!==void 0&&s.gravity!==null&&(n.gravity=m.FromArray(s.gravity)),s.useRightHandedSystem!==void 0&&(n.useRightHandedSystem=!!s.useRightHandedSystem),s.fogMode!==void 0&&s.fogMode!==null&&(n.fogMode=s.fogMode),s.fogColor!==void 0&&s.fogColor!==null&&(n.fogColor=U.FromArray(s.fogColor)),s.fogStart!==void 0&&s.fogStart!==null&&(n.fogStart=s.fogStart),s.fogEnd!==void 0&&s.fogEnd!==null&&(n.fogEnd=s.fogEnd),s.fogDensity!==void 0&&s.fogDensity!==null&&(n.fogDensity=s.fogDensity),r+="	Fog mode for scene:  ",n.fogMode){case 0:r+=`none
`;break;case 1:r+=`exp
`;break;case 2:r+=`exp2
`;break;case 3:r+=`linear
`;break}if(s.physicsEnabled){let a;s.physicsEngine==="cannon"||s.physicsEngine===Yl.name?a=new Yl(void 0,void 0,Jl.LoaderInjectedPhysicsEngine):s.physicsEngine==="oimo"||s.physicsEngine===rh.name?a=new rh(void 0,Jl.LoaderInjectedPhysicsEngine):(s.physicsEngine==="ammo"||s.physicsEngine===WC.name)&&(a=new WC(void 0,Jl.LoaderInjectedPhysicsEngine,void 0)),r="	Physics engine "+(s.physicsEngine?s.physicsEngine:"oimo")+` enabled
`;let l=s.gravity?m.FromArray(s.gravity):s.physicsGravity?m.FromArray(s.physicsGravity):null;n.enablePhysics(l,a)}return s.metadata!==void 0&&s.metadata!==null&&(n.metadata=s.metadata),s.collisionsEnabled!==void 0&&s.collisionsEnabled!==null&&(n.collisionsEnabled=s.collisionsEnabled),vD(n,e,t,i,!0)?(s.autoAnimate&&n.beginAnimation(n,s.autoAnimateFrom,s.autoAnimateTo,s.autoAnimateLoop,s.autoAnimateSpeed||1),s.activeCameraID!==void 0&&s.activeCameraID!==null&&n.setActiveCameraById(s.activeCameraID),!0):!1}catch(o){let a=Ql("importScene",s?s.producer:"Unknown")+r;if(i)i(a,o);else throw P.Log(a),o}finally{r!==null&&Nt.loggingLevel!==0&&P.Log(Ql("importScene",s?s.producer:"Unknown")+(Nt.loggingLevel!==1?r:""))}return!1},loadAssetContainer:(n,e,t,i)=>vD(n,e,t,i)});var tc=(()=>{class n{get camera(){return this._options.camera}set camera(t){this._options.camera=t}get renderingGroupId(){return this._options.renderingGroupId}set renderingGroupId(t){this._options.renderingGroupId=t}get objectRenderer(){return this._objectRenderer}get shaderLanguage(){return this._shaderLanguage}setMaterialForRendering(t,i){if(this._objectRenderer.setMaterialForRendering(t,i),Array.isArray(t))for(let r=0;r<t.length;++r){let s=t[r];i?this._materialForRendering[s.uniqueId]=[s,i]:delete this._materialForRendering[s.uniqueId]}else i?this._materialForRendering[t.uniqueId]=[t,i]:delete this._materialForRendering[t.uniqueId]}getEffectIntensity(t){return this._effectIntensity[t.uniqueId]??1}setEffectIntensity(t,i){this._effectIntensity[t.uniqueId]=i}constructor(t,i,r=!1,s=!1,o){this._additionalImportShadersAsync=o,this._vertexBuffers={},this._dontCheckIfReady=!1,this._shouldRender=!0,this._emissiveTextureAndColor={texture:null,color:new ce},this._effectIntensity={},this._postProcesses=[],this.neutralColor=new ce,this.isEnabled=!0,this.disableBoundingBoxesFromEffectLayer=!1,this.onDisposeObservable=new F,this.onBeforeRenderLayerObservable=new F,this.onBeforeComposeObservable=new F,this.onBeforeRenderMeshToEffect=new F,this.onAfterRenderMeshToEffect=new F,this.onAfterComposeObservable=new F,this.onBeforeBlurObservable=new F,this.onAfterBlurObservable=new F,this._shaderLanguage=0,this._materialForRendering={},this._shadersLoaded=!1,this.name=t,this._scene=i||ye.LastCreatedScene,this._dontCheckIfReady=s,this._scene.getEngine().isWebGPU&&!r&&!n.ForceGLSL&&(this._shaderLanguage=1),this._engine=this._scene.getEngine(),this._mergeDrawWrapper=[],this._generateIndexBuffer(),this._generateVertexBuffer()}getEffectName(){return""}isReady(t,i){return!0}needStencil(){return!1}_createMergeEffect(){throw new Error("Effect Layer: no merge effect defined")}_createTextureAndPostProcesses(){}_internalCompose(t,i){}_setEmissiveTextureAndColor(t,i,r){}_numInternalDraws(){return 1}_init(t){this._options=Y({mainTextureRatio:.5,mainTextureFixedSize:0,mainTextureType:0,alphaBlendingMode:2,camera:null,renderingGroupId:-1},t),this._createObjectRenderer()}_generateIndexBuffer(){let t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=this._engine.createIndexBuffer(t)}_generateVertexBuffer(){let t=[];t.push(1,1),t.push(-1,1),t.push(-1,-1),t.push(1,-1);let i=new T(this._engine,t,T.PositionKind,!1,!1,2);this._vertexBuffers[T.PositionKind]=i}_createObjectRenderer(){this._objectRenderer=new $T(`ObjectRenderer for thin effect layer ${this.name}`,this._scene,{doNotChangeAspectRatio:!0}),this._objectRenderer.activeCamera=this._options.camera,this._objectRenderer.renderParticles=!1,this._objectRenderer.renderList=null;let t=!!this._scene.getBoundingBoxRenderer,i=!1;t&&(this._objectRenderer.onBeforeRenderObservable.add(()=>{i=this._scene.getBoundingBoxRenderer().enabled,this._scene.getBoundingBoxRenderer().enabled=!this.disableBoundingBoxesFromEffectLayer&&i}),this._objectRenderer.onAfterRenderObservable.add(()=>{this._scene.getBoundingBoxRenderer().enabled=i})),this._objectRenderer.customIsReadyFunction=(r,s,o)=>{if((o||s===0)&&r.subMeshes)for(let a=0;a<r.subMeshes.length;++a){let l=r.subMeshes[a],c=l.getMaterial(),u=l.getRenderingMesh();if(!c)continue;let d=u._getInstancesRenderList(l._id,!!l.getReplacementMesh()).hardwareInstancedRendering[l._id]||u.hasThinInstances;if(this._setEmissiveTextureAndColor(u,l,c),!this._isSubMeshReady(l,d,this._emissiveTextureAndColor.texture))return!1}return!0},this._objectRenderer.customRenderFunction=(r,s,o,a)=>{this.onBeforeRenderLayerObservable.notifyObservers(this);let l,c=this._scene.getEngine();if(a.length){for(c.setColorWrite(!1),l=0;l<a.length;l++)this._renderSubMesh(a.data[l]);c.setColorWrite(!0)}for(l=0;l<r.length;l++)this._renderSubMesh(r.data[l]);for(l=0;l<s.length;l++)this._renderSubMesh(s.data[l]);let u=c.getAlphaMode();for(l=0;l<o.length;l++){let h=o.data[l],d=h.getMaterial();if(d&&d.needDepthPrePass){let f=d.getScene().getEngine();f.setColorWrite(!1),this._renderSubMesh(h),f.setColorWrite(!0)}this._renderSubMesh(h,!0)}c.setAlphaMode(u)}}_addCustomEffectDefines(t){}_internalIsSubMeshReady(t,i,r){let s=this._scene.getEngine(),o=t.getMesh(),a=o._internalAbstractMeshDataInfo._materialForRenderPass?.[s.currentRenderPassId];if(a)return a.isReadyForSubMesh(o,t,i);let l=t.getMaterial();if(!l)return!1;if(this._useMeshMaterial(t.getRenderingMesh()))return l.isReadyForSubMesh(t.getMesh(),t,i);let c=[],u=[T.PositionKind],h=!1,d=!1,f=!1;if(l){let I=l.needAlphaTestingForMesh(o),v=l.getAlphaTestTexture(),x=v&&v.hasAlpha&&(l.useAlphaFromDiffuseTexture||l._useAlphaFromAlbedoTexture);v&&(I||x)&&(c.push("#define DIFFUSE"),o.isVerticesDataPresent(T.UV2Kind)&&v.coordinatesIndex===1?(c.push("#define DIFFUSEUV2"),d=!0):o.isVerticesDataPresent(T.UVKind)&&(c.push("#define DIFFUSEUV1"),h=!0),I&&(c.push("#define ALPHATEST"),c.push("#define ALPHATESTVALUE 0.4")),v.gammaSpace||c.push("#define DIFFUSE_ISLINEAR"));let C=l.opacityTexture;C&&(c.push("#define OPACITY"),o.isVerticesDataPresent(T.UV2Kind)&&C.coordinatesIndex===1?(c.push("#define OPACITYUV2"),d=!0):o.isVerticesDataPresent(T.UVKind)&&(c.push("#define OPACITYUV1"),h=!0))}r&&(c.push("#define EMISSIVE"),o.isVerticesDataPresent(T.UV2Kind)&&r.coordinatesIndex===1?(c.push("#define EMISSIVEUV2"),d=!0):o.isVerticesDataPresent(T.UVKind)&&(c.push("#define EMISSIVEUV1"),h=!0),r.gammaSpace||c.push("#define EMISSIVE_ISLINEAR")),o.useVertexColors&&o.isVerticesDataPresent(T.ColorKind)&&o.hasVertexAlpha&&l.transparencyMode!==Re.MATERIAL_OPAQUE&&(u.push(T.ColorKind),c.push("#define VERTEXALPHA")),h&&(u.push(T.UVKind),c.push("#define UV1")),d&&(u.push(T.UV2Kind),c.push("#define UV2"));let p=new vr;if(o.useBones&&o.computeBonesUsingShaders){u.push(T.MatricesIndicesKind),u.push(T.MatricesWeightsKind),o.numBoneInfluencers>4&&(u.push(T.MatricesIndicesExtraKind),u.push(T.MatricesWeightsExtraKind)),c.push("#define NUM_BONE_INFLUENCERS "+o.numBoneInfluencers);let I=o.skeleton;I&&I.isUsingTextureForMatrices?c.push("#define BONETEXTURE"):c.push("#define BonesPerMesh "+(I?I.bones.length+1:0)),o.numBoneInfluencers>0&&p.addCPUSkinningFallback(0,o)}else c.push("#define NUM_BONE_INFLUENCERS 0");let g=o.morphTargetManager?Vh(o.morphTargetManager,c,u,o,!0,!1,!1,h,d,f):0;i&&(c.push("#define INSTANCES"),Gh(u),t.getRenderingMesh().hasThinInstances&&c.push("#define THIN_INSTANCES")),Es(l,this._scene,c),this._addCustomEffectDefines(c);let _=t._getDrawWrapper(void 0,!0),y=_.defines,b=c.join(`
`);if(y!==b){let I=["world","mBones","viewProjection","glowColor","morphTargetInfluences","morphTargetCount","boneTextureWidth","diffuseMatrix","emissiveMatrix","opacityMatrix","opacityIntensity","morphTargetTextureInfo","morphTargetTextureIndices","glowIntensity"];Yi(I),_.setEffect(this._engine.createEffect("glowMapGeneration",u,I,["diffuseSampler","emissiveSampler","opacitySampler","boneSampler","morphTargets"],b,p,void 0,void 0,{maxSimultaneousMorphTargets:g},this._shaderLanguage,this._shadersLoaded?void 0:()=>S(this,null,function*(){yield this._importShadersAsync(),this._shadersLoaded=!0})),b)}return _.effect.isReady()&&(this._dontCheckIfReady||!this._dontCheckIfReady&&this.isLayerReady())}_isSubMeshReady(t,i,r){return this._internalIsSubMeshReady(t,i,r)}_importShadersAsync(){return S(this,null,function*(){this._shaderLanguage===1?yield Promise.all([import("./chunk-KL44RPIS.js"),import("./chunk-IX7PO7BN.js")]):yield Promise.all([import("./chunk-EHNKPXI2.js"),import("./chunk-HLJZYT6E.js")]),this._additionalImportShadersAsync?.()})}_internalIsLayerReady(){let t=!0;for(let r=0;r<this._postProcesses.length;r++)t=this._postProcesses[r].isReady()&&t;let i=this._numInternalDraws();for(let r=0;r<i;++r){let s=this._mergeDrawWrapper[r];s||(s=this._mergeDrawWrapper[r]=new Ti(this._engine),s.setEffect(this._createMergeEffect())),t=s.effect.isReady()&&t}return t}isLayerReady(){return this._internalIsLayerReady()}compose(){if(!this._dontCheckIfReady&&!this.isLayerReady())return!1;let t=this._scene.getEngine(),i=this._numInternalDraws();this.onBeforeComposeObservable.notifyObservers(this);let r=t.getAlphaMode();for(let s=0;s<i;++s){let o=this._mergeDrawWrapper[s];t.enableEffect(o),t.setState(!1),t.bindBuffers(this._vertexBuffers,this._indexBuffer,o.effect),t.setAlphaMode(this._options.alphaBlendingMode),this._internalCompose(o.effect,s)}return t.setAlphaMode(r),this.onAfterComposeObservable.notifyObservers(this),!0}_internalHasMesh(t){return this.renderingGroupId===-1||t.renderingGroupId===this.renderingGroupId}hasMesh(t){return this._internalHasMesh(t)}_internalShouldRender(){return this.isEnabled&&this._shouldRender}shouldRender(){return this._internalShouldRender()}_shouldRenderMesh(t){return!0}_internalCanRenderMesh(t,i){return!i.needAlphaBlendingForMesh(t)}_canRenderMesh(t,i){return this._internalCanRenderMesh(t,i)}_renderSubMesh(t,i=!1){if(!this._internalShouldRender())return;let r=t.getMaterial(),s=t.getMesh(),o=t.getReplacementMesh(),a=t.getRenderingMesh(),l=t.getEffectiveMesh(),c=this._scene,u=c.getEngine();if(l._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!r||!this._canRenderMesh(a,r))return;let h=r._getEffectiveOrientation(a);l._getWorldMatrixDeterminant()<0&&(h=h===Re.ClockWiseSideOrientation?Re.CounterClockWiseSideOrientation:Re.ClockWiseSideOrientation);let f=h===Re.ClockWiseSideOrientation;u.setState(r.backFaceCulling,r.zOffset,void 0,f,r.cullBackFaces,void 0,r.zOffsetUnits);let p=a._getInstancesRenderList(t._id,!!o);if(p.mustReturn||!this._shouldRenderMesh(a))return;let g=p.hardwareInstancedRendering[t._id]||a.hasThinInstances;if(this._setEmissiveTextureAndColor(a,t,r),this.onBeforeRenderMeshToEffect.notifyObservers(s),this._useMeshMaterial(a))t.getMaterial()._glowModeEnabled=!0,a.render(t,i,o||void 0),t.getMaterial()._glowModeEnabled=!1;else if(this._isSubMeshReady(t,g,this._emissiveTextureAndColor.texture)){let _=l._internalAbstractMeshDataInfo._materialForRenderPass?.[u.currentRenderPassId],y=t._getDrawWrapper();if(!y&&_&&(y=_._getDrawWrapper()),!y)return;let b=y.effect;if(u.enableEffect(y),g||a._bind(t,b,r.fillMode),_?_.bindForSubMesh(l.getWorldMatrix(),l,t):(b.setMatrix("viewProjection",c.getTransformMatrix()),b.setMatrix("world",l.getWorldMatrix()),b.setFloat4("glowColor",this._emissiveTextureAndColor.color.r,this._emissiveTextureAndColor.color.g,this._emissiveTextureAndColor.color.b,this._emissiveTextureAndColor.color.a)),!_){let A=r.needAlphaTestingForMesh(l),I=r.getAlphaTestTexture(),v=I&&I.hasAlpha&&(r.useAlphaFromDiffuseTexture||r._useAlphaFromAlbedoTexture);if(I&&(A||v)){b.setTexture("diffuseSampler",I);let C=I.getTextureMatrix();C&&b.setMatrix("diffuseMatrix",C)}let x=r.opacityTexture;if(x){b.setTexture("opacitySampler",x),b.setFloat("opacityIntensity",x.level);let C=x.getTextureMatrix();C&&b.setMatrix("opacityMatrix",C)}if(this._emissiveTextureAndColor.texture&&(b.setTexture("emissiveSampler",this._emissiveTextureAndColor.texture),b.setMatrix("emissiveMatrix",this._emissiveTextureAndColor.texture.getTextureMatrix())),a.useBones&&a.computeBonesUsingShaders&&a.skeleton){let C=a.skeleton;if(C.isUsingTextureForMatrices){let R=C.getTransformMatrixTexture(a);if(!R)return;b.setTexture("boneSampler",R),b.setFloat("boneTextureWidth",4*(C.bones.length+1))}else b.setMatrices("mBones",C.getTransformMatrices(a))}Ma(a,b),a.morphTargetManager&&a.morphTargetManager.isUsingTextureForTargets&&a.morphTargetManager._bind(b),i&&u.setAlphaMode(r.alphaMode),b.setFloat("glowIntensity",this.getEffectIntensity(a)),Ki(b,r,c)}a._processRendering(l,t,b,r.fillMode,p,g,(A,I)=>b.setMatrix("world",I))}else this._objectRenderer.resetRefreshCounter();this.onAfterRenderMeshToEffect.notifyObservers(s)}_useMeshMaterial(t){return!1}_rebuild(){let t=this._vertexBuffers[T.PositionKind];t&&t._rebuild(),this._generateIndexBuffer()}dispose(){let t=this._vertexBuffers[T.PositionKind];t&&(t.dispose(),this._vertexBuffers[T.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);for(let i of this._mergeDrawWrapper)i.dispose();this._mergeDrawWrapper=[],this._objectRenderer.dispose(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderLayerObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear()}}return n.ForceGLSL=!1,n})();var hn=class n{get _shouldRender(){return this._thinEffectLayer._shouldRender}set _shouldRender(e){this._thinEffectLayer._shouldRender=e}get _emissiveTextureAndColor(){return this._thinEffectLayer._emissiveTextureAndColor}set _emissiveTextureAndColor(e){this._thinEffectLayer._emissiveTextureAndColor=e}get _effectIntensity(){return this._thinEffectLayer._effectIntensity}set _effectIntensity(e){this._thinEffectLayer._effectIntensity=e}static get ForceGLSL(){return tc.ForceGLSL}static set ForceGLSL(e){tc.ForceGLSL=e}get name(){return this._thinEffectLayer.name}set name(e){this._thinEffectLayer.name=e}get neutralColor(){return this._thinEffectLayer.neutralColor}set neutralColor(e){this._thinEffectLayer.neutralColor=e}get isEnabled(){return this._thinEffectLayer.isEnabled}set isEnabled(e){this._thinEffectLayer.isEnabled=e}get camera(){return this._thinEffectLayer.camera}get renderingGroupId(){return this._thinEffectLayer.renderingGroupId}set renderingGroupId(e){this._thinEffectLayer.renderingGroupId=e}get disableBoundingBoxesFromEffectLayer(){return this._thinEffectLayer.disableBoundingBoxesFromEffectLayer}set disableBoundingBoxesFromEffectLayer(e){this._thinEffectLayer.disableBoundingBoxesFromEffectLayer=e}get mainTexture(){return this._mainTexture}get _shaderLanguage(){return this._thinEffectLayer.shaderLanguage}get shaderLanguage(){return this._thinEffectLayer.shaderLanguage}setMaterialForRendering(e,t){this._thinEffectLayer.setMaterialForRendering(e,t)}getEffectIntensity(e){return this._thinEffectLayer.getEffectIntensity(e)}setEffectIntensity(e,t){this._thinEffectLayer.setEffectIntensity(e,t)}constructor(e,t,i=!1,r){this._mainTextureCreatedSize={width:0,height:0},this._maxSize=0,this._mainTextureDesiredSize={width:0,height:0},this._postProcesses=[],this._textures=[],this.uniqueId=kh.UniqueId,this.onDisposeObservable=new F,this.onBeforeRenderMainTextureObservable=new F,this.onBeforeComposeObservable=new F,this.onBeforeRenderMeshToEffect=new F,this.onAfterRenderMeshToEffect=new F,this.onAfterComposeObservable=new F,this.onSizeChangedObservable=new F,this._internalThinEffectLayer=!r,r||(r=new tc(e,t,i,!1,this._importShadersAsync.bind(this)),r.getEffectName=this.getEffectName.bind(this),r.isReady=this.isReady.bind(this),r._createMergeEffect=this._createMergeEffect.bind(this),r._createTextureAndPostProcesses=this._createTextureAndPostProcesses.bind(this),r._internalCompose=this._internalRender.bind(this),r._setEmissiveTextureAndColor=this._setEmissiveTextureAndColor.bind(this),r._numInternalDraws=this._numInternalDraws.bind(this),r._addCustomEffectDefines=this._addCustomEffectDefines.bind(this),r.hasMesh=this.hasMesh.bind(this),r.shouldRender=this.shouldRender.bind(this),r._shouldRenderMesh=this._shouldRenderMesh.bind(this),r._canRenderMesh=this._canRenderMesh.bind(this),r._useMeshMaterial=this._useMeshMaterial.bind(this)),this._thinEffectLayer=r,this.name=e,this._scene=t||ye.LastCreatedScene,n._SceneComponentInitialization(this._scene),this._engine=this._scene.getEngine(),this._maxSize=this._engine.getCaps().maxTextureSize,this._scene.addEffectLayer(this),this._thinEffectLayer.onDisposeObservable.add(()=>{this.onDisposeObservable.notifyObservers(this)}),this._thinEffectLayer.onBeforeRenderLayerObservable.add(()=>{this.onBeforeRenderMainTextureObservable.notifyObservers(this)}),this._thinEffectLayer.onBeforeComposeObservable.add(()=>{this.onBeforeComposeObservable.notifyObservers(this)}),this._thinEffectLayer.onBeforeRenderMeshToEffect.add(s=>{this.onBeforeRenderMeshToEffect.notifyObservers(s)}),this._thinEffectLayer.onAfterRenderMeshToEffect.add(s=>{this.onAfterRenderMeshToEffect.notifyObservers(s)}),this._thinEffectLayer.onAfterComposeObservable.add(()=>{this.onAfterComposeObservable.notifyObservers(this)})}get _shadersLoaded(){return this._thinEffectLayer._shadersLoaded}set _shadersLoaded(e){this._thinEffectLayer._shadersLoaded=e}_numInternalDraws(){return this._internalThinEffectLayer?1:this._thinEffectLayer._numInternalDraws()}_init(e){this._effectLayerOptions=Y({mainTextureRatio:.5,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0,generateStencilBuffer:!1},e),this._setMainTextureSize(),this._thinEffectLayer._init(e),this._createMainTexture(),this._createTextureAndPostProcesses()}_setMainTextureSize(){this._effectLayerOptions.mainTextureFixedSize?(this._mainTextureDesiredSize.width=this._effectLayerOptions.mainTextureFixedSize,this._mainTextureDesiredSize.height=this._effectLayerOptions.mainTextureFixedSize):(this._mainTextureDesiredSize.width=this._engine.getRenderWidth()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.height=this._engine.getRenderHeight()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.width=this._engine.needPOTTextures?Jr(this._mainTextureDesiredSize.width,this._maxSize):this._mainTextureDesiredSize.width,this._mainTextureDesiredSize.height=this._engine.needPOTTextures?Jr(this._mainTextureDesiredSize.height,this._maxSize):this._mainTextureDesiredSize.height),this._mainTextureDesiredSize.width=Math.floor(this._mainTextureDesiredSize.width),this._mainTextureDesiredSize.height=Math.floor(this._mainTextureDesiredSize.height)}_createMainTexture(){this._mainTexture=new hi("EffectLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,{type:this._effectLayerOptions.mainTextureType,samplingMode:Z.TRILINEAR_SAMPLINGMODE,generateStencilBuffer:this._effectLayerOptions.generateStencilBuffer,existingObjectRenderer:this._thinEffectLayer.objectRenderer}),this._mainTexture.activeCamera=this._effectLayerOptions.camera,this._mainTexture.wrapU=Z.CLAMP_ADDRESSMODE,this._mainTexture.wrapV=Z.CLAMP_ADDRESSMODE,this._mainTexture.anisotropicFilteringLevel=1,this._mainTexture.updateSamplingMode(Z.BILINEAR_SAMPLINGMODE),this._mainTexture.renderParticles=!1,this._mainTexture.renderList=null,this._mainTexture.ignoreCameraViewport=!0,this._mainTexture.onClearObservable.add(e=>{e.clear(this.neutralColor,!0,!0,!0)})}_addCustomEffectDefines(e){}_isReady(e,t,i){return this._internalThinEffectLayer?this._thinEffectLayer._internalIsSubMeshReady(e,t,i):this._thinEffectLayer._isSubMeshReady(e,t,i)}_importShadersAsync(){return S(this,null,function*(){})}_arePostProcessAndMergeReady(){return this._internalThinEffectLayer?this._thinEffectLayer._internalIsLayerReady():this._thinEffectLayer.isLayerReady()}isLayerReady(){return this._arePostProcessAndMergeReady()&&this._mainTexture.isReady()}render(){this._thinEffectLayer.compose()&&(this._setMainTextureSize(),(this._mainTextureCreatedSize.width!==this._mainTextureDesiredSize.width||this._mainTextureCreatedSize.height!==this._mainTextureDesiredSize.height)&&this._mainTextureDesiredSize.width!==0&&this._mainTextureDesiredSize.height!==0&&(this.onSizeChangedObservable.notifyObservers(this),this._disposeTextureAndPostProcesses(),this._createMainTexture(),this._createTextureAndPostProcesses(),this._mainTextureCreatedSize.width=this._mainTextureDesiredSize.width,this._mainTextureCreatedSize.height=this._mainTextureDesiredSize.height))}hasMesh(e){return this._internalThinEffectLayer?this._thinEffectLayer._internalHasMesh(e):this._thinEffectLayer.hasMesh(e)}shouldRender(){return this._internalThinEffectLayer?this._thinEffectLayer._internalShouldRender():this._thinEffectLayer.shouldRender()}_shouldRenderMesh(e){return this._internalThinEffectLayer?!0:this._thinEffectLayer._shouldRenderMesh(e)}_canRenderMesh(e,t){return this._internalThinEffectLayer?this._thinEffectLayer._internalCanRenderMesh(e,t):this._thinEffectLayer._canRenderMesh(e,t)}_shouldRenderEmissiveTextureForMesh(){return!0}_useMeshMaterial(e){return this._internalThinEffectLayer?!1:this._thinEffectLayer._useMeshMaterial(e)}_rebuild(){this._thinEffectLayer._rebuild()}_disposeTextureAndPostProcesses(){this._mainTexture.dispose();for(let e=0;e<this._postProcesses.length;e++)this._postProcesses[e]&&this._postProcesses[e].dispose();this._postProcesses=[];for(let e=0;e<this._textures.length;e++)this._textures[e]&&this._textures[e].dispose();this._textures=[]}dispose(){this._thinEffectLayer.dispose(),this._disposeTextureAndPostProcesses(),this._scene.removeEffectLayer(this),this.onDisposeObservable.clear(),this.onBeforeRenderMainTextureObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear(),this.onSizeChangedObservable.clear()}getClassName(){return"EffectLayer"}static Parse(e,t,i){return z.Instantiate(e.customType).Parse(e,t,i)}};hn._SceneComponentInitialization=n=>{throw Zt("EffectLayerSceneComponent")};w([B()],hn.prototype,"name",null);w([GT()],hn.prototype,"neutralColor",null);w([B()],hn.prototype,"isEnabled",null);w([UT()],hn.prototype,"camera",null);w([B()],hn.prototype,"renderingGroupId",null);w([B()],hn.prototype,"disableBoundingBoxesFromEffectLayer",null);Xs(Oe.NAME_EFFECTLAYER,(n,e,t,i)=>{if(n.effectLayers){t.effectLayers||(t.effectLayers=[]);for(let r=0;r<n.effectLayers.length;r++){let s=hn.Parse(n.effectLayers[r],e,i);t.effectLayers.push(s)}}});var jC=class{constructor(e){this.name=Oe.NAME_EFFECTLAYER,this._renderEffects=!1,this._needStencil=!1,this._previousStencilState=!1,this.scene=e||ye.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine())}register(){this.scene._isReadyForMeshStage.registerStep(Oe.STEP_ISREADYFORMESH_EFFECTLAYER,this,this._isReadyForMesh),this.scene._cameraDrawRenderTargetStage.registerStep(Oe.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER,this,this._renderMainTexture),this.scene._beforeCameraDrawStage.registerStep(Oe.STEP_BEFORECAMERADRAW_EFFECTLAYER,this,this._setStencil),this.scene._afterRenderingGroupDrawStage.registerStep(Oe.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW,this,this._drawRenderingGroup),this.scene._afterCameraDrawStage.registerStep(Oe.STEP_AFTERCAMERADRAW_EFFECTLAYER,this,this._setStencilBack),this.scene._afterCameraDrawStage.registerStep(Oe.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW,this,this._drawCamera)}rebuild(){let e=this.scene.effectLayers;for(let t of e)t._rebuild()}serialize(e){e.effectLayers=[];let t=this.scene.effectLayers;for(let i of t)i.serialize&&e.effectLayers.push(i.serialize())}addFromContainer(e){if(e.effectLayers)for(let t of e.effectLayers)this.scene.addEffectLayer(t)}removeFromContainer(e,t){if(e.effectLayers)for(let i of e.effectLayers)this.scene.removeEffectLayer(i),t&&i.dispose()}dispose(){let e=this.scene.effectLayers;for(;e.length;)e[0].dispose()}_isReadyForMesh(e,t){let i=this._engine.currentRenderPassId,r=this.scene.effectLayers;for(let s of r){if(!s.hasMesh(e))continue;let o=s._mainTexture;this._engine.currentRenderPassId=o.renderPassId;for(let a of e.subMeshes)if(!s.isReady(a,t))return this._engine.currentRenderPassId=i,!1}return this._engine.currentRenderPassId=i,!0}_renderMainTexture(e){this._renderEffects=!1,this._needStencil=!1;let t=!1,i=this.scene.effectLayers;if(i&&i.length>0){this._previousStencilState=this._engine.getStencilBuffer();for(let r of i)if(r.shouldRender()&&(!r.camera||r.camera.cameraRigMode===Fe.RIG_MODE_NONE&&e===r.camera||r.camera.cameraRigMode!==Fe.RIG_MODE_NONE&&r.camera._rigCameras.indexOf(e)>-1)){this._renderEffects=!0,this._needStencil=this._needStencil||r.needStencil();let s=r._mainTexture;s._shouldRender()&&(this.scene.incrementRenderId(),s.render(!1,!1),t=!0)}this.scene.incrementRenderId()}return t}_setStencil(){this._needStencil&&this._engine.setStencilBuffer(!0)}_setStencilBack(){this._needStencil&&this._engine.setStencilBuffer(this._previousStencilState)}_draw(e){if(this._renderEffects){this._engine.setDepthBuffer(!1);let t=this.scene.effectLayers;for(let i=0;i<t.length;i++){let r=t[i];r.renderingGroupId===e&&r.shouldRender()&&r.render()}this._engine.setDepthBuffer(!0)}}_drawCamera(){this._renderEffects&&this._draw(-1)}_drawRenderingGroup(e){!this.scene._isInIntermediateRendering()&&this._renderEffects&&this._draw(e)}};hn._SceneComponentInitialization=n=>{let e=n._getComponent(Oe.NAME_EFFECTLAYER);e||(e=new jC(n),n._addComponent(e))};var qC=(()=>{class n extends tc{get ldrMerge(){return this._options.ldrMerge}set blurKernelSize(t){if(t===this._options.blurKernelSize)return;this._options.blurKernelSize=t;let i=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1.kernel=i,this._verticalBlurPostprocess1.kernel=i,this._horizontalBlurPostprocess2.kernel=i,this._verticalBlurPostprocess2.kernel=i}get blurKernelSize(){return this._options.blurKernelSize}set intensity(t){this._intensity=t}get intensity(){return this._intensity}constructor(t,i,r,s=!1){super(t,i,!1,s),this._intensity=1,this._includedOnlyMeshes=[],this._excludedMeshes=[],this._meshesUsingTheirOwnMaterials=[],this._renderPassId=0,this.neutralColor=new ce(0,0,0,1),this._options=Y({mainTextureRatio:.5,mainTextureFixedSize:0,mainTextureType:0,blurKernelSize:32,camera:null,renderingGroupId:-1,ldrMerge:!1,alphaBlendingMode:1},r),this._init(this._options),s&&this._createTextureAndPostProcesses()}getClassName(){return"GlowLayer"}_importShadersAsync(){return S(this,null,function*(){this._shaderLanguage===1?yield Promise.all([import("./chunk-LA7ELIX7.js"),import("./chunk-TTJLQDYV.js"),import("./chunk-GK3X5SFE.js")]):yield Promise.all([import("./chunk-NLCAKDMJ.js"),import("./chunk-EBYYQWWX.js"),import("./chunk-CZ4OIGAV.js")]),yield DT(n.prototype,this,"_importShadersAsync").call(this)})}getEffectName(){return n.EffectName}_createMergeEffect(){let t=`#define EMISSIVE 
`;return this._options.ldrMerge&&(t+=`#define LDR 
`),this._engine.createEffect("glowMapMerge",[T.PositionKind],["offset"],["textureSampler","textureSampler2"],t,void 0,void 0,void 0,void 0,this.shaderLanguage,this._shadersLoaded?void 0:()=>S(this,null,function*(){yield this._importShadersAsync(),this._shadersLoaded=!0}))}_createTextureAndPostProcesses(){let t=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1=new Ac("GlowLayerHBP1",this._scene.getEngine(),new me(1,0),t),this._verticalBlurPostprocess1=new Ac("GlowLayerVBP1",this._scene.getEngine(),new me(0,1),t),this._horizontalBlurPostprocess2=new Ac("GlowLayerHBP2",this._scene.getEngine(),new me(1,0),t),this._verticalBlurPostprocess2=new Ac("GlowLayerVBP2",this._scene.getEngine(),new me(0,1),t),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2]}_getEffectiveBlurKernelSize(){return this._options.blurKernelSize/2}isReady(t,i){let r=t.getMaterial(),s=t.getRenderingMesh();if(!r||!s)return!1;let o=r.emissiveTexture;return super._isSubMeshReady(t,i,o)}_canRenderMesh(t,i){return!0}_internalCompose(t){this.bindTexturesForCompose(t),t.setFloat("offset",this._intensity);let i=this._engine,r=i.getStencilBuffer();i.setStencilBuffer(!1),i.drawElementsType(Re.TriangleFillMode,0,6),i.setStencilBuffer(r)}_setEmissiveTextureAndColor(t,i,r){let s=1;if(this.customEmissiveTextureSelector?this._emissiveTextureAndColor.texture=this.customEmissiveTextureSelector(t,i,r):r?(this._emissiveTextureAndColor.texture=r.emissiveTexture,this._emissiveTextureAndColor.texture&&(s=this._emissiveTextureAndColor.texture.level)):this._emissiveTextureAndColor.texture=null,this.customEmissiveColorSelector)this.customEmissiveColorSelector(t,i,r,this._emissiveTextureAndColor.color);else if(r.emissiveColor){let o=r.emissiveIntensity??1;s*=o,this._emissiveTextureAndColor.color.set(r.emissiveColor.r*s,r.emissiveColor.g*s,r.emissiveColor.b*s,r.alpha)}else this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)}_shouldRenderMesh(t){return this.hasMesh(t)}_addCustomEffectDefines(t){t.push("#define GLOW")}addExcludedMesh(t){this._excludedMeshes.indexOf(t.uniqueId)===-1&&this._excludedMeshes.push(t.uniqueId)}removeExcludedMesh(t){let i=this._excludedMeshes.indexOf(t.uniqueId);i!==-1&&this._excludedMeshes.splice(i,1)}addIncludedOnlyMesh(t){this._includedOnlyMeshes.indexOf(t.uniqueId)===-1&&this._includedOnlyMeshes.push(t.uniqueId)}removeIncludedOnlyMesh(t){let i=this._includedOnlyMeshes.indexOf(t.uniqueId);i!==-1&&this._includedOnlyMeshes.splice(i,1)}hasMesh(t){return super.hasMesh(t)?this._includedOnlyMeshes.length?this._includedOnlyMeshes.indexOf(t.uniqueId)!==-1:this._excludedMeshes.length?this._excludedMeshes.indexOf(t.uniqueId)===-1:!0:!1}_useMeshMaterial(t){return t.material?._supportGlowLayer?!0:this._meshesUsingTheirOwnMaterials.length==0?!1:this._meshesUsingTheirOwnMaterials.indexOf(t.uniqueId)>-1}referenceMeshToUseItsOwnMaterial(t){t.resetDrawCache(this._renderPassId),this._meshesUsingTheirOwnMaterials.push(t.uniqueId),t.onDisposeObservable.add(()=>{this._disposeMesh(t)})}unReferenceMeshFromUsingItsOwnMaterial(t,i){let r=this._meshesUsingTheirOwnMaterials.indexOf(t.uniqueId);for(;r>=0;)this._meshesUsingTheirOwnMaterials.splice(r,1),r=this._meshesUsingTheirOwnMaterials.indexOf(t.uniqueId);t.resetDrawCache(i)}_disposeMesh(t){this.removeIncludedOnlyMesh(t),this.removeExcludedMesh(t)}}return n.EffectName="GlowLayer",n.DefaultBlurKernelSize=32,n})();Ce.prototype.getGlowLayerByName=function(n){for(let e=0;e<this.effectLayers?.length;e++)if(this.effectLayers[e].name===n&&this.effectLayers[e].getEffectName()===Mn.EffectName)return this.effectLayers[e];return null};var Mn=class n extends hn{static get EffectName(){return qC.EffectName}set blurKernelSize(e){this._thinEffectLayer.blurKernelSize=e}get blurKernelSize(){return this._thinEffectLayer.blurKernelSize}set intensity(e){this._thinEffectLayer.intensity=e}get intensity(){return this._thinEffectLayer.intensity}get customEmissiveColorSelector(){return this._thinEffectLayer.customEmissiveColorSelector}set customEmissiveColorSelector(e){this._thinEffectLayer.customEmissiveColorSelector=e}get customEmissiveTextureSelector(){return this._thinEffectLayer.customEmissiveTextureSelector}set customEmissiveTextureSelector(e){this._thinEffectLayer.customEmissiveTextureSelector=e}constructor(e,t,i){super(e,t,!1,new qC(e,t,i)),this._options=Y({mainTextureRatio:n.DefaultTextureRatio,blurKernelSize:32,mainTextureFixedSize:void 0,camera:null,mainTextureSamples:1,renderingGroupId:-1,ldrMerge:!1,alphaBlendingMode:1,mainTextureType:0,generateStencilBuffer:!1},i),this._init(this._options)}getEffectName(){return n.EffectName}_createMergeEffect(){return this._thinEffectLayer._createMergeEffect()}_createTextureAndPostProcesses(){this._thinEffectLayer._renderPassId=this._mainTexture.renderPassId;let e=this._mainTextureDesiredSize.width,t=this._mainTextureDesiredSize.height;e=this._engine.needPOTTextures?Jr(e,this._maxSize):e,t=this._engine.needPOTTextures?Jr(t,this._maxSize):t;let i=0;this._engine.getCaps().textureHalfFloatRender?i=2:i=0,this._blurTexture1=new hi("GlowLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture1.wrapU=Z.CLAMP_ADDRESSMODE,this._blurTexture1.wrapV=Z.CLAMP_ADDRESSMODE,this._blurTexture1.updateSamplingMode(Z.BILINEAR_SAMPLINGMODE),this._blurTexture1.renderParticles=!1,this._blurTexture1.ignoreCameraViewport=!0;let r=Math.floor(e/2),s=Math.floor(t/2);this._blurTexture2=new hi("GlowLayerBlurRTT2",{width:r,height:s},this._scene,!1,!0,i),this._blurTexture2.wrapU=Z.CLAMP_ADDRESSMODE,this._blurTexture2.wrapV=Z.CLAMP_ADDRESSMODE,this._blurTexture2.updateSamplingMode(Z.BILINEAR_SAMPLINGMODE),this._blurTexture2.renderParticles=!1,this._blurTexture2.ignoreCameraViewport=!0,this._textures=[this._blurTexture1,this._blurTexture2],this._thinEffectLayer.bindTexturesForCompose=u=>{u.setTexture("textureSampler",this._blurTexture1),u.setTexture("textureSampler2",this._blurTexture2),u.setFloat("offset",this.intensity)},this._thinEffectLayer._createTextureAndPostProcesses();let o=this._thinEffectLayer._postProcesses[0];this._horizontalBlurPostprocess1=new As("GlowLayerHBP1",o.direction,o.kernel,{samplingMode:Z.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),width:e,height:t,textureType:i,effectWrapper:o}),this._horizontalBlurPostprocess1.width=e,this._horizontalBlurPostprocess1.height=t,this._horizontalBlurPostprocess1.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess1.onApplyObservable.add(u=>{u.setTexture("textureSampler",this._mainTexture)});let a=this._thinEffectLayer._postProcesses[1];this._verticalBlurPostprocess1=new As("GlowLayerVBP1",a.direction,a.kernel,{samplingMode:Z.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),width:e,height:t,textureType:i,effectWrapper:a});let l=this._thinEffectLayer._postProcesses[2];this._horizontalBlurPostprocess2=new As("GlowLayerHBP2",l.direction,l.kernel,{samplingMode:Z.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),width:r,height:s,textureType:i,effectWrapper:l}),this._horizontalBlurPostprocess2.width=r,this._horizontalBlurPostprocess2.height=s,this._horizontalBlurPostprocess2.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess2.onApplyObservable.add(u=>{u.setTexture("textureSampler",this._blurTexture1)});let c=this._thinEffectLayer._postProcesses[3];this._verticalBlurPostprocess2=new As("GlowLayerVBP2",c.direction,c.kernel,{samplingMode:Z.BILINEAR_SAMPLINGMODE,engine:this._scene.getEngine(),width:r,height:s,textureType:i,effectWrapper:c}),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._postProcesses1=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1],this._postProcesses2=[this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._mainTexture.samples=this._options.mainTextureSamples,this._mainTexture.onAfterUnbindObservable.add(()=>{let u=this._blurTexture1.renderTarget;if(u){this._scene.postProcessManager.directRender(this._postProcesses1,u,!0);let h=this._blurTexture2.renderTarget;h&&this._scene.postProcessManager.directRender(this._postProcesses2,h,!0),this._engine.unBindFramebuffer(h??u,!0)}}),this._postProcesses.map(u=>{u.autoClear=!1})}isReady(e,t){return this._thinEffectLayer.isReady(e,t)}needStencil(){return!1}_canRenderMesh(e,t){return this._thinEffectLayer._canRenderMesh(e,t)}_internalRender(e){this._thinEffectLayer._internalCompose(e)}_setEmissiveTextureAndColor(e,t,i){this._thinEffectLayer._setEmissiveTextureAndColor(e,t,i)}_shouldRenderMesh(e){return this._thinEffectLayer._shouldRenderMesh(e)}_addCustomEffectDefines(e){this._thinEffectLayer._addCustomEffectDefines(e)}addExcludedMesh(e){this._thinEffectLayer.addExcludedMesh(e)}removeExcludedMesh(e){this._thinEffectLayer.removeExcludedMesh(e)}addIncludedOnlyMesh(e){this._thinEffectLayer.addIncludedOnlyMesh(e)}removeIncludedOnlyMesh(e){this._thinEffectLayer.removeIncludedOnlyMesh(e)}hasMesh(e){return this._thinEffectLayer.hasMesh(e)}_useMeshMaterial(e){return this._thinEffectLayer._useMeshMaterial(e)}referenceMeshToUseItsOwnMaterial(e){this._thinEffectLayer.referenceMeshToUseItsOwnMaterial(e)}unReferenceMeshFromUsingItsOwnMaterial(e){this._thinEffectLayer.unReferenceMeshFromUsingItsOwnMaterial(e,this._mainTexture.renderPassId)}_disposeMesh(e){this._thinEffectLayer._disposeMesh(e)}getClassName(){return"GlowLayer"}serialize(){let e=je.Serialize(this);e.customType="BABYLON.GlowLayer";let t;e.includedMeshes=[];let i=this._thinEffectLayer._includedOnlyMeshes;if(i.length)for(t=0;t<i.length;t++){let s=this._scene.getMeshByUniqueId(i[t]);s&&e.includedMeshes.push(s.id)}e.excludedMeshes=[];let r=this._thinEffectLayer._excludedMeshes;if(r.length)for(t=0;t<r.length;t++){let s=this._scene.getMeshByUniqueId(r[t]);s&&e.excludedMeshes.push(s.id)}return e}static Parse(e,t,i){let r=je.Parse(()=>new n(e.name,t,e.options),e,t,i),s;for(s=0;s<e.excludedMeshes.length;s++){let o=t.getMeshById(e.excludedMeshes[s]);o&&r.addExcludedMesh(o)}for(s=0;s<e.includedMeshes.length;s++){let o=t.getMeshById(e.includedMeshes[s]);o&&r.addIncludedOnlyMesh(o)}return r}};Mn.DefaultBlurKernelSize=32;Mn.DefaultTextureRatio=.5;w([B()],Mn.prototype,"blurKernelSize",null);w([B()],Mn.prototype,"intensity",null);w([B("options")],Mn.prototype,"_options",void 0);le("BABYLON.GlowLayer",Mn);function xD(n){let e=[],t=[],i=[],r=[],s=n.radius||.5,o=n.tessellation||64,a=n.arc&&(n.arc<=0||n.arc>1)?1:n.arc||1,l=n.sideOrientation===0?0:n.sideOrientation||K.DEFAULTSIDE;e.push(0,0,0),r.push(.5,.5);let c=Math.PI*2*a,u=a===1?c/o:c/(o-1),h=0;for(let p=0;p<o;p++){let g=Math.cos(h),_=Math.sin(h),y=(g+1)/2,b=(1-_)/2;e.push(s*g,s*_,0),r.push(y,Me?1-b:b),h+=u}a===1&&(e.push(e[3],e[4],e[5]),r.push(r[2],Me?1-r[3]:r[3]));let d=e.length/3;for(let p=1;p<d-1;p++)t.push(p+1,0,p);K.ComputeNormals(e,t,i),K._ComputeSides(l,e,t,i,r,n.frontUVs,n.backUVs);let f=new K;return f.indices=t,f.positions=e,f.normals=i,f.uvs=r,f}function YC(n,e={},t=null){let i=new E(n,t);return e.sideOrientation=E._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,xD(e).applyToMesh(i,e.updatable),i}K.CreateDisc=xD;E.CreateDisc=(n,e,t,i=null,r,s)=>YC(n,{radius:e,tessellation:t,sideOrientation:s,updatable:r},i);E._GroundMeshParser=(n,e)=>ic.Parse(n,e);var ic=class n extends E{constructor(e,t){super(e,t),this.generateOctree=!1}getClassName(){return"GroundMesh"}get subdivisions(){return Math.min(this._subdivisionsX,this._subdivisionsY)}get subdivisionsX(){return this._subdivisionsX}get subdivisionsY(){return this._subdivisionsY}optimize(e,t=32){this._subdivisionsX=e,this._subdivisionsY=e,this.subdivide(e);let i=this;i.createOrUpdateSubmeshesOctree&&i.createOrUpdateSubmeshesOctree(t)}getHeightAtCoordinates(e,t){let i=this.getWorldMatrix(),r=k.Matrix[5];i.invertToRef(r);let s=k.Vector3[8];if(m.TransformCoordinatesFromFloatsToRef(e,0,t,r,s),e=s.x,t=s.z,e<this._minX||e>=this._maxX||t<=this._minZ||t>this._maxZ)return this.position.y;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());let o=this._getFacetAt(e,t),a=-(o.x*e+o.z*t+o.w)/o.y;return m.TransformCoordinatesFromFloatsToRef(0,a,0,i,s),s.y}getNormalAtCoordinates(e,t){let i=new m(0,1,0);return this.getNormalAtCoordinatesToRef(e,t,i),i}getNormalAtCoordinatesToRef(e,t,i){let r=this.getWorldMatrix(),s=k.Matrix[5];r.invertToRef(s);let o=k.Vector3[8];if(m.TransformCoordinatesFromFloatsToRef(e,0,t,s,o),e=o.x,t=o.z,e<this._minX||e>this._maxX||t<this._minZ||t>this._maxZ)return this;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());let a=this._getFacetAt(e,t);return m.TransformNormalFromFloatsToRef(a.x,a.y,a.z,r,i),this}updateCoordinateHeights(){return(!this._heightQuads||this._heightQuads.length==0)&&this._initHeightQuads(),this._computeHeightQuads(),this}_getFacetAt(e,t){let i=Math.floor((e+this._maxX)*this._subdivisionsX/this._width),r=Math.floor(-(t+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),s=this._heightQuads[r*this._subdivisionsX+i],o;return t<s.slope.x*e+s.slope.y?o=s.facet1:o=s.facet2,o}_initHeightQuads(){let e=this._subdivisionsX,t=this._subdivisionsY;this._heightQuads=[];for(let i=0;i<t;i++)for(let r=0;r<e;r++){let s={slope:me.Zero(),facet1:new dt(0,0,0,0),facet2:new dt(0,0,0,0)};this._heightQuads[i*e+r]=s}return this}_computeHeightQuads(){let e=this.getVerticesData(T.PositionKind);if(!e)return this;let t=k.Vector3[3],i=k.Vector3[2],r=k.Vector3[1],s=k.Vector3[0],o=k.Vector3[4],a=k.Vector3[5],l=k.Vector3[6],c=k.Vector3[7],u=k.Vector3[8],h=0,d=0,f=0,p=0,g=0,_=0,y=0,b=this._subdivisionsX,A=this._subdivisionsY;for(let I=0;I<A;I++)for(let v=0;v<b;v++){h=v*3,d=I*(b+1)*3,f=(I+1)*(b+1)*3,t.x=e[d+h],t.y=e[d+h+1],t.z=e[d+h+2],i.x=e[d+h+3],i.y=e[d+h+4],i.z=e[d+h+5],r.x=e[f+h],r.y=e[f+h+1],r.z=e[f+h+2],s.x=e[f+h+3],s.y=e[f+h+4],s.z=e[f+h+5],p=(s.z-t.z)/(s.x-t.x),g=t.z-p*t.x,i.subtractToRef(t,o),r.subtractToRef(t,a),s.subtractToRef(t,l),m.CrossToRef(l,a,c),m.CrossToRef(o,l,u),c.normalize(),u.normalize(),_=-(c.x*t.x+c.y*t.y+c.z*t.z),y=-(u.x*i.x+u.y*i.y+u.z*i.z);let x=this._heightQuads[I*b+v];x.slope.copyFromFloats(p,g),x.facet1.copyFromFloats(c.x,c.y,c.z,_),x.facet2.copyFromFloats(u.x,u.y,u.z,y)}return this}serialize(e){super.serialize(e),e.subdivisionsX=this._subdivisionsX,e.subdivisionsY=this._subdivisionsY,e.minX=this._minX,e.maxX=this._maxX,e.minZ=this._minZ,e.maxZ=this._maxZ,e.width=this._width,e.height=this._height}static Parse(e,t){let i=new n(e.name,t);return i._subdivisionsX=e.subdivisionsX||1,i._subdivisionsY=e.subdivisionsY||1,i._minX=e.minX,i._maxX=e.maxX,i._minZ=e.minZ,i._maxZ=e.maxZ,i._width=e.width,i._height=e.height,i}};function KC(n){let e=[],t=[],i=[],r=[],s,o,a=n.width||n.size||1,l=n.height||n.size||1,c=(n.subdivisionsX||n.subdivisions||1)|0,u=(n.subdivisionsY||n.subdivisions||1)|0;for(s=0;s<=u;s++)for(o=0;o<=c;o++){let d=new m(o*a/c-a/2,0,(u-s)*l/u-l/2),f=new m(0,1,0);t.push(d.x,d.y,d.z),i.push(f.x,f.y,f.z),r.push(o/c,Me?s/u:1-s/u)}for(s=0;s<u;s++)for(o=0;o<c;o++)e.push(o+1+(s+1)*(c+1)),e.push(o+1+s*(c+1)),e.push(o+s*(c+1)),e.push(o+(s+1)*(c+1)),e.push(o+1+(s+1)*(c+1)),e.push(o+s*(c+1));let h=new K;return h.indices=e,h.positions=t,h.normals=i,h.uvs=r,h}function CD(n){let e=n.xmin!==void 0&&n.xmin!==null?n.xmin:-1,t=n.zmin!==void 0&&n.zmin!==null?n.zmin:-1,i=n.xmax!==void 0&&n.xmax!==null?n.xmax:1,r=n.zmax!==void 0&&n.zmax!==null?n.zmax:1,s=n.subdivisions||{w:1,h:1},o=n.precision||{w:1,h:1},a=[],l=[],c=[],u=[],h,d,f,p;s.h=s.h<1?1:s.h,s.w=s.w<1?1:s.w,o.w=o.w<1?1:o.w,o.h=o.h<1?1:o.h;let g={w:(i-e)/s.w,h:(r-t)/s.h};function _(b,A,I,v){let x=l.length/3,C=o.w+1;for(h=0;h<o.h;h++)for(d=0;d<o.w;d++){let D=[x+d+h*C,x+(d+1)+h*C,x+(d+1)+(h+1)*C,x+d+(h+1)*C];a.push(D[1]),a.push(D[2]),a.push(D[3]),a.push(D[0]),a.push(D[1]),a.push(D[3])}let R=m.Zero(),M=new m(0,1,0);for(h=0;h<=o.h;h++)for(R.z=h*(v-A)/o.h+A,d=0;d<=o.w;d++)R.x=d*(I-b)/o.w+b,R.y=0,l.push(R.x,R.y,R.z),c.push(M.x,M.y,M.z),u.push(d/o.w,h/o.h)}for(f=0;f<s.h;f++)for(p=0;p<s.w;p++)_(e+p*g.w,t+f*g.h,e+(p+1)*g.w,t+(f+1)*g.h);let y=new K;return y.indices=a,y.positions=l,y.normals=c,y.uvs=u,y}function TD(n){let e=[],t=[],i=[],r=[],s,o,a=n.colorFilter||new U(.3,.59,.11),l=n.alphaFilter||0,c=!1;if(n.minHeight>n.maxHeight){c=!0;let h=n.maxHeight;n.maxHeight=n.minHeight,n.minHeight=h}for(s=0;s<=n.subdivisions;s++)for(o=0;o<=n.subdivisions;o++){let h=new m(o*n.width/n.subdivisions-n.width/2,0,(n.subdivisions-s)*n.height/n.subdivisions-n.height/2),d=(h.x+n.width/2)/n.width*(n.bufferWidth-1)|0,f=(1-(h.z+n.height/2)/n.height)*(n.bufferHeight-1)|0,p=(d+f*n.bufferWidth)*4,g=n.buffer[p]/255,_=n.buffer[p+1]/255,y=n.buffer[p+2]/255,b=n.buffer[p+3]/255;c&&(g=1-g,_=1-_,y=1-y);let A=g*a.r+_*a.g+y*a.b;b>=l?h.y=n.minHeight+(n.maxHeight-n.minHeight)*A:h.y=n.minHeight-tt,n.heightBuffer&&(n.heightBuffer[s*(n.subdivisions+1)+o]=h.y),t.push(h.x,h.y,h.z),i.push(0,0,0),r.push(o/n.subdivisions,1-s/n.subdivisions)}for(s=0;s<n.subdivisions;s++)for(o=0;o<n.subdivisions;o++){let h=o+1+(s+1)*(n.subdivisions+1),d=o+1+s*(n.subdivisions+1),f=o+s*(n.subdivisions+1),p=o+(s+1)*(n.subdivisions+1),g=t[h*3+1]>=n.minHeight,_=t[d*3+1]>=n.minHeight,y=t[f*3+1]>=n.minHeight;g&&_&&y&&(e.push(h),e.push(d),e.push(f)),t[p*3+1]>=n.minHeight&&g&&y&&(e.push(p),e.push(h),e.push(f))}K.ComputeNormals(t,e,i);let u=new K;return u.indices=e,u.positions=t,u.normals=i,u.uvs=r,u}function sa(n,e={},t){let i=new ic(n,t);return i._setReady(!1),i._subdivisionsX=e.subdivisionsX||e.subdivisions||1,i._subdivisionsY=e.subdivisionsY||e.subdivisions||1,i._width=e.width||1,i._height=e.height||1,i._maxX=i._width/2,i._maxZ=i._height/2,i._minX=-i._maxX,i._minZ=-i._maxZ,KC(e).applyToMesh(i,e.updatable),i._setReady(!0),i}function XC(n,e,t=null){let i=new E(n,t);return CD(e).applyToMesh(i,e.updatable),i}function ZC(n,e,t={},i=null){let r=t.width||10,s=t.height||10,o=t.subdivisions||1,a=t.minHeight||0,l=t.maxHeight||1,c=t.colorFilter||new U(.3,.59,.11),u=t.alphaFilter||0,h=t.updatable,d=t.onReady;i=i||ye.LastCreatedScene;let f=new ic(n,i);f._subdivisionsX=o,f._subdivisionsY=o,f._width=r,f._height=s,f._maxX=f._width/2,f._maxZ=f._height/2,f._minX=-f._maxX,f._minZ=-f._maxZ,f._setReady(!1);let p;t.passHeightBufferInCallback&&(p=new Float32Array((o+1)*(o+1)));let g=(_,y,b)=>{TD({width:r,height:s,subdivisions:o,minHeight:a,maxHeight:l,colorFilter:c,buffer:_,bufferWidth:y,bufferHeight:b,alphaFilter:u,heightBuffer:p}).applyToMesh(f,h),d&&d(f,p),f._setReady(!0)};if(typeof e=="string"){let _=y=>{let b=y.width,A=y.height;if(i.isDisposed)return;let I=i?.getEngine().resizeImageBitmap(y,b,A);g(I,b,A)};z.LoadImage(e,_,t.onError?t.onError:()=>{},i.offlineProvider)}else g(e.data,e.width,e.height);return f}K.CreateGround=KC;K.CreateTiledGround=CD;K.CreateGroundFromHeightMap=TD;E.CreateGround=(n,e,t,i,r,s)=>sa(n,{width:e,height:t,subdivisions:i,updatable:s},r);E.CreateTiledGround=(n,e,t,i,r,s,o,a,l)=>XC(n,{xmin:e,zmin:t,xmax:i,zmax:r,subdivisions:s,precision:o,updatable:l},a);E.CreateGroundFromHeightMap=(n,e,t,i,r,s,o,a,l,c,u)=>ZC(n,e,{width:t,height:i,subdivisions:r,minHeight:s,maxHeight:o,updatable:l,onReady:c,alphaFilter:u},a);function SD(n){let t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],i=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],r=[],s=[],o=n.width||n.size||1,a=n.height||n.size||1,l=n.depth||n.size||1,c=n.wrap||!1,u=n.topBaseAt===void 0?1:n.topBaseAt,h=n.bottomBaseAt===void 0?0:n.bottomBaseAt;u=(u+4)%4,h=(h+4)%4;let d=[2,0,3,1],f=[2,0,1,3],p=d[u],g=f[h],_=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(c){t=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],_=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let C=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],R=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]],M=[17,18,19,16],D=[22,23,20,21];for(;p>0;)C.unshift(C.pop()),M.unshift(M.pop()),p--;for(;g>0;)R.unshift(R.pop()),D.unshift(D.pop()),g--;C=C.flat(),R=R.flat(),_=_.concat(C).concat(R),t.push(M[0],M[2],M[3],M[0],M[1],M[2]),t.push(D[0],D[2],D[3],D[0],D[1],D[2])}let y=[o/2,a/2,l/2];s=_.reduce((C,R,M)=>C.concat(R*y[M%3]),[]);let b=n.sideOrientation===0?0:n.sideOrientation||K.DEFAULTSIDE,A=n.faceUV||new Array(6),I=n.faceColors,v=[];for(let C=0;C<6;C++)A[C]===void 0&&(A[C]=new dt(0,0,1,1)),I&&I[C]===void 0&&(I[C]=new ce(1,1,1,1));for(let C=0;C<6;C++)if(r.push(A[C].z,Me?1-A[C].w:A[C].w),r.push(A[C].x,Me?1-A[C].w:A[C].w),r.push(A[C].x,Me?1-A[C].y:A[C].y),r.push(A[C].z,Me?1-A[C].y:A[C].y),I)for(let R=0;R<4;R++)v.push(I[C].r,I[C].g,I[C].b,I[C].a);K._ComputeSides(b,s,t,i,r,n.frontUVs,n.backUVs);let x=new K;if(x.indices=t,x.positions=s,x.normals=i,x.uvs=r,I){let C=b===K.DOUBLESIDE?v.concat(v):v;x.colors=C}return x}function oa(n,e={},t=null){let i=new E(n,t);return e.sideOrientation=E._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,SD(e).applyToMesh(i,e.updatable),i}K.CreateBox=SD;E.CreateBox=(n,e,t=null,i,r)=>oa(n,{size:e,sideOrientation:r,updatable:i},t);function nc(n){let e=n.pattern||E.NO_FLIP,t=n.tileWidth||n.tileSize||1,i=n.tileHeight||n.tileSize||1,r=n.alignHorizontal||0,s=n.alignVertical||0,o=n.width||n.size||1,a=Math.floor(o/t),l=o-a*t,c=n.height||n.size||1,u=Math.floor(c/i),h=c-u*i,d=t*a/2,f=i*u/2,p=0,g=0,_=0,y=0,b=0,A=0;if(l>0||h>0){switch(_=-d,y=-f,b=d,A=f,r){case E.CENTER:l/=2,_-=l,b+=l;break;case E.LEFT:b+=l,p=-l/2;break;case E.RIGHT:_-=l,p=l/2;break}switch(s){case E.CENTER:h/=2,y-=h,A+=h;break;case E.BOTTOM:A+=h,g=-h/2;break;case E.TOP:y-=h,g=h/2;break}}let I=[],v=[],x=[];x[0]=[0,0,1,0,1,1,0,1],x[1]=[0,0,1,0,1,1,0,1],(e===E.ROTATE_TILE||e===E.ROTATE_ROW)&&(x[1]=[1,1,0,1,0,0,1,0]),(e===E.FLIP_TILE||e===E.FLIP_ROW)&&(x[1]=[1,0,0,0,0,1,1,1]),(e===E.FLIP_N_ROTATE_TILE||e===E.FLIP_N_ROTATE_ROW)&&(x[1]=[0,1,1,1,1,0,0,0]);let C=[],R=[],M=[],D=0;for(let J=0;J<u;J++)for(let he=0;he<a;he++)I.push(-d+he*t+p,-f+J*i+g,0),I.push(-d+(he+1)*t+p,-f+J*i+g,0),I.push(-d+(he+1)*t+p,-f+(J+1)*i+g,0),I.push(-d+he*t+p,-f+(J+1)*i+g,0),M.push(D,D+1,D+3,D+1,D+2,D+3),e===E.FLIP_TILE||e===E.ROTATE_TILE||e===E.FLIP_N_ROTATE_TILE?C=C.concat(x[(he%2+J%2)%2]):e===E.FLIP_ROW||e===E.ROTATE_ROW||e===E.FLIP_N_ROTATE_ROW?C=C.concat(x[J%2]):C=C.concat(x[0]),R.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),v.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1),D+=4;if(l>0||h>0){let J=h>0&&(s===E.CENTER||s===E.TOP),he=h>0&&(s===E.CENTER||s===E.BOTTOM),oe=l>0&&(r===E.CENTER||r===E.RIGHT),pe=l>0&&(r===E.CENTER||r===E.LEFT),be=[],$,j,N,G;if(J&&oe&&(I.push(_+p,y+g,0),I.push(-d+p,y+g,0),I.push(-d+p,y+h+g,0),I.push(_+p,y+h+g,0),M.push(D,D+1,D+3,D+1,D+2,D+3),D+=4,$=1-l/t,j=1-h/i,N=1,G=1,be=[$,j,N,j,N,G,$,G],e===E.ROTATE_ROW&&(be=[1-$,1-j,1-N,1-j,1-N,1-G,1-$,1-G]),e===E.FLIP_ROW&&(be=[1-$,j,1-N,j,1-N,G,1-$,G]),e===E.FLIP_N_ROTATE_ROW&&(be=[$,1-j,N,1-j,N,1-G,$,1-G]),C=C.concat(be),R.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),v.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),J&&pe&&(I.push(d+p,y+g,0),I.push(b+p,y+g,0),I.push(b+p,y+h+g,0),I.push(d+p,y+h+g,0),M.push(D,D+1,D+3,D+1,D+2,D+3),D+=4,$=0,j=1-h/i,N=l/t,G=1,be=[$,j,N,j,N,G,$,G],(e===E.ROTATE_ROW||e===E.ROTATE_TILE&&a%2===0)&&(be=[1-$,1-j,1-N,1-j,1-N,1-G,1-$,1-G]),(e===E.FLIP_ROW||e===E.FLIP_TILE&&a%2===0)&&(be=[1-$,j,1-N,j,1-N,G,1-$,G]),(e===E.FLIP_N_ROTATE_ROW||e===E.FLIP_N_ROTATE_TILE&&a%2===0)&&(be=[$,1-j,N,1-j,N,1-G,$,1-G]),C=C.concat(be),R.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),v.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),he&&oe&&(I.push(_+p,f+g,0),I.push(-d+p,f+g,0),I.push(-d+p,A+g,0),I.push(_+p,A+g,0),M.push(D,D+1,D+3,D+1,D+2,D+3),D+=4,$=1-l/t,j=0,N=1,G=h/i,be=[$,j,N,j,N,G,$,G],(e===E.ROTATE_ROW&&u%2===1||e===E.ROTATE_TILE&&u%1===0)&&(be=[1-$,1-j,1-N,1-j,1-N,1-G,1-$,1-G]),(e===E.FLIP_ROW&&u%2===1||e===E.FLIP_TILE&&u%2===0)&&(be=[1-$,j,1-N,j,1-N,G,1-$,G]),(e===E.FLIP_N_ROTATE_ROW&&u%2===1||e===E.FLIP_N_ROTATE_TILE&&u%2===0)&&(be=[$,1-j,N,1-j,N,1-G,$,1-G]),C=C.concat(be),R.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),v.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),he&&pe&&(I.push(d+p,f+g,0),I.push(b+p,f+g,0),I.push(b+p,A+g,0),I.push(d+p,A+g,0),M.push(D,D+1,D+3,D+1,D+2,D+3),D+=4,$=0,j=0,N=l/t,G=h/i,be=[$,j,N,j,N,G,$,G],(e===E.ROTATE_ROW&&u%2===1||e===E.ROTATE_TILE&&(u+a)%2===1)&&(be=[1-$,1-j,1-N,1-j,1-N,1-G,1-$,1-G]),(e===E.FLIP_ROW&&u%2===1||e===E.FLIP_TILE&&(u+a)%2===1)&&(be=[1-$,j,1-N,j,1-N,G,1-$,G]),(e===E.FLIP_N_ROTATE_ROW&&u%2===1||e===E.FLIP_N_ROTATE_TILE&&(u+a)%2===1)&&(be=[$,1-j,N,1-j,N,1-G,$,1-G]),C=C.concat(be),R.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),v.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),J){let V=[];$=0,j=1-h/i,N=1,G=1,V[0]=[$,j,N,j,N,G,$,G],V[1]=[$,j,N,j,N,G,$,G],(e===E.ROTATE_TILE||e===E.ROTATE_ROW)&&(V[1]=[1-$,1-j,1-N,1-j,1-N,1-G,1-$,1-G]),(e===E.FLIP_TILE||e===E.FLIP_ROW)&&(V[1]=[1-$,j,1-N,j,1-N,G,1-$,G]),(e===E.FLIP_N_ROTATE_TILE||e===E.FLIP_N_ROTATE_ROW)&&(V[1]=[$,1-j,N,1-j,N,1-G,$,1-G]);for(let q=0;q<a;q++)I.push(-d+q*t+p,y+g,0),I.push(-d+(q+1)*t+p,y+g,0),I.push(-d+(q+1)*t+p,y+h+g,0),I.push(-d+q*t+p,y+h+g,0),M.push(D,D+1,D+3,D+1,D+2,D+3),D+=4,e===E.FLIP_TILE||e===E.ROTATE_TILE||e===E.FLIP_N_ROTATE_TILE?C=C.concat(V[(q+1)%2]):e===E.FLIP_ROW||e===E.ROTATE_ROW||e===E.FLIP_N_ROTATE_ROW?C=C.concat(V[1]):C=C.concat(V[0]),R.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),v.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(he){let V=[];$=0,j=0,N=1,G=h/i,V[0]=[$,j,N,j,N,G,$,G],V[1]=[$,j,N,j,N,G,$,G],(e===E.ROTATE_TILE||e===E.ROTATE_ROW)&&(V[1]=[1-$,1-j,1-N,1-j,1-N,1-G,1-$,1-G]),(e===E.FLIP_TILE||e===E.FLIP_ROW)&&(V[1]=[1-$,j,1-N,j,1-N,G,1-$,G]),(e===E.FLIP_N_ROTATE_TILE||e===E.FLIP_N_ROTATE_ROW)&&(V[1]=[$,1-j,N,1-j,N,1-G,$,1-G]);for(let q=0;q<a;q++)I.push(-d+q*t+p,A-h+g,0),I.push(-d+(q+1)*t+p,A-h+g,0),I.push(-d+(q+1)*t+p,A+g,0),I.push(-d+q*t+p,A+g,0),M.push(D,D+1,D+3,D+1,D+2,D+3),D+=4,e===E.FLIP_TILE||e===E.ROTATE_TILE||e===E.FLIP_N_ROTATE_TILE?C=C.concat(V[(q+u)%2]):e===E.FLIP_ROW||e===E.ROTATE_ROW||e===E.FLIP_N_ROTATE_ROW?C=C.concat(V[u%2]):C=C.concat(V[0]),R.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),v.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(oe){let V=[];$=1-l/t,j=0,N=1,G=1,V[0]=[$,j,N,j,N,G,$,G],V[1]=[$,j,N,j,N,G,$,G],(e===E.ROTATE_TILE||e===E.ROTATE_ROW)&&(V[1]=[1-$,1-j,1-N,1-j,1-N,1-G,1-$,1-G]),(e===E.FLIP_TILE||e===E.FLIP_ROW)&&(V[1]=[1-$,j,1-N,j,1-N,G,1-$,G]),(e===E.FLIP_N_ROTATE_TILE||e===E.FLIP_N_ROTATE_ROW)&&(V[1]=[$,1-j,N,1-j,N,1-G,$,1-G]);for(let q=0;q<u;q++)I.push(_+p,-f+q*i+g,0),I.push(_+l+p,-f+q*i+g,0),I.push(_+l+p,-f+(q+1)*i+g,0),I.push(_+p,-f+(q+1)*i+g,0),M.push(D,D+1,D+3,D+1,D+2,D+3),D+=4,e===E.FLIP_TILE||e===E.ROTATE_TILE||e===E.FLIP_N_ROTATE_TILE?C=C.concat(V[(q+1)%2]):e===E.FLIP_ROW||e===E.ROTATE_ROW||e===E.FLIP_N_ROTATE_ROW?C=C.concat(V[q%2]):C=C.concat(V[0]),R.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),v.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(pe){let V=[];$=0,j=0,N=l/i,G=1,V[0]=[$,j,N,j,N,G,$,G],V[1]=[$,j,N,j,N,G,$,G],(e===E.ROTATE_TILE||e===E.ROTATE_ROW)&&(V[1]=[1-$,1-j,1-N,1-j,1-N,1-G,1-$,1-G]),(e===E.FLIP_TILE||e===E.FLIP_ROW)&&(V[1]=[1-$,j,1-N,j,1-N,G,1-$,G]),(e===E.FLIP_N_ROTATE_TILE||e===E.FLIP_N_ROTATE_ROW)&&(V[1]=[$,1-j,N,1-j,N,1-G,$,1-G]);for(let q=0;q<u;q++)I.push(b-l+p,-f+q*i+g,0),I.push(b+p,-f+q*i+g,0),I.push(b+p,-f+(q+1)*i+g,0),I.push(b-l+p,-f+(q+1)*i+g,0),M.push(D,D+1,D+3,D+1,D+2,D+3),D+=4,e===E.FLIP_TILE||e===E.ROTATE_TILE||e===E.FLIP_N_ROTATE_TILE?C=C.concat(V[(q+a)%2]):e===E.FLIP_ROW||e===E.ROTATE_ROW||e===E.FLIP_N_ROTATE_ROW?C=C.concat(V[q%2]):C=C.concat(V[0]),R.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),v.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}}let W=n.sideOrientation===0?0:n.sideOrientation||K.DEFAULTSIDE;K._ComputeSides(W,I,M,v,C,n.frontUVs,n.backUVs);let ee=new K;ee.indices=M,ee.positions=I,ee.normals=v,ee.uvs=C;let ae=W===K.DOUBLESIDE?R.concat(R):R;return ee.colors=ae,ee}function ID(n,e,t=null){let i=new E(n,t);return e.sideOrientation=E._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,nc(e).applyToMesh(i,e.updatable),i}K.CreateTiledPlane=nc;var fg=1,QC=-1;function AD(n){let t=n.faceUV||new Array(6),i=n.faceColors,r=n.pattern||E.NO_FLIP,s=n.width||n.size||1,o=n.height||n.size||1,a=n.depth||n.size||1,l=n.tileWidth||n.tileSize||1,c=n.tileHeight||n.tileSize||1,u=n.alignHorizontal||0,h=n.alignVertical||0,d=n.sideOrientation===0?0:n.sideOrientation||K.DEFAULTSIDE;for(let J=0;J<6;J++)t[J]===void 0&&(t[J]=new dt(0,0,1,1)),i&&i[J]===void 0&&(i[J]=new ce(1,1,1,1));let f=s/2,p=o/2,g=a/2,_=[];for(let J=0;J<2;J++)_[J]=nc({pattern:r,tileWidth:l,tileHeight:c,width:s,height:o,alignVertical:h,alignHorizontal:u,sideOrientation:d});for(let J=2;J<4;J++)_[J]=nc({pattern:r,tileWidth:l,tileHeight:c,width:a,height:o,alignVertical:h,alignHorizontal:u,sideOrientation:d});let y=h;h===E.BOTTOM?y=E.TOP:h===E.TOP&&(y=E.BOTTOM);for(let J=4;J<6;J++)_[J]=nc({pattern:r,tileWidth:l,tileHeight:c,width:s,height:a,alignVertical:y,alignHorizontal:u,sideOrientation:d});let b=[],A=[],I=[],v=[],x=[],C=[],R=[],M=[],D=0,W=0;for(let J=0;J<6;J++){let he=_[J].positions.length;C[J]=[],R[J]=[];for(let oe=0;oe<he/3;oe++)C[J].push(new m(_[J].positions[3*oe],_[J].positions[3*oe+1],_[J].positions[3*oe+2])),R[J].push(new m(_[J].normals[3*oe],_[J].normals[3*oe+1],_[J].normals[3*oe+2]));D=_[J].uvs.length,M[J]=[];for(let oe=0;oe<D;oe+=2)M[J][oe]=t[J].x+(t[J].z-t[J].x)*_[J].uvs[oe],M[J][oe+1]=t[J].y+(t[J].w-t[J].y)*_[J].uvs[oe+1],Me&&(M[J][oe+1]=1-M[J][oe+1]);if(I=I.concat(M[J]),v=v.concat(_[J].indices.map(oe=>oe+W)),W+=C[J].length,i){let oe=i[J];for(let pe=0;pe<C[J].length;pe++)x.push(oe.r,oe.g,oe.b,oe.a)}}let ee=[{m:L.RotationY(Math.PI),t:new m(0,0,g),op:fg},{m:L.Identity(),t:new m(0,0,g),op:QC},{m:L.RotationY(-Math.PI/2),t:new m(f,0,0),op:fg},{m:L.RotationY(Math.PI/2),t:new m(f,0,0),op:QC},{m:L.RotationX(Math.PI/2),t:new m(0,p,0),op:fg},{m:L.RotationX(-Math.PI/2),t:new m(0,p,0),op:QC}];for(let J=0;J<6;J++){let{m:he,t:oe,op:pe}=ee[J];for(let be of C[J]){let $=m.TransformCoordinates(be,he),j=pe===fg?$.add(oe):$.subtract(oe);b.push(j.x,j.y,j.z)}for(let be of R[J]){let $=m.TransformNormal(be,he);A.push($.x,$.y,$.z)}}let ae=new K;if(ae.indices=v,ae.positions=b,ae.normals=A,ae.uvs=I,i){let J=d===K.DOUBLESIDE?x.concat(x):x;ae.colors=J}return ae}function ED(n,e,t=null){let i=new E(n,t);return e.sideOrientation=E._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,AD(e).applyToMesh(i,e.updatable),i}K.CreateTiledBox=AD;function wD(n){let e=(n.segments||32)|0,t=n.diameterX||n.diameter||1,i=n.diameterY||n.diameter||1,r=n.diameterZ||n.diameter||1,s=n.arc&&(n.arc<=0||n.arc>1)?1:n.arc||1,o=n.slice&&n.slice<=0?1:n.slice||1,a=n.sideOrientation===0?0:n.sideOrientation||K.DEFAULTSIDE,l=!!n.dedupTopBottomIndices,c=new m(t/2,i/2,r/2),u=2+e,h=2*u,d=[],f=[],p=[],g=[];for(let y=0;y<=u;y++){let b=y/u,A=b*Math.PI*o;for(let I=0;I<=h;I++){let v=I/h,x=v*Math.PI*2*s,C=L.RotationZ(-A),R=L.RotationY(x),M=m.TransformCoordinates(m.Up(),C),D=m.TransformCoordinates(M,R),W=D.multiply(c),ee=D.divide(c).normalize();f.push(W.x,W.y,W.z),p.push(ee.x,ee.y,ee.z),g.push(v,Me?1-b:b)}if(y>0){let I=f.length/3;for(let v=I-2*(h+1);v+h+2<I;v++)l?(y>1&&(d.push(v),d.push(v+1),d.push(v+h+1)),(y<u||o<1)&&(d.push(v+h+1),d.push(v+1),d.push(v+h+2))):(d.push(v),d.push(v+1),d.push(v+h+1),d.push(v+h+1),d.push(v+1),d.push(v+h+2))}}K._ComputeSides(a,f,d,p,g,n.frontUVs,n.backUVs);let _=new K;return _.indices=d,_.positions=f,_.normals=p,_.uvs=g,_}function eo(n,e={},t=null){let i=new E(n,t);return e.sideOrientation=E._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,wD(e).applyToMesh(i,e.updatable),i}K.CreateSphere=wD;E.CreateSphere=(n,e,t,i,r,s)=>eo(n,{segments:e,diameterX:t,diameterY:t,diameterZ:t,sideOrientation:s,updatable:r},i);function MD(n){let e=n.height||2,t=n.diameterTop===0?0:n.diameterTop||n.diameter||1,i=n.diameterBottom===0?0:n.diameterBottom||n.diameter||1;t=t||1e-5,i=i||1e-5;let r=(n.tessellation||24)|0,s=(n.subdivisions||1)|0,o=!!n.hasRings,a=!!n.enclose,l=n.cap===0?0:n.cap||E.CAP_ALL,c=n.arc&&(n.arc<=0||n.arc>1)?1:n.arc||1,u=n.sideOrientation===0?0:n.sideOrientation||K.DEFAULTSIDE,h=n.faceUV||new Array(3),d=n.faceColors,f=c!==1&&a?2:0,p=o?s:1,g=2+(1+f)*p,_;for(_=0;_<g;_++)d&&d[_]===void 0&&(d[_]=new ce(1,1,1,1));for(_=0;_<g;_++)h&&h[_]===void 0&&(h[_]=new dt(0,0,1,1));let y=[],b=[],A=[],I=[],v=[],x=Math.PI*2*c/r,C,R,M,D=(i-t)/2/e,W=m.Zero(),ee=m.Zero(),ae=m.Zero(),J=m.Zero(),he=m.Zero(),oe=Li.Y,pe,be,$,j=1,N=1,G=0,V=0;for(pe=0;pe<=s;pe++)for(R=pe/s,M=(R*(t-i)+i)/2,j=o&&pe!==0&&pe!==s?2:1,$=0;$<j;$++){for(o&&(N+=$),a&&(N+=2*$),be=0;be<=r;be++)C=be*x,W.x=Math.cos(-C)*M,W.y=-e/2+R*e,W.z=Math.sin(-C)*M,t===0&&pe===s?(ee.x=A[A.length-(r+1)*3],ee.y=A[A.length-(r+1)*3+1],ee.z=A[A.length-(r+1)*3+2]):(ee.x=W.x,ee.z=W.z,ee.y=Math.sqrt(ee.x*ee.x+ee.z*ee.z)*D,ee.normalize()),be===0&&(ae.copyFrom(W),J.copyFrom(ee)),b.push(W.x,W.y,W.z),A.push(ee.x,ee.y,ee.z),o?V=G!==N?h[N].y:h[N].w:V=h[N].y+(h[N].w-h[N].y)*R,I.push(h[N].x+(h[N].z-h[N].x)*be/r,Me?1-V:V),d&&v.push(d[N].r,d[N].g,d[N].b,d[N].a);c!==1&&a&&(b.push(W.x,W.y,W.z),b.push(0,W.y,0),b.push(0,W.y,0),b.push(ae.x,ae.y,ae.z),m.CrossToRef(oe,ee,he),he.normalize(),A.push(he.x,he.y,he.z,he.x,he.y,he.z),m.CrossToRef(J,oe,he),he.normalize(),A.push(he.x,he.y,he.z,he.x,he.y,he.z),o?V=G!==N?h[N+1].y:h[N+1].w:V=h[N+1].y+(h[N+1].w-h[N+1].y)*R,I.push(h[N+1].x,Me?1-V:V),I.push(h[N+1].z,Me?1-V:V),o?V=G!==N?h[N+2].y:h[N+2].w:V=h[N+2].y+(h[N+2].w-h[N+2].y)*R,I.push(h[N+2].x,Me?1-V:V),I.push(h[N+2].z,Me?1-V:V),d&&(v.push(d[N+1].r,d[N+1].g,d[N+1].b,d[N+1].a),v.push(d[N+1].r,d[N+1].g,d[N+1].b,d[N+1].a),v.push(d[N+2].r,d[N+2].g,d[N+2].b,d[N+2].a),v.push(d[N+2].r,d[N+2].g,d[N+2].b,d[N+2].a))),G!==N&&(G=N)}let q=c!==1&&a?r+4:r;for(pe=0,N=0;N<s;N++){let Ie=0,Je=0,jt=0,Ct=0;for(be=0;be<r;be++)Ie=pe*(q+1)+be,Je=(pe+1)*(q+1)+be,jt=pe*(q+1)+(be+1),Ct=(pe+1)*(q+1)+(be+1),y.push(Ie,Je,jt),y.push(Ct,jt,Je);c!==1&&a&&(y.push(Ie+2,Je+2,jt+2),y.push(Ct+2,jt+2,Je+2),y.push(Ie+4,Je+4,jt+4),y.push(Ct+4,jt+4,Je+4)),pe=o?pe+2:pe+1}let xe=Ie=>{let Je=Ie?t/2:i/2;if(Je===0)return;let jt,Ct,qt,_e=Ie?h[g-1]:h[0],$e=null;d&&($e=Ie?d[g-1]:d[0]);let Se=b.length/3,yi=Ie?e/2:-e/2,Pn=new m(0,yi,0);b.push(Pn.x,Pn.y,Pn.z),A.push(0,Ie?1:-1,0);let qi=_e.y+(_e.w-_e.y)*.5;I.push(_e.x+(_e.z-_e.x)*.5,Me?1-qi:qi),$e&&v.push($e.r,$e.g,$e.b,$e.a);let Yn=new me(.5,.5);for(qt=0;qt<=r;qt++){jt=Math.PI*2*qt*c/r;let ya=Math.cos(-jt),mr=Math.sin(-jt);Ct=new m(ya*Je,yi,mr*Je);let va=new me(ya*Yn.x+.5,mr*Yn.y+.5);b.push(Ct.x,Ct.y,Ct.z),A.push(0,Ie?1:-1,0);let ba=_e.y+(_e.w-_e.y)*va.y;I.push(_e.x+(_e.z-_e.x)*va.x,Me?1-ba:ba),$e&&v.push($e.r,$e.g,$e.b,$e.a)}for(qt=0;qt<r;qt++)Ie?(y.push(Se),y.push(Se+(qt+2)),y.push(Se+(qt+1))):(y.push(Se),y.push(Se+(qt+1)),y.push(Se+(qt+2)))};(l===E.CAP_START||l===E.CAP_ALL)&&xe(!1),(l===E.CAP_END||l===E.CAP_ALL)&&xe(!0),K._ComputeSides(u,b,y,A,I,n.frontUVs,n.backUVs);let re=new K;return re.indices=y,re.positions=b,re.normals=A,re.uvs=I,d&&(re.colors=v),re}function aa(n,e={},t){let i=new E(n,t);return e.sideOrientation=E._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,MD(e).applyToMesh(i,e.updatable),i}K.CreateCylinder=MD;E.CreateCylinder=(n,e,t,i,r,s,o,a,l)=>((o===void 0||!(o instanceof Ce))&&(o!==void 0&&(l=a||E.DEFAULTSIDE,a=o),o=s,s=1),aa(n,{height:e,diameterTop:t,diameterBottom:i,tessellation:r,subdivisions:s,sideOrientation:l,updatable:a},o));function DD(n){let e=[],t=[],i=[],r=[],s=n.diameter||1,o=n.thickness||.5,a=(n.tessellation||16)|0,l=n.sideOrientation===0?0:n.sideOrientation||K.DEFAULTSIDE,c=a+1;for(let h=0;h<=a;h++){let d=h/a,f=h*Math.PI*2/a-Math.PI/2,p=L.Translation(s/2,0,0).multiply(L.RotationY(f));for(let g=0;g<=a;g++){let _=1-g/a,y=g*Math.PI*2/a+Math.PI,b=Math.cos(y),A=Math.sin(y),I=new m(b,A,0),v=I.scale(o/2),x=new me(d,_);v=m.TransformCoordinates(v,p),I=m.TransformNormal(I,p),t.push(v.x,v.y,v.z),i.push(I.x,I.y,I.z),r.push(x.x,Me?1-x.y:x.y);let C=(h+1)%c,R=(g+1)%c;e.push(h*c+g),e.push(h*c+R),e.push(C*c+g),e.push(h*c+R),e.push(C*c+R),e.push(C*c+g)}}K._ComputeSides(l,t,e,i,r,n.frontUVs,n.backUVs);let u=new K;return u.indices=e,u.positions=t,u.normals=i,u.uvs=r,u}function pr(n,e={},t){let i=new E(n,t);return e.sideOrientation=E._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,DD(e).applyToMesh(i,e.updatable),i}K.CreateTorus=DD;E.CreateTorus=(n,e,t,i,r,s,o)=>pr(n,{diameter:e,thickness:t,tessellation:i,sideOrientation:o,updatable:s},r);function RD(n){let e=[],t=[],i=[],r=[],s=n.radius||2,o=n.tube||.5,a=n.radialSegments||32,l=n.tubularSegments||32,c=n.p||2,u=n.q||3,h=n.sideOrientation===0?0:n.sideOrientation||K.DEFAULTSIDE,d=_=>{let y=Math.cos(_),b=Math.sin(_),A=u/c*_,I=Math.cos(A),v=s*(2+I)*.5*y,x=s*(2+I)*b*.5,C=s*Math.sin(A)*.5;return new m(v,x,C)},f,p;for(f=0;f<=a;f++){let y=f%a/a*2*c*Math.PI,b=d(y),A=d(y+.01),I=A.subtract(b),v=A.add(b),x=m.Cross(I,v);for(v=m.Cross(x,I),x.normalize(),v.normalize(),p=0;p<l;p++){let R=p%l/l*2*Math.PI,M=-o*Math.cos(R),D=o*Math.sin(R);t.push(b.x+M*v.x+D*x.x),t.push(b.y+M*v.y+D*x.y),t.push(b.z+M*v.z+D*x.z),r.push(f/a),r.push(Me?1-p/l:p/l)}}for(f=0;f<a;f++)for(p=0;p<l;p++){let _=(p+1)%l,y=f*l+p,b=(f+1)*l+p,A=(f+1)*l+_,I=f*l+_;e.push(I),e.push(b),e.push(y),e.push(I),e.push(A),e.push(b)}K.ComputeNormals(t,e,i),K._ComputeSides(h,t,e,i,r,n.frontUVs,n.backUVs);let g=new K;return g.indices=e,g.positions=t,g.normals=i,g.uvs=r,g}function JC(n,e={},t){let i=new E(n,t);return e.sideOrientation=E._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,RD(e).applyToMesh(i,e.updatable),i}K.CreateTorusKnot=RD;E.CreateTorusKnot=(n,e,t,i,r,s,o,a,l,c)=>JC(n,{radius:e,tube:t,radialSegments:i,tubularSegments:r,p:s,q:o,sideOrientation:c,updatable:l},a);var eT=class extends me{constructor(e,t){super(e.x,e.y),this.index=t}},ah=class{constructor(){this.elements=[]}add(e){let t=[];for(let i of e){let r=new eT(i,this.elements.length);t.push(r),this.elements.push(r)}return t}computeBounds(){let e=new me(this.elements[0].x,this.elements[0].y),t=new me(this.elements[0].x,this.elements[0].y);for(let i of this.elements)i.x<e.x?e.x=i.x:i.x>t.x&&(t.x=i.x),i.y<e.y?e.y=i.y:i.y>t.y&&(t.y=i.y);return{min:e,max:t,width:t.x-e.x,height:t.y-e.y}}};var pg=class{_addToepoint(e){for(let t of e)this._epoints.push(t.x,t.y)}constructor(e,t,i,r=earcut){this._points=new ah,this._outlinepoints=new ah,this._holes=new Array,this._epoints=new Array,this._eholes=new Array,this.bjsEarcut=r,this._name=e,this._scene=i||ye.LastCreatedScene;let s;t instanceof Ph?s=t.getPoints():s=t,this._addToepoint(s),this._points.add(s),this._outlinepoints.add(s),typeof this.bjsEarcut>"u"&&P.Warn("Earcut was not found, the polygon will not be built.")}addHole(e){this._points.add(e);let t=new ah;return t.add(e),this._holes.push(t),this._eholes.push(this._epoints.length/2),this._addToepoint(e),this}build(e=!1,t=0,i=2){let r=new E(this._name,this._scene),s=this.buildVertexData(t,i);return r.setVerticesData(T.PositionKind,s.positions,e),r.setVerticesData(T.NormalKind,s.normals,e),r.setVerticesData(T.UVKind,s.uvs,e),r.setIndices(s.indices),r}buildVertexData(e=0,t=2){let i=new K,r=[],s=[],o=[],a=this._points.computeBounds();for(let u of this._points.elements)r.push(0,1,0),s.push(u.x,0,u.y),o.push((u.x-a.min.x)/a.width,(u.y-a.min.y)/a.height);let l=[],c=this.bjsEarcut(this._epoints,this._eholes,2);for(let u=0;u<c.length;u++)l.push(c[u]);if(e>0){let u=s.length/3;for(let d of this._points.elements)r.push(0,-1,0),s.push(d.x,-e,d.y),o.push(1-(d.x-a.min.x)/a.width,1-(d.y-a.min.y)/a.height);let h=l.length;for(let d=0;d<h;d+=3){let f=l[d+0],p=l[d+1],g=l[d+2];l.push(g+u),l.push(p+u),l.push(f+u)}this._addSide(s,r,o,l,a,this._outlinepoints,e,!1,t);for(let d of this._holes)this._addSide(s,r,o,l,a,d,e,!0,t)}return i.indices=l,i.positions=s,i.normals=r,i.uvs=o,i}_addSide(e,t,i,r,s,o,a,l,c){let u=e.length/3,h=0;for(let d=0;d<o.elements.length;d++){let f=o.elements[d],p=o.elements[(d+1)%o.elements.length];e.push(f.x,0,f.y),e.push(f.x,-a,f.y),e.push(p.x,0,p.y),e.push(p.x,-a,p.y);let g=o.elements[(d+o.elements.length-1)%o.elements.length],_=o.elements[(d+2)%o.elements.length],y=new m(-(p.y-f.y),0,p.x-f.x),b=new m(-(f.y-g.y),0,f.x-g.x),A=new m(-(_.y-p.y),0,_.x-p.x);l||(y=y.scale(-1),b=b.scale(-1),A=A.scale(-1));let I=y.normalizeToNew(),v=b.normalizeToNew(),x=A.normalizeToNew(),C=m.Dot(v,I);C>c?C<tt-1?v=new m(f.x,0,f.y).subtract(new m(p.x,0,p.y)).normalize():v=b.add(y).normalize():v=I;let R=m.Dot(A,y);R>c?R<tt-1?x=new m(p.x,0,p.y).subtract(new m(f.x,0,f.y)).normalize():x=A.add(y).normalize():x=I,i.push(h/s.width,0),i.push(h/s.width,1),h+=y.length(),i.push(h/s.width,0),i.push(h/s.width,1),t.push(v.x,v.y,v.z),t.push(v.x,v.y,v.z),t.push(x.x,x.y,x.z),t.push(x.x,x.y,x.z),l?(r.push(u),r.push(u+2),r.push(u+1),r.push(u+1),r.push(u+2),r.push(u+3)):(r.push(u),r.push(u+1),r.push(u+2),r.push(u+1),r.push(u+3),r.push(u+2)),u+=4}}};function PD(n,e,t,i,r,s,o){let a=t||new Array(3),l=i,c=[],u=o||!1;for(let M=0;M<3;M++)a[M]===void 0&&(a[M]=new dt(0,0,1,1)),l&&l[M]===void 0&&(l[M]=new ce(1,1,1,1));let h=n.getVerticesData(T.PositionKind),d=n.getVerticesData(T.NormalKind),f=n.getVerticesData(T.UVKind),p=n.getIndices(),g=h.length/9,_=0,y=0,b=0,A=0,I=0,v=[0];if(u)for(let M=g;M<h.length/3;M+=4)y=h[3*(M+2)]-h[3*M],b=h[3*(M+2)+2]-h[3*M+2],A=Math.sqrt(y*y+b*b),I+=A,v.push(I);let x=0,C=0;for(let M=0;M<d.length;M+=3)Math.abs(d[M+1])<.001&&(C=1),Math.abs(d[M+1]-1)<.001&&(C=0),Math.abs(d[M+1]+1)<.001&&(C=2),x=M/3,C===1?(_=x-g,_%4<1.5?u?f[2*x]=a[C].x+(a[C].z-a[C].x)*v[Math.floor(_/4)]/I:f[2*x]=a[C].x:u?f[2*x]=a[C].x+(a[C].z-a[C].x)*v[Math.floor(_/4)+1]/I:f[2*x]=a[C].z,_%2===0?f[2*x+1]=Me?1-a[C].w:a[C].w:f[2*x+1]=Me?1-a[C].y:a[C].y):(f[2*x]=(1-f[2*x])*a[C].x+f[2*x]*a[C].z,f[2*x+1]=(1-f[2*x+1])*a[C].y+f[2*x+1]*a[C].w,Me&&(f[2*x+1]=1-f[2*x+1])),l&&c.push(l[C].r,l[C].g,l[C].b,l[C].a);K._ComputeSides(e,h,p,d,f,r,s);let R=new K;if(R.indices=p,R.positions=h,R.normals=d,R.uvs=f,l){let M=e===K.DOUBLESIDE?c.concat(c):c;R.colors=M}return R}function mg(n,e,t=null,i=earcut){e.sideOrientation=E._GetDefaultSideOrientation(e.sideOrientation);let r=e.shape,s=e.holes||[],o=e.depth||0,a=e.smoothingThreshold||2,l=[],c=[];for(let p=0;p<r.length;p++)l[p]=new me(r[p].x,r[p].z);l[0].equalsWithEpsilon(l[l.length-1],1e-8)&&l.pop();let h=new pg(n,l,t||ye.LastCreatedScene,i);for(let p=0;p<s.length;p++){c=[];for(let g=0;g<s[p].length;g++)c.push(new me(s[p][g].x,s[p][g].z));h.addHole(c)}let d=h.build(!1,o,a);return d._originalBuilderSideOrientation=e.sideOrientation,PD(d,e.sideOrientation,e.faceUV,e.faceColors,e.frontUVs,e.backUVs,e.wrap).applyToMesh(d,e.updatable),d}function lh(n,e,t=null,i=earcut){return mg(n,e,t,i)}K.CreatePolygon=PD;E.CreatePolygon=(n,e,t,i,r,s,o=earcut)=>mg(n,{shape:e,holes:i,updatable:r,sideOrientation:s},t,o);E.ExtrudePolygon=(n,e,t,i,r,s,o,a=earcut)=>lh(n,{shape:e,holes:r,depth:t,updatable:s,sideOrientation:o},i,a);function tT(n,e,t=null){let i=e.arc?e.arc<=0||e.arc>1?1:e.arc:1,r=e.closed===void 0?!0:e.closed,s=e.shape,o=e.radius||1,a=e.tessellation||64,l=e.clip||0,c=e.updatable,u=E._GetDefaultSideOrientation(e.sideOrientation),h=e.cap||E.NO_CAP,d=Math.PI*2,f=[],p=e.invertUV||!1,g=0,_=0,y=d/a*i,b,A;for(g=0;g<=a-l;g++){for(A=[],(h==E.CAP_START||h==E.CAP_ALL)&&(A.push(new m(0,s[0].y,0)),A.push(new m(Math.cos(g*y)*s[0].x*o,s[0].y,Math.sin(g*y)*s[0].x*o))),_=0;_<s.length;_++)b=new m(Math.cos(g*y)*s[_].x*o,s[_].y,Math.sin(g*y)*s[_].x*o),A.push(b);(h==E.CAP_END||h==E.CAP_ALL)&&(A.push(new m(Math.cos(g*y)*s[s.length-1].x*o,s[s.length-1].y,Math.sin(g*y)*s[s.length-1].x*o)),A.push(new m(0,s[s.length-1].y,0))),f.push(A)}return fr(n,{pathArray:f,closeArray:r,sideOrientation:u,updatable:c,invertUV:p,frontUVs:e.frontUVs,backUVs:e.backUVs},t)}E.CreateLathe=(n,e,t,i,r,s,o)=>tT(n,{shape:e,radius:t,tessellation:i,sideOrientation:o,updatable:s},r);function OD(n){let e=[],t=[],i=[],r=[],s=n.width!==void 0?n.width:n.size!==void 0?n.size:1,o=n.height!==void 0?n.height:n.size!==void 0?n.size:1,a=n.sideOrientation===0?0:n.sideOrientation||K.DEFAULTSIDE,l=s/2,c=o/2;t.push(-l,-c,0),i.push(0,0,-1),r.push(0,Me?1:0),t.push(l,-c,0),i.push(0,0,-1),r.push(1,Me?1:0),t.push(l,c,0),i.push(0,0,-1),r.push(1,Me?0:1),t.push(-l,c,0),i.push(0,0,-1),r.push(0,Me?0:1),e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),K._ComputeSides(a,t,e,i,r,n.frontUVs,n.backUVs);let u=new K;return u.indices=e,u.positions=t,u.normals=i,u.uvs=r,u}function ch(n,e={},t=null){let i=new E(n,t);return e.sideOrientation=E._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,OD(e).applyToMesh(i,e.updatable),e.sourcePlane&&(i.translate(e.sourcePlane.normal,-e.sourcePlane.d),i.setDirection(e.sourcePlane.normal.scale(-1))),i}K.CreatePlane=OD;E.CreatePlane=(n,e,t,i,r)=>ch(n,{size:e,width:e,height:e,sideOrientation:r,updatable:i},t);function iT(n,e,t=null){let i=e.path,r=e.instance,s=1;e.radius!==void 0?s=e.radius:r&&(s=r._creationDataStorage.radius);let o=e.tessellation||64,a=e.radiusFunction||null,l=e.cap||E.NO_CAP,c=e.invertUV||!1,u=e.updatable,h=E._GetDefaultSideOrientation(e.sideOrientation);e.arc=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1;let d=(y,b,A,I,v,x,C,R)=>{let M=b.getTangents(),D=b.getNormals(),W=b.getDistances(),ae=Math.PI*2/v*R,he=x||(()=>I),oe,pe,be,$,j=k.Matrix[0],N=C===E.NO_CAP||C===E.CAP_END?0:2;for(let V=0;V<y.length;V++){pe=he(V,W[V]),oe=Array(),be=D[V];for(let q=0;q<v;q++)L.RotationAxisToRef(M[V],ae*q,j),$=oe[q]?oe[q]:m.Zero(),m.TransformCoordinatesToRef(be,j,$),$.scaleInPlace(pe).addInPlace(y[V]),oe[q]=$;A[N]=oe,N++}let G=(V,q)=>{let xe=Array();for(let re=0;re<V;re++)xe.push(y[q]);return xe};switch(C){case E.NO_CAP:break;case E.CAP_START:A[0]=G(v,0),A[1]=A[2].slice(0);break;case E.CAP_END:A[N]=A[N-1].slice(0),A[N+1]=G(v,y.length-1);break;case E.CAP_ALL:A[0]=G(v,0),A[1]=A[2].slice(0),A[N]=A[N-1].slice(0),A[N+1]=G(v,y.length-1);break;default:break}return A},f,p;if(r){let y=r._creationDataStorage,b=e.arc||y.arc;return f=y.path3D.update(i),p=d(i,f,y.pathArray,s,y.tessellation,a,y.cap,b),r=fr("",{pathArray:p,instance:r}),y.path3D=f,y.pathArray=p,y.arc=b,y.radius=s,r}f=new Sc(i);let g=new Array;l=l<0||l>3?0:l,p=d(i,f,g,s,o,a,l,e.arc);let _=fr(n,{pathArray:p,closePath:!0,closeArray:!1,updatable:u,sideOrientation:h,invertUV:c,frontUVs:e.frontUVs,backUVs:e.backUVs},t);return _._creationDataStorage.pathArray=p,_._creationDataStorage.path3D=f,_._creationDataStorage.tessellation=o,_._creationDataStorage.cap=l,_._creationDataStorage.arc=e.arc,_._creationDataStorage.radius=s,_}E.CreateTube=(n,e,t,i,r,s,o,a,l,c)=>iT(n,{path:e,radius:t,tessellation:i,radiusFunction:r,arc:1,cap:s,updatable:a,sideOrientation:l,instance:c},o);function ND(n){let e=[];e[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]},e[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]},e[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]},e[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]},e[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]},e[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]},e[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]},e[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]},e[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]},e[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]},e[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]},e[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]},e[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]},e[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]},e[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};let t=n.type&&(n.type<0||n.type>=e.length)?0:n.type||0,i=n.size,r=n.sizeX||i||1,s=n.sizeY||i||1,o=n.sizeZ||i||1,a=n.custom||e[t],l=a.face.length,c=n.faceUV||new Array(l),u=n.faceColors,h=n.flat===void 0?!0:n.flat,d=n.sideOrientation===0?0:n.sideOrientation||K.DEFAULTSIDE,f=[],p=[],g=[],_=[],y=[],b=0,A=0,I=[],v=0,x=0,C,R,M,D,W,ee;if(h)for(x=0;x<l;x++)u&&u[x]===void 0&&(u[x]=new ce(1,1,1,1)),c&&c[x]===void 0&&(c[x]=new dt(0,0,1,1));if(h)for(x=0;x<l;x++){let J=a.face[x].length;for(M=2*Math.PI/J,D=.5*Math.tan(M/2),W=.5,v=0;v<J;v++)f.push(a.vertex[a.face[x][v]][0]*r,a.vertex[a.face[x][v]][1]*s,a.vertex[a.face[x][v]][2]*o),I.push(b),b++,C=c[x].x+(c[x].z-c[x].x)*(.5+D),R=c[x].y+(c[x].w-c[x].y)*(W-.5),_.push(C,Me?1-R:R),ee=D*Math.cos(M)-W*Math.sin(M),W=D*Math.sin(M)+W*Math.cos(M),D=ee,u&&y.push(u[x].r,u[x].g,u[x].b,u[x].a);for(v=0;v<J-2;v++)p.push(I[0+A],I[v+2+A],I[v+1+A]);A+=J}else{for(v=0;v<a.vertex.length;v++)f.push(a.vertex[v][0]*r,a.vertex[v][1]*s,a.vertex[v][2]*o),_.push(0,Me?1:0);for(x=0;x<l;x++)for(v=0;v<a.face[x].length-2;v++)p.push(a.face[x][0],a.face[x][v+2],a.face[x][v+1])}K.ComputeNormals(f,p,g),K._ComputeSides(d,f,p,g,_,n.frontUVs,n.backUVs);let ae=new K;return ae.positions=f,ae.indices=p,ae.normals=g,ae.uvs=_,u&&h&&(ae.colors=y),ae}function uh(n,e={},t=null){let i=new E(n,t);return e.sideOrientation=E._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,ND(e).applyToMesh(i,e.updatable),i}K.CreatePolyhedron=ND;E.CreatePolyhedron=(n,e,t)=>uh(n,e,t);function FD(n){let e=n.sideOrientation||K.DEFAULTSIDE,t=n.radius||1,i=n.flat===void 0?!0:n.flat,r=(n.subdivisions||4)|0,s=n.radiusX||t,o=n.radiusY||t,a=n.radiusZ||t,l=(1+Math.sqrt(5))/2,c=[-1,l,-0,1,l,0,-1,-l,0,1,-l,0,0,-1,-l,0,1,-l,0,-1,l,0,1,l,l,0,1,l,0,-1,-l,0,1,-l,0,-1],u=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],h=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],d=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],f=138/1024,p=239/1024,g=60/1024,_=26/1024,y=-40/1024,b=20/1024,A=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],I=[],v=[],x=[],C=[],R=0,M=new Array(3),D=new Array(3),W;for(W=0;W<3;W++)M[W]=m.Zero(),D[W]=me.Zero();for(let ae=0;ae<20;ae++){for(W=0;W<3;W++){let he=u[3*ae+W];M[W].copyFromFloats(c[3*h[he]],c[3*h[he]+1],c[3*h[he]+2]),M[W].normalize(),D[W].copyFromFloats(d[2*he]*f+g+A[ae]*y,d[2*he+1]*p+_+A[ae]*b)}let J=(he,oe,pe,be)=>{let $=m.Lerp(M[0],M[2],oe/r),j=m.Lerp(M[1],M[2],oe/r),N=r===oe?M[2]:m.Lerp($,j,he/(r-oe));N.normalize();let G;if(i){let re=m.Lerp(M[0],M[2],be/r),Ie=m.Lerp(M[1],M[2],be/r);G=m.Lerp(re,Ie,pe/(r-be))}else G=new m(N.x,N.y,N.z);G.x/=s,G.y/=o,G.z/=a,G.normalize();let V=me.Lerp(D[0],D[2],oe/r),q=me.Lerp(D[1],D[2],oe/r),xe=r===oe?D[2]:me.Lerp(V,q,he/(r-oe));v.push(N.x*s,N.y*o,N.z*a),x.push(G.x,G.y,G.z),C.push(xe.x,Me?1-xe.y:xe.y),I.push(R),R++};for(let he=0;he<r;he++)for(let oe=0;oe+he<r;oe++)J(oe,he,oe+1/3,he+1/3),J(oe+1,he,oe+1/3,he+1/3),J(oe,he+1,oe+1/3,he+1/3),oe+he+1<r&&(J(oe+1,he,oe+2/3,he+2/3),J(oe+1,he+1,oe+2/3,he+2/3),J(oe,he+1,oe+2/3,he+2/3))}K._ComputeSides(e,v,I,x,C,n.frontUVs,n.backUVs);let ee=new K;return ee.indices=I,ee.positions=v,ee.normals=x,ee.uvs=C,ee}function rc(n,e={},t=null){let i=new E(n,t);return e.sideOrientation=E._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,FD(e).applyToMesh(i,e.updatable),i}K.CreateIcoSphere=FD;E.CreateIcoSphere=(n,e,t)=>rc(n,e,t);var Pk=new m(1,0,0),Ok=new m(-1,0,0),Nk=new m(0,1,0),Fk=new m(0,-1,0),Lk=new m(0,0,1),Bk=new m(0,0,-1),gg=class n{constructor(e=m.Zero(),t=m.Up(),i=me.Zero(),r=0,s=0,o=null,a=null,l=null,c=null){this.position=e,this.normal=t,this.uv=i,this.vertexIdx=r,this.vertexIdxForBones=s,this.localPositionOverride=o,this.localNormalOverride=a,this.matrixIndicesOverride=l,this.matrixWeightsOverride=c}clone(){return new n(this.position.clone(),this.normal.clone(),this.uv.clone(),this.vertexIdx,this.vertexIdxForBones,this.localPositionOverride?.slice(),this.localNormalOverride?.slice(),this.matrixIndicesOverride?.slice(),this.matrixWeightsOverride?.slice())}};function nT(n,e,t){let i=!!e.skeleton,r=!!e.morphTargetManager?.numTargets,s=t.localMode||i,o=e.getIndices(),a=i||r?e.getPositionData(!0,!0):e.getVerticesData(T.PositionKind),l=i||r?e.getNormalsData(!0,!0):e.getVerticesData(T.NormalKind),c=s?i?e.getVerticesData(T.PositionKind):a:null,u=s?i?e.getVerticesData(T.NormalKind):l:null,h=e.getVerticesData(T.UVKind),d=i?e.getVerticesData(T.MatricesIndicesKind):null,f=i?e.getVerticesData(T.MatricesWeightsKind):null,p=i?e.getVerticesData(T.MatricesIndicesExtraKind):null,g=i?e.getVerticesData(T.MatricesWeightsExtraKind):null,_=t.position||m.Zero(),y=t.normal||m.Up(),b=t.size||m.One(),A=t.angle||0;if(!y){let pe=new m(0,0,1),be=e.getScene().activeCamera,$=m.TransformCoordinates(pe,be.getWorldMatrix());y=be.globalPosition.subtract($)}let I=-Math.atan2(y.z,y.x)-Math.PI/2,v=Math.sqrt(y.x*y.x+y.z*y.z),x=Math.atan2(y.y,v),C=new K;C.indices=[],C.positions=[],C.normals=[],C.uvs=[],C.matricesIndices=i?[]:null,C.matricesWeights=i?[]:null,C.matricesIndicesExtra=p?[]:null,C.matricesWeightsExtra=g?[]:null;let R=0,M=(pe,be)=>{let $=new gg;if(!o||!a||!l)return $;let j=o[pe];if($.vertexIdx=j*3,$.vertexIdxForBones=j*4,$.position=new m(a[j*3],a[j*3+1],a[j*3+2]),m.TransformCoordinatesToRef($.position,be,$.position),$.normal=new m(l[j*3],l[j*3+1],l[j*3+2]),m.TransformNormalToRef($.normal,be,$.normal),t.captureUVS&&h){let N=h[j*2+1];$.uv=new me(h[j*2],Me?1-N:N)}return $},D=[0,0,0,0],W=(pe,be)=>{if(pe.length===0)return pe;let $=.5*Math.abs(m.Dot(b,be)),j=(V,q,xe,re)=>{for(let Ie=0;Ie<re;++Ie)if(V[xe+Ie]===q)return xe+Ie;return-1},N=(V,q)=>{let xe=m.GetClipFactor(V.position,q.position,be,$),re=D,Ie=D;if(d&&f){let bc=V.matrixIndicesOverride?0:V.vertexIdxForBones,Hg=V.matrixIndicesOverride??d,ET=V.matrixWeightsOverride??f,Wg=q.matrixIndicesOverride?0:q.vertexIdxForBones,wT=q.matrixIndicesOverride??d,MT=q.matrixWeightsOverride??f;re=[0,0,0,0],Ie=[0,0,0,0];let ao=0;for(let Kn=0;Kn<4;++Kn)if(ET[bc+Kn]>0){let xc=j(wT,Hg[bc+Kn],Wg,4);re[ao]=Hg[bc+Kn],Ie[ao]=Qt(ET[bc+Kn],xc>=0?MT[xc]:0,xe),ao++}for(let Kn=0;Kn<4&&ao<4;++Kn){let xc=wT[Wg+Kn];j(Hg,xc,bc,4)===-1&&(re[ao]=xc,Ie[ao]=Qt(0,MT[Wg+Kn],xe),ao++)}let Mh=Ie[0]+Ie[1]+Ie[2]+Ie[3];Ie[0]/=Mh,Ie[1]/=Mh,Ie[2]/=Mh,Ie[3]/=Mh}let Je=V.localPositionOverride?V.localPositionOverride[0]:c?.[V.vertexIdx]??0,jt=V.localPositionOverride?V.localPositionOverride[1]:c?.[V.vertexIdx+1]??0,Ct=V.localPositionOverride?V.localPositionOverride[2]:c?.[V.vertexIdx+2]??0,qt=q.localPositionOverride?q.localPositionOverride[0]:c?.[q.vertexIdx]??0,_e=q.localPositionOverride?q.localPositionOverride[1]:c?.[q.vertexIdx+1]??0,$e=q.localPositionOverride?q.localPositionOverride[2]:c?.[q.vertexIdx+2]??0,Se=V.localNormalOverride?V.localNormalOverride[0]:u?.[V.vertexIdx]??0,yi=V.localNormalOverride?V.localNormalOverride[1]:u?.[V.vertexIdx+1]??0,Pn=V.localNormalOverride?V.localNormalOverride[2]:u?.[V.vertexIdx+2]??0,qi=q.localNormalOverride?q.localNormalOverride[0]:u?.[q.vertexIdx]??0,Yn=q.localNormalOverride?q.localNormalOverride[1]:u?.[q.vertexIdx+1]??0,ya=q.localNormalOverride?q.localNormalOverride[2]:u?.[q.vertexIdx+2]??0,mr=Se+(qi-Se)*xe,va=yi+(Yn-yi)*xe,ba=Pn+(ya-Pn)*xe,zg=Math.sqrt(mr*mr+va*va+ba*ba);return new gg(m.Lerp(V.position,q.position,xe),m.Lerp(V.normal,q.normal,xe).normalize(),me.Lerp(V.uv,q.uv,xe),-1,-1,c?[Je+(qt-Je)*xe,jt+(_e-jt)*xe,Ct+($e-Ct)*xe]:null,u?[mr/zg,va/zg,ba/zg]:null,re,Ie)},G=null;pe.length>3&&(G=[]);for(let V=0;V<pe.length;V+=3){let q=0,xe=null,re=null,Ie=null,Je=null,jt=m.Dot(pe[V].position,be)-$,Ct=m.Dot(pe[V+1].position,be)-$,qt=m.Dot(pe[V+2].position,be)-$,_e=jt>0,$e=Ct>0,Se=qt>0;switch(q=(_e?1:0)+($e?1:0)+(Se?1:0),q){case 0:pe.length>3?(G.push(pe[V]),G.push(pe[V+1]),G.push(pe[V+2])):G=pe;break;case 1:if(G=G??new Array,_e&&(xe=pe[V+1],re=pe[V+2],Ie=N(pe[V],xe),Je=N(pe[V],re)),$e){xe=pe[V],re=pe[V+2],Ie=N(pe[V+1],xe),Je=N(pe[V+1],re),G.push(Ie),G.push(re.clone()),G.push(xe.clone()),G.push(re.clone()),G.push(Ie.clone()),G.push(Je);break}Se&&(xe=pe[V],re=pe[V+1],Ie=N(pe[V+2],xe),Je=N(pe[V+2],re)),xe&&re&&Ie&&Je&&(G.push(xe.clone()),G.push(re.clone()),G.push(Ie),G.push(Je),G.push(Ie.clone()),G.push(re.clone()));break;case 2:G=G??new Array,_e||(xe=pe[V].clone(),re=N(xe,pe[V+1]),Ie=N(xe,pe[V+2]),G.push(xe),G.push(re),G.push(Ie)),$e||(xe=pe[V+1].clone(),re=N(xe,pe[V+2]),Ie=N(xe,pe[V]),G.push(xe),G.push(re),G.push(Ie)),Se||(xe=pe[V+2].clone(),re=N(xe,pe[V]),Ie=N(xe,pe[V+1]),G.push(xe),G.push(re),G.push(Ie));break;case 3:break}}return G},ee=e instanceof E?e:null,ae=ee?._thinInstanceDataStorage.matrixData,J=ee?.thinInstanceCount||1,he=k.Matrix[0];he.copyFrom(L.IdentityReadOnly);for(let pe=0;pe<J;++pe){if(ee?.hasThinInstances&&ae){let V=pe*16;he.setRowFromFloats(0,ae[V+0],ae[V+1],ae[V+2],ae[V+3]),he.setRowFromFloats(1,ae[V+4],ae[V+5],ae[V+6],ae[V+7]),he.setRowFromFloats(2,ae[V+8],ae[V+9],ae[V+10],ae[V+11]),he.setRowFromFloats(3,ae[V+12],ae[V+13],ae[V+14],ae[V+15])}let be=L.RotationYawPitchRoll(I,x,A).multiply(L.Translation(_.x,_.y,_.z)),$=L.Invert(be),j=e.getWorldMatrix(),N=he.multiply(j).multiply($),G=new Array(3);for(let V=0;V<o.length;V+=3){let q=G;if(q[0]=M(V,N),q[1]=M(V+1,N),q[2]=M(V+2,N),!(t.cullBackFaces&&-q[0].normal.z<=0&&-q[1].normal.z<=0&&-q[2].normal.z<=0)&&(q=W(q,Pk),!!q&&(q=W(q,Ok),!!q&&(q=W(q,Nk),!!q&&(q=W(q,Fk),!!q&&(q=W(q,Lk),!!q&&(q=W(q,Bk),!!q)))))))for(let xe=0;xe<q.length;xe++){let re=q[xe];if(C.indices.push(R),s?(re.localPositionOverride?(C.positions[R*3]=re.localPositionOverride[0],C.positions[R*3+1]=re.localPositionOverride[1],C.positions[R*3+2]=re.localPositionOverride[2]):c&&(C.positions[R*3]=c[re.vertexIdx],C.positions[R*3+1]=c[re.vertexIdx+1],C.positions[R*3+2]=c[re.vertexIdx+2]),re.localNormalOverride?(C.normals[R*3]=re.localNormalOverride[0],C.normals[R*3+1]=re.localNormalOverride[1],C.normals[R*3+2]=re.localNormalOverride[2]):u&&(C.normals[R*3]=u[re.vertexIdx],C.normals[R*3+1]=u[re.vertexIdx+1],C.normals[R*3+2]=u[re.vertexIdx+2])):(re.position.toArray(C.positions,R*3),re.normal.toArray(C.normals,R*3)),C.matricesIndices&&C.matricesWeights&&(re.matrixIndicesOverride?(C.matricesIndices[R*4]=re.matrixIndicesOverride[0],C.matricesIndices[R*4+1]=re.matrixIndicesOverride[1],C.matricesIndices[R*4+2]=re.matrixIndicesOverride[2],C.matricesIndices[R*4+3]=re.matrixIndicesOverride[3]):(d&&(C.matricesIndices[R*4]=d[re.vertexIdxForBones],C.matricesIndices[R*4+1]=d[re.vertexIdxForBones+1],C.matricesIndices[R*4+2]=d[re.vertexIdxForBones+2],C.matricesIndices[R*4+3]=d[re.vertexIdxForBones+3]),p&&C.matricesIndicesExtra&&(C.matricesIndicesExtra[R*4]=p[re.vertexIdxForBones],C.matricesIndicesExtra[R*4+1]=p[re.vertexIdxForBones+1],C.matricesIndicesExtra[R*4+2]=p[re.vertexIdxForBones+2],C.matricesIndicesExtra[R*4+3]=p[re.vertexIdxForBones+3])),re.matrixWeightsOverride?(C.matricesWeights[R*4]=re.matrixWeightsOverride[0],C.matricesWeights[R*4+1]=re.matrixWeightsOverride[1],C.matricesWeights[R*4+2]=re.matrixWeightsOverride[2],C.matricesWeights[R*4+3]=re.matrixWeightsOverride[3]):(f&&(C.matricesWeights[R*4]=f[re.vertexIdxForBones],C.matricesWeights[R*4+1]=f[re.vertexIdxForBones+1],C.matricesWeights[R*4+2]=f[re.vertexIdxForBones+2],C.matricesWeights[R*4+3]=f[re.vertexIdxForBones+3]),g&&C.matricesWeightsExtra&&(C.matricesWeightsExtra[R*4]=g[re.vertexIdxForBones],C.matricesWeightsExtra[R*4+1]=g[re.vertexIdxForBones+1],C.matricesWeightsExtra[R*4+2]=g[re.vertexIdxForBones+2],C.matricesWeightsExtra[R*4+3]=g[re.vertexIdxForBones+3]))),t.captureUVS)re.uv.toArray(C.uvs,R*2);else{C.uvs.push(.5+re.position.x/b.x);let Ie=.5+re.position.y/b.y;C.uvs.push(Me?1-Ie:Ie)}R++}}}C.indices.length===0&&(C.indices=null),C.positions.length===0&&(C.positions=null),C.normals.length===0&&(C.normals=null),C.uvs.length===0&&(C.uvs=null),C.matricesIndices?.length===0&&(C.matricesIndices=null),C.matricesWeights?.length===0&&(C.matricesWeights=null),C.matricesIndicesExtra?.length===0&&(C.matricesIndicesExtra=null),C.matricesWeightsExtra?.length===0&&(C.matricesWeightsExtra=null);let oe=new E(n,e.getScene());return C.applyToMesh(oe),s?(oe.skeleton=e.skeleton,oe.parent=e):(oe.position=_.clone(),oe.rotation=new m(x,I,A)),oe.computeWorldMatrix(!0),oe.refreshBoundingInfo(!0,!0),oe}E.CreateDecal=(n,e,t,i,r,s)=>nT(n,e,{position:t,normal:i,size:r,angle:s});function LD(n={subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){let e=Math.max(n.subdivisions?n.subdivisions:2,1)|0,t=Math.max(n.tessellation?n.tessellation:16,3)|0,i=Math.max(n.height?n.height:1,0),r=Math.max(n.radius?n.radius:.25,0),s=Math.max(n.capSubdivisions?n.capSubdivisions:6,1)|0,o=t,a=e,l=Math.max(n.radiusTop?n.radiusTop:r,0),c=Math.max(n.radiusBottom?n.radiusBottom:r,0),u=i-(l+c),h=0,d=2*Math.PI,f=Math.max(n.topCapSubdivisions?n.topCapSubdivisions:s,1),p=Math.max(n.bottomCapSubdivisions?n.bottomCapSubdivisions:s,1),g=Math.acos((c-l)/i),_=[],y=[],b=[],A=[],I=0,v=[],x=u*.5,C=Math.PI*.5,R,M,D=m.Zero(),W=m.Zero(),ee=Math.cos(g),ae=Math.sin(g),J=new me(l*ae,x+l*ee).subtract(new me(c*ae,-x+c*ee)).length(),he=l*g+J+c*(C-g),oe=0;for(M=0;M<=f;M++){let j=[],N=C-g*(M/f);oe+=l*g/f;let G=Math.cos(N),V=Math.sin(N),q=G*l;for(R=0;R<=o;R++){let xe=R/o,re=xe*d+h,Ie=Math.sin(re),Je=Math.cos(re);W.x=q*Ie,W.y=x+V*l,W.z=q*Je,y.push(W.x,W.y,W.z),D.set(G*Ie,V,G*Je),b.push(D.x,D.y,D.z),A.push(xe,Me?oe/he:1-oe/he),j.push(I),I++}v.push(j)}let pe=i-l-c+ee*l-ee*c,be=ae*(c-l)/pe;for(M=1;M<=a;M++){let j=[];oe+=J/a;let N=ae*(M*(c-l)/a+l);for(R=0;R<=o;R++){let G=R/o,V=G*d+h,q=Math.sin(V),xe=Math.cos(V);W.x=N*q,W.y=x+ee*l-M*pe/a,W.z=N*xe,y.push(W.x,W.y,W.z),D.set(q,be,xe).normalize(),b.push(D.x,D.y,D.z),A.push(G,Me?oe/he:1-oe/he),j.push(I),I++}v.push(j)}for(M=1;M<=p;M++){let j=[],N=C-g-(Math.PI-g)*(M/p);oe+=c*g/p;let G=Math.cos(N),V=Math.sin(N),q=G*c;for(R=0;R<=o;R++){let xe=R/o,re=xe*d+h,Ie=Math.sin(re),Je=Math.cos(re);W.x=q*Ie,W.y=-x+V*c,W.z=q*Je,y.push(W.x,W.y,W.z),D.set(G*Ie,V,G*Je),b.push(D.x,D.y,D.z),A.push(xe,Me?oe/he:1-oe/he),j.push(I),I++}v.push(j)}for(R=0;R<o;R++)for(M=0;M<f+a+p;M++){let j=v[M][R],N=v[M+1][R],G=v[M+1][R+1],V=v[M][R+1];_.push(j),_.push(N),_.push(V),_.push(N),_.push(G),_.push(V)}if(_=_.reverse(),n.orientation&&!n.orientation.equals(m.Up())){let j=new L;n.orientation.clone().scale(Math.PI*.5).cross(m.Up()).toQuaternion().toRotationMatrix(j);let N=m.Zero();for(let G=0;G<y.length;G+=3)N.set(y[G],y[G+1],y[G+2]),m.TransformCoordinatesToRef(N.clone(),j,N),y[G]=N.x,y[G+1]=N.y,y[G+2]=N.z}let $=new K;return $.positions=y,$.normals=b,$.uvs=A,$.indices=_,$}function rT(n,e={orientation:m.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6,updatable:!1},t=null){let i=new E(n,t);return LD(e).applyToMesh(i,e.updatable),i}E.CreateCapsule=(n,e,t)=>rT(n,e,t);K.CreateCapsule=LD;var xt=class n{constructor(e=0,t=0){this.x=e,this.y=t,e!==Math.floor(e)&&(e=Math.floor(e),P.Warn("x is not an integer, floor(x) used")),t!==Math.floor(t)&&(t=Math.floor(t),P.Warn("y is not an integer, floor(y) used"))}clone(){return new n(this.x,this.y)}rotate60About(e){let t=this.x;return this.x=e.x+e.y-this.y,this.y=t+this.y-e.x,this}rotateNeg60About(e){let t=this.x;return this.x=t+this.y-e.y,this.y=e.x+e.y-t,this}rotate120(e,t){e!==Math.floor(e)&&(e=Math.floor(e),P.Warn("m not an integer only floor(m) used")),t!==Math.floor(t)&&(t=Math.floor(t),P.Warn("n not an integer only floor(n) used"));let i=this.x;return this.x=e-i-this.y,this.y=t+i,this}rotateNeg120(e,t){e!==Math.floor(e)&&(e=Math.floor(e),P.Warn("m is not an integer, floor(m) used")),t!==Math.floor(t)&&(t=Math.floor(t),P.Warn("n is not an integer,   floor(n) used"));let i=this.x;return this.x=this.y-t,this.y=e+t-i-this.y,this}toCartesianOrigin(e,t){let i=m.Zero();return i.x=e.x+2*this.x*t+this.y*t,i.y=e.y+Math.sqrt(3)*this.y*t,i}static Zero(){return new n(0,0)}};var sc=class{constructor(){this.cartesian=[],this.vertices=[],this.max=[],this.min=[],this.closestTo=[],this.innerFacets=[],this.isoVecsABOB=[],this.isoVecsOBOA=[],this.isoVecsBAOA=[],this.vertexTypes=[],this.IDATA=new hh("icosahedron","Regular",[[0,Dt,-1],[-Dt,1,0],[-1,0,-Dt],[1,0,-Dt],[Dt,1,0],[0,Dt,1],[-1,0,Dt],[-Dt,-1,0],[0,-Dt,-1],[Dt,-1,0],[1,0,Dt],[0,-Dt,1]],[[0,2,1],[0,3,2],[0,4,3],[0,5,4],[0,1,5],[7,6,1],[8,7,2],[9,8,3],[10,9,4],[6,10,5],[2,7,1],[3,8,2],[4,9,3],[5,10,4],[1,6,5],[11,6,7],[11,7,8],[11,8,9],[11,9,10],[11,10,6]])}setIndices(){let e=12,t={},i=this.m,r=this.n,s=i,o=1,a=0;r!==0&&(s=qg(i,r)),o=i/s,a=r/s;let l,c,u,h,d,f=xt.Zero(),p=new xt(i,r),g=new xt(-r,i+r),_=xt.Zero(),y=xt.Zero(),b=xt.Zero(),A=[],I,v,x,C,R=[],M=this.vertByDist,D=(W,ee,ae,J)=>{I=W+"|"+ae,v=ee+"|"+J,I in t||v in t?I in t&&!(v in t)?t[v]=t[I]:v in t&&!(I in t)&&(t[I]=t[v]):(t[I]=e,t[v]=e,e++),M[ae][0]>2?R[t[I]]=[-M[ae][0],M[ae][1],t[I]]:R[t[I]]=[A[M[ae][0]],M[ae][1],t[I]]};this.IDATA.edgematch=[[1,"B"],[2,"B"],[3,"B"],[4,"B"],[0,"B"],[10,"O",14,"A"],[11,"O",10,"A"],[12,"O",11,"A"],[13,"O",12,"A"],[14,"O",13,"A"],[0,"O"],[1,"O"],[2,"O"],[3,"O"],[4,"O"],[19,"B",5,"A"],[15,"B",6,"A"],[16,"B",7,"A"],[17,"B",8,"A"],[18,"B",9,"A"]];for(let W=0;W<20;W++){if(A=this.IDATA.face[W],u=A[2],h=A[1],d=A[0],x=f.x+"|"+f.y,I=W+"|"+x,I in t||(t[I]=u,R[u]=[A[M[x][0]],M[x][1]]),x=p.x+"|"+p.y,I=W+"|"+x,I in t||(t[I]=h,R[h]=[A[M[x][0]],M[x][1]]),x=g.x+"|"+g.y,I=W+"|"+x,I in t||(t[I]=d,R[d]=[A[M[x][0]],M[x][1]]),l=this.IDATA.edgematch[W][0],c=this.IDATA.edgematch[W][1],c==="B")for(let ee=1;ee<s;ee++)y.x=i-ee*(o+a),y.y=r+ee*o,b.x=-ee*a,b.y=ee*(o+a),x=y.x+"|"+y.y,C=b.x+"|"+b.y,D(W,l,x,C);if(c==="O")for(let ee=1;ee<s;ee++)b.x=-ee*a,b.y=ee*(o+a),_.x=ee*o,_.y=ee*a,x=b.x+"|"+b.y,C=_.x+"|"+_.y,D(W,l,x,C);if(l=this.IDATA.edgematch[W][2],c=this.IDATA.edgematch[W][3],c&&c==="A")for(let ee=1;ee<s;ee++)_.x=ee*o,_.y=ee*a,y.x=i-(s-ee)*(o+a),y.y=r+(s-ee)*o,x=_.x+"|"+_.y,C=y.x+"|"+y.y,D(W,l,x,C);for(let ee=0;ee<this.vertices.length;ee++)x=this.vertices[ee].x+"|"+this.vertices[ee].y,I=W+"|"+x,I in t||(t[I]=e++,M[x][0]>2?R[t[I]]=[-M[x][0],M[x][1],t[I]]:R[t[I]]=[A[M[x][0]],M[x][1],t[I]])}this.closestTo=R,this.vecToidx=t}calcCoeffs(){let e=this.m,t=this.n,i=Math.sqrt(3)/3,r=e*e+t*t+e*t;this.coau=(e+t)/r,this.cobu=-t/r,this.coav=-i*(e-t)/r,this.cobv=i*(2*e+t)/r}createInnerFacets(){let e=this.m,t=this.n;for(let i=0;i<t+e+1;i++)for(let r=this.min[i];r<this.max[i]+1;r++)r<this.max[i]&&r<this.max[i+1]+1&&this.innerFacets.push(["|"+r+"|"+i,"|"+r+"|"+(i+1),"|"+(r+1)+"|"+i]),i>0&&r<this.max[i-1]&&r+1<this.max[i]+1&&this.innerFacets.push(["|"+r+"|"+i,"|"+(r+1)+"|"+i,"|"+(r+1)+"|"+(i-1)])}edgeVecsABOB(){let e=this.m,t=this.n,i=new xt(-t,e+t);for(let r=1;r<e+t;r++){let s=new xt(this.min[r],r),o=new xt(this.min[r-1],r-1),a=new xt(this.min[r+1],r+1),l=s.clone(),c=o.clone(),u=a.clone();l.rotate60About(i),c.rotate60About(i),u.rotate60About(i);let h=new xt(this.max[l.y],l.y),d=new xt(this.max[l.y-1],l.y-1),f=new xt(this.max[l.y-1]-1,l.y-1);(l.x!==h.x||l.y!==h.y)&&(l.x!==d.x?(this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,d,f]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,f,h])):l.y===u.y?(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([s,o,d]),this.vertexTypes.push([1,0,1]),this.isoVecsABOB.push([s,d,a])):(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([s,o,d]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([s,d,h])))}}mapABOBtoOBOA(){let e=new xt(0,0);for(let t=0;t<this.isoVecsABOB.length;t++){let i=[];for(let r=0;r<3;r++)e.x=this.isoVecsABOB[t][r].x,e.y=this.isoVecsABOB[t][r].y,this.vertexTypes[t][r]===0&&e.rotateNeg120(this.m,this.n),i.push(e.clone());this.isoVecsOBOA.push(i)}}mapABOBtoBAOA(){let e=new xt(0,0);for(let t=0;t<this.isoVecsABOB.length;t++){let i=[];for(let r=0;r<3;r++)e.x=this.isoVecsABOB[t][r].x,e.y=this.isoVecsABOB[t][r].y,this.vertexTypes[t][r]===1&&e.rotate120(this.m,this.n),i.push(e.clone());this.isoVecsBAOA.push(i)}}MapToFace(e,t){let i=this.IDATA.face[e],r=i[2],s=i[1],o=i[0],a=m.FromArray(this.IDATA.vertex[r]),l=m.FromArray(this.IDATA.vertex[s]),c=m.FromArray(this.IDATA.vertex[o]),u=l.subtract(a),h=c.subtract(a),d=u.scale(this.coau).add(h.scale(this.cobu)),f=u.scale(this.coav).add(h.scale(this.cobv)),p=[],g,_=k.Vector3[0];for(let y=0;y<this.cartesian.length;y++)_=d.scale(this.cartesian[y].x).add(f.scale(this.cartesian[y].y)).add(a),p[y]=[_.x,_.y,_.z],g=e+"|"+this.vertices[y].x+"|"+this.vertices[y].y,t.vertex[this.vecToidx[g]]=[_.x,_.y,_.z]}build(e,t){let i=[],r=xt.Zero(),s=new xt(e,t),o=new xt(-t,e+t);i.push(r,s,o);for(let v=t;v<e+1;v++)for(let x=0;x<e+1-v;x++)i.push(new xt(x,v));if(t>0){let v=qg(e,t),x=e/v,C=t/v;for(let M=1;M<v;M++)i.push(new xt(M*x,M*C)),i.push(new xt(-M*C,M*(x+C))),i.push(new xt(e-M*(x+C),t+M*x));let R=e/t;for(let M=1;M<t;M++)for(let D=0;D<M*R;D++)i.push(new xt(D,M)),i.push(new xt(D,M).rotate120(e,t)),i.push(new xt(D,M).rotateNeg120(e,t))}i.sort((v,x)=>v.x-x.x),i.sort((v,x)=>v.y-x.y);let a=new Array(e+t+1),l=new Array(e+t+1);for(let v=0;v<a.length;v++)a[v]=1/0,l[v]=-1/0;let c=0,u=0,h=i.length;for(let v=0;v<h;v++)u=i[v].x,c=i[v].y,a[c]=Math.min(u,a[c]),l[c]=Math.max(u,l[c]);let d=(v,x)=>{let C=v.clone();return x==="A"&&C.rotateNeg120(e,t),x==="B"&&C.rotate120(e,t),C.x<0?C.y:C.x+C.y},f=[],p=[],g=[],_=[],y={},b=[],A=-1,I=-1;for(let v=0;v<h;v++)f[v]=i[v].toCartesianOrigin(new xt(0,0),.5),p[v]=d(i[v],"O"),g[v]=d(i[v],"A"),_[v]=d(i[v],"B"),p[v]===g[v]&&g[v]===_[v]?(A=3,I=p[v]):p[v]===g[v]?(A=4,I=p[v]):g[v]===_[v]?(A=5,I=g[v]):_[v]===p[v]&&(A=6,I=p[v]),p[v]<g[v]&&p[v]<_[v]&&(A=2,I=p[v]),g[v]<p[v]&&g[v]<_[v]&&(A=1,I=g[v]),_[v]<g[v]&&_[v]<p[v]&&(A=0,I=_[v]),b.push([A,I,i[v].x,i[v].y]);b.sort((v,x)=>v[2]-x[2]),b.sort((v,x)=>v[3]-x[3]),b.sort((v,x)=>v[1]-x[1]),b.sort((v,x)=>v[0]-x[0]);for(let v=0;v<b.length;v++)y[b[v][2]+"|"+b[v][3]]=[b[v][0],b[v][1],v];return this.m=e,this.n=t,this.vertices=i,this.vertByDist=y,this.cartesian=f,this.min=a,this.max=l,this}},hh=class{constructor(e,t,i,r){this.name=e,this.category=t,this.vertex=i,this.face=r}},oc=class n extends hh{innerToData(e,t){for(let i=0;i<t.innerFacets.length;i++)this.face.push(t.innerFacets[i].map(r=>t.vecToidx[e+r]))}mapABOBtoDATA(e,t){let i=t.IDATA.edgematch[e][0];for(let r=0;r<t.isoVecsABOB.length;r++){let s=[];for(let o=0;o<3;o++)t.vertexTypes[r][o]===0?s.push(e+"|"+t.isoVecsABOB[r][o].x+"|"+t.isoVecsABOB[r][o].y):s.push(i+"|"+t.isoVecsABOB[r][o].x+"|"+t.isoVecsABOB[r][o].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}mapOBOAtoDATA(e,t){let i=t.IDATA.edgematch[e][0];for(let r=0;r<t.isoVecsOBOA.length;r++){let s=[];for(let o=0;o<3;o++)t.vertexTypes[r][o]===1?s.push(e+"|"+t.isoVecsOBOA[r][o].x+"|"+t.isoVecsOBOA[r][o].y):s.push(i+"|"+t.isoVecsOBOA[r][o].x+"|"+t.isoVecsOBOA[r][o].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}mapBAOAtoDATA(e,t){let i=t.IDATA.edgematch[e][2];for(let r=0;r<t.isoVecsBAOA.length;r++){let s=[];for(let o=0;o<3;o++)t.vertexTypes[r][o]===1?s.push(e+"|"+t.isoVecsBAOA[r][o].x+"|"+t.isoVecsBAOA[r][o].y):s.push(i+"|"+t.isoVecsBAOA[r][o].x+"|"+t.isoVecsBAOA[r][o].y);this.face.push([t.vecToidx[s[0]],t.vecToidx[s[1]],t.vecToidx[s[2]]])}}orderData(e){let t=[];for(let o=0;o<13;o++)t[o]=[];let i=e.closestTo;for(let o=0;o<i.length;o++)i[o][0]>-1?i[o][1]>0&&t[i[o][0]].push([o,i[o][1]]):t[12].push([o,i[o][0]]);let r=[];for(let o=0;o<12;o++)r[o]=o;let s=12;for(let o=0;o<12;o++){t[o].sort((a,l)=>a[1]-l[1]);for(let a=0;a<t[o].length;a++)r[t[o][a][0]]=s++}for(let o=0;o<t[12].length;o++)r[t[12][o][0]]=s++;for(let o=0;o<this.vertex.length;o++)this.vertex[o].push(r[o]);this.vertex.sort((o,a)=>o[3]-a[3]);for(let o=0;o<this.vertex.length;o++)this.vertex[o].pop();for(let o=0;o<this.face.length;o++)for(let a=0;a<this.face[o].length;a++)this.face[o][a]=r[this.face[o][a]];this.sharedNodes=t[12].length,this.poleNodes=this.vertex.length-this.sharedNodes}setOrder(e,t){let i=[],r=[],s=t.pop();r.push(s);let o=this.face[s].indexOf(e);o=(o+2)%3;let a=this.face[s][o];i.push(a);let l=0;for(;t.length>0;)s=t[l],this.face[s].indexOf(a)>-1?(o=(this.face[s].indexOf(a)+1)%3,a=this.face[s][o],i.push(a),r.push(s),t.splice(l,1),l=0):l++;return this.adjacentFaces.push(i),r}toGoldbergPolyhedronData(){let e=new hh("GeoDual","Goldberg",[],[]);e.name="GD dual";let t=this.vertex.length,i=new Array(t);for(let c=0;c<t;c++)i[c]=[];for(let c=0;c<this.face.length;c++)for(let u=0;u<3;u++)i[this.face[c][u]].push(c);let r=0,s=0,o=0,a=[],l=[];this.adjacentFaces=[];for(let c=0;c<i.length;c++){e.face[c]=this.setOrder(c,i[c].concat([]));for(let u of i[c]){r=0,s=0,o=0,a=this.face[u];for(let h=0;h<3;h++)l=this.vertex[a[h]],r+=l[0],s+=l[1],o+=l[2];e.vertex[u]=[r/3,s/3,o/3]}}return e}static BuildGeodesicData(e){let t=new n("Geodesic-m-n","Geodesic",[[0,Dt,-1],[-Dt,1,0],[-1,0,-Dt],[1,0,-Dt],[Dt,1,0],[0,Dt,1],[-1,0,Dt],[-Dt,-1,0],[0,-Dt,-1],[Dt,-1,0],[1,0,Dt],[0,-Dt,1]],[]);e.setIndices(),e.calcCoeffs(),e.createInnerFacets(),e.edgeVecsABOB(),e.mapABOBtoOBOA(),e.mapABOBtoBAOA();for(let r=0;r<e.IDATA.face.length;r++)e.MapToFace(r,t),t.innerToData(r,e),e.IDATA.edgematch[r][1]==="B"&&t.mapABOBtoDATA(r,e),e.IDATA.edgematch[r][1]==="O"&&t.mapOBOAtoDATA(r,e),e.IDATA.edgematch[r][3]==="A"&&t.mapBAOAtoDATA(r,e);t.orderData(e);let i=1;return t.vertex=t.vertex.map(function(r){let s=r[0],o=r[1],a=r[2],l=Math.sqrt(s*s+o*o+a*a);return r[0]*=i/l,r[1]*=i/l,r[2]*=i/l,r}),t}};function BD(n,e,t=null){let i=e.m||1;i!==Math.floor(i)&&(i=Math.floor(i),P.Warn("m not an integer only floor(m) used"));let r=e.n||0;if(r!==Math.floor(r)&&(r=Math.floor(r),P.Warn("n not an integer only floor(n) used")),r>i){let c=r;r=i,i=c,P.Warn("n > m therefore m and n swapped")}let s=new sc;s.build(i,r);let a={custom:oc.BuildGeodesicData(s),size:e.size,sizeX:e.sizeX,sizeY:e.sizeY,sizeZ:e.sizeZ,faceUV:e.faceUV,faceColors:e.faceColors,flat:e.flat,updatable:e.updatable,sideOrientation:e.sideOrientation,frontUVs:e.frontUVs,backUVs:e.backUVs};return uh(n,a,t)}E._GoldbergMeshParser=(n,e)=>dh.Parse(n,e);var dh=class n extends E{constructor(){super(...arguments),this.goldbergData={faceColors:[],faceCenters:[],faceZaxis:[],faceXaxis:[],faceYaxis:[],nbSharedFaces:0,nbUnsharedFaces:0,nbFaces:0,nbFacesAtPole:0,adjacentFaces:[]}}relatedGoldbergFace(e,t){return t===void 0?(e>this.goldbergData.nbUnsharedFaces-1&&(P.Warn("Maximum number of unshared faces used"),e=this.goldbergData.nbUnsharedFaces-1),this.goldbergData.nbUnsharedFaces+e):(e>11&&(P.Warn("Last pole used"),e=11),t>this.goldbergData.nbFacesAtPole-1&&(P.Warn("Maximum number of faces at a pole used"),t=this.goldbergData.nbFacesAtPole-1),12+e*this.goldbergData.nbFacesAtPole+t)}_changeGoldbergFaceColors(e){for(let i=0;i<e.length;i++){let r=e[i][0],s=e[i][1],o=e[i][2];for(let a=r;a<s+1;a++)this.goldbergData.faceColors[a]=o}let t=[];for(let i=0;i<12;i++)for(let r=0;r<5;r++)t.push(this.goldbergData.faceColors[i].r,this.goldbergData.faceColors[i].g,this.goldbergData.faceColors[i].b,this.goldbergData.faceColors[i].a);for(let i=12;i<this.goldbergData.faceColors.length;i++)for(let r=0;r<6;r++)t.push(this.goldbergData.faceColors[i].r,this.goldbergData.faceColors[i].g,this.goldbergData.faceColors[i].b,this.goldbergData.faceColors[i].a);return t}setGoldbergFaceColors(e){let t=this._changeGoldbergFaceColors(e);this.setVerticesData(T.ColorKind,t)}updateGoldbergFaceColors(e){let t=this._changeGoldbergFaceColors(e);this.updateVerticesData(T.ColorKind,t)}_changeGoldbergFaceUVs(e){let t=this.getVerticesData(T.UVKind);for(let i=0;i<e.length;i++){let r=e[i][0],s=e[i][1],o=e[i][2],a=e[i][3],l=e[i][4],c=[],u=[],h,d;for(let f=0;f<5;f++)h=o.x+a*Math.cos(l+f*Math.PI/2.5),d=o.y+a*Math.sin(l+f*Math.PI/2.5),h<0&&(h=0),h>1&&(h=1),c.push(h,d);for(let f=0;f<6;f++)h=o.x+a*Math.cos(l+f*Math.PI/3),d=o.y+a*Math.sin(l+f*Math.PI/3),h<0&&(h=0),h>1&&(h=1),u.push(h,d);for(let f=r;f<Math.min(12,s+1);f++)for(let p=0;p<5;p++)t[10*f+2*p]=c[2*p],t[10*f+2*p+1]=c[2*p+1];for(let f=Math.max(12,r);f<s+1;f++)for(let p=0;p<6;p++)t[12*f-24+2*p]=u[2*p],t[12*f-23+2*p]=u[2*p+1]}return t}setGoldbergFaceUVs(e){let t=this._changeGoldbergFaceUVs(e);this.setVerticesData(T.UVKind,t)}updateGoldbergFaceUVs(e){let t=this._changeGoldbergFaceUVs(e);this.updateVerticesData(T.UVKind,t)}placeOnGoldbergFaceAt(e,t,i){let r=m.RotationFromAxis(this.goldbergData.faceXaxis[t],this.goldbergData.faceYaxis[t],this.goldbergData.faceZaxis[t]);e.rotation=r,e.position=this.goldbergData.faceCenters[t].add(this.goldbergData.faceXaxis[t].scale(i.x)).add(this.goldbergData.faceYaxis[t].scale(i.y)).add(this.goldbergData.faceZaxis[t].scale(i.z))}serialize(e){super.serialize(e),e.type="GoldbergMesh";let t={};if(t.adjacentFaces=this.goldbergData.adjacentFaces,t.nbSharedFaces=this.goldbergData.nbSharedFaces,t.nbUnsharedFaces=this.goldbergData.nbUnsharedFaces,t.nbFaces=this.goldbergData.nbFaces,t.nbFacesAtPole=this.goldbergData.nbFacesAtPole,this.goldbergData.faceColors){t.faceColors=[];for(let i of this.goldbergData.faceColors)t.faceColors.push(i.asArray())}if(this.goldbergData.faceCenters){t.faceCenters=[];for(let i of this.goldbergData.faceCenters)t.faceCenters.push(i.asArray())}if(this.goldbergData.faceZaxis){t.faceZaxis=[];for(let i of this.goldbergData.faceZaxis)t.faceZaxis.push(i.asArray())}if(this.goldbergData.faceYaxis){t.faceYaxis=[];for(let i of this.goldbergData.faceYaxis)t.faceYaxis.push(i.asArray())}if(this.goldbergData.faceXaxis){t.faceXaxis=[];for(let i of this.goldbergData.faceXaxis)t.faceXaxis.push(i.asArray())}e.goldbergData=t}static Parse(e,t){let i=e.goldbergData;i.faceColors=i.faceColors.map(s=>ce.FromArray(s)),i.faceCenters=i.faceCenters.map(s=>m.FromArray(s)),i.faceZaxis=i.faceZaxis.map(s=>m.FromArray(s)),i.faceXaxis=i.faceXaxis.map(s=>m.FromArray(s)),i.faceYaxis=i.faceYaxis.map(s=>m.FromArray(s));let r=new n(e.name,t);return r.goldbergData=i,r}};function kk(n,e){let t=n.size,i=n.sizeX||t||1,r=n.sizeY||t||1,s=n.sizeZ||t||1,o=n.sideOrientation===0?0:n.sideOrientation||K.DEFAULTSIDE,a=[],l=[],c=[],u=[],h=1/0,d=-1/0,f=1/0,p=-1/0;for(let y=0;y<e.vertex.length;y++)h=Math.min(h,e.vertex[y][0]*i),d=Math.max(d,e.vertex[y][0]*i),f=Math.min(f,e.vertex[y][1]*r),p=Math.max(p,e.vertex[y][1]*r);let g=0;for(let y=0;y<e.face.length;y++){let b=e.face[y],A=m.FromArray(e.vertex[b[0]]),I=m.FromArray(e.vertex[b[2]]),v=m.FromArray(e.vertex[b[1]]),x=I.subtract(A),C=v.subtract(A),R=m.Cross(C,x).normalize();for(let M=0;M<b.length;M++){c.push(R.x,R.y,R.z);let D=e.vertex[b[M]];a.push(D[0]*i,D[1]*r,D[2]*s);let W=(D[1]*r-f)/(p-f);u.push((D[0]*i-h)/(d-h),Me?1-W:W)}for(let M=0;M<b.length-2;M++)l.push(g,g+M+2,g+M+1);g+=b.length}K._ComputeSides(o,a,l,c,u);let _=new K;return _.positions=a,_.indices=l,_.normals=c,_.uvs=u,_}function kD(n,e,t=null){let i=e.size,r=e.sizeX||i||1,s=e.sizeY||i||1,o=e.sizeZ||i||1,a=e.m||1;a!==Math.floor(a)&&(a=Math.floor(a),P.Warn("m not an integer only floor(m) used"));let l=e.n||0;if(l!==Math.floor(l)&&(l=Math.floor(l),P.Warn("n not an integer only floor(n) used")),l>a){let p=l;l=a,a=p,P.Warn("n > m therefore m and n swapped")}let c=new sc;c.build(a,l);let u=oc.BuildGeodesicData(c),h=u.toGoldbergPolyhedronData(),d=new dh(n,t);e.sideOrientation=E._GetDefaultSideOrientation(e.sideOrientation),d._originalBuilderSideOrientation=e.sideOrientation,kk(e,h).applyToMesh(d,e.updatable),d.goldbergData.nbSharedFaces=u.sharedNodes,d.goldbergData.nbUnsharedFaces=u.poleNodes,d.goldbergData.adjacentFaces=u.adjacentFaces,d.goldbergData.nbFaces=d.goldbergData.nbSharedFaces+d.goldbergData.nbUnsharedFaces,d.goldbergData.nbFacesAtPole=(d.goldbergData.nbUnsharedFaces-12)/12;for(let p=0;p<u.vertex.length;p++)d.goldbergData.faceCenters.push(m.FromArray(u.vertex[p])),d.goldbergData.faceCenters[p].x*=r,d.goldbergData.faceCenters[p].y*=s,d.goldbergData.faceCenters[p].z*=o,d.goldbergData.faceColors.push(new ce(1,1,1,1));for(let p=0;p<h.face.length;p++){let g=h.face[p],_=m.FromArray(h.vertex[g[0]]),y=m.FromArray(h.vertex[g[2]]),b=m.FromArray(h.vertex[g[1]]),A=y.subtract(_),I=b.subtract(_),v=m.Cross(I,A).normalize(),x=m.Cross(I,v).normalize();d.goldbergData.faceXaxis.push(I.normalize()),d.goldbergData.faceYaxis.push(v),d.goldbergData.faceZaxis.push(x)}return d}var sT=class{constructor(e){this._paths=[],this._tempPaths=[],this._holes=[],this._resolution=e}moveTo(e,t){this._currentPath=new Ph(e,t),this._tempPaths.push(this._currentPath)}lineTo(e,t){this._currentPath.addLineTo(e,t)}quadraticCurveTo(e,t,i,r){this._currentPath.addQuadraticCurveTo(e,t,i,r,this._resolution)}bezierCurveTo(e,t,i,r,s,o){this._currentPath.addBezierCurveTo(e,t,i,r,s,o,this._resolution)}extractHoles(){for(let e of this._tempPaths)e.area()>0?this._holes.push(e):this._paths.push(e);if(!this._paths.length&&this._holes.length){let e=this._holes;this._holes=this._paths,this._paths=e}this._tempPaths.length=0}get paths(){return this._paths}get holes(){return this._holes}};function Vk(n,e,t,i,r,s){let o=s.glyphs[n]||s.glyphs["?"];if(!o)return null;let a=new sT(r);if(o.o){let l=o.o.split(" ");for(let c=0,u=l.length;c<u;)switch(l[c++]){case"m":{let d=parseInt(l[c++])*e+t,f=parseInt(l[c++])*e+i;a.moveTo(d,f);break}case"l":{let d=parseInt(l[c++])*e+t,f=parseInt(l[c++])*e+i;a.lineTo(d,f);break}case"q":{let d=parseInt(l[c++])*e+t,f=parseInt(l[c++])*e+i,p=parseInt(l[c++])*e+t,g=parseInt(l[c++])*e+i;a.quadraticCurveTo(p,g,d,f);break}case"b":{let d=parseInt(l[c++])*e+t,f=parseInt(l[c++])*e+i,p=parseInt(l[c++])*e+t,g=parseInt(l[c++])*e+i,_=parseInt(l[c++])*e+t,y=parseInt(l[c++])*e+i;a.bezierCurveTo(p,g,_,y,d,f);break}}}return a.extractHoles(),{offsetX:o.ha*e,shapePath:a}}function Gk(n,e,t,i){let r=Array.from(n),s=e/i.resolution,o=(i.boundingBox.yMax-i.boundingBox.yMin+i.underlineThickness)*s,a=[],l=0,c=0;for(let u=0;u<r.length;u++){let h=r[u];if(h===`
`)l=0,c-=o;else{let d=Vk(h,s,l,c,t,i);d&&(l+=d.offsetX,a.push(d.shapePath))}}return a}function VD(n,e,t,i={size:50,resolution:8,depth:1},r=null,s=earcut){let o=Gk(e,i.size||50,i.resolution||8,t),a=[],l=0;for(let u of o){if(!u.paths.length)continue;let h=u.holes.slice();for(let d of u.paths){let f=[],p=[],g=d.getPoints();for(let b of g)p.push(new m(b.x,0,b.y));let _=h.slice();for(let b of _){let A=b.getPoints(),I=!1;for(let x of A)if(d.isPointInside(x)){I=!0;break}if(!I)continue;let v=[];for(let x of A)v.push(new m(x.x,0,x.y));f.push(v),h.splice(h.indexOf(b),1)}if(!f.length&&h.length)for(let b of h){let A=b.getPoints(),I=[];for(let v of A)I.push(new m(v.x,0,v.y));f.push(I)}let y=lh(n,{shape:p,holes:f.length?f:void 0,depth:i.depth||1,faceUV:i.faceUV||i.perLetterFaceUV?.(l),faceColors:i.faceColors||i.perLetterFaceColors?.(l),sideOrientation:E._GetDefaultSideOrientation(i.sideOrientation||E.DOUBLESIDE)},r,s);a.push(y),l++}}let c=E.MergeMeshes(a,!0,!0);if(c){let u=c.getBoundingInfo().boundingBox;c.position.x+=-(u.minimumWorld.x+u.maximumWorld.x)/2,c.position.y+=-(u.minimumWorld.y+u.maximumWorld.y)/2,c.position.z+=-(u.minimumWorld.z+u.maximumWorld.z)/2+u.extendSize.z,c.name=n;let h=new vi("pivot",r);h.rotation.x=-Math.PI/2,c.parent=h,c.bakeCurrentTransformIntoVertices(),c.parent=null,h.dispose()}return c}var $i={CreateBox:oa,CreateTiledBox:ED,CreateSphere:eo,CreateDisc:YC,CreateIcoSphere:rc,CreateRibbon:fr,CreateCylinder:aa,CreateTorus:pr,CreateTorusKnot:JC,CreateLineSystem:zC,CreateLines:na,CreateDashedLines:HC,ExtrudeShape:sh,ExtrudeShapeCustom:GC,CreateLathe:tT,CreateTiledPlane:ID,CreatePlane:ch,CreateGround:sa,CreateTiledGround:XC,CreateGroundFromHeightMap:ZC,CreatePolygon:mg,ExtrudePolygon:lh,CreateTube:iT,CreatePolyhedron:uh,CreateGeodesic:BD,CreateGoldberg:kD,CreateDecal:nT,CreateCapsule:rT,CreateText:VD};function GD(n){let e=document.querySelectorAll(`link[href="${n}"]`);if(e.length>1)for(let t=1;t<e.length;t++)e[t].remove()}function UD(){let n=navigator.userAgent,e;"userAgentData"in navigator&&navigator.userAgentData?e=navigator.userAgentData.platform:e=navigator.platform;let t=e==="MacIntel"&&navigator.maxTouchPoints>1;return/android/i.test(n)||/iphone|ipod/i.test(n)||/ipad/i.test(n)?!0:t}var _g=class{constructor(){this._zoomStopsAnimation=!1,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this.targetAlpha=null,this._isPointerDown=!1,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0}get name(){return"AutoRotation"}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set idleRotationSpeed(e){this._idleRotationSpeed=e}get idleRotationSpeed(){return this._idleRotationSpeed}set idleRotationWaitTime(e){this._idleRotationWaitTime=e}get idleRotationWaitTime(){return this._idleRotationWaitTime}set idleRotationSpinupTime(e){this._idleRotationSpinupTime=e}get idleRotationSpinupTime(){return this._idleRotationSpinupTime}get rotationInProgress(){return Math.abs(this._cameraRotationSpeed)>0}init(){}attach(e){this._attachedCamera=e;let t=this._attachedCamera.getScene();this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{if(i.type===Ee.POINTERDOWN){this._isPointerDown=!0;return}i.type===Ee.POINTERUP&&(this._isPointerDown=!1)}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{if(this._reachTargetAlpha())return;let i=Xn.Now,r=0;this._lastFrameTime!=null&&(r=i-this._lastFrameTime),this._lastFrameTime=i,this._applyUserInteraction();let s=i-this._lastInteractionTime-this._idleRotationWaitTime,o=Math.max(Math.min(s/this._idleRotationSpinupTime,1),0);this._cameraRotationSpeed=this._idleRotationSpeed*o,this._attachedCamera&&(this._attachedCamera.alpha-=this._cameraRotationSpeed*(r/1e3))})}detach(){if(!this._attachedCamera)return;let e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null,this._lastFrameTime=null}resetLastInteractionTime(e){this._lastInteractionTime=e??Xn.Now}_reachTargetAlpha(){return this._attachedCamera&&this.targetAlpha?Math.abs(this._attachedCamera.alpha-this.targetAlpha)<tt:!1}_userIsZooming(){return this._attachedCamera?this._attachedCamera.inertialRadiusOffset!==0:!1}_shouldAnimationStopForInteraction(){if(!this._attachedCamera)return!1;let e=!1;return this._lastFrameRadius===this._attachedCamera.radius&&this._attachedCamera.inertialRadiusOffset!==0&&(e=!0),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?e:this._userIsZooming()}_applyUserInteraction(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=Xn.Now)}_userIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}};var ac=class n{constructor(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=!1,this._radiusIsAnimating=!1,this._radiusBounceTransition=null,this._animatables=new Array}get name(){return"Bouncing"}get autoTransitionRange(){return this._autoTransitionRange}set autoTransitionRange(e){if(this._autoTransitionRange===e)return;this._autoTransitionRange=e;let t=this._attachedCamera;t&&(e?this._onMeshTargetChangedObserver=t.onMeshTargetChangedObservable.add(i=>{if(i&&(i.computeWorldMatrix(!0),i.getBoundingInfo)){let r=i.getBoundingInfo().diagonalLength;this.lowerRadiusTransitionRange=r*.05,this.upperRadiusTransitionRange=r*.05}}):this._onMeshTargetChangedObserver&&t.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver))}init(){}attach(e){this._attachedCamera=e,this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._attachedCamera&&(this._isRadiusAtLimit(this._attachedCamera.lowerRadiusLimit)&&this._applyBoundRadiusAnimation(this.lowerRadiusTransitionRange),this._isRadiusAtLimit(this._attachedCamera.upperRadiusLimit)&&this._applyBoundRadiusAnimation(this.upperRadiusTransitionRange))})}detach(){this._attachedCamera&&(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null)}_isRadiusAtLimit(e){return this._attachedCamera?this._attachedCamera.radius===e&&!this._radiusIsAnimating:!1}_applyBoundRadiusAnimation(e){if(!this._attachedCamera)return;this._radiusBounceTransition||(n.EasingFunction.setEasingMode(n.EasingMode),this._radiusBounceTransition=H.CreateAnimation("radius",H.ANIMATIONTYPE_FLOAT,60,n.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=!0;let t=H.TransitionTo("radius",this._attachedCamera.radius+e,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,()=>this._clearAnimationLocks());t&&this._animatables.push(t)}_clearAnimationLocks(){this._radiusIsAnimating=!1,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision)}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift()}};ac.EasingFunction=new A0(.3);ac.EasingMode=Qi.EASINGMODE_EASEOUT;var to=class n{constructor(){this.onTargetFramingAnimationEndObservable=new F,this._mode=n.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=!1,this._framingTime=1500,this.autoCorrectCameraLimitsAndSensibility=!0,this._isPointerDown=!1,this._lastInteractionTime=-1/0,this._animatables=new Array,this._betaIsAnimating=!1}get name(){return"Framing"}set mode(e){this._mode=e}get mode(){return this._mode}set radiusScale(e){this._radiusScale=e}get radiusScale(){return this._radiusScale}set positionScale(e){this._positionScale=e}get positionScale(){return this._positionScale}set defaultElevation(e){this._defaultElevation=e}get defaultElevation(){return this._defaultElevation}set elevationReturnTime(e){this._elevationReturnTime=e}get elevationReturnTime(){return this._elevationReturnTime}set elevationReturnWaitTime(e){this._elevationReturnWaitTime=e}get elevationReturnWaitTime(){return this._elevationReturnWaitTime}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set framingTime(e){this._framingTime=e}get framingTime(){return this._framingTime}init(){}attach(e){this._attachedCamera=e;let t=this._attachedCamera.getScene();n.EasingFunction.setEasingMode(n.EasingMode),this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{if(i.type===Ee.POINTERDOWN){this._isPointerDown=!0;return}i.type===Ee.POINTERUP&&(this._isPointerDown=!1)}),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add(i=>{i&&i.getBoundingInfo&&this.zoomOnMesh(i,void 0,()=>{this.onTargetFramingAnimationEndObservable.notifyObservers()})}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._applyUserInteraction(),this._maintainCameraAboveGround()})}detach(){if(!this._attachedCamera)return;let e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null}zoomOnMesh(e,t=!1,i=null){e.computeWorldMatrix(!0);let r=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(r.minimumWorld,r.maximumWorld,t,i)}zoomOnMeshHierarchy(e,t=!1,i=null){e.computeWorldMatrix(!0);let r=e.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(r.min,r.max,t,i)}zoomOnMeshesHierarchy(e,t=!1,i=null){let r=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new m(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let o=0;o<e.length;o++){let a=e[o].getHierarchyBoundingVectors(!0);m.CheckExtends(a.min,r,s),m.CheckExtends(a.max,r,s)}this.zoomOnBoundingInfo(r,s,t,i)}zoomOnBoundingInfo(e,t,i=!1,r=null){let s;if(!this._attachedCamera)return!1;let o=e.y,a=t.y,l=o+(a-o)*this._positionScale,c=t.subtract(e).scale(.5);if(!isFinite(l))return!1;if(i)s=new m(0,l,0);else{let d=e.add(c);s=new m(d.x,l,d.z)}this._vectorTransition||(this._vectorTransition=H.CreateAnimation("target",H.ANIMATIONTYPE_VECTOR3,60,n.EasingFunction)),this._betaIsAnimating=!0;let u=H.TransitionTo("target",s,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);u&&this._animatables.push(u);let h=0;if(this._mode===n.FitFrustumSidesMode){let d=this._calculateLowerRadiusFromModelBoundingSphere(e,t);this.autoCorrectCameraLimitsAndSensibility&&(this._attachedCamera.lowerRadiusLimit=c.length()+this._attachedCamera.minZ),h=d}else this._mode===n.IgnoreBoundsSizeMode&&(h=this._calculateLowerRadiusFromModelBoundingSphere(e,t),this.autoCorrectCameraLimitsAndSensibility&&this._attachedCamera.lowerRadiusLimit===null&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));if(this.autoCorrectCameraLimitsAndSensibility){let d=t.subtract(e).length();this._attachedCamera.panningSensibility=5e3/d,this._attachedCamera.wheelPrecision=100/h}return this._radiusTransition||(this._radiusTransition=H.CreateAnimation("radius",H.ANIMATIONTYPE_FLOAT,60,n.EasingFunction)),u=H.TransitionTo("radius",h,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,()=>{this.stopAllAnimations(),r&&r(),this._attachedCamera&&this._attachedCamera.useInputToRestoreState&&this._attachedCamera.storeState()}),u&&this._animatables.push(u),!0}_calculateLowerRadiusFromModelBoundingSphere(e,t){let i=this._attachedCamera;if(!i)return 0;let r=i._calculateLowerRadiusFromModelBoundingSphere(e,t,this._radiusScale);return i.lowerRadiusLimit&&this._mode===n.IgnoreBoundsSizeMode&&(r=r<i.lowerRadiusLimit?i.lowerRadiusLimit:r),i.upperRadiusLimit&&(r=r>i.upperRadiusLimit?i.upperRadiusLimit:r),r}_maintainCameraAboveGround(){if(this._elevationReturnTime<0)return;let e=Xn.Now-this._lastInteractionTime,t=Math.PI*.5-this._defaultElevation,i=Math.PI*.5;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>i&&e>=this._elevationReturnWaitTime){this._betaIsAnimating=!0,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=H.CreateAnimation("beta",H.ANIMATIONTYPE_FLOAT,60,n.EasingFunction));let r=H.TransitionTo("beta",t,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,()=>{this._clearAnimationLocks(),this.stopAllAnimations()});r&&this._animatables.push(r)}}_clearAnimationLocks(){this._betaIsAnimating=!1}_applyUserInteraction(){this.isUserIsMoving&&(this._lastInteractionTime=Xn.Now,this.stopAllAnimations(),this._clearAnimationLocks())}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift()}get isUserIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}};to.EasingFunction=new E0;to.EasingMode=Qi.EASINGMODE_EASEINOUT;to.IgnoreBoundsSizeMode=0;to.FitFrustumSidesMode=1;var fh=class{constructor(){this._currentMousePointerIdDown=-1,this.buttons=[0,1,2]}attachControl(e){e=z.BackCompatCameraNoPreventDefault(arguments);let t=this.camera.getEngine(),i=t.getInputElement(),r=0,s=null;this._pointA=null,this._pointB=null,this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._pointerInput=a=>{let l=a.event,c=l.pointerType==="touch";if(a.type!==Ee.POINTERMOVE&&this.buttons.indexOf(l.button)===-1)return;let u=l.target;if(this._altKey=l.altKey,this._ctrlKey=l.ctrlKey,this._metaKey=l.metaKey,this._shiftKey=l.shiftKey,this._buttonsPressed=l.buttons,t.isPointerLock){let h=l.movementX,d=l.movementY;this.onTouch(null,h,d),this._pointA=null,this._pointB=null}else{if(a.type!==Ee.POINTERDOWN&&a.type!==Ee.POINTERDOUBLETAP&&c&&this._pointA?.pointerId!==l.pointerId&&this._pointB?.pointerId!==l.pointerId)return;if(a.type===Ee.POINTERDOWN&&(this._currentMousePointerIdDown===-1||c)){try{u?.setPointerCapture(l.pointerId)}catch{}if(this._pointA===null)this._pointA={x:l.clientX,y:l.clientY,pointerId:l.pointerId,type:l.pointerType,button:l.button};else if(this._pointB===null)this._pointB={x:l.clientX,y:l.clientY,pointerId:l.pointerId,type:l.pointerType,button:l.button};else return;this._currentMousePointerIdDown===-1&&!c&&(this._currentMousePointerIdDown=l.pointerId),this.onButtonDown(l),e||(l.preventDefault(),i&&i.focus())}else if(a.type===Ee.POINTERDOUBLETAP)this.onDoubleTap(l.pointerType);else if(a.type===Ee.POINTERUP&&(this._currentMousePointerIdDown===l.pointerId||c)){try{u?.releasePointerCapture(l.pointerId)}catch{}c||(this._pointB=null),t._badOS?this._pointA=this._pointB=null:this._pointB&&this._pointA&&this._pointA.pointerId==l.pointerId?(this._pointA=this._pointB,this._pointB=null):this._pointA&&this._pointB&&this._pointB.pointerId==l.pointerId?this._pointB=null:this._pointA=this._pointB=null,(r!==0||s)&&(this.onMultiTouch(this._pointA,this._pointB,r,0,s,null),r=0,s=null),this._currentMousePointerIdDown=-1,this.onButtonUp(l),e||l.preventDefault()}else if(a.type===Ee.POINTERMOVE){if(e||l.preventDefault(),this._pointA&&this._pointB===null){let h=l.clientX-this._pointA.x,d=l.clientY-this._pointA.y;this._pointA.x=l.clientX,this._pointA.y=l.clientY,this.onTouch(this._pointA,h,d)}else if(this._pointA&&this._pointB){let h=this._pointA.pointerId===l.pointerId?this._pointA:this._pointB;h.x=l.clientX,h.y=l.clientY;let d=this._pointA.x-this._pointB.x,f=this._pointA.y-this._pointB.y,p=d*d+f*f,g={x:(this._pointA.x+this._pointB.x)/2,y:(this._pointA.y+this._pointB.y)/2,pointerId:l.pointerId,type:a.type};this.onMultiTouch(this._pointA,this._pointB,r,p,s,g),s=g,r=p}}}},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Ee.POINTERDOWN|Ee.POINTERUP|Ee.POINTERMOVE|Ee.POINTERDOUBLETAP),this._onLostFocus=()=>{this._pointA=this._pointB=null,r=0,s=null,this.onLostFocus()},this._contextMenuBind=a=>this.onContextMenu(a),i&&i.addEventListener("contextmenu",this._contextMenuBind,!1);let o=this.camera.getScene().getEngine().getHostWindow();o&&z.RegisterTopRootEvents(o,[{name:"blur",handler:this._onLostFocus}])}detachControl(){if(this._onLostFocus){let e=this.camera.getScene().getEngine().getHostWindow();e&&z.UnregisterTopRootEvents(e,[{name:"blur",handler:this._onLostFocus}])}if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._contextMenuBind){let e=this.camera.getScene().getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this._onLostFocus=null}this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._currentMousePointerIdDown=-1}getClassName(){return"BaseCameraPointersInput"}getSimpleName(){return"pointers"}onDoubleTap(e){}onTouch(e,t,i){}onMultiTouch(e,t,i,r,s,o){}onContextMenu(e){e.preventDefault()}onButtonDown(e){}onButtonUp(e){}onLostFocus(){}};w([B()],fh.prototype,"buttons",void 0);var la=class extends fh{constructor(){super(...arguments),this.pinchZoom=!0,this.multiTouchPanning=!0,this.multiTouchPanAndZoom=!0,this._isPinching=!1,this._twoFingerActivityCount=0,this._shouldStartPinchZoom=!1}_computePinchZoom(e,t){}_computeMultiTouchPanning(e,t){}onMultiTouch(e,t,i,r,s,o){i===0&&s===null||r===0&&o===null||(this.multiTouchPanAndZoom?(this._computePinchZoom(i,r),this._computeMultiTouchPanning(s,o)):this.multiTouchPanning&&this.pinchZoom?(this._twoFingerActivityCount++,this._isPinching||this._shouldStartPinchZoom?(this._computePinchZoom(i,r),this._isPinching=!0):this._computeMultiTouchPanning(s,o)):this.multiTouchPanning?this._computeMultiTouchPanning(s,o):this.pinchZoom&&this._computePinchZoom(i,r))}onButtonUp(e){this._twoFingerActivityCount=0,this._isPinching=!1}onLostFocus(){this._twoFingerActivityCount=0,this._isPinching=!1}};w([B()],la.prototype,"pinchZoom",void 0);w([B()],la.prototype,"multiTouchPanning",void 0);w([B()],la.prototype,"multiTouchPanAndZoom",void 0);var Dn=class n extends la{constructor(){super(...arguments),this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.useNaturalPinchZoom=!1,this.panningSensibility=1e3,this.pinchInwards=!0,this._isPanClick=!1}getClassName(){return"ArcRotateCameraPointersInput"}_computeMultiTouchPanning(e,t){if(this.panningSensibility!==0&&e&&t){let i=t.x-e.x,r=t.y-e.y;this.camera.inertialPanningX+=-i/this.panningSensibility,this.camera.inertialPanningY+=r/this.panningSensibility}}_computePinchZoom(e,t){let i=this.camera.radius||n.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=i*Math.sqrt(e)/Math.sqrt(t):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=(t-e)*.001*i*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(t-e)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}onTouch(e,t,i){this.panningSensibility!==0&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)?(this.camera.inertialPanningX+=-t/this.panningSensibility,this.camera.inertialPanningY+=i/this.panningSensibility):(this.camera.inertialAlphaOffset-=t/this.angularSensibilityX,this.camera.inertialBetaOffset-=i/this.angularSensibilityY)}onDoubleTap(){this.camera.useInputToRestoreState&&this.camera.restoreState()}onMultiTouch(e,t,i,r,s,o){this._shouldStartPinchZoom=this._twoFingerActivityCount<20&&Math.abs(Math.sqrt(r)-Math.sqrt(i))>this.camera.pinchToPanMaxDistance,super.onMultiTouch(e,t,i,r,s,o)}onButtonDown(e){this._isPanClick=e.button===this.camera._panningMouseButton,super.onButtonDown(e)}onButtonUp(e){super.onButtonUp(e)}onLostFocus(){this._isPanClick=!1,super.onLostFocus()}};Dn.MinimumRadiusForPinch=.001;w([B()],Dn.prototype,"buttons",void 0);w([B()],Dn.prototype,"angularSensibilityX",void 0);w([B()],Dn.prototype,"angularSensibilityY",void 0);w([B()],Dn.prototype,"pinchPrecision",void 0);w([B()],Dn.prototype,"pinchDeltaPercentage",void 0);w([B()],Dn.prototype,"useNaturalPinchZoom",void 0);w([B()],Dn.prototype,"panningSensibility",void 0);Vt.ArcRotateCameraPointersInput=Dn;var dn=class{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0,this.angularSpeed=.01,this._keys=new Array}attachControl(e){e=z.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{let i=t.event;if(!i.metaKey){if(t.type===Lh.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysReset.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysReset.indexOf(i.keyCode)!==-1){let r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),i.preventDefault&&(e||i.preventDefault())}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){let e=this.camera;for(let t=0;t<this._keys.length;t++){let i=this._keys[t];this.keysLeft.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX-=1/this.panningSensibility:e.inertialAlphaOffset-=this.angularSpeed:this.keysUp.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset+=1/this.zoomingSensibility:e.inertialBetaOffset-=this.angularSpeed:this.keysRight.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX+=1/this.panningSensibility:e.inertialAlphaOffset+=this.angularSpeed:this.keysDown.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset-=1/this.zoomingSensibility:e.inertialBetaOffset+=this.angularSpeed:this.keysReset.indexOf(i)!==-1&&e.useInputToRestoreState&&e.restoreState()}}}getClassName(){return"ArcRotateCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}};w([B()],dn.prototype,"keysUp",void 0);w([B()],dn.prototype,"keysDown",void 0);w([B()],dn.prototype,"keysLeft",void 0);w([B()],dn.prototype,"keysRight",void 0);w([B()],dn.prototype,"keysReset",void 0);w([B()],dn.prototype,"panningSensibility",void 0);w([B()],dn.prototype,"zoomingSensibility",void 0);w([B()],dn.prototype,"useAltToZoom",void 0);w([B()],dn.prototype,"angularSpeed",void 0);Vt.ArcRotateCameraKeyboardMoveInput=dn;var Uk=40,io=class{constructor(){this.wheelPrecision=3,this.zoomToMouseLocation=!1,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this._viewOffset=new m(0,0,0),this._globalOffset=new m(0,0,0),this._inertialPanning=m.Zero()}_computeDeltaFromMouseWheelLegacyEvent(e,t){let i=0,r=e*.01*this.wheelDeltaPercentage*t;return e>0?i=r/(1+this.wheelDeltaPercentage):i=r*(1+this.wheelDeltaPercentage),i}attachControl(e){e=z.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Ee.POINTERWHEEL)return;let i=t.event,r=0,s=i.deltaMode===Bh.DOM_DELTA_LINE?Uk:1,o=-(i.deltaY*s);if(this.customComputeDeltaFromMouseWheel)r=this.customComputeDeltaFromMouseWheel(o,this,i);else if(this.wheelDeltaPercentage){if(r=this._computeDeltaFromMouseWheelLegacyEvent(o,this.camera.radius),r>0){let a=this.camera.radius,l=this.camera.inertialRadiusOffset+r;for(let c=0;c<20&&!(a<=l||Math.abs(l*this.camera.inertia)<.001);c++)a-=l,l*=this.camera.inertia;a=On(a,0,Number.MAX_VALUE),r=this._computeDeltaFromMouseWheelLegacyEvent(o,a)}}else r=o/(this.wheelPrecision*40);r&&(this.zoomToMouseLocation?(this._hitPlane||this._updateHitPlane(),this._zoomToMouse(r)):this.camera.inertialRadiusOffset+=r),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Ee.POINTERWHEEL),this.zoomToMouseLocation&&this._inertialPanning.setAll(0)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}checkInputs(){if(!this.zoomToMouseLocation)return;let e=this.camera;0+e.inertialAlphaOffset+e.inertialBetaOffset+e.inertialRadiusOffset&&(this._updateHitPlane(),e.target.addInPlace(this._inertialPanning),this._inertialPanning.scaleInPlace(e.inertia),this._zeroIfClose(this._inertialPanning))}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}_updateHitPlane(){let e=this.camera,t=e.target.subtract(e.position);this._hitPlane=Sa.FromPositionAndNormal(e.target,t)}_getPosition(){let e=this.camera,t=e.getScene(),i=t.createPickingRay(t.pointerX,t.pointerY,L.Identity(),e,!1);(e.targetScreenOffset.x!==0||e.targetScreenOffset.y!==0)&&(this._viewOffset.set(e.targetScreenOffset.x,e.targetScreenOffset.y,0),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),this._globalOffset=m.TransformNormal(this._viewOffset,e._cameraTransformMatrix),i.origin.addInPlace(this._globalOffset));let r=0;return this._hitPlane&&(r=i.intersectsPlane(this._hitPlane)??0),i.origin.addInPlace(i.direction.scaleInPlace(r))}_zoomToMouse(e){let t=this.camera,i=1-t.inertia;if(t.lowerRadiusLimit){let l=t.lowerRadiusLimit??0;t.radius-(t.inertialRadiusOffset+e)/i<l&&(e=(t.radius-l)*i-t.inertialRadiusOffset)}if(t.upperRadiusLimit){let l=t.upperRadiusLimit??0;t.radius-(t.inertialRadiusOffset+e)/i>l&&(e=(t.radius-l)*i-t.inertialRadiusOffset)}let s=e/i/t.radius,o=this._getPosition(),a=k.Vector3[6];o.subtractToRef(t.target,a),a.scaleInPlace(s),a.scaleInPlace(i),this._inertialPanning.addInPlace(a),t.inertialRadiusOffset+=e}_zeroIfClose(e){Math.abs(e.x)<tt&&(e.x=0),Math.abs(e.y)<tt&&(e.y=0),Math.abs(e.z)<tt&&(e.z=0)}};w([B()],io.prototype,"wheelPrecision",void 0);w([B()],io.prototype,"zoomToMouseLocation",void 0);w([B()],io.prototype,"wheelDeltaPercentage",void 0);Vt.ArcRotateCameraMouseWheelInput=io;var lc=class extends Fl{constructor(e){super(e)}addMouseWheel(){return this.add(new io),this}addPointers(){return this.add(new Dn),this}addKeyboard(){return this.add(new dn),this}};Ut.AddNodeConstructor("ArcRotateCamera",(n,e)=>()=>new Qe(n,0,0,1,m.Zero(),e));function zk(n){let e=Math.PI/2;return n.x===0&&n.z===0||(e=Math.acos(n.x/Math.sqrt(Math.pow(n.x,2)+Math.pow(n.z,2)))),n.z<0&&(e=2*Math.PI-e),e}function Hk(n,e){return Math.acos(n/e)}function Ni(n,e){return isNaN(n)?e:n}var Qe=class n extends gi{get target(){return this._target}set target(e){this.setTarget(e)}get targetHost(){return this._targetHost}set targetHost(e){e&&this.setTarget(e)}getTarget(){return this.target}get position(){return this._position}set position(e){this.setPosition(e)}set upVector(e){this._upToYMatrix||(this._yToUpMatrix=new L,this._upToYMatrix=new L,this._upVector=m.Zero()),e.normalize(),this._upVector.copyFrom(e),this.setMatUp()}get upVector(){return this._upVector}setMatUp(){L.RotationAlignToRef(m.UpReadOnly,this._upVector,this._yToUpMatrix),L.RotationAlignToRef(this._upVector,m.UpReadOnly,this._upToYMatrix)}get angularSensibilityX(){let e=this.inputs.attached.pointers;return e?e.angularSensibilityX:0}set angularSensibilityX(e){let t=this.inputs.attached.pointers;t&&(t.angularSensibilityX=e)}get angularSensibilityY(){let e=this.inputs.attached.pointers;return e?e.angularSensibilityY:0}set angularSensibilityY(e){let t=this.inputs.attached.pointers;t&&(t.angularSensibilityY=e)}get pinchPrecision(){let e=this.inputs.attached.pointers;return e?e.pinchPrecision:0}set pinchPrecision(e){let t=this.inputs.attached.pointers;t&&(t.pinchPrecision=e)}get pinchDeltaPercentage(){let e=this.inputs.attached.pointers;return e?e.pinchDeltaPercentage:0}set pinchDeltaPercentage(e){let t=this.inputs.attached.pointers;t&&(t.pinchDeltaPercentage=e)}get useNaturalPinchZoom(){let e=this.inputs.attached.pointers;return e?e.useNaturalPinchZoom:!1}set useNaturalPinchZoom(e){let t=this.inputs.attached.pointers;t&&(t.useNaturalPinchZoom=e)}get panningSensibility(){let e=this.inputs.attached.pointers;return e?e.panningSensibility:0}set panningSensibility(e){let t=this.inputs.attached.pointers;t&&(t.panningSensibility=e)}get keysUp(){let e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){let t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){let e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){let t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){let e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){let t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){let e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){let t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get wheelPrecision(){let e=this.inputs.attached.mousewheel;return e?e.wheelPrecision:0}set wheelPrecision(e){let t=this.inputs.attached.mousewheel;t&&(t.wheelPrecision=e)}get zoomToMouseLocation(){let e=this.inputs.attached.mousewheel;return e?e.zoomToMouseLocation:!1}set zoomToMouseLocation(e){let t=this.inputs.attached.mousewheel;t&&(t.zoomToMouseLocation=e)}get wheelDeltaPercentage(){let e=this.inputs.attached.mousewheel;return e?e.wheelDeltaPercentage:0}set wheelDeltaPercentage(e){let t=this.inputs.attached.mousewheel;t&&(t.wheelDeltaPercentage=e)}get isInterpolating(){return this._isInterpolating}get bouncingBehavior(){return this._bouncingBehavior}get useBouncingBehavior(){return this._bouncingBehavior!=null}set useBouncingBehavior(e){e!==this.useBouncingBehavior&&(e?(this._bouncingBehavior=new ac,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null))}get framingBehavior(){return this._framingBehavior}get useFramingBehavior(){return this._framingBehavior!=null}set useFramingBehavior(e){e!==this.useFramingBehavior&&(e?(this._framingBehavior=new to,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null))}get autoRotationBehavior(){return this._autoRotationBehavior}get useAutoRotationBehavior(){return this._autoRotationBehavior!=null}set useAutoRotationBehavior(e){e!==this.useAutoRotationBehavior&&(e?(this._autoRotationBehavior=new _g,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null))}constructor(e,t,i,r,s,o,a=!0){super(e,m.Zero(),o,a),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI-.01,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.lowerTargetYLimit=-1/0,this.inertialPanningX=0,this.inertialPanningY=0,this.pinchToPanMaxDistance=20,this.panningDistanceLimit=null,this.panningOriginTarget=m.Zero(),this.panningInertia=.9,this.zoomOnFactor=1,this.targetScreenOffset=me.Zero(),this.allowUpsideDown=!0,this.useInputToRestoreState=!0,this.restoreStateInterpolationFactor=0,this._currentInterpolationFactor=0,this._viewMatrix=new L,this.panningAxis=new m(1,1,0),this._transformedDirection=new m,this.mapPanning=!1,this._isInterpolating=!1,this.onMeshTargetChangedObservable=new F,this.checkCollisions=!1,this.collisionRadius=new m(.5,.5,.5),this._previousPosition=m.Zero(),this._collisionVelocity=m.Zero(),this._newPosition=m.Zero(),this._computationVector=m.Zero(),this._goalAlpha=NaN,this._goalBeta=NaN,this._goalRadius=NaN,this._goalTarget=new m(NaN,NaN,NaN),this._goalTargetScreenOffset=new me(NaN,NaN),this._onCollisionPositionChange=(l,c,u=null)=>{u?(this.setPosition(c),this.onCollide&&this.onCollide(u)):this._previousPosition.copyFrom(this._position);let h=Math.cos(this.alpha),d=Math.sin(this.alpha),f=Math.cos(this.beta),p=Math.sin(this.beta);p===0&&(p=1e-4);let g=this._getTargetPosition();this._computationVector.copyFromFloats(this.radius*h*p,this.radius*f,this.radius*d*p),g.addToRef(this._computationVector,this._newPosition),this._position.copyFrom(this._newPosition);let _=this.upVector;this.allowUpsideDown&&this.beta<0&&(_=_.clone(),_=_.negate()),this._computeViewMatrix(this._position,g,_),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y),this._collisionTriggered=!1},this._target=m.Zero(),s&&this.setTarget(s),this.alpha=t,this.beta=i,this.radius=r,this.getViewMatrix(),this.inputs=new lc(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_initCache(){super._initCache(),this._cache._target=new m(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=me.Zero()}_updateCache(e){e||super._updateCache(),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)}_getTargetPosition(){if(this._targetHost&&this._targetHost.getAbsolutePosition){let t=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?t.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(t)}let e=this._getLockedTargetPosition();return e||this._target}storeState(){return this._storedAlpha=this.alpha,this._storedBeta=this.beta,this._storedRadius=this.radius,this._storedTarget=this._getTargetPosition().clone(),this._storedTargetScreenOffset=this.targetScreenOffset.clone(),super.storeState()}_restoreStateValues(){return this.hasStateStored()&&this.restoreStateInterpolationFactor>tt&&this.restoreStateInterpolationFactor<1?(this.interpolateTo(this._storedAlpha,this._storedBeta,this._storedRadius,this._storedTarget,this._storedTargetScreenOffset,this.restoreStateInterpolationFactor),!0):super._restoreStateValues()?(this.setTarget(this._storedTarget.clone()),this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.targetScreenOffset=this._storedTargetScreenOffset.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0):!1}stopInterpolation(){this._goalAlpha=NaN,this._goalBeta=NaN,this._goalRadius=NaN,this._goalTarget.set(NaN,NaN,NaN),this._goalTargetScreenOffset.set(NaN,NaN)}interpolateTo(e=this.alpha,t=this.beta,i=this.radius,r=this.target,s=this.targetScreenOffset,o){this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,o!=null?this._currentInterpolationFactor=o:this.restoreStateInterpolationFactor!==0?this._currentInterpolationFactor=this.restoreStateInterpolationFactor:this._currentInterpolationFactor=.1,this._goalAlpha=Ni(e,this._goalAlpha),this._goalBeta=Ni(t,this._goalBeta),this._goalRadius=Ni(i,this._goalRadius),this._goalTarget.set(Ni(r.x,this._goalTarget.x),Ni(r.y,this._goalTarget.y),Ni(r.z,this._goalTarget.z)),this._goalTargetScreenOffset.set(Ni(s.x,this._goalTargetScreenOffset.x),Ni(s.y,this._goalTargetScreenOffset.y)),this._goalAlpha=On(this._goalAlpha,this.lowerAlphaLimit??-1/0,this.upperAlphaLimit??1/0),this._goalBeta=On(this._goalBeta,this.lowerBetaLimit??-1/0,this.upperBetaLimit??1/0),this._goalRadius=On(this._goalRadius,this.lowerRadiusLimit??-1/0,this.upperRadiusLimit??1/0),this._goalTarget.y=On(this._goalTarget.y,this.lowerTargetYLimit??-1/0,1/0),this._isInterpolating=!0}_isSynchronizedViewMatrix(){return super._isSynchronizedViewMatrix()?this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset):!1}attachControl(e,t,i=!0,r=2){let s=arguments;t=z.BackCompatCameraNoPreventDefault(s),this._useCtrlForPanning=i,this._panningMouseButton=r,typeof s[0]=="boolean"&&(s.length>1&&(this._useCtrlForPanning=s[1]),s.length>2&&(this._panningMouseButton=s[2])),this.inputs.attachElement(t),this._reset=()=>{this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){if(this._collisionTriggered)return;this.inputs.checkInputs();let e=!1,t=this.speed*this._panningEpsilon,i=this.speed*this._rotationEpsilon;if(this.inertialAlphaOffset!==0||this.inertialBetaOffset!==0||this.inertialRadiusOffset!==0){e=!0;let r=this.invertRotation?-1:1,s=this._calculateHandednessMultiplier(),o=this.inertialAlphaOffset*s;this.beta<0&&(o*=-1),this.alpha+=o*r,this.beta+=this.inertialBetaOffset*r,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<i&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<i&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<i&&(this.inertialRadiusOffset=0)}if(this.inertialPanningX!==0||this.inertialPanningY!==0){e=!0;let r=new m(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);if(this._viewMatrix.invertToRef(this._cameraTransformMatrix),r.multiplyInPlace(this.panningAxis),m.TransformNormalToRef(r,this._cameraTransformMatrix,this._transformedDirection),this.mapPanning){let s=this.upVector,o=m.CrossToRef(this._transformedDirection,s,this._transformedDirection);m.CrossToRef(s,o,this._transformedDirection)}else this.panningAxis.y||(this._transformedDirection.y=0);if(!this._targetHost)if(this.panningDistanceLimit)this._transformedDirection.addInPlace(this._target),m.DistanceSquared(this._transformedDirection,this.panningOriginTarget)<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection);else{if(this.parent){let s=k.Matrix[0];this.parent.getWorldMatrix().getRotationMatrixToRef(s),s.transposeToRef(s),m.TransformCoordinatesToRef(this._transformedDirection,s,this._transformedDirection)}this._target.addInPlace(this._transformedDirection)}this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<t&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<t&&(this.inertialPanningY=0)}if(e)this.stopInterpolation();else if(this._isInterpolating){let r=!1,s=this._scene.getEngine().getDeltaTime()/1e3,o=1-Math.pow(2,-s/this._currentInterpolationFactor),a=Ni(this._goalRadius,this.radius);if(!isNaN(this._goalTarget.x)||!isNaN(this._goalTarget.y)||!isNaN(this._goalTarget.z)){let l=k.Vector3[0].set(Ni(this._goalTarget.x,this._target.x),Ni(this._goalTarget.y,this._target.y),Ni(this._goalTarget.z,this._target.z));m.LerpToRef(this.target,l,o,this._target),m.Distance(this.target,l)*10/a<tt?(this._goalTarget.set(NaN,NaN,NaN),this.target.copyFrom(l),this.setTarget(this.target,!1,!0,!0)):r=!0}if(!isNaN(this._goalAlpha)||!isNaN(this._goalBeta)){let l=Q.RotationAlphaBetaGammaToRef(Ni(this._goalAlpha,this.alpha),Ni(this._goalBeta,this.beta),0,k.Quaternion[0]),c=Q.RotationAlphaBetaGammaToRef(this.alpha,this.beta,0,k.Quaternion[1]),u=Q.SlerpToRef(c,l,o,k.Quaternion[2]);u.normalize();let h=u.toAlphaBetaGammaToRef(k.Vector3[0]);if(this.alpha=h.x,this.beta=h.y,u.isApprox(l,tt/5)){this._goalAlpha=NaN,this._goalBeta=NaN;let d=l.toAlphaBetaGammaToRef(k.Vector3[0]);this.alpha=d.x,this.beta=d.y}else r=!0}if(isNaN(this._goalRadius)||(this.radius+=(a-this.radius)*o,Math.abs(a/this.radius-1)<tt?(this._goalRadius=NaN,this.radius=a):r=!0),!isNaN(this._goalTargetScreenOffset.x)||!isNaN(this._goalTargetScreenOffset.y)){let l=k.Vector2[0].set(Ni(this._goalTargetScreenOffset.x,this.targetScreenOffset.x),Ni(this._goalTargetScreenOffset.y,this.targetScreenOffset.y));me.LerpToRef(this.targetScreenOffset,l,o,this.targetScreenOffset),me.Distance(this.targetScreenOffset,l)<tt?(this._goalTargetScreenOffset.set(NaN,NaN),this.targetScreenOffset.copyFrom(l)):r=!0}this._isInterpolating=r}this._checkLimits(),super._checkInputs()}_checkLimits(){this.lowerBetaLimit===null||this.lowerBetaLimit===void 0?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),this.upperBetaLimit===null||this.upperBetaLimit===void 0?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),this.lowerAlphaLimit!==null&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),this.upperAlphaLimit!==null&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),this.lowerRadiusLimit!==null&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),this.upperRadiusLimit!==null&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0),this.target.y=Math.max(this.target.y,this.lowerTargetYLimit)}rebuildAnglesAndRadius(){this._position.subtractToRef(this._getTargetPosition(),this._computationVector),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&m.TransformCoordinatesToRef(this._computationVector,this._upToYMatrix,this._computationVector),this.radius=this._computationVector.length(),this.radius===0&&(this.radius=1e-4);let e=this.alpha;this.alpha=zk(this._computationVector),this.beta=Hk(this._computationVector.y,this.radius);let t=Math.round((e-this.alpha)/(2*Math.PI));this.alpha+=t*2*Math.PI,this._checkLimits()}setPosition(e){this._position.equals(e)||(this._position.copyFrom(e),this.rebuildAnglesAndRadius())}setTarget(e,t=!1,i=!1,r=!1){if(r=this.overrideCloneAlphaBetaRadius??r,e.computeWorldMatrix)t&&e.getBoundingInfo?this._targetBoundingCenter=e.getBoundingInfo().boundingBox.centerWorld.clone():this._targetBoundingCenter=null,e.computeWorldMatrix(),this._targetHost=e,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else{let s=e,o=this._getTargetPosition();if(o&&!i&&o.equals(s))return;this._targetHost=null,this._target=s,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null)}r||this.rebuildAnglesAndRadius()}_getViewMatrix(){let e=Math.cos(this.alpha),t=Math.sin(this.alpha),i=Math.cos(this.beta),r=Math.sin(this.beta);r===0&&(r=1e-4),this.radius===0&&(this.radius=1e-4);let s=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*e*r,this.radius*i,this.radius*t*r),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&m.TransformCoordinatesToRef(this._computationVector,this._yToUpMatrix,this._computationVector),s.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions){let o=this.getScene().collisionCoordinator;this._collider||(this._collider=o.createCollider()),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this._position,this._collisionVelocity),this._collisionTriggered=!0,o.getNewPosition(this._position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this._position.copyFrom(this._newPosition);let o=this.upVector;this.allowUpsideDown&&r<0&&(o=o.negate()),this._computeViewMatrix(this._position,s,o),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y)}return this._currentTarget.copyFrom(s),this._viewMatrix}zoomOn(e,t=!1){e=e||this.getScene().meshes;let i=E.MinMax(e),r=this._calculateLowerRadiusFromModelBoundingSphere(i.min,i.max);if(r=Math.max(Math.min(r,this.upperRadiusLimit||Number.MAX_VALUE),this.lowerRadiusLimit||0),this.radius=r*this.zoomOnFactor,this.mode===Fe.ORTHOGRAPHIC_CAMERA){let s=this.getScene().getEngine().getAspectRatio(this),o=r*this.zoomOnFactor/2;this.orthoLeft=-o*s,this.orthoRight=o*s,this.orthoBottom=-o,this.orthoTop=o}this.focusOn({min:i.min,max:i.max,distance:r},t)}focusOn(e,t=!1){let i,r;if(e.min===void 0){let s=e||this.getScene().meshes;i=E.MinMax(s),r=m.Distance(i.min,i.max)}else{let s=e;i=s,r=s.distance}this._target=E.Center(i),t||(this.maxZ=r*2)}createRigCamera(e,t){let i=0;switch(this.cameraRigMode){case Fe.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Fe.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Fe.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Fe.RIG_MODE_STEREOSCOPIC_INTERLACED:case Fe.RIG_MODE_VR:i=this._cameraRigParams.stereoHalfAngle*(t===0?1:-1);break;case Fe.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:i=this._cameraRigParams.stereoHalfAngle*(t===0?-1:1);break}let r=new n(e,this.alpha+i,this.beta,this.radius,this._target,this.getScene());return r._cameraRigParams={},r.isRigCamera=!0,r.rigParent=this,r.upVector=this.upVector,r.mode=this.mode,r.orthoLeft=this.orthoLeft,r.orthoRight=this.orthoRight,r.orthoBottom=this.orthoBottom,r.orthoTop=this.orthoTop,r}_updateRigCameras(){let e=this._rigCameras[0],t=this._rigCameras[1];switch(e.beta=t.beta=this.beta,this.cameraRigMode){case Fe.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Fe.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Fe.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Fe.RIG_MODE_STEREOSCOPIC_INTERLACED:case Fe.RIG_MODE_VR:e.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case Fe.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle;break}super._updateRigCameras()}_calculateLowerRadiusFromModelBoundingSphere(e,t,i=1){let r=m.Distance(e,t),o=this.getScene().getEngine().getAspectRatio(this),a=Math.tan(this.fov/2),l=a*o,u=r*.5*i,h=u*Math.sqrt(1+1/(l*l)),d=u*Math.sqrt(1+1/(a*a));return Math.max(h,d)}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"ArcRotateCamera"}};w([B()],Qe.prototype,"alpha",void 0);w([B()],Qe.prototype,"beta",void 0);w([B()],Qe.prototype,"radius",void 0);w([B()],Qe.prototype,"overrideCloneAlphaBetaRadius",void 0);w([Jt("target")],Qe.prototype,"_target",void 0);w([Aa("targetHost")],Qe.prototype,"_targetHost",void 0);w([B()],Qe.prototype,"inertialAlphaOffset",void 0);w([B()],Qe.prototype,"inertialBetaOffset",void 0);w([B()],Qe.prototype,"inertialRadiusOffset",void 0);w([B()],Qe.prototype,"lowerAlphaLimit",void 0);w([B()],Qe.prototype,"upperAlphaLimit",void 0);w([B()],Qe.prototype,"lowerBetaLimit",void 0);w([B()],Qe.prototype,"upperBetaLimit",void 0);w([B()],Qe.prototype,"lowerRadiusLimit",void 0);w([B()],Qe.prototype,"upperRadiusLimit",void 0);w([B()],Qe.prototype,"lowerTargetYLimit",void 0);w([B()],Qe.prototype,"inertialPanningX",void 0);w([B()],Qe.prototype,"inertialPanningY",void 0);w([B()],Qe.prototype,"pinchToPanMaxDistance",void 0);w([B()],Qe.prototype,"panningDistanceLimit",void 0);w([Jt()],Qe.prototype,"panningOriginTarget",void 0);w([B()],Qe.prototype,"panningInertia",void 0);w([B()],Qe.prototype,"zoomToMouseLocation",null);w([B()],Qe.prototype,"zoomOnFactor",void 0);w([VT()],Qe.prototype,"targetScreenOffset",void 0);w([B()],Qe.prototype,"allowUpsideDown",void 0);w([B()],Qe.prototype,"useInputToRestoreState",void 0);w([B()],Qe.prototype,"restoreStateInterpolationFactor",void 0);le("BABYLON.ArcRotateCamera",Qe);Xs(Oe.NAME_SHADOWGENERATOR,(n,e)=>{if(n.shadowGenerators!==void 0&&n.shadowGenerators!==null)for(let t=0,i=n.shadowGenerators.length;t<i;t++){let r=n.shadowGenerators[t];r.className===Qg.CLASSNAME?Qg.Parse(r,e):Xg.Parse(r,e)}});var oT=class{constructor(e){this.name=Oe.NAME_SHADOWGENERATOR,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(Oe.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)}rebuild(){}serialize(e){e.shadowGenerators=[];let t=this.scene.lights;for(let i of t){if(i.doNotSerialize)continue;let r=i.getShadowGenerators();if(r){let s=r.values();for(let o=s.next();o.done!==!0;o=s.next()){let a=o.value;a.doNotSerialize||e.shadowGenerators.push(a.serialize())}}}}addFromContainer(e){}removeFromContainer(e,t){}dispose(){}_gatherRenderTargets(e){let t=this.scene;if(this.scene.shadowsEnabled)for(let i=0;i<t.lights.length;i++){let r=t.lights[i],s=r.getShadowGenerators();if(r.isEnabled()&&r.shadowEnabled&&s){let o=s.values();for(let a=o.next();a.done!==!0;a=o.next()){let c=a.value.getShadowMap();t.textures.indexOf(c)!==-1&&e.push(c)}}}}};Xg._SceneComponentInitialization=n=>{let e=n._getComponent(Oe.NAME_SHADOWGENERATOR);e||(e=new oT(n),n._addComponent(e))};var ph=class n extends hi{set blurRatio(e){this._blurRatio!==e&&(this._blurRatio=e,this._preparePostProcesses())}get blurRatio(){return this._blurRatio}set adaptiveBlurKernel(e){this._adaptiveBlurKernel=e,this._autoComputeBlurKernel()}set blurKernel(e){this.blurKernelX=e,this.blurKernelY=e}set blurKernelX(e){this._blurKernelX!==e&&(this._blurKernelX=e,this._preparePostProcesses())}get blurKernelX(){return this._blurKernelX}set blurKernelY(e){this._blurKernelY!==e&&(this._blurKernelY=e,this._preparePostProcesses())}get blurKernelY(){return this._blurKernelY}_autoComputeBlurKernel(){let e=this.getScene().getEngine(),t=this.getRenderWidth()/e.getRenderWidth(),i=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*t,this.blurKernelY=this._adaptiveBlurKernel*i}resize(e){super.resize(e),this._adaptiveBlurKernel?this._autoComputeBlurKernel():this._preparePostProcesses()}_onRatioRescale(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()}_updateGammaSpace(){let e=this.getScene();e&&(this.gammaSpace=!e.imageProcessingConfiguration.isEnabled||!e.imageProcessingConfiguration.applyByPostProcess)}constructor(e,t,i,r,s=0,o=Z.BILINEAR_SAMPLINGMODE,a=!0){if(super(e,t,i,r,!0,s,!1,o,a),this.mirrorPlane=new Sa(0,1,0,1),this._transformMatrix=L.Zero(),this._mirrorMatrix=L.Zero(),this._adaptiveBlurKernel=0,this._blurKernelX=0,this._blurKernelY=0,this._blurRatio=1,i=this.getScene(),!i)return this;this.ignoreCameraViewport=!0,this._updateGammaSpace(),this._imageProcessingConfigChangeObserver=i.imageProcessingConfiguration.onUpdateParameters.add(()=>{this._updateGammaSpace()}),i.getEngine().supportsUniformBuffers&&(this._sceneUBO=i.createSceneUniformBuffer(`Scene for Mirror Texture (name "${e}")`));let c;this.onBeforeRenderObservable.add(()=>{this._sceneUBO&&(this._currentSceneUBO=i.getSceneUniformBuffer(),i.setSceneUniformBuffer(this._sceneUBO),i.getSceneUniformBuffer().unbindEffect()),L.ReflectionToRef(this.mirrorPlane,this._mirrorMatrix),this._mirrorMatrix.multiplyToRef(i.getViewMatrix(),this._transformMatrix),i.setTransformMatrix(this._transformMatrix,i.getProjectionMatrix()),c=i.clipPlane,i.clipPlane=this.mirrorPlane;let u=m.TransformCoordinates(i.activeCamera.globalPosition,this._mirrorMatrix);i._mirroredCameraPosition=u,i._forcedViewPosition=u}),this.onAfterRenderObservable.add(()=>{this._sceneUBO&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(),i._mirroredCameraPosition=null,i._forcedViewPosition=null,i.clipPlane=c})}_preparePostProcesses(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){let e=this.getScene().getEngine(),t=e.getCaps().textureFloatRender&&e.getCaps().textureFloatLinearFiltering?1:2;this._blurX=new As("horizontal blur",new me(1,0),this._blurKernelX,this._blurRatio,null,Z.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurX.autoClear=!1,this._blurRatio===1&&this.samples<2&&this._texture?this._blurX.inputTexture=this._renderTarget:this._blurX.alwaysForcePOT=!0,this._blurY=new As("vertical blur",new me(0,1),this._blurKernelY,this._blurRatio,null,Z.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=this._blurRatio!==1,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)}clone(){let e=this.getScene();if(!e)return this;let t=this.getSize(),i=new n(this.name,t.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;let e=super.serialize();return e.mirrorPlane=this.mirrorPlane.asArray(),e}dispose(){super.dispose();let e=this.getScene();e&&e.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver),this._sceneUBO?.dispose()}};Z._CreateMirror=(n,e,t,i)=>new ph(n,e,t,i);var aT=class extends ws{},lT=class extends La(aT){constructor(){super(),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=!1,this.DIFFUSEHASALPHA=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONBLUR=!1,this.REFLECTIONFRESNEL=!1,this.REFLECTIONFALLOFF=!1,this.TEXTURELODSUPPORT=!1,this.PREMULTIPLYALPHA=!1,this.USERGBCOLOR=!1,this.USEHIGHLIGHTANDSHADOWCOLORS=!1,this.BACKMAT_SHADOWONLY=!1,this.NOISE=!1,this.REFLECTIONBGR=!1,this.PROJECTED_GROUND=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.EQUIRECTANGULAR_RELFECTION_FOV=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.UV1=!1,this.UV2=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.SHADOWFLOAT=!1,this.LOGARITHMICDEPTH=!1,this.NONUNIFORMSCALING=!1,this.ALPHATEST=!1,this.rebuild()}},cT=class extends ka(Tr){},Ve=class n extends cT{get _perceptualColor(){return this.__perceptualColor}set _perceptualColor(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()}get primaryColorShadowLevel(){return this._primaryColorShadowLevel}set primaryColorShadowLevel(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}get primaryColorHighlightLevel(){return this._primaryColorHighlightLevel}set primaryColorHighlightLevel(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}set reflectionStandardFresnelWeight(e){let t=e;t<.5?(t=t*2,this.reflectionReflectance0=n.StandardReflectance0*t,this.reflectionReflectance90=n.StandardReflectance90*t):(t=t*2-1,this.reflectionReflectance0=n.StandardReflectance0+(1-n.StandardReflectance0)*t,this.reflectionReflectance90=n.StandardReflectance90+(1-n.StandardReflectance90)*t)}get fovMultiplier(){return this._fovMultiplier}set fovMultiplier(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))}constructor(e,t,i=!1){super(e,t,void 0,i),this.primaryColor=U.White(),this._primaryColorShadowLevel=0,this._primaryColorHighlightLevel=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this._shadowLights=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=m.Zero(),this.opacityFresnel=!0,this.reflectionFresnel=!1,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=!0,this.enableNoise=!1,this._fovMultiplier=1,this.useEquirectangularFOV=!1,this._maxSimultaneousLights=4,this.maxSimultaneousLights=4,this._shadowOnly=!1,this.shadowOnly=!1,this.switchToBGR=!1,this._enableGroundProjection=!1,this.enableGroundProjection=!1,this.projectedGroundRadius=1e3,this.projectedGroundHeight=10,this._renderTargets=new wa(16),this._reflectionControls=dt.Zero(),this._white=U.White(),this._primaryShadowColor=U.Black(),this._primaryHighlightColor=U.Black(),this._shadersLoaded=!1,this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._renderTargets.push(this._diffuseTexture),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._renderTargets)}get hasRenderTargetTextures(){return!!(this._diffuseTexture&&this._diffuseTexture.isRenderTarget||this._reflectionTexture&&this._reflectionTexture.isRenderTarget)}needAlphaTesting(){return!0}needAlphaBlending(){return this.alpha<1||this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._shadowOnly}isReadyForSubMesh(e,t,i=!1){let r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new lT);let s=this.getScene(),o=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;let a=s.getEngine();if($h(s,e,o,!1,this._maxSimultaneousLights),o._needNormals=!0,qh(s,o),o._areTexturesDirty){if(o._needUVs=!1,s.texturesEnabled){if(s.getEngine().getCaps().textureLOD&&(o.TEXTURELODSUPPORT=!0),this._diffuseTexture&&at.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;br(this._diffuseTexture,o,"DIFFUSE"),o.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,o.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,o.OPACITYFRESNEL=this._opacityFresnel}else o.DIFFUSE=!1,o.DIFFUSEDIRECTUV=0,o.DIFFUSEHASALPHA=!1,o.GAMMADIFFUSE=!1,o.OPACITYFRESNEL=!1;let l=this._reflectionTexture;if(jh(s,l,o),l&&at.ReflectionTextureEnabled){if(!l.isReadyOrNotBlocking())return!1;o.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,o.REFLECTIONBGR=this.switchToBGR,o.REFLECTIONBLUR=this._reflectionBlur>0,this.reflectionFresnel?(o.REFLECTIONFRESNEL=!0,o.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(o.REFLECTIONFRESNEL=!1,o.REFLECTIONFALLOFF=!1)}else o.REFLECTIONFRESNEL=!1,o.REFLECTIONFALLOFF=!1,o.REFLECTIONBLUR=!1}o.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,o.USERGBCOLOR=this._useRGBColor,o.NOISE=this._enableNoise}if(o._areLightsDirty&&(o.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(this._primaryColorShadowLevel!==0||this._primaryColorHighlightLevel!==0),o.BACKMAT_SHADOWONLY=this._shadowOnly),o._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(o)}if(o._areMiscDirty&&(o.REFLECTIONMAP_3D&&this._enableGroundProjection?(o.PROJECTED_GROUND=!0,o.REFLECTIONMAP_SKYBOX=!0):o.PROJECTED_GROUND=!1),Pa(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),o,void 0,void 0,void 0,this._isVertexOutputInvariant),Oa(s,a,this,o,i,null,t.getRenderingMesh().hasThinInstances),Na(e,o,!1,!0,!1)&&e&&!s.getEngine().getCaps().standardDerivatives&&!e.isVerticesDataPresent(T.NormalKind)&&(e.createNormals(!0),P.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name)),o.isDirty){o.markAsProcessed(),s.resetCachedMaterial();let l=new vr;o.FOG&&l.addFallback(0,"FOG"),o.POINTSIZE&&l.addFallback(1,"POINTSIZE"),o.MULTIVIEW&&l.addFallback(0,"MULTIVIEW"),Wh(o,l,this._maxSimultaneousLights);let c=[T.PositionKind];o.NORMAL&&c.push(T.NormalKind),o.UV1&&c.push(T.UVKind),o.UV2&&c.push(T.UV2Kind),Hh(c,e,o,l),Ra(c,o);let u=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","mBones","vPrimaryColor","vPrimaryColorShadow","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix","projectedGroundInfos","logarithmicDepthConstant"];Yi(u);let h=["diffuseSampler"];Kh(u,h,!1);let d=["Material","Scene"];gn&&(gn.PrepareUniforms(u,o),gn.PrepareSamplers(h,o)),Xh({uniformsNames:u,uniformBuffersNames:d,samplers:h,defines:o,maxSimultaneousLights:this._maxSimultaneousLights});let f=o.toString(),p=s.getEngine().createEffect("background",{attributes:c,uniformsNames:u,uniformBuffersNames:d,samplers:h,defines:f,fallbacks:l,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights},shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:()=>S(this,null,function*(){this.shaderLanguage===1?yield Promise.all([import("./chunk-ZQ4C773O.js"),import("./chunk-SWH7WA7H.js")]):yield Promise.all([import("./chunk-AP7I5FR2.js"),import("./chunk-FQQXX3WT.js")]),this._shadersLoaded=!0})},a);t.setEffect(p,o,this._materialContext),this.buildUniformLayout()}return!t.effect||!t.effect.isReady()?!1:(o._renderId=s.getRenderId(),r._wasPreviouslyReady=!0,r._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}_computePrimaryColorFromPerceptualColor(){this.__perceptualColor&&(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor,this.getScene().getEngine().useExactSrgbConversions),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())}_computePrimaryColors(){this._primaryColorShadowLevel===0&&this._primaryColorHighlightLevel===0||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))}buildUniformLayout(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.addUniform("projectedGroundInfos",2),Zh(this._uniformBuffer,!0,!1,!1),this._uniformBuffer.create()}unbind(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),super.unbind()}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindForSubMesh(e,t,i){let r=this.getScene(),s=i.materialDefines;if(!s)return;let o=i.effect;if(!o)return;this._activeEffect=o,this.bindOnlyWorldMatrix(e),Da(t,this._activeEffect);let a=this._mustRebind(r,o,i,t.visibility);if(a){this._uniformBuffer.bindToEffect(o,"Material"),this.bindViewProjection(o);let l=this._reflectionTexture;if((!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync||i._drawWrapper._forceRebindOnNextCall)&&(r.texturesEnabled&&(this._diffuseTexture&&at.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),xr(this._diffuseTexture,this._uniformBuffer,"diffuse")),Uh(r,s,this._uniformBuffer,U.White(),l,!1,!0,!1,!1,!1,!1,this._reflectionBlur)),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),s.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),s.REFLECTIONFRESNEL&&this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w),s.REFLECTIONFRESNEL&&s.REFLECTIONFALLOFF||s.OPACITYFRESNEL){let c=k.Vector3[0].copyFrom(this.sceneCenter).subtractInPlace(r.floatingOriginOffset);this._uniformBuffer.updateFloat3("vBackgroundCenter",c.x,c.y,c.z)}r.texturesEnabled&&(this._diffuseTexture&&at.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),l&&at.ReflectionTextureEnabled&&t0(r,s,this._uniformBuffer,l),s.PROJECTED_GROUND&&this._uniformBuffer.updateFloat2("projectedGroundInfos",this.projectedGroundRadius,this.projectedGroundHeight)),Ki(this._activeEffect,this,r),r.bindEyePosition(o)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(o,"Material"),this._needToBindSceneUbo=!0);(a||!this.isFrozen)&&(r.lightsEnabled&&zh(r,t,this._activeEffect,s,this._maxSimultaneousLights),this.bindView(o),Nn(r,t,this._activeEffect,!0),this._useLogarithmicDepth&&Si(s,o,r),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect,i),this._uniformBuffer.update()}hasTexture(e){return!!(super.hasTexture(e)||this._reflectionTexture===e||this._diffuseTexture===e)}dispose(e=!1,t=!1){t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e)}clone(e){return je.Clone(()=>new n(e,this.getScene()),this)}serialize(){let e=super.serialize();return e.customType="BABYLON.BackgroundMaterial",e}getClassName(){return"BackgroundMaterial"}static Parse(e,t,i){return je.Parse(()=>new n(e.name,t),e,t,i)}};Ve.StandardReflectance0=.05;Ve.StandardReflectance90=.5;w([mn()],Ve.prototype,"_primaryColor",void 0);w([Pe("_markAllSubMeshesAsLightsDirty")],Ve.prototype,"primaryColor",void 0);w([mn()],Ve.prototype,"__perceptualColor",void 0);w([B()],Ve.prototype,"_primaryColorShadowLevel",void 0);w([B()],Ve.prototype,"_primaryColorHighlightLevel",void 0);w([Pe("_markAllSubMeshesAsLightsDirty")],Ve.prototype,"primaryColorHighlightLevel",null);w([Bi()],Ve.prototype,"_reflectionTexture",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"reflectionTexture",void 0);w([B()],Ve.prototype,"_reflectionBlur",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"reflectionBlur",void 0);w([Bi()],Ve.prototype,"_diffuseTexture",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"diffuseTexture",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"shadowLights",void 0);w([B()],Ve.prototype,"_shadowLevel",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"shadowLevel",void 0);w([Jt()],Ve.prototype,"_sceneCenter",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"sceneCenter",void 0);w([B()],Ve.prototype,"_opacityFresnel",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"opacityFresnel",void 0);w([B()],Ve.prototype,"_reflectionFresnel",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"reflectionFresnel",void 0);w([B()],Ve.prototype,"_reflectionFalloffDistance",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"reflectionFalloffDistance",void 0);w([B()],Ve.prototype,"_reflectionAmount",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"reflectionAmount",void 0);w([B()],Ve.prototype,"_reflectionReflectance0",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"reflectionReflectance0",void 0);w([B()],Ve.prototype,"_reflectionReflectance90",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"reflectionReflectance90",void 0);w([B()],Ve.prototype,"_useRGBColor",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"useRGBColor",void 0);w([B()],Ve.prototype,"_enableNoise",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"enableNoise",void 0);w([B()],Ve.prototype,"_maxSimultaneousLights",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],Ve.prototype,"maxSimultaneousLights",void 0);w([B()],Ve.prototype,"_shadowOnly",void 0);w([Pe("_markAllSubMeshesAsLightsDirty")],Ve.prototype,"shadowOnly",void 0);w([B(),Pe("_markAllSubMeshesAsMiscDirty")],Ve.prototype,"enableGroundProjection",void 0);w([B()],Ve.prototype,"projectedGroundRadius",void 0);w([B()],Ve.prototype,"projectedGroundHeight",void 0);le("BABYLON.BackgroundMaterial",Ve);var uT=(()=>{class n{static _GetDefaultOptions(t){return{createGround:!0,groundSize:15,groundTexture:z.GetAssetUrl(this._GroundTextureCDNUrl),groundColor:new U(.2,.2,.3).toLinearSpace(t.getEngine().useExactSrgbConversions).scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:0,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:z.GetAssetUrl(this._SkyboxTextureCDNUrl),skyboxColor:new U(.2,.2,.3).toLinearSpace(t.getEngine().useExactSrgbConversions).scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:m.Zero(),setupImageProcessing:!0,environmentTexture:z.GetAssetUrl(this._EnvironmentTextureCDNUrl),cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}}get rootMesh(){return this._rootMesh}get skybox(){return this._skybox}get skyboxTexture(){return this._skyboxTexture}get skyboxMaterial(){return this._skyboxMaterial}get ground(){return this._ground}get groundTexture(){return this._groundTexture}get groundMirror(){return this._groundMirror}get groundMirrorRenderList(){return this._groundMirror?this._groundMirror.renderList:null}get groundMaterial(){return this._groundMaterial}constructor(t,i){this._errorHandler=(r,s)=>{this.onErrorObservable.notifyObservers({message:r,exception:s})},this._options=Y(Y({},n._GetDefaultOptions(i)),t),this._scene=i,this.onErrorObservable=new F,this._setupBackground(),this._setupImageProcessing()}updateOptions(t){let i=Y(Y({},this._options),t);this._ground&&!i.createGround&&(this._ground.dispose(),this._ground=null),this._groundMaterial&&!i.createGround&&(this._groundMaterial.dispose(),this._groundMaterial=null),this._groundTexture&&this._options.groundTexture!=i.groundTexture&&(this._groundTexture.dispose(),this._groundTexture=null),this._skybox&&!i.createSkybox&&(this._skybox.dispose(),this._skybox=null),this._skyboxMaterial&&!i.createSkybox&&(this._skyboxMaterial.dispose(),this._skyboxMaterial=null),this._skyboxTexture&&this._options.skyboxTexture!=i.skyboxTexture&&(this._skyboxTexture.dispose(),this._skyboxTexture=null),this._groundMirror&&!i.enableGroundMirror&&(this._groundMirror.dispose(),this._groundMirror=null),this._scene.environmentTexture&&this._options.environmentTexture!=i.environmentTexture&&this._scene.environmentTexture.dispose(),this._options=i,this._setupBackground(),this._setupImageProcessing()}setMainColor(t){this.groundMaterial&&(this.groundMaterial.primaryColor=t),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=t),this.groundMirror&&(this.groundMirror.clearColor=new ce(t.r,t.g,t.b,1))}_setupImageProcessing(){this._options.setupImageProcessing&&(this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast,this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure,this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled,this._setupEnvironmentTexture())}_setupEnvironmentTexture(){if(this._scene.environmentTexture)return;if(this._options.environmentTexture instanceof _r){this._scene.environmentTexture=this._options.environmentTexture;return}let t=Gt.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=t}_setupBackground(){this._rootMesh||(this._rootMesh=new E("BackgroundHelper",this._scene)),this._rootMesh.rotation.y=this._options.backgroundYRotation;let t=this._getSceneSize();this._options.createGround&&(this._setupGround(t),this._setupGroundMaterial(),this._setupGroundDiffuseTexture(),this._options.enableGroundMirror&&this._setupGroundMirrorTexture(t),this._setupMirrorInGroundMaterial()),this._options.createSkybox&&(this._setupSkybox(t),this._setupSkyboxMaterial(),this._setupSkyboxReflectionTexture()),this._rootMesh.position.x=t.rootPosition.x,this._rootMesh.position.z=t.rootPosition.z,this._rootMesh.position.y=t.rootPosition.y}_getSceneSize(){let t=this._options.groundSize,i=this._options.skyboxSize,r=this._options.rootPosition;if(!this._scene.meshes||this._scene.meshes.length===1)return{groundSize:t,skyboxSize:i,rootPosition:r};let s=this._scene.getWorldExtends(a=>a!==this._ground&&a!==this._rootMesh&&a!==this._skybox),o=s.max.subtract(s.min);if(this._options.sizeAuto){this._scene.activeCamera instanceof Qe&&this._scene.activeCamera.upperRadiusLimit&&(t=this._scene.activeCamera.upperRadiusLimit*2,i=t);let a=o.length();a>t&&(t=a*2,i=t),t*=1.1,i*=1.5,r=s.min.add(o.scale(.5)),r.y=s.min.y-this._options.groundYBias}return{groundSize:t,skyboxSize:i,rootPosition:r}}_setupGround(t){(!this._ground||this._ground.isDisposed())&&(this._ground=ch("BackgroundPlane",{size:t.groundSize},this._scene),this._ground.rotation.x=Math.PI/2,this._ground.isPickable=!1,this._ground.parent=this._rootMesh,this._ground.onDisposeObservable.add(()=>{this._ground=null})),this._ground.receiveShadows=this._options.enableGroundShadow}_setupGroundMaterial(){this._groundMaterial||(this._groundMaterial=new Ve("BackgroundPlaneMaterial",this._scene)),this._groundMaterial.alpha=this._options.groundOpacity,this._groundMaterial.alphaMode=8,this._groundMaterial.shadowLevel=this._options.groundShadowLevel,this._groundMaterial.primaryColor=this._options.groundColor,this._groundMaterial.useRGBColor=!1,this._groundMaterial.enableNoise=!0,this._ground&&(this._ground.material=this._groundMaterial)}_setupGroundDiffuseTexture(){if(this._groundMaterial&&!this._groundTexture){if(this._options.groundTexture instanceof _r){this._groundMaterial.diffuseTexture=this._options.groundTexture;return}this._groundTexture=new Z(this._options.groundTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._groundTexture.gammaSpace=!1,this._groundTexture.hasAlpha=!0,this._groundMaterial.diffuseTexture=this._groundTexture}}_setupGroundMirrorTexture(t){let i=Z.CLAMP_ADDRESSMODE;if(!this._groundMirror&&(this._groundMirror=new ph("BackgroundPlaneMirrorTexture",{ratio:this._options.groundMirrorSizeRatio},this._scene,!1,this._options.groundMirrorTextureType,Z.BILINEAR_SAMPLINGMODE,!0),this._groundMirror.mirrorPlane=new Sa(0,-1,0,t.rootPosition.y),this._groundMirror.anisotropicFilteringLevel=1,this._groundMirror.wrapU=i,this._groundMirror.wrapV=i,this._groundMirror.renderList))for(let s=0;s<this._scene.meshes.length;s++){let o=this._scene.meshes[s];o!==this._ground&&o!==this._skybox&&o!==this._rootMesh&&this._groundMirror.renderList.push(o)}let r=this._options.groundColor.toGammaSpace(this._scene.getEngine().useExactSrgbConversions);this._groundMirror.clearColor=new ce(r.r,r.g,r.b,1),this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel}_setupMirrorInGroundMaterial(){this._groundMaterial&&(this._groundMaterial.reflectionTexture=this._groundMirror,this._groundMaterial.reflectionFresnel=!0,this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount,this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight,this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance)}_setupSkybox(t){(!this._skybox||this._skybox.isDisposed())&&(this._skybox=oa("BackgroundSkybox",{size:t.skyboxSize,sideOrientation:E.BACKSIDE},this._scene),this._skybox.isPickable=!1,this._skybox.onDisposeObservable.add(()=>{this._skybox=null})),this._skybox.parent=this._rootMesh}_setupSkyboxMaterial(){this._skybox&&(this._skyboxMaterial||(this._skyboxMaterial=new Ve("BackgroundSkyboxMaterial",this._scene)),this._skyboxMaterial.useRGBColor=!1,this._skyboxMaterial.primaryColor=this._options.skyboxColor,this._skyboxMaterial.enableNoise=!0,this._skybox.material=this._skyboxMaterial)}_setupSkyboxReflectionTexture(){if(this._skyboxMaterial&&!this._skyboxTexture){if(this._options.skyboxTexture instanceof _r){this._skyboxMaterial.reflectionTexture=this._options.skyboxTexture;return}this._skyboxTexture=new Gt(this._options.skyboxTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._skyboxTexture.coordinatesMode=Z.SKYBOX_MODE,this._skyboxTexture.gammaSpace=!1,this._skyboxMaterial.reflectionTexture=this._skyboxTexture}}dispose(){this._groundMaterial&&this._groundMaterial.dispose(!0,!0),this._skyboxMaterial&&this._skyboxMaterial.dispose(!0,!0),this._rootMesh.dispose(!1)}}return n._GroundTextureCDNUrl="https://assets.babylonjs.com/core/environments/backgroundGround.png",n._SkyboxTextureCDNUrl="https://assets.babylonjs.com/core/environments/backgroundSkybox.dds",n._EnvironmentTextureCDNUrl="https://assets.babylonjs.com/core/environments/environmentSpecular.env",n})();Ys.prototype.addDeviceOrientation=function(n){return this._deviceOrientationInput||(this._deviceOrientationInput=new yg,n&&(this._deviceOrientationInput.smoothFactor=n),this.add(this._deviceOrientationInput)),this};var yg=class{static WaitForOrientationChangeAsync(e){return S(this,null,function*(){return yield new Promise((t,i)=>{let r=!1,s=()=>{window.removeEventListener("deviceorientation",s),r=!0,t()};e&&setTimeout(()=>{r||(window.removeEventListener("deviceorientation",s),i("WaitForOrientationChangeAsync timed out"))},e),typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(o=>{o=="granted"?window.addEventListener("deviceorientation",s):z.Warn("Permission not granted.")}).catch(o=>{z.Error(o)}):window.addEventListener("deviceorientation",s)})})}constructor(){this._screenOrientationAngle=0,this._screenQuaternion=new Q,this._alpha=0,this._beta=0,this._gamma=0,this.smoothFactor=0,this._onDeviceOrientationChangedObservable=new F,this._orientationChanged=()=>{this._screenOrientationAngle=window.orientation!==void 0?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,this._screenOrientationAngle=-z.ToRadians(this._screenOrientationAngle/2),this._screenQuaternion.copyFromFloats(0,Math.sin(this._screenOrientationAngle),0,Math.cos(this._screenOrientationAngle))},this._deviceOrientation=e=>{this.smoothFactor?(this._alpha=e.alpha!==null?z.SmoothAngleChange(this._alpha,e.alpha,this.smoothFactor):0,this._beta=e.beta!==null?z.SmoothAngleChange(this._beta,e.beta,this.smoothFactor):0,this._gamma=e.gamma!==null?z.SmoothAngleChange(this._gamma,e.gamma,this.smoothFactor):0):(this._alpha=e.alpha!==null?e.alpha:0,this._beta=e.beta!==null?e.beta:0,this._gamma=e.gamma!==null?e.gamma:0),e.alpha!==null&&this._onDeviceOrientationChangedObservable.notifyObservers()},this._constantTransform=new Q(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}get camera(){return this._camera}set camera(e){this._camera=e,this._camera!=null&&!this._camera.rotationQuaternion&&(this._camera.rotationQuaternion=new Q),this._camera&&this._camera.onDisposeObservable.add(()=>{this._onDeviceOrientationChangedObservable.clear()})}attachControl(){let e=this.camera.getScene().getEngine().getHostWindow();if(e){let t=()=>{e.addEventListener("orientationchange",this._orientationChanged),e.addEventListener("deviceorientation",this._deviceOrientation),this._orientationChanged()};typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(i=>{i==="granted"?t():z.Warn("Permission not granted.")}).catch(i=>{z.Error(i)}):t()}}detachControl(){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0}checkInputs(){this._alpha&&this._camera.rotationQuaternion&&(Q.RotationYawPitchRollToRef(z.ToRadians(this._alpha),z.ToRadians(this._beta),-z.ToRadians(this._gamma),this._camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTransform),this._camera.getScene().useRightHandedSystem?this._camera.rotationQuaternion.y*=-1:this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)}getClassName(){return"FreeCameraDeviceOrientationInput"}getSimpleName(){return"deviceOrientation"}};Vt.FreeCameraDeviceOrientationInput=yg;Ut.AddNodeConstructor("DeviceOrientationCamera",(n,e)=>()=>new ca(n,m.Zero(),e));var ca=class extends Bt{constructor(e,t,i){super(e,t,i),this._tmpDragQuaternion=new Q,this._disablePointerInputWhenUsingDeviceOrientation=!0,this._dragFactor=0,this._quaternionCache=new Q,this.inputs.addDeviceOrientation(),this.inputs._deviceOrientationInput&&this.inputs._deviceOrientationInput._onDeviceOrientationChangedObservable.addOnce(()=>{this._disablePointerInputWhenUsingDeviceOrientation&&this.inputs._mouseInput&&(this.inputs._mouseInput._allowCameraRotation=!1,this.inputs._mouseInput.onPointerMovedObservable.add(r=>{this._dragFactor!=0&&(this._initialQuaternion||(this._initialQuaternion=new Q),Q.FromEulerAnglesToRef(0,r.offsetX*this._dragFactor,0,this._tmpDragQuaternion),this._initialQuaternion.multiplyToRef(this._tmpDragQuaternion,this._initialQuaternion))}))})}get disablePointerInputWhenUsingDeviceOrientation(){return this._disablePointerInputWhenUsingDeviceOrientation}set disablePointerInputWhenUsingDeviceOrientation(e){this._disablePointerInputWhenUsingDeviceOrientation=e}enableHorizontalDragging(e=1/300){this._dragFactor=e}getClassName(){return"DeviceOrientationCamera"}_checkInputs(){super._checkInputs(),this.rotationQuaternion&&(this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))}resetToCurrentRotation(e=Li.Y){if(!this.rotationQuaternion)return;this._initialQuaternion||(this._initialQuaternion=new Q),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion);let t=["x","y","z"];for(let i of t)e[i]?this._initialQuaternion[i]*=-1:this._initialQuaternion[i]=0;this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}};var cc=class n{constructor(){this.compensateDistortion=!0,this.multiviewEnabled=!1}get aspectRatio(){return this.hResolution/(2*this.vResolution)}get aspectRatioFov(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))}get leftHMatrix(){let t=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return L.Translation(t,0,0)}get rightHMatrix(){let t=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return L.Translation(-t,0,0)}get leftPreViewMatrix(){return L.Translation(.5*this.interpupillaryDistance,0,0)}get rightPreViewMatrix(){return L.Translation(-.5*this.interpupillaryDistance,0,0)}static GetDefault(){let e=new n;return e.hResolution=1280,e.vResolution=800,e.hScreenSize=.149759993,e.vScreenSize=.0935999975,e.vScreenCenter=.0467999987,e.eyeToScreenDistance=.0410000011,e.lensSeparationDistance=.063500002,e.interpupillaryDistance=.064000003,e.distortionK=[1,.219999999,.239999995,0],e.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],e.postProcessScaleFactor=1.714605507808412,e.lensCenterOffset=.151976421,e}};var mh=class extends yr{getClassName(){return"VRDistortionCorrectionPostProcess"}constructor(e,t,i,r){super(e,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,r.postProcessScaleFactor,t,Z.BILINEAR_SAMPLINGMODE),this._isRightEye=i,this._distortionFactors=r.distortionK,this._postProcessScaleFactor=r.postProcessScaleFactor,this._lensCenterOffset=r.lensCenterOffset,this.adaptScaleToCurrentViewport=!0,this.onSizeChangedObservable.add(()=>{this._scaleIn=new me(2,2/this.aspectRatio),this._scaleFactor=new me(.5*(1/this._postProcessScaleFactor),.5*(1/this._postProcessScaleFactor)*this.aspectRatio),this._lensCenter=new me(this._isRightEye?.5-this._lensCenterOffset*.5:.5+this._lensCenterOffset*.5,.5)}),this.onApplyObservable.add(s=>{s.setFloat2("LensCenter",this._lensCenter.x,this._lensCenter.y),s.setFloat2("Scale",this._scaleFactor.x,this._scaleFactor.y),s.setFloat2("ScaleIn",this._scaleIn.x,this._scaleIn.y),s.setFloat4("HmdWarpParam",this._distortionFactors[0],this._distortionFactors[1],this._distortionFactors[2],this._distortionFactors[3])})}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(import("./chunk-FVXVXR73.js"))):t.push(import("./chunk-6WCIRO6M.js")),super._gatherImports(e,t)}};var zD="vrMultiviewToSingleviewPixelShader",Wk=`precision mediump sampler2DArray;varying vec2 vUV;uniform sampler2DArray multiviewSampler;uniform int imageIndex;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{gl_FragColor=texture2D(multiviewSampler,vec3(vUV,imageIndex));}`;ht.ShadersStore[zD]||(ht.ShadersStore[zD]=Wk);var ua=class extends hi{set samples(e){this._samples=e}get samples(){return this._samples}constructor(e,t=512){super("multiview rtt",t,e,!1,!0,0,!1,void 0,!1,!1,!0,void 0,!0),this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight()),this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,this.samples=this._getEngine().getCaps().maxSamples||this.samples,this._texture.samples=this._samples}_bindFrameBuffer(){this._renderTarget&&this.getScene().getEngine().bindMultiviewFramebuffer(this._renderTarget)}getViewCount(){return 2}};di.prototype.createMultiviewRenderTargetTexture=function(n,e,t,i){let r=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";let s=this._createHardwareRenderTargetWrapper(!1,!1,{width:n,height:e});s._framebuffer=r.createFramebuffer();let o=new Ta(this,0,!0);return o.width=n,o.height=e,o.isMultiview=!0,t||(t=r.createTexture(),r.bindTexture(r.TEXTURE_2D_ARRAY,t),r.texStorage3D(r.TEXTURE_2D_ARRAY,1,r.RGBA8,n,e,2)),s._colorTextureArray=t,i||(i=r.createTexture(),r.bindTexture(r.TEXTURE_2D_ARRAY,i),r.texStorage3D(r.TEXTURE_2D_ARRAY,1,r.DEPTH24_STENCIL8,n,e,2)),s._depthStencilTextureArray=i,o.isReady=!0,s.setTextures(o),s._depthStencilTexture=o,s};di.prototype.bindMultiviewFramebuffer=function(n){let e=n,t=this._gl,i=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),e._colorTextureArray&&e._depthStencilTextureArray)this.getCaps().oculusMultiview?(i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,e.samples,0,2),i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,e.samples,0,2)):(i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,0,2));else throw"Invalid multiview frame buffer"};di.prototype.bindSpaceWarpFramebuffer=function(n){let e=n,t=this._gl,i=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),e._colorTextureArray&&e._depthStencilTextureArray)i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_ATTACHMENT,e._depthStencilTextureArray,0,0,2);else throw new Error("Invalid Space Warp framebuffer")};Fe.prototype._useMultiviewToSingleView=!1;Fe.prototype._multiviewTexture=null;Fe.prototype._resizeOrCreateMultiviewTexture=function(n,e){this._multiviewTexture?(this._multiviewTexture.getRenderWidth()!=n||this._multiviewTexture.getRenderHeight()!=e)&&(this._multiviewTexture.dispose(),this._multiviewTexture=new ua(this.getScene(),{width:n,height:e})):this._multiviewTexture=new ua(this.getScene(),{width:n,height:e})};function HD(n,e,t){let i=new XT(n,void 0,!0,e,void 0,t);return i.addUniform("viewProjection",16),i.addUniform("viewProjectionR",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i}var $k=Ce.prototype.createSceneUniformBuffer;Ce.prototype._transformMatrixR=L.Zero();Ce.prototype._multiviewSceneUbo=null;Ce.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=HD(this.getEngine(),"scene_multiview")};Ce.prototype.createSceneUniformBuffer=function(n,e){return this._multiviewSceneUbo?HD(this.getEngine(),n,e):$k.bind(this)(n,e)};Ce.prototype._updateMultiviewUbo=function(n,e){n&&e&&n.multiplyToRef(e,this._transformMatrixR),n&&e&&(n.multiplyToRef(e,k.Matrix[0]),NT.GetRightPlaneToRef(k.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))};Ce.prototype._renderMultiviewToSingleView=function(n){n._resizeOrCreateMultiviewTexture(n._rigPostProcess&&n._rigPostProcess&&n._rigPostProcess.width>0?n._rigPostProcess.width:this.getEngine().getRenderWidth(!0),n._rigPostProcess&&n._rigPostProcess&&n._rigPostProcess.height>0?n._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),n.outputRenderTarget=n._multiviewTexture,this._renderForCamera(n),n.outputRenderTarget=null;for(let e=0;e<n._rigCameras.length;e++){let t=this.getEngine();this._activeCamera=n._rigCameras[e],t.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}};var vg=class extends yr{getClassName(){return"VRMultiviewToSingleviewPostProcess"}constructor(e,t,i){super(e,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],i,t,Z.BILINEAR_SAMPLINGMODE);let r=t??this.getCamera();this.onSizeChangedObservable.add(()=>{}),this.onApplyObservable.add(s=>{r._scene.activeCamera&&r._scene.activeCamera.isLeftCamera?s.setInt("imageIndex",0):s.setInt("imageIndex",1),s.setTexture("multiviewSampler",r._multiviewTexture)})}};function WD(n,e){let t=e.vrCameraMetrics||cc.GetDefault();n._rigCameras[0]._cameraRigParams.vrMetrics=t,n._rigCameras[0].viewport=new Is(0,0,.5,1),n._rigCameras[0]._cameraRigParams.vrWorkMatrix=new L,n._rigCameras[0]._cameraRigParams.vrHMatrix=t.leftHMatrix,n._rigCameras[0]._cameraRigParams.vrPreViewMatrix=t.leftPreViewMatrix,n._rigCameras[0].getProjectionMatrix=n._rigCameras[0]._getVRProjectionMatrix,n._rigCameras[1]._cameraRigParams.vrMetrics=t,n._rigCameras[1].viewport=new Is(.5,0,.5,1),n._rigCameras[1]._cameraRigParams.vrWorkMatrix=new L,n._rigCameras[1]._cameraRigParams.vrHMatrix=t.rightHMatrix,n._rigCameras[1]._cameraRigParams.vrPreViewMatrix=t.rightPreViewMatrix,n._rigCameras[1].getProjectionMatrix=n._rigCameras[1]._getVRProjectionMatrix,t.multiviewEnabled&&(n.getScene().getEngine().getCaps().multiview?(n._useMultiviewToSingleView=!0,n._rigPostProcess=new vg("VRMultiviewToSingleview",n,t.postProcessScaleFactor)):(P.Warn("Multiview is not supported, falling back to standard rendering"),t.multiviewEnabled=!1)),t.compensateDistortion&&(n._rigCameras[0]._rigPostProcess=new mh("VR_Distort_Compensation_Left",n._rigCameras[0],!1,t),n._rigCameras[1]._rigPostProcess=new mh("VR_Distort_Compensation_Right",n._rigCameras[1],!0,t))}Ut.AddNodeConstructor("VRDeviceOrientationFreeCamera",(n,e)=>()=>new gh(n,m.Zero(),e));var gh=class extends ca{constructor(e,t,i,r=!0,s=cc.GetDefault()){super(e,t,i),this._setRigMode=o=>WD(this,o),s.compensateDistortion=r,this.setCameraRigMode(Fe.RIG_MODE_VR,{vrCameraMetrics:s})}getClassName(){return"VRDeviceOrientationFreeCamera"}};var Wt=(()=>{class n{get isConnected(){return this._isConnected}constructor(t,i,r,s=0,o=1,a=2,l=3){this.id=t,this.index=i,this.browserGamepad=r,this._leftStick={x:0,y:0},this._rightStick={x:0,y:0},this._isConnected=!0,this._invertLeftStickY=!1,this.type=n.GAMEPAD,this._leftStickAxisX=s,this._leftStickAxisY=o,this._rightStickAxisX=a,this._rightStickAxisY=l,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}onleftstickchanged(t){this._onleftstickchanged=t}onrightstickchanged(t){this._onrightstickchanged=t}get leftStick(){return this._leftStick}set leftStick(t){this._onleftstickchanged&&(this._leftStick.x!==t.x||this._leftStick.y!==t.y)&&this._onleftstickchanged(t),this._leftStick=t}get rightStick(){return this._rightStick}set rightStick(t){this._onrightstickchanged&&(this._rightStick.x!==t.x||this._rightStick.y!==t.y)&&this._onrightstickchanged(t),this._rightStick=t}update(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}dispose(){}}return n.GAMEPAD=0,n.GENERIC=1,n.XBOX=2,n.POSE_ENABLED=3,n.DUALSHOCK=4,n})(),bg=class extends Wt{onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}constructor(e,t,i){super(e,t,i),this.onButtonDownObservable=new F,this.onButtonUpObservable=new F,this.type=Wt.GENERIC,this._buttons=new Array(i.buttons.length)}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()}};gD(Ce,Fe);Ce.prototype.createPickingRayToRef=function(n,e,t,i,r,s=!1,o=!1){return oh(this,n,e,t,i,r,s,o)};Ce.prototype.createPickingRayInCameraSpace=function(n,e,t){return cg(this,n,e,t)};Ce.prototype.createPickingRayInCameraSpaceToRef=function(n,e,t,i){return Xl(this,n,e,t,i)};Ce.prototype.pickWithBoundingInfo=function(n,e,t,i,r){return hD(this,n,e,t,i,r)};Ce.prototype.pick=function(n,e,t,i,r,s,o=!1){return dD(this,n,e,t,i,r,s,o)};Ce.prototype.pickWithRay=function(n,e,t,i){return fD(this,n,e,t,i)};Ce.prototype.multiPick=function(n,e,t,i,r){return pD(this,n,e,t,i,r)};Ce.prototype.multiPickWithRay=function(n,e,t){return mD(this,n,e,t)};Kg.prototype.createDynamicTexture=function(n,e,t,i){let r=new Ta(this,4);return r.baseWidth=n,r.baseHeight=e,t&&(n=this.needPOTTextures?Jr(n,this._caps.maxTextureSize):n,e=this.needPOTTextures?Jr(e,this._caps.maxTextureSize):e),r.width=n,r.height=e,r.isReady=!1,r.generateMipMaps=t,r.samplingMode=i,this.updateTextureSamplingMode(i,r),this._internalTexturesCache.push(r),r};Kg.prototype.updateDynamicTexture=function(n,e,t,i=!1,r,s=!1,o=!1){if(!n)return;let a=this._gl,l=a.TEXTURE_2D,c=this._bindTextureDirectly(l,n,!0,s);this._unpackFlipY(t===void 0?n.invertY:t),i&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);let u=this._getWebGLTextureType(n.type),h=this._getInternalFormat(r||n.format),d=this._getRGBABufferInternalSizedFormat(n.type,h);a.texImage2D(l,0,d,h,u,e),n.generateMipMaps&&a.generateMipmap(l),c||this._bindTextureDirectly(l,null),i&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),r&&(n.format=r),n._dynamicTextureSource=e,n._premulAlpha=i,n.invertY=t||!1,n.isReady=!0};var no=class n extends Z{constructor(e,t,i,r=!1,s=3,o=5,a){let l=!i||i._isScene,c=l?i:i?.scene,u=l?!r:i;super(null,c,u,a,s,void 0,void 0,void 0,void 0,o),this.name=e,this.wrapU=Z.CLAMP_ADDRESSMODE,this.wrapV=Z.CLAMP_ADDRESSMODE,this._generateMipMaps=r;let h=this._getEngine();if(!h)return;if(t.getContext)this._canvas=t,this._ownCanvas=!1,this._texture=h.createDynamicTexture(this._canvas.width,this._canvas.height,r,s);else{this._canvas=h.createCanvas(1,1),this._ownCanvas=!0;let f=t;f.width||f.width===0?this._texture=h.createDynamicTexture(f.width,f.height,r,s):this._texture=h.createDynamicTexture(t,t,r,s)}let d=this.getSize();this._canvas.width!==d.width&&(this._canvas.width=d.width),this._canvas.height!==d.height&&(this._canvas.height=d.height),this._context=this._canvas.getContext("2d")}getClassName(){return"DynamicTexture"}get canRescale(){return!0}_recreate(e){this._canvas.width=e.width,this._canvas.height=e.height,this.releaseInternalTexture(),this._texture=this._getEngine().createDynamicTexture(e.width,e.height,this._generateMipMaps,this.samplingMode)}scale(e){let t=this.getSize();t.width*=e,t.height*=e,this._recreate(t)}scaleTo(e,t){let i=this.getSize();i.width=e,i.height=t,this._recreate(i)}getContext(){return this._context}clear(e){let t=this.getSize();e&&(this._context.fillStyle=e),this._context.clearRect(0,0,t.width,t.height)}update(e,t=!1,i=!1){this._texture&&this._getEngine().updateDynamicTexture(this._texture,this._canvas,e===void 0?!0:e,t,this._format||void 0,void 0,i)}drawText(e,t,i,r,s,o,a,l=!0){let c=this.getSize();if(o&&(this._context.fillStyle=o,this._context.fillRect(0,0,c.width,c.height)),this._context.font=r,t==null){let u=this._context.measureText(e);t=(c.width-u.width)/2}if(i==null){let u=parseInt(r.replace(/\D/g,""));i=c.height/2+u/3.65}this._context.fillStyle=s||"",this._context.fillText(e,t,i),l&&this.update(a)}dispose(){super.dispose(),this._ownCanvas&&this._canvas?.remove?.(),this._canvas=null,this._context=null}clone(){let e=this.getScene();if(!e)return this;let t=this.getSize(),i=new n(this.name,t,e,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.wrapU=this.wrapU,i.wrapV=this.wrapV,i}serialize(){let e=this.getScene();e&&!e.isReady()&&P.Warn("The scene must be ready before serializing the dynamic texture");let t=super.serialize();return n._IsCanvasElement(this._canvas)&&(t.base64String=this._canvas.toDataURL()),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t}static _IsCanvasElement(e){return e.toDataURL!==void 0}_rebuild(){this.update()}};var xg=class extends Wt{constructor(e,t,i,r=!1){super(e,t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new F,this.onButtonUpObservable=new F,this.onPadDownObservable=new F,this.onPadUpObservable=new F,this._buttonA=0,this._buttonB=0,this._buttonX=0,this._buttonY=0,this._buttonBack=0,this._buttonStart=0,this._buttonLb=0,this._buttonRb=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this._isXboxOnePad=!1,this.type=Wt.XBOX,this._isXboxOnePad=r}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDpadValue(e,t,i){return e!==t&&(e===1&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),e===0&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonA(){return this._buttonA}set buttonA(e){this._buttonA=this._setButtonValue(e,this._buttonA,0)}get buttonB(){return this._buttonB}set buttonB(e){this._buttonB=this._setButtonValue(e,this._buttonB,1)}get buttonX(){return this._buttonX}set buttonX(e){this._buttonX=this._setButtonValue(e,this._buttonX,2)}get buttonY(){return this._buttonY}set buttonY(e){this._buttonY=this._setButtonValue(e,this._buttonY,3)}get buttonStart(){return this._buttonStart}set buttonStart(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,9)}get buttonBack(){return this._buttonBack}set buttonBack(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,8)}get buttonLB(){return this._buttonLb}set buttonLB(e){this._buttonLb=this._setButtonValue(e,this._buttonLb,4)}get buttonRB(){return this._buttonRb}set buttonRB(e){this._buttonRb=this._setButtonValue(e,this._buttonRb,5)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,10)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,11)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDpadValue(e,this._dPadUp,12)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDpadValue(e,this._dPadDown,13)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDpadValue(e,this._dPadLeft,14)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDpadValue(e,this._dPadRight,15)}update(){super.update(),this._isXboxOnePad?(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value):(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}};var Cg=class extends Wt{constructor(e,t,i){super(e.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new F,this.onButtonUpObservable=new F,this.onPadDownObservable=new F,this.onPadUpObservable=new F,this._buttonCross=0,this._buttonCircle=0,this._buttonSquare=0,this._buttonTriangle=0,this._buttonShare=0,this._buttonOptions=0,this._buttonL1=0,this._buttonR1=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this.type=Wt.DUALSHOCK}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDpadValue(e,t,i){return e!==t&&(e===1&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),e===0&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonCross(){return this._buttonCross}set buttonCross(e){this._buttonCross=this._setButtonValue(e,this._buttonCross,0)}get buttonCircle(){return this._buttonCircle}set buttonCircle(e){this._buttonCircle=this._setButtonValue(e,this._buttonCircle,1)}get buttonSquare(){return this._buttonSquare}set buttonSquare(e){this._buttonSquare=this._setButtonValue(e,this._buttonSquare,2)}get buttonTriangle(){return this._buttonTriangle}set buttonTriangle(e){this._buttonTriangle=this._setButtonValue(e,this._buttonTriangle,3)}get buttonOptions(){return this._buttonOptions}set buttonOptions(e){this._buttonOptions=this._setButtonValue(e,this._buttonOptions,9)}get buttonShare(){return this._buttonShare}set buttonShare(e){this._buttonShare=this._setButtonValue(e,this._buttonShare,8)}get buttonL1(){return this._buttonL1}set buttonL1(e){this._buttonL1=this._setButtonValue(e,this._buttonL1,4)}get buttonR1(){return this._buttonR1}set buttonR1(e){this._buttonR1=this._setButtonValue(e,this._buttonR1,5)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,10)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,11)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDpadValue(e,this._dPadUp,12)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDpadValue(e,this._dPadDown,13)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDpadValue(e,this._dPadLeft,14)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDpadValue(e,this._dPadRight,15)}update(){super.update(),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}};var Tg=class{constructor(e){if(this._scene=e,this._babylonGamepads=[],this._oneGamepadConnected=!1,this._isMonitoring=!1,this.onGamepadDisconnectedObservable=new F,RT()?(this._gamepadEventSupported="GamepadEvent"in window,this._gamepadSupport=navigator&&navigator.getGamepads):this._gamepadEventSupported=!1,this.onGamepadConnectedObservable=new F(t=>{for(let i in this._babylonGamepads){let r=this._babylonGamepads[i];r&&r._isConnected&&this.onGamepadConnectedObservable.notifyObserver(t,r)}}),this._onGamepadConnectedEvent=t=>{let i=t.gamepad;if(i.index in this._babylonGamepads&&this._babylonGamepads[i.index].isConnected)return;let r;this._babylonGamepads[i.index]?(r=this._babylonGamepads[i.index],r.browserGamepad=i,r._isConnected=!0):r=this._addNewGamepad(i),this.onGamepadConnectedObservable.notifyObservers(r),this._startMonitoringGamepads()},this._onGamepadDisconnectedEvent=t=>{let i=t.gamepad;for(let r in this._babylonGamepads)if(this._babylonGamepads[r].index===i.index){let s=this._babylonGamepads[r];s._isConnected=!1,this.onGamepadDisconnectedObservable.notifyObservers(s),s.dispose&&s.dispose();break}},this._gamepadSupport)if(this._updateGamepadObjects(),this._babylonGamepads.length&&this._startMonitoringGamepads(),this._gamepadEventSupported){let t=this._scene?this._scene.getEngine().getHostWindow():window;t&&(t.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),t.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,!1))}else this._startMonitoringGamepads()}get gamepads(){return this._babylonGamepads}getGamepadByType(e=Wt.XBOX){for(let t of this._babylonGamepads)if(t&&t.type===e)return t;return null}dispose(){this._gamepadEventSupported&&(this._onGamepadConnectedEvent&&window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent),this._onGamepadDisconnectedEvent&&window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent),this._onGamepadConnectedEvent=null,this._onGamepadDisconnectedEvent=null);for(let e of this._babylonGamepads)e.dispose();this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this._oneGamepadConnected=!1,this._stopMonitoringGamepads(),this._babylonGamepads=[]}_addNewGamepad(e){this._oneGamepadConnected||(this._oneGamepadConnected=!0);let t,i=e.id.search("054c")!==-1&&e.id.search("0ce6")===-1,r=e.id.search("Xbox One")!==-1;return r||e.id.search("Xbox 360")!==-1||e.id.search("xinput")!==-1||e.id.search("045e")!==-1&&e.id.search("Surface Dock")===-1?t=new xg(e.id,e.index,e,r):i?t=new Cg(e.id,e.index,e):t=new bg(e.id,e.index,e),this._babylonGamepads[t.index]=t,t}_startMonitoringGamepads(){this._isMonitoring||(this._isMonitoring=!0,this._checkGamepadsStatus())}_stopMonitoringGamepads(){this._isMonitoring=!1}_checkGamepadsStatus(){this._updateGamepadObjects();for(let e in this._babylonGamepads){let t=this._babylonGamepads[e];if(!(!t||!t.isConnected))try{t.update()}catch{this._loggedErrors.indexOf(t.index)===-1&&(z.Warn(`Error updating gamepad ${t.id}`),this._loggedErrors.push(t.index))}}this._isMonitoring&&ne.QueueNewFrame(()=>{this._checkGamepadsStatus()})}_updateGamepadObjects(){let e=navigator.getGamepads?navigator.getGamepads():[];for(let t=0;t<e.length;t++){let i=e[t];if(i)if(this._babylonGamepads[i.index])this._babylonGamepads[t].browserGamepad=i,this._babylonGamepads[t].isConnected||(this._babylonGamepads[t]._isConnected=!0,this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[t]));else{let r=this._addNewGamepad(i);this.onGamepadConnectedObservable.notifyObservers(r)}}}};var ha=class{constructor(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this.deadzoneDelta=.1,this._yAxisScale=1,this._cameraTransform=L.Identity(),this._deltaTransform=m.Zero(),this._vector3=m.Zero(),this._vector2=me.Zero()}get invertYAxis(){return this._yAxisScale!==1}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){let e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{t.type!==Wt.POSE_ENABLED&&(!this.gamepad||t.type===Wt.XBOX)&&(this.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{this.gamepad===t&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(Wt.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad&&this.gamepad.leftStick){let e=this.camera,t=this.gamepad.leftStick;this.gamepadMoveSensibility!==0&&(t.x=Math.abs(t.x)>this.deadzoneDelta?t.x/this.gamepadMoveSensibility:0,t.y=Math.abs(t.y)>this.deadzoneDelta?t.y/this.gamepadMoveSensibility:0);let i=this.gamepad.rightStick;i&&this.gamepadAngularSensibility!==0?(i.x=Math.abs(i.x)>this.deadzoneDelta?i.x/this.gamepadAngularSensibility:0,i.y=(Math.abs(i.y)>this.deadzoneDelta?i.y/this.gamepadAngularSensibility:0)*this._yAxisScale):i={x:0,y:0},e.rotationQuaternion?e.rotationQuaternion.toRotationMatrix(this._cameraTransform):L.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,this._cameraTransform);let r=e._computeLocalCameraSpeed()*50;this._vector3.copyFromFloats(t.x*r,0,-t.y*r),m.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform),e.cameraDirection.addInPlace(this._deltaTransform),this._vector2.copyFromFloats(i.y,i.x),e.cameraRotation.addInPlace(this._vector2)}}getClassName(){return"FreeCameraGamepadInput"}getSimpleName(){return"gamepad"}};w([B()],ha.prototype,"gamepadAngularSensibility",void 0);w([B()],ha.prototype,"gamepadMoveSensibility",void 0);Vt.FreeCameraGamepadInput=ha;var da=class{constructor(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40,this._yAxisScale=1}get invertYAxis(){return this._yAxisScale!==1}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){let e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{t.type!==Wt.POSE_ENABLED&&(!this.gamepad||t.type===Wt.XBOX)&&(this.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{this.gamepad===t&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(Wt.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad){let e=this.camera,t=this.gamepad.rightStick;if(t){if(t.x!=0){let r=t.x/this.gamepadRotationSensibility;r!=0&&Math.abs(r)>.005&&(e.inertialAlphaOffset+=r)}if(t.y!=0){let r=t.y/this.gamepadRotationSensibility*this._yAxisScale;r!=0&&Math.abs(r)>.005&&(e.inertialBetaOffset+=r)}}let i=this.gamepad.leftStick;if(i&&i.y!=0){let r=i.y/this.gamepadMoveSensibility;r!=0&&Math.abs(r)>.005&&(this.camera.inertialRadiusOffset-=r)}}}getClassName(){return"ArcRotateCameraGamepadInput"}getSimpleName(){return"gamepad"}};w([B()],da.prototype,"gamepadRotationSensibility",void 0);w([B()],da.prototype,"gamepadMoveSensibility",void 0);Vt.ArcRotateCameraGamepadInput=da;Object.defineProperty(Ce.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new Tg(this);let n=this._getComponent(Oe.NAME_GAMEPAD);n||(n=new hT(this),this._addComponent(n))}return this._gamepadManager},enumerable:!0,configurable:!0});Ys.prototype.addGamepad=function(){return this.add(new ha),this};lc.prototype.addGamepad=function(){return this.add(new da),this};var hT=class{constructor(e){this.name=Oe.NAME_GAMEPAD,this.scene=e}register(){}rebuild(){}dispose(){let e=this.scene._gamepadManager;e&&(e.dispose(),this.scene._gamepadManager=null)}};var uc=class{get isFixedFoveationSupported(){return this.layerType=="XRWebGLLayer"&&typeof this.layer.fixedFoveation=="number"}get fixedFoveation(){return this.isFixedFoveationSupported?this.layer.fixedFoveation:null}set fixedFoveation(e){if(this.isFixedFoveationSupported){let t=Math.max(0,Math.min(1,e||0));this.layer.fixedFoveation=t}}createRenderTargetTextureProvider(e){return this._rttWrapper=this._createRenderTargetTextureProvider(e),this._rttWrapper}dispose(){this._rttWrapper&&(this._rttWrapper.dispose(),this._rttWrapper=null)}constructor(e,t,i,r,s){this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=r,this._createRenderTargetTextureProvider=s,this._rttWrapper=null}};var hc=class{constructor(e,t){this._scene=e,this.layerWrapper=t,this._renderTargetTextures=new Array,this._engine=e.getEngine()}_createInternalTexture(e,t){let i=new Ta(this._engine,0,!0);return i.width=e.width,i.height=e.height,i._hardwareTexture=new qT(t,this._engine._gl),i.isReady=!0,i}_createRenderTargetTexture(e,t,i,r,s,o){if(!this._engine)throw new Error("Engine is disposed");let a={width:e,height:t},l=o?new ua(this._scene,a):new hi("XR renderTargetTexture",a,this._scene),c=l.renderTarget;if(c._samples=l.samples,(i||!r)&&(c._framebuffer=i),r)if(o)c._colorTextureArray=r;else{let u=this._createInternalTexture(a,r);c.setTexture(u,0),l._texture=u}return s&&(o?c._depthStencilTextureArray=s:c._depthStencilTexture=this._createInternalTexture(a,s)),l.disableRescaling(),this._renderTargetTextures.push(l),l}_destroyRenderTargetTexture(e){this._renderTargetTextures.splice(this._renderTargetTextures.indexOf(e),1),e.dispose()}getFramebufferDimensions(){return this._framebufferDimensions}dispose(){for(let e of this._renderTargetTextures)e.dispose();this._renderTargetTextures.length=0}};var dc=class extends uc{constructor(e){super(()=>e.framebufferWidth,()=>e.framebufferHeight,e,"XRWebGLLayer",t=>new dT(t.scene,this)),this.layer=e}},dT=class extends hc{constructor(e,t){super(e,t),this.layerWrapper=t,this._layer=t.layer,this._framebufferDimensions={framebufferWidth:this._layer.framebufferWidth,framebufferHeight:this._layer.framebufferHeight}}trySetViewportForView(e,t){let i=this._layer.getViewport(t);if(!i)return!1;let r=this._framebufferDimensions.framebufferWidth,s=this._framebufferDimensions.framebufferHeight;return e.x=i.x/r,e.y=i.y/s,e.width=i.width/r,e.height=i.height/s,!0}getRenderTargetTextureForEye(e){let t=this._layer.framebufferWidth,i=this._layer.framebufferHeight,r=this._layer.framebuffer;return(!this._rtt||t!==this._framebufferDimensions.framebufferWidth||i!==this._framebufferDimensions.framebufferHeight||r!==this._framebuffer)&&(this._rtt=this._createRenderTargetTexture(t,i,r),this._framebufferDimensions.framebufferWidth=t,this._framebufferDimensions.framebufferHeight=i,this._framebuffer=r),this._rtt}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e.eye)}};var _h=class n{static GetDefaults(e){let t=new n;return t.canvasOptions={antialias:!0,depth:!0,stencil:e?e.isStencilEnable:!0,alpha:!0,framebufferScaleFactor:1},t.newCanvasCssStyle="position:absolute; bottom:0px;right:0px;z-index:10;width:90%;height:100%;background-color: #000000;",t}},Sg=class{constructor(e,t=_h.GetDefaults()){if(this._options=t,this._canvas=null,this._engine=null,this.xrLayer=null,this._xrLayerWrapper=null,this.onXRLayerInitObservable=new F,this._engine=e.scene.getEngine(),this._engine.onDisposeObservable.addOnce(()=>{this._engine=null}),t.canvasElement)this._setManagedOutputCanvas(t.canvasElement);else{let i=document.createElement("canvas");i.style.cssText=this._options.newCanvasCssStyle||"position:absolute; bottom:0px;right:0px;",this._setManagedOutputCanvas(i)}e.onXRSessionInit.add(()=>{this._addCanvas()}),e.onXRSessionEnded.add(()=>{this._removeCanvas()}),this._makeCanvasCompatible()}dispose(){this._removeCanvas(),this._setManagedOutputCanvas(null),this.onXRLayerInitObservable.clear()}_makeCanvasCompatible(){this._canvasCompatiblePromise=new Promise((e,t)=>{try{this.canvasContext&&this.canvasContext.makeXRCompatible?this.canvasContext.makeXRCompatible().then(()=>{e()},()=>{z.Warn("Error executing makeXRCompatible. This does not mean that the session will work incorrectly."),e()}):e()}catch(i){t(i)}})}initializeXRLayerAsync(e){return S(this,null,function*(){let t=()=>(this.xrLayer=new XRWebGLLayer(e,this.canvasContext,this._options.canvasOptions),this._xrLayerWrapper=new dc(this.xrLayer),this.onXRLayerInitObservable.notifyObservers(this.xrLayer),this.xrLayer);return yield this._canvasCompatiblePromise.then(()=>{},()=>{}).then(()=>t())})}_addCanvas(){this._canvas&&this._engine&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.appendChild(this._canvas),this.xrLayer?this._setCanvasSize(!0):this.onXRLayerInitObservable.addOnce(()=>{this._setCanvasSize(!0)})}_removeCanvas(){this._canvas&&this._engine&&document.body.contains(this._canvas)&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.removeChild(this._canvas),this._setCanvasSize(!1)}_setCanvasSize(e=!0,t=this._xrLayerWrapper){!this._canvas||!this._engine||(e?t&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=t.getWidth()+"px",this._canvas.style.height=t.getHeight()+"px"):this._engine.setSize(t.getWidth(),t.getHeight())):this._originalCanvasSize&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=this._originalCanvasSize.width+"px",this._canvas.style.height=this._originalCanvasSize.height+"px"):this._engine.setSize(this._originalCanvasSize.width,this._originalCanvasSize.height)))}_setManagedOutputCanvas(e){this._removeCanvas(),e?(this._originalCanvasSize={width:e.offsetWidth,height:e.offsetHeight},this._canvas=e,this.canvasContext=this._canvas.getContext("webgl2"),this.canvasContext||(this.canvasContext=this._canvas.getContext("webgl"))):(this._canvas=null,this.canvasContext=null)}};var Ig=class extends uc{constructor(e){super(()=>e.framebufferWidth,()=>e.framebufferHeight,e,"XRWebGLLayer",t=>new fT(t,this)),this.layer=e}},fT=class extends hc{constructor(e,t){super(e.scene,t),this.layerWrapper=t,this._nativeRTTProvider=navigator.xr.getNativeRenderTargetProvider(e.session,this._createRenderTargetTexture.bind(this),this._destroyRenderTargetTexture.bind(this)),this._nativeLayer=t.layer}trySetViewportForView(e){return e.x=0,e.y=0,e.width=1,e.height=1,!0}getRenderTargetTextureForEye(e){return this._nativeRTTProvider.getRenderTargetForEye(e)}getRenderTargetTextureForView(e){return this._nativeRTTProvider.getRenderTargetForEye(e.eye)}getFramebufferDimensions(){return{framebufferWidth:this._nativeLayer.framebufferWidth,framebufferHeight:this._nativeLayer.framebufferHeight}}},Ag=class{constructor(e){this._nativeRenderTarget=navigator.xr.getWebXRRenderTarget(e.scene.getEngine())}initializeXRLayerAsync(e){return S(this,null,function*(){return yield this._nativeRenderTarget.initializeXRLayerAsync(e),this.xrLayer=this._nativeRenderTarget.xrLayer,this.xrLayer})}dispose(){}};var fc=class n{get worldScalingFactor(){return this._worldScalingFactor}set worldScalingFactor(e){let t=this._worldScalingFactor;this._worldScalingFactor=e,this.onWorldScaleFactorChangedObservable.notifyObservers({previousScaleFactor:t,newScaleFactor:e})}constructor(e){this.scene=e,this.currentTimestamp=-1,this.defaultHeightCompensation=1.7,this.onXRFrameObservable=new F,this.onXRReferenceSpaceChanged=new F,this.onXRSessionEnded=new F,this.onXRSessionInit=new F,this.onXRReferenceSpaceInitialized=new F,this.onXRReady=new F,this.inXRFrameLoop=!1,this.inXRSession=!1,this._worldScalingFactor=1,this.onWorldScaleFactorChangedObservable=new F(void 0,!0),this._engine=e.getEngine(),this._onEngineDisposedObserver=this._engine.onDisposeObservable.addOnce(()=>{this._engine=null}),e.onDisposeObservable.addOnce(()=>{this.dispose()}),this.onXRSessionEnded.add(()=>{e.cameraToUseForPointers=null})}get referenceSpace(){return this._referenceSpace}set referenceSpace(e){this._referenceSpace=e,this.onXRReferenceSpaceChanged.notifyObservers(this._referenceSpace)}get sessionMode(){return this._sessionMode}dispose(){this.inXRSession&&this.exitXRAsync(),this.onXRReady.clear(),this.onXRFrameObservable.clear(),this.onXRSessionEnded.clear(),this.onXRReferenceSpaceChanged.clear(),this.onXRSessionInit.clear(),this.onWorldScaleFactorChangedObservable.clear(),this._engine?.onDisposeObservable.remove(this._onEngineDisposedObserver),this._engine=null}exitXRAsync(){return S(this,null,function*(){if(this.session&&this.inXRSession){this.inXRSession=!1;try{return yield this.session.end()}catch{P.Warn("Could not end XR session.")}}})}trySetViewportForView(e,t){return this._baseLayerRTTProvider?.trySetViewportForView(e,t)||!1}getRenderTargetTextureForEye(e){return this._baseLayerRTTProvider?.getRenderTargetTextureForEye(e)||null}getRenderTargetTextureForView(e){return this._baseLayerRTTProvider?.getRenderTargetTextureForView(e)||null}getWebXRRenderTarget(e){let t=this.scene.getEngine();return this._xrNavigator.xr.native?new Ag(this):(e=e||_h.GetDefaults(t),e.canvasElement=e.canvasElement||t.getRenderingCanvas()||void 0,new Sg(this,e))}initializeAsync(){return S(this,null,function*(){if(this._xrNavigator=navigator,!this._xrNavigator.xr)throw new Error("WebXR not supported on this browser.")})}initializeSessionAsync(){return S(this,arguments,function*(e="immersive-vr",t={}){let i=yield this._xrNavigator.xr.requestSession(e,t);return this.session=i,this._sessionMode=e,this.inXRSession=!0,this.onXRSessionInit.notifyObservers(i),this.session.addEventListener("end",()=>{this.inXRSession=!1,this.onXRSessionEnded.notifyObservers(null),this._engine&&(this._engine.framebufferDimensionsObject=null,this._engine.restoreDefaultFramebuffer(),this._engine.customAnimationFrameRequester=null,this._engine._renderLoop()),this.isNative&&this._baseLayerRTTProvider?.dispose(),this._baseLayerRTTProvider=null,this._baseLayerWrapper=null},{once:!0}),this.session})}isSessionSupportedAsync(e){return S(this,null,function*(){return yield n.IsSessionSupportedAsync(e)})}resetReferenceSpace(){this.referenceSpace=this.baseReferenceSpace}runXRRenderLoop(){!this.inXRSession||!this._engine||(this._engine.customAnimationFrameRequester={requestAnimationFrame:e=>this.session.requestAnimationFrame(e),renderFunction:(e,t)=>{if(!(!this.inXRSession||!this._engine)&&(this.currentFrame=t,this.currentTimestamp=e,t)){this.inXRFrameLoop=!0;let i=this._baseLayerRTTProvider?.getFramebufferDimensions()||null;this._engine.framebufferDimensionsObject!==i&&(this._engine.framebufferDimensionsObject=i),this.onXRFrameObservable.notifyObservers(t),this._engine._renderLoop(),this._engine.framebufferDimensionsObject=null,this.inXRFrameLoop=!1}}},this._engine.framebufferDimensionsObject=this._baseLayerRTTProvider?.getFramebufferDimensions()||null,this.onXRFrameObservable.addOnce(()=>{this.onXRReady.notifyObservers(this)}),typeof window<"u"&&window.cancelAnimationFrame&&window.cancelAnimationFrame(this._engine._frameHandler),this._engine._renderLoop())}setReferenceSpaceTypeAsync(e="local-floor"){return S(this,null,function*(){let t;try{t=yield this.session.requestReferenceSpace(e)}catch(r){P.Error("XR.requestReferenceSpace failed for the following reason: "),P.Error(r),P.Log('Defaulting to universally-supported "viewer" reference space type.');try{let s=yield this.session.requestReferenceSpace("viewer"),o=new XRRigidTransform({x:0,y:-this.defaultHeightCompensation,z:0});return s.getOffsetReferenceSpace(o)}catch(s){throw P.Error(s),'XR initialization failed: required "viewer" reference space type not supported.'}}let i=yield this.session.requestReferenceSpace("viewer");return this.viewerReferenceSpace=i,this.referenceSpace=this.baseReferenceSpace=t,this.onXRReferenceSpaceInitialized.notifyObservers(t),this.referenceSpace})}updateRenderStateAsync(e){return S(this,null,function*(){return yield this.session.updateRenderState(e)})}_setBaseLayerWrapper(e){this.isNative&&this._baseLayerRTTProvider?.dispose(),this._baseLayerWrapper=e,this._baseLayerRTTProvider=this._baseLayerWrapper?.createRenderTargetTextureProvider(this)||null}_getBaseLayerWrapper(){return this._baseLayerWrapper}updateRenderState(e){e.baseLayer&&this._setBaseLayerWrapper(this.isNative?new Ig(e.baseLayer):new dc(e.baseLayer)),this.session.updateRenderState(e)}static IsSessionSupportedAsync(e){return S(this,null,function*(){if(!navigator.xr)return!1;let t=navigator.xr.isSessionSupported||navigator.xr.supportsSession;if(t)try{let i=t.call(navigator.xr,e);return typeof i>"u"?!0:i}catch(i){return P.Warn(i),!1}else return!1})}get isNative(){return this._xrNavigator.xr.native??!1}get currentFrameRate(){return this.session?.frameRate}get supportedFrameRates(){return this.session?.supportedFrameRates}updateTargetFrameRate(e){return S(this,null,function*(){return yield this.session.updateTargetFrameRate(e)})}runInXRFrame(e,t=!0){this.inXRFrameLoop?e():(this.inXRSession||!t)&&this.onXRFrameObservable.addOnce(e)}get isFixedFoveationSupported(){return this._baseLayerWrapper?.isFixedFoveationSupported||!1}get fixedFoveation(){return this._baseLayerWrapper?.fixedFoveation||null}set fixedFoveation(e){let t=Math.max(0,Math.min(1,e||0));this._baseLayerWrapper&&(this._baseLayerWrapper.fixedFoveation=t)}get enabledFeatures(){return this.session?.enabledFeatures??null}};var jk=(()=>{class n{constructor(t,i=null){if(this.scene=t,this._pointerDownOnMeshAsked=!1,this._isActionableMesh=!1,this._teleportationRequestInitiated=!1,this._teleportationBackRequestInitiated=!1,this._rotationRightAsked=!1,this._rotationLeftAsked=!1,this._dpadPressed=!0,this._activePointer=!1,this._id=n._IdCounter++,i)this._gazeTracker=i.clone("gazeTracker");else{this._gazeTracker=pr("gazeTracker",{diameter:.0035,thickness:.0025,tessellation:20,updatable:!1},t),this._gazeTracker.bakeCurrentTransformIntoVertices(),this._gazeTracker.isPickable=!1,this._gazeTracker.isVisible=!1;let r=new te("targetMat",t);r.specularColor=U.Black(),r.emissiveColor=new U(.7,.7,.7),r.backFaceCulling=!1,this._gazeTracker.material=r}}_getForwardRay(t){return new rt(m.Zero(),new m(0,0,t))}_selectionPointerDown(){this._pointerDownOnMeshAsked=!0,this._currentHit&&this.scene.simulatePointerDown(this._currentHit,{pointerId:this._id})}_selectionPointerUp(){this._currentHit&&this.scene.simulatePointerUp(this._currentHit,{pointerId:this._id}),this._pointerDownOnMeshAsked=!1}_activatePointer(){this._activePointer=!0}_deactivatePointer(){this._activePointer=!1}_updatePointerDistance(t=100){}dispose(){this._interactionsEnabled=!1,this._teleportationEnabled=!1,this._gazeTracker&&this._gazeTracker.dispose()}}return n._IdCounter=0,n})(),Eg=class extends jk{constructor(e,t){super(t),this._getCamera=e}_getForwardRay(e){let t=this._getCamera();return t?t.getForwardRay(e):new rt(m.Zero(),m.Forward())}};var $D=(()=>{class n{get onEnteringVR(){return this.onEnteringVRObservable}get onExitingVR(){return this.onExitingVRObservable}get teleportationTarget(){return this._teleportationTarget}set teleportationTarget(t){t&&(t.name="teleportationTarget",this._isDefaultTeleportationTarget=!1,this._teleportationTarget=t)}get gazeTrackerMesh(){return this._cameraGazer._gazeTracker}set gazeTrackerMesh(t){t&&(this._cameraGazer._gazeTracker&&this._cameraGazer._gazeTracker.dispose(),this._cameraGazer._gazeTracker=t,this._cameraGazer._gazeTracker.bakeCurrentTransformIntoVertices(),this._cameraGazer._gazeTracker.isPickable=!1,this._cameraGazer._gazeTracker.isVisible=!1,this._cameraGazer._gazeTracker.name="gazeTracker")}get displayGaze(){return this._displayGaze}set displayGaze(t){this._displayGaze=t,t||(this._cameraGazer._gazeTracker.isVisible=!1)}get displayLaserPointer(){return this._displayLaserPointer}set displayLaserPointer(t){this._displayLaserPointer=t}get deviceOrientationCamera(){return this._deviceOrientationCamera}get currentVRCamera(){return this._scene.activeCamera}get vrDeviceOrientationCamera(){return this._vrDeviceOrientationCamera}get vrButton(){return this._btnVR}get _teleportationRequestInitiated(){return this._cameraGazer._teleportationRequestInitiated}constructor(t,i={}){if(this.webVROptions=i,this._fullscreenVRpresenting=!1,this.enableGazeEvenWhenNoPointerLock=!1,this.exitVROnDoubleTap=!0,this.onEnteringVRObservable=new F,this.onAfterEnteringVRObservable=new F,this.onExitingVRObservable=new F,this._useCustomVRButton=!1,this._teleportActive=!1,this._floorMeshesCollection=[],this._teleportationMode=n.TELEPORTATIONMODE_CONSTANTTIME,this._teleportationTime=122,this._teleportationSpeed=20,this._rotationAllowed=!0,this._teleportBackwardsVector=new m(0,-1,-1),this._isDefaultTeleportationTarget=!0,this._teleportationFillColor="#444444",this._teleportationBorderColor="#FFFFFF",this._rotationAngle=0,this._haloCenter=new m(0,0,0),this._padSensibilityUp=.65,this._padSensibilityDown=.35,this._pickedLaserColor=new U(.2,.2,1),this._pickedGazeColor=new U(0,0,1),this.onNewMeshSelected=new F,this.onNewMeshPicked=new F,this.onBeforeCameraTeleport=new F,this.onAfterCameraTeleport=new F,this.onSelectedMeshUnselected=new F,this.teleportationEnabled=!0,this._teleportationInitialized=!1,this._interactionsEnabled=!1,this._displayGaze=!0,this._displayLaserPointer=!0,this.updateGazeTrackerScale=!0,this.updateGazeTrackerColor=!0,this.updateControllerLaserColor=!0,this.requestPointerLockOnFullScreen=!0,this.xrTestDone=!1,this._onResize=()=>{this._moveButtonToBottomRight()},this._onFullscreenChange=()=>{this._fullscreenVRpresenting=!!document.fullscreenElement,!this._fullscreenVRpresenting&&this._inputElement&&(this.exitVR(),!this._useCustomVRButton&&this._btnVR&&(this._btnVR.style.top=this._inputElement.offsetTop+this._inputElement.offsetHeight-70+"px",this._btnVR.style.left=this._inputElement.offsetLeft+this._inputElement.offsetWidth-100+"px",this._updateButtonVisibility()))},this._cachedAngularSensibility={angularSensibilityX:null,angularSensibilityY:null,angularSensibility:null},this._beforeRender=()=>{this._scene.getEngine().isPointerLock||this.enableGazeEvenWhenNoPointerLock||(this._cameraGazer._gazeTracker.isVisible=!1)},this._onNewGamepadConnected=s=>{s.type!==Wt.POSE_ENABLED&&(s.leftStick&&s.onleftstickchanged(o=>{this._teleportationInitialized&&this.teleportationEnabled&&(this._checkTeleportWithRay(o,this._cameraGazer),this._checkTeleportBackwards(o,this._cameraGazer))}),s.rightStick&&s.onrightstickchanged(o=>{this._teleportationInitialized&&this._checkRotate(o,this._cameraGazer)}),s.type===Wt.XBOX&&(s.onbuttondown(o=>{this._interactionsEnabled&&o===0&&this._cameraGazer._selectionPointerDown()}),s.onbuttonup(o=>{this._interactionsEnabled&&o===0&&this._cameraGazer._selectionPointerUp()})))},this._workingVector=m.Zero(),this._workingQuaternion=Q.Identity(),this._workingMatrix=L.Identity(),P.Warn("WebVR is deprecated. Please avoid using this experience helper and use the WebXR experience helper instead"),this._scene=t,this._inputElement=t.getEngine().getInputElement(),!("getVRDisplays"in navigator)&&i.useXR===void 0&&(i.useXR=!0),i.createFallbackVRDeviceOrientationFreeCamera===void 0&&(i.createFallbackVRDeviceOrientationFreeCamera=!0),i.createDeviceOrientationCamera===void 0&&(i.createDeviceOrientationCamera=!0),i.laserToggle===void 0&&(i.laserToggle=!0),this._hasEnteredVR=!1,this._scene.activeCamera?this._position=this._scene.activeCamera.position.clone():this._position=new m(0,this._defaultHeight,0),i.createDeviceOrientationCamera||!this._scene.activeCamera){if(this._deviceOrientationCamera=new ca("deviceOrientationVRHelper",this._position.clone(),t),this._scene.activeCamera&&(this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ,this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ,this._scene.activeCamera instanceof gi&&this._scene.activeCamera.rotation)){let s=this._scene.activeCamera;s.rotationQuaternion?this._deviceOrientationCamera.rotationQuaternion?.copyFrom(s.rotationQuaternion):this._deviceOrientationCamera.rotationQuaternion?.copyFrom(Q.RotationYawPitchRoll(s.rotation.y,s.rotation.x,s.rotation.z)),this._deviceOrientationCamera.rotation=s.rotation.clone()}this._scene.activeCamera=this._deviceOrientationCamera,this._inputElement&&this._scene.activeCamera.attachControl()}else this._existingCamera=this._scene.activeCamera;this.webVROptions.useXR&&navigator.xr?fc.IsSessionSupportedAsync("immersive-vr").then(s=>{s?(P.Log("Using WebXR. It is recommended to use the WebXRDefaultExperience directly"),t.createDefaultXRExperienceAsync({floorMeshes:i.floorMeshes||[]}).then(o=>{this.xr=o,this.xrTestDone=!0,this._cameraGazer=new Eg(()=>this.xr.baseExperience.camera,t),this.xr.baseExperience.onStateChangedObservable.add(a=>{switch(a){case 0:this.onEnteringVRObservable.notifyObservers(this),this._interactionsEnabled||this.xr.pointerSelection.detach(),this.xr.pointerSelection.displayLaserPointer=this._displayLaserPointer;break;case 1:this.onExitingVRObservable.notifyObservers(this),this._scene.getEngine().resize();break;case 2:this._hasEnteredVR=!0;break;case 3:this._hasEnteredVR=!1;break}})})):this._completeVRInit(t,i)}):this._completeVRInit(t,i)}_completeVRInit(t,i){if(this.xrTestDone=!0,i.createFallbackVRDeviceOrientationFreeCamera&&(this._vrDeviceOrientationCamera=new gh("VRDeviceOrientationVRHelper",this._position,this._scene,!0,i.vrDeviceOrientationCameraMetrics),this._vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._cameraGazer=new Eg(()=>this.currentVRCamera,t),!this._useCustomVRButton){this._btnVR=document.createElement("BUTTON"),this._btnVR.className="babylonVRicon",this._btnVR.id="babylonVRiconbtn",this._btnVR.title="Click to switch to VR";let o=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A":"https://cdn.babylonjs.com/Assets/vrButton.png")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";o+=".babylonVRicon.vrdisplaypresenting { display: none; }";let a=document.createElement("style");a.appendChild(document.createTextNode(o)),document.getElementsByTagName("head")[0].appendChild(a),this._moveButtonToBottomRight()}this._btnVR&&this._btnVR.addEventListener("click",()=>{this.isInVRMode||this.enterVR()});let r=this._scene.getEngine().getHostWindow();r&&(r.addEventListener("resize",this._onResize),document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),i.createFallbackVRDeviceOrientationFreeCamera&&this._displayVRButton(),this._onKeyDown=s=>{s.keyCode===27&&this.isInVRMode&&this.exitVR()},document.addEventListener("keydown",this._onKeyDown),this._scene.onPrePointerObservable.add(()=>{this._hasEnteredVR&&this.exitVROnDoubleTap&&(this.exitVR(),this._fullscreenVRpresenting&&this._scene.getEngine().exitFullscreen())},Ee.POINTERDOUBLETAP,!1),t.onDisposeObservable.add(()=>{this.dispose()}),this._updateButtonVisibility(),this._circleEase=new I0,this._circleEase.setEasingMode(Qi.EASINGMODE_EASEINOUT),this._teleportationEasing=this._circleEase,t.onPointerObservable.add(s=>{this._interactionsEnabled&&t.activeCamera===this.vrDeviceOrientationCamera&&s.event.pointerType==="mouse"&&(s.type===Ee.POINTERDOWN?this._cameraGazer._selectionPointerDown():s.type===Ee.POINTERUP&&this._cameraGazer._selectionPointerUp())}),this.webVROptions.floorMeshes&&this.enableTeleportation({floorMeshes:this.webVROptions.floorMeshes}))}get isInVRMode(){return this.xr&&this.webVROptions.useXR&&this.xr.baseExperience.state===2||this._fullscreenVRpresenting}_moveButtonToBottomRight(){if(this._inputElement&&!this._useCustomVRButton&&this._btnVR){let t=this._inputElement.getBoundingClientRect();this._btnVR.style.top=t.top+t.height-70+"px",this._btnVR.style.left=t.left+t.width-100+"px"}}_displayVRButton(){!this._useCustomVRButton&&!this._btnVRDisplayed&&this._btnVR&&(document.body.appendChild(this._btnVR),this._btnVRDisplayed=!0)}_updateButtonVisibility(){!this._btnVR||this._useCustomVRButton||(this._btnVR.className="babylonVRicon",this.isInVRMode&&(this._btnVR.className+=" vrdisplaypresenting"))}enterVR(){if(this.xr){this.xr.baseExperience.enterXRAsync("immersive-vr","local-floor",this.xr.renderTarget);return}if(this.onEnteringVRObservable)try{this.onEnteringVRObservable.notifyObservers(this)}catch(t){P.Warn("Error in your custom logic onEnteringVR: "+t)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone(),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.rotation=Q.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles(),this.vrDeviceOrientationCamera.angularSensibility=2e3),this._existingCamera=this._scene.activeCamera,this._existingCamera.angularSensibilityX&&(this._cachedAngularSensibility.angularSensibilityX=this._existingCamera.angularSensibilityX,this._existingCamera.angularSensibilityX=Number.MAX_VALUE),this._existingCamera.angularSensibilityY&&(this._cachedAngularSensibility.angularSensibilityY=this._existingCamera.angularSensibilityY,this._existingCamera.angularSensibilityY=Number.MAX_VALUE),this._existingCamera.angularSensibility&&(this._cachedAngularSensibility.angularSensibility=this._existingCamera.angularSensibility,this._existingCamera.angularSensibility=Number.MAX_VALUE)),this._vrDeviceOrientationCamera&&(this._vrDeviceOrientationCamera.position=this._position,this._scene.activeCamera&&(this._vrDeviceOrientationCamera.minZ=this._scene.activeCamera.minZ),this._scene.activeCamera=this._vrDeviceOrientationCamera,this._scene.getEngine().enterFullscreen(this.requestPointerLockOnFullScreen),this._updateButtonVisibility(),this._vrDeviceOrientationCamera.onViewMatrixChangedObservable.addOnce(()=>{this.onAfterEnteringVRObservable.notifyObservers({success:!0})})),this._scene.activeCamera&&this._inputElement&&this._scene.activeCamera.attachControl(),this._interactionsEnabled&&this._scene.registerBeforeRender(this._beforeRender),this._hasEnteredVR=!0}exitVR(){if(this.xr){this.xr.baseExperience.exitXRAsync();return}if(this._hasEnteredVR){if(this.onExitingVRObservable)try{this.onExitingVRObservable.notifyObservers(this)}catch(t){P.Warn("Error in your custom logic onExitingVR: "+t)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone()),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._deviceOrientationCamera?(this._deviceOrientationCamera.position=this._position,this._scene.activeCamera=this._deviceOrientationCamera,this._cachedAngularSensibility.angularSensibilityX&&(this._deviceOrientationCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._deviceOrientationCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._deviceOrientationCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)):this._existingCamera&&(this._existingCamera.position=this._position,this._scene.activeCamera=this._existingCamera,this._inputElement&&this._scene.activeCamera.attachControl(),this._cachedAngularSensibility.angularSensibilityX&&(this._existingCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._existingCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._existingCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)),this._updateButtonVisibility(),this._interactionsEnabled&&(this._scene.unregisterBeforeRender(this._beforeRender),this._cameraGazer._gazeTracker.isVisible=!1),this._scene.getEngine().resize(),this._hasEnteredVR=!1}}get position(){return this._position}set position(t){this._position=t,this._scene.activeCamera&&(this._scene.activeCamera.position=t)}enableInteractions(){if(!this._interactionsEnabled){if(this.xr){this.xr.baseExperience.state===2&&this.xr.pointerSelection.attach();return}this.raySelectionPredicate=t=>t.isVisible&&(t.isPickable||t.name===this._floorMeshName),this.meshSelectionPredicate=()=>!0,this._raySelectionPredicate=t=>this._isTeleportationFloor(t)||t.name.indexOf("gazeTracker")===-1&&t.name.indexOf("teleportationTarget")===-1&&t.name.indexOf("torusTeleportation")===-1?this.raySelectionPredicate(t):!1,this._interactionsEnabled=!0}}_isTeleportationFloor(t){for(let i=0;i<this._floorMeshesCollection.length;i++)if(this._floorMeshesCollection[i].id===t.id)return!0;return!!(this._floorMeshName&&t.name===this._floorMeshName)}addFloorMesh(t){this._floorMeshesCollection&&(this._floorMeshesCollection.indexOf(t)>-1||this._floorMeshesCollection.push(t))}removeFloorMesh(t){if(!this._floorMeshesCollection)return;let i=this._floorMeshesCollection.indexOf(t);i!==-1&&this._floorMeshesCollection.splice(i,1)}enableTeleportation(t={}){if(!this._teleportationInitialized){if(this.enableInteractions(),this.webVROptions.useXR&&(t.floorMeshes||t.floorMeshName)){let r=t.floorMeshes||[];if(!r.length){let s=this._scene.getMeshByName(t.floorMeshName);s&&r.push(s)}if(this.xr){for(let s of r)this.xr.teleportation.addFloorMesh(s);this.xr.teleportation.attached||this.xr.teleportation.attach();return}else if(!this.xrTestDone){let s=()=>{this.xrTestDone&&(this._scene.unregisterBeforeRender(s),this.xr?this.xr.teleportation.attached||this.xr.teleportation.attach():this.enableTeleportation(t))};this._scene.registerBeforeRender(s);return}}t.floorMeshName&&(this._floorMeshName=t.floorMeshName),t.floorMeshes&&(this._floorMeshesCollection=t.floorMeshes),t.teleportationMode&&(this._teleportationMode=t.teleportationMode),t.teleportationTime&&t.teleportationTime>0&&(this._teleportationTime=t.teleportationTime),t.teleportationSpeed&&t.teleportationSpeed>0&&(this._teleportationSpeed=t.teleportationSpeed),t.easingFunction!==void 0&&(this._teleportationEasing=t.easingFunction);let i=new gn;i.vignetteColor=new ce(0,0,0,0),i.vignetteEnabled=!0,this._teleportationInitialized=!0,this._isDefaultTeleportationTarget&&this._createTeleportationCircles()}}_checkTeleportWithRay(t,i){this._teleportationRequestInitiated&&!i._teleportationRequestInitiated||(i._teleportationRequestInitiated?Math.sqrt(t.y*t.y+t.x*t.x)<this._padSensibilityDown&&(this._teleportActive&&this.teleportCamera(this._haloCenter),i._teleportationRequestInitiated=!1):t.y<-this._padSensibilityUp&&i._dpadPressed&&(i._activatePointer(),i._teleportationRequestInitiated=!0))}_checkRotate(t,i){i._teleportationRequestInitiated||(i._rotationLeftAsked?t.x>-this._padSensibilityDown&&(i._rotationLeftAsked=!1):t.x<-this._padSensibilityUp&&i._dpadPressed&&(i._rotationLeftAsked=!0,this._rotationAllowed&&this._rotateCamera(!1)),i._rotationRightAsked?t.x<this._padSensibilityDown&&(i._rotationRightAsked=!1):t.x>this._padSensibilityUp&&i._dpadPressed&&(i._rotationRightAsked=!0,this._rotationAllowed&&this._rotateCamera(!0)))}_checkTeleportBackwards(t,i){if(!i._teleportationRequestInitiated)if(t.y>this._padSensibilityUp&&i._dpadPressed){if(!i._teleportationBackRequestInitiated){if(!this.currentVRCamera)return;let r=Q.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix()),s=this.currentVRCamera.position;r.toEulerAnglesToRef(this._workingVector),this._workingVector.z=0,this._workingVector.x=0,Q.RotationYawPitchRollToRef(this._workingVector.y,this._workingVector.x,this._workingVector.z,this._workingQuaternion),this._workingQuaternion.toRotationMatrix(this._workingMatrix),m.TransformCoordinatesToRef(this._teleportBackwardsVector,this._workingMatrix,this._workingVector);let o=new rt(s,this._workingVector),a=this._scene.pickWithRay(o,this._raySelectionPredicate);a&&a.pickedPoint&&a.pickedMesh&&this._isTeleportationFloor(a.pickedMesh)&&a.distance<5&&this.teleportCamera(a.pickedPoint),i._teleportationBackRequestInitiated=!0}}else i._teleportationBackRequestInitiated=!1}_createTeleportationCircles(){this._teleportationTarget=sa("teleportationTarget",{width:2,height:2,subdivisions:2},this._scene),this._teleportationTarget.isPickable=!1;let t=512,i=new no("DynamicTexture",t,this._scene,!0);i.hasAlpha=!0;let r=i.getContext(),s=t/2,o=t/2,a=200;r.beginPath(),r.arc(s,o,a,0,2*Math.PI,!1),r.fillStyle=this._teleportationFillColor,r.fill(),r.lineWidth=10,r.strokeStyle=this._teleportationBorderColor,r.stroke(),r.closePath(),i.update();let l=new te("TextPlaneMaterial",this._scene);l.diffuseTexture=i,this._teleportationTarget.material=l;let c=pr("torusTeleportation",{diameter:.75,thickness:.1,tessellation:25,updatable:!1},this._scene);c.isPickable=!1,c.parent=this._teleportationTarget;let u=new H("animationInnerCircle","position.y",30,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CYCLE),h=[];h.push({frame:0,value:0}),h.push({frame:30,value:.4}),h.push({frame:60,value:0}),u.setKeys(h);let d=new rd;d.setEasingMode(Qi.EASINGMODE_EASEINOUT),u.setEasingFunction(d),c.animations=[],c.animations.push(u),this._scene.beginAnimation(c,0,60,!0),this._hideTeleportationTarget()}_hideTeleportationTarget(){this._teleportActive=!1,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!1,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!1))}_rotateCamera(t){if(!(this.currentVRCamera instanceof Bt))return;t?this._rotationAngle++:this._rotationAngle--,this.currentVRCamera.animations=[];let i=Q.FromRotationMatrix(L.RotationY(Math.PI/4*this._rotationAngle)),r=new H("animationRotation","rotationQuaternion",90,H.ANIMATIONTYPE_QUATERNION,H.ANIMATIONLOOPMODE_CONSTANT),s=[];s.push({frame:0,value:this.currentVRCamera.rotationQuaternion}),s.push({frame:6,value:i}),r.setKeys(s),r.setEasingFunction(this._circleEase),this.currentVRCamera.animations.push(r),this._postProcessMove.animations=[];let o=new H("animationPP","vignetteWeight",90,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CONSTANT),a=[];a.push({frame:0,value:0}),a.push({frame:3,value:4}),a.push({frame:6,value:0}),o.setKeys(a),o.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(o);let l=new H("animationPP2","vignetteStretch",90,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CONSTANT),c=[];c.push({frame:0,value:0}),c.push({frame:3,value:10}),c.push({frame:6,value:0}),l.setKeys(c),l.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(l),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._postProcessMove.samples=4,this._scene.beginAnimation(this.currentVRCamera,0,6,!1,1)}teleportCamera(t){if(!(this.currentVRCamera instanceof Bt))return;this._workingVector.copyFrom(t),this.isInVRMode||(this._workingVector.y+=this._defaultHeight),this.onBeforeCameraTeleport.notifyObservers(this._workingVector);let i=90,r,s;if(this._teleportationMode==n.TELEPORTATIONMODE_CONSTANTSPEED){s=i;let f=m.Distance(this.currentVRCamera.position,this._workingVector);r=this._teleportationSpeed/f}else s=Math.round(this._teleportationTime*i/1e3),r=1;this.currentVRCamera.animations=[];let o=new H("animationCameraTeleportation","position",i,H.ANIMATIONTYPE_VECTOR3,H.ANIMATIONLOOPMODE_CONSTANT),a=[{frame:0,value:this.currentVRCamera.position},{frame:s,value:this._workingVector}];o.setKeys(a),o.setEasingFunction(this._teleportationEasing),this.currentVRCamera.animations.push(o),this._postProcessMove.animations=[];let l=Math.round(s/2),c=new H("animationPP","vignetteWeight",i,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CONSTANT),u=[];u.push({frame:0,value:0}),u.push({frame:l,value:8}),u.push({frame:s,value:0}),c.setKeys(u),this._postProcessMove.animations.push(c);let h=new H("animationPP2","vignetteStretch",i,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CONSTANT),d=[];d.push({frame:0,value:0}),d.push({frame:l,value:10}),d.push({frame:s,value:0}),h.setKeys(d),this._postProcessMove.animations.push(h),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._scene.beginAnimation(this.currentVRCamera,0,s,!1,r,()=>{this.onAfterCameraTeleport.notifyObservers(this._workingVector)}),this._hideTeleportationTarget()}setLaserColor(t,i=this._pickedLaserColor){this._pickedLaserColor=i}setLaserLightingState(t=!0){}setGazeColor(t,i=this._pickedGazeColor){this._pickedGazeColor=i}changeLaserColor(t){this.updateControllerLaserColor}changeGazeColor(t){this.updateGazeTrackerColor&&this._cameraGazer._gazeTracker.material&&(this._cameraGazer._gazeTracker.material.emissiveColor=t)}dispose(){this.isInVRMode&&this.exitVR(),this._postProcessMove&&this._postProcessMove.dispose(),this._vrDeviceOrientationCamera&&this._vrDeviceOrientationCamera.dispose(),!this._useCustomVRButton&&this._btnVR&&this._btnVR.parentNode&&document.body.removeChild(this._btnVR),this._deviceOrientationCamera&&this._scene.activeCamera!=this._deviceOrientationCamera&&this._deviceOrientationCamera.dispose(),this._cameraGazer&&this._cameraGazer.dispose(),this._teleportationTarget&&this._teleportationTarget.dispose(),this.xr&&this.xr.dispose(),this._floorMeshesCollection.length=0,document.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),window.removeEventListener("resize",this._onResize),document.removeEventListener("fullscreenchange",this._onFullscreenChange),this._scene.gamepadManager.onGamepadConnectedObservable.removeCallback(this._onNewGamepadConnected),this._scene.unregisterBeforeRender(this._beforeRender)}getClassName(){return"VRExperienceHelper"}}return n.TELEPORTATIONMODE_CONSTANTTIME=0,n.TELEPORTATIONMODE_CONSTANTSPEED=1,n})();var yh=class n extends Bt{constructor(e,t,i){super(e,m.Zero(),t),this._xrSessionManager=i,this._firstFrame=!1,this._referenceQuaternion=Q.Identity(),this._referencedPosition=new m,this._trackingState=0,this.onXRCameraInitializedObservable=new F,this.onBeforeCameraTeleport=new F,this.onAfterCameraTeleport=new F,this.onTrackingStateChanged=new F,this.compensateOnFirstFrame=!0,this.minZ=.1,this.rotationQuaternion=new Q,this.cameraRigMode=Fe.RIG_MODE_CUSTOM,this.updateUpVectorFromRotation=!0,this._updateNumberOfRigCameras(1),this.freezeProjectionMatrix(),this._deferOnly=!0,this._xrSessionManager.onXRSessionInit.add(()=>{this._referencedPosition.copyFromFloats(0,0,0),this._referenceQuaternion.copyFromFloats(0,0,0,1),this._firstFrame=this.compensateOnFirstFrame,this._xrSessionManager.onWorldScaleFactorChangedObservable.add(()=>{this._xrSessionManager.currentFrame&&this._updateDepthNearFar()})}),this._xrSessionManager.onXRFrameObservable.add(()=>{this._firstFrame&&this._updateFromXRSession(),this.onXRCameraInitializedObservable.hasObservers()&&(this.onXRCameraInitializedObservable.notifyObservers(this),this.onXRCameraInitializedObservable.clear()),this._deferredUpdated&&(this.position.copyFrom(this._deferredPositionUpdate),this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate)),this._updateReferenceSpace(),this._updateFromXRSession()},void 0,!0)}get trackingState(){return this._trackingState}_setTrackingState(e){this._trackingState!==e&&(this._trackingState=e,this.onTrackingStateChanged.notifyObservers(e))}get realWorldHeight(){let e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.baseReferenceSpace);return e&&e.transform?e.transform.position.y*this._xrSessionManager.worldScalingFactor:0}_updateForDualEyeDebugging(){this._updateNumberOfRigCameras(2),this.rigCameras[0].viewport=new Is(0,0,.5,1),this.rigCameras[0].outputRenderTarget=null,this.rigCameras[1].viewport=new Is(.5,0,.5,1),this.rigCameras[1].outputRenderTarget=null}setTransformationFromNonVRCamera(e=this.getScene().activeCamera,t=!0){if(!e||e===this)return;e.computeWorldMatrix().decompose(void 0,this.rotationQuaternion,this.position),this.position.y=0,Q.FromEulerAnglesToRef(0,this.rotationQuaternion.toEulerAngles().y,0,this.rotationQuaternion),this._firstFrame=!0,t&&this._xrSessionManager.resetReferenceSpace()}getClassName(){return"WebXRCamera"}setTarget(e){let t=k.Vector3[1];e.subtractToRef(this.position,t),t.y=0,t.normalize();let i=Math.atan2(t.x,t.z)+(this._scene.useRightHandedSystem?Math.PI:0);this.rotationQuaternion.toEulerAnglesToRef(t),Q.FromEulerAnglesToRef(t.x,i,t.z,this.rotationQuaternion)}dispose(){super.dispose(),this._lastXRViewerPose=void 0,this.onTrackingStateChanged.clear()}_updateDepthNearFar(){let e=(this.maxZ||1e4)*this._xrSessionManager.worldScalingFactor,t={depthFar:e,depthNear:this.minZ};this._xrSessionManager.updateRenderState(t),this._cache.minZ=this.minZ,this._cache.maxZ=e}_updateFromXRSession(){let e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.referenceSpace);if(this._lastXRViewerPose=e||void 0,!e){this._setTrackingState(0);return}let t=e.emulatedPosition?1:2;if(this._setTrackingState(t),(this.minZ!==this._cache.minZ||this.maxZ!==this._cache.maxZ)&&this._updateDepthNearFar(),e.transform){let i=e.transform.orientation;if(e.transform.orientation.x===void 0)return;let r=e.transform.position;this._referencedPosition.set(r.x,r.y,r.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),this._referenceQuaternion.set(i.x,i.y,i.z,i.w),this._scene.useRightHandedSystem||(this._referencedPosition.z*=-1,this._referenceQuaternion.z*=-1,this._referenceQuaternion.w*=-1),this._firstFrame?(this._firstFrame=!1,this.position.y+=this._referencedPosition.y,this._referenceQuaternion.copyFromFloats(0,0,0,1)):(this.rotationQuaternion.copyFrom(this._referenceQuaternion),this.position.copyFrom(this._referencedPosition))}this.rigCameras.length!==e.views.length&&this._updateNumberOfRigCameras(e.views.length);for(let i=0;i<e.views.length;i++){let r=e.views[i],s=this.rigCameras[i];!s.isLeftCamera&&!s.isRightCamera&&(r.eye==="right"?s._isRightCamera=!0:r.eye==="left"&&(s._isLeftCamera=!0));let o=this.getScene().customRenderTargets;for(let h=0;h<o.length;h++){let d=o[h];s.customRenderTargets.indexOf(d)===-1&&s.customRenderTargets.push(d)}let a=r.transform.position,l=r.transform.orientation;s.parent=this.parent,s.position.set(a.x,a.y,a.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),s.rotationQuaternion?.set(l.x,l.y,l.z,l.w),!this._scene.useRightHandedSystem&&s.rotationQuaternion&&(s.position.z*=-1,s.rotationQuaternion.z*=-1,s.rotationQuaternion.w*=-1),L.FromFloat32ArrayToRefScaled(r.projectionMatrix,0,1,s._projectionMatrix),this._scene.useRightHandedSystem||s._projectionMatrix.toggleProjectionMatrixHandInPlace();let c=Math.atan2(1,r.projectionMatrix[5])*2;s.fov=c,i===0&&(this.fov=c,this._projectionMatrix.copyFrom(s._projectionMatrix));let u=this._xrSessionManager.getRenderTargetTextureForView(r);this._renderingMultiview=u?._texture?.isMultiview||!1,this._renderingMultiview?i==0&&(this._xrSessionManager.trySetViewportForView(this.viewport,r),this.outputRenderTarget=u):(this._xrSessionManager.trySetViewportForView(s.viewport,r),s.outputRenderTarget=u||this._xrSessionManager.getRenderTargetTextureForView(r)),s.layerMask=this.layerMask}}_updateNumberOfRigCameras(e=1){for(;this.rigCameras.length<e;){let t=new gi("XR-RigCamera: "+this.rigCameras.length,m.Zero(),this.getScene());t.minZ=.1,t.rotationQuaternion=new Q,t.updateUpVectorFromRotation=!0,t.isRigCamera=!0,t.rigParent=this,t.freezeProjectionMatrix(),this.rigCameras.push(t)}for(;this.rigCameras.length>e;){let t=this.rigCameras.pop();t&&t.dispose()}}_updateReferenceSpace(){if(!this.position.equals(this._referencedPosition)||!this.rotationQuaternion.equals(this._referenceQuaternion)){let e=k.Matrix[0],t=k.Matrix[1],i=k.Matrix[2];L.ComposeToRef(n._ScaleReadOnly,this._referenceQuaternion,this._referencedPosition,e),L.ComposeToRef(n._ScaleReadOnly,this.rotationQuaternion,this.position,t),e.invert().multiplyToRef(t,i),i.invert(),this._scene.useRightHandedSystem||i.toggleModelMatrixHandInPlace(),i.decompose(void 0,this._referenceQuaternion,this._referencedPosition);let r=new XRRigidTransform({x:this._referencedPosition.x/this._xrSessionManager.worldScalingFactor,y:this._referencedPosition.y/this._xrSessionManager.worldScalingFactor,z:this._referencedPosition.z/this._xrSessionManager.worldScalingFactor,w:1},{x:this._referenceQuaternion.x,y:this._referenceQuaternion.y,z:this._referenceQuaternion.z,w:this._referenceQuaternion.w});this._xrSessionManager.referenceSpace=this._xrSessionManager.referenceSpace.getOffsetReferenceSpace(r)}}};yh._ScaleReadOnly=m.One();var fn=(()=>{class n{}return n.ANCHOR_SYSTEM="xr-anchor-system",n.BACKGROUND_REMOVER="xr-background-remover",n.HIT_TEST="xr-hit-test",n.MESH_DETECTION="xr-mesh-detection",n.PHYSICS_CONTROLLERS="xr-physics-controller",n.PLANE_DETECTION="xr-plane-detection",n.POINTER_SELECTION="xr-controller-pointer-selection",n.TELEPORTATION="xr-controller-teleportation",n.FEATURE_POINTS="xr-feature-points",n.HAND_TRACKING="xr-hand-tracking",n.IMAGE_TRACKING="xr-image-tracking",n.NEAR_INTERACTION="xr-near-interaction",n.DOM_OVERLAY="xr-dom-overlay",n.MOVEMENT="xr-controller-movement",n.LIGHT_ESTIMATION="xr-light-estimation",n.EYE_TRACKING="xr-eye-tracking",n.WALKING_LOCOMOTION="xr-walking-locomotion",n.LAYERS="xr-layers",n.DEPTH_SENSING="xr-depth-sensing",n.SPACE_WARP="xr-space-warp",n.RAW_CAMERA_ACCESS="xr-raw-camera-access",n})(),pn=class n{constructor(e){this._xrSessionManager=e,this._features={},this._xrSessionManager.onXRSessionInit.add(()=>{let t=this.getEnabledFeatures();for(let i of t){let r=this._features[i];r.enabled&&!r.featureImplementation.attached&&!r.featureImplementation.disableAutoAttach&&this.attachFeature(i)}}),this._xrSessionManager.onXRSessionEnded.add(()=>{let t=this.getEnabledFeatures();for(let i of t){let r=this._features[i];r.enabled&&r.featureImplementation.attached&&this.detachFeature(i)}})}static AddWebXRFeature(e,t,i=1,r=!1){this._AvailableFeatures[e]=this._AvailableFeatures[e]||{latest:i},i>this._AvailableFeatures[e].latest&&(this._AvailableFeatures[e].latest=i),r&&(this._AvailableFeatures[e].stable=i),this._AvailableFeatures[e][i]=t}static ConstructFeature(e,t=1,i,r){let s=this._AvailableFeatures[e][t];if(!s)throw new Error("feature not found");return s(i,r)}static GetAvailableFeatures(){return Object.keys(this._AvailableFeatures)}static GetAvailableVersions(e){return Object.keys(this._AvailableFeatures[e])}static GetLatestVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].latest||-1}static GetStableVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].stable||-1}attachFeature(e){let t=this._features[e];t&&t.enabled&&!t.featureImplementation.attached&&(t.featureImplementation.attach()||z.Warn(`Feature ${e} failed to attach`))}detachFeature(e){let t=this._features[e];t&&t.featureImplementation.attached&&(t.featureImplementation.detach()||z.Warn(`Feature ${e} failed to detach`))}disableFeature(e){let t=typeof e=="string"?e:e.Name,i=this._features[t];return i&&i.enabled?(i.enabled=!1,this.detachFeature(t),i.featureImplementation.dispose(),delete this._features[t],!0):!1}dispose(){let e=this.getEnabledFeatures();for(let t of e)this.disableFeature(t)}enableFeature(e,t="latest",i={},r=!0,s=!0){let o=typeof e=="string"?e:e.Name,a=0;if(typeof t=="string"){if(!t)throw new Error(`Error in provided version - ${o} (${t})`);if(t==="stable"?a=n.GetStableVersionOfFeature(o):t==="latest"?a=n.GetLatestVersionOfFeature(o):a=+t,a===-1||isNaN(a))throw new Error(`feature not found - ${o} (${t})`)}else a=t;let l=n._ConflictingFeatures[o];if(l!==void 0&&this.getEnabledFeatures().indexOf(l)!==-1)throw new Error(`Feature ${o} cannot be enabled while ${l} is enabled.`);let c=this._features[o],u=n.ConstructFeature(o,a,this._xrSessionManager,i);if(!u)throw new Error(`feature not found - ${o}`);c&&this.disableFeature(o);let h=u();if(h.dependsOn&&!h.dependsOn.every(f=>!!this._features[f]))throw new Error(`Dependant features missing. Make sure the following features are enabled - ${h.dependsOn.join(", ")}`);if(h.isCompatible())return this._features[o]={featureImplementation:h,enabled:!0,version:a,required:s},r?this._xrSessionManager.session&&!this._features[o].featureImplementation.attached&&this.attachFeature(o):this._features[o].featureImplementation.disableAutoAttach=!0,this._features[o].featureImplementation;if(s)throw new Error("required feature not compatible");return z.Warn(`Feature ${o} not compatible with the current environment/browser and was not enabled.`),h}getEnabledFeature(e){return this._features[e]&&this._features[e].featureImplementation}getEnabledFeatures(){return Object.keys(this._features)}_extendXRSessionInitObject(e){return S(this,null,function*(){let t=this.getEnabledFeatures();for(let i of t){let r=this._features[i],s=r.featureImplementation.xrNativeFeatureName;if(s&&(r.required?(e.requiredFeatures=e.requiredFeatures||[],e.requiredFeatures.indexOf(s)===-1&&e.requiredFeatures.push(s)):(e.optionalFeatures=e.optionalFeatures||[],e.optionalFeatures.indexOf(s)===-1&&e.optionalFeatures.push(s))),r.featureImplementation.getXRSessionInitExtension){let o=yield r.featureImplementation.getXRSessionInitExtension();e=Y(Y({},e),o)}}return e})}};pn._AvailableFeatures={};pn._ConflictingFeatures={[fn.TELEPORTATION]:fn.MOVEMENT,[fn.MOVEMENT]:fn.TELEPORTATION};Ut.AddNodeConstructor("TouchCamera",(n,e)=>()=>new vh(n,m.Zero(),e));var vh=class extends Bt{get touchAngularSensibility(){let e=this.inputs.attached.touch;return e?e.touchAngularSensibility:0}set touchAngularSensibility(e){let t=this.inputs.attached.touch;t&&(t.touchAngularSensibility=e)}get touchMoveSensibility(){let e=this.inputs.attached.touch;return e?e.touchMoveSensibility:0}set touchMoveSensibility(e){let t=this.inputs.attached.touch;t&&(t.touchMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addTouch(),this._setupInputs()}getClassName(){return"TouchCamera"}_setupInputs(){let e=this.inputs.attached.touch,t=this.inputs.attached.mouse;t?t.touchEnabled=!e:e.allowMouse=!t}};Ut.AddNodeConstructor("FreeCamera",(n,e)=>()=>new pc(n,m.Zero(),e));var pc=class extends vh{get gamepadAngularSensibility(){let e=this.inputs.attached.gamepad;return e?e.gamepadAngularSensibility:0}set gamepadAngularSensibility(e){let t=this.inputs.attached.gamepad;t&&(t.gamepadAngularSensibility=e)}get gamepadMoveSensibility(){let e=this.inputs.attached.gamepad;return e?e.gamepadMoveSensibility:0}set gamepadMoveSensibility(e){let t=this.inputs.attached.gamepad;t&&(t.gamepadMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addGamepad()}getClassName(){return"UniversalCamera"}};Fe._CreateDefaultParsedCamera=(n,e)=>new pc(n,m.Zero(),e);var wg=class n{constructor(e){this._scene=e,this._nonVRCamera=null,this._attachedToElement=!1,this._spectatorCamera=null,this._originalSceneAutoClear=!0,this._supported=!1,this._spectatorMode=!1,this._lastTimestamp=0,this.onInitialXRPoseSetObservable=new F,this.onStateChangedObservable=new F,this.state=3,this.sessionManager=new fc(e),this.camera=new yh("webxr",e,this.sessionManager),this.featuresManager=new pn(this.sessionManager),e.onDisposeObservable.addOnce(()=>{this.dispose()})}static CreateAsync(e){return S(this,null,function*(){let t=new n(e);return yield t.sessionManager.initializeAsync().then(()=>(t._supported=!0,t)).catch(i=>{throw t._setState(3),t.dispose(),i})})}dispose(){this.exitXRAsync(),this.camera.dispose(),this.onStateChangedObservable.clear(),this.onInitialXRPoseSetObservable.clear(),this.sessionManager.dispose(),this._spectatorCamera?.dispose(),this._nonVRCamera&&(this._scene.activeCamera=this._nonVRCamera)}enterXRAsync(s,o){return S(this,arguments,function*(e,t,i=this.sessionManager.getWebXRRenderTarget(),r={}){if(!this._supported)throw"WebXR not supported in this browser or environment";this._setState(0),t!=="viewer"&&t!=="local"&&(r.optionalFeatures=r.optionalFeatures||[],r.optionalFeatures.push(t)),r=yield this.featuresManager._extendXRSessionInitObject(r),e==="immersive-ar"&&t!=="unbounded"&&P.Warn("We recommend using 'unbounded' reference space type when using 'immersive-ar' session mode");try{yield this.sessionManager.initializeSessionAsync(e,r),yield this.sessionManager.setReferenceSpaceTypeAsync(t);let a={depthFar:this.camera.maxZ||1e4,depthNear:this.camera.minZ};if(!this.featuresManager.getEnabledFeature(fn.LAYERS)){let l=yield i.initializeXRLayerAsync(this.sessionManager.session);a.baseLayer=l}return this.sessionManager.updateRenderState(a),this.sessionManager.runXRRenderLoop(),this._originalSceneAutoClear=this._scene.autoClear,this._nonVRCamera=this._scene.activeCamera,this._attachedToElement=!!this._nonVRCamera?.inputs?.attachedToElement,this._nonVRCamera?.detachControl(),this._scene.activeCamera=this.camera,e!=="immersive-ar"?this._nonXRToXRCamera():(this._scene.autoClear=!1,this.camera.compensateOnFirstFrame=!1,this.camera.position.set(0,0,0),this.camera.rotationQuaternion.set(0,0,0,1),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)),ne.audioEngine?._resumeAudioContextOnStateChange(),this.sessionManager.onXRSessionEnded.addOnce(()=>{this.state!==1&&this._setState(1);for(let l of this.camera.rigCameras)l.outputRenderTarget=null;this._scene.autoClear=this._originalSceneAutoClear,this._scene.activeCamera=this._nonVRCamera,this._attachedToElement&&this._nonVRCamera&&this._nonVRCamera.attachControl(!!this._nonVRCamera.inputs.noPreventDefault),e!=="immersive-ar"&&this.camera.compensateOnFirstFrame&&(this._nonVRCamera.setPosition?this._nonVRCamera.setPosition(this.camera.position):this._nonVRCamera.position.copyFrom(this.camera.position)),this._setState(3)}),this.sessionManager.onXRFrameObservable.addOnce(()=>{this._setState(2)}),this.sessionManager}catch(a){throw P.Log(a),P.Log(a.message),this._setState(3),a}})}exitXRAsync(){return S(this,null,function*(){if(this.state===2)return this._setState(1),yield this.sessionManager.exitXRAsync()})}enableSpectatorMode(e){this._spectatorMode||(this._spectatorMode=!0,this._switchSpectatorMode(e))}disableSpecatatorMode(){this._spectatorMode&&(this._spectatorMode=!1,this._switchSpectatorMode())}_switchSpectatorMode(e){let i=1/(e?.fps?e.fps:1e3)*1e3,r=e?.preferredCameraIndex?e?.preferredCameraIndex:0,s=()=>{this._spectatorCamera&&this.sessionManager.currentTimestamp-this._lastTimestamp>=i&&(this._lastTimestamp=this.sessionManager.currentTimestamp,this._spectatorCamera.position.copyFrom(this.camera.rigCameras[r].globalPosition),this._spectatorCamera.rotationQuaternion?.copyFrom(this.camera.rigCameras[r].absoluteRotation))};if(this._spectatorMode){if(r>=this.camera.rigCameras.length)throw new Error("the preferred camera index is beyond the length of rig camera array.");let o=()=>{this.state===2?(this._spectatorCamera=new pc("webxr-spectator",m.Zero(),this._scene),this._spectatorCamera.rotationQuaternion=new Q,this._scene.activeCameras=[this.camera,this._spectatorCamera],this.sessionManager.onXRFrameObservable.add(s),this._scene.onAfterRenderCameraObservable.add(a=>{a===this.camera&&(this._scene.getEngine().framebufferDimensionsObject=null)})):this.state===1&&(this.sessionManager.onXRFrameObservable.removeCallback(s),this._scene.activeCameras=null)};this.onStateChangedObservable.add(o),o()}else this.sessionManager.onXRFrameObservable.removeCallback(s),this._scene.activeCameras=[this.camera]}_nonXRToXRCamera(){this.camera.setTransformationFromNonVRCamera(this._nonVRCamera),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)}_setState(e){this.state!==e&&(this.state=e,this.onStateChangedObservable.notifyObservers(this.state))}};var ro=(()=>{class n{constructor(t,i,r=-1,s=[]){this.id=t,this.type=i,this._buttonIndex=r,this._axesIndices=s,this._axes={x:0,y:0},this._changes={},this._currentValue=0,this._hasChanges=!1,this._pressed=!1,this._touched=!1,this.onAxisValueChangedObservable=new F,this.onButtonStateChangedObservable=new F}get axes(){return this._axes}get changes(){return this._changes}get hasChanges(){return this._hasChanges}get pressed(){return this._pressed}get touched(){return this._touched}get value(){return this._currentValue}dispose(){this.onAxisValueChangedObservable.clear(),this.onButtonStateChangedObservable.clear()}isAxes(){return this._axesIndices.length!==0}isButton(){return this._buttonIndex!==-1}update(t){let i=!1,r=!1;if(this._hasChanges=!1,this._changes={},this.isButton()){let s=t.buttons[this._buttonIndex];if(!s)return;this._currentValue!==s.value&&(this.changes.value={current:s.value,previous:this._currentValue},i=!0,this._currentValue=s.value),this._touched!==s.touched&&(this.changes.touched={current:s.touched,previous:this._touched},i=!0,this._touched=s.touched),this._pressed!==s.pressed&&(this.changes.pressed={current:s.pressed,previous:this._pressed},i=!0,this._pressed=s.pressed)}this.isAxes()&&(this._axes.x!==t.axes[this._axesIndices[0]]&&(this.changes.axes={current:{x:t.axes[this._axesIndices[0]],y:this._axes.y},previous:{x:this._axes.x,y:this._axes.y}},this._axes.x=t.axes[this._axesIndices[0]],r=!0),this._axes.y!==t.axes[this._axesIndices[1]]&&(this.changes.axes?this.changes.axes.current.y=t.axes[this._axesIndices[1]]:this.changes.axes={current:{x:this._axes.x,y:t.axes[this._axesIndices[1]]},previous:{x:this._axes.x,y:this._axes.y}},this._axes.y=t.axes[this._axesIndices[1]],r=!0)),i&&(this._hasChanges=!0,this.onButtonStateChangedObservable.notifyObservers(this)),r&&(this._hasChanges=!0,this.onAxisValueChangedObservable.notifyObservers(this._axes))}}return n.BUTTON_TYPE="button",n.SQUEEZE_TYPE="squeeze",n.THUMBSTICK_TYPE="thumbstick",n.TOUCHPAD_TYPE="touchpad",n.TRIGGER_TYPE="trigger",n})();var mc=class{constructor(e,t,i,r,s=!1,o){if(this.scene=e,this.layout=t,this.gamepadObject=i,this.handedness=r,this._doNotLoadControllerMesh=s,this._controllerCache=o,this._initComponent=a=>{if(!a)return;let l=this.layout.components[a],c=l.type,u=l.gamepadIndices.button,h=[];l.gamepadIndices.xAxis!==void 0&&l.gamepadIndices.yAxis!==void 0&&h.push(l.gamepadIndices.xAxis,l.gamepadIndices.yAxis),this.components[a]=new ro(a,c,u,h)},this._modelReady=!1,this.components={},this.disableAnimation=!1,this.onModelLoadedObservable=new F,t.components){let a=Object.keys(t.components);for(let l of a)this._initComponent(l)}}dispose(){let e=this.getComponentIds();for(let t of e)this.getComponent(t).dispose();if(this.rootMesh){let t=this.rootMesh.getChildren(void 0,!0);for(let i of t)i.setEnabled(!1);this.rootMesh.dispose(!!this._controllerCache,!this._controllerCache)}this.onModelLoadedObservable.clear()}getAllComponentsOfType(e){return this.getComponentIds().map(t=>this.components[t]).filter(t=>t.type===e)}getComponent(e){return this.components[e]}getComponentIds(){return Object.keys(this.components)}getComponentOfType(e){return this.getAllComponentsOfType(e)[0]||null}getMainComponent(){return this.getComponent(this.layout.selectComponentId)}loadModel(){return S(this,null,function*(){let e=!this._getModelLoadingConstraints(),t=this._getGenericFilenameAndPath();return e?P.Warn("Falling back to generic models"):t=this._getFilenameAndPath(),yield new Promise((i,r)=>{let s=o=>{e?this._getGenericParentMesh(o):this._setRootMesh(o),this._processLoadedModel(o),this._modelReady=!0,this.onModelLoadedObservable.notifyObservers(this),i(!0)};if(this._controllerCache){let o=this._controllerCache.filter(a=>a.filename===t.filename&&a.path===t.path);if(o[0]){for(let a of o[0].meshes)a.setEnabled(!0);s(o[0].meshes);return}}Ho.ImportMesh("",t.path,t.filename,this.scene,o=>{this._controllerCache&&this._controllerCache.push(lt(Y({},t),{meshes:o})),s(o)},null,(o,a)=>{P.Log(a),P.Warn(`Failed to retrieve controller model of type ${this.profileId} from the remote server: ${t.path}${t.filename}`),r(a)})})})}updateFromXRFrame(e){for(let t of this.getComponentIds())this.getComponent(t).update(this.gamepadObject);this.updateModel(e)}get handness(){return this.handedness}pulse(e,t,i=0){return S(this,null,function*(){return this.gamepadObject.hapticActuators&&this.gamepadObject.hapticActuators[i]?yield this.gamepadObject.hapticActuators[i].pulse(e,t):!1})}_getChildByName(e,t){return e.getChildren(i=>i.name===t,!1)[0]}_getImmediateChildByName(e,t){return e.getChildren(i=>i.name==t,!0)[0]}_lerpTransform(e,t,i){if(!e.minMesh||!e.maxMesh||!e.valueMesh||!e.minMesh.rotationQuaternion||!e.maxMesh.rotationQuaternion||!e.valueMesh.rotationQuaternion)return;let r=i?t*.5+.5:t;Q.SlerpToRef(e.minMesh.rotationQuaternion,e.maxMesh.rotationQuaternion,r,e.valueMesh.rotationQuaternion),m.LerpToRef(e.minMesh.position,e.maxMesh.position,r,e.valueMesh.position)}updateModel(e){this._modelReady&&this._updateModel(e)}_getGenericFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getGenericParentMesh(e){this.rootMesh=new E(this.profileId+" "+this.handedness,this.scene);for(let t of e)t.parent||(t.isPickable=!1,t.setParent(this.rootMesh));this.rootMesh.rotationQuaternion=Q.FromEulerAngles(0,Math.PI,0)}};var pT=(()=>{class n extends mc{constructor(t,i,r){super(t,qk[r],i,r),this.profileId=n.ProfileId}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(t){}_setRootMesh(t){this.rootMesh=new E(this.profileId+" "+this.handedness,this.scene);for(let i of t)i.isPickable=!1,i.parent||i.setParent(this.rootMesh);this.rootMesh.rotationQuaternion=Q.FromEulerAngles(0,Math.PI,0)}_updateModel(){}}return n.ProfileId="generic-trigger",n})(),qk={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-none",assetPath:"none.glb"}};var Mg=class extends mc{constructor(e,t,i,r,s){super(e,i.layouts[t.handedness||"none"],t.gamepad,t.handedness,void 0,s),this._repositoryUrl=r,this.controllerCache=s,this._buttonMeshMapping={},this._touchDots={},this.profileId=i.profileId}dispose(){if(super.dispose(),!this.controllerCache){let e=Object.keys(this._touchDots);for(let t of e)this._touchDots[t].dispose()}}_getFilenameAndPath(){return{filename:this.layout.assetPath,path:`${this._repositoryUrl}/profiles/${this.profileId}/`}}_getModelLoadingConstraints(){let e=Ho.IsPluginForExtensionAvailable(".glb");return e||P.Warn("glTF / glb loader was not registered, using generic controller instead"),e}_processLoadedModel(e){let t=this.getComponentIds();for(let i of t){let r=this.layout.components[i];this._buttonMeshMapping[i]={mainMesh:this._getChildByName(this.rootMesh,r.rootNodeName),states:{}};let s=Object.keys(r.visualResponses);for(let o of s){let a=r.visualResponses[o];if(a.valueNodeProperty==="transform")this._buttonMeshMapping[i].states[o]={valueMesh:this._getChildByName(this.rootMesh,a.valueNodeName),minMesh:this._getChildByName(this.rootMesh,a.minNodeName),maxMesh:this._getChildByName(this.rootMesh,a.maxNodeName)};else{let l=r.type===ro.TOUCHPAD_TYPE&&r.touchPointNodeName?r.touchPointNodeName:a.valueNodeName;if(this._buttonMeshMapping[i].states[o]={valueMesh:this._getChildByName(this.rootMesh,l)},r.type===ro.TOUCHPAD_TYPE&&!this._touchDots[o]){let c=eo(o+"dot",{diameter:.0015,segments:8},this.scene);c.material=new te(o+"mat",this.scene),c.material.diffuseColor=U.Red(),c.parent=this._buttonMeshMapping[i].states[o].valueMesh||null,c.isVisible=!1,this._touchDots[o]=c}}}}}_setRootMesh(e){this.rootMesh=new E(this.profileId+"-"+this.handedness,this.scene),this.rootMesh.isPickable=!1;let t;for(let i=0;i<e.length;i++){let r=e[i];r.isPickable=!1,r.parent||(t=r)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||this.rootMesh.rotate(Li.Y,Math.PI,1)}_updateModel(e){if(this.disableAnimation)return;let t=this.getComponentIds();for(let i of t){let r=this.getComponent(i);if(!r.hasChanges)continue;let s=this._buttonMeshMapping[i],o=this.layout.components[i],a=Object.keys(o.visualResponses);for(let l of a){let c=o.visualResponses[l],u=r.value;if(c.componentProperty==="xAxis"?u=r.axes.x:c.componentProperty==="yAxis"&&(u=r.axes.y),c.valueNodeProperty==="transform")this._lerpTransform(s.states[l],u,c.componentProperty!=="button");else{let h=s.states[l].valueMesh;h&&(h.isVisible=r.touched||r.pressed),this._touchDots[l]&&(this._touchDots[l].isVisible=r.touched||r.pressed)}}}}};var mT=[],$n=(()=>{class n{static ClearProfilesCache(){this._ProfilesList=null,this._ProfileLoadingPromises={}}static DefaultFallbacks(){this.RegisterFallbacksForProfileId("google-daydream",["generic-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive-focus",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("magicleap-one",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("windows-mixed-reality",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("microsoft-mixed-reality",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-go",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("oculus-touch-v2",["oculus-touch","generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-touch",["generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-gearvr",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-odyssey",["generic-touchpad"]),this.RegisterFallbacksForProfileId("valve-index",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("generic-hand-select",["generic-trigger"]),this.RegisterFallbacksForProfileId("oculus-hand",["generic-trigger"])}static FindFallbackWithProfileId(t){let i=this._Fallbacks[t]||[];return i.unshift(t),i}static GetMotionControllerWithXRInput(t,i,r){return S(this,null,function*(){let s=[];if(r&&s.push(r),s.push(...t.profiles||[]),s.length&&!s[0]&&s.pop(),t.gamepad&&t.gamepad.id)switch(t.gamepad.id){case(t.gamepad.id.match(/oculus touch/gi)?t.gamepad.id:void 0):s.push("oculus-touch-v2");break}let o=s.indexOf("windows-mixed-reality");if(o!==-1&&s.splice(o,0,"microsoft-mixed-reality"),s.length||s.push("generic-trigger"),this.UseOnlineRepository){let a=this.PrioritizeOnlineRepository?this._LoadProfileFromRepositoryAsync:this._LoadProfilesFromAvailableControllersAsync,l=this.PrioritizeOnlineRepository?this._LoadProfilesFromAvailableControllersAsync:this._LoadProfileFromRepositoryAsync;return a.call(this,s,t,i).catch(()=>l.call(this,s,t,i))}else return yield this._LoadProfilesFromAvailableControllersAsync(s,t,i)})}static RegisterController(t,i){this._AvailableControllers[t]=i}static RegisterFallbacksForProfileId(t,i){this._Fallbacks[t]?this._Fallbacks[t].push(...i):this._Fallbacks[t]=i}static UpdateProfilesList(){return S(this,null,function*(){let t=yield z.LoadFileAsync(this.BaseRepositoryUrl+"/profiles/profilesList.json",!1);return this._ProfilesList=JSON.parse(t),yield this._ProfilesList})}static ClearControllerCache(){for(let t of mT)for(let i of t.meshes)i.dispose(!1,!0);mT.length=0}static _LoadProfileFromRepositoryAsync(t,i,r){return S(this,null,function*(){return yield Promise.resolve().then(()=>S(this,null,function*(){return this._ProfilesList?yield this._ProfilesList:yield this.UpdateProfilesList()})).then(s=>{for(let o=0;o<t.length;++o)if(t[o]&&s[t[o]])return t[o];throw new Error(`neither controller ${t[0]} nor all fallbacks were found in the repository,`)}).then(s=>S(this,null,function*(){return this._ProfileLoadingPromises[s]||(this._ProfileLoadingPromises[s]=z.LoadFileAsync(`${this.BaseRepositoryUrl}/profiles/${s}/profile.json`,!1).then(o=>JSON.parse(o))),yield this._ProfileLoadingPromises[s]})).then(s=>new Mg(r,i,s,this.BaseRepositoryUrl,this.DisableControllerCache?void 0:mT))})}static _LoadProfilesFromAvailableControllersAsync(t,i,r){return S(this,null,function*(){for(let s=0;s<t.length;++s){if(!t[s])continue;let o=this.FindFallbackWithProfileId(t[s]);for(let a=0;a<o.length;++a){let l=this._AvailableControllers[o[a]];if(l)return l(i,r)}}throw new Error("no controller requested was found in the available controllers list")})}}return n._AvailableControllers={},n._Fallbacks={},n._ProfileLoadingPromises={},n.BaseRepositoryUrl="https://immersive-web.github.io/webxr-input-profiles/packages/viewer/dist",n.PrioritizeOnlineRepository=!0,n.UseOnlineRepository=!0,n.DisableControllerCache=!0,n})();$n.RegisterController(pT.ProfileId,(n,e)=>new pT(e,n.gamepad,n.handedness));$n.DefaultFallbacks();var Yk=0,Dg=class{constructor(e,t,i={}){this._scene=e,this.inputSource=t,this._options=i,this._tmpVector=new m,this._disposed=!1,this.onDisposeObservable=new F,this.onMeshLoadedObservable=new F,this.onMotionControllerInitObservable=new F,this._uniqueId=`controller-${Yk++}-${t.targetRayMode}-${t.handedness}`,this.pointer=new E(`${this._uniqueId}-pointer`,e),this.pointer.rotationQuaternion=new Q,this.inputSource.gripSpace&&(this.grip=new E(`${this._uniqueId}-grip`,this._scene),this.grip.rotationQuaternion=new Q),this._tmpVector.set(0,0,this._scene.useRightHandedSystem?-1:1),this.inputSource.gamepad&&this.inputSource.targetRayMode==="tracked-pointer"&&$n.GetMotionControllerWithXRInput(t,e,this._options.forceControllerProfile).then(r=>{this.motionController=r,this.onMotionControllerInitObservable.notifyObservers(r),!this._options.doNotLoadControllerMesh&&!this.motionController._doNotLoadControllerMesh&&this.motionController.loadModel().then(s=>{if(s&&this.motionController&&this.motionController.rootMesh){if(this._options.renderingGroupId){this.motionController.rootMesh.renderingGroupId=this._options.renderingGroupId;let o=this.motionController.rootMesh.getChildMeshes(!1);for(let a of o)a.renderingGroupId=this._options.renderingGroupId}this.onMeshLoadedObservable.notifyObservers(this.motionController.rootMesh),this.motionController.rootMesh.parent=this.grip||this.pointer,this.motionController.disableAnimation=!!this._options.disableMotionControllerAnimation}this._disposed&&this.motionController?.dispose()})},()=>{z.Warn("Could not find a matching motion controller for the registered input source")})}get uniqueId(){return this._uniqueId}dispose(){this.grip&&this.grip.dispose(!0),this.motionController&&this.motionController.dispose(),this.pointer.dispose(!0),this.onMotionControllerInitObservable.clear(),this.onMeshLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._disposed=!0}getWorldPointerRayToRef(e,t=!1){let i=t&&this.grip?this.grip:this.pointer;m.TransformNormalToRef(this._tmpVector,i.getWorldMatrix(),e.direction),e.direction.normalize(),e.origin.copyFrom(i.absolutePosition),e.length=1e3}updateFromXRFrame(e,t,i,r){let s=e.getPose(this.inputSource.targetRaySpace,t);if(this._lastXRPose=s,s){let o=s.transform.position;this.pointer.position.set(o.x,o.y,o.z).scaleInPlace(r.worldScalingFactor);let a=s.transform.orientation;this.pointer.rotationQuaternion.set(a.x,a.y,a.z,a.w),this._scene.useRightHandedSystem||(this.pointer.position.z*=-1,this.pointer.rotationQuaternion.z*=-1,this.pointer.rotationQuaternion.w*=-1),this.pointer.parent=i.parent,this.pointer.scaling.setAll(r.worldScalingFactor)}if(this.inputSource.gripSpace&&this.grip){let o=e.getPose(this.inputSource.gripSpace,t);if(o){let a=o.transform.position,l=o.transform.orientation;this.grip.position.set(a.x,a.y,a.z).scaleInPlace(r.worldScalingFactor),this.grip.rotationQuaternion.set(l.x,l.y,l.z,l.w),this._scene.useRightHandedSystem||(this.grip.position.z*=-1,this.grip.rotationQuaternion.z*=-1,this.grip.rotationQuaternion.w*=-1)}this.grip.parent=i.parent,this.grip.scaling.setAll(r.worldScalingFactor)}this.motionController&&this.motionController.updateFromXRFrame(e)}};var Rg=class{constructor(e,t,i={}){if(this.xrSessionManager=e,this.xrCamera=t,this._options=i,this.controllers=[],this.onControllerAddedObservable=new F,this.onControllerRemovedObservable=new F,this._onInputSourcesChange=r=>{this._addAndRemoveControllers(r.added,r.removed)},this._sessionEndedObserver=this.xrSessionManager.onXRSessionEnded.add(()=>{this._addAndRemoveControllers([],this.controllers.map(r=>r.inputSource))}),this._sessionInitObserver=this.xrSessionManager.onXRSessionInit.add(r=>{r.addEventListener("inputsourceschange",this._onInputSourcesChange)}),this._frameObserver=this.xrSessionManager.onXRFrameObservable.add(r=>{for(let s of this.controllers)s.updateFromXRFrame(r,this.xrSessionManager.referenceSpace,this.xrCamera,this.xrSessionManager)}),this._options.customControllersRepositoryURL&&($n.BaseRepositoryUrl=this._options.customControllersRepositoryURL),$n.UseOnlineRepository=!this._options.disableOnlineControllerRepository,$n.UseOnlineRepository)try{$n.UpdateProfilesList().catch(()=>{$n.UseOnlineRepository=!1})}catch{$n.UseOnlineRepository=!1}}_addAndRemoveControllers(e,t){let i=this.controllers.map(o=>o.inputSource);for(let o of e)if(i.indexOf(o)===-1){let a=new Dg(this.xrSessionManager.scene,o,lt(Y({},this._options.controllerOptions||{}),{forceControllerProfile:this._options.forceInputProfile,doNotLoadControllerMesh:this._options.doNotLoadControllerMeshes,disableMotionControllerAnimation:this._options.disableControllerAnimation}));this.controllers.push(a),this.onControllerAddedObservable.notifyObservers(a)}let r=[],s=[];for(let o of this.controllers)t.indexOf(o.inputSource)===-1?r.push(o):s.push(o);this.controllers=r;for(let o of s)this.onControllerRemovedObservable.notifyObservers(o),o.dispose()}dispose(){for(let e of this.controllers)e.dispose();this.xrSessionManager.onXRFrameObservable.remove(this._frameObserver),this.xrSessionManager.onXRSessionInit.remove(this._sessionInitObserver),this.xrSessionManager.onXRSessionEnded.remove(this._sessionEndedObserver),this.onControllerAddedObservable.clear(),this.onControllerRemovedObservable.clear(),$n.ClearControllerCache()}};var $r=class{get xrNativeFeatureName(){return this._xrNativeFeatureName}set xrNativeFeatureName(e){!this._xrSessionManager.isNative&&e&&this._xrSessionManager.inXRSession&&this._xrSessionManager.enabledFeatures?.indexOf(e)===-1&&P.Warn(`The feature ${e} needs to be enabled before starting the XR session. Note - It is still possible it is not supported.`),this._xrNativeFeatureName=e}constructor(e){this._xrSessionManager=e,this._attached=!1,this._removeOnDetach=[],this.isDisposed=!1,this.disableAutoAttach=!1,this._xrNativeFeatureName="",this.onFeatureAttachObservable=new F,this.onFeatureDetachObservable=new F}get attached(){return this._attached}attach(e){if(this.isDisposed)return!1;if(e)this.attached&&this.detach();else if(this.attached)return!1;if(!this._xrSessionManager.enabledFeatures)P.Warn("session.enabledFeatures is not available on this device. It is possible that this feature is not supported.");else if(!this._xrSessionManager.isNative&&this.xrNativeFeatureName&&this._xrSessionManager.enabledFeatures.indexOf(this.xrNativeFeatureName)===-1)return!1;return this._attached=!0,this._addNewAttachObserver(this._xrSessionManager.onXRFrameObservable,t=>this._onXRFrame(t)),this.onFeatureAttachObservable.notifyObservers(this),!0}detach(){if(!this._attached)return this.disableAutoAttach=!0,!1;this._attached=!1;for(let e of this._removeOnDetach)e.observable.remove(e.observer);return this.onFeatureDetachObservable.notifyObservers(this),!0}dispose(){this.detach(),this.isDisposed=!0,this.onFeatureAttachObservable.clear(),this.onFeatureDetachObservable.clear()}isCompatible(){return!0}_addNewAttachObserver(e,t,i){this._removeOnDetach.push({observable:e,observer:e.add(t,void 0,i)})}};var jr=(()=>{class n{getRenderCamera(t){if(this._renderCamera)return this._renderCamera;{let i;return this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?i=this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:i=this.originalScene.activeCamera,t&&i&&i.isRigCamera?i.rigParent:i}}setRenderCamera(t){this._renderCamera=t}_getSharedGizmoLight(){return this._sharedGizmoLight||(this._sharedGizmoLight=new Di("shared gizmo light",new m(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=U.Gray()),this._sharedGizmoLight}static get DefaultUtilityLayer(){return n._DefaultUtilityLayer==null?n._CreateDefaultUtilityLayerFromScene(ye.LastCreatedScene):n._DefaultUtilityLayer}static _CreateDefaultUtilityLayerFromScene(t){return n._DefaultUtilityLayer=new n(t),n._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{n._DefaultUtilityLayer=null}),n._DefaultUtilityLayer}static get DefaultKeepDepthUtilityLayer(){return n._DefaultKeepDepthUtilityLayer==null&&(n._DefaultKeepDepthUtilityLayer=new n(ye.LastCreatedScene),n._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,n._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{n._DefaultKeepDepthUtilityLayer=null})),n._DefaultKeepDepthUtilityLayer}constructor(t,i=!0,r=!1){this.originalScene=t,this.handleEvents=i,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new F,this.utilityLayerScene=new Ce(t.getEngine(),{virtual:!0,useFloatingOrigin:t.floatingOriginMode}),this.utilityLayerScene.useRightHandedSystem=t.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),i&&(this._originalPointerObserver=t.onPrePointerObservable.add(s=>{if(!this.utilityLayerScene.activeCamera||!this.pickingEnabled||!this.processAllEvents&&s.type!==Ee.POINTERMOVE&&s.type!==Ee.POINTERUP&&s.type!==Ee.POINTERDOWN&&s.type!==Ee.POINTERDOUBLETAP)return;this.utilityLayerScene.pointerX=t.pointerX,this.utilityLayerScene.pointerY=t.pointerY;let o=s.event;if(t.isPointerCaptured(o.pointerId)){this._pointerCaptures[o.pointerId]=!1;return}let a=c=>{let u=null;if(s.nearInteractionPickingInfo)s.nearInteractionPickingInfo.pickedMesh.getScene()==c?u=s.nearInteractionPickingInfo:u=new Ft;else if(c!==this.utilityLayerScene&&s.originalPickingInfo)u=s.originalPickingInfo;else{let h=null;this._renderCamera&&(h=c._activeCamera,c._activeCamera=this._renderCamera,s.ray=null),u=s.ray?c.pickWithRay(s.ray):c.pick(t.pointerX,t.pointerY),h&&(c._activeCamera=h)}return u},l=a(this.utilityLayerScene);if(!s.ray&&l&&(s.ray=l.ray),s.originalPickingInfo?.aimTransform&&l&&(l.aimTransform=s.originalPickingInfo.aimTransform,l.gripTransform=s.originalPickingInfo.gripTransform),this.utilityLayerScene.onPrePointerObservable.notifyObservers(s),this.onlyCheckPointerDownEvents&&s.type!=Ee.POINTERDOWN){s.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new Fh(s.type,s.event,l),s.type),s.type===Ee.POINTERUP&&this._pointerCaptures[o.pointerId]&&(this._pointerCaptures[o.pointerId]=!1);return}if(this.utilityLayerScene.autoClearDepthAndStencil||this.pickUtilitySceneFirst)l&&l.hit&&(s.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new Fh(s.type,s.event,l),s.type),s.skipOnPointerObservable=!0);else{let c=a(t),u=s.event;c&&l&&(l.distance===0&&c.pickedMesh?this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(c.pickedMesh)?(this._notifyObservers(s,c,u),s.skipOnPointerObservable=!0):s.type===Ee.POINTERDOWN?(this._pointerCaptures[u.pointerId]=!0,this._notifyObservers(s,c,u)):(s.type===Ee.POINTERMOVE||s.type===Ee.POINTERUP)&&(this._lastPointerEvents[u.pointerId]&&(this.onPointerOutObservable.notifyObservers(u.pointerId),delete this._lastPointerEvents[u.pointerId]),this._notifyObservers(s,c,u)):!this._pointerCaptures[u.pointerId]&&(l.distance<c.distance||c.distance===0)?(this._notifyObservers(s,l,u),s.skipOnPointerObservable||(s.skipOnPointerObservable=l.distance>0)):!this._pointerCaptures[u.pointerId]&&l.distance>=c.distance&&(this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(c.pickedMesh)?(this._notifyObservers(s,c,u),s.skipOnPointerObservable=!0):((s.type===Ee.POINTERMOVE||s.type===Ee.POINTERUP)&&this._lastPointerEvents[u.pointerId]&&(this.onPointerOutObservable.notifyObservers(u.pointerId),delete this._lastPointerEvents[u.pointerId]),this._notifyObservers(s,l,u))),s.type===Ee.POINTERUP&&this._pointerCaptures[u.pointerId]&&(this._pointerCaptures[u.pointerId]=!1))}}),this._originalPointerObserver&&t.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,r||(this._afterRenderObserver=this.originalScene.onAfterRenderCameraObservable.add(s=>{this.shouldRender&&s==this.getRenderCamera()&&this.render()})),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add(()=>{this.dispose()}),this._updateCamera()}_notifyObservers(t,i,r){t.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new Fh(t.type,t.event,i),t.type),this._lastPointerEvents[r.pointerId]=!0)}render(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){let t=this.utilityLayerScene.activeCamera.getScene(),i=this.utilityLayerScene.activeCamera;i._scene=this.utilityLayerScene,i.leftCamera&&(i.leftCamera._scene=this.utilityLayerScene),i.rightCamera&&(i.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),i._scene=t,i.leftCamera&&(i.leftCamera._scene=t),i.rightCamera&&(i.rightCamera._scene=t)}}dispose(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()}_updateCamera(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()}}return n._DefaultUtilityLayer=null,n._DefaultKeepDepthUtilityLayer=null,n})();var qr=class n extends $r{constructor(e,t){super(e),this._options=t,this._attachController=i=>{if(this._controllers[i.uniqueId])return;let{laserPointer:r,selectionMesh:s}=this._generateNewMeshPair(this._options.forceGripIfAvailable&&i.grip?i.grip:i.pointer);switch(this._controllers[i.uniqueId]={xrController:i,laserPointer:r,selectionMesh:s,meshUnderPointer:null,pick:null,tmpRay:new rt(new m,new m),disabledByNearInteraction:!1,id:n._IdCounter++},this._attachedController?!this._options.enablePointerSelectionOnAllControllers&&this._options.preferredHandedness&&i.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=i.uniqueId):this._options.enablePointerSelectionOnAllControllers||(this._attachedController=i.uniqueId),i.inputSource.targetRayMode){case"tracked-pointer":return this._attachTrackedPointerRayMode(i);case"gaze":return this._attachGazeMode(i);case"screen":case"transient-pointer":return this._attachScreenRayMode(i)}},this._controllers={},this._tmpVectorForPickCompare=new m,this.disablePointerLighting=!0,this.disableSelectionMeshLighting=!0,this.displayLaserPointer=!0,this.displaySelectionMesh=!0,this.laserPointerPickedColor=new U(.9,.9,.9),this.laserPointerDefaultColor=new U(.7,.7,.7),this.selectionMeshDefaultColor=new U(.8,.8,.8),this.selectionMeshPickedColor=new U(.3,.3,1),this._identityMatrix=L.Identity(),this._screenCoordinatesRef=m.Zero(),this._viewportRef=new Is(0,0,0,0),this._scene=this._xrSessionManager.scene,this._options.lookAndPickMode===void 0&&(this._scene.getEngine()._badDesktopOS||this._scene.getEngine()._badOS)&&(this._options.lookAndPickMode=!0),this._options.lookAndPickMode&&(this._options.enablePointerSelectionOnAllControllers=!0,this.displayLaserPointer=!1)}attach(){if(!super.attach())return!1;for(let e of this._options.xrInput.controllers)this._attachController(e);if(this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController,!0),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)},!0),this._scene.constantlyUpdateMeshUnderPointer=!0,this._options.gazeCamera){let e=this._options.gazeCamera,{laserPointer:t,selectionMesh:i}=this._generateNewMeshPair(e);this._controllers.camera={webXRCamera:e,laserPointer:t,selectionMesh:i,meshUnderPointer:null,pick:null,tmpRay:new rt(new m,new m),disabledByNearInteraction:!1,id:n._IdCounter++},this._attachGazeMode()}return!0}detach(){if(!super.detach())return!1;let e=Object.keys(this._controllers);for(let t of e)this._detachController(t);return!0}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){let t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}_getPointerSelectionDisabledByPointerId(e){let t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].disabledByNearInteraction;return!0}_setPointerSelectionDisabledByPointerId(e,t){let i=Object.keys(this._controllers);for(let r=0;r<i.length;++r)if(this._controllers[i[r]].id===e){this._controllers[i[r]].disabledByNearInteraction=t;return}}_onXRFrame(e){let t=Object.keys(this._controllers);for(let i of t){let r=this._controllers[i];if(this._options.lookAndPickMode&&r.xrController?.inputSource.targetRayMode!=="transient-pointer")continue;if(!this._options.enablePointerSelectionOnAllControllers&&i!==this._attachedController||r.disabledByNearInteraction){r.selectionMesh.isVisible=!1,r.laserPointer.isVisible=!1,r.pick=null;continue}r.laserPointer.isVisible=this.displayLaserPointer;let s;if(r.xrController)s=this._options.forceGripIfAvailable&&r.xrController.grip?r.xrController.grip.position:r.xrController.pointer.position,r.xrController.getWorldPointerRayToRef(r.tmpRay,this._options.forceGripIfAvailable);else if(r.webXRCamera)s=r.webXRCamera.position,r.webXRCamera.getForwardRayToRef(r.tmpRay);else continue;if(this._options.maxPointerDistance&&(r.tmpRay.length=this._options.maxPointerDistance),!this._options.disableScenePointerVectorUpdate&&s){let c=this._xrSessionManager.scene,u=this._options.xrInput.xrCamera;u&&(u.viewport.toGlobalToRef(c.getEngine().getRenderWidth()/u.rigCameras.length,c.getEngine().getRenderHeight(),this._viewportRef),m.ProjectToRef(s,this._identityMatrix,u.getTransformationMatrix(),this._viewportRef,this._screenCoordinatesRef),typeof this._screenCoordinatesRef.x=="number"&&typeof this._screenCoordinatesRef.y=="number"&&!isNaN(this._screenCoordinatesRef.x)&&!isNaN(this._screenCoordinatesRef.y)&&this._screenCoordinatesRef.x!==1/0&&this._screenCoordinatesRef.y!==1/0&&(c.pointerX=this._screenCoordinatesRef.x,c.pointerY=this._screenCoordinatesRef.y,r.screenCoordinates={x:this._screenCoordinatesRef.x,y:this._screenCoordinatesRef.y}))}let o=null;this._utilityLayerScene&&(o=this._utilityLayerScene.pickWithRay(r.tmpRay,this._utilityLayerScene.pointerMovePredicate||this.raySelectionPredicate));let a=this._scene.pickWithRay(r.tmpRay,this._scene.pointerMovePredicate||this.raySelectionPredicate);!o||!o.hit?r.pick=a:!a||!a.hit||o.distance<a.distance?r.pick=o:r.pick=a,r.pick&&r.xrController&&(r.pick.aimTransform=r.xrController.pointer,r.pick.gripTransform=r.xrController.grip||null,r.pick.originMesh=r.xrController.pointer,r.tmpRay.length=r.pick.distance);let l=r.pick;if(l&&l.pickedPoint&&l.hit){this._updatePointerDistance(r.laserPointer,l.distance),r.selectionMesh.position.copyFrom(l.pickedPoint),r.selectionMesh.scaling.x=Math.sqrt(l.distance),r.selectionMesh.scaling.y=Math.sqrt(l.distance),r.selectionMesh.scaling.z=Math.sqrt(l.distance);let c=this._convertNormalToDirectionOfRay(l.getNormal(!0),r.tmpRay),u=.001;if(r.selectionMesh.position.copyFrom(l.pickedPoint),c){let h=m.Cross(Li.Y,c),d=m.Cross(c,h);m.RotationFromAxisToRef(d,c,h,r.selectionMesh.rotation),r.selectionMesh.position.addInPlace(c.scale(u))}r.selectionMesh.isVisible=this.displaySelectionMesh,r.meshUnderPointer=l.pickedMesh}else r.selectionMesh.isVisible=!1,this._updatePointerDistance(r.laserPointer,1),r.meshUnderPointer=null}}get _utilityLayerScene(){return this._options.customUtilityLayerScene||jr.DefaultUtilityLayer.utilityLayerScene}_attachGazeMode(e){let t=this._controllers[e&&e.uniqueId||"camera"],i=this._options.timeToSelect||3e3,r=this._options.useUtilityLayer?this._utilityLayerScene:this._scene,s=new Ft,o=pr("selection",{diameter:.0035*15,thickness:.0025*6,tessellation:20},r);o.isVisible=!1,o.isPickable=!1,o.parent=t.selectionMesh;let a=0,l=!1,c={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{if(t.pick){if(this._augmentPointerInit(c,t.id,t.screenCoordinates),t.laserPointer.material.alpha=0,o.isVisible=!1,t.pick.hit)if(this._pickingMoved(s,t.pick))l&&(this._options.disablePointerUpOnTouchOut||this._scene.simulatePointerUp(t.pick,c)),l=!1,a=0;else if(a>i/10&&(o.isVisible=!0),a+=this._scene.getEngine().getDeltaTime(),a>=i)this._scene.simulatePointerDown(t.pick,c),l=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,c),o.isVisible=!1;else{let u=1-a/i;o.scaling.set(u,u,u)}else l=!1,a=0;this._scene.simulatePointerMove(t.pick,c),s=t.pick}}),this._options.renderingGroupId!==void 0&&(o.renderingGroupId=this._options.renderingGroupId),e&&e.onDisposeObservable.addOnce(()=>{t.pick&&!this._options.disablePointerUpOnTouchOut&&l&&(this._scene.simulatePointerUp(t.pick,c),t.finalPointerUpTriggered=!0),o.dispose()})}_attachScreenRayMode(e){let t=this._controllers[e.uniqueId],i=!1,r={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{this._augmentPointerInit(r,t.id,t.screenCoordinates),!(!t.pick||this._options.disablePointerUpOnTouchOut&&i)&&(i?this._scene.simulatePointerMove(t.pick,r):(this._scene.simulatePointerDown(t.pick,r),t.pointerDownTriggered=!0,i=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,r)))}),e.onDisposeObservable.addOnce(()=>{this._augmentPointerInit(r,t.id,t.screenCoordinates),this._xrSessionManager.runInXRFrame(()=>{t.pick&&!t.finalPointerUpTriggered&&i&&!this._options.disablePointerUpOnTouchOut&&(this._scene.simulatePointerUp(t.pick,r),t.finalPointerUpTriggered=!0)})})}_attachTrackedPointerRayMode(e){let t=this._controllers[e.uniqueId];if(this._options.forceGazeMode)return this._attachGazeMode(e);let i={pointerId:t.id,pointerType:"xr"};if(t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{t.laserPointer.material.disableLighting=this.disablePointerLighting,t.selectionMesh.material.disableLighting=this.disableSelectionMeshLighting,t.pick&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerMove(t.pick,i))}),e.inputSource.gamepad){let r=s=>{this._options.overrideButtonId&&(t.selectionComponent=s.getComponent(this._options.overrideButtonId)),t.selectionComponent||(t.selectionComponent=s.getMainComponent()),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add(o=>{if(o.changes.pressed){let a=o.changes.pressed.current;if(t.pick)(this._options.enablePointerSelectionOnAllControllers||e.uniqueId===this._attachedController)&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),a?(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor):(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor));else if(a&&!this._options.enablePointerSelectionOnAllControllers&&!this._options.disableSwitchOnClick){let l=this._controllers[this._attachedController];l&&l.pointerDownTriggered&&!l.finalPointerUpTriggered&&(this._augmentPointerInit(i,l.id,l.screenCoordinates),this._scene.simulatePointerUp(new Ft,{pointerId:l.id,pointerType:"xr"}),l.finalPointerUpTriggered=!0),this._attachedController=e.uniqueId}}})};e.motionController?r(e.motionController):e.onMotionControllerInitObservable.add(r)}else{let r=o=>{this._xrSessionManager.onXRFrameObservable.addOnce(()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&o.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor)})},s=o=>{this._xrSessionManager.onXRFrameObservable.addOnce(()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&o.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)})};t.eventListeners={selectend:s,selectstart:r},this._xrSessionManager.session.addEventListener("selectstart",r),this._xrSessionManager.session.addEventListener("selectend",s)}}_convertNormalToDirectionOfRay(e,t){return e&&Math.acos(m.Dot(e,t.direction))<Math.PI/2&&e.scaleInPlace(-1),e}_detachController(e){let t=this._controllers[e];if(t){if(t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners){let i=Object.keys(t.eventListeners);for(let r of i){let s=t.eventListeners&&t.eventListeners[r];s&&this._xrSessionManager.session.removeEventListener(r,s)}}if(!t.finalPointerUpTriggered&&t.pointerDownTriggered){let i={pointerId:t.id,pointerType:"xr"};this._xrSessionManager.runInXRFrame(()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerUp(t.pick||new Ft,i),t.finalPointerUpTriggered=!0})}this._xrSessionManager.scene.onBeforeRenderObservable.addOnce(()=>{try{if(t.selectionMesh.dispose(),t.laserPointer.dispose(),delete this._controllers[e],this._attachedController===e){let i=Object.keys(this._controllers);i.length?this._attachedController=i[0]:this._attachedController=""}}catch{z.Warn("controller already detached.")}})}}_generateNewMeshPair(e){let t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||jr.DefaultUtilityLayer.utilityLayerScene:this._scene,i=this._options.customLasterPointerMeshGenerator?this._options.customLasterPointerMeshGenerator():aa("laserPointer",{height:1,diameterTop:2e-4,diameterBottom:.004,tessellation:20,subdivisions:1},t);i.parent=e;let r=new te("laserPointerMat",t);r.emissiveColor=this.laserPointerDefaultColor,r.alpha=.7,i.material=r,i.rotation.x=Math.PI/2,this._updatePointerDistance(i,1),i.isPickable=!1,i.isVisible=!1;let s=this._options.customSelectionMeshGenerator?this._options.customSelectionMeshGenerator():pr("gazeTracker",{diameter:.0035*3,thickness:.0025*3,tessellation:20},t);s.bakeCurrentTransformIntoVertices(),s.isPickable=!1,s.isVisible=!1;let o=new te("targetMat",t);return o.specularColor=U.Black(),o.emissiveColor=this.selectionMeshDefaultColor,o.backFaceCulling=!1,s.material=o,this._options.renderingGroupId!==void 0&&(i.renderingGroupId=this._options.renderingGroupId,s.renderingGroupId=this._options.renderingGroupId),{laserPointer:i,selectionMesh:s}}_pickingMoved(e,t){if(!e.hit||!t.hit||!e.pickedMesh||!e.pickedPoint||!t.pickedMesh||!t.pickedPoint||e.pickedMesh!==t.pickedMesh)return!0;e.pickedPoint?.subtractToRef(t.pickedPoint,this._tmpVectorForPickCompare),this._tmpVectorForPickCompare.set(Math.abs(this._tmpVectorForPickCompare.x),Math.abs(this._tmpVectorForPickCompare.y),Math.abs(this._tmpVectorForPickCompare.z));let i=(this._options.gazeModePointerMovedFactor||1)*.01*t.distance;return this._tmpVectorForPickCompare.length()>i}_updatePointerDistance(e,t=100){e.scaling.y=t,this._scene.useRightHandedSystem&&(t*=-1),e.position.z=t/2+.05}_augmentPointerInit(e,t,i){e.pointerId=t,e.pointerType="xr",i&&(e.screenX=i.x,e.screenY=i.y)}get lasterPointerDefaultColor(){return this.laserPointerDefaultColor}};qr._IdCounter=200;qr.Name=fn.POINTER_SELECTION;qr.Version=1;pn.AddWebXRFeature(qr.Name,(n,e)=>()=>new qr(n,e),qr.Version,!0);var O=(function(n){return n[n.Float=1]="Float",n[n.Int=2]="Int",n[n.Vector2=4]="Vector2",n[n.Vector3=8]="Vector3",n[n.Vector4=16]="Vector4",n[n.Color3=32]="Color3",n[n.Color4=64]="Color4",n[n.Matrix=128]="Matrix",n[n.Object=256]="Object",n[n.AutoDetect=1024]="AutoDetect",n[n.BasedOnInput=2048]="BasedOnInput",n[n.All=4095]="All",n})(O||{});var X=(function(n){return n[n.Vertex=1]="Vertex",n[n.Fragment=2]="Fragment",n[n.Neutral=4]="Neutral",n[n.VertexAndFragment=3]="VertexAndFragment",n})(X||{});var bh=class{constructor(){this.supportUniformBuffers=!1,this.attributes=[],this.uniforms=[],this.constants=[],this.samplers=[],this.functions={},this.extensions={},this.prePassOutput={},this.counters={},this._terminalBlocks=new Set,this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._injectAtTop="",this._customEntryHeader="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}get shaderLanguage(){return this.sharedData.nodeMaterial.shaderLanguage}get fSuffix(){return this.shaderLanguage===1?"f":""}getProcessedShaderAsync(e){return S(this,null,function*(){if(!this._builtCompilationString)return P.Error("getProcessedShaderAsync: Shader not built yet."),"";let t=this.sharedData.nodeMaterial.getScene().getEngine(),i={defines:e.split(`
`),indexParameters:void 0,isFragment:this.target===X.Fragment,shouldUseHighPrecisionShader:t._shouldUseHighPrecisionShader,processor:t._getShaderProcessor(this.shaderLanguage),supportsUniformBuffers:t.supportsUniformBuffers,shadersRepository:ht.GetShadersRepository(this.shaderLanguage),includesShadersStore:ht.GetIncludesShadersStore(this.shaderLanguage),version:(t.version*100).toString(),platformName:t.shaderPlatformName,processingContext:null,isNDCHalfZRange:t.isNDCHalfZRange,useReverseDepthBuffer:t.useReverseDepthBuffer};return!t.isWebGPU&&t.version>1&&(i.processor=new jT),yield new Promise(r=>{OT(this._builtCompilationString,i,(s,o)=>{r(s)},t)})})}finalize(e){let t=e.sharedData.emitComments,i=this.target===X.Fragment,r=`
${t?`//Entry point
`:""}`;this._customEntryHeader?r+=this._customEntryHeader:this.shaderLanguage===1?i?r+=`@fragment
fn main(input: FragmentInputs) -> FragmentOutputs {
${this.sharedData.varyingInitializationsFragment}`:r+=`@vertex
fn main(input: VertexInputs) -> FragmentInputs{
`:r+=`void main(void) {
`,this.compilationString=r+this.compilationString,this._constantDeclaration&&(this.compilationString=`
${t?`//Constants
`:""}${this._constantDeclaration}
${this.compilationString}`);let s="";for(let o in this.functions)s+=this.functions[o]+`
`;if(this.compilationString=`
${s}
${this.compilationString}`,!i&&this._varyingTransfer&&(this.compilationString=`${this.compilationString}
${this._varyingTransfer}`),this._injectAtEnd&&(this.compilationString=`${this.compilationString}
${this._injectAtEnd}`),this.compilationString=`${this.compilationString}
}`,this.sharedData.varyingDeclaration&&(this.compilationString=`
${t?`//Varyings
`:""}${i?this.sharedData.varyingDeclarationFragment:this.sharedData.varyingDeclaration}
${this.compilationString}`),this._samplerDeclaration&&(this.compilationString=`
${t?`//Samplers
`:""}${this._samplerDeclaration}
${this.compilationString}`),this._uniformDeclaration&&(this.compilationString=`
${t?`//Uniforms
`:""}${this._uniformDeclaration}
${this.compilationString}`),this._attributeDeclaration&&!i&&(this.compilationString=`
${t?`//Attributes
`:""}${this._attributeDeclaration}
${this.compilationString}`),this.shaderLanguage!==1){this.compilationString=`precision highp float;
`+this.compilationString,this.compilationString=`#if defined(WEBGL2) || defined(WEBGPU)
precision highp sampler2DArray;
#endif
`+this.compilationString,i&&(this.compilationString=`#if defined(PREPASS)\r
#extension GL_EXT_draw_buffers : require\r
layout(location = 0) out highp vec4 glFragData[SCENE_MRT_COUNT];\r
highp vec4 gl_FragColor;\r
#endif\r
`+this.compilationString);for(let o in this.extensions){let a=this.extensions[o];this.compilationString=`
${a}
${this.compilationString}`}}this._injectAtTop&&(this.compilationString=`${this._injectAtTop}
${this.compilationString}`),this._builtCompilationString=this.compilationString}get _repeatableContentAnchor(){return`###___ANCHOR${this._repeatableContentAnchorIndex++}___###`}_getFreeVariableName(e){return e=this.sharedData.formatConfig.formatVariablename(e),this.sharedData.variableNames[e]===void 0?(this.sharedData.variableNames[e]=0,e==="output"||e==="texture"?e+this.sharedData.variableNames[e]:e):(this.sharedData.variableNames[e]++,e+this.sharedData.variableNames[e])}_getFreeDefineName(e){return this.sharedData.defineNames[e]===void 0?this.sharedData.defineNames[e]=0:this.sharedData.defineNames[e]++,e+this.sharedData.defineNames[e]}_excludeVariableName(e){this.sharedData.variableNames[e]=0}_emit2DSampler(e,t="",i=!1,r,s,o){if(this.samplers.indexOf(e)<0||i){if(t&&(this._samplerDeclaration+=`#if ${t}
`),this.shaderLanguage===1){let a=s?"u":"f";this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;
`,this._samplerDeclaration+=`var ${e}: texture_2d<${a}32>;
`}else{let a=s?"u":"",l=o??"";this._samplerDeclaration+=`uniform ${l} ${a}sampler2D ${e}; ${r||""}
`}t&&(this._samplerDeclaration+=`#endif
`),i||this.samplers.push(e)}}_emitCubeSampler(e,t="",i=!1){(this.samplers.indexOf(e)<0||i)&&(t&&(this._samplerDeclaration+=`#if ${t}
`),this.shaderLanguage===1?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;
`,this._samplerDeclaration+=`var ${e}: texture_cube<f32>;
`):this._samplerDeclaration+=`uniform samplerCube ${e};
`,t&&(this._samplerDeclaration+=`#endif
`),i||this.samplers.push(e))}_emit2DArraySampler(e){this.samplers.indexOf(e)<0&&(this.shaderLanguage===1?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;
`,this._samplerDeclaration+=`var ${e}: texture_2d_array<f32>;
`):this._samplerDeclaration+=`uniform sampler2DArray ${e};
`,this.samplers.push(e))}_getGLType(e){switch(e){case O.Float:return"float";case O.Int:return"int";case O.Vector2:return"vec2";case O.Color3:case O.Vector3:return"vec3";case O.Color4:case O.Vector4:return"vec4";case O.Matrix:return"mat4"}return""}_getShaderType(e){let t=this.shaderLanguage===1;switch(e){case O.Float:return t?"f32":"float";case O.Int:return t?"i32":"int";case O.Vector2:return t?"vec2f":"vec2";case O.Color3:case O.Vector3:return t?"vec3f":"vec3";case O.Color4:case O.Vector4:return t?"vec4f":"vec4";case O.Matrix:return t?"mat4x4f":"mat4"}return""}_emitExtension(e,t,i=""){this.extensions[e]||(i&&(t=`#if ${i}
${t}
#endif`),this.extensions[e]=t)}_emitFunction(e,t,i){this.functions[e]||(this.sharedData.emitComments&&(t=i+`
`+t),this.functions[e]=t)}_emitCodeFromInclude(e,t,i){let r=ht.GetIncludesShadersStore(this.shaderLanguage);if(i&&i.repeatKey)return`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]
`;let s=r[e]+`
`;if(this.sharedData.emitComments&&(s=t+`
`+s),!i)return s;if(i.replaceStrings)for(let o=0;o<i.replaceStrings.length;o++){let a=i.replaceStrings[o];s=s.replace(a.search,a.replace)}return s}_emitFunctionFromInclude(e,t,i,r=""){let s=e+r;if(this.functions[s])return;let o=ht.GetIncludesShadersStore(this.shaderLanguage);if(!i||!i.removeAttributes&&!i.removeUniforms&&!i.removeVaryings&&!i.removeIfDef&&!i.replaceStrings){i&&i.repeatKey?this.functions[s]=`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]
`:this.functions[s]=`#include<${e}>${i?.substitutionVars?"("+i?.substitutionVars+")":""}
`,this.sharedData.emitComments&&(this.functions[s]=t+`
`+this.functions[s]);return}if(this.functions[s]=o[e],this.sharedData.emitComments&&(this.functions[s]=t+`
`+this.functions[s]),i.removeIfDef&&(this.functions[s]=this.functions[s].replace(/^\s*?#ifdef.+$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#endif.*$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#else.*$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#elif.*$/gm,"")),i.removeAttributes&&(this.functions[s]=this.functions[s].replace(/\s*?attribute .+?;/g,`
`)),i.removeUniforms&&(this.functions[s]=this.functions[s].replace(/\s*?uniform .*?;/g,`
`)),i.removeVaryings&&(this.functions[s]=this.functions[s].replace(/\s*?(varying|in) .+?;/g,`
`)),i.replaceStrings)for(let a=0;a<i.replaceStrings.length;a++){let l=i.replaceStrings[a];this.functions[s]=this.functions[s].replace(l.search,l.replace)}}_registerTempVariable(e){return this.sharedData.temps.indexOf(e)!==-1?!1:(this.sharedData.temps.push(e),!0)}_emitDefineStart(e,t=!1){let i="";return e&&(e.startsWith("defined(")?i=`#if ${e}
`:i=`${t?"#ifndef":"#ifdef"} ${e}
`),i}_emitDefineEnd(e){return e?`#endif
`:""}_emitVaryingFromString(e,t,i="",r=!1){if(this.sharedData.varyings.indexOf(e)!==-1)return!1;this.sharedData.varyings.push(e);let s=this._getShaderType(t),o=(a=!1)=>{let l=this._emitDefineStart(i,r);if(this.shaderLanguage===1)switch(s){case"i32":case"f32":case"vec2f":case"vec3f":case"vec4f":l+=`varying ${e}: ${s};
`,a&&(l+=`var<private> ${e}: ${s};
`,this.sharedData.varyingInitializationsFragment+=this._emitDefineStart(i,r)+`${e} = fragmentInputs.${e};
`+this._emitDefineEnd(i));break;case"mat4x4f":l+=`varying ${e}_r0: vec4f;
`,l+=`varying ${e}_r1: vec4f;
`,l+=`varying ${e}_r2: vec4f;
`,l+=`varying ${e}_r3: vec4f;
`,a&&(l+=`var<private> ${e}: mat4x4f;
`,this.sharedData.varyingInitializationsFragment+=this._emitDefineStart(i,r)+`${e} = mat4x4f(fragmentInputs.${e}_r0, fragmentInputs.${e}_r1, fragmentInputs.${e}_r2, fragmentInputs.${e}_r3);
`+this._emitDefineEnd(i));break;default:l+=`varying ${e}: ${s};
`;break}else l+=`varying ${s} ${e};
`;return l+=this._emitDefineEnd(i),l};if(this.shaderLanguage===1)this.sharedData.varyingDeclaration+=o(!1),this.sharedData.varyingDeclarationFragment+=o(!0);else{let a=o();this.sharedData.varyingDeclaration+=a,this.sharedData.varyingDeclarationFragment+=a}return!0}_getVaryingName(e){return this.shaderLanguage===1?(this.target!==X.Fragment?"vertexOutputs.":"fragmentInputs.")+e:e}_emitUniformFromString(e,t,i="",r=!1){if(this.uniforms.indexOf(e)!==-1)return;this.uniforms.push(e),i&&(i.startsWith("defined(")?this._uniformDeclaration+=`#if ${i}
`:this._uniformDeclaration+=`${r?"#ifndef":"#ifdef"} ${i}
`),this.sharedData.formatConfig.getUniformAnnotation&&(this._uniformDeclaration+=this.sharedData.formatConfig.getUniformAnnotation(e));let s=this._getShaderType(t);this.shaderLanguage===1?this._uniformDeclaration+=`uniform ${e}: ${s};
`:this._uniformDeclaration+=`uniform ${s} ${e};
`,i&&(this._uniformDeclaration+=`#endif
`)}_generateTernary(e,t,i){return this.shaderLanguage===1?`select(${t}, ${e}, ${i})`:`(${i}) ? ${e} : ${t}`}_emitFloat(e){return e.toString()===e.toFixed(0)?`${e}.0`:e.toString()}_declareOutput(e,t){return this._declareLocalVar(e.associatedVariableName,e.type,t)}_declareLocalVar(e,t,i,r){return this.shaderLanguage===1?`${i?"const":"var"+(r?"<private>":"")} ${e}: ${this._getShaderType(t)}`:`${i?"const ":""}${this._getShaderType(t)} ${e}`}_samplerCubeFunc(){return this.shaderLanguage===1?"textureSample":"textureCube"}_samplerFunc(){return this.shaderLanguage===1?"textureSample":"texture2D"}_samplerLODFunc(){return this.shaderLanguage===1?"textureSampleLevel":"texture2DLodEXT"}_toLinearSpace(e){return this.shaderLanguage===1?e.type===O.Color3||e.type===O.Vector3?`toLinearSpaceVec3(${e.associatedVariableName})`:`toLinearSpace(${e.associatedVariableName})`:`toLinearSpace(${e.associatedVariableName})`}_generateTextureSample(e,t){return this.shaderLanguage===1?`${this._samplerFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerFunc()}(${t}, ${e})`}_generateTextureSampleLOD(e,t,i){return this.shaderLanguage===1?`${this._samplerLODFunc()}(${t},${t+"Sampler"}, ${e}, ${i})`:`${this._samplerLODFunc()}(${t}, ${e}, ${i})`}_generateTextureSampleCube(e,t){return this.shaderLanguage===1?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerCubeFunc()}(${t}, ${e})`}_generateTextureSampleCubeLOD(e,t,i){return this.shaderLanguage===1?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e}, ${i})`:`${this._samplerCubeFunc()}(${t}, ${e}, ${i})`}_convertVariableDeclarationToWGSL(e,t,i){return i.replace(new RegExp(`(${e})\\s+(\\w+)`,"g"),`var $2: ${t}`)}_convertVariableConstructorsToWGSL(e,t,i){return i.replace(new RegExp(`(${e})\\(`,"g"),` ${t}(`)}_convertOutParametersToWGSL(e){return e.replace(new RegExp("out\\s+var\\s+(\\w+)\\s*:\\s*(\\w+)","g"),"$1: ptr<function, $2>")}_convertTernaryOperandsToWGSL(e){return e.replace(new RegExp("\\[(.*?)\\?(.*?):(.*)\\]","g"),(t,i,r,s)=>`select(${s}, ${r}, ${i})`)}_convertModOperatorsToWGSL(e){return e.replace(new RegExp("mod\\((.+?),\\s*(.+?)\\)","g"),(t,i,r)=>`((${i})%(${r}))`)}_convertConstToWGSL(e){return e.replace(new RegExp("const var","g"),"const")}_convertInnerFunctionsToWGSL(e){return e.replace(new RegExp("inversesqrt","g"),"inverseSqrt")}_convertFunctionsToWGSL(e){let t=/var\s+(\w+)\s*:\s*(\w+)\((.*)\)/g,i;for(;(i=t.exec(e))!==null;){let r=i[1],s=i[2],a=i[3].replace(/var\s/g,"");e=e.replace(i[0],`fn ${r}(${a}) -> ${s}`)}return e}_babylonSLtoWGSL(e){return e=this._convertVariableDeclarationToWGSL("void","voidnull",e),e=this._convertVariableDeclarationToWGSL("bool","bool",e),e=this._convertVariableDeclarationToWGSL("int","i32",e),e=this._convertVariableDeclarationToWGSL("uint","u32",e),e=this._convertVariableDeclarationToWGSL("float","f32",e),e=this._convertVariableDeclarationToWGSL("vec2","vec2f",e),e=this._convertVariableDeclarationToWGSL("vec3","vec3f",e),e=this._convertVariableDeclarationToWGSL("vec4","vec4f",e),e=this._convertVariableDeclarationToWGSL("mat2","mat2x2f",e),e=this._convertVariableDeclarationToWGSL("mat3","mat3x3f",e),e=this._convertVariableDeclarationToWGSL("mat4","mat4x4f",e),e=this._convertVariableConstructorsToWGSL("float","f32",e),e=this._convertVariableConstructorsToWGSL("vec2","vec2f",e),e=this._convertVariableConstructorsToWGSL("vec3","vec3f",e),e=this._convertVariableConstructorsToWGSL("vec4","vec4f",e),e=this._convertVariableConstructorsToWGSL("mat2","mat2x2f",e),e=this._convertVariableConstructorsToWGSL("mat3","mat3x3f",e),e=this._convertVariableConstructorsToWGSL("mat4","mat4x4f",e),e=this._convertTernaryOperandsToWGSL(e),e=this._convertModOperatorsToWGSL(e),e=this._convertConstToWGSL(e),e=this._convertInnerFunctionsToWGSL(e),e=this._convertOutParametersToWGSL(e),e=e.replace(/\[\*\]/g,"*"),e=this._convertFunctionsToWGSL(e),e=e.replace(/\s->\svoidnull/g,""),e=e.replace(/dFdx/g,"dpdx"),e=e.replace(/dFdy/g,"dpdy"),e}_convertTernaryOperandsToGLSL(e){return e.replace(new RegExp("\\[(.+?)\\?(.+?):(.+)\\]","g"),(t,i,r,s)=>`${i} ? ${r} : ${s}`)}_babylonSLtoGLSL(e){return e=e.replace(/\[\*\]/g,""),e=this._convertTernaryOperandsToGLSL(e),e}};var Pg=class{constructor(){this.temps=[],this.varyings=[],this.varyingDeclaration="",this.varyingDeclarationFragment="",this.varyingInitializationsFragment="",this.inputBlocks=[],this.textureBlocks=[],this.bindableBlocks=[],this.forcedBindableBlocks=[],this.blocksWithFallbacks=[],this.blocksWithDefines=[],this.repeatableContentBlocks=[],this.dynamicUniformBlocks=[],this.blockingBlocks=[],this.animatedInputs=[],this.formatConfig={getUniformAnnotation:null,formatVariablename:e=>e.replace(/[^a-zA-Z_]+/g,"")},this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array,customErrors:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}raiseBuildError(e){this.checks.customErrors.indexOf(e)!==-1&&this.checks.customErrors.push(e)}emitErrors(){let e="";!this.checks.emitVertex&&!this.allowEmptyVertexProgram&&(e+=`NodeMaterial does not have a vertex output. You need to at least add a block that generates a position value.
`),this.checks.emitFragment||(e+=`NodeMaterial does not have a fragment output. You need to at least add a block that generates a color value.
`);for(let t of this.checks.notConnectedNonOptionalInputs)e+=`input ${t.name} from block ${t.ownerBlock.name}[${t.ownerBlock.getClassName()}] is not connected and is not optional.
`;for(let t of this.checks.customErrors)e+=t+`
`;return e?(e=`Node material build failed: 
`+e,P.Error(e),this.nodeMaterial.onBuildErrorObservable.notifyObservers(e),!1):!0}};var xh=class n{static AreEquivalentTypes(e,t){switch(e){case O.Vector3:{if(t===O.Color3)return!0;break}case O.Vector4:{if(t===O.Color4)return!0;break}case O.Color3:{if(t===O.Vector3)return!0;break}case O.Color4:{if(t===O.Vector4)return!0;break}}return!1}get isInactive(){return this._isInactive}get _connectedPoint(){return this._connectedPointBackingField}set _connectedPoint(e){this._connectedPointBackingField!==e&&(this._connectedPointTypeChangedObserver?.remove(),this._updateTypeDependentState(()=>this._connectedPointBackingField=e),this._connectedPointBackingField&&(this._connectedPointTypeChangedObserver=this._connectedPointBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get _typeConnectionSource(){return this._typeConnectionSourceBackingField}set _typeConnectionSource(e){this._typeConnectionSourceBackingField!==e&&(this._typeConnectionSourceTypeChangedObserver?.remove(),this._updateTypeDependentState(()=>this._typeConnectionSourceBackingField=e),this._typeConnectionSourceBackingField&&(this._typeConnectionSourceTypeChangedObserver=this._typeConnectionSourceBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get _defaultConnectionPointType(){return this._defaultConnectionPointTypeBackingField}set _defaultConnectionPointType(e){this._updateTypeDependentState(()=>this._defaultConnectionPointTypeBackingField=e)}get _linkedConnectionSource(){return this._linkedConnectionSourceBackingField}set _linkedConnectionSource(e){this._linkedConnectionSourceBackingField!==e&&(this._linkedConnectionSourceTypeChangedObserver?.remove(),this._updateTypeDependentState(()=>this._linkedConnectionSourceBackingField=e),this._isMainLinkSource=!1,this._linkedConnectionSourceBackingField&&(this._linkedConnectionSourceTypeChangedObserver=this._linkedConnectionSourceBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get direction(){return this._direction}get declarationVariableName(){return this._ownerBlock.isInput?this._ownerBlock.declarationVariableName:(!this._enforceAssociatedVariableName||!this._associatedVariableName)&&this._connectedPoint?this._connectedPoint.declarationVariableName:this._associatedVariableName}get associatedVariableName(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:(!this._enforceAssociatedVariableName||!this._associatedVariableName)&&this._connectedPoint?this._connectedPoint.associatedVariableName:this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get innerType(){return this._linkedConnectionSource&&!this._isMainLinkSource&&this._linkedConnectionSource.isConnected?this.type:this._type}get type(){if(this._type===O.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource){if(this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.connectedPoint._redirectedSource&&this._linkedConnectionSource.connectedPoint._redirectedSource.isConnected?this._linkedConnectionSource.connectedPoint._redirectedSource.type:this._linkedConnectionSource.type;if(this._linkedConnectionSource._defaultConnectionPointType)return this._linkedConnectionSource._defaultConnectionPointType}if(this._defaultConnectionPointType)return this._defaultConnectionPointType}if(this._type===O.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._updateTypeDependentState(()=>this._type=e)}get target(){return!this._prioritizeVertex||!this._ownerBlock?this._target:this._target!==X.VertexAndFragment?this._target:this._ownerBlock.target===X.Fragment?X.Fragment:X.Vertex}set target(e){this._target=e}get isConnected(){return this.connectedPoint!==null||this.hasEndpoints}get isConnectedToInputBlock(){return this.connectedPoint!==null&&this.connectedPoint.ownerBlock.isInput}get connectInputBlock(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return this._endpoints.length===0?[]:this._endpoints.map(e=>e.ownerBlock)}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get isDirectlyConnectedToVertexOutput(){if(!this.hasEndpoints)return!1;for(let e of this._endpoints)if(e.ownerBlock.target===X.Vertex||(e.ownerBlock.target===X.Neutral||e.ownerBlock.target===X.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isDirectlyConnectedToVertexOutput))return!0;return!1}get isConnectedInVertexShader(){if(this.target===X.Vertex)return!0;if(!this.hasEndpoints)return!1;for(let e of this._endpoints)if(e.ownerBlock.target===X.Vertex||e.target===X.Vertex||(e.ownerBlock.target===X.Neutral||e.ownerBlock.target===X.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isConnectedInVertexShader))return!0;return!1}get isConnectedInFragmentShader(){if(this.target===X.Fragment)return!0;if(!this.hasEndpoints)return!1;for(let e of this._endpoints)if(e.ownerBlock.target===X.Fragment||(e.ownerBlock.target===X.Neutral||e.ownerBlock.target===X.VertexAndFragment)&&e.ownerBlock.isConnectedInFragmentShader())return!0;return!1}createCustomInputBlock(){return null}constructor(e,t,i){this._isInactive=!1,this._preventBubbleUp=!1,this._connectedPointBackingField=null,this._endpoints=new Array,this._redirectedSource=null,this._typeConnectionSourceBackingField=null,this._defaultConnectionPointTypeBackingField=null,this._isMainLinkSource=!1,this._linkedConnectionSourceBackingField=null,this._acceptedConnectionPointType=null,this._type=O.Float,this._enforceAssociatedVariableName=!1,this._forPostBuild=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new F,this.onDisconnectionObservable=new F,this.onTypeChangedObservable=new F,this._isTypeChangeObservableNotifying=!1,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=X.VertexAndFragment,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeMaterialConnectionPoint"}canConnectTo(e){return this.checkCompatibilityState(e)===0}checkCompatibilityState(e){let t=this._ownerBlock,i=e.ownerBlock;if(t.target===X.Fragment){if(i.target===X.Vertex)return 2;for(let o of i.outputs)if(o.ownerBlock.target!=X.Neutral&&o.isConnectedInVertexShader)return 2}if(this.type!==e.type&&e.innerType!==O.AutoDetect)return n.AreEquivalentTypes(this.type,e.type)||e.acceptedConnectionPointTypes&&e.acceptedConnectionPointTypes.indexOf(this.type)!==-1||e._acceptedConnectionPointType&&n.AreEquivalentTypes(e._acceptedConnectionPointType.type,this.type)?0:1;if(e.excludedConnectionPointTypes&&e.excludedConnectionPointTypes.indexOf(this.type)!==-1)return 1;let r=i,s=t;return this.direction===0&&(r=t,s=i),r.isAnAncestorOf(s)?3:0}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw`Cannot connect these two connectors. source: "${this.ownerBlock.name}".${this.name}, target: "${e.ownerBlock.name}".${e.name}`;return this._endpoints.push(e),e._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){let t=this._endpoints.indexOf(e);return t===-1?this:(this._endpoints.splice(t,1),e._connectedPoint=null,this._enforceAssociatedVariableName=!1,e._enforceAssociatedVariableName=!1,this.onDisconnectionObservable.notifyObservers(e),e.onDisconnectionObservable.notifyObservers(this),this)}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<O.All;)e&t||this.excludedConnectionPointTypes.push(t),t=t<<1}serialize(e=!0){let t={};return t.name=this.name,this.displayName&&(t.displayName=this.displayName),e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear(),this.onDisconnectionObservable.clear(),this.onTypeChangedObservable.clear(),this._connectedPoint=null,this._typeConnectionSource=null,this._linkedConnectionSource=null}_updateTypeDependentState(e){let t=this.type;e(),this.type!==t&&this._notifyTypeChanged()}_notifyTypeChanged(){this._isTypeChangeObservableNotifying||(this._isTypeChangeObservableNotifying=!0,this.onTypeChangedObservable.notifyObservers(this.type),this._isTypeChangeObservableNotifying=!1)}};var yt=class{get _isFinalOutputAndActive(){return this._isFinalOutput}get _hasPrecedence(){return!1}get name(){return this._name}get codeIsReady(){return this._codeIsReady}set name(e){this.validateBlockName(e)&&(this._name=e)}get isUnique(){return this._isUnique}get isFinalMerger(){return this._isFinalMerger}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get isLoop(){return this._isLoop}get buildId(){return this._buildId}set buildId(e){this._buildId=e}get target(){return this._target}set target(e){(this._target&e)===0&&(this._target=e)}get inputs(){return this._inputs}get outputs(){return this._outputs}getInputByName(e){let t=this._inputs.filter(i=>i.name===e);return t.length?t[0]:null}getOutputByName(e){let t=this._outputs.filter(i=>i.name===e);return t.length?t[0]:null}constructor(e,t=X.Vertex,i=!1,r=!1){switch(this._isFinalMerger=!1,this._isInput=!1,this._isLoop=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._name="",this._isUnique=!1,this._codeIsReady=!0,this._isFinalOutput=!1,this.onCodeIsReadyObservable=new F,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=t,this._originalTargetIsNeutral=t===X.Neutral,this._isFinalMerger=i,this._isFinalOutput=r,this.getClassName()){case"InputBlock":this._isInput=!0;break;case"NodeMaterialTeleportOutBlock":this._isTeleportOut=!0;break;case"NodeMaterialTeleportInBlock":this._isTeleportIn=!0;break;case"LoopBlock":this._isLoop=!0;break}this._name=e,this.uniqueId=kh.UniqueId}_setInitialTarget(e){this._target=e,this._originalTargetIsNeutral=e===X.Neutral}initialize(e){}bind(e,t,i,r){}_writeVariable(e){return e.connectedPoint?`${e.associatedVariableName}`:"0."}_writeFloat(e){let t=e.toString();return t.indexOf(".")===-1&&(t+=".0"),`${t}`}getClassName(){return"NodeMaterialBlock"}isConnectedInFragmentShader(){return this.outputs.some(e=>e.isConnectedInFragmentShader)}registerInput(e,t,i=!1,r,s){return s=s??new xh(e,this,0),s.type=t,s.isOptional=i,r&&(s.target=r),this._inputs.push(s),this}registerOutput(e,t,i,r){return r=r??new xh(e,this,1),r.type=t,i&&(r.target=i),this._outputs.push(r),this}getFirstAvailableInput(e=null){for(let t of this._inputs)if(!t.connectedPoint&&(!e||e.type===t.type||t.type===O.AutoDetect||t.acceptedConnectionPointTypes.indexOf(e.type)!==-1))return t;return null}getFirstAvailableOutput(e=null){for(let t of this._outputs)if(!e||!e.target||e.target===X.Neutral||(e.target&t.target)!==0)return t;return null}getSiblingOutput(e){let t=this._outputs.indexOf(e);return t===-1||t>=this._outputs.length?null:this._outputs[t+1]}isAnAncestorOf(e){for(let t of this._outputs)if(t.hasEndpoints){for(let i of t.endpoints)if(i.ownerBlock===e||i.ownerBlock.isAnAncestorOf(e))return!0}return!1}connectTo(e,t){if(this._outputs.length===0)return;let i=t&&t.output?this.getOutputByName(t.output):this.getFirstAvailableOutput(e),r=!0;for(;r;){let s=t&&t.input?e.getInputByName(t.input):e.getFirstAvailableInput(i);if(i&&s&&i.canConnectTo(s))i.connectTo(s),r=!1;else if(i)i=this.getSiblingOutput(i);else throw"Unable to find a compatible match"}return this}_buildBlock(e){}_postBuildBlock(e){}updateUniformsAndSamples(e,t,i,r){}provideFallbacks(e,t){}initializeDefines(e){}prepareDefines(e,t,i,r=!1,s){}autoConfigure(e,t=()=>!0){}replaceRepeatableContent(e,t,i){}get willBeGeneratedIntoVertexShaderFromFragmentShader(){return this.isInput||this.isFinalMerger||this._outputs.some(e=>e.isDirectlyConnectedToVertexOutput)||this.target===X.Vertex?!1:!!((this.target===X.VertexAndFragment||this.target===X.Neutral)&&this._outputs.some(e=>e.isConnectedInVertexShader))}isReady(e,t,i,r=!1){return!0}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:(this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[e]._isMainLinkSource=!0),this._inputs[t]._linkedConnectionSource=this._inputs[e]}_processBuild(e,t,i,r){e.build(t,r);let s=t._vertexState!=null,o=e._buildTarget===X.Vertex&&e.target!==X.VertexAndFragment;if(!(e.isTeleportOut&&e.entryPoint?.isConnectedToUniform)&&s&&((e.target&e._buildTarget)===0||(e.target&i.target)===0||this.target!==X.VertexAndFragment&&o)&&(!e.isInput&&t.target!==e._buildTarget||e.isInput&&e.isAttribute&&!e._noContextSwitch)){let a=i.connectedPoint;if(t._vertexState._emitVaryingFromString("v_"+a.declarationVariableName,a.type)){let c=t.shaderLanguage===1?"vertexOutputs.":"";t.shaderLanguage===1&&a.type===O.Matrix?(t._vertexState.compilationString+=`${c}${"v_"+a.declarationVariableName}_r0 = ${a.associatedVariableName}[0];
`,t._vertexState.compilationString+=`${c}${"v_"+a.declarationVariableName}_r1 = ${a.associatedVariableName}[1];
`,t._vertexState.compilationString+=`${c}${"v_"+a.declarationVariableName}_r2 = ${a.associatedVariableName}[2];
`,t._vertexState.compilationString+=`${c}${"v_"+a.declarationVariableName}_r3 = ${a.associatedVariableName}[3];
`):t._vertexState.compilationString+=`${c}${"v_"+a.declarationVariableName} = ${a.associatedVariableName};
`}let l=t.shaderLanguage===1&&a.type!==O.Matrix?"fragmentInputs.":"";i.associatedVariableName=l+"v_"+a.declarationVariableName,i._enforceAssociatedVariableName=!0}}validateBlockName(e){let t=["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","postprocess_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"];for(let i of t)if(e===i)return!1;return!0}_customBuildStep(e,t){}build(e,t){if(this._buildId===e.sharedData.buildId)return!0;if(!this.isInput)for(let i of this._outputs)i.associatedVariableName||(i.associatedVariableName=e._getFreeVariableName(i.name));for(let i of this._inputs){if(!i.connectedPoint){i.isOptional||e.sharedData.checks.notConnectedNonOptionalInputs.push(i);continue}if(this.target!==X.Neutral&&((i.target&this.target)===0||(i.target&e.target)===0))continue;let r=i.connectedPoint.ownerBlock;r&&r!==this&&this._processBuild(r,e,i,t)}if(this._customBuildStep(e,t),this._buildId===e.sharedData.buildId)return!0;if(e.sharedData.verbose&&P.Log(`${e.target===X.Vertex?"Vertex shader":"Fragment shader"}: Building ${this.name} [${this.getClassName()}]`),this.isFinalMerger)switch(e.target){case X.Vertex:e.sharedData.checks.emitVertex=!0;break;case X.Fragment:e.sharedData.checks.emitFragment=!0;break}!this.isInput&&e.sharedData.emitComments&&(e.compilationString+=`
//${this.name}
`),this._buildBlock(e),this._buildId=e.sharedData.buildId,this._buildTarget=e.target;for(let i of this._outputs)if(!i._forPostBuild&&(i.target&e.target)!==0)for(let r of i.endpoints){let s=r.ownerBlock;s&&((s.target&e.target)!==0&&t.indexOf(s)!==-1||e._terminalBlocks.has(s))&&this._processBuild(s,e,r,t)}this._postBuildBlock(e);for(let i of this._outputs)if(i._forPostBuild&&(i.target&e.target)!==0)for(let r of i.endpoints){let s=r.ownerBlock;s&&(s.target&e.target)!==0&&t.indexOf(s)!==-1&&this._processBuild(s,e,r,t)}return!1}_inputRename(e){return e}_outputRename(e){return e}_dumpPropertiesCode(){let e=this._codeVariableName;return`${e}.visibleInInspector = ${this.visibleInInspector};
${e}.visibleOnFrame = ${this.visibleOnFrame};
${e}.target = ${this.target};
`}_dumpCode(e,t){t.push(this);let i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,e.indexOf(this._codeVariableName)!==-1){let s=0;do s++,this._codeVariableName=i+s;while(e.indexOf(this._codeVariableName)!==-1)}e.push(this._codeVariableName);let r=`
// ${this.getClassName()}
`;this.comments&&(r+=`// ${this.comments}
`),r+=`var ${this._codeVariableName} = new BABYLON.${this.getClassName()}("${this.name}");
`,r+=this._dumpPropertiesCode();for(let s of this.inputs){if(!s.isConnected)continue;let a=s.connectedPoint.ownerBlock;t.indexOf(a)===-1&&(r+=a._dumpCode(e,t))}for(let s of this.outputs)if(s.hasEndpoints)for(let o of s.endpoints){let a=o.ownerBlock;a&&t.indexOf(a)===-1&&(r+=a._dumpCode(e,t))}return r}_dumpCodeForOutputConnections(e){let t="";if(e.indexOf(this)!==-1)return t;e.push(this);for(let i of this.inputs){if(!i.isConnected)continue;let r=i.connectedPoint,s=r.ownerBlock;t+=s._dumpCodeForOutputConnections(e),t+=`${s._codeVariableName}.${s._outputRename(r.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});
`}return t}clone(e,t=""){let i=this.serialize(),r=vt(i.customType);if(r){let s=new r;return s._deserialize(i,e,t),s}return null}serialize(){let e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.comments=this.comments,e.visibleInInspector=this.visibleInInspector,e.visibleOnFrame=this.visibleOnFrame,e.target=this.target,e.inputs=[],e.outputs=[];for(let t of this.inputs)e.inputs.push(t.serialize());for(let t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e,t,i,r){this.name=e.name,this.comments=e.comments,this.visibleInInspector=!!e.visibleInInspector,this.visibleOnFrame=!!e.visibleOnFrame,this._target=e.target??this.target,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){let t=e.inputs,i=e.outputs;if(t)for(let r=0;r<t.length;r++){let s=t[r];s.displayName&&(this.inputs[r].displayName=s.displayName),s.isExposedOnFrame&&(this.inputs[r].isExposedOnFrame=s.isExposedOnFrame,this.inputs[r].exposedPortPosition=s.exposedPortPosition)}if(i)for(let r=0;r<i.length;r++){let s=i[r];s.displayName&&(this.outputs[r].displayName=s.displayName),s.isExposedOnFrame&&(this.outputs[r].isExposedOnFrame=s.isExposedOnFrame,this.outputs[r].exposedPortPosition=s.exposedPortPosition)}}dispose(){this.onCodeIsReadyObservable.clear();for(let e of this.inputs)e.dispose();for(let e of this.outputs)e.dispose()}};function Yr(n,e=0,t="PROPERTIES",i){return(r,s)=>{let o=r._propStore;o||(o=[],r._propStore=o),o.push({propertyName:s,displayName:n,type:e,groupName:t,options:i??{},className:r.getClassName()})}}var Cs=(function(n){return n[n.NoColorSpace=0]="NoColorSpace",n[n.Gamma=1]="Gamma",n[n.Linear=2]="Linear",n})(Cs||{}),jn=class extends yt{constructor(e){super(e,X.Fragment,!0,!0),this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.useLogarithmicDepth=!1,this.registerInput("rgba",O.Color4,!0),this.registerInput("rgb",O.Color3,!0),this.registerInput("a",O.Float,!0),this.registerInput("glow",O.Color3,!0),this.rgb.acceptedConnectionPointTypes.push(O.Vector3),this.rgb.acceptedConnectionPointTypes.push(O.Float),this.additionalColor.acceptedConnectionPointTypes.push(O.Vector3),this.additionalColor.acceptedConnectionPointTypes.push(O.Float)}get colorSpace(){return this.convertToGammaSpace?Cs.Gamma:this.convertToLinearSpace?Cs.Linear:Cs.NoColorSpace}set colorSpace(e){this.convertToGammaSpace=e===Cs.Gamma,this.convertToLinearSpace=e===Cs.Linear}getClassName(){return"FragmentOutputBlock"}initialize(e){e._excludeVariableName("logarithmicDepthConstant"),e._excludeVariableName("vFragmentDepth")}get rgba(){return this._inputs[0]}get rgb(){return this._inputs[1]}get a(){return this._inputs[2]}get additionalColor(){return this._inputs[3]}get glow(){return this._inputs[3]}_getOutputString(e){return e.shaderLanguage===1?"fragmentOutputsColor":"gl_FragColor"}prepareDefines(e,t){e.setValue(this._linearDefineName,this.convertToLinearSpace,!0),e.setValue(this._gammaDefineName,this.convertToGammaSpace,!0),e.setValue(this._additionalColorDefineName,this.additionalColor.connectedPoint&&t._useAdditionalColor,!0)}bind(e,t,i){(this.useLogarithmicDepth||t.useLogarithmicDepth)&&i&&Si(void 0,e,i.getScene())}_buildBlock(e){super._buildBlock(e);let t=this.rgba,i=this.rgb,r=this.a,s=this.additionalColor,o=e.shaderLanguage===1;e.sharedData.hints.needAlphaBlending=t.isConnected||r.isConnected,e.sharedData.blocksWithDefines.push(this),(this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth)&&(e._emitUniformFromString("logarithmicDepthConstant",O.Float),e._emitVaryingFromString("vFragmentDepth",O.Float),e.sharedData.bindableBlocks.push(this)),s.connectedPoint&&(e._excludeVariableName("useAdditionalColor"),e._emitUniformFromString("useAdditionalColor",O.Float),this._additionalColorDefineName=e._getFreeDefineName("USEADDITIONALCOLOR")),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA");let a=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",a);let l=this._getOutputString(e);e.shaderLanguage===1&&(e.compilationString+=`var ${l} : vec4<f32>;\r
`);let c=e._getShaderType(O.Vector4);if(s.connectedPoint){let u="1.0";r.connectedPoint&&(u=r.associatedVariableName),e.compilationString+=`#ifdef ${this._additionalColorDefineName}
`,s.connectedPoint.type===O.Float?e.compilationString+=`${l}  = ${c}(${s.associatedVariableName}, ${s.associatedVariableName}, ${s.associatedVariableName}, ${u});
`:e.compilationString+=`${l}  = ${c}(${s.associatedVariableName}, ${u});
`,e.compilationString+=`#else
`}if(t.connectedPoint)r.isConnected?e.compilationString+=`${l} = ${c}(${t.associatedVariableName}.rgb, ${r.associatedVariableName});
`:e.compilationString+=`${l}  = ${t.associatedVariableName};
`;else if(i.connectedPoint){let u="1.0";r.connectedPoint&&(u=r.associatedVariableName),i.connectedPoint.type===O.Float?e.compilationString+=`${l}  = ${c}(${i.associatedVariableName}, ${i.associatedVariableName}, ${i.associatedVariableName}, ${u});
`:e.compilationString+=`${l}  = ${c}(${i.associatedVariableName}, ${u});
`}else e.sharedData.checks.notConnectedNonOptionalInputs.push(t);if(s.connectedPoint&&(e.compilationString+=`#endif
`),e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${l}  = toLinearSpace(${l});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${l}  = toGammaSpace(${l});
`,e.compilationString+=`#endif
`,e.shaderLanguage===1&&(e.compilationString+=`#if !defined(PREPASS)\r
`,e.compilationString+=`fragmentOutputs.color = ${l};\r
`,e.compilationString+=`#endif\r
`),this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth){let u=o?"input.vFragmentDepth":"vFragmentDepth",h=o?"uniforms.":"",d=o?"fragmentOutputs.fragDepth":"gl_FragDepthEXT";e.compilationString+=`${d} = log2(${u}) * ${h}logarithmicDepthConstant * 0.5;
`}return e.compilationString+=`#if defined(PREPASS)\r
`,e.compilationString+=`${o?"fragmentOutputs.fragData0":"gl_FragData[0]"} = ${l};\r
`,e.compilationString+=`#endif\r
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};
`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};
`,e+=`${this._codeVariableName}.useLogarithmicDepth = ${this.useLogarithmicDepth};
`,e}serialize(){let e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.useLogarithmicDepth=this.useLogarithmicDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.useLogarithmicDepth=e.useLogarithmicDepth??!1}};w([Yr("Use logarithmic depth",0,"PROPERTIES",{embedded:!0})],jn.prototype,"useLogarithmicDepth",void 0);w([Yr("Color space",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"No color space",value:Cs.NoColorSpace},{label:"Gamma",value:Cs.Gamma},{label:"Linear",value:Cs.Linear}]})],jn.prototype,"colorSpace",null);le("BABYLON.FragmentOutputBlock",jn);var ui=(function(n){return n[n.Material=0]="Material",n[n.PostProcess=1]="PostProcess",n[n.Particle=2]="Particle",n[n.ProceduralTexture=3]="ProceduralTexture",n[n.GaussianSplatting=4]="GaussianSplatting",n[n.SFE=5]="SFE",n})(ui||{});var st=(function(n){return n[n.World=1]="World",n[n.View=2]="View",n[n.Projection=3]="Projection",n[n.ViewProjection=4]="ViewProjection",n[n.WorldView=5]="WorldView",n[n.WorldViewProjection=6]="WorldViewProjection",n[n.CameraPosition=7]="CameraPosition",n[n.FogColor=8]="FogColor",n[n.DeltaTime=9]="DeltaTime",n[n.CameraParameters=10]="CameraParameters",n[n.MaterialAlpha=11]="MaterialAlpha",n[n.ProjectionInverse=12]="ProjectionInverse",n})(st||{});var Kr=(function(n){return n[n.None=0]="None",n[n.Time=1]="Time",n[n.RealTime=2]="RealTime",n[n.MouseInfo=3]="MouseInfo",n})(Kr||{});var Kk={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW",postprocess_uv:"vUV"},gT={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0,postprocess_uv:!0},jD={particle_texturemask:!0},qD={normal:"NORMAL",tangent:"TANGENT",uv:"UV1",uv2:"UV2",uv3:"UV3",uv4:"UV4",uv5:"UV5",uv6:"UV6",uv7:"UV7",uv8:"UV8"},$t=class extends yt{get type(){if(this._type===O.AutoDetect){if(this.isUniform&&this.value!=null){if(!isNaN(this.value))return this._type=O.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=O.Vector2,this._type;case"Vector3":return this._type=O.Vector3,this._type;case"Vector4":return this._type=O.Vector4,this._type;case"Color3":return this._type=O.Color3,this._type;case"Color4":return this._type=O.Color4,this._type;case"Matrix":return this._type=O.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"splatIndex":return this._type=O.Float,this._type;case"position":case"normal":case"particle_positionw":case"splatPosition":return this._type=O.Vector3,this._type;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":case"splatScale":case"postprocess_uv":return this._type=O.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"matricesIndicesExtra":case"matricesWeightsExtra":case"world0":case"world1":case"world2":case"world3":case"tangent":return this._type=O.Vector4,this._type;case"color":case"instanceColor":case"particle_color":case"particle_texturemask":case"splatColor":return this._type=O.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case st.World:case st.WorldView:case st.WorldViewProjection:case st.View:case st.ViewProjection:case st.Projection:case st.ProjectionInverse:return this._type=O.Matrix,this._type;case st.CameraPosition:return this._type=O.Vector3,this._type;case st.FogColor:return this._type=O.Color3,this._type;case st.DeltaTime:case st.MaterialAlpha:return this._type=O.Float,this._type;case st.CameraParameters:return this._type=O.Vector4,this._type}}return this._type}constructor(e,t=X.Vertex,i=O.AutoDetect){super(e,t,!1),this._mode=3,this._animationType=Kr.None,this._prefix="",this.min=0,this.max=0,this.isBoolean=!1,this.matrixMode=0,this._systemValue=null,this.isConstant=!1,this.groupInInspector="",this.onValueChangedObservable=new F,this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._type=i,this.setDefaultValue(),this.registerOutput("output",i)}validateBlockName(e){return this.isAttribute?!0:super.validateBlockName(e)}get output(){return this._outputs[0]}setAsAttribute(e){return this._mode=1,e&&(this.name=e),this}setAsSystemValue(e){return this.systemValue=e,this}get value(){return this._storedValue}set value(e){this.type===O.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=0,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e,this._mode=0}get declarationVariableName(){return this._associatedVariableName}get associatedVariableName(){return this._prefix+this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get animationType(){return this._animationType}set animationType(e){this._animationType=e}get isUndefined(){return this._mode===3}get isUniform(){return this._mode===0}set isUniform(e){this._mode=e?0:3,this.associatedVariableName=""}get isAttribute(){return this._mode===1}set isAttribute(e){this._mode=e?1:3,this.associatedVariableName=""}get isVarying(){return this._mode===2}set isVarying(e){this._mode=e?2:3,this.associatedVariableName=""}get isSystemValue(){return this._systemValue!=null}get systemValue(){return this._systemValue}set systemValue(e){this._mode=0,this.associatedVariableName="",this._systemValue=e}getClassName(){return"InputBlock"}animate(e){switch(this._animationType){case Kr.Time:{this.type===O.Float&&(this.value+=e.getAnimationRatio()*.01);break}case Kr.RealTime:{this.type===O.Float&&(this.value=(Xn.Now-e.getEngine().startTime)/1e3);break}case Kr.MouseInfo:{if(this.type===O.Vector4){let t=e._inputManager._originMouseEvent;if(t){let i=t.offsetX,r=t.offsetY,s=(t.buttons&1)!=0?1:0,o=(t.buttons&2)!=0?1:0;this.value=new dt(i,r,s,o)}else this.value=new dt(0,0,0,0)}break}}}_emitDefine(e,t=!1){return`${t?"#ifndef":"#ifdef"} ${e}
`}initialize(){this.associatedVariableName=""}setDefaultValue(){switch(this.type){case O.Float:this.value=0;break;case O.Vector2:this.value=me.Zero();break;case O.Vector3:this.value=m.Zero();break;case O.Vector4:this.value=dt.Zero();break;case O.Color3:this.value=U.White();break;case O.Color4:this.value=new ce(1,1,1,1);break;case O.Matrix:this.value=L.Identity();break}}_emitConstant(e){switch(this.type){case O.Float:return`${e._emitFloat(this.value)}`;case O.Vector2:return`vec2(${this.value.x}, ${this.value.y})`;case O.Vector3:return`vec3(${this.value.x}, ${this.value.y}, ${this.value.z})`;case O.Vector4:return`vec4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;case O.Color3:return ot.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&ot.Color3[0].toGammaSpaceToRef(ot.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&ot.Color3[0].toLinearSpaceToRef(ot.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec3(${ot.Color3[0].r}, ${ot.Color3[0].g}, ${ot.Color3[0].b})`;case O.Color4:return ot.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&ot.Color4[0].toGammaSpaceToRef(ot.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&ot.Color4[0].toLinearSpaceToRef(ot.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec4(${ot.Color4[0].r}, ${ot.Color4[0].g}, ${ot.Color4[0].b}, ${ot.Color4[0].a})`}return""}get _noContextSwitch(){return gT[this.name]}_emit(e){if(this.isUniform){if(this._associatedVariableName||(this._associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(e.constants.indexOf(this.associatedVariableName)!==-1)return;e.constants.push(this.associatedVariableName),e._constantDeclaration+=e._declareOutput(this.output,!0)+` = ${this._emitConstant(e)};
`;return}if(e.uniforms.indexOf(this.associatedVariableName)!==-1)return;e._emitUniformFromString(this._associatedVariableName,this.type),e.shaderLanguage===1&&(this._prefix="uniforms.");let t=e.sharedData.hints;if(this._systemValue!==null&&this._systemValue!==void 0)switch(this._systemValue){case st.WorldView:t.needWorldViewMatrix=!0;break;case st.WorldViewProjection:t.needWorldViewProjectionMatrix=!0;break}else this._animationType!==Kr.None&&e.sharedData.animatedInputs.push(this);return}if(this.isAttribute){if(this.associatedVariableName=Kk[this.name]??this.name,this.target===X.Vertex&&e._vertexState){gT[this.name]?jD[this.name]?(e._emitUniformFromString(this.declarationVariableName,this.type),e.shaderLanguage===1&&(this._prefix="vertexInputs.")):e._emitVaryingFromString(this.declarationVariableName,this.type):this._emit(e._vertexState);return}let t=e.attributes.indexOf(this.declarationVariableName)!==-1;if(t||e.attributes.push(this.declarationVariableName),gT[this.name])jD[this.name]?(t||e._emitUniformFromString(this.declarationVariableName,this.type),e.shaderLanguage===1&&(this._prefix="uniforms.")):(t||e._emitVaryingFromString(this.declarationVariableName,this.type),e.shaderLanguage===1&&(this._prefix="fragmentInputs."));else if(e.shaderLanguage===1){if(!t){let i=qD[this.name];i?(e._attributeDeclaration+=this._emitDefine(i),e._attributeDeclaration+=`attribute ${this.declarationVariableName}: ${e._getShaderType(this.type)};
`,e._attributeDeclaration+=`#else
`,e._attributeDeclaration+=`var<private> ${this.declarationVariableName}: ${e._getShaderType(this.type)} = ${e._getShaderType(this.type)}(0.);
`,e._attributeDeclaration+=`#endif
`):e._attributeDeclaration+=`attribute ${this.declarationVariableName}: ${e._getShaderType(this.type)};
`}this._prefix="vertexInputs."}else if(!t){let i=qD[this.name];i?(e._attributeDeclaration+=this._emitDefine(i),e._attributeDeclaration+=`attribute ${e._getShaderType(this.type)} ${this.declarationVariableName};
`,e._attributeDeclaration+=`#else
`,e._attributeDeclaration+=`${e._getShaderType(this.type)} ${this.declarationVariableName} = ${e._getShaderType(this.type)}(0.);
`,e._attributeDeclaration+=`#endif
`):e._attributeDeclaration+=`attribute ${e._getShaderType(this.type)} ${this.declarationVariableName};
`}}}_transmitWorld(e,t,i,r){if(!this._systemValue)return;let s=this._associatedVariableName;switch(this._systemValue){case st.World:e.setMatrix(s,t);break;case st.WorldView:e.setMatrix(s,i);break;case st.WorldViewProjection:e.setMatrix(s,r);break}}_transmit(e,t,i){if(this.isAttribute)return;let r=this._associatedVariableName;if(this._systemValue){switch(this._systemValue){case st.World:case st.WorldView:case st.WorldViewProjection:return;case st.View:e.setMatrix(r,t.getViewMatrix());break;case st.Projection:e.setMatrix(r,t.getProjectionMatrix());break;case st.ProjectionInverse:{t.getProjectionMatrix().invertToRef(k.Matrix[0]),e.setMatrix(r,k.Matrix[0]);break}case st.ViewProjection:e.setMatrix(r,t.getTransformMatrix());break;case st.CameraPosition:t.bindEyePosition(e,r,!0);break;case st.FogColor:e.setColor3(r,t.fogColor);break;case st.DeltaTime:e.setFloat(r,t.deltaTime/1e3);break;case st.CameraParameters:t.activeCamera&&e.setFloat4(r,t.getEngine().hasOriginBottomLeft?-1:1,t.activeCamera.minZ,t.activeCamera.maxZ,1/t.activeCamera.maxZ);break;case st.MaterialAlpha:e.setFloat(r,i.alpha);break}return}let s=this._valueCallback?this._valueCallback():this._storedValue;if(s!==null)switch(this.type){case O.Float:e.setFloat(r,s);break;case O.Int:e.setInt(r,s);break;case O.Color3:ot.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&ot.Color3[0].toGammaSpaceToRef(ot.Color3[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&ot.Color3[0].toLinearSpaceToRef(ot.Color3[0],t.getEngine().useExactSrgbConversions),e.setColor3(r,ot.Color3[0]);break;case O.Color4:ot.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&ot.Color4[0].toGammaSpaceToRef(ot.Color4[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&ot.Color4[0].toLinearSpaceToRef(ot.Color4[0],t.getEngine().useExactSrgbConversions),e.setDirectColor4(r,ot.Color4[0]);break;case O.Vector2:e.setVector2(r,s);break;case O.Vector3:e.setVector3(r,s);break;case O.Vector4:e.setVector4(r,s);break;case O.Matrix:e.setMatrix(r,s);break}}_buildBlock(e){super._buildBlock(e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)}_dumpPropertiesCode(){let e=this._codeVariableName;if(this.isAttribute)return super._dumpPropertiesCode()+`${e}.setAsAttribute("${this.name}");
`;if(this.isSystemValue)return super._dumpPropertiesCode()+`${e}.setAsSystemValue(BABYLON.NodeMaterialSystemValues.${st[this._systemValue]});
`;if(this.isUniform){let t=[],i="";switch(this.type){case O.Float:i=`${this.value}`;break;case O.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case O.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case O.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break;case O.Color3:i=`new BABYLON.Color3(${this.value.r}, ${this.value.g}, ${this.value.b})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case O.Color4:i=`new BABYLON.Color4(${this.value.r}, ${this.value.g}, ${this.value.b}, ${this.value.a})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case O.Matrix:i=`BABYLON.Matrix.FromArray([${this.value.m.join(", ")}])`;break}return t.push(`${e}.value = ${i}`),this.type===O.Float&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`,`${e}.isBoolean = ${this.isBoolean}`,`${e}.matrixMode = ${this.matrixMode}`,`${e}.animationType = BABYLON.AnimatedInputBlockTypes.${Kr[this.animationType]}`),t.push(`${e}.isConstant = ${this.isConstant}`),t.push(""),super._dumpPropertiesCode()+t.join(`;
`)}return super._dumpPropertiesCode()}dispose(){this.onValueChangedObservable.clear(),super.dispose()}serialize(){let e=super.serialize();return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this._storedValue!=null&&this._mode===0&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e,t,i){if(this._mode=e.mode,super._deserialize(e,t,i),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.name==="tangent"&&e.mode===1&&e.type===O.Vector3&&(this._type=O.Vector4),!!e.valueType)if(e.valueType==="number")this._storedValue=e.value;else{let r=vt(e.valueType);r&&(this._storedValue=r.FromArray(e.value))}}};le("BABYLON.InputBlock",$t);var Ch=class extends yt{get associatedVariableName(){return this._varName}constructor(e){super(e,X.Fragment),this.registerOutput("xy",O.Vector2,X.Fragment),this.registerOutput("x",O.Float,X.Fragment),this.registerOutput("y",O.Float,X.Fragment)}getClassName(){return"ScreenSizeBlock"}get xy(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}bind(e){let t=this._scene.getEngine();e.setFloat2(this._varName,t.getRenderWidth(),t.getRenderHeight())}writeOutputs(e,t){let i="";for(let r of this._outputs)r.hasEndpoints&&(i+=`${e._declareOutput(r)} = ${t}.${r.name};
`);return i}_buildBlock(e){if(super._buildBlock(e),this._scene=e.sharedData.scene,e.target===X.Vertex)return e.sharedData.raiseBuildError("ScreenSizeBlock must only be used in a fragment shader"),this;e.sharedData.bindableBlocks.push(this),this._varName=e._getFreeVariableName("screenSize"),e._emitUniformFromString(this._varName,O.Vector2);let t=e.shaderLanguage===1?"uniforms.":"";return e.compilationString+=this.writeOutputs(e,t+this._varName),this}};le("BABYLON.ScreenSizeBlock",Ch);var Og="USE_SFE_FRAMEWORK",_T=class extends jn{constructor(e){super(e)}getClassName(){return"SmartFilterFragmentOutputBlock"}initialize(e){super.initialize(e),e.sharedData.nodeMaterial.mode!==ui.SFE&&e.sharedData.raiseBuildError("SmartFilterFragmentOutputBlock should not be used outside of SFE mode."),e.sharedData.nodeMaterial.shaderLanguage!==0&&e.sharedData.raiseBuildError("WebGPU is not supported in SmartFilters mode."),e.sharedData.formatConfig.getUniformAnnotation||(e.sharedData.formatConfig.getUniformAnnotation=t=>{for(let i of e.sharedData.nodeMaterial.attachedBlocks){if(i instanceof $t&&i.isUniform&&i.associatedVariableName===t)return this._generateInputBlockAnnotation(i);if(i instanceof Ch&&i.associatedVariableName===t)return this._generateScreenSizeBlockAnnotation()}return""}),e.sharedData.formatConfig.formatVariablename=t=>{let i=t;return i.length>1&&i[1]==="_"&&(i=i.substring(2)),i.replace(/[^a-zA-Z]+/g,"")}}_generateInputBlockAnnotation(e){let t=e.valueCallback?e.valueCallback():e.value;return`// { "default": ${JSON.stringify(t)} }
`}_generateScreenSizeBlockAnnotation(){return`// { "autoBind": "outputResolution" }
`}_getMainUvName(e){let t=e.sharedData.nodeMaterial.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="postprocess_uv");return!t||!t.isAnAncestorOf(this)?"":t.associatedVariableName}_getOutputString(){return"outColor"}_buildBlock(e){super._buildBlock(e);let t=this._getOutputString();return e._customEntryHeader+=`#ifdef ${Og}
`,e._customEntryHeader+=`vec4 nmeMain(vec2 ${this._getMainUvName(e)}) { // main
`,e._customEntryHeader+=`#else
`,e._customEntryHeader+=`void main(void) {
`,e._customEntryHeader+=`#endif
`,e._customEntryHeader+=`vec4 ${t} = vec4(0.0);
`,e.compilationString+=`
#ifndef ${Og}
`,e.compilationString+=`gl_FragColor = ${t};
`,e.compilationString+=`#else
`,e.compilationString+=`return ${t};
`,e.compilationString+=`#endif
`,this}};le("BABYLON.SmartFilterFragmentOutputBlock",_T);var fa=class extends yt{get transformAsDirection(){return this.complementW===0}set transformAsDirection(e){this.complementW=e?0:1}constructor(e){super(e,X.Neutral),this.complementW=1,this.complementZ=0,this.target=X.Vertex,this.registerInput("vector",O.AutoDetect),this.registerInput("transform",O.Matrix),this.registerOutput("output",O.Vector4),this.registerOutput("xyz",O.Vector3),this._inputs[0].onConnectionObservable.add(t=>{if(t.ownerBlock.isInput){let i=t.ownerBlock;(i.name==="normal"||i.name==="tangent")&&(this.complementW=0)}})}getClassName(){return"TransformBlock"}get vector(){return this._inputs[0]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}get transform(){return this._inputs[1]}_buildBlock(e){super._buildBlock(e);let t=this.vector,i=this.transform,r=e._getShaderType(O.Vector4),s=e._getShaderType(O.Vector3);if(t.connectedPoint){if(this.complementW===0||this.transformAsDirection){let o=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",o),e.sharedData.blocksWithDefines.push(this);let a=e._getFreeVariableName(`${i.associatedVariableName}_NUS`);switch(e.shaderLanguage===1?e.compilationString+=`var ${a}: mat3x3f = mat3x3f(${i.associatedVariableName}[0].xyz, ${i.associatedVariableName}[1].xyz, ${i.associatedVariableName}[2].xyz);
`:e.compilationString+=`mat3 ${a} = mat3(${i.associatedVariableName});
`,e.compilationString+=`#ifdef NONUNIFORMSCALING
`,e.compilationString+=`${a} = transposeMat3(inverseMat3(${a}));
`,e.compilationString+=`#endif
`,t.connectedPoint.type){case O.Vector2:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${a} * ${s}(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}), ${this._writeFloat(this.complementW)});
`;break;case O.Vector3:case O.Color3:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${a} * ${t.associatedVariableName}, ${this._writeFloat(this.complementW)});
`;break;default:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${a} * ${t.associatedVariableName}.xyz, ${this._writeFloat(this.complementW)});
`;break}}else{let o=i.associatedVariableName;switch(t.connectedPoint.type){case O.Vector2:e.compilationString+=e._declareOutput(this.output)+` = ${o} * ${r}(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}, ${this._writeFloat(this.complementW)});
`;break;case O.Vector3:case O.Color3:e.compilationString+=e._declareOutput(this.output)+` = ${o} * ${r}(${t.associatedVariableName}, ${this._writeFloat(this.complementW)});
`;break;default:e.compilationString+=e._declareOutput(this.output)+` = ${o} * ${t.associatedVariableName};
`;break}}this.xyz.hasEndpoints&&(e.compilationString+=e._declareOutput(this.xyz)+` = ${this.output.associatedVariableName}.xyz;
`)}return this}prepareDefines(e,t,i){i&&i.nonUniformScaling&&e.setValue("NONUNIFORMSCALING",!0)}serialize(){let e=super.serialize();return e.complementZ=this.complementZ,e.complementW=this.complementW,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.complementZ=e.complementZ!==void 0?e.complementZ:0,this.complementW=e.complementW!==void 0?e.complementW:1}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.complementZ = ${this.complementZ};
`;return e+=`${this._codeVariableName}.complementW = ${this.complementW};
`,e}};w([Yr("Transform as direction",0,void 0,{embedded:!0})],fa.prototype,"transformAsDirection",null);le("BABYLON.TransformBlock",fa);var pa=class extends yt{constructor(e){super(e,X.Vertex,!0),this.registerInput("vector",O.Vector4)}getClassName(){return"VertexOutputBlock"}get vector(){return this._inputs[0]}_isLogarithmicDepthEnabled(e,t){if(t)return!0;for(let i of e)if(i.useLogarithmicDepth)return!0;return!1}_buildBlock(e){super._buildBlock(e);let t=this.vector,i=e.shaderLanguage===1;if(e.shaderLanguage===1?e.compilationString+=`vertexOutputs.position = ${t.associatedVariableName};
`:e.compilationString+=`gl_Position = ${t.associatedVariableName};
`,this._isLogarithmicDepthEnabled(e.sharedData.fragmentOutputNodes,e.sharedData.nodeMaterial.useLogarithmicDepth)){e._emitUniformFromString("logarithmicDepthConstant",O.Float),e._emitVaryingFromString("vFragmentDepth",O.Float);let r=i?"vertexOutputs.vFragmentDepth":"vFragmentDepth",s=i?"uniforms.":"",o=i?"vertexOutputs.position":"gl_Position";e.compilationString+=`${r} = 1.0 + ${o}.w;
`,e.compilationString+=`${o}.z = log2(max(0.000001, ${r})) * ${s}logarithmicDepthConstant;
`}return this}};le("BABYLON.VertexOutputBlock",pa);var Th=class extends yt{get samplerName(){return this._samplerName}get texture(){return this._texture}set texture(e){this._texture=e}constructor(e){super(e,X.VertexAndFragment),this._samplerName="textureSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",O.AutoDetect,!1,X.VertexAndFragment),this.registerOutput("rgba",O.Color4,X.Neutral),this.registerOutput("rgb",O.Color3,X.Neutral),this.registerOutput("r",O.Float,X.Neutral),this.registerOutput("g",O.Float,X.Neutral),this.registerOutput("b",O.Float,X.Neutral),this.registerOutput("a",O.Float,X.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(O.Vector2|O.Vector3|O.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"CurrentScreenBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName(this.samplerName)}get target(){return this.uv.isConnected?this.uv.sourceBlock.isInput?X.VertexAndFragment:X.Fragment:X.VertexAndFragment}prepareDefines(e){e.setValue(this._linearDefineName,this.convertToGammaSpace,!0),e.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_getMainUvName(e){return"vMain"+this.uv.associatedVariableName}_injectVertexCode(e){let t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,O.Vector2)),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;
`,!!this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(let i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name,!0)}}_writeTextureRead(e,t=!1){let i=this.uv;if(t){if(e.target===X.Fragment)return;let s=e.shaderLanguage===0?`texture2D(${this.samplerName},`:`textureSampleLevel(${this.samplerName}, ${this.samplerName+"Sampler"},`,o=e.shaderLanguage===0?"":", 0";e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,O.Vector4)} = ${s} ${i.associatedVariableName}${o});
`;return}let r=e.shaderLanguage===0?`texture2D(${this.samplerName},`:`textureSample(${this.samplerName}, ${this.samplerName+"Sampler"},`;if(this.uv.ownerBlock.target===X.Fragment){e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,O.Vector4)} = ${r} ${i.associatedVariableName});
`;return}e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,O.Vector4)} = ${r} ${this._mainUVName});
`}_writeOutput(e,t,i,r=!1){if(r){if(e.target===X.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`;return}if(this.uv.ownerBlock.target===X.Fragment){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`;return}e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`,e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`}_emitUvAndSampler(e){e._emitVaryingFromString(this._mainUVName,O.Vector2),e._emit2DSampler(this.samplerName)}_buildBlock(e){if(super._buildBlock(e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),this._mainUVName=this._getMainUvName(e),this._emitUvAndSampler(e),e.target!==X.Fragment){this._injectVertexCode(e);return}if(!this._outputs.some(i=>i.isConnectedInFragmentShader))return;this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");let t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._writeTextureRead(e);for(let i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}serialize(){let e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=Z.Parse(e.texture,t,i))}};le("BABYLON.CurrentScreenBlock",Th);var Sh=class extends yt{constructor(e){super(e,X.Fragment),this._samplerName="diffuseSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",O.AutoDetect,!1,X.VertexAndFragment),this.registerOutput("rgba",O.Color4,X.Neutral),this.registerOutput("rgb",O.Color3,X.Neutral),this.registerOutput("r",O.Float,X.Neutral),this.registerOutput("g",O.Float,X.Neutral),this.registerOutput("b",O.Float,X.Neutral),this.registerOutput("a",O.Float,X.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(O.Vector2|O.Vector3|O.Vector4)}getClassName(){return"ParticleTextureBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("diffuseSampler")}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="particle_uv"&&t(r));i||(i=new $t("uv"),i.setAsAttribute("particle_uv")),i.output.connectTo(this.uv)}}prepareDefines(e){e.setValue(this._linearDefineName,this.convertToGammaSpace,!0),e.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_writeOutput(e,t,i){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`,e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`}_buildBlock(e){if(super._buildBlock(e),e.target===X.Vertex)return;this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");let t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,O.Vector4)} = ${e._generateTextureSample(this.uv.associatedVariableName,this._samplerName)};
`;for(let i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}serialize(){let e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=Z.Parse(e.texture,t,i))}};le("BABYLON.ParticleTextureBlock",Sh);var Ih=class extends yt{constructor(e){super(e,X.Fragment),this._isUnique=!0,this.registerInput("color",O.Color4,!1,X.Fragment),this.registerOutput("rampColor",O.Color4,X.Fragment)}getClassName(){return"ParticleRampGradientBlock"}get color(){return this._inputs[0]}get rampColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor")}_buildBlock(e){if(super._buildBlock(e),e.target===X.Vertex)return;e._emit2DSampler("rampSampler","RAMPGRADIENT"),e._emitVaryingFromString("remapRanges",O.Vector4,"RAMPGRADIENT");let t=e.shaderLanguage===0?"":"fragmentInputs.";return e.compilationString+=`
            #ifdef RAMPGRADIENT
                ${e._declareLocalVar("baseColor",O.Vector4)} = ${this.color.associatedVariableName};
                ${e._declareLocalVar("alpha",O.Float)} = ${this.color.associatedVariableName}.a;

                ${e._declareLocalVar("remappedColorIndex",O.Float)} = clamp((alpha - ${t}remapRanges.x) / ${t}remapRanges.y, 0.0, 1.0);

                ${e._declareLocalVar("rampColor",O.Vector4)} = ${e._generateTextureSample("vec2(1.0 - remappedColorIndex, 0.)","rampSampler")};

                // Remapped alpha
                ${e._declareOutput(this.rampColor)} = vec4${e.fSuffix}(baseColor.rgb * rampColor.rgb, clamp((alpha * rampColor.a - ${t}remapRanges.z) / ${t}remapRanges.w, 0.0, 1.0));
            #else
                ${e._declareOutput(this.rampColor)} = ${this.color.associatedVariableName};
            #endif
        `,this}};le("BABYLON.ParticleRampGradientBlock",Ih);var Ah=class extends yt{constructor(e){super(e,X.Fragment),this._isUnique=!0,this.registerInput("color",O.Color4,!1,X.Fragment),this.registerInput("alphaTexture",O.Float,!1,X.Fragment),this.registerInput("alphaColor",O.Float,!1,X.Fragment),this.registerOutput("blendColor",O.Color4,X.Fragment)}getClassName(){return"ParticleBlendMultiplyBlock"}get color(){return this._inputs[0]}get alphaTexture(){return this._inputs[1]}get alphaColor(){return this._inputs[2]}get blendColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("sourceAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==X.Vertex)return e.compilationString+=`
            #ifdef BLENDMULTIPLYMODE
                ${e._declareOutput(this.blendColor)};
                ${e._declareLocalVar("sourceAlpha",O.Float)}  = ${this.alphaColor.associatedVariableName} * ${this.alphaTexture.associatedVariableName};
                ${this.blendColor.associatedVariableName} = vec4${e.fSuffix}(${this.color.associatedVariableName}.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha), ${this.color.associatedVariableName}.a);
            #else
                ${e._declareOutput(this.blendColor)} = ${this.color.associatedVariableName};
            #endif
        `,this}};le("BABYLON.ParticleBlendMultiplyBlock",Ah);var ma=class extends yt{constructor(e){super(e,X.Neutral),this.xSwizzle="x",this.ySwizzle="y",this.zSwizzle="z",this.wSwizzle="w",this.registerInput("xyzw ",O.Vector4,!0),this.registerInput("xyz ",O.Vector3,!0),this.registerInput("xy ",O.Vector2,!0),this.registerInput("zw ",O.Vector2,!0),this.registerInput("x",O.Float,!0),this.registerInput("y",O.Float,!0),this.registerInput("z",O.Float,!0),this.registerInput("w",O.Float,!0),this.registerOutput("xyzw",O.Vector4),this.registerOutput("xyz",O.Vector3),this.registerOutput("xy",O.Vector2),this.registerOutput("zw",O.Vector2)}getClassName(){return"VectorMergerBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get x(){return this._inputs[4]}get y(){return this._inputs[5]}get z(){return this._inputs[6]}get w(){return this._inputs[7]}get xyzw(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xy(){return this.xyOut}get xyz(){return this.xyzOut}_inputRename(e){return e==="xyzw "?"xyzwIn":e==="xyz "?"xyzIn":e==="xy "?"xyIn":e==="zw "?"zwIn":e}_buildSwizzle(e){return"."+(this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle).substring(0,e)}_buildBlock(e){super._buildBlock(e);let t=this.x,i=this.y,r=this.z,s=this.w,o=this.xyIn,a=this.zwIn,l=this.xyzIn,c=this.xyzwIn,u=this._outputs[0],h=this._outputs[1],d=this._outputs[2],f=this._outputs[3],p=e._getShaderType(O.Vector4),g=e._getShaderType(O.Vector3),_=e._getShaderType(O.Vector2);return c.isConnected?(u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${c.associatedVariableName}${this._buildSwizzle(4)};
`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${c.associatedVariableName}${this._buildSwizzle(3)};
`),d.hasEndpoints&&(e.compilationString+=e._declareOutput(d)+` = ${c.associatedVariableName}${this._buildSwizzle(2)};
`)):l.isConnected?(u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${p}(${l.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};
`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${l.associatedVariableName}${this._buildSwizzle(3)};
`),d.hasEndpoints&&(e.compilationString+=e._declareOutput(d)+` = ${l.associatedVariableName}${this._buildSwizzle(2)};
`)):o.isConnected?(u.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(u)+` = ${p}(${o.associatedVariableName}, ${a.associatedVariableName})${this._buildSwizzle(4)};
`:e.compilationString+=e._declareOutput(u)+` = ${p}(${o.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};
`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${g}(${o.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};
`),d.hasEndpoints&&(e.compilationString+=e._declareOutput(d)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};
`),f.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(f)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};
`:e.compilationString+=e._declareOutput(f)+` = ${_}(${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(2)};
`)):(u.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(u)+` = ${p}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${a.associatedVariableName})${this._buildSwizzle(4)};
`:e.compilationString+=e._declareOutput(u)+` = ${p}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};
`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${g}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};
`),d.hasEndpoints&&(e.compilationString+=e._declareOutput(d)+` = ${_}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"})${this._buildSwizzle(2)};
`),f.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(f)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};
`:e.compilationString+=e._declareOutput(f)+` = ${_}(${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(2)};
`)),this}serialize(){let e=super.serialize();return e.xSwizzle=this.xSwizzle,e.ySwizzle=this.ySwizzle,e.zSwizzle=this.zSwizzle,e.wSwizzle=this.wSwizzle,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.xSwizzle=e.xSwizzle??"x",this.ySwizzle=e.ySwizzle??"y",this.zSwizzle=e.zSwizzle??"z",this.wSwizzle=e.wSwizzle??"w"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.xSwizzle = "${this.xSwizzle}";
`,e+=`${this._codeVariableName}.ySwizzle = "${this.ySwizzle}";
`,e+=`${this._codeVariableName}.zSwizzle = "${this.zSwizzle}";
`,e+=`${this._codeVariableName}.wSwizzle = "${this.wSwizzle}";
`,e}};le("BABYLON.VectorMergerBlock",ma);var ga=class extends yt{constructor(e){super(e,X.Neutral),this.sourceRange=new me(-1,1),this.targetRange=new me(0,1),this.registerInput("input",O.AutoDetect),this.registerInput("sourceMin",O.Float,!0),this.registerInput("sourceMax",O.Float,!0),this.registerInput("targetMin",O.Float,!0),this.registerInput("targetMax",O.Float,!0),this.registerOutput("output",O.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"RemapBlock"}get input(){return this._inputs[0]}get sourceMin(){return this._inputs[1]}get sourceMax(){return this._inputs[2]}get targetMin(){return this._inputs[3]}get targetMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),r=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),s=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),o=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=e._declareOutput(t)+` = ${s} + (${this._inputs[0].associatedVariableName} - ${i}) * (${o} - ${s}) / (${r} - ${i});
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.sourceRange = new BABYLON.Vector2(${this.sourceRange.x}, ${this.sourceRange.y});
`;return e+=`${this._codeVariableName}.targetRange = new BABYLON.Vector2(${this.targetRange.x}, ${this.targetRange.y});
`,e}serialize(){let e=super.serialize();return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.sourceRange=me.FromArray(e.sourceRange),this.targetRange=me.FromArray(e.targetRange)}};w([Yr("From",3)],ga.prototype,"sourceRange",void 0);w([Yr("To",3)],ga.prototype,"targetRange",void 0);le("BABYLON.RemapBlock",ga);var Ng=class extends yt{constructor(e){super(e,X.Neutral),this.registerInput("left",O.AutoDetect),this.registerInput("right",O.AutoDetect),this.registerOutput("output",O.BasedOnInput),this.output._typeConnectionSource=this.left,this._linkConnectionTypes(0,1,!0),this.left.acceptedConnectionPointTypes.push(O.Float),this.right.acceptedConnectionPointTypes.push(O.Float),this._connectionObservers=[this.left.onTypeChangedObservable.add(()=>this._updateInputOutputTypes()),this.right.onTypeChangedObservable.add(()=>this._updateInputOutputTypes())]}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_updateInputOutputTypes(){if(this.output._typeConnectionSource=this.left,this.left.isConnected&&this.right.isConnected?(this.left.type===O.Int||this.left.type===O.Float&&this.right.type!==O.Int)&&(this.output._typeConnectionSource=this.right):this.left.isConnected!==this.right.isConnected&&(this.output._typeConnectionSource=this.left.isConnected?this.left:this.right),this.left.isConnected||this.right.isConnected)for(let[e,t]of[[this.left,this.right],[this.right,this.left]])e.acceptedConnectionPointTypes=[O.Int,O.Float],t.isConnected&&(e.acceptedConnectionPointTypes.push(t.type),(t.type===O.Int||t.type===O.Float)&&e.acceptedConnectionPointTypes.push(O.Vector2,O.Vector3,O.Vector4,O.Color3,O.Color4,O.Matrix))}dispose(){super.dispose();for(let e of this._connectionObservers)e.remove();this._connectionObservers.length=0}};var gc=class extends Ng{constructor(e){super(e)}getClassName(){return"MultiplyBlock"}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} * ${this.right.associatedVariableName};
`,this}};le("BABYLON.MultiplyBlock",gc);var Eh=class extends yt{constructor(e){super(e,X.Neutral),this.registerInput("rgba",O.Color4,!0),this.registerInput("rgb ",O.Color3,!0),this.registerOutput("rgb",O.Color3),this.registerOutput("r",O.Float),this.registerOutput("g",O.Float),this.registerOutput("b",O.Float),this.registerOutput("a",O.Float),this.inputsAreExclusive=!0}getClassName(){return"ColorSplitterBlock"}get rgba(){return this._inputs[0]}get rgbIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get r(){return this._outputs[1]}get g(){return this._outputs[2]}get b(){return this._outputs[3]}get a(){return this._outputs[4]}_inputRename(e){return e==="rgb "?"rgbIn":e}_outputRename(e){return e==="rgb"?"rgbOut":e}_buildBlock(e){super._buildBlock(e);let t=this.rgba.isConnected?this.rgba:this.rgbIn;if(!t.isConnected)return;let i=this._outputs[0],r=this._outputs[1],s=this._outputs[2],o=this._outputs[3],a=this._outputs[4];return i.hasEndpoints&&(e.compilationString+=e._declareOutput(i)+` = ${t.associatedVariableName}.rgb;
`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName}.r;
`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = ${t.associatedVariableName}.g;
`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${t.associatedVariableName}.b;
`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${t.associatedVariableName}.a;
`),this}};le("BABYLON.ColorSplitterBlock",Eh);var We=(function(n){return n[n.Cos=0]="Cos",n[n.Sin=1]="Sin",n[n.Abs=2]="Abs",n[n.Exp=3]="Exp",n[n.Exp2=4]="Exp2",n[n.Round=5]="Round",n[n.Floor=6]="Floor",n[n.Ceiling=7]="Ceiling",n[n.Sqrt=8]="Sqrt",n[n.Log=9]="Log",n[n.Tan=10]="Tan",n[n.ArcTan=11]="ArcTan",n[n.ArcCos=12]="ArcCos",n[n.ArcSin=13]="ArcSin",n[n.Fract=14]="Fract",n[n.Sign=15]="Sign",n[n.Radians=16]="Radians",n[n.Degrees=17]="Degrees",n[n.Set=18]="Set",n})(We||{}),_c=class extends yt{constructor(e){super(e,X.Neutral),this.operation=We.Cos,this.registerInput("input",O.AutoDetect),this.registerOutput("output",O.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"TrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i="";switch(this.operation){case We.Cos:{i="cos";break}case We.Sin:{i="sin";break}case We.Abs:{i="abs";break}case We.Exp:{i="exp";break}case We.Exp2:{i="exp2";break}case We.Round:{i="round";break}case We.Floor:{i="floor";break}case We.Ceiling:{i="ceil";break}case We.Sqrt:{i="sqrt";break}case We.Log:{i="log";break}case We.Tan:{i="tan";break}case We.ArcTan:{i="atan";break}case We.ArcCos:{i="acos";break}case We.ArcSin:{i="asin";break}case We.Fract:{i="fract";break}case We.Sign:{i="sign";break}case We.Radians:{i="radians";break}case We.Degrees:{i="degrees";break}case We.Set:{i="";break}}return e.compilationString+=e._declareOutput(t)+` = ${i}(${this.input.associatedVariableName});
`,this}serialize(){let e=super.serialize();return e.operation=this.operation,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.TrigonometryBlockOperations.${We[this.operation]};
`}};w([Yr("Operation",5,"ADVANCED",{notifiers:{rebuild:!0},embedded:!0,options:[{label:"Cos",value:We.Cos},{label:"Sin",value:We.Sin},{label:"Abs",value:We.Abs},{label:"Exp",value:We.Exp},{label:"Exp2",value:We.Exp2},{label:"Round",value:We.Round},{label:"Floor",value:We.Floor},{label:"Ceiling",value:We.Ceiling},{label:"Sqrt",value:We.Sqrt},{label:"Log",value:We.Log},{label:"Tan",value:We.Tan},{label:"ArcTan",value:We.ArcTan},{label:"ArcCos",value:We.ArcCos},{label:"ArcSin",value:We.ArcSin},{label:"Fract",value:We.Fract},{label:"Sign",value:We.Sign},{label:"Radians",value:We.Radians},{label:"Degrees",value:We.Degrees},{label:"Set",value:We.Set}]})],_c.prototype,"operation",void 0);le("BABYLON.TrigonometryBlock",_c);var yT={effect:null,subMesh:null},vT=class extends td(ws){},_a=class extends La(vT){constructor(){super(),this.NORMAL=!1,this.TANGENT=!1,this.VERTEXCOLOR_NME=!1,this.PREPASS=!1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_POSITION=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.MORPHTARGETS_UV2=!1,this.MORPHTARGETS_COLOR=!1,this.MORPHTARGETTEXTURE_HASPOSITIONS=!1,this.MORPHTARGETTEXTURE_HASNORMALS=!1,this.MORPHTARGETTEXTURE_HASTANGENTS=!1,this.MORPHTARGETTEXTURE_HASUVS=!1,this.MORPHTARGETTEXTURE_HASUV2S=!1,this.MORPHTARGETTEXTURE_HASCOLORS=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.BUMPDIRECTUV=0,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.AREALIGHTSUPPORTED=!0,this.AREALIGHTNOROUGHTNESS=!0,this.rebuild()}setValue(e,t,i=!1){this[e]===void 0&&this._keys.push(e),i&&this[e]!==t&&this.markAsUnprocessed(),this[e]=t}},bT=class extends ka(Tr){},Xt=class n extends bT{static _BlockIsTextureBlock(e){return e.getClassName()==="TextureBlock"||e.getClassName()==="ReflectionTextureBaseBlock"||e.getClassName()==="ReflectionTextureBlock"||e.getClassName()==="ReflectionBlock"||e.getClassName()==="RefractionBlock"||e.getClassName()==="CurrentScreenBlock"||e.getClassName()==="SmartFilterTextureBlock"||e.getClassName()==="ParticleTextureBlock"||e.getClassName()==="ImageSourceBlock"||e.getClassName()==="TriPlanarBlock"||e.getClassName()==="BiPlanarBlock"||e.getClassName()==="PrePassTextureBlock"}get buildIsInProgress(){return this._buildIsInProgress}set _glowModeEnabled(e){this._useAdditionalColor=e}_getGlobalNodeMaterialEditor(){if(typeof NODEEDITOR<"u")return NODEEDITOR;if(typeof BABYLON<"u"&&typeof BABYLON.NodeEditor<"u")return BABYLON}get shaderLanguage(){return this._options?.shaderLanguage||n.DefaultShaderLanguage}set shaderLanguage(e){this._options.shaderLanguage=e}get options(){return this._options}set options(e){this._options=e}get mode(){return this._mode}set mode(e){this._mode=e}get buildId(){return this._buildId}set buildId(e){this._buildId=e}constructor(e,t,i={}){if(super(e,t||ye.LastCreatedScene),this._buildId=n._BuildIdGenerator++,this._buildWasSuccessful=!1,this._cachedWorldViewMatrix=new L,this._cachedWorldViewProjectionMatrix=new L,this._optimizers=new Array,this._animationFrame=-1,this._buildIsInProgress=!1,this.BJSNODEMATERIALEDITOR=this._getGlobalNodeMaterialEditor(),this._useAdditionalColor=!1,this.editorData=null,this.ignoreAlpha=!1,this.maxSimultaneousLights=4,this.onBuildObservable=new F,this.onBuildErrorObservable=new F,this._vertexOutputNodes=new Array,this._fragmentOutputNodes=new Array,this.attachedBlocks=[],this._mode=ui.Material,this.forceAlphaBlending=!1,!n.UseNativeShaderLanguageOfEngine&&i&&i.shaderLanguage===1&&!this.getScene().getEngine().isWebGPU)throw new Error("WebGPU shader language is only supported with WebGPU engine");this._options=Y({emitComments:!1,shaderLanguage:n.DefaultShaderLanguage},i),n.UseNativeShaderLanguageOfEngine&&(this._options.shaderLanguage=this.getScene().getEngine().isWebGPU?1:0),this._attachImageProcessingConfiguration(null)}getClassName(){return"NodeMaterial"}getBlockByName(e){let t=null;for(let i of this.attachedBlocks)if(i.name===e)if(!t)t=i;else return z.Warn("More than one block was found with the name `"+e+"`"),t;return t}getBlockByPredicate(e){for(let t of this.attachedBlocks)if(e(t))return t;return null}getInputBlockByPredicate(e){for(let t of this.attachedBlocks)if(t.isInput&&e(t))return t;return null}getInputBlocks(){let e=[];for(let t of this.attachedBlocks)t.isInput&&e.push(t);return e}registerOptimizer(e){if(!(this._optimizers.indexOf(e)>-1))return this._optimizers.push(e),this}unregisterOptimizer(e){let t=this._optimizers.indexOf(e);if(t!==-1)return this._optimizers.splice(t,1),this}addOutputNode(e){if(e.target===null)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return(e.target&X.Vertex)!==0&&this._addVertexOutputNode(e),(e.target&X.Fragment)!==0&&this._addFragmentOutputNode(e),this}removeOutputNode(e){return e.target===null?this:((e.target&X.Vertex)!==0&&this._removeVertexOutputNode(e),(e.target&X.Fragment)!==0&&this._removeFragmentOutputNode(e),this)}_addVertexOutputNode(e){if(this._vertexOutputNodes.indexOf(e)===-1)return e.target=X.Vertex,this._vertexOutputNodes.push(e),this}_removeVertexOutputNode(e){let t=this._vertexOutputNodes.indexOf(e);if(t!==-1)return this._vertexOutputNodes.splice(t,1),this}_addFragmentOutputNode(e){if(this._fragmentOutputNodes.indexOf(e)===-1)return e.target=X.Fragment,this._fragmentOutputNodes.push(e),this}_removeFragmentOutputNode(e){let t=this._fragmentOutputNodes.indexOf(e);if(t!==-1)return this._fragmentOutputNodes.splice(t,1),this}get _supportGlowLayer(){return this._fragmentOutputNodes.length===0?!1:!!this._fragmentOutputNodes.some(e=>e.additionalColor&&e.additionalColor.isConnected)}needAlphaBlending(){return this.ignoreAlpha?!1:this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending}needAlphaTesting(){return this._sharedData&&this._sharedData.hints.needAlphaTesting}_processInitializeOnLink(e,t,i,r=!0){(e.target===X.VertexAndFragment||t.target===X.Fragment&&e.target===X.Vertex&&e._preparationId!==this._buildId)&&i.push(e),this._initializeBlock(e,t,i,r)}_attachBlock(e){if(this.attachedBlocks.indexOf(e)===-1){if(e.isUnique){let t=e.getClassName();for(let i of this.attachedBlocks)if(i.getClassName()===t){this._sharedData.raiseBuildError(`Cannot have multiple blocks of type ${t} in the same NodeMaterial`);return}}this.attachedBlocks.push(e)}}_initializeBlock(e,t,i,r=!0){e.initialize(t),r&&e.autoConfigure(this),e._preparationId=this._buildId,this._attachBlock(e);for(let s of e.inputs){s.associatedVariableName="";let o=s.connectedPoint;if(o&&!o._preventBubbleUp){let a=o.ownerBlock;a!==e&&this._processInitializeOnLink(a,t,i,r)}}if(e.isLoop){let s=e;if(s.loopID.hasEndpoints)for(let o of s.loopID.endpoints){let a=o.ownerBlock;a.outputs.length===0&&(t._terminalBlocks.add(a),this._processInitializeOnLink(a,t,i,r))}}else if(e.isTeleportOut){let s=e;s.entryPoint&&this._processInitializeOnLink(s.entryPoint,t,i,r)}for(let s of e.outputs)s.associatedVariableName=""}_resetDualBlocks(e,t){e.target===X.VertexAndFragment&&(e.buildId=t);for(let i of e.inputs){let r=i.connectedPoint;if(r&&!r._preventBubbleUp){let s=r.ownerBlock;s!==e&&this._resetDualBlocks(s,t)}}if(e.isTeleportOut){let i=e;i.entryPoint&&this._resetDualBlocks(i.entryPoint,t)}else if(e.isLoop){let i=e;if(i.loopID.hasEndpoints)for(let r of i.loopID.endpoints){let s=r.ownerBlock;s.outputs.length===0&&this._resetDualBlocks(s,t)}}}removeBlock(e){let t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e.isFinalMerger&&this.removeOutputNode(e)}build(e=!1,t=!0,i=!1){if(this._buildIsInProgress){P.Warn("Build is already in progress, You can use NodeMaterial.onBuildObservable to determine when the build is completed.");return}this._buildIsInProgress=!0,!this._vertexCompilationState&&!i&&(i=!0),this._buildWasSuccessful=!1;let r=this.getScene().getEngine(),s=this._mode===ui.Particle||this._mode===ui.SFE;if(this._vertexOutputNodes.length===0&&!s){this.onBuildErrorObservable.notifyObservers("You must define at least one vertexOutputNode"),this._buildIsInProgress=!1;return}if(this._fragmentOutputNodes.length===0){this.onBuildErrorObservable.notifyObservers("You must define at least one fragmentOutputNode"),this._buildIsInProgress=!1;return}this._vertexCompilationState=new bh,this._vertexCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._vertexCompilationState.target=X.Vertex,this._fragmentCompilationState=new bh,this._fragmentCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._fragmentCompilationState.target=X.Fragment;let o=this._fragmentOutputNodes.filter(h=>h._isFinalOutputAndActive).length>1,a=this._fragmentOutputNodes;o&&(a=this._fragmentOutputNodes.filter(h=>!h._isFinalOutputAndActive),a.push(this._fragmentOutputNodes.filter(h=>h._isFinalOutputAndActive&&h._hasPrecedence)[0])),this._sharedData=new Pg,this._sharedData.nodeMaterial=this,this._sharedData.fragmentOutputNodes=a,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=s;let l=[],c=[];for(let h of this._vertexOutputNodes)l.push(h),this._initializeBlock(h,this._vertexCompilationState,c,i);for(let h of a)c.push(h),this._initializeBlock(h,this._fragmentCompilationState,l,i);let u=0;for(let h of this.attachedBlocks)h.codeIsReady||(u++,h.onCodeIsReadyObservable.addOnce(()=>{u--,u===0&&this._finishBuildProcess(e,t,l,c)}));u===0&&this._finishBuildProcess(e,t,l,c)}_finishBuildProcess(e=!1,t=!0,i,r){this.optimize();for(let l of i)l.build(this._vertexCompilationState,i);this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(let l of r)this._resetDualBlocks(l,this._buildId-1);for(let l of r)l.build(this._fragmentCompilationState,r);this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),t&&(this._buildId=n._BuildIdGenerator++),e&&(P.Log("Vertex shader:"),P.Log(this._vertexCompilationState.compilationString),P.Log("Fragment shader:"),P.Log(this._fragmentCompilationState.compilationString));let s=this._sharedData.emitErrors();this._buildIsInProgress=!1,s&&(this._buildWasSuccessful=!0,this.onBuildObservable.notifyObservers(this));let o=this.getScene().meshes;for(let l of o)if(l.subMeshes)for(let c of l.subMeshes){if(c.getMaterial()!==this||!c.materialDefines)continue;let u=c.materialDefines;u.markAllAsDirty(),u.reset()}this.prePassTextureInputs.length&&this.getScene().enablePrePassRenderer();let a=this.getScene().prePassRenderer;a&&a.markAsDirty()}optimize(){for(let e of this._optimizers)e.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}_prepareDefinesForAttributes(e,t){let i=t.NORMAL,r=t.TANGENT,s=t.VERTEXCOLOR_NME;t.NORMAL=e.isVerticesDataPresent(T.NormalKind),t.TANGENT=e.isVerticesDataPresent(T.TangentKind);let o=e.useVertexColors&&e.isVerticesDataPresent(T.ColorKind);t.VERTEXCOLOR_NME=o;let a=!1;for(let c=1;c<=6;++c){let u=t["UV"+c];t["UV"+c]=e.isVerticesDataPresent(`uv${c===1?"":c}`),a=a||t["UV"+c]!==u}let l=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;Yh(this.getScene(),t,!l),Ba.PrepareDefines(this.getScene().getEngine().currentRenderPassId,e,t),(i!==t.NORMAL||r!==t.TANGENT||s!==t.VERTEXCOLOR_NME||a)&&t.markAsAttributesDirty()}get isPrePassCapable(){return!0}get prePassTextureOutputs(){let e=this.getBlockByPredicate(i=>i.getClassName()==="PrePassOutputBlock"),t=[4];return!e||this.prePassTextureInputs.length||(e.viewDepth.isConnected&&t.push(5),e.screenDepth.isConnected&&t.push(10),e.viewNormal.isConnected&&t.push(6),e.worldNormal.isConnected&&t.push(8),e.worldPosition.isConnected&&t.push(1),e.localPosition.isConnected&&t.push(9),e.reflectivity.isConnected&&t.push(3),e.velocity.isConnected&&t.push(2),e.velocityLinear.isConnected&&t.push(11)),t}get prePassTextureInputs(){let e=this.getAllTextureBlocks().filter(i=>i.getClassName()==="PrePassTextureBlock"),t=[];for(let i of e)i.position.isConnected&&!t.includes(1)&&t.push(1),i.localPosition.isConnected&&!t.includes(9)&&t.push(9),i.depth.isConnected&&!t.includes(5)&&t.push(5),i.screenDepth.isConnected&&!t.includes(10)&&t.push(10),i.normal.isConnected&&!t.includes(6)&&t.push(6),i.worldNormal.isConnected&&!t.includes(8)&&t.push(8);return t}setPrePassRenderer(e){let t=this.prePassTextureInputs.concat(this.prePassTextureOutputs);if(e&&t.length>1){let i=e.getEffectConfiguration("nodeMaterial");i||(i=e.addEffectConfiguration({enabled:!0,needsImageProcessing:!1,name:"nodeMaterial",texturesRequired:[]}));for(let r of t)i.texturesRequired.includes(r)||i.texturesRequired.push(r);i.enabled=!0}return t.length>1}createPostProcess(e,t=1,i=1,r,s,o=0,a=5){return this.mode!==ui.PostProcess&&this.mode!==ui.SFE?(P.Log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,t,i,r,s,o,a)}createEffectForPostProcess(e){this._createEffectForPostProcess(e)}_createEffectForPostProcess(e,t,i=1,r=1,s,o,a=0,l=5){let c=this.name+this._buildId,u=new _a,h=this._buildId;this._processDefines(u);let d=this._sharedData.checks.emitVertex?this._vertexCompilationState._builtCompilationString:void 0;return Pt.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,d,this.shaderLanguage),e?e.updateEffect(u.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,c,c):e=new yr(this.name+"PostProcess",c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,i,t,r,s,o,u.toString(),a,d?c:"postprocess",{maxSimultaneousLights:this.maxSimultaneousLights},!1,l,this.shaderLanguage),e.nodeMaterialSource=this,e.onApplyObservable.add(f=>{h!==this._buildId&&(delete Pt.ShadersStore[c+"VertexShader"],delete Pt.ShadersStore[c+"PixelShader"],c=this.name+this._buildId,u.markAllAsDirty(),h=this._buildId),this._processDefines(u)&&(Pt.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),$g.SetImmediate(()=>e.updateEffect(u.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,c,c))),this._checkInternals(f)}),e}createProceduralTexture(e,t){if(this.mode!==ui.ProceduralTexture)return P.Log("Incompatible material mode"),null;let i=this.name+this._buildId,r=new Oi(i,e,null,t),s=new _a,o=this._processDefines(s);Pt.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage);let a=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[T.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,s.toString(),o?.fallbacks,void 0,void 0,void 0,this.shaderLanguage);r.nodeMaterialSource=this,r._setEffect(a);let l=this._buildId,c=()=>{l!==this._buildId&&(delete Pt.ShadersStore[i+"VertexShader"],delete Pt.ShadersStore[i+"PixelShader"],i=this.name+this._buildId,s.markAllAsDirty(),l=this._buildId);let u=this._processDefines(s);u&&(Pt.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage),$g.SetImmediate(()=>{a=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[T.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,s.toString(),u?.fallbacks,void 0),r._setEffect(a)})),this._checkInternals(a)};return r.onBeforeGenerationObservable.add(()=>{c()}),this.onBuildObservable.add(()=>{c()}),r}_createEffectForParticles(e,t,i,r,s,o,a=""){let l=this.name+this._buildId+"_"+t;o||(o=new _a);let c=this._buildId,u=[],h=a;if(!s){let d=this._processDefines(o);Pt.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,void 0,this.shaderLanguage),e.fillDefines(u,t,!1),h=u.join(`
`),s=this.getScene().getEngine().createEffectForParticles(l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,o.toString()+`
`+h,d?.fallbacks,i,r,e,this.shaderLanguage),e.setCustomEffect(s,t)}s.onBindObservable.add(d=>{c!==this._buildId&&(delete Pt.ShadersStore[l+"PixelShader"],l=this.name+this._buildId+"_"+t,o.markAllAsDirty(),c=this._buildId),u.length=0,e.fillDefines(u,t,!1);let f=u.join(`
`);f!==h&&(o.markAllAsDirty(),h=f);let p=this._processDefines(o);if(p){Pt.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,void 0,this.shaderLanguage),d=this.getScene().getEngine().createEffectForParticles(l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,o.toString()+`
`+h,p?.fallbacks,i,r,e),e.setCustomEffect(d,t),this._createEffectForParticles(e,t,i,r,d,o,a);return}this._checkInternals(d)})}_checkInternals(e){if(this._sharedData.animatedInputs){let t=this.getScene(),i=t.getFrameId();if(this._animationFrame!==i){for(let r of this._sharedData.animatedInputs)r.animate(t);this._animationFrame=i}}for(let t of this._sharedData.bindableBlocks)t.bind(e,this);for(let t of this._sharedData.inputBlocks)t._transmit(e,this.getScene(),this)}createEffectForParticles(e,t,i){if(this.mode!==ui.Particle){P.Log("Incompatible material mode");return}this._createEffectForParticles(e,Wi.BLENDMODE_ONEONE,t,i),this._createEffectForParticles(e,Wi.BLENDMODE_MULTIPLY,t,i)}createAsShadowDepthWrapper(e){if(this.mode!==ui.Material){P.Log("Incompatible material mode");return}e.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene())}_processDefines(e,t,i=!1,r){let s=null,o=this.getScene();r0(o,e)&&e.markAsMiscDirty();for(let a of this._sharedData.blocksWithDefines)a.initializeDefines(e);for(let a of this._sharedData.blocksWithDefines)a.prepareDefines(e,this,t,i,r);if(e.isDirty){let a=e._areLightsDisposed;e.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString;for(let d of this._sharedData.repeatableContentBlocks)d.replaceRepeatableContent(this._vertexCompilationState,e,t);let l=[];for(let d of this._sharedData.dynamicUniformBlocks)d.updateUniformsAndSamples(this._vertexCompilationState,this,e,l);let c=this._vertexCompilationState.uniforms;for(let d of this._fragmentCompilationState.uniforms)c.indexOf(d)===-1&&c.push(d);let u=this._vertexCompilationState.samplers;for(let d of this._fragmentCompilationState.samplers)u.indexOf(d)===-1&&u.push(d);let h=new vr;for(let d of this._sharedData.blocksWithFallbacks)d.provideFallbacks(h,t);s={lightDisposed:a,uniformBuffers:l,mergedUniforms:c,mergedSamplers:u,fallbacks:h}}return s}isReadyForSubMesh(e,t,i=!1){if(!this._buildWasSuccessful)return!1;let r=this.getScene();if(this._sharedData.animatedInputs){let c=r.getFrameId();if(this._animationFrame!==c){for(let u of this._sharedData.animatedInputs)u.animate(r);this._animationFrame=c}}let s=t._drawWrapper;if(s.effect&&this.isFrozen&&s._wasPreviouslyReady&&s._wasPreviouslyUsingInstances===i)return!0;(!t.materialDefines||typeof t.materialDefines=="string")&&(t.materialDefines=new _a);let o=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;let a=r.getEngine();if(this._prepareDefinesForAttributes(e,o),this._sharedData.blockingBlocks.some(c=>!c.isReady(e,this,o,i)))return!1;let l=this._processDefines(o,e,i,t);if(l){let c=t.effect,u=o.toString(),h=a.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:l.mergedUniforms,uniformBuffersNames:l.uniformBuffers,samplers:l.mergedSamplers,defines:u,fallbacks:l.fallbacks,onCompiled:this.onCompiled,onError:this.onError,multiTarget:o.PREPASS,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:o.NUM_MORPH_INFLUENCERS},shaderLanguage:this.shaderLanguage},a);if(h)if(this._onEffectCreatedObservable&&(yT.effect=h,yT.subMesh=t,this._onEffectCreatedObservable.notifyObservers(yT)),this.allowShaderHotSwapping&&c&&!h.isReady()){if(h=c,o.markAsUnprocessed(),l.lightDisposed)return o._areLightsDisposed=!0,!1}else r.resetCachedMaterial(),t.setEffect(h,o,this._materialContext)}if(o.AREALIGHTUSED){for(let c=0;c<e.lightSources.length;c++)if(!e.lightSources[c]._isReady())return!1}return!t.effect||!t.effect.isReady()?!1:(o._renderId=r.getRenderId(),s._wasPreviouslyReady=!0,s._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}get compiledShaders(){return this._buildWasSuccessful||this.build(),`// Vertex shader
${this._vertexCompilationState.compilationString}

// Fragment shader
${this._fragmentCompilationState.compilationString}`}_getProcessedFragmentAsync(){return S(this,null,function*(){this._buildWasSuccessful||this.build();let e=new _a;this._processDefines(e);let t=e.toString();return this.mode===ui.SFE&&(t+=`#define ${Og}
`),yield this._fragmentCompilationState.getProcessedShaderAsync(t)})}bindOnlyWorldMatrix(e){let t=this.getScene();if(!this._activeEffect)return;let i=this._sharedData.hints;i.needWorldViewMatrix&&e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),i.needWorldViewProjectionMatrix&&e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(let r of this._sharedData.inputBlocks)r._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}bindForSubMesh(e,t,i){let r=this.getScene(),s=i.effect;if(!s)return;this._activeEffect=s,this.bindOnlyWorldMatrix(e);let o=this._mustRebind(r,s,i,t.visibility),a=this._sharedData;if(o){for(let l of a.bindableBlocks)l.bind(s,this,t,i);for(let l of a.forcedBindableBlocks)l.bind(s,this,t,i);for(let l of a.inputBlocks)l._transmit(s,r,this)}else if(!this.isFrozen)for(let l of a.forcedBindableBlocks)l.bind(s,this,t,i);this._afterBind(t,this._activeEffect,i)}getActiveTextures(){let e=super.getActiveTextures();return this._sharedData&&e.push(...this._sharedData.textureBlocks.filter(t=>t.texture).map(t=>t.texture)),e}getTextureBlocks(){return this._sharedData?this._sharedData.textureBlocks:[]}getAllTextureBlocks(){let e=[];for(let t of this.attachedBlocks)n._BlockIsTextureBlock(t)&&e.push(t);return e}hasTexture(e){if(super.hasTexture(e))return!0;if(!this._sharedData)return!1;for(let t of this._sharedData.textureBlocks)if(t.texture===e)return!0;return!1}dispose(e,t,i){if(t)for(let r of this.getTextureBlocks().filter(s=>s.texture).map(s=>s.texture))r.dispose();for(let r of this.attachedBlocks)r.dispose();this.attachedBlocks.length=0,this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this.onBuildErrorObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),super.dispose(e,t,i)}_createNodeEditor(e){let t=Y({nodeMaterial:this},e);this.BJSNODEMATERIALEDITOR.NodeEditor.Show(t)}edit(e){return S(this,null,function*(){return yield new Promise(t=>{if(this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),typeof this.BJSNODEMATERIALEDITOR>"u"){let i=e&&e.editorURL?e.editorURL:n.EditorURL;z.LoadBabylonScript(i,()=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this._createNodeEditor(e?.nodeEditorConfig),t()})}else this._createNodeEditor(e?.nodeEditorConfig),t()})})}clear(){this._vertexOutputNodes.length=0,this._fragmentOutputNodes.length=0,this.attachedBlocks.length=0,this._buildIsInProgress=!1}setToDefault(){this.clear(),this.editorData=null;let e=new $t("Position");e.setAsAttribute("position");let t=new $t("World");t.setAsSystemValue(st.World);let i=new fa("WorldPos");e.connectTo(i),t.connectTo(i);let r=new $t("ViewProjection");r.setAsSystemValue(st.ViewProjection);let s=new fa("WorldPos * ViewProjectionTransform");i.connectTo(s),r.connectTo(s);let o=new pa("VertexOutput");s.connectTo(o);let a=new $t("color");a.value=new ce(.8,.8,.8,1);let l=new jn("FragmentOutput");a.connectTo(l),this.addOutputNode(o),this.addOutputNode(l),this._mode=ui.Material}setToDefaultPostProcess(){this.clear(),this.editorData=null;let e=new $t("Position");e.setAsAttribute("position2d");let t=new $t("Constant1");t.isConstant=!0,t.value=1;let i=new ma("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});let r=new pa("VertexOutput");i.connectTo(r);let s=new $t("Scale");s.visibleInInspector=!0,s.value=new me(1,1);let o=new ga("uv0");e.connectTo(o);let a=new gc("UV scale");o.connectTo(a),s.connectTo(a);let l=new Th("CurrentScreen");a.connectTo(l);let c=z.GetAssetUrl("https://assets.babylonjs.com/core/nme/currentScreenPostProcess.png");l.texture=new Z(c,this.getScene());let u=new jn("FragmentOutput");l.connectTo(u,{output:"rgba"}),this.addOutputNode(r),this.addOutputNode(u),this._mode=ui.PostProcess}setToDefaultProceduralTexture(){this.clear(),this.editorData=null;let e=new $t("Position");e.setAsAttribute("position2d");let t=new $t("Constant1");t.isConstant=!0,t.value=1;let i=new ma("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});let r=new pa("VertexOutput");i.connectTo(r);let s=new $t("Time");s.value=0,s.min=0,s.max=0,s.isBoolean=!1,s.matrixMode=0,s.animationType=Kr.Time,s.isConstant=!1;let o=new $t("Color3");o.value=new U(1,1,1),o.isConstant=!1;let a=new jn("FragmentOutput"),l=new ma("VectorMerger");l.visibleInInspector=!1;let c=new _c("Cos");c.operation=We.Cos,e.connectTo(l),s.output.connectTo(c.input),c.output.connectTo(l.z),l.xyzOut.connectTo(a.rgb),this.addOutputNode(r),this.addOutputNode(a),this._mode=ui.ProceduralTexture}setToDefaultParticle(){this.clear(),this.editorData=null;let e=new $t("uv");e.setAsAttribute("particle_uv");let t=new Sh("ParticleTexture");e.connectTo(t);let i=new $t("Color");i.setAsAttribute("particle_color");let r=new gc("Texture * Color");t.connectTo(r),i.connectTo(r);let s=new Ih("ParticleRampGradient");r.connectTo(s);let o=new Eh("ColorSplitter");i.connectTo(o);let a=new Ah("ParticleBlendMultiply");s.connectTo(a),t.connectTo(a,{output:"a"}),o.connectTo(a,{output:"a"});let l=new jn("FragmentOutput");a.connectTo(l),this.addOutputNode(l),this._mode=ui.Particle}loadAsync(e,t=""){return S(this,null,function*(){return yield n.ParseFromFileAsync("",e,this.getScene(),t,!0,this)})}_gatherBlocks(e,t){if(t.indexOf(e)===-1){t.push(e);for(let i of e.inputs){let r=i.connectedPoint;if(r){let s=r.ownerBlock;s!==e&&this._gatherBlocks(s,t)}}if(e.isTeleportOut){let i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}generateCode(){let e=[],t=[],i=["const","var","let"];for(let o of this._vertexOutputNodes)this._gatherBlocks(o,t);let r=[];for(let o of this._fragmentOutputNodes)this._gatherBlocks(o,r);let s=`var nodeMaterial = new BABYLON.NodeMaterial("${this.name||"node material"}");
`;s+=`nodeMaterial.mode = BABYLON.NodeMaterialModes.${ui[this.mode]};
`;for(let o of t)o.isInput&&e.indexOf(o)===-1&&(s+=o._dumpCode(i,e));for(let o of r)o.isInput&&e.indexOf(o)===-1&&(s+=o._dumpCode(i,e));e=[],s+=`
// Connections
`;for(let o of this._vertexOutputNodes)s+=o._dumpCodeForOutputConnections(e);for(let o of this._fragmentOutputNodes)s+=o._dumpCodeForOutputConnections(e);s+=`
// Output nodes
`;for(let o of this._vertexOutputNodes)s+=`nodeMaterial.addOutputNode(${o._codeVariableName});
`;for(let o of this._fragmentOutputNodes)s+=`nodeMaterial.addOutputNode(${o._codeVariableName});
`;return s+=`nodeMaterial.build();
`,s}serialize(e){let t=e?{}:je.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];if(e)i=e;else{t.customType="BABYLON.NodeMaterial",t.outputNodes=[];for(let r of this._vertexOutputNodes)this._gatherBlocks(r,i),t.outputNodes.push(r.uniqueId);for(let r of this._fragmentOutputNodes)this._gatherBlocks(r,i),t.outputNodes.indexOf(r.uniqueId)===-1&&t.outputNodes.push(r.uniqueId)}t.blocks=[];for(let r of i)t.blocks.push(r.serialize());if(!e)for(let r of this.attachedBlocks)i.indexOf(r)===-1&&t.blocks.push(r.serialize());return t.uniqueId=this.uniqueId,t}_restoreConnections(e,t,i){for(let r of e.outputs)for(let s of t.blocks){let o=i[s.id];if(o){for(let a of s.inputs)if(i[a.targetBlockId]===e&&a.targetConnectionName===r.name){let l=o.getInputByName(a.inputName);if(!l||l.isConnected)continue;r.connectTo(l,!0),this._restoreConnections(o,t,i);continue}}}}parseSerializedObject(e,t="",i=!1,r){i||this.clear();let s={};for(let o of e.blocks){let a=vt(o.customType);if(a){let l=new a;l._deserialize(o,this.getScene(),t,r),s[o.id]=l,this.attachedBlocks.push(l)}}for(let o of this.attachedBlocks)if(o.isTeleportOut){let a=o,l=a._tempEntryPointUniqueId;l&&s[l].attachToEndpoint(a)}for(let o=0;o<e.blocks.length;o++){let a=e.blocks[o],l=s[a.id];l&&(l.inputs.length&&!i||this._restoreConnections(l,e,s))}if(e.outputNodes)for(let o of e.outputNodes)this.addOutputNode(s[o]);if(e.locations||e.editorData&&e.editorData.locations){let o=e.locations||e.editorData.locations;for(let l of o)s[l.blockId]&&(l.blockId=s[l.blockId].uniqueId);i&&this.editorData&&this.editorData.locations&&o.concat(this.editorData.locations),e.locations?this.editorData={locations:o}:(this.editorData=e.editorData,this.editorData.locations=o);let a={};for(let l in s)a[l]=s[l].uniqueId;this.editorData.map=a}Re.ParseAlphaMode(e,this),i||(this._mode=e.mode??ui.Material)}loadFromSerialization(e,t="",i=!1){je.ParseProperties(e,this,this.getScene(),t),this.parseSerializedObject(e,t,i)}clone(e,t=!1){let i=this.serialize(),r=je.Clone(()=>new n(e,this.getScene(),this.options),this);return r.id=e,r.name=e,r.parseSerializedObject(i),r._buildId=this._buildId,r.build(!1,!t),r}whenTexturesReadyAsync(){let e=[],t=this.getActiveTextures();for(let i of t){let r=i.getInternalTexture();r&&!r.isReady&&e.push(new Promise((s,o)=>{r.onLoadedObservable.addOnce(()=>{s()}),r.onErrorObservable.addOnce(a=>{o(a)})}))}return Promise.all(e)}static Parse(e,t,i="",r=0){let s=je.Parse(()=>new n(e.name,t,{shaderLanguage:r}),e,t,i);return s.parseSerializedObject(e,i),s.build(),s}static ParseFromFileAsync(e,t,i,r="",s=!1,o,a,l){return S(this,null,function*(){let c=o??new n(e,i,l),u=yield i._loadFileAsync(t),h=JSON.parse(u);return c.parseSerializedObject(h,r,void 0,a),s||c.build(),c})}static ParseFromSnippetAsync(e,t=ye.LastCreatedScene,i="",r,s=!1,o=!1,a,l){return e==="_BLANK"?Promise.resolve(n.CreateDefault("blank",t)):new Promise((c,u)=>{let h=new gr;h.addEventListener("readystatechange",()=>{if(h.readyState==4)if(h.status==200){let d=JSON.parse(JSON.parse(h.responseText).jsonPayload),f=JSON.parse(d.nodeMaterial);r||(r=je.Parse(()=>new n(e,t,l),f,t,i),r.uniqueId=t.getUniqueId()),r.parseSerializedObject(f,void 0,void 0,a),r.snippetId=e,r.sideOrientation=null;try{s||r.build()}catch(p){u(p)}o?r.whenTexturesReadyAsync().then(()=>{c(r)}).catch(p=>{u(p)}):c(r)}else u("Unable to load the snippet "+e)}),h.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),h.send()})}static CreateDefault(e,t){let i=new n(e,t);return i.setToDefault(),i.build(),i}};Xt._BuildIdGenerator=0;Xt.EditorURL=`${z._DefaultCdnUrl}/v${ne.Version}/nodeEditor/babylon.nodeEditor.js`;Xt.SnippetUrl="https://snippet.babylonjs.com";Xt.IgnoreTexturesAtLoadTime=!1;Xt.AllowSerializationOfRenderTargetTextures=!1;Xt.DefaultShaderLanguage=0;Xt.UseNativeShaderLanguageOfEngine=!1;w([B()],Xt.prototype,"ignoreAlpha",void 0);w([B()],Xt.prototype,"maxSimultaneousLights",void 0);w([B("mode")],Xt.prototype,"_mode",void 0);w([B("comment")],Xt.prototype,"comment",void 0);w([B()],Xt.prototype,"forceAlphaBlending",void 0);le("BABYLON.NodeMaterial",Xt);Xi.prototype._projectOnTrianglesToRef=function(n,e,t,i,r,s){let o=k.Vector3[0],a=k.Vector3[1],l=1/0;for(let c=this.indexStart;c<this.indexStart+this.indexCount-(3-i);c+=i){let u=t[c],h=t[c+1],d=t[c+2];if(r&&d===4294967295){c+=2;continue}let f=e[u],p=e[h],g=e[d];if(!f||!p||!g)continue;let _=m.ProjectOnTriangleToRef(n,f,p,g,a);_<l&&(o.copyFrom(a),l=_)}return s.copyFrom(o),l};Xi.prototype._projectOnUnIndexedTrianglesToRef=function(n,e,t,i){let r=k.Vector3[0],s=k.Vector3[1],o=1/0;for(let a=this.verticesStart;a<this.verticesStart+this.verticesCount;a+=3){let l=e[a],c=e[a+1],u=e[a+2],h=m.ProjectOnTriangleToRef(n,l,c,u,s);h<o&&(r.copyFrom(s),o=h)}return i.copyFrom(r),o};Xi.prototype.projectToRef=function(n,e,t,i){let r=this.getMaterial();if(!r)return-1;let s=3,o=!1;switch(r.fillMode){case 3:case 5:case 6:case 8:return-1;case 7:s=1,o=!0;break;default:break}return r.fillMode===4?-1:!t.length&&this._mesh._unIndexed?this._projectOnUnIndexedTrianglesToRef(n,e,t,i):this._projectOnTrianglesToRef(n,e,t,s,o,i)};var Rn=(function(n){return n[n.DEHYDRATED=0]="DEHYDRATED",n[n.HOVER=1]="HOVER",n[n.TOUCH=2]="TOUCH",n})(Rn||{});var yc=[new m,new m,new m,new m],Xr=class n extends $r{constructor(e,t){super(e),this._options=t,this._tmpRay=new rt(new m,new m),this._attachController=i=>{if(this._controllers[i.uniqueId])return;let{touchCollisionMesh:r,touchCollisionMeshFunction:s,hydrateCollisionMeshFunction:o}=this._generateNewTouchPointMesh(),a=this._generateVisualCue();switch(this._controllers[i.uniqueId]={xrController:i,meshUnderPointer:null,nearInteractionTargetMesh:null,pick:null,stalePick:null,touchCollisionMesh:r,touchCollisionMeshFunction:s,hydrateCollisionMeshFunction:o,currentAnimationState:Rn.DEHYDRATED,grabRay:new rt(new m,new m),hoverInteraction:!1,nearInteraction:!1,grabInteraction:!1,downTriggered:!1,id:n._IdCounter++,pickedPointVisualCue:a},this._controllers[i.uniqueId]._worldScaleObserver=this._controllers[i.uniqueId]._worldScaleObserver||this._xrSessionManager.onWorldScaleFactorChangedObservable.add(l=>{if(l.newScaleFactor!==l.previousScaleFactor){this._controllers[i.uniqueId].touchCollisionMesh.dispose(),this._controllers[i.uniqueId].pickedPointVisualCue.dispose();let{touchCollisionMesh:c,touchCollisionMeshFunction:u,hydrateCollisionMeshFunction:h}=this._generateNewTouchPointMesh();this._controllers[i.uniqueId].touchCollisionMesh=c,this._controllers[i.uniqueId].touchCollisionMeshFunction=u,this._controllers[i.uniqueId].hydrateCollisionMeshFunction=h,this._controllers[i.uniqueId].pickedPointVisualCue=this._generateVisualCue()}}),this._attachedController?!this._options.enableNearInteractionOnAllControllers&&this._options.preferredHandedness&&i.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=i.uniqueId):this._options.enableNearInteractionOnAllControllers||(this._attachedController=i.uniqueId),i.inputSource.targetRayMode){case"tracked-pointer":return this._attachNearInteractionMode(i);case"gaze":return null;case"screen":return null}},this._controllers={},this._farInteractionFeature=null,this.selectionMeshDefaultColor=new U(.8,.8,.8),this.selectionMeshPickedColor=new U(.3,.3,1),this.alwaysHideSelectionMesh=!1,this._hoverRadius=.1,this._pickRadius=.02,this._controllerPickRadius=.03,this._nearGrabLengthScale=5,this._scene=this._xrSessionManager.scene,this._options.nearInteractionControllerMode===void 0&&(this._options.nearInteractionControllerMode=2),this._options.farInteractionFeature&&(this._farInteractionFeature=this._options.farInteractionFeature)}attach(){if(!super.attach())return!1;for(let e of this._options.xrInput.controllers)this._attachController(e);return this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),this._scene.constantlyUpdateMeshUnderPointer=!0,!0}detach(){if(!super.detach())return!1;let e=Object.keys(this._controllers);for(let t of e)this._detachController(t);return!0}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){let t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}setFarInteractionFeature(e){this._farInteractionFeature=e}_nearPickPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearPickable}_nearGrabPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearGrabbable}_nearInteractionPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&(e.isNearPickable||e.isNearGrabbable)}_controllerAvailablePredicate(e,t){let i=e;for(;i;){if(i.reservedDataStore&&i.reservedDataStore.nearInteraction&&i.reservedDataStore.nearInteraction.excludedControllerId===t)return!1;i=i.parent}return!0}_handleTransitionAnimation(e,t){if(!(e.currentAnimationState===t||this._options.nearInteractionControllerMode!==2||e.xrController?.inputSource.hand)){if(t>e.currentAnimationState)switch(e.currentAnimationState){case Rn.DEHYDRATED:if(e.hydrateCollisionMeshFunction(!0),t===Rn.HOVER)break;case Rn.HOVER:if(e.touchCollisionMeshFunction(!0),t===Rn.TOUCH)break}else switch(e.currentAnimationState){case Rn.TOUCH:if(e.touchCollisionMeshFunction(!1),t===Rn.HOVER)break;case Rn.HOVER:if(e.hydrateCollisionMeshFunction(!1),t===Rn.DEHYDRATED)break}e.currentAnimationState=t}}_processTouchPoint(e,t,i){let r=this._controllers[e];r.grabRay.origin.copyFrom(t),i.toEulerAnglesToRef(k.Vector3[0]),r.grabRay.direction.copyFrom(k.Vector3[0]),this._options.nearInteractionControllerMode===2&&!r.xrController?.inputSource.hand&&(r.xrController.getWorldPointerRayToRef(this._tmpRay),r.grabRay.origin.addInPlace(this._tmpRay.direction.scale(.05))),r.grabRay.length=this._nearGrabLengthScale*this._hoverRadius*this._xrSessionManager.worldScalingFactor,r.touchCollisionMesh.position.copyFrom(r.grabRay.origin).scaleInPlace(this._xrSessionManager.worldScalingFactor)}_onXRFrame(e){let t=Object.keys(this._controllers);for(let i of t){let r=this._controllers[i],s=r.xrController?.inputSource.hand;if(!this._options.enableNearInteractionOnAllControllers&&i!==this._attachedController||!r.xrController||!s&&(!this._options.nearInteractionControllerMode||!r.xrController.inputSource.gamepad)){r.pick=null;return}if(r.hoverInteraction=!1,r.nearInteraction=!1,r.xrController){if(s){let c=s.get("index-finger-tip");if(c){let u=e.getJointPose(c,this._xrSessionManager.referenceSpace);if(u&&u.transform){let h=this._scene.useRightHandedSystem?1:-1;k.Vector3[0].set(u.transform.position.x,u.transform.position.y,u.transform.position.z*h),k.Quaternion[0].set(u.transform.orientation.x,u.transform.orientation.y,u.transform.orientation.z*h,u.transform.orientation.w*h),this._processTouchPoint(i,k.Vector3[0],k.Quaternion[0])}}}else if(r.xrController.inputSource.gamepad&&this._options.nearInteractionControllerMode!==0){let c=r.xrController.pointer;r.xrController.grip&&this._options.nearInteractionControllerMode===1&&(c=r.xrController.grip),this._processTouchPoint(i,c.position,c.rotationQuaternion)}}else return;let o=(c,u)=>{let h=null;return!u||!u.hit?h=c:!c||!c.hit||u.distance<c.distance?h=u:h=c,h},a=c=>{let u=new Ft,h=!1,d=c&&c.pickedPoint&&c.hit;return c?.pickedPoint&&(h=c.pickedPoint.x===0&&c.pickedPoint.y===0&&c.pickedPoint.z===0),d&&!h&&(u=c),u};if(!r.grabInteraction){let c=null,u=null;this._options.useUtilityLayer&&this._utilityLayerScene&&(u=this._pickWithSphere(r,this._hoverRadius*this._xrSessionManager.worldScalingFactor,this._utilityLayerScene,f=>this._nearInteractionPredicate(f)));let h=this._pickWithSphere(r,this._hoverRadius*this._xrSessionManager.worldScalingFactor,this._scene,f=>this._nearInteractionPredicate(f)),d=o(h,u);if(d&&d.hit&&(c=a(d),c.hit&&(r.hoverInteraction=!0)),r.hoverInteraction){let f=null,p=(s?this._pickRadius:this._controllerPickRadius)*this._xrSessionManager.worldScalingFactor;this._options.useUtilityLayer&&this._utilityLayerScene&&(f=this._pickWithSphere(r,p,this._utilityLayerScene,b=>this._nearPickPredicate(b)));let g=this._pickWithSphere(r,p,this._scene,b=>this._nearPickPredicate(b)),_=o(g,f),y=a(_);y.hit&&(c=y,r.nearInteraction=!0)}r.stalePick=r.pick,r.pick=c,r.pick&&r.pick.pickedPoint&&r.pick.hit?(r.meshUnderPointer=r.pick.pickedMesh,r.pickedPointVisualCue.position.copyFrom(r.pick.pickedPoint),r.pickedPointVisualCue.isVisible=!this.alwaysHideSelectionMesh,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(r.id,!0)):(r.meshUnderPointer=null,r.pickedPointVisualCue.isVisible=!1,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(r.id,!1))}let l=Rn.DEHYDRATED;r.grabInteraction||r.nearInteraction?l=Rn.TOUCH:r.hoverInteraction&&(l=Rn.HOVER),this._handleTransitionAnimation(r,l)}}get _utilityLayerScene(){return this._options.customUtilityLayerScene||jr.DefaultUtilityLayer.utilityLayerScene}_generateVisualCue(){let e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||jr.DefaultUtilityLayer.utilityLayerScene:this._scene,t=eo("nearInteraction",{diameter:.0035*3*this._xrSessionManager.worldScalingFactor},e);t.bakeCurrentTransformIntoVertices(),t.isPickable=!1,t.isVisible=!1,t.rotationQuaternion=Q.Identity();let i=new te("targetMat",e);return i.specularColor=U.Black(),i.emissiveColor=this.selectionMeshDefaultColor,i.backFaceCulling=!1,t.material=i,t}_isControllerReadyForNearInteraction(e){return this._farInteractionFeature?this._farInteractionFeature._getPointerSelectionDisabledByPointerId(e):!0}_attachNearInteractionMode(e){let t=this._controllers[e.uniqueId],i={pointerId:t.id,pointerType:"xr-near"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{!this._options.enableNearInteractionOnAllControllers&&e.uniqueId!==this._attachedController||!t.xrController||!t.xrController.inputSource.hand&&(!this._options.nearInteractionControllerMode||!t.xrController.inputSource.gamepad)||(t.pick&&(t.pick.ray=t.grabRay),t.pick&&this._isControllerReadyForNearInteraction(t.id)&&this._scene.simulatePointerMove(t.pick,i),t.nearInteraction&&t.pick&&t.pick.hit?t.nearInteractionTargetMesh||(this._scene.simulatePointerDown(t.pick,i),t.nearInteractionTargetMesh=t.meshUnderPointer,t.downTriggered=!0):t.nearInteractionTargetMesh&&t.stalePick&&(this._scene.simulatePointerUp(t.stalePick,i),t.downTriggered=!1,t.nearInteractionTargetMesh=null))});let r=s=>{this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController&&this._isControllerReadyForNearInteraction(t.id)?(t.pick&&(t.pick.ray=t.grabRay),s&&t.pick&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)?(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i),t.downTriggered=!0):!s&&t.pick&&t.grabInteraction&&(this._scene.simulatePointerUp(t.pick,i),t.downTriggered=!1,t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!this.alwaysHideSelectionMesh)):s&&!this._options.enableNearInteractionOnAllControllers&&!this._options.disableSwitchOnClick&&(this._attachedController=e.uniqueId)};if(e.inputSource.gamepad){let s=o=>{t.squeezeComponent=o.getComponent("grasp"),t.squeezeComponent?t.onSqueezeButtonChangedObserver=t.squeezeComponent.onButtonStateChangedObservable.add(a=>{if(a.changes.pressed){let l=a.changes.pressed.current;r(l)}}):(t.selectionComponent=o.getMainComponent(),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add(a=>{if(a.changes.pressed){let l=a.changes.pressed.current;r(l)}}))};e.motionController?s(e.motionController):e.onMotionControllerInitObservable.add(s)}else{let s=a=>{t.xrController&&a.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)&&(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i),t.downTriggered=!0)},o=a=>{t.xrController&&a.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&(this._scene.simulatePointerUp(t.pick,i),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!this.alwaysHideSelectionMesh,t.downTriggered=!1)};t.eventListeners={selectend:o,selectstart:s},this._xrSessionManager.session.addEventListener("selectstart",s),this._xrSessionManager.session.addEventListener("selectend",o)}}_detachController(e){let t=this._controllers[e];if(t){if(t.squeezeComponent&&t.onSqueezeButtonChangedObserver&&t.squeezeComponent.onButtonStateChangedObservable.remove(t.onSqueezeButtonChangedObserver),t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners){let i=Object.keys(t.eventListeners);for(let r of i){let s=t.eventListeners&&t.eventListeners[r];s&&this._xrSessionManager.session.removeEventListener(r,s)}}if(t.touchCollisionMesh.dispose(),t.pickedPointVisualCue.dispose(),this._xrSessionManager.runInXRFrame(()=>{if(!t.downTriggered)return;let i={pointerId:t.id,pointerType:"xr-near"};this._scene.simulatePointerUp(new Ft,i)}),t._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(t._worldScaleObserver),delete this._controllers[e],this._attachedController===e){let i=Object.keys(this._controllers);i.length?this._attachedController=i[0]:this._attachedController=""}}}_generateNewTouchPointMesh(){let e=this._xrSessionManager.worldScalingFactor,t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||jr.DefaultUtilityLayer.utilityLayerScene:this._scene,i=eo("PickSphere",{diameter:1*e},t);if(i.isVisible=!1,this._options.motionControllerOrbMaterial)i.material=this._options.motionControllerOrbMaterial;else{let R;this._options.motionControllerTouchMaterialSnippetUrl?R=Xt.ParseFromFileAsync("motionControllerTouchMaterial",this._options.motionControllerTouchMaterialSnippetUrl,t):R=Xt.ParseFromSnippetAsync("8RUNKL#3",t),R.then(M=>{i.material=M}).catch(M=>{P.Warn(`Error creating touch material in WebXRNearInteraction: ${M}`)})}let r=new Dc;r.setEasingMode(Qi.EASINGMODE_EASEINOUT);let s=new m(this._controllerPickRadius,this._controllerPickRadius,this._controllerPickRadius).scaleInPlace(e),o=this._controllerPickRadius*(4/3),a=new m(o,o,o).scaleInPlace(e),l=this._controllerPickRadius*(7/6),c=new m(l,l,l).scaleInPlace(e),u=this._controllerPickRadius*(4/5),h=new m(u,u,u).scaleInPlace(e),d=this._controllerPickRadius*(3/2),f=new m(d,d,d).scaleInPlace(e),p=[{frame:0,value:s},{frame:10,value:f},{frame:18,value:a}],g=[{frame:0,value:a},{frame:10,value:h},{frame:18,value:s}],_=[{frame:0,value:m.ZeroReadOnly},{frame:12,value:c},{frame:15,value:s}],y=[{frame:0,value:s},{frame:10,value:m.ZeroReadOnly},{frame:15,value:m.ZeroReadOnly}],b=new H("touch","scaling",60,H.ANIMATIONTYPE_VECTOR3,H.ANIMATIONLOOPMODE_CONSTANT),A=new H("release","scaling",60,H.ANIMATIONTYPE_VECTOR3,H.ANIMATIONLOOPMODE_CONSTANT),I=new H("hydrate","scaling",60,H.ANIMATIONTYPE_VECTOR3,H.ANIMATIONLOOPMODE_CONSTANT),v=new H("dehydrate","scaling",60,H.ANIMATIONTYPE_VECTOR3,H.ANIMATIONLOOPMODE_CONSTANT);return b.setEasingFunction(r),A.setEasingFunction(r),I.setEasingFunction(r),v.setEasingFunction(r),b.setKeys(p),A.setKeys(g),I.setKeys(_),v.setKeys(y),{touchCollisionMesh:i,touchCollisionMeshFunction:R=>{let M=R?b:A;t.beginDirectAnimation(i,[M],0,18,!1,1)},hydrateCollisionMeshFunction:R=>{let M=R?I:v;R&&(i.isVisible=!0),t.beginDirectAnimation(i,[M],0,15,!1,1,()=>{R||(i.isVisible=!1)})}}}_pickWithSphere(e,t,i,r){let s=new Ft;if(s.distance=1/0,e.touchCollisionMesh&&e.xrController){let o=e.touchCollisionMesh.position,a=Zg.CreateFromCenterAndRadius(o,t);for(let l=0;l<i.meshes.length;l++){let c=i.meshes[l];if(!r(c)||!this._controllerAvailablePredicate(c,e.xrController.uniqueId))continue;let u=n.PickMeshWithSphere(c,a);u&&u.hit&&u.distance<s.distance&&(s.hit=u.hit,s.pickedMesh=c,s.pickedPoint=u.pickedPoint,s.aimTransform=e.xrController.pointer,s.gripTransform=e.xrController.grip||null,s.originMesh=e.touchCollisionMesh,s.distance=u.distance,s.bu=u.bu,s.bv=u.bv,s.faceId=u.faceId,s.subMeshId=u.subMeshId)}}return s}static PickMeshWithSphere(e,t,i=!1){let r=e.subMeshes,s=new Ft,o=e.getBoundingInfo();if(!e._generatePointsArray()||!e.subMeshes||!o||!i&&!Zg.Intersects(o.boundingSphere,t))return s;let a=yc[0],l=yc[1];yc[2].setAll(0),yc[3].setAll(0);let c=new rt(yc[2],yc[3],1),u=1/0,h,d,f,p,g=k.Vector3[2],_=k.Matrix[0];_.copyFrom(e.getWorldMatrix()),_.invert(),m.TransformCoordinatesToRef(t.center,_,g);for(let y=0;y<r.length;y++)r[y].projectToRef(g,e._positions,e.getIndices(),l),m.TransformCoordinatesToRef(l,e.getWorldMatrix(),l),h=m.Distance(l,t.center),f=m.DistanceSquared(l,e.getAbsolutePosition()),d=m.DistanceSquared(t.center,e.getAbsolutePosition()),d!==-1&&f!==-1&&f>d&&(h=0,l.copyFrom(t.center)),h!==-1&&h<u&&(u=h,rt.CreateFromToToRef(t.center,l,c),c.length=u*2,p=c.intersectsMesh(e),a.copyFrom(l));return u<t.radius&&(s.hit=!0,s.distance=u,s.pickedMesh=e,s.pickedPoint=a.clone(),p&&p.bu!==null&&p.bv!==null&&(s.faceId=p.faceId,s.subMeshId=p.subMeshId,s.bu=p.bu,s.bv=p.bv)),s}};Xr._IdCounter=200;Xr.Name=fn.NEAR_INTERACTION;Xr.Version=1;pn.AddWebXRFeature(Xr.Name,(n,e)=>()=>new Xr(n,e),Xr.Version,!0);var xT=class{constructor(e,t,i){this.element=e,this.sessionMode=t,this.referenceSpaceType=i}update(e){}};var Fg=class n{constructor(e,t){if(this._scene=e,this.options=t,this._activeButton=null,this._buttons=[],this.activeButtonChangedObservable=new F,this._onSessionGranted=r=>{this._helper&&this._enterXRWithButtonIndexAsync(0)},this.overlay=document.createElement("div"),this.overlay.classList.add("xr-button-overlay"),!t.ignoreSessionGrantedEvent&&navigator.xr&&navigator.xr.addEventListener("sessiongranted",this._onSessionGranted),typeof window<"u"&&window.location&&window.location.protocol==="http:"&&window.location.hostname!=="localhost")throw z.Warn("WebXR can only be served over HTTPS"),new Error("WebXR can only be served over HTTPS");if(t.customButtons)this._buttons=t.customButtons;else{this.overlay.style.cssText="z-index:11;position: absolute; right: 20px;bottom: 50px;";let r=t.sessionMode||"immersive-vr",s=t.referenceSpaceType||"local-floor",a=".babylonVRicon { color: #868686; border-color: #868686; border-style: solid; margin-left: 10px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(typeof SVGSVGElement>"u"?"https://cdn.babylonjs.com/Assets/vrButton.png":"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";a+='.babylonVRicon.vrdisplaypresenting { background-image: none;} .vrdisplaypresenting::after { content: "EXIT"} .xr-error::after { content: "ERROR"}';let l=document.createElement("style");l.appendChild(document.createTextNode(a)),document.getElementsByTagName("head")[0].appendChild(l);let c=document.createElement("button");c.className="babylonVRicon",c.title=`${r} - ${s}`,this._buttons.push(new xT(c,r,s)),this._buttons[this._buttons.length-1].update=function(u){this.element.style.display=u===null||u===this?"":"none",c.className="babylonVRicon"+(u===this?" vrdisplaypresenting":"")},this._updateButtons(null)}let i=e.getEngine().getInputElement();i&&i.parentNode&&(i.parentNode.appendChild(this.overlay),e.onDisposeObservable.addOnce(()=>{this.dispose()}))}setHelperAsync(e,t){return S(this,null,function*(){this._helper=e,this._renderTarget=t;let i=this._buttons.map(s=>S(this,null,function*(){return yield e.sessionManager.isSessionSupportedAsync(s.sessionMode)}));e.onStateChangedObservable.add(s=>{s==3&&this._updateButtons(null)});let r=yield Promise.all(i);for(let s=0;s<r.length;s++)r[s]?(this.overlay.appendChild(this._buttons[s].element),this._buttons[s].element.onclick=this._enterXRWithButtonIndexAsync.bind(this,s)):z.Warn(`Session mode "${this._buttons[s].sessionMode}" not supported in browser`)})}static CreateAsync(e,t,i){return S(this,null,function*(){let r=new n(e,i);return yield r.setHelperAsync(t,i.renderTarget||void 0),r})}_enterXRWithButtonIndexAsync(e=0){return S(this,null,function*(){if(this._helper.state==2)yield this._helper.exitXRAsync(),this._updateButtons(null);else if(this._helper.state==3)try{yield this._helper.enterXRAsync(this._buttons[e].sessionMode,this._buttons[e].referenceSpaceType,this._renderTarget,{optionalFeatures:this.options.optionalFeatures,requiredFeatures:this.options.requiredFeatures}),this._updateButtons(this._buttons[e])}catch(t){this._updateButtons(null);let i=this._buttons[e].element,r=i.title;i.title="Error entering XR session : "+r,i.classList.add("xr-error"),this.options.onError&&this.options.onError(t)}})}dispose(){let e=this._scene.getEngine().getInputElement();e&&e.parentNode&&e.parentNode.contains(this.overlay)&&e.parentNode.removeChild(this.overlay),this.activeButtonChangedObservable.clear(),navigator.xr.removeEventListener("sessiongranted",this._onSessionGranted)}_updateButtons(e){this._activeButton=e;for(let t of this._buttons)t.update(this._activeButton);this.activeButtonChangedObservable.notifyObservers(this._activeButton)}};var qn=["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"],Xk={wrist:["wrist"],thumb:["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],index:["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],middle:["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],ring:["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],little:["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]},CT=class{get handMesh(){return this._handMesh}getHandPartMeshes(e){return Xk[e].map(t=>this._jointMeshes[qn.indexOf(t)])}getJointMesh(e){return this._jointMeshes[qn.indexOf(e)]}constructor(e,t,i,r,s=!1,o=!1,a=1){this.xrController=e,this._jointMeshes=t,this._handMesh=i,this.rigMapping=r,this._leftHandedMeshes=s,this._jointsInvisible=o,this._jointScaleFactor=a,this.onHandMeshSetObservable=new F,this._jointTransforms=new Array(qn.length),this._jointTransformMatrices=new Float32Array(qn.length*16),this._tempJointMatrix=new L,this._jointRadii=new Float32Array(qn.length),this._handMeshRoot=null,this._scene=t[0].getScene();for(let l=0;l<this._jointTransforms.length;l++)this._jointTransforms[l]=new vi(qn[l],this._scene),this._jointTransforms[l].rotationQuaternion=new Q,t[l].rotationQuaternion?t[l].rotationQuaternion=new Q:t[l].rotationQuaternion?.set(0,0,0,1);i&&this.setHandMesh(i,r),this.xrController.motionController&&this.xrController.motionController.rootMesh&&this.xrController.motionController.rootMesh.dispose(!1,!0),this.xrController.onMotionControllerInitObservable.add(l=>{l._doNotLoadControllerMesh=!0})}setHandMesh(e,t,i){for(this._handMesh=e,this._handMeshRoot=this._handMesh;this._handMeshRoot.parent;)this._handMeshRoot=this._handMeshRoot.parent;e.alwaysSelectAsActiveMesh=!0;let r=e.getChildMeshes();for(let s of r)s.alwaysSelectAsActiveMesh=!0;if(this._handMesh.skeleton){let s=this._handMesh.skeleton;for(let o=0;o<qn.length;o++){let a=qn[o],l=s.getBoneIndexByName(t?t[a]:a);l!==-1&&s.bones[l].linkTransformNode(this._jointTransforms[o])}}this.onHandMeshSetObservable.notifyObservers(this)}updateFromXRFrame(e,t,i){let r=this.xrController.inputSource.hand;if(!r)return;let s=r,o=qn.map(l=>s[l]||r.get(l)),a=!1;if(e.fillPoses&&e.fillJointRadii)a=e.fillPoses(o,t,this._jointTransformMatrices)&&e.fillJointRadii(o,this._jointRadii);else if(e.getJointPose){a=!0;for(let l=0;l<o.length;l++){let c=e.getJointPose(o[l],t);if(c)this._jointTransformMatrices.set(c.transform.matrix,l*16),this._jointRadii[l]=c.radius||.008;else{a=!1;break}}}if(a){for(let l=0;l<qn.length;l++){let c=this._jointTransforms[l];L.FromArrayToRef(this._jointTransformMatrices,l*16,this._tempJointMatrix),this._tempJointMatrix.decompose(void 0,c.rotationQuaternion,c.position);let u=this._jointRadii[l]*this._jointScaleFactor,h=this._jointMeshes[l];h.isVisible=!this._handMesh&&!this._jointsInvisible,h.position.copyFrom(c.position),h.rotationQuaternion.copyFrom(c.rotationQuaternion),h.scaling.setAll(u),h.parent=i.parent,this._scene.useRightHandedSystem||(h.position.z*=-1,h.rotationQuaternion.z*=-1,h.rotationQuaternion.w*=-1,this._leftHandedMeshes&&this._handMesh&&(c.position.z*=-1,c.rotationQuaternion.z*=-1,c.rotationQuaternion.w*=-1))}this._handMesh&&(this._handMesh.isVisible=!0,this._handMeshRoot&&(this._handMeshRoot.parent=i.parent)),this.xrController.pointer.parent=i.parent}}dispose(e=!1){this._handMesh&&(e?(this._handMesh.skeleton?.dispose(),this._handMesh.dispose(!1,!0)):this._handMesh.isVisible=!1);for(let t of this._jointTransforms)t.dispose();this._jointTransforms.length=0,this.onHandMeshSetObservable.clear()}},Fi=class n extends $r{static _GenerateTrackedJointMeshes(e,t=rc("jointParent",n._ICOSPHERE_PARAMS)){let i={};return["left","right"].map(r=>{let s=[];t.isVisible=!!e.jointMeshes?.keepOriginalVisible;for(let o=0;o<qn.length;++o){let a=t.createInstance(`${r}-handJoint-${o}`);if(e.jointMeshes?.onHandJointMeshGenerated){let l=e.jointMeshes.onHandJointMeshGenerated(a,o,r);l&&l!==a&&(a.dispose(),a=l)}if(a.isPickable=!1,e.jointMeshes?.enablePhysics){let l=e.jointMeshes?.physicsProps||{};a.scaling.setAll(.02);let c=l.impostorType!==void 0?l.impostorType:Te.SphereImpostor;a.physicsImpostor=new Te(a,c,Y({mass:0},l))}a.rotationQuaternion=new Q,a.isVisible=!1,s.push(a)}i[r]=s}),{left:i.left,right:i.right}}static _GenerateDefaultHandMeshesAsync(e,t,i){return S(this,null,function*(){return yield new Promise(r=>S(null,null,function*(){let s={};n._RightHandGLB?.meshes[1]?.isDisposed()&&(n._RightHandGLB=null),n._LeftHandGLB?.meshes[1]?.isDisposed()&&(n._LeftHandGLB=null);let o=!!(n._RightHandGLB&&n._LeftHandGLB),a=z.GetAssetUrl(n.DEFAULT_HAND_MODEL_BASE_URL),l=yield Promise.all([n._RightHandGLB||Ho.ImportMeshAsync("",a,n.DEFAULT_HAND_MODEL_RIGHT_FILENAME,e),n._LeftHandGLB||Ho.ImportMeshAsync("",a,n.DEFAULT_HAND_MODEL_LEFT_FILENAME,e)]);n._RightHandGLB=l[0],n._LeftHandGLB=l[1];let c=z.GetAssetUrl(n.DEFAULT_HAND_MODEL_SHADER_URL),u=yield Xt.ParseFromFileAsync("handShader",c,e,void 0,!0);u.needDepthPrePass=!0,u.transparencyMode=Re.MATERIAL_ALPHABLEND,u.alphaMode=2,u.build(!1);let h=Y({base:U.FromInts(116,63,203),fresnel:U.FromInts(149,102,229),fingerColor:U.FromInts(177,130,255),tipFresnel:U.FromInts(220,200,255)},i?.handMeshes?.customColors),d={base:u.getBlockByName("baseColor"),fresnel:u.getBlockByName("fresnelColor"),fingerColor:u.getBlockByName("fingerColor"),tipFresnel:u.getBlockByName("tipFresnelColor")};d.base.value=h.base,d.fresnel.value=h.fresnel,d.fingerColor.value=h.fingerColor,d.tipFresnel.value=h.tipFresnel;let f=t._getBaseLayerWrapper()?.isMultiview,p=["left","right"];for(let g of p){let _=g=="left"?n._LeftHandGLB:n._RightHandGLB;if(!_)throw new Error("Could not load hand model");let y=_.meshes[1];y._internalAbstractMeshDataInfo._computeBonesUsingShaders=!0,!f&&!i?.handMeshes?.disableHandShader&&(y.material=u.clone(`${g}HandShaderClone`,!0)),y.isVisible=!1,s[g]=y,!o&&!e.useRightHandedSystem&&_.meshes[1].rotate(Li.Y,Math.PI)}u.dispose(),r({left:s.left,right:s.right})}))})}static _GenerateDefaultHandMeshRigMapping(e){let t=e=="right"?"R":"L";return{wrist:`wrist_${t}`,"thumb-metacarpal":`thumb_metacarpal_${t}`,"thumb-phalanx-proximal":`thumb_proxPhalanx_${t}`,"thumb-phalanx-distal":`thumb_distPhalanx_${t}`,"thumb-tip":`thumb_tip_${t}`,"index-finger-metacarpal":`index_metacarpal_${t}`,"index-finger-phalanx-proximal":`index_proxPhalanx_${t}`,"index-finger-phalanx-intermediate":`index_intPhalanx_${t}`,"index-finger-phalanx-distal":`index_distPhalanx_${t}`,"index-finger-tip":`index_tip_${t}`,"middle-finger-metacarpal":`middle_metacarpal_${t}`,"middle-finger-phalanx-proximal":`middle_proxPhalanx_${t}`,"middle-finger-phalanx-intermediate":`middle_intPhalanx_${t}`,"middle-finger-phalanx-distal":`middle_distPhalanx_${t}`,"middle-finger-tip":`middle_tip_${t}`,"ring-finger-metacarpal":`ring_metacarpal_${t}`,"ring-finger-phalanx-proximal":`ring_proxPhalanx_${t}`,"ring-finger-phalanx-intermediate":`ring_intPhalanx_${t}`,"ring-finger-phalanx-distal":`ring_distPhalanx_${t}`,"ring-finger-tip":`ring_tip_${t}`,"pinky-finger-metacarpal":`little_metacarpal_${t}`,"pinky-finger-phalanx-proximal":`little_proxPhalanx_${t}`,"pinky-finger-phalanx-intermediate":`little_intPhalanx_${t}`,"pinky-finger-phalanx-distal":`little_distPhalanx_${t}`,"pinky-finger-tip":`little_tip_${t}`}}isCompatible(){return typeof XRHand<"u"}getHandByControllerId(e){return this._attachedHands[e]}getHandByHandedness(e){return e=="none"?null:this._trackingHands[e]}constructor(e,t){super(e),this.options=t,this._attachedHands={},this._trackingHands={left:null,right:null},this._handResources={jointMeshes:null,handMeshes:null,rigMappings:null},this._worldScaleObserver=null,this.onHandAddedObservable=new F,this.onHandRemovedObservable=new F,this._attachHand=s=>{if(!s.inputSource.hand||s.inputSource.handedness=="none"||!this._handResources.jointMeshes)return;let o=s.inputSource.handedness,a=new CT(s,this._handResources.jointMeshes[o],this._handResources.handMeshes&&this._handResources.handMeshes[o],this._handResources.rigMappings&&this._handResources.rigMappings[o],this.options.handMeshes?.meshesUseLeftHandedCoordinates,this.options.jointMeshes?.invisible,this.options.jointMeshes?.scaleFactor);this._attachedHands[s.uniqueId]=a,this._trackingHands[o]=a,this.onHandAddedObservable.notifyObservers(a)},this._detachHand=s=>{this._detachHandById(s.uniqueId)},this.xrNativeFeatureName="hand-tracking";let r=t.jointMeshes;if(r&&(typeof r.disableDefaultHandMesh<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.disableDefaultMeshes=r.disableDefaultHandMesh),typeof r.handMeshes<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.customMeshes=r.handMeshes),typeof r.leftHandedSystemMeshes<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.meshesUseLeftHandedCoordinates=r.leftHandedSystemMeshes),typeof r.rigMapping<"u")){t.handMeshes=t.handMeshes||{};let s={},o={},a=[[r.rigMapping.left,s],[r.rigMapping.right,o]];for(let l of a){let c=l[0],u=l[1];for(let h=0;h<c.length;h++){let d=c[h];u[qn[h]]=d}}t.handMeshes.customRigMappings={left:s,right:o}}}attach(){if(!super.attach())return!1;this._handResources.jointMeshes||(this._originalMesh=this._originalMesh||this.options.jointMeshes?.sourceMesh||rc("jointParent",n._ICOSPHERE_PARAMS),this._originalMesh.isVisible=!1,this._handResources.jointMeshes=n._GenerateTrackedJointMeshes(this.options,this._originalMesh)),this._handResources.handMeshes=this.options.handMeshes?.customMeshes||null,this._handResources.rigMappings=this.options.handMeshes?.customRigMappings||null,!this.options.handMeshes?.customMeshes&&!this.options.handMeshes?.disableDefaultMeshes&&(n._GenerateDefaultHandMeshesAsync(ye.LastCreatedScene,this._xrSessionManager,this.options).then(e=>{this._handResources.handMeshes=e,this._handResources.rigMappings={left:n._GenerateDefaultHandMeshRigMapping("left"),right:n._GenerateDefaultHandMeshRigMapping("right")},this._trackingHands.left?.setHandMesh(this._handResources.handMeshes.left,this._handResources.rigMappings.left,this._xrSessionManager),this._trackingHands.right?.setHandMesh(this._handResources.handMeshes.right,this._handResources.rigMappings.right,this._xrSessionManager),this._handResources.handMeshes.left.scaling.setAll(this._xrSessionManager.worldScalingFactor),this._handResources.handMeshes.right.scaling.setAll(this._xrSessionManager.worldScalingFactor)}),this._worldScaleObserver=this._xrSessionManager.onWorldScaleFactorChangedObservable.add(e=>{this._handResources.handMeshes&&(this._handResources.handMeshes.left.scaling.scaleInPlace(e.newScaleFactor/e.previousScaleFactor),this._handResources.handMeshes.right.scaling.scaleInPlace(e.newScaleFactor/e.previousScaleFactor))}));for(let e of this.options.xrInput.controllers)this._attachHand(e);return this._addNewAttachObserver(this.options.xrInput.onControllerAddedObservable,this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerRemovedObservable,this._detachHand),!0}_onXRFrame(e){this._trackingHands.left?.updateFromXRFrame(e,this._xrSessionManager.referenceSpace,this.options.xrInput.xrCamera),this._trackingHands.right?.updateFromXRFrame(e,this._xrSessionManager.referenceSpace,this.options.xrInput.xrCamera)}_detachHandById(e,t){let i=this.getHandByControllerId(e);if(i){let r=i.xrController.inputSource.handedness=="left"?"left":"right";this._trackingHands[r]?.xrController.uniqueId===e&&(this._trackingHands[r]=null),this.onHandRemovedObservable.notifyObservers(i),i.dispose(t),delete this._attachedHands[e]}}detach(){if(!super.detach())return!1;let e=Object.keys(this._attachedHands);for(let t of e)this._detachHandById(t,this.options.handMeshes?.disposeOnSessionEnd);if(this.options.handMeshes?.disposeOnSessionEnd){if(this._handResources.jointMeshes){for(let t of this._handResources.jointMeshes.left)t.dispose();for(let t of this._handResources.jointMeshes.right)t.dispose();this._handResources.jointMeshes=null}if(this._handResources.handMeshes&&(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),this._handResources.handMeshes=null),n._RightHandGLB)for(let t of n._RightHandGLB.meshes)t.dispose();if(n._LeftHandGLB)for(let t of n._LeftHandGLB.meshes)t.dispose();n._RightHandGLB=null,n._LeftHandGLB=null,this._originalMesh?.dispose(),this._originalMesh=void 0}return this._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(this._worldScaleObserver),!0}dispose(){if(super.dispose(),this.onHandAddedObservable.clear(),this.onHandRemovedObservable.clear(),this._handResources.handMeshes&&!this.options.handMeshes?.customMeshes){if(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),n._RightHandGLB)for(let e of n._RightHandGLB.meshes)e.dispose();if(n._LeftHandGLB)for(let e of n._LeftHandGLB.meshes)e.dispose();n._RightHandGLB=null,n._LeftHandGLB=null}if(this._handResources.jointMeshes){for(let e of this._handResources.jointMeshes.left)e.dispose();for(let e of this._handResources.jointMeshes.right)e.dispose()}}};Fi.Name=fn.HAND_TRACKING;Fi.Version=1;Fi.DEFAULT_HAND_MODEL_BASE_URL="https://assets.babylonjs.com/core/HandMeshes/";Fi.DEFAULT_HAND_MODEL_RIGHT_FILENAME="r_hand_rhs.glb";Fi.DEFAULT_HAND_MODEL_LEFT_FILENAME="l_hand_rhs.glb";Fi.DEFAULT_HAND_MODEL_SHADER_URL="https://assets.babylonjs.com/core/HandMeshes/handsShader.json";Fi._ICOSPHERE_PARAMS={radius:.5,flat:!1,subdivisions:2};Fi._RightHandGLB=null;Fi._LeftHandGLB=null;pn.AddWebXRFeature(Fi.Name,(n,e)=>()=>new Fi(n,e),Fi.Version,!1);var Ts=class extends $r{get rotationEnabled(){return this._rotationEnabled}set rotationEnabled(e){if(this._rotationEnabled=e,this._options.teleportationTargetMesh){let t=this._options.teleportationTargetMesh.getChildMeshes(!1,i=>i.name==="rotationCone");t[0]&&t[0].setEnabled(e)}}get teleportationTargetMesh(){return this._options.teleportationTargetMesh||null}constructor(e,t){super(e),this._options=t,this._controllers={},this._snappedToPoint=!1,this._cachedColor4White=new ce(1,1,1,1),this._tmpRay=new rt(new m,new m),this._tmpVector=new m,this._tmpQuaternion=new Q,this._worldScaleObserver=null,this.skipNextTeleportation=!1,this.backwardsMovementEnabled=!0,this.backwardsTeleportationDistance=.7,this.parabolicCheckRadius=5,this.parabolicRayEnabled=!0,this.straightRayEnabled=!0,this.rotationAngle=Math.PI/8,this.onTargetMeshPositionUpdatedObservable=new F,this.teleportationEnabled=!0,this._rotationEnabled=!0,this.onBeforeCameraTeleportRotation=new F,this.onAfterCameraTeleportRotation=new F,this._attachController=i=>{if(this._controllers[i.uniqueId]||this._options.forceHandedness&&i.inputSource.handedness!==this._options.forceHandedness)return;this._controllers[i.uniqueId]={xrController:i,teleportationState:{forward:!1,backwards:!1,rotating:!1,currentRotation:0,baseRotation:0,blocked:!1,initialHit:!1,mainComponentUsed:!1}};let r=this._controllers[i.uniqueId];if(r.xrController.inputSource.targetRayMode==="tracked-pointer"&&r.xrController.inputSource.gamepad){let s=()=>{if(i.motionController){let o=i.motionController.getComponentOfType(ro.THUMBSTICK_TYPE)||i.motionController.getComponentOfType(ro.TOUCHPAD_TYPE);if(!o||this._options.useMainComponentOnly){let a=i.motionController.getMainComponent();if(!a)return;r.teleportationState.mainComponentUsed=!0,r.teleportationComponent=a,r.onButtonChangedObserver=a.onButtonStateChangedObservable.add(()=>{if(!this.teleportationEnabled)return;let l=()=>{r.teleportationState.forward=!0,r.teleportationState.initialHit=!1,this._currentTeleportationControllerId=r.xrController.uniqueId,r.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,r.teleportationState.currentRotation=0;let c=this._options.timeToTeleport||3e3;Mc({timeout:c,contextObservable:this._xrSessionManager.onXRFrameObservable,breakCondition:()=>!a.pressed,onEnded:()=>{this._currentTeleportationControllerId===r.xrController.uniqueId&&r.teleportationState.forward&&this._teleportForward(i.uniqueId)}})};a.changes.pressed&&(a.changes.pressed.current?this._options.timeToTeleportStart?Mc({timeout:this._options.timeToTeleportStart,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{a.pressed&&l()}}):l():(r.teleportationState.forward=!1,this._currentTeleportationControllerId=""))})}else r.teleportationComponent=o,r.onAxisChangedObserver=o.onAxisValueChangedObservable.add(a=>{if(a.y<=.7&&r.teleportationState.backwards&&(r.teleportationState.backwards=!1),a.y>.7&&!r.teleportationState.forward&&this.backwardsMovementEnabled&&!this.snapPointsOnly&&!r.teleportationState.backwards){r.teleportationState.backwards=!0,this._tmpQuaternion.copyFrom(this._options.xrInput.xrCamera.rotationQuaternion),this._tmpQuaternion.toEulerAnglesToRef(this._tmpVector),this._tmpVector.x=0,this._tmpVector.z=0,Q.FromEulerVectorToRef(this._tmpVector,this._tmpQuaternion),this._tmpVector.set(0,0,this.backwardsTeleportationDistance*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),this._tmpVector.rotateByQuaternionToRef(this._tmpQuaternion,this._tmpVector),this._tmpVector.addInPlace(this._options.xrInput.xrCamera.position),this._tmpRay.origin.copyFrom(this._tmpVector),this._tmpRay.length=this._options.xrInput.xrCamera.realWorldHeight+.1,this._tmpRay.direction.set(0,-1,0);let l=this._xrSessionManager.scene.pickWithRay(this._tmpRay,c=>this._floorMeshes.indexOf(c)!==-1);l&&l.pickedPoint&&(this._options.xrInput.xrCamera.position.x=l.pickedPoint.x,this._options.xrInput.xrCamera.position.z=l.pickedPoint.z)}if(a.y<-.7&&!this._currentTeleportationControllerId&&!r.teleportationState.rotating&&this.teleportationEnabled&&(r.teleportationState.forward=!0,this._currentTeleportationControllerId=r.xrController.uniqueId,r.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y),a.x){if(r.teleportationState.forward)this._currentTeleportationControllerId===r.xrController.uniqueId&&(this.rotationEnabled?setTimeout(()=>{r.teleportationState.currentRotation=Math.atan2(a.x,a.y*(this._xrSessionManager.scene.useRightHandedSystem?1:-1))}):r.teleportationState.currentRotation=0);else if(!r.teleportationState.rotating&&Math.abs(a.x)>.7){r.teleportationState.rotating=!0;let l=this.rotationAngle*(a.x>0?1:-1)*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);this.onBeforeCameraTeleportRotation.notifyObservers(l),Q.FromEulerAngles(0,l,0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this.onAfterCameraTeleportRotation.notifyObservers(this._options.xrInput.xrCamera.rotationQuaternion)}}else r.teleportationState.rotating=!1;a.x===0&&a.y===0&&(r.teleportationState.blocked&&(r.teleportationState.blocked=!1,this._setTargetMeshVisibility(!1)),r.teleportationState.forward&&this._teleportForward(i.uniqueId))})}};i.motionController?s():i.onMotionControllerInitObservable.addOnce(()=>{s()})}else{r.teleportationState.mainComponentUsed=!0;let s=!1,o=()=>{this._currentTeleportationControllerId=r.xrController.uniqueId,r.teleportationState.forward=!0,r.teleportationState.initialHit=!1,r.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,r.teleportationState.currentRotation=0;let a=this._options.timeToTeleport||3e3;Mc({timeout:a,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===r.xrController.uniqueId&&r.teleportationState.forward&&this._teleportForward(i.uniqueId)}})};this._xrSessionManager.scene.onPointerObservable.add(a=>{a.type===Ee.POINTERDOWN?(s=!1,this._options.timeToTeleportStart?Mc({timeout:this._options.timeToTeleportStart,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===r.xrController.uniqueId&&o()},breakCondition:()=>s?(s=!1,!0):!1}):o()):a.type===Ee.POINTERUP&&(s=!0,r.teleportationState.forward=!1,this._currentTeleportationControllerId="")})}},this._colorArray=Array(24).fill(this._cachedColor4White),this._options.teleportationTargetMesh||this._createDefaultTargetMesh(),this._floorMeshes=this._options.floorMeshes||[],this._snapToPositions=this._options.snapPositions||[],this._blockedRayColor=this._options.blockedRayColor||new ce(1,0,0,.75),this._setTargetMeshVisibility(!1),this.onBeforeCameraTeleport=t.xrInput.xrCamera.onBeforeCameraTeleport,this.onAfterCameraTeleport=t.xrInput.xrCamera.onAfterCameraTeleport,this.parabolicCheckRadius*=this._xrSessionManager.worldScalingFactor,this._worldScaleObserver=e.onWorldScaleFactorChangedObservable.add(i=>{this.parabolicCheckRadius=this.parabolicCheckRadius/i.previousScaleFactor*i.newScaleFactor,this._options.teleportationTargetMesh?.scaling.scaleInPlace(i.newScaleFactor/i.previousScaleFactor)})}get snapPointsOnly(){return!!this._options.snapPointsOnly}set snapPointsOnly(e){this._options.snapPointsOnly=e}addFloorMesh(e){this._floorMeshes.push(e)}addBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[],this._options.pickBlockerMeshes.push(e)}addSnapPoint(e){this._snapToPositions.push(e)}attach(){if(!super.attach())return!1;this._currentTeleportationControllerId="";for(let e of this._options.xrInput.controllers)this._attachController(e);return this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),!0}detach(){if(!super.detach())return!1;let e=Object.keys(this._controllers);for(let t of e)this._detachController(t);return this._setTargetMeshVisibility(!1),this._currentTeleportationControllerId="",this._controllers={},!0}dispose(){super.dispose(),this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.dispose(!1,!0),this._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(this._worldScaleObserver),this.onTargetMeshPositionUpdatedObservable.clear(),this.onTargetMeshPositionUpdatedObservable.clear(),this.onBeforeCameraTeleportRotation.clear(),this.onAfterCameraTeleportRotation.clear(),this.onBeforeCameraTeleport.clear(),this.onAfterCameraTeleport.clear()}removeFloorMesh(e){let t=this._floorMeshes.indexOf(e);t!==-1&&this._floorMeshes.splice(t,1)}removeBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[];let t=this._options.pickBlockerMeshes.indexOf(e);t!==-1&&this._options.pickBlockerMeshes.splice(t,1)}removeFloorMeshByName(e){let t=this._xrSessionManager.scene.getMeshByName(e);t&&this.removeFloorMesh(t)}removeSnapPoint(e){let t=this._snapToPositions.indexOf(e);if(t===-1){for(let i=0;i<this._snapToPositions.length;++i)if(this._snapToPositions[i].equals(e)){t=i;break}}return t!==-1?(this._snapToPositions.splice(t,1),!0):!1}setSelectionFeature(e){this._selectionFeature=e}_onXRFrame(e){let t=this._xrSessionManager.currentFrame,i=this._xrSessionManager.scene;if(!this.attach||!t)return;let r=this._options.teleportationTargetMesh;if(this._currentTeleportationControllerId){if(!r)return;r.rotationQuaternion=r.rotationQuaternion||new Q;let s=this._controllers[this._currentTeleportationControllerId];if(s&&s.teleportationState.forward){Q.RotationYawPitchRollToRef(s.teleportationState.currentRotation+s.teleportationState.baseRotation,0,0,r.rotationQuaternion);let o=!1,a=s.xrController.inputSource.targetRayMode!=="transient-pointer";if(s.xrController.getWorldPointerRayToRef(this._tmpRay),this.straightRayEnabled){let l=i.pickWithRay(this._tmpRay,u=>{if(this._options.blockerMeshesPredicate&&this._options.blockerMeshesPredicate(u)||this._options.blockAllPickableMeshes&&u.isPickable||this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(u)!==-1)return!0;let h=this._floorMeshes.indexOf(u);return h===-1?!1:this._floorMeshes[h].absolutePosition.y<this._options.xrInput.xrCamera.globalPosition.y}),c=l&&l.pickedMesh&&this._floorMeshes.indexOf(l.pickedMesh)!==-1;if(l&&l.pickedMesh&&!c){if(s.teleportationState.mainComponentUsed&&!s.teleportationState.initialHit){s.teleportationState.forward=!1;return}s.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1,!1,a),this._showParabolicPath(l);return}else l&&l.pickedPoint&&(s.teleportationState.initialHit=!0,s.teleportationState.blocked=!1,o=!0,this._setTargetMeshPosition(l),this._setTargetMeshVisibility(!0,!1,a),this._showParabolicPath(l))}if(this.parabolicRayEnabled&&!o){let l=s.xrController.pointer.rotationQuaternion.toEulerAngles().x,c=1+(Math.PI/2-Math.abs(l)),u=this.parabolicCheckRadius*c;this._tmpRay.origin.addToRef(this._tmpRay.direction.scale(u*2),this._tmpVector),this._tmpVector.y=this._tmpRay.origin.y,this._tmpRay.origin.addInPlace(this._tmpRay.direction.scale(u)),this._tmpVector.subtractToRef(this._tmpRay.origin,this._tmpRay.direction),this._tmpRay.direction.normalize();let h=i.pickWithRay(this._tmpRay,f=>this._options.blockerMeshesPredicate&&this._options.blockerMeshesPredicate(f)||this._options.blockAllPickableMeshes&&f.isPickable||this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(f)!==-1?!0:this._floorMeshes.indexOf(f)!==-1),d=h&&h.pickedMesh&&this._floorMeshes.indexOf(h.pickedMesh)!==-1;if(h&&h.pickedMesh&&!d){if(s.teleportationState.mainComponentUsed&&!s.teleportationState.initialHit){s.teleportationState.forward=!1;return}s.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1,!1,a),this._showParabolicPath(h);return}else h&&h.pickedPoint&&(s.teleportationState.initialHit=!0,s.teleportationState.blocked=!1,o=!0,this._setTargetMeshPosition(h),this._setTargetMeshVisibility(!0,!1,a),this._showParabolicPath(h))}this._setTargetMeshVisibility(o,!1,a)}else this._setTargetMeshVisibility(!1,!1,!0)}else this._disposeBezierCurve(),this._setTargetMeshVisibility(!1,!1,!0)}_createDefaultTargetMesh(){this._options.defaultTargetMeshOptions=this._options.defaultTargetMeshOptions||{};let e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||jr.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,t=sa("teleportationTarget",{width:2,height:2,subdivisions:2},e);if(t.isPickable=!1,this._options.defaultTargetMeshOptions.teleportationCircleMaterial)t.material=this._options.defaultTargetMeshOptions.teleportationCircleMaterial;else{let o=new no("teleportationPlaneDynamicTexture",512,e,!0);o.hasAlpha=!0;let a=o.getContext(),l=512/2,c=512/2,u=200;a.beginPath(),a.arc(l,c,u,0,2*Math.PI,!1),a.fillStyle=this._options.defaultTargetMeshOptions.teleportationFillColor||"#444444",a.fill(),a.lineWidth=10,a.strokeStyle=this._options.defaultTargetMeshOptions.teleportationBorderColor||"#FFFFFF",a.stroke(),a.closePath(),o.update();let h=new te("teleportationPlaneMaterial",e);h.diffuseTexture=o,t.material=h}let i=pr("torusTeleportation",{diameter:.75,thickness:.1,tessellation:20},e);if(i.isPickable=!1,i.parent=t,!this._options.defaultTargetMeshOptions.disableAnimation){let s=new H("animationInnerCircle","position.y",30,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CYCLE),o=[];o.push({frame:0,value:0}),o.push({frame:30,value:.4}),o.push({frame:60,value:0}),s.setKeys(o);let a=new rd;a.setEasingMode(Qi.EASINGMODE_EASEINOUT),s.setEasingFunction(a),i.animations=[],i.animations.push(s),e.beginAnimation(i,0,60,!0)}let r=aa("rotationCone",{diameterTop:0,tessellation:4},e);if(r.isPickable=!1,r.scaling.set(.5,.12,.2),r.rotate(Li.X,Math.PI/2),r.position.z=.6,r.parent=i,this._options.defaultTargetMeshOptions.torusArrowMaterial)i.material=this._options.defaultTargetMeshOptions.torusArrowMaterial,r.material=this._options.defaultTargetMeshOptions.torusArrowMaterial;else{let s=new te("torusConsMat",e);s.disableLighting=!!this._options.defaultTargetMeshOptions.disableLighting,s.disableLighting?s.emissiveColor=new U(.3,.3,1):s.diffuseColor=new U(.3,.3,1),s.alpha=.9,i.material=s,r.material=s,this._teleportationRingMaterial=s}this._options.renderingGroupId!==void 0&&(t.renderingGroupId=this._options.renderingGroupId,i.renderingGroupId=this._options.renderingGroupId,r.renderingGroupId=this._options.renderingGroupId),this._options.teleportationTargetMesh=t,this._options.teleportationTargetMesh.scaling.setAll(this._xrSessionManager.worldScalingFactor),this._setTargetMeshVisibility(!1)}_detachController(e){let t=this._controllers[e];t&&(t.teleportationComponent&&(t.onAxisChangedObserver&&t.teleportationComponent.onAxisValueChangedObservable.remove(t.onAxisChangedObserver),t.onButtonChangedObserver&&t.teleportationComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver)),delete this._controllers[e])}_findClosestSnapPointWithRadius(e,t=this._options.snapToPositionRadius||.8){let i=null,r=Number.MAX_VALUE;if(this._snapToPositions.length){let s=t*t;for(let o of this._snapToPositions){let a=m.DistanceSquared(o,e);a<=s&&a<r&&(r=a,i=o)}}return i}_setTargetMeshPosition(e){let t=e.pickedPoint;if(!this._options.teleportationTargetMesh||!t)return;let i=this._findClosestSnapPointWithRadius(t);this._snappedToPoint=!!i,this.snapPointsOnly&&!this._snappedToPoint&&this._teleportationRingMaterial?this._teleportationRingMaterial.diffuseColor.set(1,.3,.3):this.snapPointsOnly&&this._snappedToPoint&&this._teleportationRingMaterial&&this._teleportationRingMaterial.diffuseColor.set(.3,.3,1),this._options.teleportationTargetMesh.position.copyFrom(i||t),this._options.teleportationTargetMesh.position.y+=.01,this.onTargetMeshPositionUpdatedObservable.notifyObservers(e)}_setTargetMeshVisibility(e,t,i){if(!this._options.teleportationTargetMesh||this._options.teleportationTargetMesh.isVisible===e&&!t)return;this._options.teleportationTargetMesh.isVisible=e;let r=this._options.teleportationTargetMesh.getChildren(void 0,!1);for(let s of r)s.isVisible=e;e?this._selectionFeature&&i&&this._selectionFeature.detach():(this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null),this._selectionFeature&&i&&this._selectionFeature.attach())}_disposeBezierCurve(){this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null)}_showParabolicPath(e){if(!e.pickedPoint||!this._currentTeleportationControllerId)return;let t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||jr.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,i=this._controllers[this._currentTeleportationControllerId],r=FT.CreateQuadraticBezier(i.xrController.pointer.absolutePosition,e.ray.origin,e.pickedPoint,25),s=i.teleportationState.blocked?this._blockedRayColor:void 0,o=this._colorArray.fill(s||this._cachedColor4White),a=r.getPoints();a.shift(),a.shift(),this._options.generateRayPathMesh?this._quadraticBezierCurve=this._options.generateRayPathMesh(r.getPoints(),e):this._quadraticBezierCurve=na("teleportation path line",{points:a,instance:this._quadraticBezierCurve,updatable:!0,colors:o},t),this._quadraticBezierCurve.isPickable=!1,this._options.renderingGroupId!==void 0&&(this._quadraticBezierCurve.renderingGroupId=this._options.renderingGroupId)}_teleportForward(e){let t=this._controllers[e];if(!(!t||!t.teleportationState.forward||!this.teleportationEnabled)&&(t.teleportationState.forward=!1,this._currentTeleportationControllerId="",!(this.snapPointsOnly&&!this._snappedToPoint))){if(this.skipNextTeleportation){this.skipNextTeleportation=!1;return}if(this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.isVisible){let i=this._options.xrInput.xrCamera.realWorldHeight;this.onBeforeCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position),this._options.xrInput.xrCamera.position.copyFrom(this._options.teleportationTargetMesh.position),this._options.xrInput.xrCamera.position.y+=i,Q.FromEulerAngles(0,t.teleportationState.currentRotation-(this._xrSessionManager.scene.useRightHandedSystem?Math.PI:0),0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this.onAfterCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position)}}}};Ts.Name=fn.TELEPORTATION;Ts.Version=1;pn.AddWebXRFeature(Ts.Name,(n,e)=>()=>new Ts(n,e),Ts.Version,!0);var Lg=class n{constructor(){}static CreateAsync(i){return S(this,arguments,function*(e,t={}){let r=new n;if(e.onDisposeObservable.addOnce(()=>{r.dispose()}),!t.disableDefaultUI){let s=Y({renderTarget:r.renderTarget},t.uiOptions||{});t.optionalFeatures&&(typeof t.optionalFeatures=="boolean"?s.optionalFeatures=["hit-test","anchors","plane-detection","hand-tracking"]:s.optionalFeatures=t.optionalFeatures),r.enterExitUI=new Fg(e,s)}try{let s=yield wg.CreateAsync(e);if(r.baseExperience=s,t.ignoreNativeCameraTransformation&&(r.baseExperience.camera.compensateOnFirstFrame=!1),r.input=new Rg(s.sessionManager,s.camera,Y({controllerOptions:{renderingGroupId:t.renderingGroupId}},t.inputOptions||{})),!t.disablePointerSelection){let o=lt(Y({},t.pointerSelectionOptions),{xrInput:r.input,renderingGroupId:t.renderingGroupId});r.pointerSelection=r.baseExperience.featuresManager.enableFeature(qr.Name,t.useStablePlugins?"stable":"latest",o),t.disableTeleportation||(r.teleportation=r.baseExperience.featuresManager.enableFeature(Ts.Name,t.useStablePlugins?"stable":"latest",Y({floorMeshes:t.floorMeshes,xrInput:r.input,renderingGroupId:t.renderingGroupId},t.teleportationOptions)),r.teleportation.setSelectionFeature(r.pointerSelection))}return t.disableNearInteraction||(r.nearInteraction=r.baseExperience.featuresManager.enableFeature(Xr.Name,t.useStablePlugins?"stable":"latest",Y({xrInput:r.input,farInteractionFeature:r.pointerSelection,renderingGroupId:t.renderingGroupId,useUtilityLayer:!0,enableNearInteractionOnAllControllers:!0},t.nearInteractionOptions))),t.disableHandTracking||r.baseExperience.featuresManager.enableFeature(Fi.Name,t.useStablePlugins?"stable":"latest",Y({xrInput:r.input},t.handSupportOptions),void 0,!1),r.renderTarget=r.baseExperience.sessionManager.getWebXRRenderTarget(t.outputCanvasOptions),t.disableDefaultUI||(yield r.enterExitUI.setHelperAsync(r.baseExperience,r.renderTarget)),r}catch(s){return P.Error("Error initializing XR"),P.Error(s),r}})}dispose(){this.baseExperience&&this.baseExperience.dispose(),this.input&&this.input.dispose(),this.enterExitUI&&this.enterExitUI.dispose(),this.renderTarget&&this.renderTarget.dispose()}};Ce.prototype.createDefaultLight=function(n=!1){if(n&&this.lights)for(let e=0;e<this.lights.length;e++)this.lights[e].dispose();this.lights.length===0&&new Di("default light",m.Up(),this)};Ce.prototype.createDefaultCamera=function(n=!1,e=!1,t=!1){if(e&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){let i=this.getWorldExtends(l=>l.isVisible&&l.isEnabled()),r=i.max.subtract(i.min),s=i.min.add(r.scale(.5)),o,a=r.length()*1.5;if(isFinite(a)||(a=1,s.copyFromFloats(0,0,0)),n){let l=new Qe("default camera",-(Math.PI/2),Math.PI/2,a,s,this);l.lowerRadiusLimit=a*.01,l.wheelPrecision=100/a,o=l}else{let l=new Bt("default camera",new m(s.x,s.y,-a),this);l.setTarget(s),o=l}o.minZ=a*.01,o.maxZ=a*1e3,o.speed=a*.2,this.activeCamera=o,t&&o.attachControl()}};Ce.prototype.createDefaultCameraOrLight=function(n=!1,e=!1,t=!1){this.createDefaultLight(e),this.createDefaultCamera(n,e,t)};Ce.prototype.createDefaultSkybox=function(n,e=!1,t=1e3,i=0,r=!0){if(!n)return P.Warn("Can not create default skybox without environment texture."),null;r&&n&&(this.environmentTexture=n);let s=oa("hdrSkyBox",{size:t},this);if(e){let o=new Va("skyBox",this);o.backFaceCulling=!1,o.reflectionTexture=n.clone(),o.reflectionTexture&&(o.reflectionTexture.coordinatesMode=Z.SKYBOX_MODE),o.microSurface=1-i,o.disableLighting=!0,o.twoSidedLighting=!0,s.material=o}else{let o=new te("skyBox",this);o.backFaceCulling=!1,o.reflectionTexture=n.clone(),o.reflectionTexture&&(o.reflectionTexture.coordinatesMode=Z.SKYBOX_MODE),o.disableLighting=!0,s.material=o}return s.isPickable=!1,s.infiniteDistance=!0,s.ignoreCameraMaxZ=!0,s};Ce.prototype.createDefaultEnvironment=function(n){return uT?new uT(n,this):null};Ce.prototype.createDefaultVRExperience=function(n={}){return new $D(this,n)};Ce.prototype.createDefaultXRExperienceAsync=function(){return S(this,arguments,function*(n={}){return yield Lg.CreateAsync(this,n)})};var ji={INITIAL_ALPHA:Math.PI/2,INITIAL_BETA:15*Math.PI/32,INITIAL_RADIUS:3,WHEEL_PRECISION:200,ANGULAR_SENSITIVITY:3e3,FRAMING_TIME:0,ELEVATION_RETURN_TIME:3e3,ELEVATION_WAIT_TIME:9e3,RADIUS_ADJUSTMENT:1.5,RADIUS_LOWER_LIMIT_RATIO:.5,RADIUS_UPPER_LIMIT_RATIO:2},TT={POINT_LIGHT_INTENSITY:.2,HEMISPHERIC_LIGHT_INTENSITY:.2},vc=class n{constructor(e){this.ngZone=e}engine=null;scene=null;camera=null;canvas=null;framingBehavior=null;envTexture="assets/textures/environmentSpecular.env";glowLayer=null;parentBox=null;meshToZoom=null;sceneHelper=null;pointLightBottom=null;hemisphericLightLeft=null;hemisphericLightRight=null;cameraInitialAlpha=null;cameraInitialBeta=null;cameraInitialRadius=null;keydownListener;isInspectorLoaded=!1;get currentGlowLayer(){return this.glowLayer}initScene(e,t,i){this.createEngine(e),this.createScene(),this.createPrincipalCamera(i),t.createEnvironmentTexture&&this.createDefaultEnvironment(),t.createLights&&this.createDefaultLights(),t.allowCamControls&&this.allowCamControls(!0),t.createGlowLayer&&this.scene&&(this.glowLayer=new Mn("glow",this.scene),this.glowLayer.intensity=.8),this.showDebugLayer()}createEngine(e){this.ngZone.runOutsideAngular(()=>{this.engine=new di(e,!0,{adaptToDeviceRatio:!0,preserveDrawingBuffer:!0,stencil:!0,disableWebGL2Support:!1})}),this.canvas=e}createScene(){this.scene=new Ce(this.engine,{preserveDrawingBuffer:!0})}allowCamControls(e){!this.scene||!this.camera||(this.scene.activeCamera=this.camera,e?this.camera.attachControl(this.canvas,!0):this.camera.detachControl())}createPrincipalCamera(e){this.scene&&(this.camera=new Qe("mainCamera",ji.INITIAL_ALPHA,ji.INITIAL_BETA,ji.INITIAL_RADIUS,m.Zero(),this.scene),this.scene.setActiveCameraById(this.camera.id),this.configureCameraSettings(e))}configureCameraSettings(e){this.camera&&(this.camera.wheelPrecision=ji.WHEEL_PRECISION,this.camera.angularSensibilityX=ji.ANGULAR_SENSITIVITY,this.camera.angularSensibilityY=ji.ANGULAR_SENSITIVITY,this.camera.minZ=0,this.camera.useFramingBehavior=!0,this.camera.framingBehavior&&(this.framingBehavior=this.camera.framingBehavior,this.configureFramingBehavior(e.autoElevation)),e.removeKeyBoardInputs&&this.camera.inputs.removeByType("ArcRotateCameraKeyboardMoveInput"),e.disablePanning&&(this.camera._useCtrlForPanning=!1,this.camera.panningSensibility=0))}configureFramingBehavior(e){this.framingBehavior&&(e?(this.framingBehavior.elevationReturnTime=-1,this.framingBehavior.autoCorrectCameraLimitsAndSensibility=!1):(this.framingBehavior.elevationReturnTime=ji.ELEVATION_RETURN_TIME,this.framingBehavior.elevationReturnWaitTime=ji.ELEVATION_WAIT_TIME))}rendererLoopCallback=()=>{this.engine?.resize(),this.scene?.render()};onResize=()=>{this.engine&&this.engine.resize()};startAnimation(){this.engine&&this.ngZone.runOutsideAngular(()=>{this.engine.runRenderLoop(this.rendererLoopCallback),window.addEventListener("resize",this.onResize)})}stopAnimation(){this.engine&&(this.engine.stopRenderLoop(this.rendererLoopCallback),window.removeEventListener("resize",this.onResize))}loadModel(e,t){return S(this,null,function*(){if(!this.scene)throw new Error("Scene not initialized.");try{return yield Gw(e,this.scene,{name:this.extractFileName(e),pluginExtension:".glb",onProgress:t})}catch(i){throw new Error(`Failed to load model from "${e}": ${i}`)}})}extractFileName(e){return e.split("/").pop()||""}setCameraInitialTarget(e=!1,t=!0,i=!1,r,s=!0,o=!0){if(!r?.meshes)return;let a=this.createParentBoundingBox(r.meshes,i);return o&&(this.parentBox=a),t&&this.setRadius(e,s),a}createParentBoundingBox(e,t){let i=this.calculateCombinedBoundingInfo(e),r=this.createBoundingBoxMesh(i),s=e[0];return s.setBoundingInfo(i),s.computeWorldMatrix(!0),s.setParent(r),s.isPickable=!0,t&&r.position.set(0,0,0),r.normalizeToUnitCube(!0),r.computeWorldMatrix(!0),r.refreshBoundingInfo(!0,!0),r.isPickable=!0,r}calculateCombinedBoundingInfo(e){let t=null,i=null;e[0].scaling.scaleInPlace(1);let r=e[0].getChildMeshes();for(let s of r){s.refreshBoundingInfo(!0,!0),s.computeWorldMatrix(!0);let o=s.getBoundingInfo().boundingBox;t=t?m.Minimize(t,o.minimumWorld):o.minimumWorld.clone(),i=i?m.Maximize(i,o.maximumWorld):o.maximumWorld.clone()}return new es(t,i)}createBoundingBoxMesh(e){let t=e.boundingBox.maximumWorld.subtract(e.boundingBox.minimumWorld),i=e.boundingBox.centerWorld,r=$i.CreateBox("parentBox"+Math.random(),{size:1},this.scene);return r.scaling.copyFrom(t),r.position.copyFrom(i),r.visibility=.4,r.isVisible=!1,r}setRadius(e,t=!0,i=!0){if(!this.parentBox||!this.framingBehavior)return;let r=this.createZoomMesh();this.frameCamera(r,e),t?this.meshToZoom=r:r.dispose(!1,!0),this.finalizeCameraSetup(e,i)}createZoomMesh(){let e=this.parentBox.clone("clone"+Math.random());return e.getChildren().forEach(t=>{t.setParent(null),t.dispose(),this.scene?.removeMesh(t)}),this.scaleMesh(e,ji.RADIUS_ADJUSTMENT),e}frameCamera(e,t){this.framingBehavior&&(this.framingBehavior.framingTime=ji.FRAMING_TIME,this.framingBehavior.zoomOnMesh(e,!1,()=>{t||this.framingBehavior?.detach()}))}finalizeCameraSetup(e,t){this.camera&&(e||(this.camera.useFramingBehavior=!0,this.camera.framingBehavior&&(this.framingBehavior=this.camera.framingBehavior),this.camera._useCtrlForPanning=!1,this.camera.panningSensibility=0,this.camera.wheelPrecision=ji.WHEEL_PRECISION,this.camera.angularSensibilityX=ji.ANGULAR_SENSITIVITY,this.camera.angularSensibilityY=ji.ANGULAR_SENSITIVITY),t&&this.setCameraRadiusLimits(),this.saveCameraInitialPosition())}setCameraRadiusLimits(){if(!this.camera)return;let e=this.camera.radius;this.camera.lowerRadiusLimit=e*ji.RADIUS_LOWER_LIMIT_RATIO,this.camera.upperRadiusLimit=e*ji.RADIUS_UPPER_LIMIT_RATIO}saveCameraInitialPosition(){!this.camera||this.cameraInitialAlpha!==null||(this.cameraInitialAlpha=this.camera.alpha,this.cameraInitialBeta=this.camera.beta,this.cameraInitialRadius=this.camera.radius)}scaleMesh(e,t=1){let i=1/t;e.scaling.set(e.scaling.x*i,e.scaling.y*i,e.scaling.z*i),e.refreshBoundingInfo(!0,!0),e.computeWorldMatrix()}createDefaultEnvironment(){if(!this.scene)return;this.scene.clearColor=new ce(0,0,0,0);let e={createGround:!1,createSkybox:!1,environmentTexture:this.envTexture};try{this.sceneHelper=this.scene.createDefaultEnvironment(e),this.sceneHelper&&this.sceneHelper.setMainColor(new U(.4,.4,.4))}catch(t){console.warn("Environment creation failed, likely network issue loading texture:",t)}}createDefaultLights(){if(!this.scene)return;let e=new U(1,1,1);this.pointLightBottom=this.createPointLight("pointLight",new m(0,-.8,0),e,TT.POINT_LIGHT_INTENSITY),this.hemisphericLightLeft=this.createHemisphericLight("hemisphericLightLeft",new m(-1,0,0),e,TT.HEMISPHERIC_LIGHT_INTENSITY),this.hemisphericLightRight=this.createHemisphericLight("hemisphericLightRight",new m(1,0,0),e,TT.HEMISPHERIC_LIGHT_INTENSITY)}createPointLight(e,t,i,r){let s=new In(e,t,this.scene);return s.diffuse=i,s.specular=i,s.intensity=r,s}createHemisphericLight(e,t,i,r){let s=new Di(e,t,this.scene);return s.diffuse=i,s.specular=i,s.intensity=r,s}get currentScene(){return this.scene}get currentCamera(){return this.camera}showDebugLayer(){this.keydownListener=e=>{this.isInputFieldFocused(e)||e.key.toLowerCase()==="i"&&this.toggleDebugLayer().catch(console.error)},window.addEventListener("keydown",this.keydownListener)}isInputFieldFocused(e){let t=e.target;return t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.isContentEditable}toggleDebugLayer(){return S(this,null,function*(){if(this.scene){if(this.scene.debugLayer?.isVisible()){this.scene.debugLayer.hide();return}if(!this.isInspectorLoaded)try{yield Promise.all([import("./chunk-Y4XU4BRH.js"),import("./chunk-WHMF545I.js"),import("./chunk-NA2I4L4R.js"),import("./chunk-SS6S227R.js")]),this.isInspectorLoaded=!0}catch(e){console.error("Failed to load Babylon Inspector:",e);return}yield this.scene.debugLayer.show({enablePopup:!0,enableClose:!0,embedMode:!0}),GD("https://use.typekit.net/cta4xsb.css")}})}dispose(){this.stopAnimation(),this.keydownListener&&window.removeEventListener("keydown",this.keydownListener),this.scene?.dispose(),this.engine?.dispose(),this.scene=null,this.engine=null,this.camera=null}ngOnDestroy(){this.dispose()}static \u0275fac=function(t){return new(t||n)(qe(Et))};static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"root"})};var so=class n{_show$=new Ot(!1);show$=this._show$.asObservable();_message$=new Ot("Engaging Mechanism");message$=this._message$.asObservable();_image$=new Ot("assets/icons/map-icon.png");image$=this._image$.asObservable();_showButton$=new Ot(!1);showButton$=this._showButton$.asObservable();buttonText="LAUNCH";isTransparent=!1;autoHide=!0;_textVisible$=new Ot(!0);textVisible$=this._textVisible$.asObservable();_messageRequest$=new ti;_isExiting$=new Ot(!1);isExiting$=this._isExiting$.asObservable();constructor(){this._messageRequest$.pipe(mo(e=>(this._textVisible$.next(!1),et(e).pipe(Nd(300),pi(t=>{this._message$.next(t),this._textVisible$.next(!0)}),Nd(500))))).subscribe()}forceClose(){this._isExiting$.next(!0),setTimeout(()=>{this.show=!1,this._isExiting$.next(!1)},500)}updateMessage(e){this._messageRequest$.next(e)}get show(){return this._show$.value}set show(e){this._show$.next(e),e?this.toggleScroll(!0):this.toggleScroll(!1)}hide(){this.autoHide?this.show=!1:(this._showButton$.next(!0),this.updateMessage("!COORDINATES LOCKED!"))}toggleScroll(e){e?document.body.classList.add("no-scroll"):document.body.classList.remove("no-scroll")}updateImage(e){this._image$.next(e)}static \u0275fac=function(t){return new(t||n)};static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"root"})};var KD="puzzle-state",Zr=class n{_isUnlocked=nn(this.loadFromStorage().isUnlocked);_isLoading=nn(!0);isUnlocked=this._isUnlocked.asReadonly();isLoading=this._isLoading.asReadonly();loadFromStorage(){try{let e=sessionStorage.getItem(KD);if(e)return JSON.parse(e)}catch(e){console.warn("Failed to load puzzle state from sessionStorage",e)}return{isUnlocked:!1}}saveToStorage(){try{let e={isUnlocked:this._isUnlocked()};sessionStorage.setItem(KD,JSON.stringify(e))}catch(e){console.warn("Failed to save puzzle state to sessionStorage",e)}}unlockPuzzle(){this._isUnlocked.set(!0),this.saveToStorage()}lockPuzzle(){this._isUnlocked.set(!1),this.saveToStorage()}setLoading(e){this._isLoading.set(e)}reset(){this._isUnlocked.set(!1),this._isLoading.set(!0),this.saveToStorage()}static \u0275fac=function(t){return new(t||n)};static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"root"})};var Zk=["renderCanvas"];function Qk(n,e){if(n&1&&(De(0,"span",7),Ke(1),we()),n&2){let t=e.$implicit,i=e.$index,r=Ei(2);us("completed",i<r.puzzleStep())("active",i===r.puzzleStep()),Be(),or(" ",t," ")}}function Jk(n,e){if(n&1&&(De(0,"div",3)(1,"div",4),Ke(2,"UNLOCK MAP"),we(),De(3,"div",5),xn(4,Qk,2,5,"span",6,Lr),we()()),n&2){let t=Ei();Be(4),Cn(t.SEQUENCE_DISPLAY)}}var wh={SEQUENCE:["right","down","left"],SEQUENCE_DISPLAY:["\u2192","\u2193","\u2190"],SWIPE_THRESHOLD:50,FLOATING_SPEED:2.5,FLOATING_AMPLITUDE:.015},Ss={INNER_SPHERE:{ALBEDO_COLOR:new U(0,0,0),METALLIC:.1,ROUGHNESS:.9},GLOW_LAYER:{MAIN_TEXTURE_RATIO:.5,BLUR_KERNEL_SIZE:32,INTENSITY:2},FEEDBACK_COLORS:{CORRECT:new U(0,1,0),WRONG:new U(1,0,0),UNLOCKED:U.FromHexString("#00ffff")}},Qr={PULSE_DURATION:36,PULSE_FPS:30,CAMERA_DELAY:200,VIBRATE_DELAY:50,VIBRATE_ERROR_DELAY:150},oo={ROTATION_FPS:30,ROTATION_FRAMES:15,RESET_FRAMES:15,SHAKE_DURATION:500,SHAKE_FREQUENCY:50,SHAKE_INTENSITY:.005},Bg=class n{constructor(e,t,i,r,s){this.babylonService=e;this.splashService=t;this.ngZone=i;this.router=r;this.puzzleStore=s}canvasRef;puzzleStep=nn(0);SEQUENCE_DISPLAY=wh.SEQUENCE_DISPLAY;isAnimating=!1;isVibrating=!1;startX=0;startY=0;loadedOuterMap=null;loadedInnerMap=null;mapSphere=null;glowLayer=null;floatingObserver=null;pointerObserver=null;SEQUENCE=wh.SEQUENCE;SWIPE_THRESHOLD=wh.SWIPE_THRESHOLD;ngOnInit(){this.splashService.show=!0,this.puzzleStore.setLoading(!0)}ngAfterViewInit(){this.ngZone.runOutsideAngular(()=>{setTimeout(()=>{this.initBabylonScene().catch(console.error)},0)})}initBabylonScene(){return S(this,null,function*(){this.initializeScene();try{yield this.loadInnerSphere(),yield this.loadOuterMapModel(),this.setupInteraction(),this.finalizeSceneSetup()}catch(e){console.error("Failed to initialize treasure map:",e),this.splashService.updateMessage("Error Loading Map Data"),setTimeout(()=>this.splashService.hide(),2e3)}})}initializeScene(){let e=this.canvasRef.nativeElement;this.babylonService.initScene(e,{createEnvironmentTexture:!0,createLights:!1,allowCamControls:!1,createGlowLayer:!1},{removeKeyBoardInputs:!1,autoElevation:!1,disablePanning:!1})}loadInnerSphere(){return S(this,null,function*(){if(this.loadedInnerMap=yield this.babylonService.loadModel("assets/models/inner_sphere.glb"),this.loadedInnerMap.addAllToScene(),this.mapSphere=this.loadedInnerMap.meshes[1],this.mapSphere&&this.babylonService.currentScene){let e=new Va("blackSphere",this.babylonService.currentScene);e.albedoColor=Ss.INNER_SPHERE.ALBEDO_COLOR,e.metallic=Ss.INNER_SPHERE.METALLIC,e.roughness=Ss.INNER_SPHERE.ROUGHNESS,e.emissiveColor=new U(0,0,0),this.mapSphere.material=e,this.glowLayer=new Mn("glow",this.babylonService.currentScene,{mainTextureRatio:Ss.GLOW_LAYER.MAIN_TEXTURE_RATIO,blurKernelSize:Ss.GLOW_LAYER.BLUR_KERNEL_SIZE}),this.glowLayer.intensity=Ss.GLOW_LAYER.INTENSITY}this.babylonService.setCameraInitialTarget(!1,!1,!0,this.loadedInnerMap,!1,!1),this.babylonService.scaleMesh(this.loadedInnerMap.meshes[0],1.03)})}loadOuterMapModel(){return S(this,null,function*(){this.loadedOuterMap=yield this.babylonService.loadModel("assets/models/treasure_map.glb"),this.loadedOuterMap.addAllToScene(),this.babylonService.setCameraInitialTarget(!1,!0,!0,this.loadedOuterMap,!0,!0),this.startFloatingEffect()})}finalizeSceneSetup(){this.ngZone.run(()=>{this.puzzleStore.setLoading(!1),setTimeout(()=>{this.splashService.hide()},500)}),this.babylonService.startAnimation()}startFloatingEffect(){if(!this.babylonService.currentScene||!this.babylonService.parentBox||!this.loadedInnerMap)return;let e=new E("coreGroup",this.babylonService.currentScene);this.babylonService.parentBox.parent=e,this.loadedInnerMap.meshes[0].parent=e;let t=this.babylonService.currentScene,i=0,r=wh.FLOATING_SPEED,s=wh.FLOATING_AMPLITUDE,o=e.position.y;this.floatingObserver=t.onBeforeRenderObservable.add(()=>{!this.isAnimating&&e&&(i+=.016*r,e.position.y=o+Math.sin(i)*s)})}setupInteraction(){this.babylonService.currentScene&&this.attachPointerObserver()}attachPointerObserver(){!this.babylonService.currentScene||this.pointerObserver||(this.pointerObserver=this.babylonService.currentScene.onPointerObservable.add(e=>{let t=e.type;if(t===Ee.POINTERDOWN)this.startX=e.event.clientX,this.startY=e.event.clientY;else if(t===Ee.POINTERUP&&this.startX!==0){let i=e.event.clientX-this.startX,r=e.event.clientY-this.startY,s=this.detectSwipeDirection(i,r);s&&this.handleSwipe(s),this.startX=0,this.startY=0}}))}detachPointerObserver(){this.pointerObserver&&this.babylonService.currentScene&&(this.babylonService.currentScene.onPointerObservable.remove(this.pointerObserver),this.pointerObserver=null,this.startX=0,this.startY=0)}detectSwipeDirection(e,t){let i=Math.abs(e),r=Math.abs(t);return i<this.SWIPE_THRESHOLD&&r<this.SWIPE_THRESHOLD?null:i>r?e>0?"right":"left":t>0?"down":"up"}handleSwipe(e){this.isAnimating||this.puzzleStore.isUnlocked()||(this.isAnimating=!0,this.detachPointerObserver(),this.ngZone.run(()=>{let t=this.SEQUENCE[this.puzzleStep()];e===t?(this.puzzleStep.set(this.puzzleStep()+1),this.onCorrectSwipe(),this.puzzleStep()>=this.SEQUENCE.length&&this.unlockPuzzle().catch(console.error)):(this.puzzleStep.set(0),this.onWrongSwipe())}))}onCorrectSwipe(){if("vibrate"in navigator&&!this.isVibrating&&(this.isVibrating=!0,navigator.vibrate(100),setTimeout(()=>this.isVibrating=!1,Qr.VIBRATE_DELAY)),!this.mapSphere?.material||!this.babylonService.currentScene){this.resetAfterAnimation();return}let e=this.mapSphere.material,t=this.babylonService.currentScene,i=new H("greenPulse","emissiveIntensity",Qr.PULSE_FPS,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CONSTANT);i.setKeys([{frame:0,value:0},{frame:9,value:2},{frame:18,value:0},{frame:27,value:2},{frame:Qr.PULSE_DURATION,value:0}]),i.setEasingFunction(new Dc),e.emissiveColor=Ss.FEEDBACK_COLORS.CORRECT,e.emissiveIntensity=0;let r=t.beginDirectAnimation(e,[i],0,Qr.PULSE_DURATION,!1);setTimeout(()=>{let s=this.SEQUENCE[this.puzzleStep()-1];this.rotateCameraByDirection(s)},Qr.CAMERA_DELAY),r.onAnimationEndObservable.addOnce(()=>{e.emissiveColor=new U(0,0,0),e.emissiveIntensity=1,this.resetAfterAnimation()})}onWrongSwipe(){if("vibrate"in navigator&&!this.isVibrating&&(this.isVibrating=!0,navigator.vibrate([50,100,50]),setTimeout(()=>this.isVibrating=!1,Qr.VIBRATE_ERROR_DELAY)),this.shakeParentBox(),!this.mapSphere?.material||!this.babylonService.currentScene){setTimeout(()=>{this.resetCameraToInitialPosition(),this.resetAfterAnimation()},200);return}let e=this.mapSphere.material,t=this.babylonService.currentScene,i=new H("redPulse","emissiveIntensity",Qr.PULSE_FPS,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CONSTANT);i.setKeys([{frame:0,value:0},{frame:9,value:2},{frame:18,value:0},{frame:27,value:2},{frame:Qr.PULSE_DURATION,value:0}]),i.setEasingFunction(new Dc),e.emissiveColor=Ss.FEEDBACK_COLORS.WRONG,e.emissiveIntensity=0;let r=t.beginDirectAnimation(e,[i],0,Qr.PULSE_DURATION,!1);setTimeout(()=>this.resetCameraToInitialPosition(),Qr.CAMERA_DELAY),r.onAnimationEndObservable.addOnce(()=>{e.emissiveColor=new U(0,0,0),e.emissiveIntensity=1,this.resetAfterAnimation()})}resetAfterAnimation(){this.isAnimating=!1,this.isVibrating=!1,this.puzzleStore.isUnlocked()||this.attachPointerObserver()}unlockPuzzle(){return S(this,null,function*(){if(this.puzzleStore.unlockPuzzle(),"vibrate"in navigator&&navigator.vibrate([100,50,100,50,200]),this.detachPointerObserver(),this.floatingObserver&&this.babylonService.currentScene&&(this.babylonService.currentScene.onBeforeRenderObservable.remove(this.floatingObserver),this.floatingObserver=null),this.mapSphere&&this.mapSphere.material){let t=this.mapSphere.material;t.emissiveColor=Ss.FEEDBACK_COLORS.UNLOCKED,t.emissiveIntensity=2}let e=null;if(this.babylonService.parentBox&&this.babylonService.currentScene){let t=new H("celebrateRotation","rotation.y",30,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CYCLE);t.setKeys([{frame:0,value:this.babylonService.parentBox.rotation.y},{frame:60,value:this.babylonService.parentBox.rotation.y+Math.PI*2}]),this.babylonService.parentBox.animations=[t],e=this.babylonService.currentScene.beginAnimation(this.babylonService.parentBox,0,60,!0)}this.mapSphere?this.createOrbExplosion(this.mapSphere,()=>{e&&e.stop(),this.cleanupResources(),this.transitionToGridRoom()}).then(()=>{}):(e&&e.stop(),this.cleanupResources(),this.transitionToGridRoom())})}cleanupResources(){this.mapSphere&&(this.mapSphere.dispose(),this.mapSphere=null),this.glowLayer&&(this.glowLayer.dispose(),this.glowLayer=null),this.loadedOuterMap&&(this.loadedOuterMap.dispose(),this.loadedOuterMap=null),this.loadedInnerMap&&(this.loadedInnerMap.dispose(),this.loadedInnerMap=null),this.floatingObserver&&this.babylonService.currentScene&&(this.babylonService.currentScene.onBeforeRenderObservable.remove(this.floatingObserver),this.floatingObserver=null),this.detachPointerObserver()}transitionToGridRoom(){this.ngZone.run(()=>{this.router.navigate(["/holographic-room"]).catch(console.error)})}shakeParentBox(){let e=this.babylonService.parentBox,t=this.babylonService.currentScene;if(!e||!t)return;let i=e.position.clone(),r=Date.now(),s=t.onBeforeRenderObservable.add(()=>{let o=Date.now()-r;o>=oo.SHAKE_DURATION?this.resetShake(s,i):this.applyShakeOffset(o,i)})}resetShake(e,t){let i=this.babylonService.parentBox,r=this.babylonService.currentScene;!i||!r||(i.position.copyFrom(t),r.onBeforeRenderObservable.remove(e))}applyShakeOffset(e,t){let i=this.babylonService.parentBox;if(!i)return;let r=e/oo.SHAKE_DURATION,s=oo.SHAKE_INTENSITY*(1-r),o=e/1e3,a=oo.SHAKE_FREQUENCY*Math.PI*2;i.position.x=t.x+Math.sin(o*a)*s,i.position.y=t.y+Math.cos(o*a)*s*.7,i.position.z=t.z+Math.sin(o*a+Math.PI/3)*s*.5}createOrbExplosion(e,t,i=U.FromHexString("#020205")){let r=this.babylonService.currentScene;return r?new Promise(s=>{if(!r)return s();let o=UD(),a=o?1500:3e3,l;ta.IsSupported?(l=new ta("explosionParticles",{capacity:a},r),l.activeParticleCount=a):l=new Mt("explosionParticles",o?300:600,r),l.particleTexture=new Z("assets/textures/the_flare.png",r),l.emitter=e;let c=new bs;c.radius=.1,c.radiusRange=0,l.particleEmitterType=c;let u=U.FromHexString("#00ff00");l.color1=new ce(u.r*3,u.g*3,u.b*3,1),l.color2=new ce(u.r*2,u.g*2,u.b*2,1),l.colorDead=new ce(u.r*.5,u.g*.5,u.b*.5,0),l.minSize=.01,l.maxSize=.06,l.minLifeTime=.8,l.maxLifeTime=1.2,l.emitRate=o?4e3:8e3,l.blendMode=Mt.BLENDMODE_ADD,l.gravity=new m(0,0,0),l.minEmitPower=6,l.maxEmitPower=12,l.updateSpeed=.016,l.start();let h=$i.CreatePlane("transitionFlash",{size:500},r),d=r.activeCamera;d&&(h.parent=d,h.position=new m(0,0,5),h.renderingGroupId=3);let f=new te("transitionFlashMaterial",r);f.emissiveColor=i,f.disableLighting=!0,f.backFaceCulling=!1,f.alpha=0,h.material=f,h.isVisible=!0;let p=0,g=2500,_=1e3,y=1500,b=2e3,A=2200,I=2500,v=!1,x=r.onBeforeRenderObservable.add(()=>{if(p+=r.getEngine().getDeltaTime(),p>=_&&(l.emitRate=0),p>=A&&!v&&(v=!0,t()),p<y)f.alpha=0;else if(p<b){let C=(p-y)/(b-y);f.alpha=C*C}else if(p<I){let C=(p-b)/(I-b);f.alpha=1-C*C*C}else f.alpha=0;p>=g&&(x&&r?.onBeforeRenderObservable.remove(x),h.dispose(),f.dispose(),s(),setTimeout(()=>l.dispose(),500))})}):Promise.resolve()}rotateCameraByDirection(e){let t=this.babylonService.currentCamera,i=this.babylonService.currentScene;if(!t||!i)return;let r=Math.PI/2,{property:s,currentValue:o,targetValue:a}=this.calculateRotationTarget(e,r,t.alpha,t.beta);this.animateCameraProperty(s,o,a)}calculateRotationTarget(e,t,i,r){switch(e){case"right":return{property:"alpha",currentValue:i,targetValue:i-t};case"left":return{property:"alpha",currentValue:i,targetValue:i+t};case"up":return{property:"beta",currentValue:r,targetValue:Math.max(.1,r+t)};case"down":return{property:"beta",currentValue:r,targetValue:Math.min(Math.PI-.1,r-t)};default:return{property:"alpha",currentValue:0,targetValue:0}}}animateCameraProperty(e,t,i){let r=this.babylonService.currentCamera;r&&H.CreateAndStartAnimation(`cameraRotation_${e}`,r,e,oo.ROTATION_FPS,oo.ROTATION_FRAMES,t,i,H.ANIMATIONLOOPMODE_CONSTANT)}resetCameraToInitialPosition(){!this.babylonService.currentCamera||!this.hasInitialCameraPosition()||(this.animateCameraReset("alpha",this.babylonService.cameraInitialAlpha),this.animateCameraReset("beta",this.babylonService.cameraInitialBeta),this.animateCameraReset("radius",this.babylonService.cameraInitialRadius))}hasInitialCameraPosition(){return this.babylonService.cameraInitialAlpha!==null&&this.babylonService.cameraInitialBeta!==null&&this.babylonService.cameraInitialRadius!==null}animateCameraReset(e,t){let i=this.babylonService.currentCamera;if(!i)return;let r=i[e];H.CreateAndStartAnimation(`resetCamera_${e}`,i,e,oo.ROTATION_FPS,oo.RESET_FRAMES,r,t,H.ANIMATIONLOOPMODE_CONSTANT)}cleanup(){this.cleanupResources(),this.babylonService.dispose()}ngOnDestroy(){this.cleanup()}static \u0275fac=function(t){return new(t||n)(si(vc),si(so),si(Et),si(Gr),si(Zr))};static \u0275cmp=sr({type:n,selectors:[["app-map-puzzle"]],viewQuery:function(t,i){if(t&1&&gu(Zk,7),t&2){let r;_u(r=yu())&&(i.canvasRef=r.first)}},decls:4,vars:1,consts:[["renderCanvas",""],[1,"closed-map-container"],[1,"render-canvas"],[1,"puzzle-hints"],[1,"hint-title"],[1,"sequence-display"],[1,"sequence-step",3,"completed","active"],[1,"sequence-step"]],template:function(t,i){t&1&&(De(0,"div",1),on(1,"canvas",2,0),rn(3,Jk,6,0,"div",3),we()),t&2&&(Be(3),sn(!i.puzzleStore.isUnlocked()&&!i.puzzleStore.isLoading()?3:-1))},dependencies:[bl],styles:[".closed-map-container[_ngcontent-%COMP%]{position:relative;width:100%;height:100vh;background-color:var(--bg-space);overflow:hidden}.render-canvas[_ngcontent-%COMP%]{width:100%;height:100%;display:block;outline:none}.puzzle-hints[_ngcontent-%COMP%]{position:absolute;top:1rem;left:50%;transform:translate(-50%);background:#020205d9;padding:1rem 1.5rem;border-radius:12px;border:2px solid var(--color-gold);box-shadow:0 0 20px #c7883580;z-index:100}.hint-title[_ngcontent-%COMP%]{color:var(--color-gold);font-size:2rem;text-transform:uppercase;margin-bottom:.5rem;text-align:center}.sequence-display[_ngcontent-%COMP%]{display:flex;gap:.5rem;justify-content:center}.sequence-step[_ngcontent-%COMP%]{padding:1rem;background:#c7883526;border:1px solid var(--color-gold);border-radius:6px;color:var(--color-gold);font-size:1.8rem;font-weight:600;transition:all .3s ease;opacity:.5;min-width:3rem;text-align:center;line-height:1;will-change:color;-webkit-transform:translateZ(0);transform:translateZ(0)}.sequence-step.active[_ngcontent-%COMP%]{opacity:1;background:#c788354d;box-shadow:0 0 15px #c7883599;animation:_ngcontent-%COMP%_pulse 1.5s ease-in-out infinite}.sequence-step.completed[_ngcontent-%COMP%]{opacity:1;background:#0f03;border-color:#0f0;color:#0f0}@keyframes _ngcontent-%COMP%_pulse{0%,to{transform:scale(1);box-shadow:0 0 15px #c7883599}50%{transform:scale(1.05);box-shadow:0 0 25px #c78835e6}}@media(max-width:768px){.puzzle-hints[_ngcontent-%COMP%]{top:10px;padding:15px 20px}.sequence-display[_ngcontent-%COMP%]{gap:10px}.sequence-step[_ngcontent-%COMP%]{padding:6px 12px;font-size:.75rem}}"]})};var ZD=[{id:"about",title:"DAVID ALVARADO",label:"KNOW ME",type:"about",position:[0,2,0],content:{avatar:"assets/images/david_tp.jpg",role:"Front-End Tech Lead",location:"Ecuador",bio:["I blend technical precision with artistic creativity. With over 5 years of experience, I specialize in building high-performance architectures using Angular, TypeScript, and 3D web technologies. My attention to detail ensures that every pixel and every line of code serves a purpose.","Beyond the screen, I am a passionate singer and content creator. On my YouTube channel, I translate and perform songs, applying the same dedication to musical nuances as I do to software quality.","I value autonomy and trust. I'm a responsible leader who fosters good communication and a positive environment, believing that great software is built by happy, self-managed teams."],socials:{youtube:"https://www.youtube.com/@D4veCovers",linkedin:"https://linkedin.com/in/david-alvarado-dev/",email:"frealvaradoc@gmail.com"},softSkills:["Detail Oriented","Good Communication","Autonomous","Team Player"]}},{id:"experience",title:"CAREER LOG",label:"CAREER",type:"experience",position:[-4,0,2],content:[{company:"StickerStoke S.A.S",role:"Front-End Tech Lead",period:"2021 - 2025",desc:"Led the technological vision for a real-time visual customization platform.",highlights:["Architected a patent-pending 3D vector editor using Babylon.js & Angular.","Optimized rendering performance, reducing load times by 40%.","Managed AWS/Docker pipelines for CI/CD efficiency.","Mentored the frontend team, establishing SOLID principles."]},{company:"GoData Ecuador",role:"Tech Lead",period:"2020 - 2021",desc:"Directed banking operations digitalization.",highlights:["Led a squad of 4 developers using Agile/Scrum methodologies.","Modernized legacy banking interfaces improving UX for internal staff.","Orchestrated Java Spring Boot backend integration."]},{company:"Freelance Developer",role:"Full Stack Developer",period:"2019 - 2020",desc:"Delivered custom web solutions and digital transformations.",highlights:["Designed SEO-optimized websites increasing client visibility.","Built custom WordPress plugins for automated workflows.","Developed full-stack apps for warehouse management using Angular/Node."]}]},{id:"projects",title:"INNOVATION HUB",label:"PROJECTS",type:"projects",position:[0,-3,3],content:[{name:"3DCAL",category:"Core Product",description:"A complex e-commerce ecosystem featuring a real-time 3D vehicle configurator. Migrated from WordPress to a custom Angular/NestJS architecture.",stack:["Angular","Babylon.js","NestJS"],link:"https://3dcal.com/"},{name:"Custom WP Plugins",category:"Development Tools",description:"Built a real-time Shipping Cost Calculator for Ecuadorian couriers and an Auto-Image Optimizer API integration to preserve quality while reducing file size.",stack:["PHP","WordPress API","REST"]},{name:"AMPDC",category:"Volunteer Work",description:"Maintained the site, updated sections/color palettes, and integrated payments. Implemented analytics (Clarify, GA, FB Pixel), published articles, and collaborated on a custom appointment scheduling plugin.",stack:["WordPress","Analytics","Plugins"],link:"https://psicologiaydesarrollocomunitario.com/"},{name:"PBYA",category:"Web Solutions",description:"Solved critical hosting migration issues, diagnosed and repaired code errors with deep refactoring, and developed a new custom module for the industrial sector.",stack:["Headless WP","Gatsby","React"],link:"https://pbya.com/"}]},{id:"skills",title:"TECH ARSENAL",label:"SKILLS",type:"skills",position:[4,0,2],content:{core:[{name:"Angular & TS",level:98},{name:"Babylon.js / Three.js 3D",level:90},{name:"Vue.js",level:80},{name:"React / Astro",level:85}],backend:["Node.js","NestJS","PostgreSQL","PHP / WordPress","Electron.js"],devops:["Docker","AWS (ECS/S3)","Azure","Git Flow","CI/CD"]}}];var QD="gridPixelShader",eV=`#extension GL_OES_standard_derivatives : enable
#define SQRT2 1.41421356
#define PI 3.14159
precision highp float;uniform float visibility;uniform vec3 mainColor;uniform vec3 lineColor;uniform vec4 gridControl;uniform vec3 gridOffset;varying vec3 vPosition;varying vec3 vNormal;
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#ifdef OPACITY
varying vec2 vOpacityUV;uniform sampler2D opacitySampler;uniform vec2 vOpacityInfos;
#endif
float getDynamicVisibility(float position) {float majorGridFrequency=gridControl.y;if (floor(position+0.5)==floor(position/majorGridFrequency+0.5)*majorGridFrequency)
{return 1.0;}
return gridControl.z;}
float getAnisotropicAttenuation(float differentialLength) {const float maxNumberOfLines=10.0;return clamp(1.0/(differentialLength+1.0)-1.0/maxNumberOfLines,0.0,1.0);}
float isPointOnLine(float position,float differentialLength) {float fractionPartOfPosition=position-floor(position+0.5); 
fractionPartOfPosition/=differentialLength; 
#ifdef ANTIALIAS
fractionPartOfPosition=clamp(fractionPartOfPosition,-1.,1.);float result=0.5+0.5*cos(fractionPartOfPosition*PI); 
return result;
#else
return abs(fractionPartOfPosition)<SQRT2/4. ? 1. : 0.;
#endif
}
float contributionOnAxis(float position) {float differentialLength=length(vec2(dFdx(position),dFdy(position)));differentialLength*=SQRT2; 
float result=isPointOnLine(position,differentialLength);float dynamicVisibility=getDynamicVisibility(position);result*=dynamicVisibility;float anisotropicAttenuation=getAnisotropicAttenuation(differentialLength);result*=anisotropicAttenuation;return result;}
float normalImpactOnAxis(float x) {float normalImpact=clamp(1.0-3.0*abs(x*x*x),0.0,1.0);return normalImpact;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
float gridRatio=gridControl.x;vec3 gridPos=(vPosition+gridOffset.xyz)/gridRatio;float x=contributionOnAxis(gridPos.x);float y=contributionOnAxis(gridPos.y);float z=contributionOnAxis(gridPos.z);vec3 normal=normalize(vNormal);x*=normalImpactOnAxis(normal.x);y*=normalImpactOnAxis(normal.y);z*=normalImpactOnAxis(normal.z);
#ifdef MAX_LINE
float grid=clamp(max(max(x,y),z),0.,1.);
#else
float grid=clamp(x+y+z,0.,1.);
#endif
vec3 color=mix(mainColor,lineColor,grid);
#ifdef FOG
#include<fogFragment>
#endif
float opacity=1.0;
#ifdef TRANSPARENT
opacity=clamp(grid,0.08,gridControl.w*grid);
#endif
#ifdef OPACITY
opacity*=texture2D(opacitySampler,vOpacityUV).a;
#endif
gl_FragColor=vec4(color.rgb,opacity*visibility);
#ifdef TRANSPARENT
#ifdef PREMULTIPLYALPHA
gl_FragColor.rgb*=opacity;
#endif
#else
#endif
#include<logDepthFragment>
#include<imageProcessingCompatibility>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;ht.ShadersStore[QD]||(ht.ShadersStore[QD]=eV);var JD="gridVertexShader",tV=`precision highp float;attribute vec3 position;attribute vec3 normal;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#include<instancesDeclaration>
#include<__decl__sceneVertex>
varying vec3 vPosition;varying vec3 vNormal;
#include<logDepthDeclaration>
#include<fogVertexDeclaration>
#ifdef OPACITY
varying vec2 vOpacityUV;uniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;
#endif
#include<clipPlaneVertexDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
vec4 worldPos=finalWorld*vec4(position,1.0);
#include<fogVertex>
vec4 cameraSpacePosition=view*worldPos;gl_Position=projection*cameraSpacePosition;
#ifdef OPACITY
#ifndef UV1
vec2 uv=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2=vec2(0.,0.);
#endif
if (vOpacityInfos.x==0.)
{vOpacityUV=vec2(opacityMatrix*vec4(uv,1.0,0.0));}
else
{vOpacityUV=vec2(opacityMatrix*vec4(uv2,1.0,0.0));}
#endif 
#include<clipPlaneVertex>
#include<logDepthVertex>
vPosition=position;vNormal=normal;
#define CUSTOM_VERTEX_MAIN_END
}`;ht.ShadersStore[JD]||(ht.ShadersStore[JD]=tV);var IT=class extends ws{constructor(){super(),this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.OPACITY=!1,this.ANTIALIAS=!1,this.TRANSPARENT=!1,this.FOG=!1,this.PREMULTIPLYALPHA=!1,this.MAX_LINE=!1,this.UV1=!1,this.UV2=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.LOGARITHMICDEPTH=!1,this.rebuild()}},Ci=class n extends Tr{constructor(e,t){super(e,t),this.mainColor=U.Black(),this.lineColor=U.Teal(),this.gridRatio=1,this.gridOffset=m.Zero(),this.majorUnitFrequency=10,this.minorUnitVisibility=.33,this.opacity=1,this.antialias=!0,this.preMultiplyAlpha=!1,this.useMaxLine=!1,this._gridControl=new dt(this.gridRatio,this.majorUnitFrequency,this.minorUnitVisibility,this.opacity)}needAlphaBlending(){return this.opacity<1||this._opacityTexture&&this._opacityTexture.isReady()}needAlphaBlendingForMesh(e){return e.visibility<1||this.needAlphaBlending()}isReadyForSubMesh(e,t,i){let r=t._drawWrapper;if(this.isFrozen&&r.effect&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new IT);let s=t.materialDefines,o=this.getScene();if(this._isReadyForSubMesh(t))return!0;if(s.TRANSPARENT!==this.opacity<1&&(s.TRANSPARENT=!s.TRANSPARENT,s.markAsUnprocessed()),s.PREMULTIPLYALPHA!=this.preMultiplyAlpha&&(s.PREMULTIPLYALPHA=!s.PREMULTIPLYALPHA,s.markAsUnprocessed()),s.MAX_LINE!==this.useMaxLine&&(s.MAX_LINE=!s.MAX_LINE,s.markAsUnprocessed()),s.ANTIALIAS!==this.antialias&&(s.ANTIALIAS=!s.ANTIALIAS,s.markAsUnprocessed()),s._areTexturesDirty&&(s._needUVs=!1,o.texturesEnabled&&this._opacityTexture&&at.OpacityTextureEnabled))if(this._opacityTexture.isReady())s._needUVs=!0,s.OPACITY=!0;else return!1;if(Pa(e,o,this._useLogarithmicDepth,!1,this.fogEnabled,!1,s,void 0,void 0,void 0,this._isVertexOutputInvariant),Oa(o,o.getEngine(),this,s,!!i),s.isDirty){s.markAsProcessed(),o.resetCachedMaterial(),Na(e,s,!1,!1);let a=[T.PositionKind,T.NormalKind];s.UV1&&a.push(T.UVKind),s.UV2&&a.push(T.UV2Kind),s.IMAGEPROCESSINGPOSTPROCESS=o.imageProcessingConfiguration.applyByPostProcess,Ra(a,s);let l=["projection","mainColor","lineColor","gridControl","gridOffset","vFogInfos","vFogColor","world","view","opacityMatrix","vOpacityInfos","visibility","logarithmicDepthConstant"],c=s.toString();Yi(l),t.setEffect(o.getEngine().createEffect("grid",{attributes:a,uniformsNames:l,uniformBuffersNames:["Scene"],samplers:["opacitySampler"],defines:c,fallbacks:null,onCompiled:this.onCompiled,onError:this.onError},o.getEngine()),s,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(s._renderId=o.getRenderId(),r._wasPreviouslyReady=!0,r._wasPreviouslyUsingInstances=!!i,!0)}bindForSubMesh(e,t,i){let r=this.getScene(),s=i.materialDefines;if(!s)return;let o=i.effect;o&&(this._activeEffect=o,this._activeEffect.setFloat("visibility",t.visibility),(!s.INSTANCES||s.THIN_INSTANCE)&&this.bindOnlyWorldMatrix(e),this.bindView(o),this.bindViewProjection(o),this._mustRebind(r,o,i)&&(this._activeEffect.setColor3("mainColor",this.mainColor),this._activeEffect.setColor3("lineColor",this.lineColor),this._activeEffect.setVector3("gridOffset",this.gridOffset),this._gridControl.x=this.gridRatio,this._gridControl.y=Math.round(this.majorUnitFrequency),this._gridControl.z=this.minorUnitVisibility,this._gridControl.w=this.opacity,this._activeEffect.setVector4("gridControl",this._gridControl),this._opacityTexture&&at.OpacityTextureEnabled&&(this._activeEffect.setTexture("opacitySampler",this._opacityTexture),this._activeEffect.setFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),this._activeEffect.setMatrix("opacityMatrix",this._opacityTexture.getTextureMatrix())),Ki(o,this,r),this._useLogarithmicDepth&&Si(s,o,r)),Nn(r,t,this._activeEffect),this._afterBind(t,this._activeEffect,i))}dispose(e){super.dispose(e)}clone(e){return je.Clone(()=>new n(e,this.getScene()),this)}serialize(){let e=super.serialize();return e.customType="BABYLON.GridMaterial",e}getClassName(){return"GridMaterial"}static Parse(e,t,i){return je.Parse(()=>new n(e.name,t),e,t,i)}};w([mn()],Ci.prototype,"mainColor",void 0);w([mn()],Ci.prototype,"lineColor",void 0);w([B()],Ci.prototype,"gridRatio",void 0);w([Jt()],Ci.prototype,"gridOffset",void 0);w([B()],Ci.prototype,"majorUnitFrequency",void 0);w([B()],Ci.prototype,"minorUnitVisibility",void 0);w([B()],Ci.prototype,"opacity",void 0);w([B()],Ci.prototype,"antialias",void 0);w([B()],Ci.prototype,"preMultiplyAlpha",void 0);w([B()],Ci.prototype,"useMaxLine",void 0);w([Bi("opacityTexture")],Ci.prototype,"_opacityTexture",void 0);w([Pe("_markAllSubMeshesAsTexturesDirty")],Ci.prototype,"opacityTexture",void 0);le("BABYLON.GridMaterial",Ci);var eR=`
varying vec2 vUV;
uniform vec2 iResolution;
uniform float iTime;

// Controls
#define LAYERS 5.0
#define PI 3.141592654
#define TAU (2.0*PI)
#define TIME mod(iTime, 30.0)
#define TTIME (TAU*TIME)
#define RESOLUTION iResolution
#define ROT(a) mat2(cos(a), sin(a), -sin(a), cos(a))

// License: Unknown, author: nmz (twitter: @stormoid), found: https://www.shadertoy.com/view/NdfyRM
float sRGB(float t) {
  return mix(1.055*pow(t, 1./2.4) - 0.055, 12.92*t, step(t, 0.0031308));
}

// License: Unknown, author: nmz (twitter: @stormoid), found: https://www.shadertoy.com/view/NdfyRM
vec3 sRGB(in vec3 c) {
  return vec3(sRGB(c.x), sRGB(c.y), sRGB(c.z));
}

// License: Unknown, author: Matt Taylor (https://github.com/64), found: https://64.github.io/tonemapping/
vec3 aces_approx(vec3 v) {
  v = max(v, 0.0);
  v *= 0.6f;
  float a = 2.51f;
  float b = 0.03f;
  float c = 2.43f;
  float d = 0.59f;
  float e = 0.14f;
  return clamp((v*(a*v+b))/(v*(c*v+d)+e), 0.0f, 1.0f);
}

// License: Unknown, author: Unknown, found: don't remember
float tanh_approx(float x) {
  float x2 = x*x;
  return clamp(x*(27.0 + x2)/(27.0+9.0*x2), -1.0, 1.0);
}

// License: WTFPL, author: sam hocevar, found: https://stackoverflow.com/a/17897228/418488
const vec4 hsv2rgb_K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 hsv2rgb(vec3 c) {
  vec3 p = abs(fract(c.xxx + hsv2rgb_K.xyz) * 6.0 - hsv2rgb_K.www);
  return c.z * mix(hsv2rgb_K.xxx, clamp(p - hsv2rgb_K.xxx, 0.0, 1.0), c.y);
}

// License: MIT OR CC-BY-NC-4.0, author: mercury, found: https://mercury.sexy/hg_sdf/
vec2 mod2(inout vec2 p, vec2 size) {
  vec2 c = floor((p + size*0.5)/size);
  p = mod(p + size*0.5,size) - size*0.5;
  return c;
}

// Hash functions
vec2 hash2(vec2 p) {
  p = vec2(dot(p, vec2(127.1, 311.7)), dot(p, vec2(269.5, 183.3)));
  return fract(sin(p)*43758.5453123);
}

vec2 shash2(vec2 p) {
  return -1.0+2.0*hash2(p);
}

vec3 toSpherical(vec3 p) {
  float r   = length(p);
  float t   = acos(p.z/r);
  float ph  = atan(p.y, p.x);
  return vec3(r, t, ph);
}

// License: CC BY-NC-SA 3.0, author: Stephane Cuillerdier - Aiekick/2015 (twitter:@aiekick), found: https://www.shadertoy.com/view/Mt3GW2
vec3 blackbody(float Temp) {
  vec3 col = vec3(255.);
  col.x = 56100000. * pow(Temp,(-3. / 2.)) + 148.;
  col.y = 100.04 * log(Temp) - 623.6;
  if (Temp > 6500.) col.y = 35200000. * pow(Temp,(-3. / 2.)) + 184.;
  col.z = 194.18 * log(Temp) - 1448.6;
  col = clamp(col, 0., 255.)/255.;
  if (Temp < 1000.) col *= Temp/1000.;
  return col;
}

// License: MIT, author: Inigo Quilez, found: https://www.shadertoy.com/view/XslGRr
float noise(vec2 p) {
  vec2 i = floor(p);
  vec2 f = fract(p);
  vec2 u = f*f*(3.-2.*f);

  float n = mix(
    mix(dot(shash2(i + vec2(0.,0.)), f - vec2(0.,0.)),
        dot(shash2(i + vec2(1.,0.)), f - vec2(1.,0.)), u.x),
    mix(dot(shash2(i + vec2(0.,1.)), f - vec2(0.,1.)),
        dot(shash2(i + vec2(1.,1.)), f - vec2(1.,1.)), u.x), u.y);

  return 2.0*n;
}

// Fractal Brownian Motion
float fbm(vec2 p, float o, float s, int iters) {
  p *= s;
  p += o;

  const float aa = 0.5;
  const mat2 pp = 2.04*ROT(1.0);

  float h = 0.0;
  float a = 1.0;
  float d = 0.0;
  for (int i = 0; i < iters; ++i) {
    d += a;
    h += a*noise(p);
    p += vec2(10.7, 8.3);
    p *= pp;
    a *= aa;
  }
  h /= d;

  return h;
}

float height(vec2 p) {
  float h = fbm(p, 0.0, 5.0, 5);
  h *= 0.3;
  h += 0.0;
  return h;
}

// Stars with original warm/cool color temperatures
vec3 stars(vec3 ro, vec3 rd, vec2 sp, float hh) {
  vec3 col = vec3(0.0);

  const float m = LAYERS;
  hh = tanh_approx(20.0*hh);

  for (float i = 0.0; i < m; ++i) {
    vec2 pp = sp+0.5*i;
    float s = i/(m-1.0);
    vec2 dim  = vec2(mix(0.05, 0.003, s)*PI);
    vec2 np = mod2(pp, dim);
    vec2 h = hash2(np+127.0+i);
    vec2 o = -1.0+2.0*h;
    float y = sin(sp.x);
    pp += o*dim*0.5;
    pp.y *= y;
    float l = length(pp);

    float h1 = fract(h.x*1667.0);
    float h2 = fract(h.x*1887.0);
    float h3 = fract(h.x*2997.0);

    vec3 scol = mix(8.0*h2, 0.25*h2*h2, s)*blackbody(mix(3000.0, 22000.0, h1*h1));
    scol *= 0.1; // Reduce brightness to 10% (much darker)

    vec3 ccol = col + exp(-(mix(6000.0, 2000.0, hh)/mix(2.0, 0.25, s))*max(l-0.001, 0.0))*scol;
    col = h3 < y ? ccol : col;
  }

  return col;
}

// License: MIT, author: Inigo Quilez, found: https://iquilezles.org/articles/spherefunctions
vec2 raySphere(vec3 ro, vec3 rd, vec4 sph) {
  vec3 oc = ro - sph.xyz;
  float b = dot( oc, rd );
  float c = dot( oc, oc ) - sph.w*sph.w;
  float h = b*b - c;
  if( h<0.0 ) return vec2(-1.0);
  h = sqrt( h );
  return vec2(-b - h, -b + h);
}

vec4 moon(vec3 ro, vec3 rd, vec2 sp, vec3 lp, vec4 md) {
  vec2 mi = raySphere(ro, rd, md);

  if(mi.x < 0.0) return vec4(0.0);

  vec3 p    = ro + mi.x*rd;
  vec3 n    = normalize(p-md.xyz);
  vec3 r    = reflect(rd, n);
  vec3 ld   = normalize(lp - p);
  float fre = dot(n, rd)+1.0;
  fre = pow(fre, 15.0);
  float dif = max(dot(ld, n), 0.0);
  float spe = pow(max(dot(ld, r), 0.0), 8.0);
  float i = 0.5*tanh_approx(20.0*fre*spe+0.05*dif);
  vec3 col = blackbody(1500.0)*i+hsv2rgb(vec3(0.6, mix(0.6, 0.0, i), i));

  float t = tanh_approx(0.25*(mi.y-mi.x));

  return vec4(col, t);
}

vec3 sky(vec3 ro, vec3 rd, vec2 sp, vec3 lp, out float cf) {
  float ld = max(dot(normalize(lp-ro), rd),0.0);
  float y = -0.5+sp.x/PI;
  y = max(abs(y)-0.02, 0.0)+0.1*smoothstep(0.5, PI, abs(sp.y));
  vec3 blue = hsv2rgb(vec3(0.6, 0.75, 0.35*exp(-15.0*y)));
  blue *= 0.05; // Reduce blue sky to 5% brightness
  float ci = pow(ld, 10.0)*2.0*exp(-25.0*y);
  vec3 yellow = blackbody(1500.0)*ci;
  yellow *= 0.05; // Reduce yellow glow to 5% brightness
  cf = ci;
  return blue+yellow;
}

vec3 galaxy(vec3 ro, vec3 rd, vec2 sp, out float sf) {
  vec2 gp = sp;
  gp *= ROT(0.67);
  gp += vec2(-1.0, 0.5);
  float h1 = height(2.0*sp);
  float gcc = dot(gp, gp);
  float gcx = exp(-(abs(3.0*(gp.x))));
  float gcy = exp(-abs(10.0*(gp.y)));
  float gh = gcy*gcx;
  float cf = smoothstep(0.05, -0.2, -h1);
  vec3 col = vec3(0.0);
  col += blackbody(mix(300.0, 1500.0, gcx*gcy))*gcy*gcx;
  col += hsv2rgb(vec3(0.6, 0.5, 0.00125/gcc));
  col *= mix(mix(0.15, 1.0, gcy*gcx), 1.0, cf);
  col *= 0.1; // Reduce galaxy brightness to 10%
  sf = gh*cf;
  return col;
}

// Optional grid overlay
vec3 grid(vec3 ro, vec3 rd, vec2 sp) {
  const vec2 dim = vec2(1.0/8.0*PI);
  vec2 pp = sp;
  vec2 np = mod2(pp, dim);

  vec3 col = vec3(0.0);

  float y = sin(sp.x);
  float d = min(abs(pp.x), abs(pp.y*y));

  col += 2.0*vec3(0.5, 0.5, 1.0)*exp(-2000.0*max(d-0.00025, 0.0));

  return 0.25*col;
}

// Main color composition
vec3 color(vec3 ro, vec3 rd, vec3 lp, vec4 md) {
  vec2 sp = toSpherical(rd.xzy).yz;

  float sf = 0.0;
  float cf = 0.0;
  vec3 col = vec3(0.002, 0.002, 0.004); // Even darker base color (very deep space)

  vec4 mcol = moon(ro, rd, sp, lp, md);

  col += stars(ro, rd, sp, sf)*(1.0-tanh_approx(2.0*cf));
  col += galaxy(ro, rd, sp, sf);
  col = mix(col, mcol.xyz, mcol.w);
  col += sky(ro, rd, sp, lp, cf);
  // col += grid(ro, rd, sp); // Uncomment for grid overlay

  if (rd.y < 0.0) {
    col = vec3(0.001, 0.001, 0.002); // Extremely dark bottom hemisphere
  }

  col *= 0.5; // Additional global brightness reduction to 50%

  return col;
}

// Main composition
void mainImage(out vec4 fragColor, in vec2 fragCoord) {
  vec2 q = fragCoord/iResolution.xy;
  vec2 p = -1.0 + 2.0*q;
  p.x *= RESOLUTION.x/RESOLUTION.y;

  vec3 ro = vec3(0.0, 0.0, 0.0);
  vec3 lp = 500.0*vec3(1.0, -0.25, 0.0);
  vec4 md = 50.0*vec4(vec3(1.0, 1., -0.6), 0.5);
  vec3 la = vec3(1.0, 0.5, 0.0);
  vec3 up = vec3(0.0, 1.0, 0.0);
  la.xz *= ROT(TTIME/360.0-PI/2.0);

  vec3 ww = normalize(la - ro);
  vec3 uu = normalize(cross(up, ww));
  vec3 vv = normalize(cross(ww,uu));
  vec3 rd = normalize(p.x*uu + p.y*vv + 0.6*ww);
  vec3 col = color(ro, rd, lp, md);

  col *= smoothstep(0.0, 4.0, TIME)*smoothstep(30.0, 26.0, TIME);
  col = aces_approx(col);
  col = sRGB(col);

  fragColor = vec4(col, 1.0);
}

void main() {
  mainImage(gl_FragColor, vUV * iResolution.xy);
}
`;var kg=class n{starfieldMesh=null;starfieldMaterial=null;time=0;scene=null;initStarfieldEffect(e,t){if(!e||!t)return console.error("Scene or camera is required for starfield effect"),null;this.scene=e;try{Pt.ShadersStore.starfieldFragmentShader=eR,Pt.ShadersStore.starfieldVertexShader=`
        precision highp float;

        // Attributes
        attribute vec3 position;
        attribute vec2 uv;

        // Uniforms
        uniform mat4 worldViewProjection;

        // Varying
        varying vec2 vUV;

        void main(void) {
          gl_Position = worldViewProjection * vec4(position, 1.0);
          vUV = uv;
        }
      `,this.starfieldMesh=$i.CreateSphere("starfieldBackground",{diameter:500,segments:32,sideOrientation:E.BACKSIDE},e),this.starfieldMesh.parent=t,this.starfieldMesh.position.set(0,0,0),this.starfieldMesh.renderingGroupId=0,this.starfieldMesh.isPickable=!1,this.starfieldMaterial=new un("starfieldMaterial",e,{vertex:"starfield",fragment:"starfield"},{attributes:["position","uv"],uniforms:["worldViewProjection","iResolution","iTime"]});let i=this.getResolution(e);return this.starfieldMaterial.setVector2("iResolution",i),this.starfieldMaterial.setFloat("iTime",this.time),this.starfieldMaterial.backFaceCulling=!1,this.starfieldMesh.material=this.starfieldMaterial,e.onBeforeRenderObservable.add(()=>{if(this.starfieldMaterial&&this.scene){this.time+=.01;let r=this.getResolution(this.scene);this.starfieldMaterial.setVector2("iResolution",r),this.starfieldMaterial.setFloat("iTime",this.time)}}),this.starfieldMesh}catch(i){return console.error("Failed to initialize starfield shader:",i),null}}getResolution(e){let t=e.getEngine().getRenderingCanvas();return t?new me(t.width,t.height):new me(1920,1080)}resetTime(){this.time=0}setTime(e){this.time=e}getTime(){return this.time}dispose(){this.starfieldMaterial&&(this.starfieldMaterial.dispose(),this.starfieldMaterial=null),this.starfieldMesh&&(this.starfieldMesh.dispose(),this.starfieldMesh=null),this.time=0,this.scene=null}static \u0275fac=function(t){return new(t||n)};static \u0275prov=Ne({token:n,factory:n.\u0275fac,providedIn:"root"})};var nV=["renderCanvas"],rV=(n,e)=>e.company,tR=(n,e)=>e.name;function sV(n,e){if(n&1&&(De(0,"span",25),Ke(1),we()),n&2){let t=e.$implicit;Be(),oi(t)}}function oV(n,e){if(n&1&&(De(0,"p"),Ke(1),we()),n&2){let t=e.$implicit;Be(),oi(t)}}function aV(n,e){if(n&1&&(De(0,"div",12)(1,"div",16)(2,"div",17),on(3,"img",18)(4,"div",19)(5,"div",20),we(),De(6,"div",21)(7,"h3"),Ke(8),we(),De(9,"span",22)(10,"span",23),Ke(11,"\u{1F4CD}"),we(),Ke(12),we(),De(13,"div",24),xn(14,sV,2,1,"span",25,Lr),we()()(),De(16,"div",26),xn(17,oV,2,1,"p",null,Lr),we(),De(19,"div",27)(20,"a",28)(21,"span"),Ke(22,"\u25B6"),we(),Ke(23," D4veCovers "),we(),De(24,"a",29)(25,"span"),Ke(26,"in"),we(),Ke(27," LinkedIn "),we(),De(28,"a",30)(29,"span"),Ke(30,"\u2709"),we(),Ke(31," Contact "),we()()()),n&2){let t=Ei();Be(3),Br("src",t.content.avatar,cs),Be(5),oi(t.content.role),Be(4),or(" ",t.content.location," "),Be(2),Cn(t.content.softSkills),Be(3),Cn(t.content.bio),Be(3),Br("href",t.content.socials.youtube,cs),Be(4),Br("href",t.content.socials.linkedin,cs),Be(4),Br("href","mailto:"+t.content.socials.email,cs)}}function lV(n,e){if(n&1&&(De(0,"li"),Ke(1),we()),n&2){let t=e.$implicit;Be(),oi(t)}}function cV(n,e){if(n&1&&(De(0,"div",31),on(1,"div",32),De(2,"div",33)(3,"div",34)(4,"h3"),Ke(5),we(),De(6,"span",35),Ke(7),we()(),De(8,"h4",36),Ke(9),we(),De(10,"p",37),Ke(11),we(),De(12,"ul",38),xn(13,lV,2,1,"li",null,Lr),we()()()),n&2){let t=e.$implicit;Be(5),oi(t.role),Be(2),oi(t.period),Be(2),oi(t.company),Be(2),oi(t.desc),Be(2),Cn(t.highlights)}}function uV(n,e){if(n&1&&(De(0,"div",13),xn(1,cV,15,4,"div",31,rV),we()),n&2){let t=Ei();Be(),Cn(t.content)}}function hV(n,e){if(n&1&&(De(0,"span",45),Ke(1),we()),n&2){let t=e.$implicit;Be(),oi(t)}}function dV(n,e){if(n&1&&(De(0,"a",47),Ke(1,"Visit Site \u2197"),we()),n&2){let t=Ei().$implicit;Br("href",t.link,cs)}}function fV(n,e){if(n&1&&(De(0,"div",39),on(1,"div",40),De(2,"div",41)(3,"span",42),Ke(4),we(),De(5,"h3"),Ke(6),we()(),De(7,"p"),Ke(8),we(),De(9,"div",43)(10,"div",44),xn(11,hV,2,1,"span",45,Lr),we(),De(13,"div",46),rn(14,dV,2,1,"a",47),we()()()),n&2){let t=e.$implicit;Be(4),oi(t.category),Be(2),oi(t.name),Be(2),oi(t.description),Be(3),Cn(t.stack),Be(3),sn(t.link?14:-1)}}function pV(n,e){if(n&1&&(De(0,"div",14),xn(1,fV,15,4,"div",39,tR),we()),n&2){let t=Ei();Be(),Cn(t.content)}}function mV(n,e){if(n&1&&(De(0,"div",50)(1,"div",55)(2,"span"),Ke(3),we(),De(4,"span",56),Ke(5),we()(),De(6,"div",57),on(7,"div",58),we()()),n&2){let t=e.$implicit;Be(3),oi(t.name),Be(2),or("",t.level,"%"),Be(2),Yf("width",t.level,"%")}}function gV(n,e){if(n&1&&(De(0,"span",54),Ke(1),we()),n&2){let t=e.$implicit;Be(),oi(t)}}function _V(n,e){if(n&1&&(De(0,"span",54),Ke(1),we()),n&2){let t=e.$implicit;Be(),oi(t)}}function yV(n,e){if(n&1&&(De(0,"div",15)(1,"div",48)(2,"h4",49),Ke(3,"CORE CAPABILITIES"),we(),xn(4,mV,8,4,"div",50,tR),we(),De(6,"div",51)(7,"div",52)(8,"h4",49),Ke(9,"BACKEND & DATA"),we(),De(10,"div",53),xn(11,gV,2,1,"span",54,Lr),we()(),De(13,"div",52)(14,"h4",49),Ke(15,"INFRA & DEVOPS"),we(),De(16,"div",53),xn(17,_V,2,1,"span",54,Lr),we()()()()),n&2){let t=Ei();Be(4),Cn(t.content.core),Be(7),Cn(t.content.backend),Be(6),Cn(t.content.devops)}}function vV(n,e){if(n&1){let t=pu();De(0,"div",6)(1,"div",7)(2,"h2",8),Ke(3),we()(),De(4,"button",9),yl("click",function(){nl(t);let r=Ei(2);return rl(r.closeDetails())}),De(5,"span",10),Ke(6,"\xD7"),we()()(),De(7,"div",11),rn(8,aV,32,6,"div",12),rn(9,uV,3,0,"div",13),rn(10,pV,3,0,"div",14),rn(11,yV,19,0,"div",15),we()}if(n&2){let t=e;Be(3),oi(t.title),Be(5),sn(t.type==="about"?8:-1),Be(),sn(t.type==="experience"?9:-1),Be(),sn(t.type==="projects"?10:-1),Be(),sn(t.type==="skills"?11:-1)}}function bV(n,e){if(n&1&&(De(0,"div",3)(1,"div",4),Ke(2,"SYSTEM: ONLINE"),we()(),De(3,"div",5),rn(4,vV,12,5),we()),n&2){let t,i=Ei();Be(3),us("active",i.isDetailsOpen()),Be(),sn((t=i.activeSection())?4:-1,t)}}var Vg=class n{constructor(e,t,i,r,s){this.babylonService=e;this.ngZone=t;this.puzzleStore=i;this.splashService=r;this.starfieldShader=s}canvasRef;activeSection=nn(null);isDetailsOpen=nn(!1);isTransitioning=!1;ngOnInit(){this.splashService.updateImage("assets/icons/opened-map.png"),this.splashService.autoHide=!1,this.splashService.buttonText="Engage",this.splashService.show=!0,this.puzzleStore.setLoading(!0),this.splashService.updateMessage("Unlocking Map"),this.ngZone.runOutsideAngular(()=>{setTimeout(()=>this.initScene(),0)})}initScene(){return S(this,null,function*(){let e=this.canvasRef.nativeElement;if(!e){console.error("Canvas element not found!");return}try{this.babylonService.initScene(e,{createEnvironmentTexture:!1,createLights:!1,allowCamControls:!0,createGlowLayer:!0},{removeKeyBoardInputs:!0,autoElevation:!1,disablePanning:!0});let t=this.babylonService.currentScene;if(!t){console.error("Scene initialization failed!");return}t.clearColor=new ce(.02,.02,.08,1);let i=this.babylonService.currentCamera;i&&(i.radius=35,i.beta=Math.PI/2.3,i.alpha=Math.PI*2,i.wheelPrecision=30,i.angularSensibilityX=1500,i.angularSensibilityY=1500,i.lowerRadiusLimit=5,i.upperRadiusLimit=80,i.lowerBetaLimit=.1,i.upperBetaLimit=Math.PI-.1,this.starfieldShader.initStarfieldEffect(t,i)),this.createGridUniverse(),yield this.loadGalaxyModel(),yield this.createCentralHologram(),this.spawnCVConstellations(),this.babylonService.startAnimation(),this.ngZone.run(()=>{this.puzzleStore.setLoading(!1),setTimeout(()=>{this.splashService.hide()},500)})}catch(t){console.error("Failed to initialize holographic room:",t),this.ngZone.run(()=>{this.splashService.updateMessage("Error loading holographic interface"),this.puzzleStore.setLoading(!1)})}})}createGridUniverse(){let e=this.babylonService.currentScene;if(!e)return;let t=$i.CreateSphere("universe",{diameter:100,segments:64},e),i=new Ci("gridMat",e);i.majorUnitFrequency=5,i.minorUnitVisibility=1,i.gridRatio=4,i.mainColor=U.FromHexString("#005555"),i.lineColor=U.FromHexString("#00ffff"),i.opacity=.4,i.backFaceCulling=!1,t.material=i,t.isPickable=!1}loadGalaxyModel(){return S(this,null,function*(){if(this.babylonService.currentScene)try{let t=yield this.babylonService.loadModel("assets/models/solar_system.glb");t.addAllToScene();let i=t.meshes;if(i.length>0){let r=i[0];r.position=m.Zero(),r.scaling=new m(.1,.1,.1),i.forEach(s=>{if(s.isPickable=!1,s.material){let a=s.material;a.alpha=.4,a.backFaceCulling=!1}let o=this.babylonService.currentGlowLayer;o&&s&&o.addExcludedMesh(s)})}}catch(t){console.error("Failed to load galaxy.glb:",t)}})}createCentralHologram(){return S(this,null,function*(){let e=this.babylonService.currentScene;if(!e)throw new Error("Scene not initialized");let t=new E("coreGroup",e);try{let l=yield this.babylonService.loadModel("assets/models/treasure_map.glb");l.addAllToScene();let c=l.meshes;if(c.length>0){let u=c[0];u.parent=t,u.scaling=new m(1,1,1),c.forEach(h=>{if(h.isPickable=!1,h.material){let d=new te("treasureMapGreen",e);d.emissiveColor=U.FromHexString("#038a03"),d.alpha=.3,h.material=d}})}}catch(l){console.error("Failed to load treasure_map.glb, using fallback sphere",l);let c=$i.CreateSphere("corePlanet",{diameter:10,segments:64},e);c.parent=t;let u=new te("planetMat",e);u.diffuseColor=U.FromHexString("#00aa00"),u.specularColor=U.FromHexString("#33ff33"),u.emissiveColor=U.Black(),u.alpha=1,c.material=u}let i=0;e.onBeforeRenderObservable.add(()=>{i+=.03,t.position.y=Math.sin(i)*.25});let r=$i.CreateTorus("ring1",{diameter:25,thickness:.12,tessellation:48},e);r.parent=t,r.position=m.Zero(),r.rotation.x=Math.PI+Math.PI/8,r.rotation.y=0,r.rotation.z=0;let s=new te("ring1Mat",e);s.emissiveColor=U.FromHexString("#00ff00"),s.diffuseColor=U.Black(),s.specularColor=U.Black(),s.alpha=.85,r.material=s;let a=this.createParticlesRing()?.emitter;return a&&(a.parent=t,a.position=m.Zero(),a.rotation.x=Math.PI-Math.PI/8,a.rotation.y=0,a.rotation.z=0),t})}spawnCVConstellations(){let t=ZD,i=t.length;t.forEach((r,s)=>{let o=s/i*Math.PI*2,a=Math.cos(o)*14,l=Math.sin(o)*14,c=Math.sin(o*3)*1.5,u=new m(a,c,l),d=this.createOrbitalNode(r.label,u,"#00ffff",()=>{this.onNodeClicked(r,d)})})}onNodeClicked(e,t){this.isDetailsOpen()||this.ngZone.run(()=>{this.flyToMesh(t,7,()=>{this.ngZone.run(()=>{this.activeSection.set(e),this.isDetailsOpen.set(!0)})})})}closeDetails(){this.isDetailsOpen.set(!1),setTimeout(()=>{this.activeSection.set(null),this.resetCameraView()},100)}createOrbitalNode(e,t,i,r){let s=this.babylonService.currentScene;if(!s)throw new Error("Scene not initialized");let o=new E(e+"_group",s);o.position=t;let a=$i.CreateSphere(e,{diameter:2,segments:16},s);a.parent=o;let l=new te(e+"_mat",s);l.emissiveColor=U.FromHexString(i),l.alpha=.8,a.material=l;let c=$i.CreateSphere(e+"_atmo",{diameter:1.5,segments:16},s);c.parent=o;let u=new te(e+"_atmoMat",s);return u.emissiveColor=U.FromHexString(i),u.alpha=.3,c.material=u,a.isPickable=!0,o.isPickable=!1,a.actionManager=new xs(s),a.actionManager.registerAction(new ia(xs.OnPickTrigger,()=>{this.isTransitioning||r()})),this.setupConstellationHoverEffect(a,c,i),this.createHolographicLabel(e,o,i),this.createConnectionBeam(m.Zero(),t,i),o}setupConstellationHoverEffect(e,t,i){let r=this.babylonService.currentScene;e.actionManager||(e.actionManager=new xs(r));let s=U.FromHexString(i),o=U.FromHexString("#FF8C00"),a=U.FromHexString("#FFA500"),l=e.material,c=t.material;e.actionManager.registerAction(new ia(xs.OnPointerOverTrigger,()=>{this.isTransitioning||(l.emissiveColor=a,c.emissiveColor=o)})),e.actionManager.registerAction(new ia(xs.OnPointerOutTrigger,()=>{l.emissiveColor=s,c.emissiveColor=s}))}createConnectionBeam(e,t,i){let r=[e,t],s=$i.CreateLines("beam",{points:r},this.babylonService.currentScene);s.color=U.FromHexString("#00ffff"),s.alpha=.3,s.isPickable=!1}createParticlesRing(){let e=this.babylonService.currentScene;if(!e)return;let t=$i.CreateTorus("torusEmitter",{diameter:25,thickness:.5,tessellation:48},e);t.isVisible=!1,t.scaling.y=.01;let i=new Mt("clouds",1e3,e);return i.particleTexture=new Z("assets/textures/flame.png",e),i.emitter=t,i.particleEmitterType=new Ul(t),i.color1=new ce(.2,1,.3,.8),i.color2=new ce(0,1,.1,.7),i.colorDead=new ce(0,.5,.1,0),i.minSize=.8,i.maxSize=1.5,i.minLifeTime=.5,i.maxLifeTime=1.2,i.emitRate=1e3,i.gravity=new m(0,0,0),i.minEmitPower=0,i.maxEmitPower=0,i.minAngularSpeed=0,i.maxAngularSpeed=Math.PI*2,i.blendMode=Mt.BLENDMODE_ADD,i.start(),i}createHolographicLabel(e,t,i){let r=this.babylonService.currentScene,a=$i.CreatePlane("label",{width:12,height:3},r);a.parent=t,a.position.y=-2.8,a.billboardMode=E.BILLBOARDMODE_ALL,a.isPickable=!1;let l=new no("dynamic texture",{width:2048,height:512},r);l.hasAlpha=!0;let c=l.getContext();c.clearRect(0,0,2048,512);let u="#ffffff",h="#003875",d="#000000",f=140;c.font=`700 ${f}px "TreasurePlanet", sans-serif`;let g=(2048-c.measureText(e.toUpperCase()).width)/2,_=280;c.shadowColor=h,c.shadowBlur=30,c.shadowOffsetX=0,c.shadowOffsetY=0,c.fillStyle=h,c.fillText(e.toUpperCase(),g,_),c.shadowBlur=18,c.fillText(e.toUpperCase(),g,_),c.shadowBlur=0,c.lineWidth=8,c.strokeStyle=d,c.strokeText(e.toUpperCase(),g,_),c.shadowBlur=12,c.shadowColor=h,c.fillStyle=h,c.fillText(e.toUpperCase(),g,_),c.shadowBlur=6,c.shadowColor="#ffffff",c.fillStyle=u,c.fillText(e.toUpperCase(),g,_),c.shadowBlur=0,c.fillStyle="#ffffff",c.fillText(e.toUpperCase(),g,_),l.update();let y=new te("labelMat",this.babylonService.currentScene);y.diffuseTexture=l,y.emissiveColor=U.FromHexString("#ffffff"),y.emissiveColor.scale(1.3),y.opacityTexture=l,y.alpha=1,y.disableLighting=!0,y.backFaceCulling=!1,a.material=y,this.babylonService.currentGlowLayer&&this.babylonService.currentGlowLayer.addExcludedMesh(a)}flyToMesh(e,t=4,i){let r=this.babylonService.currentScene,s=this.babylonService.currentCamera;if(!r||!s||this.isTransitioning)return;this.isTransitioning=!0;let o=30,a=60,l=e.absolutePosition.clone(),c=new H("zoom","radius",o,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CONSTANT),u=new H("move","target",o,H.ANIMATIONTYPE_VECTOR3,H.ANIMATIONLOOPMODE_CONSTANT),h=new n_;h.setEasingMode(Qi.EASINGMODE_EASEINOUT),[c,u].forEach(d=>d.setEasingFunction(h)),c.setKeys([{frame:0,value:s.radius},{frame:a,value:t}]),u.setKeys([{frame:0,value:s.target},{frame:a,value:l}]),r.beginDirectAnimation(s,[c,u],0,a,!1,1,()=>{this.isTransitioning=!1,i&&i()})}resetCameraView(e){let t=this.babylonService.currentScene,i=this.babylonService.currentCamera;if(!t||!i)return;this.isTransitioning=!0;let r=60,s=90,o=new H("zoomOut","radius",r,H.ANIMATIONTYPE_FLOAT,H.ANIMATIONLOOPMODE_CONSTANT),a=new H("resetTarget","target",r,H.ANIMATIONTYPE_VECTOR3,H.ANIMATIONLOOPMODE_CONSTANT),l=new n_;l.setEasingMode(Qi.EASINGMODE_EASEINOUT),[o,a].forEach(c=>c.setEasingFunction(l)),o.setKeys([{frame:0,value:i.radius},{frame:s,value:40}]),a.setKeys([{frame:0,value:i.target},{frame:s,value:m.Zero()}]),t.beginDirectAnimation(i,[o,a],0,s,!1,1,()=>{this.isTransitioning=!1,e&&e()})}ngOnDestroy(){this.starfieldShader.dispose(),this.babylonService.dispose()}static \u0275fac=function(t){return new(t||n)(si(vc),si(Et),si(Zr),si(so),si(kg))};static \u0275cmp=sr({type:n,selectors:[["app-holographic-room"]],viewQuery:function(t,i){if(t&1&&gu(nV,7),t&2){let r;_u(r=yu())&&(i.canvasRef=r.first)}},decls:4,vars:1,consts:[["renderCanvas",""],[1,"holographic-container"],[1,"render-canvas"],[1,"hud-overlay"],[1,"status-bar"],[1,"holo-panel"],[1,"panel-header"],[1,"header-content"],[1,"neon-title"],[1,"close-btn",3,"click"],[1,"icon"],[1,"panel-content","custom-scrollbar"],[1,"about-container"],[1,"timeline-container"],[1,"projects-grid"],[1,"skills-layout"],[1,"profile-header"],[1,"avatar-frame"],["alt","David Alvarado",1,"avatar-img",3,"src"],[1,"scan-line"],[1,"avatar-ring"],[1,"profile-intro"],[1,"location"],[1,"pin-icon"],[1,"soft-skills-row"],[1,"skill-pill"],[1,"bio-section"],[1,"connections"],["target","_blank",1,"holo-btn","youtube",3,"href"],["target","_blank",1,"holo-btn",3,"href"],[1,"holo-btn",3,"href"],[1,"timeline-item"],[1,"timeline-marker"],[1,"job-card"],[1,"job-header"],[1,"period"],[1,"company"],[1,"job-desc"],[1,"highlights"],[1,"project-card"],[1,"card-glow"],[1,"project-header"],[1,"category"],[1,"mt-auto"],[1,"tech-stack-mini"],[1,"tech-pill"],[1,"project-links"],["target","_blank",1,"link-btn",3,"href"],[1,"core-skills"],[1,"section-label"],[1,"skill-bar-container"],[1,"secondary-skills"],[1,"skill-group"],[1,"tags"],[1,"tag"],[1,"skill-info"],[1,"percent"],[1,"bar-track"],[1,"bar-fill"]],template:function(t,i){t&1&&(De(0,"div",1),on(1,"canvas",2,0),rn(3,bV,5,3),we()),t&2&&(Be(3),sn(i.puzzleStore.isLoading()?-1:3))},styles:[".holographic-container[_ngcontent-%COMP%]{width:100%;height:100vh;position:relative;overflow:hidden;background:#000}.holographic-container[_ngcontent-%COMP%]   canvas[_ngcontent-%COMP%]{width:100%;height:100%;outline:none;cursor:grab}.holographic-container[_ngcontent-%COMP%]   canvas[_ngcontent-%COMP%]:active{cursor:grabbing}.hud-overlay[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;padding:.5rem}.hud-overlay[_ngcontent-%COMP%]   .status-bar[_ngcontent-%COMP%]{position:absolute;top:20px;font-family:Courier New,Courier,monospace;font-size:.8rem;color:#0ff9;border:1px solid rgba(0,255,255,.3);padding:4px 8px;background:#00142880}.hud-overlay[_ngcontent-%COMP%]   .status-bar.right[_ngcontent-%COMP%]{right:20px;text-align:right}.holo-panel[_ngcontent-%COMP%]{position:absolute;top:50%;left:50%;transform:translate(-50%,-40%) scale(.9);width:90%;max-width:650px;max-height:80dvh;font-family:Courier New,Courier,monospace;background:#0c141ea6;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid rgba(0,255,255,.3);box-shadow:0 0 30px #00ffff1a;border-radius:12px;display:flex;flex-direction:column;opacity:0;pointer-events:none;transition:all .4s cubic-bezier(.16,1,.3,1)}.holo-panel.active[_ngcontent-%COMP%]{opacity:1;pointer-events:auto;transform:translate(-50%,-50%) scale(1)}.holo-panel[_ngcontent-%COMP%]   .panel-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid rgba(0,255,255,.1)}.holo-panel[_ngcontent-%COMP%]   .panel-header[_ngcontent-%COMP%]   .header-content[_ngcontent-%COMP%]{display:flex;flex-direction:column}.holo-panel[_ngcontent-%COMP%]   .panel-header[_ngcontent-%COMP%]   .neon-title[_ngcontent-%COMP%]{color:#0ff;text-shadow:0 0 10px rgba(0,255,255,.5);margin:0;font-size:1.5rem;letter-spacing:2px}.holo-panel[_ngcontent-%COMP%]   .panel-header[_ngcontent-%COMP%]   .close-btn[_ngcontent-%COMP%]{background:none;border:1px solid rgba(0,255,255,.3);color:#0ff;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1.2rem;transition:all .2s;display:flex;align-items:center;justify-content:center}.holo-panel[_ngcontent-%COMP%]   .panel-header[_ngcontent-%COMP%]   .close-btn[_ngcontent-%COMP%]:hover{background:#0ff3;box-shadow:0 0 10px #0ff6}.holo-panel[_ngcontent-%COMP%]   .panel-content[_ngcontent-%COMP%]{padding:1rem;overflow-y:auto;color:#e0e0e0;line-height:1.6}.holo-panel[_ngcontent-%COMP%]   .panel-content[_ngcontent-%COMP%]::-webkit-scrollbar{width:6px}.holo-panel[_ngcontent-%COMP%]   .panel-content[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:#0000004d}.holo-panel[_ngcontent-%COMP%]   .panel-content[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:#00ffff4d;border-radius:3px}.about-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:20px}.profile-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:20px;border-bottom:1px solid rgba(0,255,255,.2);padding-bottom:20px}@media(max-width:600px){.profile-header[_ngcontent-%COMP%]{flex-direction:column;text-align:center}}.avatar-frame[_ngcontent-%COMP%]{position:relative;width:120px;height:120px;border-radius:50%;border:2px solid #00ffff;box-shadow:0 0 15px #00ffff4d;overflow:hidden;flex-shrink:0}.avatar-frame[_ngcontent-%COMP%]   .avatar-img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover;filter:sepia(20%) hue-rotate(180deg) saturate(90%)}.avatar-frame[_ngcontent-%COMP%]   .scan-line[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom,transparent 40%,rgba(0,255,255,.4) 50%,transparent 60%);background-size:100% 200%;animation:_ngcontent-%COMP%_scanFace 3s linear infinite;pointer-events:none}.profile-intro[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 5px;color:#fff;font-size:1.3rem}.profile-intro[_ngcontent-%COMP%]   .location[_ngcontent-%COMP%]{color:#aaa;font-size:.9rem;display:block;margin-bottom:10px}.soft-skills-row[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:8px}@media(max-width:600px){.soft-skills-row[_ngcontent-%COMP%]{justify-content:center}}.soft-skills-row[_ngcontent-%COMP%]   .skill-pill[_ngcontent-%COMP%]{font-size:.75rem;padding:2px 8px;border:1px solid rgba(0,255,255,.4);color:#0ff;border-radius:4px;background:#00ffff0d}.bio-section[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin-bottom:12px;color:#e0e0e0;font-size:1rem;text-align:justify}.connections[_ngcontent-%COMP%]{display:flex;gap:15px;margin-top:10px;flex-wrap:wrap}@media(max-width:600px){.connections[_ngcontent-%COMP%]{justify-content:center}}.holo-btn[_ngcontent-%COMP%]{text-decoration:none;padding:8px 16px;border:1px solid #00ffff;color:#0ff;font-family:Courier New,monospace;font-weight:700;font-size:.9rem;background:#00ffff1a;transition:all .3s ease;display:flex;align-items:center;gap:8px}.holo-btn[_ngcontent-%COMP%]:hover{background:#0ff;color:#000;box-shadow:0 0 15px #0ff9}.holo-btn.youtube[_ngcontent-%COMP%]{border-color:#f44;color:#f44;background:#ff44441a}.holo-btn.youtube[_ngcontent-%COMP%]:hover{background:#f44;color:#fff;box-shadow:0 0 15px #f449}@keyframes _ngcontent-%COMP%_scanFace{0%{transform:translateY(-100%)}to{transform:translateY(100%)}}.timeline-container[_ngcontent-%COMP%]{position:relative;padding-left:20px;border-left:2px solid rgba(0,255,255,.15)}.timeline-item[_ngcontent-%COMP%]{position:relative;margin-bottom:35px}.timeline-item[_ngcontent-%COMP%]:last-child{margin-bottom:0}.timeline-item[_ngcontent-%COMP%]   .timeline-marker[_ngcontent-%COMP%]{position:absolute;left:-26px;top:5px;width:10px;height:10px;background:#0ff;border-radius:50%;box-shadow:0 0 10px #0ff}.job-card[_ngcontent-%COMP%]{background:#ffffff08;padding:1.2rem;border-radius:8px;border:1px solid rgba(0,255,255,.1);transition:background .3s}.job-card[_ngcontent-%COMP%]:hover{background:#00ffff0f;border-color:#00ffff4d}.job-card[_ngcontent-%COMP%]   .job-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;flex-wrap:wrap}.job-card[_ngcontent-%COMP%]   .job-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;color:#fff;font-size:1.1rem}.job-card[_ngcontent-%COMP%]   .job-header[_ngcontent-%COMP%]   .period[_ngcontent-%COMP%]{color:#0ff;font-family:Courier New,monospace;font-size:.85rem}.job-card[_ngcontent-%COMP%]   .company[_ngcontent-%COMP%]{margin:0 0 10px;color:#aaa;font-weight:400;font-style:italic}.job-card[_ngcontent-%COMP%]   .job-desc[_ngcontent-%COMP%]{margin-bottom:10px;color:#ddd}.job-card[_ngcontent-%COMP%]   .highlights[_ngcontent-%COMP%]{padding-left:18px;margin:0}.job-card[_ngcontent-%COMP%]   .highlights[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{margin-bottom:6px;color:#bdd;font-size:.9rem}.job-card[_ngcontent-%COMP%]   .highlights[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]::marker{color:#0ff}.projects-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px}.project-card[_ngcontent-%COMP%]{position:relative;background:#0006;border:1px solid rgba(0,255,255,.2);padding:1.2rem;border-radius:8px;overflow:hidden;transition:transform .3s ease;display:flex;flex-direction:column}.project-card[_ngcontent-%COMP%]:hover{transform:translateY(-5px);border-color:#0ff}.project-card[_ngcontent-%COMP%]:hover   .card-glow[_ngcontent-%COMP%]{opacity:1}.project-card[_ngcontent-%COMP%]   .card-glow[_ngcontent-%COMP%]{position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at top right,rgba(0,255,255,.1),transparent 60%);opacity:0;transition:opacity .4s;pointer-events:none}.project-card[_ngcontent-%COMP%]   .project-header[_ngcontent-%COMP%]{margin-bottom:10px}.project-card[_ngcontent-%COMP%]   .project-header[_ngcontent-%COMP%]   .category[_ngcontent-%COMP%]{font-size:.7rem;color:#0ff;text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:4px}.project-card[_ngcontent-%COMP%]   .project-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;color:#fff;font-size:1.1rem}.project-card[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:.9rem;color:#ccc;margin-bottom:15px;line-height:1.4}.project-card[_ngcontent-%COMP%]   .tech-stack-mini[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}.project-card[_ngcontent-%COMP%]   .tech-stack-mini[_ngcontent-%COMP%]   .tech-pill[_ngcontent-%COMP%]{background:#ffffff1a;color:#aff;font-size:.75rem;padding:2px 8px;border-radius:4px}.project-card[_ngcontent-%COMP%]   .project-links[_ngcontent-%COMP%]{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}.project-card[_ngcontent-%COMP%]   .project-links[_ngcontent-%COMP%]   .link-btn[_ngcontent-%COMP%]{font-size:.75rem;color:#0ff;text-decoration:none;border:1px solid rgba(0,255,255,.3);padding:4px 8px;border-radius:4px;transition:all .2s}.project-card[_ngcontent-%COMP%]   .project-links[_ngcontent-%COMP%]   .link-btn[_ngcontent-%COMP%]:hover{background:#00ffff1a;border-color:#0ff}.skills-layout[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:30px}.section-label[_ngcontent-%COMP%]{color:#0ff;border-bottom:1px solid rgba(0,255,255,.2);padding-bottom:5px;margin:0 0 15px;font-size:.9rem;letter-spacing:2px;font-family:Courier New,monospace}.core-skills[_ngcontent-%COMP%]   .skill-bar-container[_ngcontent-%COMP%]{margin-bottom:12px}.core-skills[_ngcontent-%COMP%]   .skill-bar-container[_ngcontent-%COMP%]   .skill-info[_ngcontent-%COMP%]{display:flex;justify-content:space-between;margin-bottom:4px;font-size:.9rem;color:#fff}.core-skills[_ngcontent-%COMP%]   .skill-bar-container[_ngcontent-%COMP%]   .skill-info[_ngcontent-%COMP%]   .percent[_ngcontent-%COMP%]{color:#0ff;font-family:Courier New}.core-skills[_ngcontent-%COMP%]   .skill-bar-container[_ngcontent-%COMP%]   .bar-track[_ngcontent-%COMP%]{height:6px;background:#ffffff1a;border-radius:3px;overflow:hidden}.core-skills[_ngcontent-%COMP%]   .skill-bar-container[_ngcontent-%COMP%]   .bar-track[_ngcontent-%COMP%]   .bar-fill[_ngcontent-%COMP%]{height:100%;background:linear-gradient(90deg,#08a,#0ff);box-shadow:0 0 10px #00ffff80}.secondary-skills[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;gap:20px}@media(max-width:500px){.secondary-skills[_ngcontent-%COMP%]{grid-template-columns:1fr}}.secondary-skills[_ngcontent-%COMP%]   .tags[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:8px}.secondary-skills[_ngcontent-%COMP%]   .tags[_ngcontent-%COMP%]   .tag[_ngcontent-%COMP%]{background:#00ffff14;border:1px solid rgba(0,255,255,.2);color:#cff;padding:4px 10px;border-radius:4px;font-size:.8rem;transition:all .2s}.secondary-skills[_ngcontent-%COMP%]   .tags[_ngcontent-%COMP%]   .tag[_ngcontent-%COMP%]:hover{background:#0ff3;border-color:#0ff}.mt-auto[_ngcontent-%COMP%]{margin-top:auto}"]})};var AT=()=>{let n=ue(Zr),e=ue(Gr);return n.isUnlocked()?(e.navigate(["/holographic-room"]),!1):(e.navigate(["/treasure-map"]),!1)},iR=()=>{let n=ue(Zr),e=ue(Gr);return n.isUnlocked()?!0:(e.navigate(["/map-puzzle"]),!1)},nR=()=>{let n=ue(Zr),e=ue(Gr);return n.isUnlocked()?(e.navigate(["/holographic-room"]),!1):!0};var rR=[{path:"",canActivate:[AT],children:[]},{path:"treasure-map",component:Bg,title:"David Alvarado - Map Puzzle",canActivate:[nR]},{path:"holographic-room",component:Vg,title:"David Alvarado - Holographic Room",canActivate:[iR]},{path:"**",canActivate:[AT],children:[]}];var sR={providers:[bE({eventCoalescing:!0}),Sb(rR)]};function xV(n,e){if(n&1){let t=pu();De(0,"button",11),yl("click",function(){nl(t);let r=Ei(2);return rl(r.onContinue())}),Ke(1),we()}if(n&2){let t=Ei(2);Be(),or(" ",t.splashService.buttonText," ")}}function CV(n,e){n&1&&(De(0,"div",10),on(1,"span")(2,"span")(3,"span"),we())}function TV(n,e){if(n&1&&(De(0,"div",1),zs(1,"async"),De(2,"div",2)(3,"div",3),on(4,"img",4),zs(5,"async"),on(6,"div",5)(7,"div",6),we(),De(8,"h1",7),zs(9,"async"),Ke(10),zs(11,"async"),we(),De(12,"div",8),rn(13,xV,2,1,"button",9),zs(14,"async"),fu(15,CV,4,0,"div",10),we()()()),n&2){let t=Ei();us("exiting",Hs(1,9,t.splashService.isExiting$))("transparent-mode",t.splashService.isTransparent),Be(4),Br("src",Hs(5,11,t.splashService.image$),cs),Be(4),us("holo-fade-out",!Hs(9,13,t.splashService.textVisible$)),Be(2),or(" ",Hs(11,15,t.splashService.message$)," "),Be(3),sn(Hs(14,17,t.splashService.showButton$)?13:15)}}var Gg=class n{constructor(e){this.splashService=e}onContinue(){this.splashService.forceClose()}static \u0275fac=function(t){return new(t||n)(si(so))};static \u0275cmp=sr({type:n,selectors:[["app-splash-screen"]],decls:2,vars:3,consts:[[1,"splash-screen",3,"exiting","transparent-mode"],[1,"splash-screen"],[1,"splash-content"],[1,"splash-icon-container"],["alt","Map Sphere","width","500","height","500",1,"treasure-icon",3,"src"],[1,"glow-core"],[1,"mech-ring"],[1,"splash-title"],[1,"action-placeholder"],[1,"action-btn"],[1,"loading-indicator"],[1,"action-btn",3,"click"]],template:function(t,i){t&1&&(rn(0,TV,16,19,"div",0),zs(1,"async")),t&2&&sn(Hs(1,1,i.splashService.show$)?0:-1)},dependencies:[bl,jv],styles:[`:host{display:block}.splash-screen{position:fixed;inset:0;width:100vw;height:100vh;z-index:99999;background:radial-gradient(circle at center,#131622,#050608);display:flex;align-items:center;justify-content:center}.splash-screen.transparent-mode{background:#0f111ad9;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px)}.splash-screen{opacity:1;transition:opacity .5s ease-out}.splash-screen.exiting{opacity:0;pointer-events:none}.splash-content{position:relative;display:flex;flex-direction:column;align-items:center;z-index:10}.splash-icon-container{position:relative;width:20rem;height:100%;aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;margin-bottom:2rem}.treasure-icon{width:70%;height:70%;object-fit:contain;z-index:5;filter:drop-shadow(0 0 15px rgba(229,192,123,.4));animation:float-map 4s ease-in-out infinite}.glow-core{position:absolute;width:100%;height:100%;background:radial-gradient(circle,var(--color-neon) 0%,transparent 60%);opacity:.15;filter:blur(20px);animation:pulse-glow 3s infinite alternate;z-index:1}.mech-ring{position:absolute;width:100%;height:100%;border:1px dashed rgba(76,244,42,.47);border-radius:50%;box-shadow:0 0 15px #40fa001a;animation:spin-mech 20s linear infinite;z-index:2}.mech-ring:after{content:"";position:absolute;inset:10%;border:1px solid rgba(229,192,123,.2);border-radius:50%;border-left-color:transparent;border-right-color:transparent;animation:spin-mech-reverse 10s linear infinite}.splash-title{color:var(--color-gold);font-size:1.8rem;letter-spacing:4px;text-transform:uppercase;margin:0 0 1.5rem;text-align:center;background:linear-gradient(to bottom,#fff5d6,#d4af37);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 2px 4px rgba(0,0,0,.5));opacity:1;transform:scale(1) translateY(0);transition:opacity .3s ease-in-out,transform .3s ease-in,filter .3s ease-in}.splash-title.holo-fade-out{opacity:0;transform:scale(.95) translateY(5px)}.loading-indicator{display:flex;gap:12px}.loading-indicator span{width:6px;height:6px;background-color:var(--color-gold);border-radius:50%;opacity:.5;animation:sequence-fade 1.4s infinite ease-in-out both}.loading-indicator span:nth-child(1){animation-delay:-.32s}.loading-indicator span:nth-child(2){animation-delay:-.16s}.loading-indicator span:nth-child(3){animation-delay:0s}.action-btn{background:#d4af371a;border:1px solid var(--color-gold);color:var(--color-gold);border-radius:6px;font-family:Cinzel Decorative,serif;font-size:1.2rem;padding:.8rem 2.5rem;cursor:pointer;letter-spacing:3px;text-transform:uppercase;transition:all .3s ease;position:relative;overflow:hidden;box-shadow:0 0 10px #d4af3733}.action-btn:hover{background:#d4af3740;box-shadow:0 0 20px #d4af3799;text-shadow:0 0 8px rgba(212,175,55,.8);transform:translateY(-2px)}.action-btn:active{transform:scale(.98)}.action-placeholder{height:4rem;width:100%;display:flex;align-items:center;justify-content:center;transition:all .3s ease}@keyframes float-map{0%,to{transform:translateY(0)}50%{transform:translateY(-10px)}}@keyframes spin-mech{to{transform:rotate(360deg)}}@keyframes spin-mech-reverse{to{transform:rotate(-360deg)}}@keyframes pulse-glow{0%{opacity:.1;transform:scale(.8)}to{opacity:.25;transform:scale(1.1)}}@keyframes sequence-fade{0%,80%,to{transform:scale(0);opacity:0}40%{transform:scale(1);opacity:1;box-shadow:0 0 10px var(--color-gold)}}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}@media(max-width:768px)or (max-height:700px){.splash-icon-container{width:15rem}.splash-title{font-size:1.2rem}}
`],encapsulation:2})};var Ug=class n{title="t-p-portfolio";static \u0275fac=function(t){return new(t||n)};static \u0275cmp=sr({type:n,selectors:[["app-root"]],decls:2,vars:0,template:function(t,i){t&1&&_l(0,"app-splash-screen")(1,"router-outlet")},dependencies:[Gu,Gg],encapsulation:2})};tb(Ug,sR).catch(n=>console.error(n));
