import{a as _}from"./chunk-BNAXGE26.js";import{d as p,f as s,g as f}from"./chunk-YCU4LZCU.js";import{c as A}from"./chunk-KMSJAFJG.js";import{a as G}from"./chunk-3WG2WLZ4.js";var g=class extends _{constructor(i){super(i,["animationLoop","animationEnd","animationGroupLoop"]),this.config=i,this.speed=this.registerDataInput("speed",s),this.loop=this.registerDataInput("loop",f),this.from=this.registerDataInput("from",s,0),this.to=this.registerDataInput("to",s),this.currentFrame=this.registerDataOutput("currentFrame",s),this.currentTime=this.registerDataOutput("currentTime",s),this.currentAnimationGroup=this.registerDataOutput("currentAnimationGroup",p),this.animationGroup=this.registerDataInput("animationGroup",p,i?.animationGroup),this.animation=this.registerDataInput("animation",p),this.object=this.registerDataInput("object",p)}_preparePendingTasks(i){let t=this.animationGroup.getValue(i),r=this.animation.getValue(i);if(!t&&!r)return this._reportError(i,"No animation or animation group provided");{let e=this.currentAnimationGroup.getValue(i);e&&e!==t&&e.dispose();let n=t;if(r&&!n){let o=this.object.getValue(i);if(!o)return this._reportError(i,"No target object provided");let h=Array.isArray(r)?r:[r],y=h[0].name;n=new A("flowGraphAnimationGroup-"+y+"-"+o.name,i.configuration.scene);let c=!1,V=i._getGlobalContextVariable("interpolationAnimations",[]);for(let d of h)n.addTargetedAnimation(d,o),V.indexOf(d.uniqueId)!==-1&&(c=!0);c&&this._checkInterpolationDuplications(i,h,o)}let u=this.speed.getValue(i)||1,a=this.from.getValue(i)??0,m=this.to.getValue(i)||n.to,b=!isFinite(m)||this.loop.getValue(i);this.currentAnimationGroup.setValue(n,i);let l=i._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);l.indexOf(n.uniqueId)!==-1&&n.stop();try{n.start(b,u,a,m),n.onAnimationGroupEndObservable.add(()=>this._onAnimationGroupEnd(i)),n.onAnimationEndObservable.add(()=>this._eventsSignalOutputs.animationEnd._activateSignal(i)),n.onAnimationLoopObservable.add(()=>this._eventsSignalOutputs.animationLoop._activateSignal(i)),n.onAnimationGroupLoopObservable.add(()=>this._eventsSignalOutputs.animationGroupLoop._activateSignal(i)),l.push(n.uniqueId),i._setGlobalContextVariable("currentlyRunningAnimationGroups",l)}catch(o){this._reportError(i,o)}}}_reportError(i,t){super._reportError(i,t),this.currentFrame.setValue(-1,i),this.currentTime.setValue(-1,i)}_executeOnTick(i){let t=this.currentAnimationGroup.getValue(i);t&&(this.currentFrame.setValue(t.getCurrentFrame(),i),this.currentTime.setValue(t.animatables[0]?.elapsedTime??0,i))}_execute(i){this._startPendingTasks(i)}_onAnimationGroupEnd(i){this._removeFromCurrentlyRunning(i,this.currentAnimationGroup.getValue(i)),this._resetAfterCanceled(i),this.done._activateSignal(i)}_checkInterpolationDuplications(i,t,r){let e=i._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);for(let n of e){let u=i.assetsContext.animationGroups.find(a=>a.uniqueId===n);if(u)for(let a of u.targetedAnimations)for(let m of t)a.animation.targetProperty===m.targetProperty&&a.target===r&&this._stopAnimationGroup(i,u)}}_stopAnimationGroup(i,t){t.stop(!0),t.dispose(),this._removeFromCurrentlyRunning(i,t)}_removeFromCurrentlyRunning(i,t){let r=i._getGlobalContextVariable("currentlyRunningAnimationGroups",[]),e=r.indexOf(t.uniqueId);e!==-1&&(r.splice(e,1),i._setGlobalContextVariable("currentlyRunningAnimationGroups",r))}_cancelPendingTasks(i){let t=this.currentAnimationGroup.getValue(i);t&&this._stopAnimationGroup(i,t)}getClassName(){return"FlowGraphPlayAnimationBlock"}};G("FlowGraphPlayAnimationBlock",g);export{g as a};
